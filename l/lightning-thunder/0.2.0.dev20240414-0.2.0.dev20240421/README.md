# Comparing `tmp/lightning_thunder-0.2.0.dev20240414.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240421.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240414.tar", last modified: Sun Apr 14 00:21:59 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240421.tar", last modified: Sun Apr 21 00:20:24 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240414.tar` & `lightning_thunder-0.2.0.dev20240421.tar`

### file list

```diff
@@ -1,101 +1,101 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12527 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9649 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12527 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      524 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.167459 lightning_thunder-0.2.0.dev20240414/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      344 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-14 00:21:59.000000 lightning_thunder-0.2.0.dev20240414/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    35864 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   101338 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    21055 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    26212 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.171459 lightning_thunder-0.2.0.dev20240414/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    63815 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    31678 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   255602 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    54226 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   117252 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    48759 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    19122 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   140614 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.175459 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    75512 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    15407 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     7872 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    82431 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    22098 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15889 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17053 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.179459 lightning_thunder-0.2.0.dev20240414/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-14 00:21:59.183459 lightning_thunder-0.2.0.dev20240414/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   148213 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2494 2024-04-14 00:21:53.000000 lightning_thunder-0.2.0.dev20240414/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12606 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12606 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      524 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.906218 lightning_thunder-0.2.0.dev20240421/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      864 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-21 00:20:24.926218 lightning_thunder-0.2.0.dev20240421/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-21 00:20:24.000000 lightning_thunder-0.2.0.dev20240421/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35664 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102957 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20786 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27205 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.910218 lightning_thunder-0.2.0.dev20240421/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    63815 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30802 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5921 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   255602 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54226 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   115363 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19863 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   139748 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7663 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.914218 lightning_thunder-0.2.0.dev20240421/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.918218 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      310 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.918218 lightning_thunder-0.2.0.dev20240421/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24903 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    74208 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7872 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    81988 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23242 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15699 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17053 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-21 00:20:24.922218 lightning_thunder-0.2.0.dev20240421/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   149156 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-04-21 00:20:22.000000 lightning_thunder-0.2.0.dev20240421/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240414/LICENSE` & `lightning_thunder-0.2.0.dev20240421/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240421/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/PKG-INFO` & `lightning_thunder-0.2.0.dev20240421/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240414
+Version: 0.2.0.dev20240421
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -28,17 +28,14 @@
 Requires-Dist: looseversion==1.3.0
 Requires-Dist: lightning-utilities>=0.7.0
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
-Provides-Extra: notebooks
-Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.4.4; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.1; extra == "test"
@@ -51,18 +48,21 @@
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
+Provides-Extra: notebooks
+Requires-Dist: cuda-python; extra == "notebooks"
+Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -70,15 +70,15 @@
   <a href="https://lightning.ai/">Lightning.ai</a> •
   <a href="#performance">Performance</a> •
   <a href="#get-started">Get started</a> •
   <a href="#install-thunder">Install</a> •
   <a href="#hello-world">Examples</a> •
   <a href="#inside-thunder-a-brief-look-at-the-core-features">Inside Thunder</a> •
   <a href="#get-involved">Get involved!</a> •
-  <a href="#documentation">Documentation</a>
+  <a href="https://lightning-thunder.readthedocs.io/en/latest/">Documentation</a>
 </p>
 
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://github.com/Lightning-AI/lightning-thunder/blob/main/LICENSE)
 [![CI testing](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml)
 [![General checks](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml)
 [![Documentation Status](https://readthedocs.org/projects/lightning-thunder/badge/?version=latest)](https://lightning-thunder.readthedocs.io/en/latest/?badge=latest)
 [![pre-commit.ci status](https://results.pre-commit.ci/badge/github/Lightning-AI/lightning-thunder/main.svg)](https://results.pre-commit.ci/latest/github/Lightning-AI/lightning-thunder/main)
@@ -102,27 +102,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
@@ -273,15 +273,15 @@
 
 Modules and functions compiled with Thunder fully interoperate with vanilla PyTorch and support PyTorch's autograd. Also, Thunder works alongside torch.compile to leverage its state-of-the-art optimizations.
 
 &#160;
 
 ## Documentation
 
-Docs are currently not hosted publicly. However you can build them locally really quickly:
+[Online documentation](https://lightning-thunder.readthedocs.io/en/latest/) is available. To build documentation locally you can use
 
 ```bash
 make docs
 ```
 
 and point your browser to the generated docs at `docs/build/index.html`.
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240414
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240421
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -13,30 +13,30 @@
 License :: OSI Approved :: Apache Software License Classifier: Operating System
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
-mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
-"notebooks" Requires-Dist: ipython[all]==8.23.0; extra == "notebooks" Provides-
-Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
-coverage==7.4.4; extra == "test" Requires-Dist: einops; extra == "test"
-Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
-extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test" Requires-Dist:
-hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
-"linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
+mpmath<1.4.0 Provides-Extra: test Requires-Dist: absl-py; extra == "test"
+Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
+"test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
+fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
+Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jsonargparse; extra == "test" Requires-Dist: numpy; extra ==
-"test" Requires-Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0;
-extra == "test" Requires-Dist: pytest-random-order==1.1.1; extra == "test"
-Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
-== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
-xlsxwriter; extra == "test"
+Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
+and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
+numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
+pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
+extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
+Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
+xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
+Requires-Dist: xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-
+Dist: cuda-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0;
+extra == "notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
@@ -134,19 +134,20 @@
 through [PyCUDA](https://documen.tician.de/pycuda/
 tutorial.html#interoperability-with-other-libraries-using-the-cuda-array-
 interface), [Numba](https://numba.readthedocs.io/en/stable/cuda/kernels.html),
 [CuPy](https://docs.cupy.dev/en/stable/user_guide/kernel.html) - Custom kernels
 written in [OpenAI Triton](https://github.com/openai/triton) Modules and
 functions compiled with Thunder fully interoperate with vanilla PyTorch and
 support PyTorch's autograd. Also, Thunder works alongside torch.compile to
-leverage its state-of-the-art optimizations.   ## Documentation Docs are
-currently not hosted publicly. However you can build them locally really
-quickly: ```bash make docs ``` and point your browser to the generated docs at
-`docs/build/index.html`.   ## Get involved! We appreciate your feedback and
-contributions. If you have feature requests, questions, or want to contribute
-code or config files, please don't hesitate to use the [GitHub Issue](https://
-github.com/Lightning-AI/lightning-thunder/issues) tracker. We welcome all
-individual contributors, regardless of their level of experience or hardware.
-Your contributions are valuable, and we are excited to see what you can
-accomplish in this collaborative and supportive environment.   ## License
-Lightning Thunder is released under the [Apache 2.0](https://www.apache.org/
-licenses/LICENSE-2.0) license. See the [LICENSE](LICENSE) file for details.
+leverage its state-of-the-art optimizations.   ## Documentation [Online
+documentation](https://lightning-thunder.readthedocs.io/en/latest/) is
+available. To build documentation locally you can use ```bash make docs ``` and
+point your browser to the generated docs at `docs/build/index.html`.   ## Get
+involved! We appreciate your feedback and contributions. If you have feature
+requests, questions, or want to contribute code or config files, please don't
+hesitate to use the [GitHub Issue](https://github.com/Lightning-AI/lightning-
+thunder/issues) tracker. We welcome all individual contributors, regardless of
+their level of experience or hardware. Your contributions are valuable, and we
+are excited to see what you can accomplish in this collaborative and supportive
+environment.   ## License Lightning Thunder is released under the [Apache 2.0]
+(https://www.apache.org/licenses/LICENSE-2.0) license. See the [LICENSE]
+(LICENSE) file for details.
```

### Comparing `lightning_thunder-0.2.0.dev20240414/README.md` & `lightning_thunder-0.2.0.dev20240421/README.md`

 * *Files 3% similar despite different names*

```diff
@@ -12,15 +12,15 @@
   <a href="https://lightning.ai/">Lightning.ai</a> •
   <a href="#performance">Performance</a> •
   <a href="#get-started">Get started</a> •
   <a href="#install-thunder">Install</a> •
   <a href="#hello-world">Examples</a> •
   <a href="#inside-thunder-a-brief-look-at-the-core-features">Inside Thunder</a> •
   <a href="#get-involved">Get involved!</a> •
-  <a href="#documentation">Documentation</a>
+  <a href="https://lightning-thunder.readthedocs.io/en/latest/">Documentation</a>
 </p>
 
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://github.com/Lightning-AI/lightning-thunder/blob/main/LICENSE)
 [![CI testing](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml)
 [![General checks](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml)
 [![Documentation Status](https://readthedocs.org/projects/lightning-thunder/badge/?version=latest)](https://lightning-thunder.readthedocs.io/en/latest/?badge=latest)
 [![pre-commit.ci status](https://results.pre-commit.ci/badge/github/Lightning-AI/lightning-thunder/main.svg)](https://results.pre-commit.ci/latest/github/Lightning-AI/lightning-thunder/main)
@@ -215,15 +215,15 @@
 
 Modules and functions compiled with Thunder fully interoperate with vanilla PyTorch and support PyTorch's autograd. Also, Thunder works alongside torch.compile to leverage its state-of-the-art optimizations.
 
 &#160;
 
 ## Documentation
 
-Docs are currently not hosted publicly. However you can build them locally really quickly:
+[Online documentation](https://lightning-thunder.readthedocs.io/en/latest/) is available. To build documentation locally you can use
 
 ```bash
 make docs
 ```
 
 and point your browser to the generated docs at `docs/build/index.html`.
```

### Comparing `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240414
+Version: 0.2.0.dev20240421
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -28,17 +28,14 @@
 Requires-Dist: looseversion==1.3.0
 Requires-Dist: lightning-utilities>=0.7.0
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
-Provides-Extra: notebooks
-Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.4.4; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.1; extra == "test"
@@ -51,18 +48,21 @@
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.2.0; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.5.0; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
+Provides-Extra: notebooks
+Requires-Dist: cuda-python; extra == "notebooks"
+Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -70,15 +70,15 @@
   <a href="https://lightning.ai/">Lightning.ai</a> •
   <a href="#performance">Performance</a> •
   <a href="#get-started">Get started</a> •
   <a href="#install-thunder">Install</a> •
   <a href="#hello-world">Examples</a> •
   <a href="#inside-thunder-a-brief-look-at-the-core-features">Inside Thunder</a> •
   <a href="#get-involved">Get involved!</a> •
-  <a href="#documentation">Documentation</a>
+  <a href="https://lightning-thunder.readthedocs.io/en/latest/">Documentation</a>
 </p>
 
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://github.com/Lightning-AI/lightning-thunder/blob/main/LICENSE)
 [![CI testing](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-testing.yml)
 [![General checks](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml/badge.svg?event=push)](https://github.com/Lightning-AI/lightning-thunder/actions/workflows/ci-checks.yml)
 [![Documentation Status](https://readthedocs.org/projects/lightning-thunder/badge/?version=latest)](https://lightning-thunder.readthedocs.io/en/latest/?badge=latest)
 [![pre-commit.ci status](https://results.pre-commit.ci/badge/github/Lightning-AI/lightning-thunder/main.svg)](https://results.pre-commit.ci/latest/github/Lightning-AI/lightning-thunder/main)
@@ -102,27 +102,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240414/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240421/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
@@ -273,15 +273,15 @@
 
 Modules and functions compiled with Thunder fully interoperate with vanilla PyTorch and support PyTorch's autograd. Also, Thunder works alongside torch.compile to leverage its state-of-the-art optimizations.
 
 &#160;
 
 ## Documentation
 
-Docs are currently not hosted publicly. However you can build them locally really quickly:
+[Online documentation](https://lightning-thunder.readthedocs.io/en/latest/) is available. To build documentation locally you can use
 
 ```bash
 make docs
 ```
 
 and point your browser to the generated docs at `docs/build/index.html`.
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240414
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240421
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -13,30 +13,30 @@
 License :: OSI Approved :: Apache Software License Classifier: Operating System
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
-mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
-"notebooks" Requires-Dist: ipython[all]==8.23.0; extra == "notebooks" Provides-
-Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
-coverage==7.4.4; extra == "test" Requires-Dist: einops; extra == "test"
-Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
-extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test" Requires-Dist:
-hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
-"linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
+mpmath<1.4.0 Provides-Extra: test Requires-Dist: absl-py; extra == "test"
+Requires-Dist: coverage==7.4.4; extra == "test" Requires-Dist: einops; extra ==
+"test" Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist:
+fdm==0.4.1; extra == "test" Requires-Dist: graphviz==0.20.1; extra == "test"
+Requires-Dist: hypothesis==6.100.0; extra == "test" Requires-Dist: jax;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jsonargparse; extra == "test" Requires-Dist: numpy; extra ==
-"test" Requires-Dist: pandas; extra == "test" Requires-Dist: pytest-cov==4.1.0;
-extra == "test" Requires-Dist: pytest-random-order==1.1.1; extra == "test"
-Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-Dist: pytest-
-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-xdist==3.5.0; extra
-== "test" Requires-Dist: pytest==8.1.1; extra == "test" Requires-Dist:
-xlsxwriter; extra == "test"
+Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin")
+and extra == "test" Requires-Dist: jsonargparse; extra == "test" Requires-Dist:
+numpy; extra == "test" Requires-Dist: pandas; extra == "test" Requires-Dist:
+pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-order==1.1.1;
+extra == "test" Requires-Dist: pytest-timeout==2.2.0; extra == "test" Requires-
+Dist: pytest-timestamper==0.0.10; extra == "test" Requires-Dist: pytest-
+xdist==3.5.0; extra == "test" Requires-Dist: pytest==8.1.1; extra == "test"
+Requires-Dist: xlsxwriter; extra == "test" Provides-Extra: notebooks Requires-
+Dist: cuda-python; extra == "notebooks" Requires-Dist: ipython[all]==8.23.0;
+extra == "notebooks"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
@@ -134,19 +134,20 @@
 through [PyCUDA](https://documen.tician.de/pycuda/
 tutorial.html#interoperability-with-other-libraries-using-the-cuda-array-
 interface), [Numba](https://numba.readthedocs.io/en/stable/cuda/kernels.html),
 [CuPy](https://docs.cupy.dev/en/stable/user_guide/kernel.html) - Custom kernels
 written in [OpenAI Triton](https://github.com/openai/triton) Modules and
 functions compiled with Thunder fully interoperate with vanilla PyTorch and
 support PyTorch's autograd. Also, Thunder works alongside torch.compile to
-leverage its state-of-the-art optimizations.   ## Documentation Docs are
-currently not hosted publicly. However you can build them locally really
-quickly: ```bash make docs ``` and point your browser to the generated docs at
-`docs/build/index.html`.   ## Get involved! We appreciate your feedback and
-contributions. If you have feature requests, questions, or want to contribute
-code or config files, please don't hesitate to use the [GitHub Issue](https://
-github.com/Lightning-AI/lightning-thunder/issues) tracker. We welcome all
-individual contributors, regardless of their level of experience or hardware.
-Your contributions are valuable, and we are excited to see what you can
-accomplish in this collaborative and supportive environment.   ## License
-Lightning Thunder is released under the [Apache 2.0](https://www.apache.org/
-licenses/LICENSE-2.0) license. See the [LICENSE](LICENSE) file for details.
+leverage its state-of-the-art optimizations.   ## Documentation [Online
+documentation](https://lightning-thunder.readthedocs.io/en/latest/) is
+available. To build documentation locally you can use ```bash make docs ``` and
+point your browser to the generated docs at `docs/build/index.html`.   ## Get
+involved! We appreciate your feedback and contributions. If you have feature
+requests, questions, or want to contribute code or config files, please don't
+hesitate to use the [GitHub Issue](https://github.com/Lightning-AI/lightning-
+thunder/issues) tracker. We welcome all individual contributors, regardless of
+their level of experience or hardware. Your contributions are valuable, and we
+are excited to see what you can accomplish in this collaborative and supportive
+environment.   ## License Lightning Thunder is released under the [Apache 2.0]
+(https://www.apache.org/licenses/LICENSE-2.0) license. See the [LICENSE]
+(LICENSE) file for details.
```

### Comparing `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240421/lightning_thunder.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240421/requirements/test.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/setup.py` & `lightning_thunder-0.2.0.dev20240421/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -331,16 +331,16 @@
 ) -> Callable:
     """Just-in-time compile a callable (function or model).
 
     Args:
         fn: A :class:`~torch.nn.Module` or a function to compile.
     Keyword Args:
         langctx: the language context, which language / library to emulate. default: "torch" for PyTorch compatibility.
-        executors: list of executors to use. Defaults to the executors returned by `thunder.get_default_executors()` and always amened by `thunder.get_always_executors()`.
-                   You can get a list of all available executors with `thunder.get_all_executors()`. You can also pass the name of an executor that's been registered, and it will be resolved with get_executor().
+        executors: list of executors to use. Defaults to the executors returned by :func:`thunder.get_default_executors` and always amended by :func:`thunder.get_always_executors`.
+                   You can get a list of all available executors with :func:`thunder.get_all_executors`. You can also pass the name of an executor that's been registered, and it will be resolved with :func:`thunder.extend.get_executor`.
         sharp_edges: sharp edge detection action. What to do when thunder detects a construct that is likely to lead to errors. Can be ``"allow"``, ``"warn"``, ``"error"``. Defaults to ``"allow"``.
         cache: caching mode. default: ``"constant values"```
 
                - ``"no caching"`` - disable caching and always recompute,
                - ``"constant values"`` - require Tensors to be of the same shape, device, dtype etc., and integers and strings to match exactly,
                - ``"same input"`` - don't check, but just assume that a cached function works if it exists.
         interpretation: (deprecated: don't use this, use the thunder.functional.jit entry point to get the functional jit)
@@ -579,18 +579,14 @@
 
             backward_trc = None
             if not cd.disable_torch_autograd_support:
                 tensor_cls = (pytorch.Tensor, TensorProxy)
                 requires_grad = any(isinstance(arg, tensor_cls) and arg.requires_grad for arg in inps)
 
                 if requires_grad:
-                    # thunder_backward may recursively call compile and wraps the result in a
-                    # torch.autograd.Function to support embedding of Thunder-compiled
-                    # functions in torch's Autograd
-
                     # Currently split_forward_backward also includes
                     # transform_for_execution and various sorting of symbols,
                     # applying transform_for_execution after this would be
                     # breaking the order of operations
                     computation_trc, backward_trc = split_forward_backward(computation_trc, cd, cs, *inps)
                     # Note computation_trc and backward_trc have been appended to cs.last_(backward_)traces
                     # by split_forward_backward
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -2806,14 +2806,65 @@
     def fn(self) -> Callable:
         model = (
             litgpt_model.Block(self.config).to(device=self.device, dtype=self.tdtype).requires_grad_(self.requires_grad)
         )
         return model
 
 
+class BatchNormBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
+    def __init__(
+        self,
+        input_shape,
+        device: str = "cuda",
+        dtype: dtypes.dtype = thunder.float32,
+        requires_grad: bool = False,
+    ) -> None:
+        super().__init__()
+
+        self.shape: Sequence[int] = input_shape
+        self.device: str = device
+        self.dtype: dtypes.dtype = dtype
+        self.tdtype: torch.dtype = ltorch.to_torch_dtype(dtype)
+        self.requires_grad: bool = requires_grad
+
+        self.devices: list[str] = [device]
+
+    def make_batch(self) -> tuple[list, dict]:
+        make_arg = partial(make_tensor, device=self.device, dtype=self.tdtype, requires_grad=self.requires_grad)
+        make = partial(make_tensor, device=self.device, dtype=self.tdtype, requires_grad=False)
+        normalized_shape = (self.shape[1],)
+        a = make_arg(self.shape)
+        weight = make_arg(normalized_shape)
+        bias = make_arg(normalized_shape)
+        # 'batch_norm' is not differentiable with respect to argument 'running_mean' and 'running_var'
+        running_mean = make(normalized_shape)
+        running_var = make(normalized_shape)
+        return (
+            a,
+            running_mean,
+            running_var,
+            weight,
+            bias,
+            True,
+        ), {}
+
+    def fn(self) -> Callable:
+        def foo(a, m, v, w, b, training):
+            return torch.nn.functional.batch_norm(
+                a,
+                m,
+                v,
+                w,
+                b,
+                training=training,
+            )
+
+        return foo
+
+
 # TODO Add descriptions to the executors when listed, and list them alphabetically
 # TODO Allow querying benchmark for details
 # TODO Allow specifying benchmark arguments
 # TODO Move command-line processing to benchmarks.py so users call `python benchmarks.py ...`
 # TODO Port other benchmarks
 # TODO Port additional executors
 # TODO Add parsing for common benchmark arguments, like shape, dtype, device, and string and integer values
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 1% similar despite different names*

```diff
@@ -327,39 +327,29 @@
         t0 = None
         if global_rank in [0, None]:
             # Calculate the model FLOPs
             self.calculate_model_flops()
             # Setup throughput Collection
             self.throughput = Throughput(window_size=self.max_iters - self.warmup_iter, world_size=world_size)
 
-        if "transformerengine" in self.compile:
-            import transformer_engine.pytorch as te
-
-            te_ctx = te.fp8_autocast
-        else:
-            from contextlib import nullcontext
-
-            te_ctx = nullcontext
-
         for i in range(self.max_iters):
             iter_t0 = time.perf_counter()
             if i == self.warmup_iter:  # warmup
                 t0 = iter_t0
 
             for step_idx in range(self.gradient_accumulation_steps):
                 input_ids, targets = next(self.train_data_iter)
                 input_ids = input_ids.to(device=self.device)
                 targets = targets.to(device=self.device)
 
                 if self.nsys_enabled and i == self.profiler_start and global_rank in [0, None] and step_idx == 0:
                     print("=====Start NSYS Profiling======")
                     torch.cuda.cudart().cudaProfilerStart()
 
-                with te_ctx():
-                    logits = self.model(input_ids)
+                logits = self.model(input_ids)
 
                 logits = logits.reshape(-1, logits.size(-1))
                 targets = targets.reshape(-1)
                 loss = (
                     torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1)
                     / self.gradient_accumulation_steps
                 )
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/einsum.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/targets.py`

 * *Files 2% similar despite different names*

```diff
@@ -33,14 +33,15 @@
     thunder_apex_nvfuser_executor,
     thunder_cudnn_executor,
     thunder_cudnn_nvfuser_executor,
     thunder_cudnn_layer_norm_executor,
     thunder_cudnn_layer_norm_nvfuser_executor,
     thunder_sdpa_executor,
     thunder_sdpa_torch_compile_nvfuser_executor,
+    BatchNormBenchmark,
 )
 
 from thunder.tests.litgpt_model import Config as LitGPTConfig
 
 
 APEX_FUSED_ROPE_AVAILABLE: bool = package_available("fused_rotary_positional_embedding")
 
@@ -429,14 +430,51 @@
     setup = make_setup(gelu_bench)
     fn = executor(gelu_bench)
     fn = wrap_for_benchmark(fn)
 
     benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
 
 
+@pytest.mark.parametrize(
+    "executor,",
+    fwd_executors,
+    ids=fwd_executor_ids,
+)
+def test_batch_norm_fwd(benchmark, executor: Callable):
+    bn_bench: Benchmark = BatchNormBenchmark(
+        (16, 128, 768), device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
+    )
+
+    setup = make_setup(bn_bench)
+    fn = executor(bn_bench)
+    fn = wrap_for_benchmark(fn)
+
+    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+
+
+@pytest.mark.parametrize(
+    "executor,",
+    (
+        torch_fwd_bwd,
+        torchcompile_fwd_bwd,
+        thunder_fwd_bwd,
+    ),
+    ids=fwd_executor_ids,
+)
+def test_batch_norm_grad(benchmark, executor: Callable):
+    bn_bench: Benchmark = BatchNormBenchmark(
+        (16, 128, 768), device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
+    )
+
+    setup = make_setup(bn_bench)
+    fn = executor(bn_bench)
+    fn = wrap_for_benchmark(fn)
+    benchmark.pedantic(fn, setup=setup, rounds=200, warmup_rounds=20)
+
+
 # TODO Improve cross entropy's fwd+bwd perf when using the PyTorch executor
 #   See "torch.cross_entropy implementation has incorrect dtype metadata + bwd
 #        is very slow"
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240421/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/clang/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240421/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/common.py` & `lightning_thunder-0.2.0.dev20240421/thunder/common.py`

 * *Files 2% similar despite different names*

```diff
@@ -34,15 +34,14 @@
 from thunder.core.transform_common import dce, cse
 from thunder.core.proxies import is_proxyable, proxy, Proxy, CollectionProxy, TensorProxy, DDPType, FutureTensorProxy
 import thunder.core.prims as prims
 import thunder.distributed as dist
 import thunder.torch as ltorch
 from thunder.extend import Executor, get_default_executors, get_always_executors, OperatorExecutor, add_executor_lists
 import thunder.executors as executors
-from thunder.executors.torch_autograd import thunder_backward
 from thunder.core.transforms import autocast
 from thunder.core.dtypes import to_dtype
 
 import torch as torch
 import numpy as np
 
 #
@@ -730,34 +729,18 @@
             #   1) The grad() transform is not applied
             #   2) At least one input tensor (or tensor proxy) requires grad
             if not _using_grad_transform:
                 flat_args, _ = tree_flatten((args, kwargs))
                 tensor_cls = (torch.Tensor, TensorProxy)
                 requires_grad = any(isinstance(arg, tensor_cls) and arg.requires_grad for arg in flat_args)
                 if not cd.disable_torch_autograd_support and requires_grad:
-                    # thunder_backward may recursively call compile and wraps the result in a
-                    # torch.autograd.Function to support embedding of Thunder-compiled
-                    # functions in torch's Autograd
-                    cs.last_trace_host_execution_start = time.time_ns()
-                    c = thunder_backward(compile_data=cd, compile_stats=cs)(processed_function)
-                    result = c(*args, **kwargs)
-                    cs.last_trace_host_execution_stop = time.time_ns()
-                    cs.last_executed = c
-                    if cd.cache_option is CACHE_OPTIONS.CONSTANT_VALUES:
-                        cache_put(
-                            cs.cache,
-                            c,
-                            None,
-                            args[cd.num_constant_args :],
-                            kwargs,
-                            autocast_key=None,
-                            distributed_key=distributed_key,
-                        )
-                    cs.last_trace_host_stop = time.time_ns()
-                    return result
+                    raise NotImplementedError(
+                        "torch.autograd.Function integration is not supported in thunder.compile(). "
+                        "Please use thunder.jit() to compile functions that require torch.autograd.Function."
+                    )
 
             # TODO Revisit jit() behavior when hit in a trace ctx
             #   This will inline the invocation of compile into the current
             #   trace (UNLESS there was a cache hit, per above)
             #   This interaction between the cache and tracing seems odd
             # TODO Support a practitioner who wants to explicitly and separately compile
             #   part of the program
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/interpreter.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/jit_ext.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/prims.py`

 * *Files 2% similar despite different names*

```diff
@@ -3554,67 +3554,14 @@
     shape = (num_weights, grad.shape[-1])
     return TensorProxy(shape=shape, device=grad.device, dtype=grad.dtype, requires_grad=False)
 
 
 embedding_backward = make_prim(PrimIDs.EMBEDDING_BACKWARD, "embedding_backward", meta=embedding_backward_meta)
 
 
-def batch_norm_meta(
-    a: TensorProxy,
-    /,
-    weight: None | TensorProxy,
-    bias: None | TensorProxy,
-    running_mean: None | TensorProxy,
-    running_var: None | TensorProxy,
-    training: bool,
-    momentum: Number,
-    eps: Number,
-) -> tuple[TensorProxy, None | TensorProxy, None | TensorProxy]:
-    # Checks types
-    utils.check_type(a, TensorProxy)
-    utils.check_type(momentum, Number)
-    utils.check_type(eps, Number)
-
-    utils.check(a.ndim >= 2, lambda: f"Input tensor must have at least batch and channel dimensions!")
-    if not training:
-        utils.check(
-            running_mean is not None and running_var is not None,
-            lambda: f"running_mean and running_var must be defined in evaluation mode",
-        )
-
-    num_features = a.shape[1]
-
-    def check_type_device_shape(param, param_name):
-        utils.check_type(param, TensorProxy)
-        utils.check_same_device(a, param)
-        utils.check(
-            param.shape == (num_features,),
-            lambda: f"Expected {param_name}.shape={param.shape} to be {(num_features,)}!",
-        )
-
-    if weight is not None:
-        check_type_device_shape(weight, "weight")
-        utils.check_same_dtype(a, weight)
-    if bias is not None:
-        check_type_device_shape(bias, "bias")
-        utils.check_same_dtype(a, bias)
-    if running_mean is not None:
-        check_type_device_shape(running_mean, "running_mean")
-    if running_var is not None:
-        check_type_device_shape(running_var, "running_var")
-    return (
-        TensorProxy(like=a),
-        (TensorProxy(like=a, shape=(num_features,)) if running_mean is None else TensorProxy(like=running_mean)),
-        (TensorProxy(like=a, shape=(num_features,)) if running_var is None else TensorProxy(like=running_var)),
-    )
-
-
-batch_norm = make_prim(PrimIDs.BATCH_NORM, "batch_norm", meta=batch_norm_meta, tags=(OpTags.REDUCTION_OP,))
-
-
 def copy__meta(
     copy_from: TensorProxy,
     copy_to: TensorProxy,
 ):
     utils.check_type(copy_from, TensorProxy)
     utils.check_type(copy_to, TensorProxy)
     utils.check_same_device(copy_from, copy_to)
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/proxies.py`

 * *Files 0% similar despite different names*

```diff
@@ -1227,17 +1227,21 @@
         return tensorproxy(self, name=name, history=self.history)
 
     def type_string(self):
         return f"{self.device} {self.dtype.shortname()}{list(self.shape)}"
 
     # NOTE __getattr__ is overridden to support language-specific methods
     def __getattr__(self, attr: str, /):
-        method: None | Callable = resolve_method(attr, self)
-        baseutils.check(method is not None, lambda: f"Unknown attribute {attr}", exception_type=AttributeError)
-        return partial(method, self)
+        method_or_value: None | Callable | Any = resolve_method(attr, self)
+        baseutils.check(method_or_value is not None, lambda: f"Unknown attribute {attr}", exception_type=AttributeError)
+
+        if callable(method_or_value):
+            return partial(method_or_value, self)
+
+        return method_or_value
 
     #
     # Datatype conversion shorthands
     #
 
     def float(self):
         method = resolve_method("float", self)
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/rematerialization.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/trace.py`

 * *Files 4% similar despite different names*

```diff
@@ -85,14 +85,18 @@
         self._siginfo = None
 
         # TODO Improve "freezing" traces
         self._complete = False
 
         self._any_future_tensors = False
 
+        # This is a detail for enabling transformer_engine's autocast manager.
+        # We only want the forward function to be called with ctx manager.
+        self._include_te_fp8_autocast = False
+
     @property
     def prologue(self):
         return self._prologue
 
     @property
     def is_prologue(self):
         return self._is_prologue
@@ -363,14 +367,24 @@
             if len(import_ctx) > 0:
                 program.append("")
 
             # Prints the signature and the no_grad context (for when calling torch operations)
             program.append("@torch.no_grad()")
             # Prints the signature and the no_autocast context
             program.append("@no_autocast()")
+
+            # NOTE: For TransformerEngine executor, we want to wrap the generated
+            # forward function in fp8_autocast ctx manager.
+            # In future, if other executor has similar requirements, we should
+            # add a new extension point for executors
+            from thunder.executors.transformer_engineex import _is_te_linear_enabled, _get_te_wrapper_string
+
+            if self._include_te_fp8_autocast and _is_te_linear_enabled(import_ctx, object_ctx):
+                program.append(_get_te_wrapper_string())
+
             program.append(signature_str)
 
             # TODO Print objects from context
             # Prints constants (if any) upfront
             # constants = tuple(om for om in self._object_meta_map.values() if om.is_constant)
             # if len(constants) > 0:
             #     const_comment_str = f"{indent}# Initializes constants"
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/transforms.py`

 * *Files 1% similar despite different names*

```diff
@@ -2149,6641 +2149,6587 @@
 00008640: 2076 6172 2062 7764 0a20 2020 206e 6f72   var bwd.    nor
 00008650: 6d61 6c69 7a61 7469 6f6e 5f73 6361 6c61  malization_scala
 00008660: 7220 3d20 6e5f 656c 656d 5f72 6564 7563  r = n_elem_reduc
 00008670: 6564 202d 2063 6f72 7265 6374 696f 6e0a  ed - correction.
 00008680: 2020 2020 7265 7374 6f72 6564 5f67 7620      restored_gv 
 00008690: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
 000086a0: 645f 6469 6d73 2867 762c 2064 696d 732c  d_dims(gv, dims,
-000086b0: 2061 2e73 6861 7065 290a 2020 2020 7265   a.shape).    re
-000086c0: 7374 6f72 6564 5f6d 6561 6e20 3d20 7265  stored_mean = re
-000086d0: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
-000086e0: 6d73 286d 2c20 6469 6d73 2c20 612e 7368  ms(m, dims, a.sh
-000086f0: 6170 6529 0a20 2020 2076 6172 5f67 7261  ape).    var_gra
-00008700: 6420 3d20 2832 202a 2072 6573 746f 7265  d = (2 * restore
-00008710: 645f 6776 202a 2028 6120 2d20 7265 7374  d_gv * (a - rest
-00008720: 6f72 6564 5f6d 6561 6e29 2920 2f20 6e6f  ored_mean)) / no
-00008730: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
-00008740: 6172 0a0a 2020 2020 7075 745f 6772 6164  ar..    put_grad
-00008750: 2861 2c20 6d65 616e 5f67 7261 6420 2b20  (a, mean_grad + 
-00008760: 7661 725f 6772 6164 290a 0a20 2020 2072  var_grad)..    r
-00008770: 6574 7572 6e20 762c 206d 0a0a 0a72 6567  eturn v, m...reg
-00008780: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00008790: 5641 525f 4d45 414e 2c20 5f76 6172 5f6d  VAR_MEAN, _var_m
-000087a0: 6561 6e5f 7072 696d 5f67 7261 6429 0a0a  ean_prim_grad)..
-000087b0: 0a23 0a23 204c 696e 6561 7220 616c 6765  .#.# Linear alge
-000087c0: 6272 6120 6f70 6572 6174 6f72 2067 7261  bra operator gra
-000087d0: 6473 0a23 0a40 746f 7263 6863 7478 0a64  ds.#.@torchctx.d
-000087e0: 6566 205f 6c69 6e65 6172 5f70 7269 6d5f  ef _linear_prim_
-000087f0: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
-00008800: 6f78 792c 2077 3a20 5465 6e73 6f72 5072  oxy, w: TensorPr
-00008810: 6f78 792c 2062 6961 733a 204e 6f6e 6520  oxy, bias: None 
-00008820: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-00008830: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00008840: 2020 2066 7764 203d 2070 7269 6d73 2e6c     fwd = prims.l
-00008850: 696e 6561 7228 612c 2077 2c20 6269 6173  inear(a, w, bias
-00008860: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00008870: 7261 6428 6677 6429 0a0a 2020 2020 6669  rad(fwd)..    fi
-00008880: 7273 745f 6469 6d20 3d20 2d32 0a20 2020  rst_dim = -2.   
-00008890: 2067 7261 645f 6120 3d20 6c74 6f72 6368   grad_a = ltorch
-000088a0: 2e6d 6174 6d75 6c28 672e 7265 7368 6170  .matmul(g.reshap
-000088b0: 6528 2d31 2c20 672e 7368 6170 655b 2d31  e(-1, g.shape[-1
-000088c0: 5d29 2c20 7729 2e72 6573 6861 7065 2861  ]), w).reshape(a
-000088d0: 2e73 6861 7065 290a 0a20 2020 2067 7261  .shape)..    gra
-000088e0: 645f 773a 2054 656e 736f 7250 726f 7879  d_w: TensorProxy
-000088f0: 0a20 2020 2069 6620 612e 6e64 696d 203d  .    if a.ndim =
-00008900: 3d20 313a 0a20 2020 2020 2020 2067 7261  = 1:.        gra
-00008910: 645f 7720 3d20 6c74 6f72 6368 2e6d 6174  d_w = ltorch.mat
-00008920: 6d75 6c28 672e 756e 7371 7565 657a 6528  mul(g.unsqueeze(
-00008930: 6669 7273 745f 6469 6d29 2e6d 542c 2061  first_dim).mT, a
-00008940: 2e75 6e73 7175 6565 7a65 2866 6972 7374  .unsqueeze(first
-00008950: 5f64 696d 2929 0a20 2020 2065 6c73 653a  _dim)).    else:
-00008960: 0a20 2020 2020 2020 2067 7261 645f 7720  .        grad_w 
-00008970: 3d20 6c74 6f72 6368 2e6d 6174 6d75 6c28  = ltorch.matmul(
-00008980: 672e 7265 7368 6170 6528 2d31 2c20 672e  g.reshape(-1, g.
-00008990: 7368 6170 655b 2d31 5d29 2e6d 542c 2061  shape[-1]).mT, a
-000089a0: 2e72 6573 6861 7065 282d 312c 2061 2e73  .reshape(-1, a.s
-000089b0: 6861 7065 5b2d 315d 2929 0a0a 2020 2020  hape[-1]))..    
-000089c0: 7075 745f 6772 6164 7328 2861 2c20 7729  put_grads((a, w)
-000089d0: 2c20 2867 7261 645f 612c 2067 7261 645f  , (grad_a, grad_
-000089e0: 7729 290a 0a20 2020 2069 6620 6269 6173  w))..    if bias
-000089f0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00008a00: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
-00008a10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00008a20: 2067 7261 645f 6269 6173 203d 206c 746f   grad_bias = lto
-00008a30: 7263 682e 7375 6d28 672c 2074 7570 6c65  rch.sum(g, tuple
-00008a40: 2872 616e 6765 2867 2e6e 6469 6d20 2d20  (range(g.ndim - 
-00008a50: 3129 2929 0a20 2020 2020 2020 2065 6c73  1))).        els
-00008a60: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-00008a70: 7261 645f 6269 6173 203d 2067 0a20 2020  rad_bias = g.   
-00008a80: 2020 2020 2070 7574 5f67 7261 6428 6269       put_grad(bi
-00008a90: 6173 2c20 6772 6164 5f62 6961 7329 0a0a  as, grad_bias)..
-00008aa0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008ab0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008ac0: 6964 732e 4c49 4e45 4152 2c20 5f6c 696e  ids.LINEAR, _lin
-00008ad0: 6561 725f 7072 696d 5f67 7261 6429 0a0a  ear_prim_grad)..
-00008ae0: 0a23 2054 4f44 4f20 4164 6420 6578 706c  .# TODO Add expl
-00008af0: 6963 6974 206c 746f 7263 6820 7673 2063  icit ltorch vs c
-00008b00: 6c61 6e67 206d 6f64 756c 6520 746f 2074  lang module to t
-00008b10: 6865 2074 656e 736f 7220 6f70 6572 6174  he tensor operat
-00008b20: 696f 6e73 2062 656c 6f77 0a23 2054 4f44  ions below.# TOD
-00008b30: 4f20 636f 756c 6420 7765 2067 6574 2072  O could we get r
-00008b40: 6964 206f 6620 7468 6520 6669 6e61 6c20  id of the final 
-00008b50: 7371 7565 657a 6573 2069 6e20 7468 6520  squeezes in the 
-00008b60: 622e 6e64 696d 203d 3d20 3120 6361 7365  b.ndim == 1 case
-00008b70: 2061 6e64 2074 6865 2061 2e6e 6469 6d20   and the a.ndim 
-00008b80: 3d3d 2031 2063 6173 653f 0a40 746f 7263  == 1 case?.@torc
-00008b90: 6863 7478 0a64 6566 205f 6d61 746d 756c  hctx.def _matmul
-00008ba0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00008bb0: 6e73 6f72 5072 6f78 792c 2062 3a20 5465  nsorProxy, b: Te
-00008bc0: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00008bd0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00008be0: 2020 6677 6420 3d20 7072 696d 732e 6d61    fwd = prims.ma
-00008bf0: 746d 756c 2861 2c20 6229 0a20 2020 2067  tmul(a, b).    g
-00008c00: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00008c10: 0a0a 2020 2020 6c61 7374 5f64 696d 203d  ..    last_dim =
-00008c20: 2028 2d31 2c29 0a20 2020 2066 6972 7374   (-1,).    first
-00008c30: 5f64 696d 203d 2028 2d32 2c29 0a20 2020  _dim = (-2,).   
-00008c40: 2069 6620 612e 6e64 696d 203d 3d20 3120   if a.ndim == 1 
-00008c50: 616e 6420 622e 6e64 696d 203d 3d20 313a  and b.ndim == 1:
-00008c60: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
-00008c70: 6473 2828 612c 2062 292c 2028 6720 2a20  ds((a, b), (g * 
-00008c80: 622c 2067 202a 2061 2929 0a20 2020 2065  b, g * a)).    e
-00008c90: 6c69 6620 622e 6e64 696d 203d 3d20 313a  lif b.ndim == 1:
-00008ca0: 0a20 2020 2020 2020 2067 6120 3d20 756e  .        ga = un
-00008cb0: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
-00008cc0: 6469 6d29 2040 2075 6e73 7175 6565 7a65  dim) @ unsqueeze
-00008cd0: 2862 2c20 6c61 7374 5f64 696d 292e 6d54  (b, last_dim).mT
-00008ce0: 0a20 2020 2020 2020 2067 6220 3d20 612e  .        gb = a.
-00008cf0: 6d54 2040 2075 6e73 7175 6565 7a65 2867  mT @ unsqueeze(g
-00008d00: 2c20 6c61 7374 5f64 696d 290a 2020 2020  , last_dim).    
-00008d10: 2020 2020 6966 2067 2e6e 6469 6d20 3e20      if g.ndim > 
-00008d20: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
-00008d30: 6220 3d20 7371 7565 657a 6528 6762 2c20  b = squeeze(gb, 
-00008d40: 6c61 7374 5f64 696d 290a 2020 2020 2020  last_dim).      
-00008d50: 2020 2020 2020 6762 203d 206c 746f 7263        gb = ltorc
-00008d60: 682e 7375 6d28 6762 2c20 7475 706c 6528  h.sum(gb, tuple(
-00008d70: 7261 6e67 6528 6762 2e6e 6469 6d20 2d20  range(gb.ndim - 
-00008d80: 3129 2929 0a20 2020 2020 2020 2070 7574  1))).        put
-00008d90: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
-00008da0: 6761 2c20 6762 2e73 7175 6565 7a65 2829  ga, gb.squeeze()
-00008db0: 2929 0a20 2020 2065 6c69 6620 612e 6e64  )).    elif a.nd
-00008dc0: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
-00008dd0: 2067 6120 3d20 756e 7371 7565 657a 6528   ga = unsqueeze(
-00008de0: 672c 2066 6972 7374 5f64 696d 2920 4020  g, first_dim) @ 
-00008df0: 622e 6d54 0a20 2020 2020 2020 2069 6620  b.mT.        if 
-00008e00: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
-00008e10: 2020 2020 2020 2020 6761 203d 206c 746f          ga = lto
-00008e20: 7263 682e 7375 6d28 6761 2c20 7475 706c  rch.sum(ga, tupl
-00008e30: 6528 7261 6e67 6528 6761 2e6e 6469 6d20  e(range(ga.ndim 
-00008e40: 2d20 3129 2929 0a20 2020 2020 2020 2067  - 1))).        g
-00008e50: 6220 3d20 756e 7371 7565 657a 6528 612c  b = unsqueeze(a,
-00008e60: 2066 6972 7374 5f64 696d 292e 6d54 2040   first_dim).mT @
-00008e70: 2075 6e73 7175 6565 7a65 2867 2c20 6669   unsqueeze(g, fi
-00008e80: 7273 745f 6469 6d29 0a20 2020 2020 2020  rst_dim).       
-00008e90: 2070 7574 5f67 7261 6473 2828 612c 2062   put_grads((a, b
-00008ea0: 292c 2028 6761 2e73 7175 6565 7a65 2829  ), (ga.squeeze()
-00008eb0: 2c20 6762 2929 0a20 2020 2065 6c73 653a  , gb)).    else:
-00008ec0: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
-00008ed0: 6473 2828 612c 2062 292c 2028 6720 4020  ds((a, b), (g @ 
-00008ee0: 622e 6d54 2c20 612e 6d54 2040 2067 2929  b.mT, a.mT @ g))
-00008ef0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00008f00: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00008f10: 2870 6964 732e 4d41 544d 554c 2c20 5f6d  (pids.MATMUL, _m
-00008f20: 6174 6d75 6c5f 7072 696d 5f67 7261 6429  atmul_prim_grad)
-00008f30: 0a0a 230a 2320 4e4e 206f 7065 7261 746f  ..#.# NN operato
-00008f40: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
-00008f50: 6368 6374 780a 6465 6620 5f65 6d62 6564  chctx.def _embed
-00008f60: 6469 6e67 5f70 7269 6d5f 6772 6164 280a  ding_prim_grad(.
-00008f70: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
-00008f80: 7879 2c20 2f2c 2077 6569 6768 742c 202a  xy, /, weight, *
-00008f90: 2c20 7061 6464 696e 675f 6964 783d 2d31  , padding_idx=-1
-00008fa0: 2c20 6d61 785f 6e6f 726d 3d4e 6f6e 652c  , max_norm=None,
-00008fb0: 206e 6f72 6d5f 7479 7065 3d32 2e30 2c20   norm_type=2.0, 
-00008fc0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-00008fd0: 6571 3d46 616c 7365 2c20 7370 6172 7365  eq=False, sparse
-00008fe0: 3d46 616c 7365 0a29 202d 3e20 5465 6e73  =False.) -> Tens
-00008ff0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00009000: 203d 2070 7269 6d73 2e65 6d62 6564 6469   = prims.embeddi
-00009010: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
-00009020: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
-00009030: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
-00009040: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
-00009050: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
-00009060: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
-00009070: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
-00009080: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
-00009090: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-000090a0: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
-000090b0: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
-000090c0: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
-000090d0: 2020 290a 0a20 2020 2067 203d 2067 6574    )..    g = get
-000090e0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-000090f0: 5f67 7261 6420 3d20 7072 696d 732e 656d  _grad = prims.em
-00009100: 6265 6464 696e 675f 6261 636b 7761 7264  bedding_backward
-00009110: 2867 2c20 612c 2077 6569 6768 742e 7368  (g, a, weight.sh
-00009120: 6170 655b 305d 2c20 7061 6464 696e 675f  ape[0], padding_
-00009130: 6964 782c 2073 6361 6c65 5f67 7261 645f  idx, scale_grad_
-00009140: 6279 5f66 7265 712c 2073 7061 7273 6529  by_freq, sparse)
-00009150: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00009160: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-00009170: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00009180: 7465 725f 6772 6164 2870 6964 732e 454d  ter_grad(pids.EM
-00009190: 4245 4444 494e 472c 205f 656d 6265 6464  BEDDING, _embedd
-000091a0: 696e 675f 7072 696d 5f67 7261 6429 0a0a  ing_prim_grad)..
-000091b0: 230a 2320 5068 616e 746f 6d20 6772 6164  #.# Phantom grad
-000091c0: 2074 7261 6e73 666f 726d 2068 656c 7065   transform helpe
-000091d0: 7273 0a23 0a0a 0a64 6566 205f 6765 745f  rs.#...def _get_
-000091e0: 6772 6164 666e 2862 7379 6d3a 2042 6f75  gradfn(bsym: Bou
-000091f0: 6e64 5379 6d62 6f6c 2c20 2a2c 2065 7865  ndSymbol, *, exe
-00009200: 6375 746f 7273 5f6c 6973 743a 2053 6571  cutors_list: Seq
-00009210: 7565 6e63 655b 416e 795d 203d 2074 7570  uence[Any] = tup
-00009220: 6c65 2829 2920 2d3e 204e 6f6e 6520 7c20  le()) -> None | 
-00009230: 4361 6c6c 6162 6c65 3a0a 2020 2020 6364  Callable:.    cd
-00009240: 203d 2067 6574 5f63 6f6d 7069 6c65 5f64   = get_compile_d
-00009250: 6174 6128 290a 2020 2020 6578 6563 7574  ata().    execut
-00009260: 6f72 735f 6c69 7374 203d 2063 642e 6578  ors_list = cd.ex
-00009270: 6563 7574 6f72 735f 6c69 7374 2069 6620  ecutors_list if 
-00009280: 6364 2069 7320 6e6f 7420 4e6f 6e65 2065  cd is not None e
-00009290: 6c73 6520 6578 6563 7574 6f72 735f 6c69  lse executors_li
-000092a0: 7374 0a20 2020 2023 2043 6865 636b 7320  st.    # Checks 
-000092b0: 6966 2074 6865 2065 7865 6375 746f 7220  if the executor 
-000092c0: 7768 6963 6820 6861 7320 7072 696f 7269  which has priori
-000092d0: 7479 2066 6f72 2074 6869 7320 6f70 6572  ty for this oper
-000092e0: 6174 696f 6e20 6861 7320 6120 7370 6563  ation has a spec
-000092f0: 6966 6963 2067 7261 6420 7472 616e 7366  ific grad transf
-00009300: 6f72 6d20 666f 7220 6974 0a20 2020 2066  orm for it.    f
-00009310: 6f72 2065 7820 696e 2065 7865 6375 746f  or ex in executo
-00009320: 7273 5f6c 6973 743a 0a20 2020 2020 2020  rs_list:.       
-00009330: 2069 6620 6578 2e63 616e 5f65 7865 6375   if ex.can_execu
-00009340: 7465 5f6f 725f 6675 7365 2862 7379 6d29  te_or_fuse(bsym)
-00009350: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-00009360: 5f67 7261 645f 7472 616e 7366 6f72 6d3a  _grad_transform:
-00009370: 204e 6f6e 6520 7c20 4361 6c6c 6162 6c65   None | Callable
-00009380: 203d 2065 782e 6765 745f 6772 6164 5f74   = ex.get_grad_t
-00009390: 7261 6e73 666f 726d 2862 7379 6d2e 7379  ransform(bsym.sy
-000093a0: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
-000093b0: 6620 6578 5f67 7261 645f 7472 616e 7366  f ex_grad_transf
-000093c0: 6f72 6d20 6973 206e 6f74 204e 6f6e 653a  orm is not None:
-000093d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000093e0: 2072 6574 7572 6e20 6578 5f67 7261 645f   return ex_grad_
-000093f0: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
-00009400: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-00009410: 2023 2049 6620 7468 6520 6578 6563 7574   # If the execut
-00009420: 6f72 2064 6f65 736e 2774 2064 6566 696e  or doesn't defin
-00009430: 6520 6974 7320 6f77 6e20 6772 6164 2074  e its own grad t
-00009440: 7261 6e73 666f 726d 2c20 7468 6973 206a  ransform, this j
-00009450: 7573 7420 7265 7475 726e 7320 7468 6520  ust returns the 
-00009460: 6465 6661 756c 7420 6772 6164 2074 7261  default grad tra
-00009470: 6e73 666f 726d 2066 6f72 2074 6865 2062  nsform for the b
-00009480: 7379 6d0a 2020 2020 6772 6164 666e 203d  sym.    gradfn =
-00009490: 205f 6772 6164 5f66 6e5f 6d61 702e 6765   _grad_fn_map.ge
-000094a0: 7428 6273 796d 2e73 796d 2e69 642c 204e  t(bsym.sym.id, N
-000094b0: 6f6e 6529 0a20 2020 2072 6574 7572 6e20  one).    return 
-000094c0: 6772 6164 666e 0a0a 0a23 2054 6865 2064  gradfn...# The d
-000094d0: 6566 6175 6c74 2067 7261 6420 7370 6563  efault grad spec
-000094e0: 6966 6965 7220 666f 7220 7468 6520 6772  ifier for the gr
-000094f0: 6164 2074 7261 6e73 666f 726d 0a23 2020  ad transform.#  
-00009500: 2046 6f72 2065 6163 6820 7465 6e73 6f72   For each tensor
-00009510: 206f 7574 7075 7420 226f 2220 7265 7175   output "o" requ
-00009520: 6972 696e 6720 6772 6164 2c20 7370 6563  iring grad, spec
-00009530: 6966 6965 7320 6120 6772 6164 206f 6620  ifies a grad of 
-00009540: 6f6e 6573 5f6c 696b 6528 6f29 0a64 6566  ones_like(o).def
-00009550: 205f 6772 6164 5f73 7065 6369 6669 6572   _grad_specifier
-00009560: 5f64 6566 6175 6c74 2870 7974 7265 653a  _default(pytree:
-00009570: 2041 6e79 2920 2d3e 204e 6f6e 653a 0a20   Any) -> None:. 
-00009580: 2020 2066 6c61 7473 2c20 5f20 3d20 7472     flats, _ = tr
-00009590: 6565 5f66 6c61 7474 656e 2870 7974 7265  ee_flatten(pytre
-000095a0: 6529 0a0a 2020 2020 666f 7220 6620 696e  e)..    for f in
-000095b0: 2066 6c61 7473 3a0a 2020 2020 2020 2020   flats:.        
-000095c0: 6966 2069 7369 6e73 7461 6e63 6528 662c  if isinstance(f,
-000095d0: 2054 656e 736f 7250 726f 7879 2920 616e   TensorProxy) an
-000095e0: 6420 662e 7265 7175 6972 6573 5f67 7261  d f.requires_gra
-000095f0: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
-00009600: 204e 4f54 4520 5468 6973 2075 7365 7320   NOTE This uses 
-00009610: 636c 616e 672e 6f6e 6573 5f6c 696b 6520  clang.ones_like 
-00009620: 666f 7220 6e6f 7720 6265 6361 7573 6520  for now because 
-00009630: 6c74 6f72 6368 2e6f 6e65 735f 6c69 6b65  ltorch.ones_like
-00009640: 2077 696c 6c20 6578 7465 6e64 2074 6865   will extend the
-00009650: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00009660: 206c 6966 6574 696d 6520 6f66 2066 2c20   lifetime of f, 
-00009670: 7768 696c 6520 636c 616e 672e 6f6e 6573  while clang.ones
-00009680: 5f6c 696b 6520 7769 6c6c 2065 7874 7261  _like will extra
-00009690: 6374 2074 6865 206d 6574 6164 6174 6120  ct the metadata 
-000096a0: 6f66 2066 2061 7420 7472 6163 6520 7469  of f at trace ti
-000096b0: 6d65 0a20 2020 2020 2020 2020 2020 2070  me.            p
-000096c0: 7269 6d73 2e70 7574 5f67 7261 6428 662c  rims.put_grad(f,
-000096d0: 2063 6c61 6e67 2e66 756c 6c5f 6c69 6b65   clang.full_like
-000096e0: 2866 2c20 312e 3029 290a 0a0a 2320 544f  (f, 1.0))...# TO
-000096f0: 444f 2054 6573 7420 7769 7468 2062 7566  DO Test with buf
-00009700: 6665 7273 0a64 6566 205f 6772 6164 5f6f  fers.def _grad_o
-00009710: 7574 5f73 7065 6369 6669 6572 5f64 6566  ut_specifier_def
-00009720: 6175 6c74 2870 7974 7265 653a 2041 6e79  ault(pytree: Any
-00009730: 2920 2d3e 206c 6973 745b 5465 6e73 6f72  ) -> list[Tensor
-00009740: 5072 6f78 795d 3a0a 2020 2020 666c 6174  Proxy]:.    flat
-00009750: 732c 205f 203d 2074 7265 655f 666c 6174  s, _ = tree_flat
-00009760: 7465 6e28 7079 7472 6565 290a 2020 2020  ten(pytree).    
-00009770: 6772 6164 7320 3d20 6c69 7374 285b 7072  grads = list([pr
-00009780: 696d 732e 6765 745f 6772 6164 2866 2920  ims.get_grad(f) 
-00009790: 666f 7220 6620 696e 2066 6c61 7473 2069  for f in flats i
-000097a0: 6620 6973 696e 7374 616e 6365 2866 2c20  f isinstance(f, 
-000097b0: 5465 6e73 6f72 5072 6f78 7929 2061 6e64  TensorProxy) and
-000097c0: 2066 2e72 6571 7569 7265 735f 6772 6164   f.requires_grad
-000097d0: 5d29 0a20 2020 2072 6574 7572 6e20 6772  ]).    return gr
-000097e0: 6164 730a 0a0a 2320 544f 444f 2046 6f72  ads...# TODO For
-000097f0: 6d61 6c6c 7920 6465 6669 6e65 2074 6865  mally define the
-00009800: 2022 6772 6164 6965 6e74 2220 6f66 2061   "gradient" of a
-00009810: 2074 656e 736f 720a 2320 544f 444f 2049   tensor.# TODO I
-00009820: 6620 6e6f 6e65 206f 6620 7468 6520 696e  f none of the in
-00009830: 7075 7473 2074 6f20 616e 206f 7065 7261  puts to an opera
-00009840: 7469 6f6e 2072 6571 7569 7265 2067 7261  tion require gra
-00009850: 642c 2074 6865 6e20 7765 2063 6f75 6c64  d, then we could
-00009860: 206c 6561 7665 2074 6861 7420 6f70 6572   leave that oper
-00009870: 6174 696f 6e20 616c 6f6e 650a 2320 2020  ation alone.#   
-00009880: 5468 6973 2063 6f75 6c64 2061 6374 7561  This could actua
-00009890: 6c6c 7920 696d 7072 6f76 6520 7065 7266  lly improve perf
-000098a0: 6f72 6d61 6e63 6520 6966 2074 6865 206f  ormance if the o
-000098b0: 7065 7261 7469 6f6e 2070 6572 666f 726d  peration perform
-000098c0: 7320 6578 7472 6120 636f 6d70 7574 6174  s extra computat
-000098d0: 696f 6e73 2069 6e20 6974 7320 6772 6164  ions in its grad
-000098e0: 2074 7261 6e73 666f 726d 0a23 2020 2041   transform.#   A
-000098f0: 2077 6f72 6b61 726f 756e 6420 666f 7220   workaround for 
-00009900: 7468 6973 2077 6f75 6c64 2062 6520 666f  this would be fo
-00009910: 7220 7468 6520 6f70 6572 6174 696f 6e20  r the operation 
-00009920: 6974 7365 6c66 2074 6f20 6368 6563 6b20  itself to check 
-00009930: 6966 2069 7473 2069 6e70 7574 2072 6571  if its input req
-00009940: 7569 7265 7320 6772 6164 206f 7220 6e6f  uires grad or no
-00009950: 740a 2320 5472 616e 7366 6f72 6d73 2061  t.# Transforms a
-00009960: 2066 756e 6374 696f 6e20 746f 2063 6f6d   function to com
-00009970: 7075 7465 2074 6865 2022 6772 6164 6965  pute the "gradie
-00009980: 6e74 2220 6f66 2069 7473 2069 6e70 7574  nt" of its input
-00009990: 7320 7265 7175 6972 696e 6720 6772 6164  s requiring grad
-000099a0: 2c20 706f 7373 6962 6c79 0a23 2020 206d  , possibly.#   m
-000099b0: 6f64 6966 6965 6420 6279 2074 6865 2067  odified by the g
-000099c0: 7261 6420 7370 6563 6966 6965 7273 2028  rad specifiers (
-000099d0: 7365 6520 6265 6c6f 7729 2e0a 2320 5468  see below)..# Th
-000099e0: 6520 6f70 7469 6f6e 616c 2067 7261 645f  e optional grad_
-000099f0: 7370 6563 6966 6965 7220 6172 6775 6d65  specifier argume
-00009a00: 6e74 2061 6363 6570 7473 2074 6865 2066  nt accepts the f
-00009a10: 756e 6374 696f 6e27 7320 6f75 7470 7574  unction's output
-00009a20: 2c20 7275 6e73 2069 6e20 6120 6e6f 2d67  , runs in a no-g
-00009a30: 7261 6420 636f 6e74 6578 742c 0a23 2020  rad context,.#  
-00009a40: 2061 6e64 2063 616e 2070 7574 2067 7261   and can put gra
-00009a50: 6473 2028 7573 696e 6720 7072 696d 732e  ds (using prims.
-00009a60: 7075 745f 6772 6164 2829 2920 666f 7220  put_grad()) for 
-00009a70: 7465 6e73 6f72 732e 2042 7920 6465 6661  tensors. By defa
-00009a80: 756c 742c 2066 6f72 2065 7665 7279 2074  ult, for every t
-00009a90: 656e 736f 7220 6f75 7470 7574 2022 6f22  ensor output "o"
-00009aa0: 0a23 2020 2074 6861 7420 7265 7175 6972  .#   that requir
-00009ab0: 6573 2067 7261 642c 2061 2067 7261 6420  es grad, a grad 
-00009ac0: 6f66 206f 6e65 735f 6c69 6b65 286f 2920  of ones_like(o) 
-00009ad0: 6973 2070 7574 2e0a 2320 5468 6520 6f70  is put..# The op
-00009ae0: 7469 6f6e 616c 2067 7261 645f 6f75 745f  tional grad_out_
-00009af0: 7370 6563 6966 6965 7220 6163 6365 7074  specifier accept
-00009b00: 7320 7468 6520 6675 6e63 7469 6f6e 2773  s the function's
-00009b10: 2069 6e70 7574 2061 6e64 2063 616e 2063   input and can c
-00009b20: 616c 6c20 7072 696d 732e 6765 745f 6772  all prims.get_gr
-00009b30: 6164 2829 2074 6f0a 2320 2020 6163 7175  ad() to.#   acqu
-00009b40: 6972 6520 616e 6420 7265 7475 726e 2067  ire and return g
-00009b50: 7261 6469 656e 7473 2061 7320 6465 7369  radients as desi
-00009b60: 7265 642e 2042 7920 6465 6661 756c 742c  red. By default,
-00009b70: 2074 6865 2069 6e70 7574 2069 7320 666c   the input is fl
-00009b80: 6174 7465 6e65 640a 2320 2020 2874 7265  attened.#   (tre
-00009b90: 655f 666c 6174 7465 6e28 6172 6773 2c20  e_flatten(args, 
-00009ba0: 6b77 6172 6773 2929 2061 6e64 2061 2066  kwargs)) and a f
-00009bb0: 6c61 7420 6c69 7374 206f 6620 6772 6164  lat list of grad
-00009bc0: 7320 666f 7220 616c 6c20 7465 6e73 6f72  s for all tensor
-00009bd0: 7320 7265 7175 6972 696e 6720 6772 6164  s requiring grad
-00009be0: 0a23 2020 2061 6e64 204e 6f6e 6520 666f  .#   and None fo
-00009bf0: 7220 6f74 6865 7220 696e 7075 7473 2069  r other inputs i
-00009c00: 7320 7265 7475 726e 6564 2e0a 2320 5468  s returned..# Th
-00009c10: 6520 616c 676f 7269 7468 6d20 666f 7220  e algorithm for 
-00009c20: 6d6f 6469 6679 696e 6720 7468 6520 7072  modifying the pr
-00009c30: 6f67 7261 6d20 6861 7320 7468 6520 666f  ogram has the fo
-00009c40: 6c6c 6f77 696e 6720 7374 6570 733a 0a23  llowing steps:.#
-00009c50: 2020 2031 2920 466c 6174 7465 6e73 2074     1) Flattens t
-00009c60: 6865 206f 7269 6769 6e61 6c20 7472 6163  he original trac
-00009c70: 6520 666f 7220 7468 6520 6772 6164 2074  e for the grad t
-00009c80: 7261 6e73 666f 726d 202d 2d20 656e 7375  ransform -- ensu
-00009c90: 696e 6720 7468 6174 2061 6c6c 2074 6f70  ing that all top
-00009ca0: 2d6c 6576 656c 2073 796d 626f 6c73 2068  -level symbols h
-00009cb0: 6176 650a 2320 2020 2020 2020 6120 6772  ave.#       a gr
-00009cc0: 6164 2066 756e 6374 696f 6e2e 0a64 6566  ad function..def
-00009cd0: 2067 7261 6428 0a20 2020 2063 666e 2c20   grad(.    cfn, 
-00009ce0: 6772 6164 5f73 7065 6369 6669 6572 3a20  grad_specifier: 
-00009cf0: 4361 6c6c 6162 6c65 203d 205f 6772 6164  Callable = _grad
-00009d00: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
-00009d10: 6c74 2c20 6772 6164 5f6f 7574 5f73 7065  lt, grad_out_spe
-00009d20: 6369 6669 6572 3a20 4361 6c6c 6162 6c65  cifier: Callable
-00009d30: 203d 205f 6772 6164 5f6f 7574 5f73 7065   = _grad_out_spe
-00009d40: 6369 6669 6572 5f64 6566 6175 6c74 0a29  cifier_default.)
-00009d50: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
-00009d60: 2020 2320 4372 6561 7465 7320 6120 6375    # Creates a cu
-00009d70: 7374 6f6d 2074 7261 6e73 666f 726d 2063  stom transform c
-00009d80: 616c 6c61 626c 6520 7468 6174 2062 696e  allable that bin
-00009d90: 6473 2074 6865 2061 6464 6974 696f 6e61  ds the additiona
-00009da0: 6c20 6172 6775 6d65 6e74 7320 746f 2074  l arguments to t
-00009db0: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
-00009dc0: 6d0a 2020 2020 406c 616e 6763 7478 284c  m.    @langctx(L
-00009dd0: 616e 6775 6167 6573 2e43 4c41 4e47 290a  anguages.CLANG).
-00009de0: 2020 2020 6465 6620 5f67 7261 645f 7472      def _grad_tr
-00009df0: 616e 7366 6f72 6d28 7472 633a 2054 7261  ansform(trc: Tra
-00009e00: 6365 2c20 2a2c 2065 7865 6375 746f 7273  ce, *, executors
-00009e10: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
-00009e20: 416e 795d 2920 2d3e 2054 7261 6365 3a0a  Any]) -> Trace:.
-00009e30: 2020 2020 2020 2020 7374 6172 745f 7469          start_ti
-00009e40: 6d65 5f6e 7320 3d20 7469 6d65 2e74 696d  me_ns = time.tim
-00009e50: 655f 6e73 2829 0a0a 2020 2020 2020 2020  e_ns()..        
-00009e60: 2320 5354 4550 204f 4e45 202d 2d20 466c  # STEP ONE -- Fl
-00009e70: 6174 7465 6e73 2061 6e64 2064 6365 730a  attens and dces.
-00009e80: 0a20 2020 2020 2020 2023 2052 6574 7572  .        # Retur
-00009e90: 6e73 2054 7275 6520 6966 2074 6865 2062  ns True if the b
-00009ea0: 7379 6d20 6861 7320 6e6f 2067 7261 6420  sym has no grad 
-00009eb0: 6675 6e63 7469 6f6e 2c20 616e 6420 736f  function, and so
-00009ec0: 206d 7573 7420 6265 2066 6c61 7474 656e   must be flatten
-00009ed0: 6564 2066 6f72 2074 6865 2067 7261 6420  ed for the grad 
-00009ee0: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
-00009ef0: 2020 6e65 7665 725f 666c 6174 7465 6e3a    never_flatten:
-00009f00: 2073 6574 5b48 6173 6861 626c 655d 203d   set[Hashable] =
-00009f10: 207b 7072 696d 732e 5072 696d 4944 732e   {prims.PrimIDs.
-00009f20: 5245 5455 524e 2c20 7072 696d 732e 5072  RETURN, prims.Pr
-00009f30: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
-00009f40: 5649 414c 7d0a 0a20 2020 2020 2020 2064  VIAL}..        d
-00009f50: 6566 2073 686f 756c 645f 666c 6174 7465  ef should_flatte
-00009f60: 6e5f 666f 725f 6772 6164 2862 7379 6d3a  n_for_grad(bsym:
-00009f70: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
-00009f80: 2062 6f6f 6c3a 0a20 2020 2020 2020 2020   bool:.         
-00009f90: 2020 2069 6620 6273 796d 2e73 796d 2e69     if bsym.sym.i
-00009fa0: 6420 696e 206e 6576 6572 5f66 6c61 7474  d in never_flatt
-00009fb0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-00009fc0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-00009fd0: 0a0a 2020 2020 2020 2020 2020 2020 6772  ..            gr
-00009fe0: 6164 666e 3a20 4e6f 6e65 207c 2043 616c  adfn: None | Cal
-00009ff0: 6c61 626c 6520 3d20 5f67 6574 5f67 7261  lable = _get_gra
-0000a000: 6466 6e28 6273 796d 2c20 6578 6563 7574  dfn(bsym, execut
-0000a010: 6f72 735f 6c69 7374 3d65 7865 6375 746f  ors_list=executo
-0000a020: 7273 5f6c 6973 7429 0a20 2020 2020 2020  rs_list).       
-0000a030: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
-0000a040: 666e 2069 7320 4e6f 6e65 0a0a 2020 2020  fn is None..    
-0000a050: 2020 2020 2320 544f 444f 2052 4331 3a20      # TODO RC1: 
-0000a060: 6d61 7962 6520 6d6f 7665 2074 6f20 7072  maybe move to pr
-0000a070: 6f64 7563 6520 7468 6573 6520 616c 7761  oduce these alwa
-0000a080: 7973 206f 6e20 6372 6561 7469 6f6e 0a20  ys on creation. 
-0000a090: 2020 2020 2020 2069 6620 7472 632e 6b77         if trc.kw
-0000a0a0: 6172 6773 2069 7320 4e6f 6e65 3a0a 2020  args is None:.  
-0000a0b0: 2020 2020 2020 2020 2020 7472 632e 6b77            trc.kw
-0000a0c0: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
-0000a0d0: 2020 6966 2074 7263 2e66 6e20 6973 204e    if trc.fn is N
-0000a0e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000a0f0: 2074 7263 2e66 6e20 3d20 7472 632e 7079   trc.fn = trc.py
-0000a100: 7468 6f6e 5f63 616c 6c61 626c 6528 290a  thon_callable().
-0000a110: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000a120: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
-0000a130: 6329 0a20 2020 2020 2020 2066 6c61 7474  c).        flatt
-0000a140: 656e 6564 5f62 7379 6d73 3a20 6c69 7374  ened_bsyms: list
-0000a150: 5b42 6f75 6e64 5379 6d62 6f6c 5d20 3d20  [BoundSymbol] = 
-0000a160: 666c 6174 7465 6e5f 666f 725f 7472 616e  flatten_for_tran
-0000a170: 7366 6f72 6d28 7368 6f75 6c64 5f66 6c61  sform(should_fla
-0000a180: 7474 656e 5f66 6f72 5f67 7261 642c 2074  tten_for_grad, t
-0000a190: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000a1a0: 290a 2020 2020 2020 2020 6772 6164 7472  ).        gradtr
-0000a1b0: 632e 626f 756e 645f 7379 6d62 6f6c 7320  c.bound_symbols 
-0000a1c0: 3d20 666c 6174 7465 6e65 645f 6273 796d  = flattened_bsym
-0000a1d0: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
-0000a1e0: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
-0000a1f0: 0a0a 2020 2020 2020 2020 2320 5354 4550  ..        # STEP
-0000a200: 2054 574f 202d 2d20 5265 706c 6163 6573   TWO -- Replaces
-0000a210: 206f 7269 6769 6e61 6c20 6361 6c6c 7320   original calls 
-0000a220: 7769 7468 2067 7261 6420 6361 6c6c 730a  with grad calls.
-0000a230: 0a20 2020 2020 2020 2023 2044 6566 696e  .        # Defin
-0000a240: 6573 2074 6865 2076 6973 6974 6f72 2070  es the visitor p
-0000a250: 6174 7465 726e 2066 6f72 2074 6865 2066  attern for the f
-0000a260: 6972 7374 2070 6173 7320 6f66 2074 6865  irst pass of the
-0000a270: 2067 7261 6420 7472 616e 7366 6f72 6d2c   grad transform,
-0000a280: 0a20 2020 2020 2020 2023 2020 2077 6869  .        #   whi
-0000a290: 6368 2073 7761 7073 2042 6f75 6e64 5379  ch swaps BoundSy
-0000a2a0: 6d62 6f6c 7320 7769 7468 2074 6865 6972  mbols with their
-0000a2b0: 2067 7261 6420 6675 6e63 7469 6f6e 730a   grad functions.
-0000a2c0: 2020 2020 2020 2020 6465 6620 7669 7369          def visi
-0000a2d0: 745f 2862 7379 6d3a 2042 6f75 6e64 5379  t_(bsym: BoundSy
-0000a2e0: 6d62 6f6c 2920 2d3e 2043 616c 6c61 626c  mbol) -> Callabl
-0000a2f0: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-0000a300: 7261 6466 6e3a 204e 6f6e 6520 7c20 4361  radfn: None | Ca
-0000a310: 6c6c 6162 6c65 203d 205f 6765 745f 6772  llable = _get_gr
-0000a320: 6164 666e 2862 7379 6d2c 2065 7865 6375  adfn(bsym, execu
-0000a330: 746f 7273 5f6c 6973 743d 6578 6563 7574  tors_list=execut
-0000a340: 6f72 735f 6c69 7374 290a 2020 2020 2020  ors_list).      
-0000a350: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
-0000a360: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-0000a370: 6466 6e20 6973 206e 6f74 204e 6f6e 652c  dfn is not None,
-0000a380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a390: 206c 616d 6264 613a 2066 2246 6169 6c65   lambda: f"Faile
-0000a3a0: 6420 746f 2066 696e 6420 6120 6772 6164  d to find a grad
-0000a3b0: 666e 2066 6f72 207b 6273 796d 3d7d 2061  fn for {bsym=} a
-0000a3c0: 6674 6572 2066 6c61 7474 656e 696e 6722  fter flattening"
-0000a3d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000a3e0: 2020 6578 6365 7074 696f 6e5f 7479 7065    exception_type
-0000a3f0: 3d41 7373 6572 7469 6f6e 4572 726f 722c  =AssertionError,
-0000a400: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000a410: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000a420: 6e20 6772 6164 666e 0a0a 2020 2020 2020  n gradfn..      
-0000a430: 2020 4077 7261 7073 2874 7263 2e66 6e2e    @wraps(trc.fn.
-0000a440: 6d65 7461 2069 6620 6973 696e 7374 616e  meta if isinstan
-0000a450: 6365 2874 7263 2e66 6e2c 2053 796d 626f  ce(trc.fn, Symbo
-0000a460: 6c29 2065 6c73 6520 7472 632e 666e 290a  l) else trc.fn).
-0000a470: 2020 2020 2020 2020 6465 6620 696e 7465          def inte
-0000a480: 7270 7265 7469 6e67 5f66 6e28 2a61 7267  rpreting_fn(*arg
-0000a490: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0000a4a0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0000a4b0: 203d 2065 7661 6c5f 7472 6163 6528 6772   = eval_trace(gr
-0000a4c0: 6164 7472 632c 202a 6172 6773 2c20 7379  adtrc, *args, sy
-0000a4d0: 6d62 6f6c 5f6d 6170 7065 723d 7669 7369  mbol_mapper=visi
-0000a4e0: 745f 2c20 2a2a 6b77 6172 6773 290a 2020  t_, **kwargs).  
-0000a4f0: 2020 2020 2020 2020 2020 2320 5365 7473            # Sets
-0000a500: 2067 7261 6473 2066 6f72 206f 7574 7075   grads for outpu
-0000a510: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0000a520: 544f 444f 2054 6869 7320 6566 6665 6374  TODO This effect
-0000a530: 6976 656c 7920 7275 6e73 2069 6e20 6120  ively runs in a 
-0000a540: 6e6f 2067 7261 6420 636f 6e74 6578 7420  no grad context 
-0000a550: 2d2d 2073 686f 756c 6420 6974 2072 756e  -- should it run
-0000a560: 2069 6e20 6120 6772 6164 2063 6f6e 7465   in a grad conte
-0000a570: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
-0000a580: 2320 2020 6f72 2073 686f 756c 6420 7468  #   or should th
-0000a590: 6572 6520 6265 2074 6865 206f 7074 696f  ere be the optio
-0000a5a0: 6e20 746f 2072 756e 2069 7420 696e 2061  n to run it in a
-0000a5b0: 2067 7261 6420 636f 6e74 6578 743f 0a20   grad context?. 
-0000a5c0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
-0000a5d0: 7370 6563 6966 6965 7228 7265 7375 6c74  specifier(result
-0000a5e0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0000a5f0: 436f 6e73 7472 7563 7473 2072 6574 7572  Constructs retur
-0000a600: 6e20 7661 6c75 650a 2020 2020 2020 2020  n value.        
-0000a610: 2020 2020 666c 6174 5f67 7261 6473 203d      flat_grads =
-0000a620: 2067 7261 645f 6f75 745f 7370 6563 6966   grad_out_specif
-0000a630: 6965 7228 2861 7267 732c 206b 7761 7267  ier((args, kwarg
-0000a640: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0000a650: 7265 7475 726e 2066 6c61 745f 6772 6164  return flat_grad
-0000a660: 730a 0a20 2020 2020 2020 2023 204e 4f54  s..        # NOT
-0000a670: 4520 4166 7465 7220 7468 6973 2063 616c  E After this cal
-0000a680: 6c20 7468 6520 6772 6164 7472 6320 6973  l the gradtrc is
-0000a690: 2069 6e76 616c 6964 2c20 6265 6361 7573   invalid, becaus
-0000a6a0: 653a 0a20 2020 2020 2020 2023 2020 2031  e:.        #   1
-0000a6b0: 2920 5468 6520 6e6f 6e2d 6578 6563 7574  ) The non-execut
-0000a6c0: 6162 6c65 2070 7574 5f67 7261 6420 6f70  able put_grad op
-0000a6d0: 6572 6174 696f 6e73 2061 7265 2073 7469  erations are sti
-0000a6e0: 6c6c 2069 6e20 7468 6520 7472 6163 652c  ll in the trace,
-0000a6f0: 2061 6e64 206d 756c 7469 706c 6520 6361   and multiple ca
-0000a700: 6c6c 7320 746f 2070 7574 2067 7261 6420  lls to put grad 
-0000a710: 6172 6520 6e6f 7420 6163 6375 6d75 6c61  are not accumula
-0000a720: 7465 640a 2020 2020 2020 2020 2320 2020  ted.        #   
-0000a730: 3229 2054 6865 206e 6f6e 2d65 7865 6375  2) The non-execu
-0000a740: 7461 626c 6520 6765 745f 6772 6164 206f  table get_grad o
-0000a750: 7065 7261 7469 6f6e 7320 6172 6520 7374  perations are st
-0000a760: 696c 6c20 696e 2074 6865 2074 7261 6365  ill in the trace
-0000a770: 2c20 616e 6420 7468 6579 206d 6179 2070  , and they may p
-0000a780: 726f 6475 6365 2064 6966 6665 7265 6e74  roduce different
-0000a790: 2070 726f 7869 6573 2077 6865 6e0a 2020   proxies when.  
-0000a7a0: 2020 2020 2020 2320 2020 2020 2020 6361        #       ca
-0000a7b0: 6c6c 6564 206f 6e20 7468 6520 7361 6d65  lled on the same
-0000a7c0: 2069 6e70 7574 730a 2020 2020 2020 2020   inputs.        
-0000a7d0: 2320 2020 3329 2054 6865 206f 7065 7261  #   3) The opera
-0000a7e0: 7469 6f6e 7320 6172 6520 6e6f 7420 696e  tions are not in
-0000a7f0: 2061 2076 616c 6964 206f 7264 6572 0a20   a valid order. 
-0000a800: 2020 2020 2020 2067 7261 6474 7263 203d         gradtrc =
-0000a810: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0000a820: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
-0000a830: 6e61 6d65 5f70 726f 7869 6573 3d46 616c  name_proxies=Fal
-0000a840: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-0000a850: 7573 655f 6463 653d 4661 6c73 652c 0a20  use_dce=False,. 
-0000a860: 2020 2020 2020 2029 2869 6e74 6572 7072         )(interpr
-0000a870: 6574 696e 675f 666e 2c20 2a67 7261 6474  eting_fn, *gradt
-0000a880: 7263 2e61 7267 732c 202a 2a67 7261 6474  rc.args, **gradt
-0000a890: 7263 2e6b 7761 7267 7329 0a20 2020 2020  rc.kwargs).     
-0000a8a0: 2020 2067 7261 6474 7263 2e73 636f 7065     gradtrc.scope
-0000a8b0: 7320 3d20 5b67 7261 6474 7263 2e62 6f75  s = [gradtrc.bou
-0000a8c0: 6e64 5f73 796d 626f 6c73 5d0a 2020 2020  nd_symbols].    
-0000a8d0: 2020 2020 6772 6164 7472 632e 5f63 6f6d      gradtrc._com
-0000a8e0: 706c 6574 6520 3d20 4661 6c73 650a 0a20  plete = False.. 
-0000a8f0: 2020 2020 2020 2023 2053 5445 5020 5448         # STEP TH
-0000a900: 5245 4520 2d2d 2048 616e 646c 6573 2070  REE -- Handles p
-0000a910: 7574 5f67 7261 6420 616e 6420 6765 745f  ut_grad and get_
-0000a920: 6772 6164 206f 7065 7261 7469 6f6e 7320  grad operations 
-0000a930: 616e 6420 6163 6375 6d75 6c61 7465 7320  and accumulates 
-0000a940: 6772 6164 6965 6e74 730a 0a20 2020 2020  gradients..     
-0000a950: 2020 2023 2041 6363 756d 756c 6174 6573     # Accumulates
-0000a960: 2067 7261 6469 656e 7473 2c20 6372 6561   gradients, crea
-0000a970: 7469 6e67 2074 6865 2070 7269 6d61 6c20  ting the primal 
-0000a980: 2d3e 2061 6363 756d 756c 6174 6564 2067  -> accumulated g
-0000a990: 7261 6420 6d61 7070 696e 670a 2020 2020  rad mapping.    
-0000a9a0: 2020 2020 2320 5365 7473 2074 6865 2074      # Sets the t
-0000a9b0: 7261 6369 6e67 2063 6f6e 7465 7874 2073  racing context s
-0000a9c0: 6f20 6163 6375 6d75 6c61 7469 6f6e 206f  o accumulation o
-0000a9d0: 7065 7261 7469 6f6e 7320 6172 6520 7265  perations are re
-0000a9e0: 636f 7264 6564 2069 6e74 6f20 7468 6520  corded into the 
-0000a9f0: 7472 6163 650a 2020 2020 2020 2020 7472  trace.        tr
-0000aa00: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
-0000aa10: 7261 6365 6374 785f 746f 6b20 3d20 7365  racectx_tok = se
-0000aa20: 745f 7472 6163 6563 7478 2867 7261 6474  t_tracectx(gradt
-0000aa30: 7263 290a 0a20 2020 2020 2020 2020 2020  rc)..           
-0000aa40: 2023 204d 6170 7320 7072 696d 616c 7320   # Maps primals 
-0000aa50: 746f 2074 6865 6972 2067 7261 6469 656e  to their gradien
-0000aa60: 7473 2028 7768 6963 6820 6172 6520 7265  ts (which are re
-0000aa70: 7475 726e 6564 2066 726f 6d20 6361 6c6c  turned from call
-0000aa80: 696e 6720 6765 745f 6772 6164 206f 6e20  ing get_grad on 
-0000aa90: 7468 6520 7072 696d 616c 290a 2020 2020  the primal).    
-0000aaa0: 2020 2020 2020 2020 7072 696d 616c 735f          primals_
-0000aab0: 746f 5f67 696e 7075 745f 6d61 703a 2064  to_ginput_map: d
-0000aac0: 6963 745b 5661 7269 6162 6c65 2c20 5465  ict[Variable, Te
-0000aad0: 6e73 6f72 5072 6f78 795d 203d 207b 7d0a  nsorProxy] = {}.
-0000aae0: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
-0000aaf0: 616e 646c 6573 2070 7574 5f67 7261 6420  andles put_grad 
-0000ab00: 6f70 6572 6174 696f 6e73 0a20 2020 2020  operations.     
-0000ab10: 2020 2020 2020 2023 204e 4f54 4520 5468         # NOTE Th
-0000ab20: 6973 206d 6f64 6966 6965 7320 6120 6c69  is modifies a li
-0000ab30: 7374 2074 6861 7420 6973 2062 6569 6e67  st that is being
-0000ab40: 2065 6e75 6d65 7261 7465 6420 6f76 6572   enumerated over
-0000ab50: 2c20 6275 7420 6974 2773 204f 4b20 6265  , but it's OK be
-0000ab60: 6361 7573 6520 7765 2772 6520 6f6e 6c79  cause we're only
-0000ab70: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000ab80: 2061 7070 656e 6469 6e67 2074 6f20 7468   appending to th
-0000ab90: 6520 656e 6420 6f66 2074 6865 206c 6973  e end of the lis
-0000aba0: 740a 2020 2020 2020 2020 2020 2020 6273  t.            bs
-0000abb0: 796d 3a20 426f 756e 6453 796d 626f 6c0a  ym: BoundSymbol.
-0000abc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000abd0: 6273 796d 2069 6e20 6772 6164 7472 632e  bsym in gradtrc.
-0000abe0: 626f 756e 645f 7379 6d62 6f6c 733a 0a20  bound_symbols:. 
-0000abf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000ac00: 643a 2048 6173 6861 626c 6520 3d20 6273  d: Hashable = bs
-0000ac10: 796d 2e73 796d 2e69 640a 2020 2020 2020  ym.sym.id.      
-0000ac20: 2020 2020 2020 2020 2020 6966 2069 6420            if id 
-0000ac30: 6973 2070 6964 732e 5055 545f 4752 4144  is pids.PUT_GRAD
-0000ac40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ac50: 2020 2020 2020 7072 696d 616c 3a20 4e75        primal: Nu
-0000ac60: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-0000ac70: 7879 0a20 2020 2020 2020 2020 2020 2020  xy.             
-0000ac80: 2020 2020 2020 2067 7261 643a 204e 756d         grad: Num
-0000ac90: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-0000aca0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0000acb0: 2020 2020 2020 7072 696d 616c 2c20 6772        primal, gr
-0000acc0: 6164 203d 2062 7379 6d2e 666c 6174 5f61  ad = bsym.flat_a
-0000acd0: 7267 730a 0a20 2020 2020 2020 2020 2020  rgs..           
-0000ace0: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
-0000acf0: 5375 7070 6f72 7420 6175 746f 6772 6164  Support autograd
-0000ad00: 206f 6e20 6e75 6d62 6572 730a 2020 2020   on numbers.    
-0000ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad20: 2320 4669 6c74 6572 7320 6361 6c6c 7320  # Filters calls 
-0000ad30: 746f 2070 7574 5f67 7261 6420 7468 6174  to put_grad that
-0000ad40: 2077 6f75 6c64 2070 7574 2061 2067 7261   would put a gra
-0000ad50: 6420 6f6e 2061 206e 6f6e 2d74 656e 736f  d on a non-tenso
-0000ad60: 7220 6f72 2061 2074 656e 736f 7220 7468  r or a tensor th
-0000ad70: 6174 2064 6f65 736e 2774 2072 6571 7569  at doesn't requi
-0000ad80: 7265 2067 7261 640a 2020 2020 2020 2020  re grad.        
-0000ad90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000ada0: 6f74 2069 7369 6e73 7461 6e63 6528 7072  ot isinstance(pr
-0000adb0: 696d 616c 2c20 5465 6e73 6f72 5072 6f78  imal, TensorProx
-0000adc0: 7929 206f 7220 6e6f 7420 7072 696d 616c  y) or not primal
-0000add0: 2e72 6571 7569 7265 735f 6772 6164 3a0a  .requires_grad:.
-0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adf0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0000ae00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000ae10: 2020 2020 2020 2320 544f 444f 2053 7570        # TODO Sup
-0000ae20: 706f 7274 2063 6f6d 706c 6578 2061 7574  port complex aut
-0000ae30: 6f67 7261 640a 2020 2020 2020 2020 2020  ograd.          
-0000ae40: 2020 2020 2020 2020 2020 6368 6563 6b28            check(
-0000ae50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ae60: 2020 2020 2020 2020 206e 6f74 2064 7479           not dty
-0000ae70: 7065 732e 6973 5f63 6f6d 706c 6578 5f64  pes.is_complex_d
-0000ae80: 7479 7065 2864 7479 7065 732e 746f 5f64  type(dtypes.to_d
-0000ae90: 7479 7065 2870 7269 6d61 6c29 292c 0a20  type(primal)),. 
-0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aeb0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0000aec0: 2243 6f6d 706c 6578 2067 7261 6420 6973  "Complex grad is
-0000aed0: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
-0000aee0: 6574 222c 0a20 2020 2020 2020 2020 2020  et",.           
-0000aef0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af10: 7670 7269 6d61 6c3a 2056 6172 6961 626c  vprimal: Variabl
-0000af20: 6520 3d20 7661 7269 6162 6c65 6966 7928  e = variableify(
-0000af30: 7072 696d 616c 290a 2020 2020 2020 2020  primal).        
-0000af40: 2020 2020 2020 2020 2020 2020 6163 6375              accu
-0000af50: 6d3a 204e 6f6e 6520 7c20 5465 6e73 6f72  m: None | Tensor
-0000af60: 5072 6f78 7920 3d20 7072 696d 616c 735f  Proxy = primals_
-0000af70: 746f 5f67 696e 7075 745f 6d61 702e 6765  to_ginput_map.ge
-0000af80: 7428 7670 7269 6d61 6c2c 204e 6f6e 6529  t(vprimal, None)
-0000af90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000afa0: 2020 2020 2020 6966 2061 6363 756d 2069        if accum i
-0000afb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afd0: 7072 696d 616c 735f 746f 5f67 696e 7075  primals_to_ginpu
-0000afe0: 745f 6d61 705b 7670 7269 6d61 6c5d 203d  t_map[vprimal] =
-0000aff0: 2067 7261 640a 2020 2020 2020 2020 2020   grad.          
-0000b000: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b020: 2020 2020 2020 2020 6163 6375 6d20 3d20          accum = 
-0000b030: 6163 6375 6d20 2b20 6772 6164 0a20 2020  accum + grad.   
-0000b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b050: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
-0000b060: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
-0000b070: 616c 5d20 3d20 6163 6375 6d0a 0a20 2020  al] = accum..   
-0000b080: 2020 2020 2020 2020 2023 2048 616e 646c           # Handl
-0000b090: 6573 2067 6574 5f67 7261 6420 6f70 6572  es get_grad oper
-0000b0a0: 6174 696f 6e73 0a0a 2020 2020 2020 2020  ations..        
-0000b0b0: 2020 2020 2320 5265 7365 7473 2074 6865      # Resets the
-0000b0c0: 2073 7761 706d 6170 2066 6f72 2067 7261   swapmap for gra
-0000b0d0: 6473 0a20 2020 2020 2020 2020 2020 2073  ds.            s
-0000b0e0: 7761 706d 6170 3a20 6469 6374 5b56 6172  wapmap: dict[Var
-0000b0f0: 6961 626c 652c 2050 726f 7879 5d20 3d20  iable, Proxy] = 
-0000b100: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
-0000b110: 666f 7220 6273 796d 2069 6e20 6772 6164  for bsym in grad
-0000b120: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
-0000b130: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000b140: 2020 2069 643a 2048 6173 6861 626c 6520     id: Hashable 
-0000b150: 3d20 6273 796d 2e73 796d 2e69 640a 2020  = bsym.sym.id.  
-0000b160: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000b170: 2069 6420 6973 2070 6964 732e 4745 545f   id is pids.GET_
-0000b180: 4752 4144 3a0a 2020 2020 2020 2020 2020  GRAD:.          
-0000b190: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0000b1a0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-0000b1b0: 7250 726f 7879 0a20 2020 2020 2020 2020  rProxy.         
-0000b1c0: 2020 2020 2020 2020 2020 2028 7072 696d             (prim
-0000b1d0: 616c 2c29 203d 2062 7379 6d2e 666c 6174  al,) = bsym.flat
-0000b1e0: 5f61 7267 730a 2020 2020 2020 2020 2020  _args.          
-0000b1f0: 2020 2020 2020 2020 2020 6772 6164 3a20            grad: 
-0000b200: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-0000b210: 726f 7879 203d 2062 7379 6d2e 6f75 7470  roxy = bsym.outp
-0000b220: 7574 0a0a 2020 2020 2020 2020 2020 2020  ut..            
-0000b230: 2020 2020 2020 2020 7670 7269 6d61 6c3a          vprimal:
-0000b240: 2056 6172 6961 626c 650a 2020 2020 2020   Variable.      
-0000b250: 2020 2020 2020 2020 2020 2020 2020 7667                vg
-0000b260: 7261 643a 2056 6172 6961 626c 650a 2020  rad: Variable.  
-0000b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b280: 2020 7670 7269 6d61 6c2c 2076 6772 6164    vprimal, vgrad
-0000b290: 203d 2076 6172 6961 626c 6569 6679 2870   = variableify(p
-0000b2a0: 7269 6d61 6c29 2c20 7661 7269 6162 6c65  rimal), variable
-0000b2b0: 6966 7928 6772 6164 290a 0a20 2020 2020  ify(grad)..     
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000b2d0: 6374 7561 6c5f 6772 6164 3a20 4e6f 6e65  ctual_grad: None
-0000b2e0: 207c 2054 656e 736f 7250 726f 7879 203d   | TensorProxy =
-0000b2f0: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
-0000b300: 7574 5f6d 6170 2e67 6574 2876 7072 696d  ut_map.get(vprim
-0000b310: 616c 2c20 4e6f 6e65 290a 0a20 2020 2020  al, None)..     
-0000b320: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b330: 204e 4f54 4520 4966 2061 6374 7561 6c5f   NOTE If actual_
-0000b340: 6772 6164 2069 7320 4e6f 6e65 2074 6865  grad is None the
-0000b350: 6e20 7468 6572 6527 7320 6120 6765 745f  n there's a get_
-0000b360: 6772 6164 2829 2072 6571 7565 7374 2066  grad() request f
-0000b370: 6f72 2061 2074 656e 736f 7220 7768 6963  or a tensor whic
-0000b380: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-0000b390: 2020 2020 2020 2320 2020 6861 7320 6e6f        #   has no
-0000b3a0: 2070 7574 5f67 7261 6428 292c 2073 6f20   put_grad(), so 
-0000b3b0: 7765 2072 6574 7572 6e20 7a65 726f 7320  we return zeros 
-0000b3c0: 666f 7220 7468 6520 6772 6164 0a20 2020  for the grad.   
-0000b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3e0: 2023 2054 4f44 4f20 5265 7669 7369 7420   # TODO Revisit 
-0000b3f0: 7468 6973 202d 2d20 6361 6e20 7765 2072  this -- can we r
-0000b400: 656d 6f76 6520 7468 6573 6520 636f 6d70  emove these comp
-0000b410: 7574 6174 696f 6e73 2c20 6f72 2075 7365  utations, or use
-0000b420: 2061 2073 7065 6369 616c 205a 6572 6f54   a special ZeroT
-0000b430: 656e 736f 720a 2020 2020 2020 2020 2020  ensor.          
-0000b440: 2020 2020 2020 2020 2020 2320 2020 746f            #   to
-0000b450: 2073 696d 706c 6966 7920 7468 656d 3f0a   simplify them?.
-0000b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b470: 2020 2020 6966 2061 6374 7561 6c5f 6772      if actual_gr
-0000b480: 6164 2069 7320 4e6f 6e65 3a0a 2020 2020  ad is None:.    
-0000b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4a0: 2020 2020 6163 7475 616c 5f67 7261 6420      actual_grad 
-0000b4b0: 3d20 6c74 6f72 6368 2e7a 6572 6f73 5f6c  = ltorch.zeros_l
-0000b4c0: 696b 6528 7072 696d 616c 290a 2020 2020  ike(primal).    
+000086b0: 2061 2e73 6861 7065 290a 2020 2020 2320   a.shape).    # 
+000086c0: 496e 7365 7274 696e 6720 6120 636f 6e76  Inserting a conv
+000086d0: 6572 7369 6f6e 2074 6f20 7468 6520 7361  ersion to the sa
+000086e0: 6d65 2064 7479 7065 2074 6f20 6469 7361  me dtype to disa
+000086f0: 626c 6520 6e76 4675 7365 7220 6578 6563  ble nvFuser exec
+00008700: 7574 6f72 7327 730a 2020 2020 2320 626f  utors's.    # bo
+00008710: 6f6b 656e 6420 6f70 7469 6d69 7a61 7469  okend optimizati
+00008720: 6f6e 2028 6e76 5f65 6e61 626c 655f 626f  on (nv_enable_bo
+00008730: 6f6b 656e 6429 2c20 7768 6963 6820 6361  okend), which ca
+00008740: 6e20 6361 7573 6520 7468 6520 6261 636b  n cause the back
+00008750: 7761 7264 0a20 2020 2023 2070 6173 7320  ward.    # pass 
+00008760: 746f 2067 656e 6572 6174 6520 7477 6f20  to generate two 
+00008770: 6b65 726e 656c 730a 2020 2020 6d65 616e  kernels.    mean
+00008780: 5f6d 6474 7970 6520 3d20 7072 696d 732e  _mdtype = prims.
+00008790: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
+000087a0: 7479 7065 286d 2c20 6d2e 6474 7970 6529  type(m, m.dtype)
+000087b0: 0a20 2020 2072 6573 746f 7265 645f 6d65  .    restored_me
+000087c0: 616e 203d 2072 6573 746f 7265 5f72 6564  an = restore_red
+000087d0: 7563 6564 5f64 696d 7328 6d65 616e 5f6d  uced_dims(mean_m
+000087e0: 6474 7970 652c 2064 696d 732c 2061 2e73  dtype, dims, a.s
+000087f0: 6861 7065 290a 2020 2020 7661 725f 6772  hape).    var_gr
+00008800: 6164 203d 2028 3220 2a20 7265 7374 6f72  ad = (2 * restor
+00008810: 6564 5f67 7620 2a20 2861 202d 2072 6573  ed_gv * (a - res
+00008820: 746f 7265 645f 6d65 616e 2929 202f 206e  tored_mean)) / n
+00008830: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
+00008840: 6c61 720a 0a20 2020 2070 7574 5f67 7261  lar..    put_gra
+00008850: 6428 612c 206d 6561 6e5f 6772 6164 202b  d(a, mean_grad +
+00008860: 2076 6172 5f67 7261 6429 0a0a 2020 2020   var_grad)..    
+00008870: 7265 7475 726e 2076 2c20 6d0a 0a0a 7265  return v, m...re
+00008880: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00008890: 2e56 4152 5f4d 4541 4e2c 205f 7661 725f  .VAR_MEAN, _var_
+000088a0: 6d65 616e 5f70 7269 6d5f 6772 6164 290a  mean_prim_grad).
+000088b0: 0a0a 230a 2320 4c69 6e65 6172 2061 6c67  ..#.# Linear alg
+000088c0: 6562 7261 206f 7065 7261 746f 7220 6772  ebra operator gr
+000088d0: 6164 730a 230a 4074 6f72 6368 6374 780a  ads.#.@torchctx.
+000088e0: 6465 6620 5f6c 696e 6561 725f 7072 696d  def _linear_prim
+000088f0: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+00008900: 726f 7879 2c20 773a 2054 656e 736f 7250  roxy, w: TensorP
+00008910: 726f 7879 2c20 6269 6173 3a20 4e6f 6e65  roxy, bias: None
+00008920: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
+00008930: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
+00008940: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
+00008950: 6c69 6e65 6172 2861 2c20 772c 2062 6961  linear(a, w, bia
+00008960: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
+00008970: 6772 6164 2866 7764 290a 0a20 2020 2066  grad(fwd)..    f
+00008980: 6972 7374 5f64 696d 203d 202d 320a 2020  irst_dim = -2.  
+00008990: 2020 6772 6164 5f61 203d 206c 746f 7263    grad_a = ltorc
+000089a0: 682e 6d61 746d 756c 2867 2e72 6573 6861  h.matmul(g.resha
+000089b0: 7065 282d 312c 2067 2e73 6861 7065 5b2d  pe(-1, g.shape[-
+000089c0: 315d 292c 2077 292e 7265 7368 6170 6528  1]), w).reshape(
+000089d0: 612e 7368 6170 6529 0a0a 2020 2020 6772  a.shape)..    gr
+000089e0: 6164 5f77 3a20 5465 6e73 6f72 5072 6f78  ad_w: TensorProx
+000089f0: 790a 2020 2020 6966 2061 2e6e 6469 6d20  y.    if a.ndim 
+00008a00: 3d3d 2031 3a0a 2020 2020 2020 2020 6772  == 1:.        gr
+00008a10: 6164 5f77 203d 206c 746f 7263 682e 6d61  ad_w = ltorch.ma
+00008a20: 746d 756c 2867 2e75 6e73 7175 6565 7a65  tmul(g.unsqueeze
+00008a30: 2866 6972 7374 5f64 696d 292e 6d54 2c20  (first_dim).mT, 
+00008a40: 612e 756e 7371 7565 657a 6528 6669 7273  a.unsqueeze(firs
+00008a50: 745f 6469 6d29 290a 2020 2020 656c 7365  t_dim)).    else
+00008a60: 3a0a 2020 2020 2020 2020 6772 6164 5f77  :.        grad_w
+00008a70: 203d 206c 746f 7263 682e 6d61 746d 756c   = ltorch.matmul
+00008a80: 2867 2e72 6573 6861 7065 282d 312c 2067  (g.reshape(-1, g
+00008a90: 2e73 6861 7065 5b2d 315d 292e 6d54 2c20  .shape[-1]).mT, 
+00008aa0: 612e 7265 7368 6170 6528 2d31 2c20 612e  a.reshape(-1, a.
+00008ab0: 7368 6170 655b 2d31 5d29 290a 0a20 2020  shape[-1]))..   
+00008ac0: 2070 7574 5f67 7261 6473 2828 612c 2077   put_grads((a, w
+00008ad0: 292c 2028 6772 6164 5f61 2c20 6772 6164  ), (grad_a, grad
+00008ae0: 5f77 2929 0a0a 2020 2020 6966 2062 6961  _w))..    if bia
+00008af0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00008b00: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
+00008b10: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00008b20: 2020 6772 6164 5f62 6961 7320 3d20 6c74    grad_bias = lt
+00008b30: 6f72 6368 2e73 756d 2867 2c20 7475 706c  orch.sum(g, tupl
+00008b40: 6528 7261 6e67 6528 672e 6e64 696d 202d  e(range(g.ndim -
+00008b50: 2031 2929 290a 2020 2020 2020 2020 656c   1))).        el
+00008b60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00008b70: 6772 6164 5f62 6961 7320 3d20 670a 2020  grad_bias = g.  
+00008b80: 2020 2020 2020 7075 745f 6772 6164 2862        put_grad(b
+00008b90: 6961 732c 2067 7261 645f 6269 6173 290a  ias, grad_bias).
+00008ba0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00008bb0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+00008bc0: 7069 6473 2e4c 494e 4541 522c 205f 6c69  pids.LINEAR, _li
+00008bd0: 6e65 6172 5f70 7269 6d5f 6772 6164 290a  near_prim_grad).
+00008be0: 0a0a 2320 544f 444f 2041 6464 2065 7870  ..# TODO Add exp
+00008bf0: 6c69 6369 7420 6c74 6f72 6368 2076 7320  licit ltorch vs 
+00008c00: 636c 616e 6720 6d6f 6475 6c65 2074 6f20  clang module to 
+00008c10: 7468 6520 7465 6e73 6f72 206f 7065 7261  the tensor opera
+00008c20: 7469 6f6e 7320 6265 6c6f 770a 2320 544f  tions below.# TO
+00008c30: 444f 2063 6f75 6c64 2077 6520 6765 7420  DO could we get 
+00008c40: 7269 6420 6f66 2074 6865 2066 696e 616c  rid of the final
+00008c50: 2073 7175 6565 7a65 7320 696e 2074 6865   squeezes in the
+00008c60: 2062 2e6e 6469 6d20 3d3d 2031 2063 6173   b.ndim == 1 cas
+00008c70: 6520 616e 6420 7468 6520 612e 6e64 696d  e and the a.ndim
+00008c80: 203d 3d20 3120 6361 7365 3f0a 4074 6f72   == 1 case?.@tor
+00008c90: 6368 6374 780a 6465 6620 5f6d 6174 6d75  chctx.def _matmu
+00008ca0: 6c5f 7072 696d 5f67 7261 6428 613a 2054  l_prim_grad(a: T
+00008cb0: 656e 736f 7250 726f 7879 2c20 623a 2054  ensorProxy, b: T
+00008cc0: 656e 736f 7250 726f 7879 2c20 2f29 202d  ensorProxy, /) -
+00008cd0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00008ce0: 2020 2066 7764 203d 2070 7269 6d73 2e6d     fwd = prims.m
+00008cf0: 6174 6d75 6c28 612c 2062 290a 2020 2020  atmul(a, b).    
+00008d00: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+00008d10: 290a 0a20 2020 206c 6173 745f 6469 6d20  )..    last_dim 
+00008d20: 3d20 282d 312c 290a 2020 2020 6669 7273  = (-1,).    firs
+00008d30: 745f 6469 6d20 3d20 282d 322c 290a 2020  t_dim = (-2,).  
+00008d40: 2020 6966 2061 2e6e 6469 6d20 3d3d 2031    if a.ndim == 1
+00008d50: 2061 6e64 2062 2e6e 6469 6d20 3d3d 2031   and b.ndim == 1
+00008d60: 3a0a 2020 2020 2020 2020 7075 745f 6772  :.        put_gr
+00008d70: 6164 7328 2861 2c20 6229 2c20 2867 202a  ads((a, b), (g *
+00008d80: 2062 2c20 6720 2a20 6129 290a 2020 2020   b, g * a)).    
+00008d90: 656c 6966 2062 2e6e 6469 6d20 3d3d 2031  elif b.ndim == 1
+00008da0: 3a0a 2020 2020 2020 2020 6761 203d 2075  :.        ga = u
+00008db0: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
+00008dc0: 5f64 696d 2920 4020 756e 7371 7565 657a  _dim) @ unsqueez
+00008dd0: 6528 622c 206c 6173 745f 6469 6d29 2e6d  e(b, last_dim).m
+00008de0: 540a 2020 2020 2020 2020 6762 203d 2061  T.        gb = a
+00008df0: 2e6d 5420 4020 756e 7371 7565 657a 6528  .mT @ unsqueeze(
+00008e00: 672c 206c 6173 745f 6469 6d29 0a20 2020  g, last_dim).   
+00008e10: 2020 2020 2069 6620 672e 6e64 696d 203e       if g.ndim >
+00008e20: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00008e30: 6762 203d 2073 7175 6565 7a65 2867 622c  gb = squeeze(gb,
+00008e40: 206c 6173 745f 6469 6d29 0a20 2020 2020   last_dim).     
+00008e50: 2020 2020 2020 2067 6220 3d20 6c74 6f72         gb = ltor
+00008e60: 6368 2e73 756d 2867 622c 2074 7570 6c65  ch.sum(gb, tuple
+00008e70: 2872 616e 6765 2867 622e 6e64 696d 202d  (range(gb.ndim -
+00008e80: 2031 2929 290a 2020 2020 2020 2020 7075   1))).        pu
+00008e90: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
+00008ea0: 2867 612c 2067 622e 7371 7565 657a 6528  (ga, gb.squeeze(
+00008eb0: 2929 290a 2020 2020 656c 6966 2061 2e6e  ))).    elif a.n
+00008ec0: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
+00008ed0: 2020 6761 203d 2075 6e73 7175 6565 7a65    ga = unsqueeze
+00008ee0: 2867 2c20 6669 7273 745f 6469 6d29 2040  (g, first_dim) @
+00008ef0: 2062 2e6d 540a 2020 2020 2020 2020 6966   b.mT.        if
+00008f00: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
+00008f10: 2020 2020 2020 2020 2067 6120 3d20 6c74           ga = lt
+00008f20: 6f72 6368 2e73 756d 2867 612c 2074 7570  orch.sum(ga, tup
+00008f30: 6c65 2872 616e 6765 2867 612e 6e64 696d  le(range(ga.ndim
+00008f40: 202d 2031 2929 290a 2020 2020 2020 2020   - 1))).        
+00008f50: 6762 203d 2075 6e73 7175 6565 7a65 2861  gb = unsqueeze(a
+00008f60: 2c20 6669 7273 745f 6469 6d29 2e6d 5420  , first_dim).mT 
+00008f70: 4020 756e 7371 7565 657a 6528 672c 2066  @ unsqueeze(g, f
+00008f80: 6972 7374 5f64 696d 290a 2020 2020 2020  irst_dim).      
+00008f90: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
+00008fa0: 6229 2c20 2867 612e 7371 7565 657a 6528  b), (ga.squeeze(
+00008fb0: 292c 2067 6229 290a 2020 2020 656c 7365  ), gb)).    else
+00008fc0: 3a0a 2020 2020 2020 2020 7075 745f 6772  :.        put_gr
+00008fd0: 6164 7328 2861 2c20 6229 2c20 2867 2040  ads((a, b), (g @
+00008fe0: 2062 2e6d 542c 2061 2e6d 5420 4020 6729   b.mT, a.mT @ g)
+00008ff0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00009000: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00009010: 6428 7069 6473 2e4d 4154 4d55 4c2c 205f  d(pids.MATMUL, _
+00009020: 6d61 746d 756c 5f70 7269 6d5f 6772 6164  matmul_prim_grad
+00009030: 290a 0a23 0a23 204e 4e20 6f70 6572 6174  )..#.# NN operat
+00009040: 6f72 2067 7261 6473 0a23 0a0a 0a40 746f  or grads.#...@to
+00009050: 7263 6863 7478 0a64 6566 205f 656d 6265  rchctx.def _embe
+00009060: 6464 696e 675f 7072 696d 5f67 7261 6428  dding_prim_grad(
+00009070: 0a20 2020 2061 3a20 5465 6e73 6f72 5072  .    a: TensorPr
+00009080: 6f78 792c 202f 2c20 7765 6967 6874 2c20  oxy, /, weight, 
+00009090: 2a2c 2070 6164 6469 6e67 5f69 6478 3d2d  *, padding_idx=-
+000090a0: 312c 206d 6178 5f6e 6f72 6d3d 4e6f 6e65  1, max_norm=None
+000090b0: 2c20 6e6f 726d 5f74 7970 653d 322e 302c  , norm_type=2.0,
+000090c0: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
+000090d0: 7265 713d 4661 6c73 652c 2073 7061 7273  req=False, spars
+000090e0: 653d 4661 6c73 650a 2920 2d3e 2054 656e  e=False.) -> Ten
+000090f0: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00009100: 6420 3d20 7072 696d 732e 656d 6265 6464  d = prims.embedd
+00009110: 696e 6728 0a20 2020 2020 2020 2061 2c0a  ing(.        a,.
+00009120: 2020 2020 2020 2020 7765 6967 6874 2c0a          weight,.
+00009130: 2020 2020 2020 2020 7061 6464 696e 675f          padding_
+00009140: 6964 783d 7061 6464 696e 675f 6964 782c  idx=padding_idx,
+00009150: 0a20 2020 2020 2020 206d 6178 5f6e 6f72  .        max_nor
+00009160: 6d3d 6d61 785f 6e6f 726d 2c0a 2020 2020  m=max_norm,.    
+00009170: 2020 2020 6e6f 726d 5f74 7970 653d 6e6f      norm_type=no
+00009180: 726d 5f74 7970 652c 0a20 2020 2020 2020  rm_type,.       
+00009190: 2073 6361 6c65 5f67 7261 645f 6279 5f66   scale_grad_by_f
+000091a0: 7265 713d 7363 616c 655f 6772 6164 5f62  req=scale_grad_b
+000091b0: 795f 6672 6571 2c0a 2020 2020 2020 2020  y_freq,.        
+000091c0: 7370 6172 7365 3d73 7061 7273 652c 0a20  sparse=sparse,. 
+000091d0: 2020 2029 0a0a 2020 2020 6720 3d20 6765     )..    g = ge
+000091e0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+000091f0: 615f 6772 6164 203d 2070 7269 6d73 2e65  a_grad = prims.e
+00009200: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
+00009210: 6428 672c 2061 2c20 7765 6967 6874 2e73  d(g, a, weight.s
+00009220: 6861 7065 5b30 5d2c 2070 6164 6469 6e67  hape[0], padding
+00009230: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
+00009240: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
+00009250: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00009260: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00009270: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00009280: 7374 6572 5f67 7261 6428 7069 6473 2e45  ster_grad(pids.E
+00009290: 4d42 4544 4449 4e47 2c20 5f65 6d62 6564  MBEDDING, _embed
+000092a0: 6469 6e67 5f70 7269 6d5f 6772 6164 290a  ding_prim_grad).
+000092b0: 0a23 0a23 2050 6861 6e74 6f6d 2067 7261  .#.# Phantom gra
+000092c0: 6420 7472 616e 7366 6f72 6d20 6865 6c70  d transform help
+000092d0: 6572 730a 230a 0a0a 6465 6620 5f67 6574  ers.#...def _get
+000092e0: 5f67 7261 6466 6e28 6273 796d 3a20 426f  _gradfn(bsym: Bo
+000092f0: 756e 6453 796d 626f 6c2c 202a 2c20 6578  undSymbol, *, ex
+00009300: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
+00009310: 7175 656e 6365 5b41 6e79 5d20 3d20 7475  quence[Any] = tu
+00009320: 706c 6528 2929 202d 3e20 4e6f 6e65 207c  ple()) -> None |
+00009330: 2043 616c 6c61 626c 653a 0a20 2020 2063   Callable:.    c
+00009340: 6420 3d20 6765 745f 636f 6d70 696c 655f  d = get_compile_
+00009350: 6461 7461 2829 0a20 2020 2065 7865 6375  data().    execu
+00009360: 746f 7273 5f6c 6973 7420 3d20 6364 2e65  tors_list = cd.e
+00009370: 7865 6375 746f 7273 5f6c 6973 7420 6966  xecutors_list if
+00009380: 2063 6420 6973 206e 6f74 204e 6f6e 6520   cd is not None 
+00009390: 656c 7365 2065 7865 6375 746f 7273 5f6c  else executors_l
+000093a0: 6973 740a 2020 2020 2320 4368 6563 6b73  ist.    # Checks
+000093b0: 2069 6620 7468 6520 6578 6563 7574 6f72   if the executor
+000093c0: 2077 6869 6368 2068 6173 2070 7269 6f72   which has prior
+000093d0: 6974 7920 666f 7220 7468 6973 206f 7065  ity for this ope
+000093e0: 7261 7469 6f6e 2068 6173 2061 2073 7065  ration has a spe
+000093f0: 6369 6669 6320 6772 6164 2074 7261 6e73  cific grad trans
+00009400: 666f 726d 2066 6f72 2069 740a 2020 2020  form for it.    
+00009410: 666f 7220 6578 2069 6e20 6578 6563 7574  for ex in execut
+00009420: 6f72 735f 6c69 7374 3a0a 2020 2020 2020  ors_list:.      
+00009430: 2020 6966 2065 782e 6361 6e5f 6578 6563    if ex.can_exec
+00009440: 7574 655f 6f72 5f66 7573 6528 6273 796d  ute_or_fuse(bsym
+00009450: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
+00009460: 785f 6772 6164 5f74 7261 6e73 666f 726d  x_grad_transform
+00009470: 3a20 4e6f 6e65 207c 2043 616c 6c61 626c  : None | Callabl
+00009480: 6520 3d20 6578 2e67 6574 5f67 7261 645f  e = ex.get_grad_
+00009490: 7472 616e 7366 6f72 6d28 6273 796d 2e73  transform(bsym.s
+000094a0: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
+000094b0: 6966 2065 785f 6772 6164 5f74 7261 6e73  if ex_grad_trans
+000094c0: 666f 726d 2069 7320 6e6f 7420 4e6f 6e65  form is not None
+000094d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000094e0: 2020 7265 7475 726e 2065 785f 6772 6164    return ex_grad
+000094f0: 5f74 7261 6e73 666f 726d 0a20 2020 2020  _transform.     
+00009500: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00009510: 2020 2320 4966 2074 6865 2065 7865 6375    # If the execu
+00009520: 746f 7220 646f 6573 6e27 7420 6465 6669  tor doesn't defi
+00009530: 6e65 2069 7473 206f 776e 2067 7261 6420  ne its own grad 
+00009540: 7472 616e 7366 6f72 6d2c 2074 6869 7320  transform, this 
+00009550: 6a75 7374 2072 6574 7572 6e73 2074 6865  just returns the
+00009560: 2064 6566 6175 6c74 2067 7261 6420 7472   default grad tr
+00009570: 616e 7366 6f72 6d20 666f 7220 7468 6520  ansform for the 
+00009580: 6273 796d 0a20 2020 2067 7261 6466 6e20  bsym.    gradfn 
+00009590: 3d20 5f67 7261 645f 666e 5f6d 6170 2e67  = _grad_fn_map.g
+000095a0: 6574 2862 7379 6d2e 7379 6d2e 6964 2c20  et(bsym.sym.id, 
+000095b0: 4e6f 6e65 290a 2020 2020 7265 7475 726e  None).    return
+000095c0: 2067 7261 6466 6e0a 0a0a 2320 5468 6520   gradfn...# The 
+000095d0: 6465 6661 756c 7420 6772 6164 2073 7065  default grad spe
+000095e0: 6369 6669 6572 2066 6f72 2074 6865 2067  cifier for the g
+000095f0: 7261 6420 7472 616e 7366 6f72 6d0a 2320  rad transform.# 
+00009600: 2020 466f 7220 6561 6368 2074 656e 736f    For each tenso
+00009610: 7220 6f75 7470 7574 2022 6f22 2072 6571  r output "o" req
+00009620: 7569 7269 6e67 2067 7261 642c 2073 7065  uiring grad, spe
+00009630: 6369 6669 6573 2061 2067 7261 6420 6f66  cifies a grad of
+00009640: 206f 6e65 735f 6c69 6b65 286f 290a 6465   ones_like(o).de
+00009650: 6620 5f67 7261 645f 7370 6563 6966 6965  f _grad_specifie
+00009660: 725f 6465 6661 756c 7428 7079 7472 6565  r_default(pytree
+00009670: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
+00009680: 2020 2020 666c 6174 732c 205f 203d 2074      flats, _ = t
+00009690: 7265 655f 666c 6174 7465 6e28 7079 7472  ree_flatten(pytr
+000096a0: 6565 290a 0a20 2020 2066 6f72 2066 2069  ee)..    for f i
+000096b0: 6e20 666c 6174 733a 0a20 2020 2020 2020  n flats:.       
+000096c0: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
+000096d0: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
+000096e0: 6e64 2066 2e72 6571 7569 7265 735f 6772  nd f.requires_gr
+000096f0: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
+00009700: 2320 4e4f 5445 2054 6869 7320 7573 6573  # NOTE This uses
+00009710: 2063 6c61 6e67 2e6f 6e65 735f 6c69 6b65   clang.ones_like
+00009720: 2066 6f72 206e 6f77 2062 6563 6175 7365   for now because
+00009730: 206c 746f 7263 682e 6f6e 6573 5f6c 696b   ltorch.ones_lik
+00009740: 6520 7769 6c6c 2065 7874 656e 6420 7468  e will extend th
+00009750: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00009760: 2020 6c69 6665 7469 6d65 206f 6620 662c    lifetime of f,
+00009770: 2077 6869 6c65 2063 6c61 6e67 2e6f 6e65   while clang.one
+00009780: 735f 6c69 6b65 2077 696c 6c20 6578 7472  s_like will extr
+00009790: 6163 7420 7468 6520 6d65 7461 6461 7461  act the metadata
+000097a0: 206f 6620 6620 6174 2074 7261 6365 2074   of f at trace t
+000097b0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
+000097c0: 7072 696d 732e 7075 745f 6772 6164 2866  prims.put_grad(f
+000097d0: 2c20 636c 616e 672e 6675 6c6c 5f6c 696b  , clang.full_lik
+000097e0: 6528 662c 2031 2e30 2929 0a0a 0a23 2054  e(f, 1.0))...# T
+000097f0: 4f44 4f20 5465 7374 2077 6974 6820 6275  ODO Test with bu
+00009800: 6666 6572 730a 6465 6620 5f67 7261 645f  ffers.def _grad_
+00009810: 6f75 745f 7370 6563 6966 6965 725f 6465  out_specifier_de
+00009820: 6661 756c 7428 7079 7472 6565 3a20 416e  fault(pytree: An
+00009830: 7929 202d 3e20 6c69 7374 5b54 656e 736f  y) -> list[Tenso
+00009840: 7250 726f 7879 5d3a 0a20 2020 2066 6c61  rProxy]:.    fla
+00009850: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
+00009860: 7474 656e 2870 7974 7265 6529 0a20 2020  tten(pytree).   
+00009870: 2067 7261 6473 203d 206c 6973 7428 5b70   grads = list([p
+00009880: 7269 6d73 2e67 6574 5f67 7261 6428 6629  rims.get_grad(f)
+00009890: 2066 6f72 2066 2069 6e20 666c 6174 7320   for f in flats 
+000098a0: 6966 2069 7369 6e73 7461 6e63 6528 662c  if isinstance(f,
+000098b0: 2054 656e 736f 7250 726f 7879 2920 616e   TensorProxy) an
+000098c0: 6420 662e 7265 7175 6972 6573 5f67 7261  d f.requires_gra
+000098d0: 645d 290a 2020 2020 7265 7475 726e 2067  d]).    return g
+000098e0: 7261 6473 0a0a 0a23 2054 4f44 4f20 466f  rads...# TODO Fo
+000098f0: 726d 616c 6c79 2064 6566 696e 6520 7468  rmally define th
+00009900: 6520 2267 7261 6469 656e 7422 206f 6620  e "gradient" of 
+00009910: 6120 7465 6e73 6f72 0a23 2054 4f44 4f20  a tensor.# TODO 
+00009920: 4966 206e 6f6e 6520 6f66 2074 6865 2069  If none of the i
+00009930: 6e70 7574 7320 746f 2061 6e20 6f70 6572  nputs to an oper
+00009940: 6174 696f 6e20 7265 7175 6972 6520 6772  ation require gr
+00009950: 6164 2c20 7468 656e 2077 6520 636f 756c  ad, then we coul
+00009960: 6420 6c65 6176 6520 7468 6174 206f 7065  d leave that ope
+00009970: 7261 7469 6f6e 2061 6c6f 6e65 0a23 2020  ration alone.#  
+00009980: 2054 6869 7320 636f 756c 6420 6163 7475   This could actu
+00009990: 616c 6c79 2069 6d70 726f 7665 2070 6572  ally improve per
+000099a0: 666f 726d 616e 6365 2069 6620 7468 6520  formance if the 
+000099b0: 6f70 6572 6174 696f 6e20 7065 7266 6f72  operation perfor
+000099c0: 6d73 2065 7874 7261 2063 6f6d 7075 7461  ms extra computa
+000099d0: 7469 6f6e 7320 696e 2069 7473 2067 7261  tions in its gra
+000099e0: 6420 7472 616e 7366 6f72 6d0a 2320 2020  d transform.#   
+000099f0: 4120 776f 726b 6172 6f75 6e64 2066 6f72  A workaround for
+00009a00: 2074 6869 7320 776f 756c 6420 6265 2066   this would be f
+00009a10: 6f72 2074 6865 206f 7065 7261 7469 6f6e  or the operation
+00009a20: 2069 7473 656c 6620 746f 2063 6865 636b   itself to check
+00009a30: 2069 6620 6974 7320 696e 7075 7420 7265   if its input re
+00009a40: 7175 6972 6573 2067 7261 6420 6f72 206e  quires grad or n
+00009a50: 6f74 0a23 2054 7261 6e73 666f 726d 7320  ot.# Transforms 
+00009a60: 6120 6675 6e63 7469 6f6e 2074 6f20 636f  a function to co
+00009a70: 6d70 7574 6520 7468 6520 2267 7261 6469  mpute the "gradi
+00009a80: 656e 7422 206f 6620 6974 7320 696e 7075  ent" of its inpu
+00009a90: 7473 2072 6571 7569 7269 6e67 2067 7261  ts requiring gra
+00009aa0: 642c 2070 6f73 7369 626c 790a 2320 2020  d, possibly.#   
+00009ab0: 6d6f 6469 6669 6564 2062 7920 7468 6520  modified by the 
+00009ac0: 6772 6164 2073 7065 6369 6669 6572 7320  grad specifiers 
+00009ad0: 2873 6565 2062 656c 6f77 292e 0a23 2054  (see below)..# T
+00009ae0: 6865 206f 7074 696f 6e61 6c20 6772 6164  he optional grad
+00009af0: 5f73 7065 6369 6669 6572 2061 7267 756d  _specifier argum
+00009b00: 656e 7420 6163 6365 7074 7320 7468 6520  ent accepts the 
+00009b10: 6675 6e63 7469 6f6e 2773 206f 7574 7075  function's outpu
+00009b20: 742c 2072 756e 7320 696e 2061 206e 6f2d  t, runs in a no-
+00009b30: 6772 6164 2063 6f6e 7465 7874 2c0a 2320  grad context,.# 
+00009b40: 2020 616e 6420 6361 6e20 7075 7420 6772    and can put gr
+00009b50: 6164 7320 2875 7369 6e67 2070 7269 6d73  ads (using prims
+00009b60: 2e70 7574 5f67 7261 6428 2929 2066 6f72  .put_grad()) for
+00009b70: 2074 656e 736f 7273 2e20 4279 2064 6566   tensors. By def
+00009b80: 6175 6c74 2c20 666f 7220 6576 6572 7920  ault, for every 
+00009b90: 7465 6e73 6f72 206f 7574 7075 7420 226f  tensor output "o
+00009ba0: 220a 2320 2020 7468 6174 2072 6571 7569  ".#   that requi
+00009bb0: 7265 7320 6772 6164 2c20 6120 6772 6164  res grad, a grad
+00009bc0: 206f 6620 6f6e 6573 5f6c 696b 6528 6f29   of ones_like(o)
+00009bd0: 2069 7320 7075 742e 0a23 2054 6865 206f   is put..# The o
+00009be0: 7074 696f 6e61 6c20 6772 6164 5f6f 7574  ptional grad_out
+00009bf0: 5f73 7065 6369 6669 6572 2061 6363 6570  _specifier accep
+00009c00: 7473 2074 6865 2066 756e 6374 696f 6e27  ts the function'
+00009c10: 7320 696e 7075 7420 616e 6420 6361 6e20  s input and can 
+00009c20: 6361 6c6c 2070 7269 6d73 2e67 6574 5f67  call prims.get_g
+00009c30: 7261 6428 2920 746f 0a23 2020 2061 6371  rad() to.#   acq
+00009c40: 7569 7265 2061 6e64 2072 6574 7572 6e20  uire and return 
+00009c50: 6772 6164 6965 6e74 7320 6173 2064 6573  gradients as des
+00009c60: 6972 6564 2e20 4279 2064 6566 6175 6c74  ired. By default
+00009c70: 2c20 7468 6520 696e 7075 7420 6973 2066  , the input is f
+00009c80: 6c61 7474 656e 6564 0a23 2020 2028 7472  lattened.#   (tr
+00009c90: 6565 5f66 6c61 7474 656e 2861 7267 732c  ee_flatten(args,
+00009ca0: 206b 7761 7267 7329 2920 616e 6420 6120   kwargs)) and a 
+00009cb0: 666c 6174 206c 6973 7420 6f66 2067 7261  flat list of gra
+00009cc0: 6473 2066 6f72 2061 6c6c 2074 656e 736f  ds for all tenso
+00009cd0: 7273 2072 6571 7569 7269 6e67 2067 7261  rs requiring gra
+00009ce0: 640a 2320 2020 616e 6420 4e6f 6e65 2066  d.#   and None f
+00009cf0: 6f72 206f 7468 6572 2069 6e70 7574 7320  or other inputs 
+00009d00: 6973 2072 6574 7572 6e65 642e 0a23 2054  is returned..# T
+00009d10: 6865 2061 6c67 6f72 6974 686d 2066 6f72  he algorithm for
+00009d20: 206d 6f64 6966 7969 6e67 2074 6865 2070   modifying the p
+00009d30: 726f 6772 616d 2068 6173 2074 6865 2066  rogram has the f
+00009d40: 6f6c 6c6f 7769 6e67 2073 7465 7073 3a0a  ollowing steps:.
+00009d50: 2320 2020 3129 2046 6c61 7474 656e 7320  #   1) Flattens 
+00009d60: 7468 6520 6f72 6967 696e 616c 2074 7261  the original tra
+00009d70: 6365 2066 6f72 2074 6865 2067 7261 6420  ce for the grad 
+00009d80: 7472 616e 7366 6f72 6d20 2d2d 2065 6e73  transform -- ens
+00009d90: 7569 6e67 2074 6861 7420 616c 6c20 746f  uing that all to
+00009da0: 702d 6c65 7665 6c20 7379 6d62 6f6c 7320  p-level symbols 
+00009db0: 6861 7665 0a23 2020 2020 2020 2061 2067  have.#       a g
+00009dc0: 7261 6420 6675 6e63 7469 6f6e 2e0a 6465  rad function..de
+00009dd0: 6620 6772 6164 280a 2020 2020 6366 6e2c  f grad(.    cfn,
+00009de0: 2067 7261 645f 7370 6563 6966 6965 723a   grad_specifier:
+00009df0: 2043 616c 6c61 626c 6520 3d20 5f67 7261   Callable = _gra
+00009e00: 645f 7370 6563 6966 6965 725f 6465 6661  d_specifier_defa
+00009e10: 756c 742c 2067 7261 645f 6f75 745f 7370  ult, grad_out_sp
+00009e20: 6563 6966 6965 723a 2043 616c 6c61 626c  ecifier: Callabl
+00009e30: 6520 3d20 5f67 7261 645f 6f75 745f 7370  e = _grad_out_sp
+00009e40: 6563 6966 6965 725f 6465 6661 756c 740a  ecifier_default.
+00009e50: 2920 2d3e 2043 616c 6c61 626c 653a 0a20  ) -> Callable:. 
+00009e60: 2020 2023 2043 7265 6174 6573 2061 2063     # Creates a c
+00009e70: 7573 746f 6d20 7472 616e 7366 6f72 6d20  ustom transform 
+00009e80: 6361 6c6c 6162 6c65 2074 6861 7420 6269  callable that bi
+00009e90: 6e64 7320 7468 6520 6164 6469 7469 6f6e  nds the addition
+00009ea0: 616c 2061 7267 756d 656e 7473 2074 6f20  al arguments to 
+00009eb0: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
+00009ec0: 726d 0a20 2020 2040 6c61 6e67 6374 7828  rm.    @langctx(
+00009ed0: 4c61 6e67 7561 6765 732e 434c 414e 4729  Languages.CLANG)
+00009ee0: 0a20 2020 2064 6566 205f 6772 6164 5f74  .    def _grad_t
+00009ef0: 7261 6e73 666f 726d 2874 7263 3a20 5472  ransform(trc: Tr
+00009f00: 6163 652c 202a 2c20 6578 6563 7574 6f72  ace, *, executor
+00009f10: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
+00009f20: 5b41 6e79 5d29 202d 3e20 5472 6163 653a  [Any]) -> Trace:
+00009f30: 0a20 2020 2020 2020 2073 7461 7274 5f74  .        start_t
+00009f40: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
+00009f50: 6d65 5f6e 7328 290a 0a20 2020 2020 2020  me_ns()..       
+00009f60: 2023 2053 5445 5020 4f4e 4520 2d2d 2046   # STEP ONE -- F
+00009f70: 6c61 7474 656e 7320 616e 6420 6463 6573  lattens and dces
+00009f80: 0a0a 2020 2020 2020 2020 2320 5265 7475  ..        # Retu
+00009f90: 726e 7320 5472 7565 2069 6620 7468 6520  rns True if the 
+00009fa0: 6273 796d 2068 6173 206e 6f20 6772 6164  bsym has no grad
+00009fb0: 2066 756e 6374 696f 6e2c 2061 6e64 2073   function, and s
+00009fc0: 6f20 6d75 7374 2062 6520 666c 6174 7465  o must be flatte
+00009fd0: 6e65 6420 666f 7220 7468 6520 6772 6164  ned for the grad
+00009fe0: 2074 7261 6e73 666f 726d 0a20 2020 2020   transform.     
+00009ff0: 2020 206e 6576 6572 5f66 6c61 7474 656e     never_flatten
+0000a000: 3a20 7365 745b 4861 7368 6162 6c65 5d20  : set[Hashable] 
+0000a010: 3d20 7b70 7269 6d73 2e50 7269 6d49 4473  = {prims.PrimIDs
+0000a020: 2e52 4554 5552 4e2c 2070 7269 6d73 2e50  .RETURN, prims.P
+0000a030: 7269 6d49 4473 2e55 4e50 4143 4b5f 5452  rimIDs.UNPACK_TR
+0000a040: 4956 4941 4c7d 0a0a 2020 2020 2020 2020  IVIAL}..        
+0000a050: 6465 6620 7368 6f75 6c64 5f66 6c61 7474  def should_flatt
+0000a060: 656e 5f66 6f72 5f67 7261 6428 6273 796d  en_for_grad(bsym
+0000a070: 3a20 426f 756e 6453 796d 626f 6c29 202d  : BoundSymbol) -
+0000a080: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
+0000a090: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
+0000a0a0: 6964 2069 6e20 6e65 7665 725f 666c 6174  id in never_flat
+0000a0b0: 7465 6e3a 0a20 2020 2020 2020 2020 2020  ten:.           
+0000a0c0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0000a0d0: 650a 0a20 2020 2020 2020 2020 2020 2067  e..            g
+0000a0e0: 7261 6466 6e3a 204e 6f6e 6520 7c20 4361  radfn: None | Ca
+0000a0f0: 6c6c 6162 6c65 203d 205f 6765 745f 6772  llable = _get_gr
+0000a100: 6164 666e 2862 7379 6d2c 2065 7865 6375  adfn(bsym, execu
+0000a110: 746f 7273 5f6c 6973 743d 6578 6563 7574  tors_list=execut
+0000a120: 6f72 735f 6c69 7374 290a 2020 2020 2020  ors_list).      
+0000a130: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+0000a140: 6466 6e20 6973 204e 6f6e 650a 0a20 2020  dfn is None..   
+0000a150: 2020 2020 2023 2054 4f44 4f20 5243 313a       # TODO RC1:
+0000a160: 206d 6179 6265 206d 6f76 6520 746f 2070   maybe move to p
+0000a170: 726f 6475 6365 2074 6865 7365 2061 6c77  roduce these alw
+0000a180: 6179 7320 6f6e 2063 7265 6174 696f 6e0a  ays on creation.
+0000a190: 2020 2020 2020 2020 6966 2074 7263 2e6b          if trc.k
+0000a1a0: 7761 7267 7320 6973 204e 6f6e 653a 0a20  wargs is None:. 
+0000a1b0: 2020 2020 2020 2020 2020 2074 7263 2e6b             trc.k
+0000a1c0: 7761 7267 7320 3d20 7b7d 0a20 2020 2020  wargs = {}.     
+0000a1d0: 2020 2069 6620 7472 632e 666e 2069 7320     if trc.fn is 
+0000a1e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a1f0: 2020 7472 632e 666e 203d 2074 7263 2e70    trc.fn = trc.p
+0000a200: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
+0000a210: 0a0a 2020 2020 2020 2020 6772 6164 7472  ..        gradtr
+0000a220: 6320 3d20 6672 6f6d 5f74 7261 6365 2874  c = from_trace(t
+0000a230: 7263 290a 2020 2020 2020 2020 666c 6174  rc).        flat
+0000a240: 7465 6e65 645f 6273 796d 733a 206c 6973  tened_bsyms: lis
+0000a250: 745b 426f 756e 6453 796d 626f 6c5d 203d  t[BoundSymbol] =
+0000a260: 2066 6c61 7474 656e 5f66 6f72 5f74 7261   flatten_for_tra
+0000a270: 6e73 666f 726d 2873 686f 756c 645f 666c  nsform(should_fl
+0000a280: 6174 7465 6e5f 666f 725f 6772 6164 2c20  atten_for_grad, 
+0000a290: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000a2a0: 7329 0a20 2020 2020 2020 2067 7261 6474  s).        gradt
+0000a2b0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
+0000a2c0: 203d 2066 6c61 7474 656e 6564 5f62 7379   = flattened_bsy
+0000a2d0: 6d73 0a20 2020 2020 2020 2067 7261 6474  ms.        gradt
+0000a2e0: 7263 203d 2064 6365 2867 7261 6474 7263  rc = dce(gradtrc
+0000a2f0: 290a 0a20 2020 2020 2020 2023 2053 5445  )..        # STE
+0000a300: 5020 5457 4f20 2d2d 2052 6570 6c61 6365  P TWO -- Replace
+0000a310: 7320 6f72 6967 696e 616c 2063 616c 6c73  s original calls
+0000a320: 2077 6974 6820 6772 6164 2063 616c 6c73   with grad calls
+0000a330: 0a0a 2020 2020 2020 2020 2320 4465 6669  ..        # Defi
+0000a340: 6e65 7320 7468 6520 7669 7369 746f 7220  nes the visitor 
+0000a350: 7061 7474 6572 6e20 666f 7220 7468 6520  pattern for the 
+0000a360: 6669 7273 7420 7061 7373 206f 6620 7468  first pass of th
+0000a370: 6520 6772 6164 2074 7261 6e73 666f 726d  e grad transform
+0000a380: 2c0a 2020 2020 2020 2020 2320 2020 7768  ,.        #   wh
+0000a390: 6963 6820 7377 6170 7320 426f 756e 6453  ich swaps BoundS
+0000a3a0: 796d 626f 6c73 2077 6974 6820 7468 6569  ymbols with thei
+0000a3b0: 7220 6772 6164 2066 756e 6374 696f 6e73  r grad functions
+0000a3c0: 0a20 2020 2020 2020 2064 6566 2076 6973  .        def vis
+0000a3d0: 6974 5f28 6273 796d 3a20 426f 756e 6453  it_(bsym: BoundS
+0000a3e0: 796d 626f 6c29 202d 3e20 4361 6c6c 6162  ymbol) -> Callab
+0000a3f0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+0000a400: 6772 6164 666e 3a20 4e6f 6e65 207c 2043  gradfn: None | C
+0000a410: 616c 6c61 626c 6520 3d20 5f67 6574 5f67  allable = _get_g
+0000a420: 7261 6466 6e28 6273 796d 2c20 6578 6563  radfn(bsym, exec
+0000a430: 7574 6f72 735f 6c69 7374 3d65 7865 6375  utors_list=execu
+0000a440: 746f 7273 5f6c 6973 7429 0a20 2020 2020  tors_list).     
+0000a450: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+0000a460: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+0000a470: 6164 666e 2069 7320 6e6f 7420 4e6f 6e65  adfn is not None
+0000a480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000a490: 2020 6c61 6d62 6461 3a20 6622 4661 696c    lambda: f"Fail
+0000a4a0: 6564 2074 6f20 6669 6e64 2061 2067 7261  ed to find a gra
+0000a4b0: 6466 6e20 666f 7220 7b62 7379 6d3d 7d20  dfn for {bsym=} 
+0000a4c0: 6166 7465 7220 666c 6174 7465 6e69 6e67  after flattening
+0000a4d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000a4e0: 2020 2065 7863 6570 7469 6f6e 5f74 7970     exception_typ
+0000a4f0: 653d 4173 7365 7274 696f 6e45 7272 6f72  e=AssertionError
+0000a500: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000a510: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a520: 726e 2067 7261 6466 6e0a 0a20 2020 2020  rn gradfn..     
+0000a530: 2020 2040 7772 6170 7328 7472 632e 666e     @wraps(trc.fn
+0000a540: 2e6d 6574 6120 6966 2069 7369 6e73 7461  .meta if isinsta
+0000a550: 6e63 6528 7472 632e 666e 2c20 5379 6d62  nce(trc.fn, Symb
+0000a560: 6f6c 2920 656c 7365 2074 7263 2e66 6e29  ol) else trc.fn)
+0000a570: 0a20 2020 2020 2020 2064 6566 2069 6e74  .        def int
+0000a580: 6572 7072 6574 696e 675f 666e 282a 6172  erpreting_fn(*ar
+0000a590: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000a5a0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0000a5b0: 7420 3d20 6576 616c 5f74 7261 6365 2867  t = eval_trace(g
+0000a5c0: 7261 6474 7263 2c20 2a61 7267 732c 2073  radtrc, *args, s
+0000a5d0: 796d 626f 6c5f 6d61 7070 6572 3d76 6973  ymbol_mapper=vis
+0000a5e0: 6974 5f2c 202a 2a6b 7761 7267 7329 0a20  it_, **kwargs). 
+0000a5f0: 2020 2020 2020 2020 2020 2023 2053 6574             # Set
+0000a600: 7320 6772 6164 7320 666f 7220 6f75 7470  s grads for outp
+0000a610: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
+0000a620: 2054 4f44 4f20 5468 6973 2065 6666 6563   TODO This effec
+0000a630: 7469 7665 6c79 2072 756e 7320 696e 2061  tively runs in a
+0000a640: 206e 6f20 6772 6164 2063 6f6e 7465 7874   no grad context
+0000a650: 202d 2d20 7368 6f75 6c64 2069 7420 7275   -- should it ru
+0000a660: 6e20 696e 2061 2067 7261 6420 636f 6e74  n in a grad cont
+0000a670: 6578 742c 0a20 2020 2020 2020 2020 2020  ext,.           
+0000a680: 2023 2020 206f 7220 7368 6f75 6c64 2074   #   or should t
+0000a690: 6865 7265 2062 6520 7468 6520 6f70 7469  here be the opti
+0000a6a0: 6f6e 2074 6f20 7275 6e20 6974 2069 6e20  on to run it in 
+0000a6b0: 6120 6772 6164 2063 6f6e 7465 7874 3f0a  a grad context?.
+0000a6c0: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0000a6d0: 5f73 7065 6369 6669 6572 2872 6573 756c  _specifier(resul
+0000a6e0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
+0000a6f0: 2043 6f6e 7374 7275 6374 7320 7265 7475   Constructs retu
+0000a700: 726e 2076 616c 7565 0a20 2020 2020 2020  rn value.       
+0000a710: 2020 2020 2066 6c61 745f 6772 6164 7320       flat_grads 
+0000a720: 3d20 6772 6164 5f6f 7574 5f73 7065 6369  = grad_out_speci
+0000a730: 6669 6572 2828 6172 6773 2c20 6b77 6172  fier((args, kwar
+0000a740: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
+0000a750: 2072 6574 7572 6e20 666c 6174 5f67 7261   return flat_gra
+0000a760: 6473 0a0a 2020 2020 2020 2020 2320 4e4f  ds..        # NO
+0000a770: 5445 2041 6674 6572 2074 6869 7320 6361  TE After this ca
+0000a780: 6c6c 2074 6865 2067 7261 6474 7263 2069  ll the gradtrc i
+0000a790: 7320 696e 7661 6c69 642c 2062 6563 6175  s invalid, becau
+0000a7a0: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
+0000a7b0: 3129 2054 6865 206e 6f6e 2d65 7865 6375  1) The non-execu
+0000a7c0: 7461 626c 6520 7075 745f 6772 6164 206f  table put_grad o
+0000a7d0: 7065 7261 7469 6f6e 7320 6172 6520 7374  perations are st
+0000a7e0: 696c 6c20 696e 2074 6865 2074 7261 6365  ill in the trace
+0000a7f0: 2c20 616e 6420 6d75 6c74 6970 6c65 2063  , and multiple c
+0000a800: 616c 6c73 2074 6f20 7075 7420 6772 6164  alls to put grad
+0000a810: 2061 7265 206e 6f74 2061 6363 756d 756c   are not accumul
+0000a820: 6174 6564 0a20 2020 2020 2020 2023 2020  ated.        #  
+0000a830: 2032 2920 5468 6520 6e6f 6e2d 6578 6563   2) The non-exec
+0000a840: 7574 6162 6c65 2067 6574 5f67 7261 6420  utable get_grad 
+0000a850: 6f70 6572 6174 696f 6e73 2061 7265 2073  operations are s
+0000a860: 7469 6c6c 2069 6e20 7468 6520 7472 6163  till in the trac
+0000a870: 652c 2061 6e64 2074 6865 7920 6d61 7920  e, and they may 
+0000a880: 7072 6f64 7563 6520 6469 6666 6572 656e  produce differen
+0000a890: 7420 7072 6f78 6965 7320 7768 656e 0a20  t proxies when. 
+0000a8a0: 2020 2020 2020 2023 2020 2020 2020 2063         #       c
+0000a8b0: 616c 6c65 6420 6f6e 2074 6865 2073 616d  alled on the sam
+0000a8c0: 6520 696e 7075 7473 0a20 2020 2020 2020  e inputs.       
+0000a8d0: 2023 2020 2033 2920 5468 6520 6f70 6572   #   3) The oper
+0000a8e0: 6174 696f 6e73 2061 7265 206e 6f74 2069  ations are not i
+0000a8f0: 6e20 6120 7661 6c69 6420 6f72 6465 720a  n a valid order.
+0000a900: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
+0000a910: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+0000a920: 6528 0a20 2020 2020 2020 2020 2020 2072  e(.            r
+0000a930: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
+0000a940: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+0000a950: 2075 7365 5f64 6365 3d46 616c 7365 2c0a   use_dce=False,.
+0000a960: 2020 2020 2020 2020 2928 696e 7465 7270          )(interp
+0000a970: 7265 7469 6e67 5f66 6e2c 202a 6772 6164  reting_fn, *grad
+0000a980: 7472 632e 6172 6773 2c20 2a2a 6772 6164  trc.args, **grad
+0000a990: 7472 632e 6b77 6172 6773 290a 2020 2020  trc.kwargs).    
+0000a9a0: 2020 2020 6772 6164 7472 632e 7363 6f70      gradtrc.scop
+0000a9b0: 6573 203d 205b 6772 6164 7472 632e 626f  es = [gradtrc.bo
+0000a9c0: 756e 645f 7379 6d62 6f6c 735d 0a20 2020  und_symbols].   
+0000a9d0: 2020 2020 2067 7261 6474 7263 2e5f 636f       gradtrc._co
+0000a9e0: 6d70 6c65 7465 203d 2046 616c 7365 0a0a  mplete = False..
+0000a9f0: 2020 2020 2020 2020 2320 5354 4550 2054          # STEP T
+0000aa00: 4852 4545 202d 2d20 4861 6e64 6c65 7320  HREE -- Handles 
+0000aa10: 7075 745f 6772 6164 2061 6e64 2067 6574  put_grad and get
+0000aa20: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
+0000aa30: 2061 6e64 2061 6363 756d 756c 6174 6573   and accumulates
+0000aa40: 2067 7261 6469 656e 7473 0a0a 2020 2020   gradients..    
+0000aa50: 2020 2020 2320 4163 6375 6d75 6c61 7465      # Accumulate
+0000aa60: 7320 6772 6164 6965 6e74 732c 2063 7265  s gradients, cre
+0000aa70: 6174 696e 6720 7468 6520 7072 696d 616c  ating the primal
+0000aa80: 202d 3e20 6163 6375 6d75 6c61 7465 6420   -> accumulated 
+0000aa90: 6772 6164 206d 6170 7069 6e67 0a20 2020  grad mapping.   
+0000aaa0: 2020 2020 2023 2053 6574 7320 7468 6520       # Sets the 
+0000aab0: 7472 6163 696e 6720 636f 6e74 6578 7420  tracing context 
+0000aac0: 736f 2061 6363 756d 756c 6174 696f 6e20  so accumulation 
+0000aad0: 6f70 6572 6174 696f 6e73 2061 7265 2072  operations are r
+0000aae0: 6563 6f72 6465 6420 696e 746f 2074 6865  ecorded into the
+0000aaf0: 2074 7261 6365 0a20 2020 2020 2020 2074   trace.        t
+0000ab00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000ab10: 7472 6163 6563 7478 5f74 6f6b 203d 2073  tracectx_tok = s
+0000ab20: 6574 5f74 7261 6365 6374 7828 6772 6164  et_tracectx(grad
+0000ab30: 7472 6329 0a0a 2020 2020 2020 2020 2020  trc)..          
+0000ab40: 2020 2320 4d61 7073 2070 7269 6d61 6c73    # Maps primals
+0000ab50: 2074 6f20 7468 6569 7220 6772 6164 6965   to their gradie
+0000ab60: 6e74 7320 2877 6869 6368 2061 7265 2072  nts (which are r
+0000ab70: 6574 7572 6e65 6420 6672 6f6d 2063 616c  eturned from cal
+0000ab80: 6c69 6e67 2067 6574 5f67 7261 6420 6f6e  ling get_grad on
+0000ab90: 2074 6865 2070 7269 6d61 6c29 0a20 2020   the primal).   
+0000aba0: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
+0000abb0: 5f74 6f5f 6769 6e70 7574 5f6d 6170 3a20  _to_ginput_map: 
+0000abc0: 6469 6374 5b56 6172 6961 626c 652c 2054  dict[Variable, T
+0000abd0: 656e 736f 7250 726f 7879 5d20 3d20 7b7d  ensorProxy] = {}
+0000abe0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000abf0: 4861 6e64 6c65 7320 7075 745f 6772 6164  Handles put_grad
+0000ac00: 206f 7065 7261 7469 6f6e 730a 2020 2020   operations.    
+0000ac10: 2020 2020 2020 2020 2320 4e4f 5445 2054          # NOTE T
+0000ac20: 6869 7320 6d6f 6469 6669 6573 2061 206c  his modifies a l
+0000ac30: 6973 7420 7468 6174 2069 7320 6265 696e  ist that is bein
+0000ac40: 6720 656e 756d 6572 6174 6564 206f 7665  g enumerated ove
+0000ac50: 722c 2062 7574 2069 7427 7320 4f4b 2062  r, but it's OK b
+0000ac60: 6563 6175 7365 2077 6527 7265 206f 6e6c  ecause we're onl
+0000ac70: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+0000ac80: 2020 6170 7065 6e64 696e 6720 746f 2074    appending to t
+0000ac90: 6865 2065 6e64 206f 6620 7468 6520 6c69  he end of the li
+0000aca0: 7374 0a20 2020 2020 2020 2020 2020 2062  st.            b
+0000acb0: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
+0000acc0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000acd0: 2062 7379 6d20 696e 2067 7261 6474 7263   bsym in gradtrc
+0000ace0: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
+0000acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad00: 6964 3a20 4861 7368 6162 6c65 203d 2062  id: Hashable = b
+0000ad10: 7379 6d2e 7379 6d2e 6964 0a20 2020 2020  sym.sym.id.     
+0000ad20: 2020 2020 2020 2020 2020 2069 6620 6964             if id
+0000ad30: 2069 7320 7069 6473 2e50 5554 5f47 5241   is pids.PUT_GRA
+0000ad40: 443a 0a20 2020 2020 2020 2020 2020 2020  D:.             
+0000ad50: 2020 2020 2020 2070 7269 6d61 6c3a 204e         primal: N
+0000ad60: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+0000ad70: 6f78 790a 2020 2020 2020 2020 2020 2020  oxy.            
+0000ad80: 2020 2020 2020 2020 6772 6164 3a20 4e75          grad: Nu
+0000ad90: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+0000ada0: 7879 0a20 2020 2020 2020 2020 2020 2020  xy.             
+0000adb0: 2020 2020 2020 2070 7269 6d61 6c2c 2067         primal, g
+0000adc0: 7261 6420 3d20 6273 796d 2e66 6c61 745f  rad = bsym.flat_
+0000add0: 6172 6773 0a0a 2020 2020 2020 2020 2020  args..          
+0000ade0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0000adf0: 2053 7570 706f 7274 2061 7574 6f67 7261   Support autogra
+0000ae00: 6420 6f6e 206e 756d 6265 7273 0a20 2020  d on numbers.   
+0000ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae20: 2023 2046 696c 7465 7273 2063 616c 6c73   # Filters calls
+0000ae30: 2074 6f20 7075 745f 6772 6164 2074 6861   to put_grad tha
+0000ae40: 7420 776f 756c 6420 7075 7420 6120 6772  t would put a gr
+0000ae50: 6164 206f 6e20 6120 6e6f 6e2d 7465 6e73  ad on a non-tens
+0000ae60: 6f72 206f 7220 6120 7465 6e73 6f72 2074  or or a tensor t
+0000ae70: 6861 7420 646f 6573 6e27 7420 7265 7175  hat doesn't requ
+0000ae80: 6972 6520 6772 6164 0a20 2020 2020 2020  ire grad.       
+0000ae90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000aea0: 6e6f 7420 6973 696e 7374 616e 6365 2870  not isinstance(p
+0000aeb0: 7269 6d61 6c2c 2054 656e 736f 7250 726f  rimal, TensorPro
+0000aec0: 7879 2920 6f72 206e 6f74 2070 7269 6d61  xy) or not prima
+0000aed0: 6c2e 7265 7175 6972 6573 5f67 7261 643a  l.requires_grad:
+0000aee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aef0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0000af00: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000af10: 2020 2020 2020 2023 2054 4f44 4f20 5375         # TODO Su
+0000af20: 7070 6f72 7420 636f 6d70 6c65 7820 6175  pport complex au
+0000af30: 746f 6772 6164 0a20 2020 2020 2020 2020  tograd.         
+0000af40: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0000af50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000af60: 2020 2020 2020 2020 2020 6e6f 7420 6474            not dt
+0000af70: 7970 6573 2e69 735f 636f 6d70 6c65 785f  ypes.is_complex_
+0000af80: 6474 7970 6528 6474 7970 6573 2e74 6f5f  dtype(dtypes.to_
+0000af90: 6474 7970 6528 7072 696d 616c 2929 2c0a  dtype(primal)),.
+0000afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afb0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0000afc0: 6622 436f 6d70 6c65 7820 6772 6164 2069  f"Complex grad i
+0000afd0: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
+0000afe0: 7965 7422 2c0a 2020 2020 2020 2020 2020  yet",.          
+0000aff0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b010: 2076 7072 696d 616c 3a20 5661 7269 6162   vprimal: Variab
+0000b020: 6c65 203d 2076 6172 6961 626c 6569 6679  le = variableify
+0000b030: 2870 7269 6d61 6c29 0a20 2020 2020 2020  (primal).       
+0000b040: 2020 2020 2020 2020 2020 2020 2061 6363               acc
+0000b050: 756d 3a20 4e6f 6e65 207c 2054 656e 736f  um: None | Tenso
+0000b060: 7250 726f 7879 203d 2070 7269 6d61 6c73  rProxy = primals
+0000b070: 5f74 6f5f 6769 6e70 7574 5f6d 6170 2e67  _to_ginput_map.g
+0000b080: 6574 2876 7072 696d 616c 2c20 4e6f 6e65  et(vprimal, None
+0000b090: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000b0a0: 2020 2020 2020 2069 6620 6163 6375 6d20         if accum 
+0000b0b0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0d0: 2070 7269 6d61 6c73 5f74 6f5f 6769 6e70   primals_to_ginp
+0000b0e0: 7574 5f6d 6170 5b76 7072 696d 616c 5d20  ut_map[vprimal] 
+0000b0f0: 3d20 6772 6164 0a20 2020 2020 2020 2020  = grad.         
+0000b100: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000b110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b120: 2020 2020 2020 2020 2061 6363 756d 203d           accum =
+0000b130: 2061 6363 756d 202b 2067 7261 640a 2020   accum + grad.  
+0000b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b150: 2020 2020 2020 7072 696d 616c 735f 746f        primals_to
+0000b160: 5f67 696e 7075 745f 6d61 705b 7670 7269  _ginput_map[vpri
+0000b170: 6d61 6c5d 203d 2061 6363 756d 0a0a 2020  mal] = accum..  
+0000b180: 2020 2020 2020 2020 2020 2320 4861 6e64            # Hand
+0000b190: 6c65 7320 6765 745f 6772 6164 206f 7065  les get_grad ope
+0000b1a0: 7261 7469 6f6e 730a 0a20 2020 2020 2020  rations..       
+0000b1b0: 2020 2020 2023 2052 6573 6574 7320 7468       # Resets th
+0000b1c0: 6520 7377 6170 6d61 7020 666f 7220 6772  e swapmap for gr
+0000b1d0: 6164 730a 2020 2020 2020 2020 2020 2020  ads.            
+0000b1e0: 7377 6170 6d61 703a 2064 6963 745b 5661  swapmap: dict[Va
+0000b1f0: 7269 6162 6c65 2c20 5072 6f78 795d 203d  riable, Proxy] =
+0000b200: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+0000b210: 2066 6f72 2062 7379 6d20 696e 2067 7261   for bsym in gra
+0000b220: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000b230: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0000b240: 2020 2020 6964 3a20 4861 7368 6162 6c65      id: Hashable
+0000b250: 203d 2062 7379 6d2e 7379 6d2e 6964 0a20   = bsym.sym.id. 
+0000b260: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b270: 6620 6964 2069 7320 7069 6473 2e47 4554  f id is pids.GET
+0000b280: 5f47 5241 443a 0a20 2020 2020 2020 2020  _GRAD:.         
+0000b290: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000b2a0: 6c3a 204e 756d 6265 7220 7c20 5465 6e73  l: Number | Tens
+0000b2b0: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
+0000b2c0: 2020 2020 2020 2020 2020 2020 2870 7269              (pri
+0000b2d0: 6d61 6c2c 2920 3d20 6273 796d 2e66 6c61  mal,) = bsym.fla
+0000b2e0: 745f 6172 6773 0a20 2020 2020 2020 2020  t_args.         
+0000b2f0: 2020 2020 2020 2020 2020 2067 7261 643a             grad:
+0000b300: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+0000b310: 5072 6f78 7920 3d20 6273 796d 2e6f 7574  Proxy = bsym.out
+0000b320: 7075 740a 0a20 2020 2020 2020 2020 2020  put..           
+0000b330: 2020 2020 2020 2020 2076 7072 696d 616c           vprimal
+0000b340: 3a20 5661 7269 6162 6c65 0a20 2020 2020  : Variable.     
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0000b360: 6772 6164 3a20 5661 7269 6162 6c65 0a20  grad: Variable. 
+0000b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b380: 2020 2076 7072 696d 616c 2c20 7667 7261     vprimal, vgra
+0000b390: 6420 3d20 7661 7269 6162 6c65 6966 7928  d = variableify(
+0000b3a0: 7072 696d 616c 292c 2076 6172 6961 626c  primal), variabl
+0000b3b0: 6569 6679 2867 7261 6429 0a0a 2020 2020  eify(grad)..    
+0000b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3d0: 6163 7475 616c 5f67 7261 643a 204e 6f6e  actual_grad: Non
+0000b3e0: 6520 7c20 5465 6e73 6f72 5072 6f78 7920  e | TensorProxy 
+0000b3f0: 3d20 7072 696d 616c 735f 746f 5f67 696e  = primals_to_gin
+0000b400: 7075 745f 6d61 702e 6765 7428 7670 7269  put_map.get(vpri
+0000b410: 6d61 6c2c 204e 6f6e 6529 0a0a 2020 2020  mal, None)..    
+0000b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b430: 2320 4e4f 5445 2049 6620 6163 7475 616c  # NOTE If actual
+0000b440: 5f67 7261 6420 6973 204e 6f6e 6520 7468  _grad is None th
+0000b450: 656e 2074 6865 7265 2773 2061 2067 6574  en there's a get
+0000b460: 5f67 7261 6428 2920 7265 7175 6573 7420  _grad() request 
+0000b470: 666f 7220 6120 7465 6e73 6f72 2077 6869  for a tensor whi
+0000b480: 6368 0a20 2020 2020 2020 2020 2020 2020  ch.             
+0000b490: 2020 2020 2020 2023 2020 2068 6173 206e         #   has n
+0000b4a0: 6f20 7075 745f 6772 6164 2829 2c20 736f  o put_grad(), so
+0000b4b0: 2077 6520 7265 7475 726e 207a 6572 6f73   we return zeros
+0000b4c0: 2066 6f72 2074 6865 2067 7261 640a 2020   for the grad.  
 0000b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4e0: 2020 2020 7072 696d 616c 735f 746f 5f67      primals_to_g
-0000b4f0: 696e 7075 745f 6d61 705b 7670 7269 6d61  input_map[vprima
-0000b500: 6c5d 203d 2061 6374 7561 6c5f 6772 6164  l] = actual_grad
-0000b510: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000b520: 2020 2020 2020 2320 5570 6461 7465 7320        # Updates 
-0000b530: 7468 6520 6772 6164 2061 6c69 6173 206d  the grad alias m
-0000b540: 6170 0a20 2020 2020 2020 2020 2020 2020  ap.             
-0000b550: 2020 2020 2020 2076 6163 7475 616c 5f67         vactual_g
-0000b560: 7261 643a 2056 6172 6961 626c 6520 3d20  rad: Variable = 
-0000b570: 7661 7269 6162 6c65 6966 7928 6163 7475  variableify(actu
-0000b580: 616c 5f67 7261 6429 0a20 2020 2020 2020  al_grad).       
-0000b590: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000b5a0: 7661 6374 7561 6c5f 6772 6164 2021 3d20  vactual_grad != 
-0000b5b0: 7667 7261 643a 0a20 2020 2020 2020 2020  vgrad:.         
-0000b5c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b5d0: 7761 706d 6170 5b76 6772 6164 5d20 3d20  wapmap[vgrad] = 
-0000b5e0: 6163 7475 616c 5f67 7261 640a 0a20 2020  actual_grad..   
-0000b5f0: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
-0000b600: 2020 2020 2020 2020 2020 2320 5265 7374            # Rest
-0000b610: 6f72 6573 2073 636f 7065 0a20 2020 2020  ores scope.     
-0000b620: 2020 2020 2020 2072 6573 6574 5f74 7261         reset_tra
-0000b630: 6365 6374 7828 7472 6163 6563 7478 5f74  cectx(tracectx_t
-0000b640: 6f6b 290a 0a20 2020 2020 2020 2023 2046  ok)..        # F
-0000b650: 696c 7465 7273 2070 7574 5f67 7261 6420  ilters put_grad 
-0000b660: 616e 6420 6765 745f 6772 6164 206f 7065  and get_grad ope
-0000b670: 7261 7469 6f6e 7320 616e 6420 6170 706c  rations and appl
-0000b680: 6965 7320 7468 6520 7377 6170 6d61 700a  ies the swapmap.
-0000b690: 2020 2020 2020 2020 6465 6620 5f66 696c          def _fil
-0000b6a0: 7465 7228 6273 796d 3a20 426f 756e 6453  ter(bsym: BoundS
-0000b6b0: 796d 626f 6c29 202d 3e20 626f 6f6c 3a0a  ymbol) -> bool:.
-0000b6c0: 2020 2020 2020 2020 2020 2020 6964 3a20              id: 
-0000b6d0: 4861 7368 6162 6c65 203d 2062 7379 6d2e  Hashable = bsym.
-0000b6e0: 7379 6d2e 6964 0a20 2020 2020 2020 2020  sym.id.         
-0000b6f0: 2020 2072 6574 7572 6e20 6964 2069 6e20     return id in 
-0000b700: 2870 6964 732e 5055 545f 4752 4144 2c20  (pids.PUT_GRAD, 
-0000b710: 7069 6473 2e47 4554 5f47 5241 4429 0a0a  pids.GET_GRAD)..
-0000b720: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
-0000b730: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0000b740: 5b0a 2020 2020 2020 2020 2020 2020 6273  [.            bs
-0000b750: 796d 2e66 726f 6d5f 6273 796d 5f73 7761  ym.from_bsym_swa
-0000b760: 705f 7072 6f78 6965 7328 7377 6170 6d61  p_proxies(swapma
-0000b770: 7029 2066 6f72 2062 7379 6d20 696e 2067  p) for bsym in g
-0000b780: 7261 6474 7263 2e62 6f75 6e64 5f73 796d  radtrc.bound_sym
-0000b790: 626f 6c73 2069 6620 6e6f 7420 5f66 696c  bols if not _fil
-0000b7a0: 7465 7228 6273 796d 290a 2020 2020 2020  ter(bsym).      
-0000b7b0: 2020 5d0a 0a20 2020 2020 2020 2023 2053    ]..        # S
-0000b7c0: 5445 5020 464f 5552 202d 2d2d 204f 7264  TEP FOUR --- Ord
-0000b7d0: 6572 7320 7468 6520 6f70 6572 6174 696f  ers the operatio
-0000b7e0: 6e73 0a20 2020 2020 2020 2023 2054 4f44  ns.        # TOD
-0000b7f0: 4f20 436f 6e73 6964 6572 2061 6c74 6572  O Consider alter
-0000b800: 6e61 7469 7665 2073 6368 6564 756c 696e  native schedulin
-0000b810: 6720 616c 676f 7269 7468 6d73 2c20 6d61  g algorithms, ma
-0000b820: 7962 6520 6279 2075 7369 6e67 2067 7261  ybe by using gra
-0000b830: 7068 2066 6561 7475 7265 730a 2020 2020  ph features.    
-0000b840: 2020 2020 2320 2020 536f 6d65 2069 6465      #   Some ide
-0000b850: 6173 2061 7265 206c 6f6f 6b69 6e67 2061  as are looking a
-0000b860: 7420 6d65 6d6f 7279 2d73 6176 696e 6720  t memory-saving 
-0000b870: 6e6f 6465 732c 2061 6e64 206e 6f64 6573  nodes, and nodes
-0000b880: 2077 6974 6820 6120 6869 6768 2069 6e2d   with a high in-
-0000b890: 6465 6772 6565 206f 7220 6869 6768 206f  degree or high o
-0000b8a0: 7574 2d64 6567 7265 650a 0a20 2020 2020  ut-degree..     
-0000b8b0: 2020 2023 2043 7265 6174 6573 2061 6e20     # Creates an 
-0000b8c0: 696e 6974 6961 6c20 7661 6c69 6420 6f72  initial valid or
-0000b8d0: 6465 7269 6e67 2074 6f20 4443 452c 2073  dering to DCE, s
-0000b8e0: 6f20 7468 6174 2061 6464 6974 696f 6e61  o that additiona
-0000b8f0: 6c20 6f72 6465 7269 6e67 2061 6e61 6c79  l ordering analy
-0000b900: 7369 7320 646f 6573 6e27 7420 6e65 6564  sis doesn't need
-0000b910: 2074 6f20 636f 6e73 6964 6572 2061 6c6c   to consider all
-0000b920: 2073 796d 626f 6c73 0a20 2020 2020 2020   symbols.       
-0000b930: 2072 6f6f 7473 2c20 6c65 6176 6573 203d   roots, leaves =
-0000b940: 2062 7379 6d5f 6c69 7374 5f74 6f5f 6461   bsym_list_to_da
-0000b950: 6728 6772 6164 7472 632e 626f 756e 645f  g(gradtrc.bound_
-0000b960: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
-0000b970: 206f 7264 6572 6564 5f62 7379 6d73 203d   ordered_bsyms =
-0000b980: 2074 6f70 6f73 6f72 745f 6273 796d 5f64   toposort_bsym_d
-0000b990: 6167 2872 6f6f 7473 2c20 544f 504f 534f  ag(roots, TOPOSO
-0000b9a0: 5254 5f4f 5244 4552 2e54 4f50 5f44 4f57  RT_ORDER.TOP_DOW
-0000b9b0: 4e29 0a20 2020 2020 2020 2067 7261 6474  N).        gradt
-0000b9c0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000b9d0: 203d 206f 7264 6572 6564 5f62 7379 6d73   = ordered_bsyms
-0000b9e0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000b9f0: 203d 2064 6365 2867 7261 6474 7263 290a   = dce(gradtrc).
-0000ba00: 0a20 2020 2020 2020 2023 2049 6465 6e74  .        # Ident
-0000ba10: 6966 6965 7320 7468 6520 6f72 6465 7220  ifies the order 
-0000ba20: 6f66 2042 6f75 6e64 5379 6d62 6f6c 7320  of BoundSymbols 
-0000ba30: 7573 696e 6720 6120 2244 4653 2061 6e64  using a "DFS and
-0000ba40: 2063 6861 696e 2220 616c 676f 7269 7468   chain" algorith
-0000ba50: 6d0a 2020 2020 2020 2020 2320 544f 444f  m.        # TODO
-0000ba60: 2045 6c61 626f 7261 7465 206f 6e20 7468   Elaborate on th
-0000ba70: 6973 2061 6c67 6f72 6974 686d 2061 6e64  is algorithm and
-0000ba80: 2074 6865 2069 6d70 6c65 6d65 6e74 6174   the implementat
-0000ba90: 696f 6e0a 2020 2020 2020 2020 726f 6f74  ion.        root
-0000baa0: 732c 206c 6561 7665 7320 3d20 6273 796d  s, leaves = bsym
-0000bab0: 5f6c 6973 745f 746f 5f64 6167 2867 7261  _list_to_dag(gra
-0000bac0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000bad0: 6c73 290a 2020 2020 2020 2020 6368 6563  ls).        chec
-0000bae0: 6b28 0a20 2020 2020 2020 2020 2020 206c  k(.            l
-0000baf0: 656e 286c 6561 7665 7329 203d 3d20 312c  en(leaves) == 1,
-0000bb00: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
-0000bb10: 6264 613a 2066 2245 7870 6563 7465 6420  bda: f"Expected 
-0000bb20: 6f6e 6c79 206f 6e65 206c 6561 6620 6e6f  only one leaf no
-0000bb30: 6465 2077 6865 6e20 736f 7274 696e 6720  de when sorting 
-0000bb40: 666f 7220 6772 6164 2c20 666f 756e 6420  for grad, found 
-0000bb50: 7468 6572 6520 7765 7265 207b 6c65 6e28  there were {len(
-0000bb60: 6c65 6176 6573 297d 206c 6561 7665 7322  leaves)} leaves"
-0000bb70: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0000bb80: 2020 2020 286c 6561 662c 2920 3d20 6c65      (leaf,) = le
-0000bb90: 6176 6573 0a0a 2020 2020 2020 2020 2320  aves..        # 
-0000bba0: 436f 6d70 7574 6573 2074 6865 2074 656e  Computes the ten
-0000bbb0: 736f 7220 6d65 6d6f 7279 2075 7365 6420  sor memory used 
-0000bbc0: 6279 2074 6865 2067 6976 656e 2070 7974  by the given pyt
-0000bbd0: 7265 650a 2020 2020 2020 2020 6465 6620  ree.        def 
-0000bbe0: 6d65 6d6f 7279 5f75 7365 6428 7079 7472  memory_used(pytr
-0000bbf0: 6565 2920 2d3e 2069 6e74 3a0a 2020 2020  ee) -> int:.    
-0000bc00: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
-0000bc10: 7365 3a20 696e 7420 3d20 300a 0a20 2020  se: int = 0..   
-0000bc20: 2020 2020 2020 2020 2064 6566 2063 6f75           def cou
-0000bc30: 6e74 5f6d 656d 6f72 795f 7573 6528 7829  nt_memory_use(x)
-0000bc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bc50: 2020 6e6f 6e6c 6f63 616c 206d 656d 6f72    nonlocal memor
-0000bc60: 795f 7573 650a 2020 2020 2020 2020 2020  y_use.          
-0000bc70: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000bc80: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-0000bc90: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-0000bca0: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-0000bcb0: 7573 6520 2b3d 2078 2e64 7479 7065 2e5f  use += x.dtype._
-0000bcc0: 6279 7465 7320 2a20 782e 6e75 6d65 6c0a  bytes * x.numel.
-0000bcd0: 0a20 2020 2020 2020 2020 2020 2074 7265  .            tre
-0000bce0: 655f 6d61 7028 636f 756e 745f 6d65 6d6f  e_map(count_memo
-0000bcf0: 7279 5f75 7365 2c20 7079 7472 6565 290a  ry_use, pytree).
-0000bd00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000bd10: 726e 206d 656d 6f72 795f 7573 650a 0a20  rn memory_use.. 
-0000bd20: 2020 2020 2020 2023 2054 7275 6520 7768         # True wh
-0000bd30: 656e 2061 206e 6f64 6520 6973 2061 2022  en a node is a "
-0000bd40: 6c69 6e6b 2220 2d2d 2061 206e 6f64 6520  link" -- a node 
-0000bd50: 7769 7468 206f 6e6c 7920 6f6e 6520 6368  with only one ch
-0000bd60: 696c 6420 616e 6420 6174 206d 6f73 7420  ild and at most 
-0000bd70: 6f6e 6520 7061 7265 6e74 0a20 2020 2020  one parent.     
-0000bd80: 2020 2023 2020 2043 6f6e 6365 7074 7561     #   Conceptua
-0000bd90: 6c6c 7920 7468 6520 6e6f 6465 2069 7320  lly the node is 
-0000bda0: 6120 226c 696e 6b22 2069 6e20 6120 6368  a "link" in a ch
-0000bdb0: 6169 6e20 6f66 206e 6f64 6573 206c 696b  ain of nodes lik
-0000bdc0: 6520 4120 2d3e 2042 202d 3e20 430a 2020  e A -> B -> C.  
-0000bdd0: 2020 2020 2020 6465 6620 6973 5f6c 696e        def is_lin
-0000bde0: 6b28 6e3a 204e 6f64 6529 202d 3e20 626f  k(n: Node) -> bo
-0000bdf0: 6f6c 3a0a 2020 2020 2020 2020 2020 2020  ol:.            
-0000be00: 5f69 735f 6c69 6e6b 203d 206c 656e 286e  _is_link = len(n
-0000be10: 2e63 6869 6c64 7265 6e29 203d 3d20 3120  .children) == 1 
-0000be20: 616e 6420 6c65 6e28 6e2e 7061 7265 6e74  and len(n.parent
-0000be30: 7329 203c 3d20 310a 2020 2020 2020 2020  s) <= 1.        
-0000be40: 2020 2020 7265 7475 726e 205f 6973 5f6c      return _is_l
-0000be50: 696e 6b0a 0a20 2020 2020 2020 2063 6f75  ink..        cou
-0000be60: 6e74 6572 3a20 696e 7420 3d20 300a 0a20  nter: int = 0.. 
-0000be70: 2020 2020 2020 2064 6566 205f 6368 6169         def _chai
-0000be80: 6e28 633a 206c 6973 745b 4e6f 6465 5d2c  n(c: list[Node],
-0000be90: 2065 6e64 3a20 4e6f 6465 2920 2d3e 206c   end: Node) -> l
-0000bea0: 6973 745b 4e6f 6465 5d3a 0a20 2020 2020  ist[Node]:.     
-0000beb0: 2020 2020 2020 206e 6f6e 6c6f 6361 6c20         nonlocal 
-0000bec0: 636f 756e 7465 720a 0a20 2020 2020 2020  counter..       
-0000bed0: 2020 2020 2023 2054 4f44 4f20 4578 7065       # TODO Expe
-0000bee0: 7269 6d65 6e74 2077 6974 6820 6e6f 7420  riment with not 
-0000bef0: 616c 7761 7973 2066 7573 696e 6720 7468  always fusing th
-0000bf00: 6973 2069 6e74 6f20 7468 6520 636f 6e73  is into the cons
-0000bf10: 756d 6572 202d 2d20 7468 6572 6520 636f  umer -- there co
-0000bf20: 756c 6420 6265 2061 6e0a 2020 2020 2020  uld be an.      
-0000bf30: 2020 2020 2020 2320 2020 696e 7465 7265        #   intere
-0000bf40: 7374 696e 6720 6d69 6e63 7574 0a20 2020  sting mincut.   
-0000bf50: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-0000bf60: 496e 2074 6869 7320 6361 7365 2074 6865  In this case the
-0000bf70: 2063 6861 696e 2063 616e 6e6f 7420 6265   chain cannot be
-0000bf80: 2065 7874 656e 6465 642c 2061 6e64 2069   extended, and i
-0000bf90: 7473 206f 7269 6769 6e20 6973 2069 6e70  ts origin is inp
-0000bfa0: 7574 2074 6f20 7468 6520 6675 6e63 7469  ut to the functi
-0000bfb0: 6f6e 0a20 2020 2020 2020 2020 2020 2023  on.            #
-0000bfc0: 2020 2073 6f20 7468 6973 206a 7573 7420     so this just 
-0000bfd0: 6675 7365 7320 6974 2069 6e74 6f20 7468  fuses it into th
-0000bfe0: 6520 636f 6e73 756d 6572 0a20 2020 2020  e consumer.     
-0000bff0: 2020 2020 2020 2069 6620 6c65 6e28 656e         if len(en
-0000c000: 642e 7061 7265 6e74 7329 203d 3d20 303a  d.parents) == 0:
-0000c010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c020: 2066 6f72 206e 2069 6e20 633a 0a20 2020   for n in c:.   
-0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c040: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
-0000c050: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-0000c060: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
-0000c070: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
-0000c080: 2020 2020 2072 6574 7572 6e20 5b5d 0a0a       return []..
-0000c090: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-0000c0a0: 5445 206c 656e 2865 6e64 2e70 6172 656e  TE len(end.paren
-0000c0b0: 7473 2920 3d3d 2031 206f 6e20 7468 6973  ts) == 1 on this
-0000c0c0: 2070 6174 680a 2020 2020 2020 2020 2020   path.          
-0000c0d0: 2020 2870 6172 656e 742c 2920 3d20 656e    (parent,) = en
-0000c0e0: 642e 7061 7265 6e74 730a 0a20 2020 2020  d.parents..     
-0000c0f0: 2020 2020 2020 2023 2045 7874 656e 6473         # Extends
-0000c100: 2074 6865 2063 6861 696e 2069 6620 7468   the chain if th
-0000c110: 6520 7061 7265 6e74 2069 7320 6120 6c69  e parent is a li
-0000c120: 6e6b 0a20 2020 2020 2020 2020 2020 2069  nk.            i
-0000c130: 6620 6973 5f6c 696e 6b28 7061 7265 6e74  f is_link(parent
-0000c140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c150: 2020 2063 2e61 7070 656e 6428 7061 7265     c.append(pare
-0000c160: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-0000c170: 2020 2020 7265 7475 726e 205f 6368 6169      return _chai
-0000c180: 6e28 632c 2070 6172 656e 7429 0a0a 2020  n(c, parent)..  
-0000c190: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-0000c1a0: 2049 6e20 7468 6973 2063 6173 6520 7468   In this case th
-0000c1b0: 6520 6368 6169 6e20 6861 7320 6120 7061  e chain has a pa
-0000c1c0: 7265 6e74 2074 6861 7420 6973 206e 6f74  rent that is not
-0000c1d0: 2061 206c 696e 6b0a 2020 2020 2020 2020   a link.        
-0000c1e0: 2020 2020 2320 4669 6e64 7320 7468 6520      # Finds the 
-0000c1f0: 6d69 6e63 7574 0a20 2020 2020 2020 2020  mincut.         
-0000c200: 2020 206d 696e 6375 745f 6964 783a 2069     mincut_idx: i
-0000c210: 6e74 203d 206c 656e 2863 290a 2020 2020  nt = len(c).    
-0000c220: 2020 2020 2020 2020 6d69 6e5f 6d65 6d6f          min_memo
-0000c230: 7279 5f75 7361 6765 3a20 696e 7420 3d20  ry_usage: int = 
-0000c240: 6d65 6d6f 7279 5f75 7365 6428 7061 7265  memory_used(pare
-0000c250: 6e74 2e62 7379 6d2e 6f75 7470 7574 290a  nt.bsym.output).
-0000c260: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000c270: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
-0000c280: 7261 7465 2863 293a 0a20 2020 2020 2020  rate(c):.       
-0000c290: 2020 2020 2020 2020 206d 656d 203d 206d           mem = m
-0000c2a0: 656d 6f72 795f 7573 6564 286e 2e62 7379  emory_used(n.bsy
-0000c2b0: 6d2e 6f75 7470 7574 290a 2020 2020 2020  m.output).      
-0000c2c0: 2020 2020 2020 2020 2020 6966 206d 656d            if mem
-0000c2d0: 203c 206d 696e 5f6d 656d 6f72 795f 7573   < min_memory_us
-0000c2e0: 6167 653a 0a20 2020 2020 2020 2020 2020  age:.           
-0000c2f0: 2020 2020 2020 2020 206d 696e 6375 745f           mincut_
-0000c300: 6964 7820 3d20 6964 780a 2020 2020 2020  idx = idx.      
-0000c310: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0000c320: 6e5f 6d65 6d6f 7279 5f75 7361 6765 203d  n_memory_usage =
-0000c330: 206d 656d 0a0a 2020 2020 2020 2020 2020   mem..          
-0000c340: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
-0000c350: 656e 756d 6572 6174 6528 6329 3a0a 2020  enumerate(c):.  
-0000c360: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000c370: 2069 6478 203c 206d 696e 6375 745f 6964   idx < mincut_id
-0000c380: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-0000c390: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
-0000c3a0: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
-0000c3b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000c3c0: 756e 7465 7220 2b3d 2031 0a0a 2020 2020  unter += 1..    
-0000c3d0: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
-0000c3e0: 7320 7468 6520 7072 6f64 7563 6572 2d73  s the producer-s
-0000c3f0: 6964 6520 6368 6169 6e20 6375 7420 6966  ide chain cut if
-0000c400: 2069 7420 6578 6973 7473 0a20 2020 2020   it exists.     
-0000c410: 2020 2020 2020 2069 6620 6d69 6e63 7574         if mincut
-0000c420: 5f69 6478 203c 206c 656e 2863 293a 0a20  _idx < len(c):. 
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c440: 6574 7572 6e20 5b63 5b6d 696e 6375 745f  eturn [c[mincut_
-0000c450: 6964 785d 5d0a 2020 2020 2020 2020 2020  idx]].          
-0000c460: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000c470: 2020 2020 2020 2020 6173 7365 7274 206d          assert m
-0000c480: 696e 6375 745f 6964 7820 3d3d 206c 656e  incut_idx == len
-0000c490: 2863 290a 2020 2020 2020 2020 2020 2020  (c).            
-0000c4a0: 2020 2020 7265 7475 726e 2065 6e64 2e70      return end.p
-0000c4b0: 6172 656e 7473 0a0a 2020 2020 2020 2020  arents..        
-0000c4c0: 6465 6620 6368 6169 6e5f 6f75 7428 6e3a  def chain_out(n:
-0000c4d0: 204e 6f64 652c 2073 7461 636b 3a20 6c69   Node, stack: li
-0000c4e0: 7374 5b4e 6f64 655d 2920 2d3e 204e 6f6e  st[Node]) -> Non
-0000c4f0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0000c500: 2053 686f 7274 2d63 6972 6375 6974 7320   Short-circuits 
-0000c510: 6966 2074 6865 206f 7269 6769 6e61 6c20  if the original 
-0000c520: 6e6f 6465 206e 2063 616e 6e6f 7420 6265  node n cannot be
-0000c530: 2070 6172 7420 6f66 2061 2063 6861 696e   part of a chain
-0000c540: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c550: 6e6f 7420 6973 5f6c 696e 6b28 6e29 3a0a  not is_link(n):.
-0000c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c570: 7374 6163 6b2e 6170 7065 6e64 286e 290a  stack.append(n).
-0000c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c590: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-0000c5a0: 2020 2020 2320 4e4f 5445 2069 735f 6c69      # NOTE is_li
-0000c5b0: 6e6b 286e 2920 3d3d 2054 7275 650a 2020  nk(n) == True.  
-0000c5c0: 2020 2020 2020 2020 2020 706f 7374 5f63            post_c
-0000c5d0: 6861 696e 3a20 6c69 7374 5b4e 6f64 655d  hain: list[Node]
-0000c5e0: 203d 205f 6368 6169 6e28 5b6e 5d2c 206e   = _chain([n], n
-0000c5f0: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
-0000c600: 6f72 2070 6320 696e 2070 6f73 745f 6368  or pc in post_ch
-0000c610: 6169 6e3a 0a20 2020 2020 2020 2020 2020  ain:.           
-0000c620: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
-0000c630: 6428 7063 290a 0a20 2020 2020 2020 2073  d(pc)..        s
-0000c640: 7461 636b 3a20 6c69 7374 5b4e 6f64 655d  tack: list[Node]
-0000c650: 203d 205b 6c65 6166 5d0a 2020 2020 2020   = [leaf].      
-0000c660: 2020 7768 696c 6520 6c65 6e28 7374 6163    while len(stac
-0000c670: 6b29 203e 2030 3a0a 2020 2020 2020 2020  k) > 0:.        
-0000c680: 2020 2020 6e3a 204e 6f64 6520 3d20 7374      n: Node = st
-0000c690: 6163 6b2e 706f 7028 290a 0a20 2020 2020  ack.pop()..     
-0000c6a0: 2020 2020 2020 2069 6620 6e2e 6e75 6d62         if n.numb
-0000c6b0: 6572 2069 7320 6e6f 7420 4e6f 6e65 3a0a  er is not None:.
-0000c6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c6d0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0000c6e0: 2020 2020 2020 6e2e 6e75 6d62 6572 203d        n.number =
-0000c6f0: 2063 6f75 6e74 6572 0a20 2020 2020 2020   counter.       
-0000c700: 2020 2020 2063 6f75 6e74 6572 202b 3d20       counter += 
-0000c710: 310a 0a20 2020 2020 2020 2020 2020 2066  1..            f
-0000c720: 6f72 2070 2069 6e20 6e2e 7061 7265 6e74  or p in n.parent
-0000c730: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000c740: 2020 2063 6861 696e 5f6f 7574 2870 2c20     chain_out(p, 
-0000c750: 7374 6163 6b29 0a0a 2020 2020 2020 2020  stack)..        
-0000c760: 6465 6620 5f73 656c 6563 746f 7228 656c  def _selector(el
-0000c770: 6967 6962 6c65 5f6e 6f64 6573 3a20 6c69  igible_nodes: li
-0000c780: 7374 5b4e 6f64 655d 2920 2d3e 2069 6e74  st[Node]) -> int
-0000c790: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
-0000c7a0: 6e5f 6964 783a 2069 6e74 203d 2030 0a20  n_idx: int = 0. 
-0000c7b0: 2020 2020 2020 2020 2020 206d 696e 5f6e             min_n
-0000c7c0: 756d 6265 723a 2069 6e74 203d 2065 6c69  umber: int = eli
-0000c7d0: 6769 626c 655f 6e6f 6465 735b 305d 2e6e  gible_nodes[0].n
-0000c7e0: 756d 6265 720a 0a20 2020 2020 2020 2020  umber..         
-0000c7f0: 2020 2023 204e 4f54 4520 416c 7468 6f75     # NOTE Althou
-0000c800: 6768 2077 6527 7665 2061 6c72 6561 6479  gh we've already
-0000c810: 2070 726f 6365 7373 6564 2074 6865 2066   processed the f
-0000c820: 6972 7374 2065 6c65 6d65 6e74 2068 6572  irst element her
-0000c830: 652c 2074 6869 7320 7374 696c 6c0a 2020  e, this still.  
-0000c840: 2020 2020 2020 2020 2020 2320 2020 656e            #   en
-0000c850: 756d 6572 6174 6573 2074 6865 2065 6e74  umerates the ent
-0000c860: 6972 6520 6c69 7374 2063 2074 6f20 616c  ire list c to al
-0000c870: 6967 6e20 7468 6520 656e 756d 6572 6174  ign the enumerat
-0000c880: 696f 6e20 6964 7820 7072 6f70 6572 6c79  ion idx properly
-0000c890: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000c8a0: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
-0000c8b0: 7261 7465 2865 6c69 6769 626c 655f 6e6f  rate(eligible_no
-0000c8c0: 6465 7329 3a0a 2020 2020 2020 2020 2020  des):.          
-0000c8d0: 2020 2020 2020 6368 6563 6b28 6e2e 6e75        check(n.nu
-0000c8e0: 6d62 6572 2069 7320 6e6f 7420 4e6f 6e65  mber is not None
-0000c8f0: 2c20 6c61 6d62 6461 3a20 6622 4578 7065  , lambda: f"Expe
-0000c900: 6374 6564 2065 6163 6820 6e6f 6465 2074  cted each node t
-0000c910: 6f20 6265 206e 756d 6265 7265 642c 2062  o be numbered, b
-0000c920: 7574 207b 6e7d 2077 6173 206e 6f74 2229  ut {n} was not")
-0000c930: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000c940: 2020 6966 206e 2e6e 756d 6265 7220 3c20    if n.number < 
-0000c950: 6d69 6e5f 6e75 6d62 6572 3a0a 2020 2020  min_number:.    
-0000c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c970: 6d69 6e5f 6964 7820 3d20 6964 780a 2020  min_idx = idx.  
-0000c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c990: 2020 6d69 6e5f 6e75 6d62 6572 203d 206e    min_number = n
-0000c9a0: 2e6e 756d 6265 720a 0a20 2020 2020 2020  .number..       
-0000c9b0: 2020 2020 2072 6574 7572 6e20 6d69 6e5f       return min_
-0000c9c0: 6964 780a 0a20 2020 2020 2020 2073 6f72  idx..        sor
-0000c9d0: 7465 645f 6273 796d 7320 3d20 746f 706f  ted_bsyms = topo
-0000c9e0: 736f 7274 5f62 7379 6d5f 6461 6728 6c65  sort_bsym_dag(le
-0000c9f0: 6176 6573 2c20 746f 706f 736f 7274 5f6f  aves, toposort_o
-0000ca00: 7264 6572 3d54 4f50 4f53 4f52 545f 4f52  rder=TOPOSORT_OR
-0000ca10: 4445 522e 424f 5454 4f4d 5f55 502c 2073  DER.BOTTOM_UP, s
-0000ca20: 656c 6563 746f 723d 5f73 656c 6563 746f  elector=_selecto
-0000ca30: 7229 0a20 2020 2020 2020 2067 7261 6474  r).        gradt
-0000ca40: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000ca50: 203d 2073 6f72 7465 645f 6273 796d 730a   = sorted_bsyms.
-0000ca60: 2020 2020 2020 2020 6772 6164 7472 6320          gradtrc 
-0000ca70: 3d20 6463 6528 6772 6164 7472 6329 0a0a  = dce(gradtrc)..
-0000ca80: 2020 2020 2020 2020 2320 544f 444f 2043          # TODO C
-0000ca90: 6f6e 7369 6465 7220 686f 7720 746f 2068  onsider how to h
-0000caa0: 616e 646c 6520 6772 6164 2077 2e72 2e74  andle grad w.r.t
-0000cab0: 2e20 6f6e 6c79 2073 6f6d 6520 6f75 7470  . only some outp
-0000cac0: 7574 7320 2d2d 2073 686f 756c 6420 616c  uts -- should al
-0000cad0: 6c20 6772 6164 0a20 2020 2020 2020 2023  l grad.        #
-0000cae0: 2020 206f 7065 7261 7469 6f6e 7320 7573     operations us
-0000caf0: 696e 6720 7468 6520 6f74 6865 7220 6f75  ing the other ou
-0000cb00: 7470 7574 2062 6520 7265 6d6f 7665 643f  tput be removed?
-0000cb10: 2057 6861 7420 6b69 6e64 206f 6620 6173   What kind of as
-0000cb20: 7375 6d70 7469 6f6e 2064 6f65 7320 7468  sumption does th
-0000cb30: 6174 0a20 2020 2020 2020 2023 2020 206d  at.        #   m
-0000cb40: 616b 6520 6162 6f75 7420 7468 6520 6772  ake about the gr
-0000cb50: 6164 2073 7472 7563 7475 7265 3f20 5072  ad structure? Pr
-0000cb60: 6f62 6162 6c79 2073 6f6d 6520 6b69 6e64  obably some kind
-0000cb70: 206f 6620 696e 6465 7065 6e64 656e 6365   of independence
-0000cb80: 2061 7373 756d 7074 696f 6e3f 2041 7265   assumption? Are
-0000cb90: 0a20 2020 2020 2020 2023 2020 2074 6865  .        #   the
-0000cba0: 7265 2070 7261 6374 6963 616c 2065 7861  re practical exa
-0000cbb0: 6d70 6c65 7320 7768 6572 6520 7468 6174  mples where that
-0000cbc0: 2773 2061 6e20 6973 7375 653f 0a0a 2020  's an issue?..  
-0000cbd0: 2020 2020 2020 656e 645f 7469 6d65 5f6e        end_time_n
-0000cbe0: 7320 3d20 7469 6d65 2e74 696d 655f 6e73  s = time.time_ns
-0000cbf0: 2829 0a20 2020 2020 2020 2065 6c61 7073  ().        elaps
-0000cc00: 6564 5f74 696d 655f 6e73 203d 2065 6e64  ed_time_ns = end
-0000cc10: 5f74 696d 655f 6e73 202d 2073 7461 7274  _time_ns - start
-0000cc20: 5f74 696d 655f 6e73 0a20 2020 2020 2020  _time_ns.       
-0000cc30: 2065 6c61 7073 6564 5f74 696d 655f 6d69   elapsed_time_mi
-0000cc40: 6c6c 6973 203d 2065 6c61 7073 6564 5f74  llis = elapsed_t
-0000cc50: 696d 655f 6e73 202f 2f20 3130 3030 3030  ime_ns // 100000
-0000cc60: 300a 2020 2020 2020 2020 6772 6164 7472  0.        gradtr
-0000cc70: 632e 7365 745f 7072 6f76 656e 616e 6365  c.set_provenance
-0000cc80: 2854 7261 6365 5072 6f76 656e 616e 6365  (TraceProvenance
-0000cc90: 2866 2247 7261 6420 2874 6f6f 6b20 7b65  (f"Grad (took {e
-0000cca0: 6c61 7073 6564 5f74 696d 655f 6d69 6c6c  lapsed_time_mill
-0000ccb0: 6973 7d20 6d69 6c6c 6973 6563 6f6e 6473  is} milliseconds
-0000ccc0: 2922 2929 0a0a 2020 2020 2020 2020 7265  )"))..        re
-0000ccd0: 7475 726e 2067 7261 6474 7263 0a0a 2020  turn gradtrc..  
-0000cce0: 2020 2320 4e4f 5445 2054 6869 7320 6973    # NOTE This is
-0000ccf0: 2061 206b 6c75 6467 6520 746f 2069 6e64   a kludge to ind
-0000cd00: 6963 6174 6520 7468 6174 2077 6520 7368  icate that we sh
-0000cd10: 6f75 6c64 6e27 7420 7573 6520 5079 546f  ouldn't use PyTo
-0000cd20: 7263 6827 7320 6175 746f 6772 6164 2062  rch's autograd b
-0000cd30: 6563 6175 7365 0a20 2020 2023 2020 2077  ecause.    #   w
-0000cd40: 6527 7265 2075 7369 6e67 206f 7572 206f  e're using our o
-0000cd50: 776e 2061 7574 6f67 7261 6420 7472 616e  wn autograd tran
-0000cd60: 7366 6f72 6d0a 2020 2020 6366 6e2e 5f75  sform.    cfn._u
-0000cd70: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
-0000cd80: 6f72 6d20 3d20 5472 7565 0a0a 2020 2020  orm = True..    
-0000cd90: 7265 7475 726e 2061 6464 5f74 7261 6e73  return add_trans
-0000cda0: 666f 726d 2863 666e 2c20 5f67 7261 645f  form(cfn, _grad_
-0000cdb0: 7472 616e 7366 6f72 6d29 0a0a 0a64 6566  transform)...def
-0000cdc0: 2067 7261 645f 7631 280a 2020 2020 6366   grad_v1(.    cf
-0000cdd0: 6e2c 0a29 202d 3e20 4361 6c6c 6162 6c65  n,.) -> Callable
-0000cde0: 3a0a 2020 2020 6465 6620 6772 6164 2866  :.    def grad(f
-0000cdf0: 756e 6329 3a0a 2020 2020 2020 2020 6465  unc):.        de
-0000ce00: 6620 6772 6164 5f66 756e 6328 2a61 7267  f grad_func(*arg
-0000ce10: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0000ce20: 2020 2020 2020 2020 2020 5f2c 2067 7261            _, gra
-0000ce30: 6473 203d 2076 616c 7565 5f61 6e64 5f67  ds = value_and_g
-0000ce40: 7261 6428 6675 6e63 2928 2a61 7267 732c  rad(func)(*args,
-0000ce50: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-0000ce60: 2020 2020 2020 2067 7261 6473 203d 205b         grads = [
-0000ce70: 6720 666f 7220 6720 696e 2067 7261 6473  g for g in grads
-0000ce80: 2069 6620 6720 6973 206e 6f74 204e 6f6e   if g is not Non
-0000ce90: 655d 0a20 2020 2020 2020 2020 2020 2072  e].            r
-0000cea0: 6574 7572 6e20 6772 6164 730a 0a20 2020  eturn grads..   
-0000ceb0: 2020 2020 2072 6574 7572 6e20 6772 6164       return grad
-0000cec0: 5f66 756e 630a 0a20 2020 2064 6566 205f  _func..    def _
-0000ced0: 6772 6164 5f74 7261 6e73 666f 726d 2874  grad_transform(t
-0000cee0: 7263 3a20 5472 6163 652c 202a 2c20 6578  rc: Trace, *, ex
-0000cef0: 6563 7574 6f72 735f 6c69 7374 3a20 5365  ecutors_list: Se
-0000cf00: 7175 656e 6365 5b41 6e79 5d29 202d 3e20  quence[Any]) -> 
-0000cf10: 5472 6163 653a 0a20 2020 2020 2020 2067  Trace:.        g
-0000cf20: 7261 6474 7263 203d 2063 6f6e 7374 7275  radtrc = constru
-0000cf30: 6374 5f74 7261 6365 2829 2867 7261 6428  ct_trace()(grad(
-0000cf40: 7472 632e 7079 7468 6f6e 5f63 616c 6c61  trc.python_calla
-0000cf50: 626c 6528 2929 2c20 2a74 7263 2e61 7267  ble()), *trc.arg
-0000cf60: 732c 202a 2a74 7263 2e6b 7761 7267 7329  s, **trc.kwargs)
-0000cf70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000cf80: 6772 6164 7472 630a 0a20 2020 2063 666e  gradtrc..    cfn
-0000cf90: 2e5f 7573 696e 675f 6772 6164 5f74 7261  ._using_grad_tra
-0000cfa0: 6e73 666f 726d 203d 2054 7275 650a 2020  nsform = True.  
-0000cfb0: 2020 7265 7475 726e 2061 6464 5f74 7261    return add_tra
-0000cfc0: 6e73 666f 726d 2863 666e 2c20 5f67 7261  nsform(cfn, _gra
-0000cfd0: 645f 7472 616e 7366 6f72 6d29 0a0a 0a63  d_transform)...c
-0000cfe0: 6c61 7373 2054 7261 6e73 666f 726d 7328  lass Transforms(
-0000cff0: 456e 756d 293a 0a20 2020 2049 6465 6e74  Enum):.    Ident
-0000d000: 6974 794f 7020 3d20 6175 746f 2829 0a20  ityOp = auto(). 
-0000d010: 2020 2056 6d61 704f 7020 3d20 6175 746f     VmapOp = auto
-0000d020: 2829 0a20 2020 204a 7670 4f70 203d 2061  ().    JvpOp = a
-0000d030: 7574 6f28 290a 2020 2020 566a 704f 7020  uto().    VjpOp 
-0000d040: 3d20 6175 746f 2829 0a0a 0a40 6c72 755f  = auto()...@lru_
-0000d050: 6361 6368 6528 6d61 7873 697a 653d 4e6f  cache(maxsize=No
-0000d060: 6e65 290a 6465 6620 7379 6d62 6f6c 5f74  ne).def symbol_t
-0000d070: 6f5f 6576 616c 2862 6f75 6e64 5f73 796d  o_eval(bound_sym
-0000d080: 626f 6c29 3a0a 2020 2020 2222 224d 6170  bol):.    """Map
-0000d090: 2061 2042 6f75 6e64 5379 6d62 6f6c 2074   a BoundSymbol t
-0000d0a0: 6f20 6120 6675 6e63 7469 6f6e 2074 6861  o a function tha
-0000d0b0: 7420 6576 616c 7561 7465 7320 6974 2e0a  t evaluates it..
-0000d0c0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000d0d0: 2020 2062 6f75 6e64 5f73 796d 626f 6c3a     bound_symbol:
-0000d0e0: 2042 6f75 6e64 5379 6d62 6f6c 2074 6f20   BoundSymbol to 
-0000d0f0: 6d61 700a 2020 2020 2222 220a 2020 2020  map.    """.    
-0000d100: 2320 5379 6d62 6f6c 2069 7320 6361 6c6c  # Symbol is call
-0000d110: 6162 6c65 0a20 2020 2072 6574 7572 6e20  able.    return 
-0000d120: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
-0000d130: 0a0a 0a23 2054 4f44 4f3a 2043 7572 7265  ...# TODO: Curre
-0000d140: 6e74 6c79 2077 6520 7573 6520 7472 6163  ntly we use trac
-0000d150: 652e 6172 6773 2061 6e64 2074 7261 6365  e.args and trace
-0000d160: 2e6b 7761 7267 7320 746f 2067 6574 2074  .kwargs to get t
-0000d170: 6865 2061 7267 756d 656e 7473 0a23 204d  he arguments.# M
-0000d180: 6179 6265 2077 6520 7368 6f75 6c64 2075  aybe we should u
-0000d190: 7365 2074 6865 7365 2069 6e73 7465 6164  se these instead
-0000d1a0: 0a74 7261 6e73 666f 726d 5f73 6b69 705f  .transform_skip_
-0000d1b0: 6c69 7374 203d 2028 0a20 2020 2070 7269  list = (.    pri
-0000d1c0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-0000d1d0: 4b5f 454d 5054 595f 4449 4354 2c0a 2020  K_EMPTY_DICT,.  
-0000d1e0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-0000d1f0: 554e 5041 434b 5f4b 4559 2c0a 2020 2020  UNPACK_KEY,.    
-0000d200: 7072 696d 732e 5072 696d 4944 732e 554e  prims.PrimIDs.UN
-0000d210: 5041 434b 5f53 4551 5545 4e43 452c 0a20  PACK_SEQUENCE,. 
-0000d220: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-0000d230: 2e55 4e50 4143 4b5f 5452 4956 4941 4c2c  .UNPACK_TRIVIAL,
-0000d240: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-0000d250: 4473 2e52 4554 5552 4e2c 0a29 0a0a 0a64  Ds.RETURN,.)...d
-0000d260: 6566 2065 7661 6c5f 7472 6163 6528 7472  ef eval_trace(tr
-0000d270: 6163 652c 202a 6172 6773 2c20 7379 6d62  ace, *args, symb
-0000d280: 6f6c 5f6d 6170 7065 723d 7379 6d62 6f6c  ol_mapper=symbol
-0000d290: 5f74 6f5f 6576 616c 2c20 7769 7468 5f65  _to_eval, with_e
-0000d2a0: 6e76 3d46 616c 7365 2c20 2a2a 6b77 6172  nv=False, **kwar
-0000d2b0: 6773 293a 0a20 2020 2022 2222 4576 616c  gs):.    """Eval
-0000d2c0: 7561 7465 2061 2074 7261 6365 2e0a 0a20  uate a trace... 
-0000d2d0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000d2e0: 2074 7261 6365 3a20 7472 6163 6520 746f   trace: trace to
-0000d2f0: 2065 7661 6c75 6174 650a 2020 2020 2020   evaluate.      
-0000d300: 2020 2a61 7267 733a 2061 7267 756d 656e    *args: argumen
-0000d310: 7473 2074 6f20 6576 616c 7561 7465 2074  ts to evaluate t
-0000d320: 6865 2074 7261 6365 2077 6974 680a 2020  he trace with.  
-0000d330: 2020 2020 2020 7379 6d62 6f6c 5f6d 6170        symbol_map
-0000d340: 7065 723a 2066 756e 6374 696f 6e20 7468  per: function th
-0000d350: 6174 206d 6170 7320 6120 7379 6d62 6f6c  at maps a symbol
-0000d360: 2074 6f20 6120 6675 6e63 7469 6f6e 2074   to a function t
-0000d370: 6861 7420 6576 616c 7561 7465 7320 6974  hat evaluates it
-0000d380: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-0000d390: 733a 206b 6579 776f 7264 2061 7267 756d  s: keyword argum
-0000d3a0: 656e 7473 2074 6f20 6576 616c 7561 7465  ents to evaluate
-0000d3b0: 2074 6865 2074 7261 6365 2077 6974 680a   the trace with.
-0000d3c0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0000d3d0: 2020 2020 2020 7265 7375 6c74 206f 6620        result of 
-0000d3e0: 6576 616c 7561 7469 6e67 2074 6865 2074  evaluating the t
-0000d3f0: 7261 6365 0a20 2020 2022 2222 0a20 2020  race.    """.   
-0000d400: 2065 6e76 203d 207b 7d0a 0a20 2020 2064   env = {}..    d
-0000d410: 6566 2072 6561 6428 783a 2056 6172 6961  ef read(x: Varia
-0000d420: 626c 6529 3a0a 2020 2020 2020 2020 6966  ble):.        if
-0000d430: 2069 7369 6e73 7461 6e63 6528 782c 2056   isinstance(x, V
-0000d440: 6172 6961 626c 6529 3a0a 2020 2020 2020  ariable):.      
-0000d450: 2020 2020 2020 7265 7475 726e 2065 6e76        return env
-0000d460: 5b78 2e6e 616d 655d 0a20 2020 2020 2020  [x.name].       
-0000d470: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000d480: 2020 2072 6574 7572 6e20 780a 0a20 2020     return x..   
-0000d490: 2064 6566 2077 7269 7465 2876 3a20 5661   def write(v: Va
-0000d4a0: 7269 6162 6c65 2c20 7661 6c3a 2041 6e79  riable, val: Any
-0000d4b0: 2c20 616c 6c6f 775f 6475 706c 6963 6174  , allow_duplicat
-0000d4c0: 6573 3d46 616c 7365 2920 2d3e 204e 6f6e  es=False) -> Non
-0000d4d0: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
-0000d4e0: 7420 6973 696e 7374 616e 6365 2876 2c20  t isinstance(v, 
-0000d4f0: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
-0000d500: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0000d510: 2020 2020 2020 2320 4475 706c 6963 6174        # Duplicat
-0000d520: 6573 2061 7265 2061 6c6c 6f77 6564 2061  es are allowed a
-0000d530: 6e64 206f 7665 7277 7269 7474 656e 0a20  nd overwritten. 
-0000d540: 2020 2020 2020 2069 6620 762e 6e61 6d65         if v.name
-0000d550: 2069 6e20 656e 763a 0a20 2020 2020 2020   in env:.       
-0000d560: 2020 2020 2069 6620 616c 6c6f 775f 6475       if allow_du
-0000d570: 706c 6963 6174 6573 3a0a 2020 2020 2020  plicates:.      
-0000d580: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d590: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000d5a0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-0000d5b0: 5661 7269 6162 6c65 207b 762e 6e61 6d65  Variable {v.name
-0000d5c0: 7d20 6973 2062 6569 6e67 206f 7665 7277  } is being overw
-0000d5d0: 7269 7474 656e 2074 6869 7320 6973 206e  ritten this is n
-0000d5e0: 6f74 2061 6c6c 6f77 6564 2229 0a20 2020  ot allowed").   
-0000d5f0: 2020 2020 2065 6e76 5b76 2e6e 616d 655d       env[v.name]
-0000d600: 203d 2076 616c 0a0a 2020 2020 7361 6665   = val..    safe
-0000d610: 5f6d 6170 5f66 6c61 7428 7772 6974 652c  _map_flat(write,
-0000d620: 206c 6973 7428 7472 6163 652e 6172 6773   list(trace.args
-0000d630: 292c 206c 6973 7428 6172 6773 2929 0a20  ), list(args)). 
-0000d640: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
-0000d650: 2877 7269 7465 2c20 6c69 7374 2874 7261  (write, list(tra
-0000d660: 6365 2e6b 7761 7267 732e 7661 6c75 6573  ce.kwargs.values
-0000d670: 2829 292c 206c 6973 7428 6b77 6172 6773  ()), list(kwargs
-0000d680: 2e76 616c 7565 7328 2929 290a 0a20 2020  .values()))..   
-0000d690: 2066 6f72 2073 796d 626f 6c20 696e 2074   for symbol in t
-0000d6a0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0000d6b0: 6c73 3a0a 2020 2020 2020 2020 6966 2073  ls:.        if s
-0000d6c0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
-0000d6d0: 7472 616e 7366 6f72 6d5f 736b 6970 5f6c  transform_skip_l
-0000d6e0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-0000d6f0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0000d700: 2020 6172 6773 203d 2074 7265 655f 6d61    args = tree_ma
-0000d710: 7028 7265 6164 2c20 7379 6d62 6f6c 2e61  p(read, symbol.a
-0000d720: 7267 7329 0a20 2020 2020 2020 206b 7761  rgs).        kwa
-0000d730: 7267 7320 3d20 7472 6565 5f6d 6170 2872  rgs = tree_map(r
-0000d740: 6561 642c 2073 796d 626f 6c2e 6b77 6172  ead, symbol.kwar
-0000d750: 6773 290a 2020 2020 2020 2020 7072 696d  gs).        prim
-0000d760: 5f66 756e 6320 3d20 7379 6d62 6f6c 5f6d  _func = symbol_m
-0000d770: 6170 7065 7228 7379 6d62 6f6c 290a 2020  apper(symbol).  
-0000d780: 2020 2020 2020 6966 2070 7269 6d5f 6675        if prim_fu
-0000d790: 6e63 2069 7320 4e6f 6e65 3a0a 2020 2020  nc is None:.    
-0000d7a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0000d7b0: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-0000d7c0: 3d20 7072 696d 5f66 756e 6328 2a61 7267  = prim_func(*arg
-0000d7d0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
-0000d7e0: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
-0000d7f0: 6174 2877 7269 7465 2c20 6c69 7374 2873  at(write, list(s
-0000d800: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
-0000d810: 2e6f 7574 7075 7429 292c 206c 6973 7428  .output)), list(
-0000d820: 7365 7175 656e 6369 6679 2872 6573 756c  sequencify(resul
-0000d830: 7429 2929 0a0a 2020 2020 6966 2077 6974  t)))..    if wit
-0000d840: 685f 656e 763a 0a20 2020 2020 2020 2072  h_env:.        r
-0000d850: 6574 7572 6e20 7472 6565 5f6d 6170 2872  eturn tree_map(r
-0000d860: 6561 642c 2074 7261 6365 2e6f 7574 7075  ead, trace.outpu
-0000d870: 7429 2c20 656e 760a 0a20 2020 2072 6574  t), env..    ret
-0000d880: 7572 6e20 7472 6565 5f6d 6170 2872 6561  urn tree_map(rea
-0000d890: 642c 2074 7261 6365 2e6f 7574 7075 7429  d, trace.output)
-0000d8a0: 0a0a 0a64 6566 205f 6964 656e 7469 7479  ...def _identity
-0000d8b0: 5f63 616c 6c5f 6d65 7461 6675 6e63 282a  _call_metafunc(*
-0000d8c0: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
-0000d8d0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-0000d8e0: 2020 2077 6974 6820 6465 7461 6368 6564     with detached
-0000d8f0: 5f74 7261 6365 2829 3a0a 2020 2020 2020  _trace():.      
-0000d900: 2020 7265 7475 726e 2065 7661 6c5f 7472    return eval_tr
-0000d910: 6163 6528 7472 6163 652c 202a 6172 6773  ace(trace, *args
-0000d920: 2c20 2a2a 6b77 6172 6773 290a 0a0a 6964  , **kwargs)...id
-0000d930: 656e 7469 7479 5f63 616c 6c20 3d20 5379  entity_call = Sy
-0000d940: 6d62 6f6c 2869 643d 5472 616e 7366 6f72  mbol(id=Transfor
-0000d950: 6d73 2e49 6465 6e74 6974 794f 702c 206e  ms.IdentityOp, n
-0000d960: 616d 653d 2269 6465 6e74 6974 795f 6361  ame="identity_ca
-0000d970: 6c6c 222c 206d 6574 613d 5f69 6465 6e74  ll", meta=_ident
-0000d980: 6974 795f 6361 6c6c 5f6d 6574 6166 756e  ity_call_metafun
-0000d990: 6329 0a0a 0a64 6566 2069 6465 6e74 6974  c)...def identit
-0000d9a0: 7928 6675 6e63 293a 0a20 2020 2022 2222  y(func):.    """
-0000d9b0: 4964 656e 7469 7479 2074 7261 6e73 666f  Identity transfo
-0000d9c0: 726d 2066 6f72 2061 2054 6875 6e64 6572  rm for a Thunder
-0000d9d0: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
-0000d9e0: 4172 6773 3a0a 2020 2020 2020 2020 6675  Args:.        fu
-0000d9f0: 6e63 2028 4361 6c6c 6162 6c65 293a 2041  nc (Callable): A
-0000da00: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
-0000da10: 6e20 746f 2062 6520 7472 616e 7366 6f72  n to be transfor
-0000da20: 6d65 642e 0a20 2020 2022 2222 0a0a 2020  med..    """..  
-0000da30: 2020 6465 6620 7772 6170 7065 7228 2a61    def wrapper(*a
-0000da40: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
-0000da50: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
-0000da60: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-0000da70: 2928 6675 6e63 2c20 2a61 7267 732c 202a  )(func, *args, *
-0000da80: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-0000da90: 2072 6574 7572 6e20 6964 656e 7469 7479   return identity
-0000daa0: 5f63 616c 6c28 2a61 7267 732c 202a 2a6b  _call(*args, **k
-0000dab0: 7761 7267 732c 2074 7261 6365 3d74 7261  wargs, trace=tra
-0000dac0: 6365 290a 0a20 2020 2072 6574 7572 6e20  ce)..    return 
-0000dad0: 7772 6170 7065 720a 0a0a 6465 6620 5f69  wrapper...def _i
-0000dae0: 6465 6e74 6974 795f 6361 6c6c 5f70 7974  dentity_call_pyt
-0000daf0: 6f72 6368 282a 6172 6773 2c20 7472 6163  orch(*args, trac
-0000db00: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
-0000db10: 6773 293a 0a20 2020 2069 6d70 6f72 7420  gs):.    import 
-0000db20: 746f 7263 680a 0a20 2020 2064 6566 2073  torch..    def s
-0000db30: 796d 626f 6c5f 6d61 7070 6572 286f 7029  ymbol_mapper(op)
-0000db40: 3a0a 2020 2020 2020 2020 6966 206f 702e  :.        if op.
-0000db50: 6f70 203d 3d20 5472 616e 7366 6f72 6d73  op == Transforms
-0000db60: 2e49 6465 6e74 6974 794f 703a 0a20 2020  .IdentityOp:.   
-0000db70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000db80: 5f69 6465 6e74 6974 795f 6361 6c6c 5f70  _identity_call_p
-0000db90: 7974 6f72 6368 0a0a 2020 2020 2020 2020  ytorch..        
-0000dba0: 746f 7263 685f 6f70 203d 206f 7073 5f74  torch_op = ops_t
-0000dbb0: 6f5f 746f 7263 685f 6f70 735f 6d61 705b  o_torch_ops_map[
-0000dbc0: 6f70 2e6f 705d 0a20 2020 2020 2020 2069  op.op].        i
-0000dbd0: 6620 6973 696e 7374 616e 6365 2874 6f72  f isinstance(tor
-0000dbe0: 6368 5f6f 702c 2073 7472 293a 0a20 2020  ch_op, str):.   
-0000dbf0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000dc00: 6765 7461 7474 7228 746f 7263 682c 2074  getattr(torch, t
-0000dc10: 6f72 6368 5f6f 702e 7374 7269 7028 2270  orch_op.strip("p
-0000dc20: 7974 6f72 6368 2e22 2929 0a20 2020 2020  ytorch.")).     
-0000dc30: 2020 2072 6574 7572 6e20 746f 7263 685f     return torch_
-0000dc40: 6f70 0a0a 2020 2020 7769 7468 2064 6574  op..    with det
-0000dc50: 6163 6865 645f 7472 6163 6528 293a 0a20  ached_trace():. 
-0000dc60: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
-0000dc70: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
-0000dc80: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
-0000dc90: 2073 796d 626f 6c5f 6d61 7070 6572 3d73   symbol_mapper=s
-0000dca0: 796d 626f 6c5f 6d61 7070 6572 290a 0a0a  ymbol_mapper)...
-0000dcb0: 2320 5265 6769 7374 6572 2074 6865 2069  # Register the i
-0000dcc0: 6465 6e74 6974 7920 6361 6c6c 2066 6f72  dentity call for
-0000dcd0: 2050 7954 6f72 6368 2065 7865 6375 746f   PyTorch executo
-0000dce0: 722e 0a23 206f 7073 5f74 6f5f 746f 7263  r..# ops_to_torc
-0000dcf0: 685f 6f70 735f 6d61 705b 5472 616e 7366  h_ops_map[Transf
-0000dd00: 6f72 6d73 2e49 6465 6e74 6974 794f 705d  orms.IdentityOp]
-0000dd10: 203d 205f 6964 656e 7469 7479 5f63 616c   = _identity_cal
-0000dd20: 6c5f 7079 746f 7263 680a 0a0a 2320 564d  l_pytorch...# VM
-0000dd30: 4150 2074 7261 6e73 666f 726d 0a23 202d  AP transform.# -
-0000dd40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a63  ------------...c
-0000dd50: 6c61 7373 204e 6f74 4d61 7070 6564 3a0a  lass NotMapped:.
-0000dd60: 2020 2020 2222 2252 6570 7265 7365 6e74      """Represent
-0000dd70: 7320 6120 6e6f 6e2d 6261 7463 6865 6420  s a non-batched 
-0000dd80: 6469 6d65 6e73 696f 6e2e 2222 220a 0a20  dimension.""".. 
-0000dd90: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
-0000dda0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-0000ddb0: 6574 7572 6e20 226e 6f74 5f6d 6170 7065  eturn "not_mappe
-0000ddc0: 6422 0a0a 0a40 6461 7461 636c 6173 7328  d"...@dataclass(
-0000ddd0: 6672 6f7a 656e 3d54 7275 6529 0a63 6c61  frozen=True).cla
-0000dde0: 7373 2042 6174 6368 6564 5661 6c75 653a  ss BatchedValue:
-0000ddf0: 0a20 2020 2022 2222 4261 7463 6865 6420  .    """Batched 
-0000de00: 7661 6c75 6520 666f 7220 7468 6520 766d  value for the vm
-0000de10: 6170 2074 7261 6e73 666f 726d 2e0a 0a20  ap transform... 
-0000de20: 2020 2041 7474 7269 6275 7465 733a 0a20     Attributes:. 
-0000de30: 2020 2020 2020 2076 616c 7565 3a20 4261         value: Ba
-0000de40: 7463 6865 6420 7661 6c75 652e 0a20 2020  tched value..   
-0000de50: 2020 2020 2062 6174 6368 5f64 696d 3a20       batch_dim: 
-0000de60: 4261 7463 6869 6e67 2064 696d 656e 7369  Batching dimensi
-0000de70: 6f6e 206f 7220 6e6f 745f 6d61 7070 6564  on or not_mapped
-0000de80: 0a20 2020 2022 2222 0a0a 2020 2020 7661  .    """..    va
-0000de90: 6c75 653a 2041 6e79 0a20 2020 2062 6174  lue: Any.    bat
-0000dea0: 6368 5f64 696d 3a20 696e 7420 7c20 4e6f  ch_dim: int | No
-0000deb0: 744d 6170 7065 640a 0a20 2020 2064 6566  tMapped..    def
-0000dec0: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
-0000ded0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0000dee0: 656c 662e 7661 6c75 650a 2020 2020 2020  elf.value.      
-0000def0: 2020 7969 656c 6420 7365 6c66 2e62 6174    yield self.bat
-0000df00: 6368 5f64 696d 0a0a 0a64 6566 2070 6169  ch_dim...def pai
-0000df10: 725f 746f 5f62 6174 6368 6564 5f76 616c  r_to_batched_val
-0000df20: 7565 2870 6169 7229 3a0a 2020 2020 2222  ue(pair):.    ""
-0000df30: 2243 6f6e 7665 7274 7320 6120 7061 6972  "Converts a pair
-0000df40: 2074 6f20 6120 4261 7463 6865 6456 616c   to a BatchedVal
-0000df50: 7565 2e0a 0a20 2020 2041 7267 733a 0a20  ue...    Args:. 
-0000df60: 2020 2020 2020 2070 6169 7220 2853 6571         pair (Seq
-0000df70: 7565 6e63 6529 3a20 5061 6972 2074 6f20  uence): Pair to 
-0000df80: 636f 6e76 6572 742e 0a0a 2020 2020 5265  convert...    Re
-0000df90: 7475 726e 733a 0a20 2020 2020 2020 2042  turns:.        B
-0000dfa0: 6174 6368 6564 5661 6c75 653a 2042 6174  atchedValue: Bat
-0000dfb0: 6368 6564 5661 6c75 6520 7265 7072 6573  chedValue repres
-0000dfc0: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
-0000dfd0: 7061 6972 2e0a 2020 2020 2222 220a 2020  pair..    """.  
-0000dfe0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000dff0: 7061 6972 2c20 4261 7463 6865 6456 616c  pair, BatchedVal
-0000e000: 7565 293a 0a20 2020 2020 2020 2072 6574  ue):.        ret
-0000e010: 7572 6e20 7061 6972 0a20 2020 2065 6c73  urn pair.    els
-0000e020: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
-0000e030: 7420 6973 696e 7374 616e 6365 2870 6169  t isinstance(pai
-0000e040: 722c 2053 6571 7565 6e63 6529 2061 6e64  r, Sequence) and
-0000e050: 206c 656e 2870 6169 7229 203d 3d20 320a   len(pair) == 2.
-0000e060: 2020 2020 2020 2020 7265 7475 726e 2042          return B
-0000e070: 6174 6368 6564 5661 6c75 6528 2a70 6169  atchedValue(*pai
-0000e080: 7229 0a0a 0a64 6566 2076 6563 746f 7269  r)...def vectori
-0000e090: 7a65 645f 6261 7463 6865 7228 7072 696d  zed_batcher(prim
-0000e0a0: 2c20 6178 6973 5f73 697a 652c 2062 6174  , axis_size, bat
-0000e0b0: 6368 6564 5f76 616c 7565 732c 202a 2a6b  ched_values, **k
-0000e0c0: 7761 7267 7329 3a0a 2020 2020 6261 7463  wargs):.    batc
-0000e0d0: 685f 6469 6d20 3d20 6261 7463 6865 645f  h_dim = batched_
-0000e0e0: 7661 6c75 6573 5b30 5d2e 6261 7463 685f  values[0].batch_
-0000e0f0: 6469 6d0a 2020 2020 6173 7365 7274 2061  dim.    assert a
-0000e100: 6c6c 280a 2020 2020 2020 2020 6261 7463  ll(.        batc
-0000e110: 685f 6469 6d20 3d3d 2062 762e 6261 7463  h_dim == bv.batc
-0000e120: 685f 6469 6d20 666f 7220 6276 2069 6e20  h_dim for bv in 
-0000e130: 6261 7463 6865 645f 7661 6c75 6573 5b31  batched_values[1
-0000e140: 3a5d 0a20 2020 2029 2c20 6622 6076 6563  :].    ), f"`vec
-0000e150: 746f 7269 7a65 645f 6261 7463 6865 7260  torized_batcher`
-0000e160: 2067 6f74 2064 6966 6665 7265 6e74 2062   got different b
-0000e170: 6174 6368 6564 2064 696d 656e 7369 6f6e  atched dimension
-0000e180: 7320 7b5b 6276 2e62 6174 6368 5f64 696d  s {[bv.batch_dim
-0000e190: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
-0000e1a0: 6564 5f76 616c 7565 735d 7d22 0a20 2020  ed_values]}".   
-0000e1b0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-0000e1c0: 616c 7565 2870 7269 6d28 2a5b 6276 2e76  alue(prim(*[bv.v
-0000e1d0: 616c 7565 2066 6f72 2062 7620 696e 2062  alue for bv in b
-0000e1e0: 6174 6368 6564 5f76 616c 7565 735d 2c20  atched_values], 
-0000e1f0: 2a2a 6b77 6172 6773 292c 2062 6174 6368  **kwargs), batch
-0000e200: 5f64 696d 290a 0a0a 6e6f 745f 6d61 7070  _dim)...not_mapp
-0000e210: 6564 203d 204e 6f74 4d61 7070 6564 2829  ed = NotMapped()
-0000e220: 0a0a 0a64 6566 206d 6f76 6564 696d 2878  ...def movedim(x
-0000e230: 2c20 7372 633a 2069 6e74 2c20 6473 743a  , src: int, dst:
-0000e240: 2069 6e74 293a 0a20 2020 2070 6572 6d20   int):.    perm 
-0000e250: 3d20 5b69 2066 6f72 2069 2069 6e20 7261  = [i for i in ra
-0000e260: 6e67 6528 782e 6e64 696d 2920 6966 2069  nge(x.ndim) if i
-0000e270: 2021 3d20 7372 635d 0a20 2020 2070 6572   != src].    per
-0000e280: 6d2e 696e 7365 7274 2864 7374 2c20 7372  m.insert(dst, sr
-0000e290: 6329 0a20 2020 2072 6574 7572 6e20 7072  c).    return pr
-0000e2a0: 696d 732e 7472 616e 7370 6f73 6528 782c  ims.transpose(x,
-0000e2b0: 2074 7570 6c65 2870 6572 6d29 290a 0a0a   tuple(perm))...
-0000e2c0: 6465 6620 6d6f 7665 5f62 6174 6368 5f64  def move_batch_d
-0000e2d0: 696d 2861 7869 735f 7369 7a65 2c20 7372  im(axis_size, sr
-0000e2e0: 632c 2064 7374 2c20 7829 3a0a 2020 2020  c, dst, x):.    
-0000e2f0: 6966 2073 7263 2069 7320 6e6f 745f 6d61  if src is not_ma
-0000e300: 7070 6564 3a0a 2020 2020 2020 2020 6966  pped:.        if
-0000e310: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
-0000e320: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
-0000e330: 2020 2020 7265 7475 726e 2078 0a20 2020      return x.   
-0000e340: 2020 2020 2074 6172 6765 745f 7368 6170       target_shap
-0000e350: 6520 3d20 6c69 7374 2878 2e73 6861 7065  e = list(x.shape
-0000e360: 290a 2020 2020 2020 2020 7461 7267 6574  ).        target
-0000e370: 5f73 6861 7065 2e69 6e73 6572 7428 6473  _shape.insert(ds
-0000e380: 742c 2061 7869 735f 7369 7a65 290a 2020  t, axis_size).  
-0000e390: 2020 2020 2020 6263 6173 745f 6469 6d73        bcast_dims
-0000e3a0: 203d 206c 6973 7428 7261 6e67 6528 6c65   = list(range(le
-0000e3b0: 6e28 7461 7267 6574 5f73 6861 7065 2929  n(target_shape))
-0000e3c0: 290a 2020 2020 2020 2020 6263 6173 745f  ).        bcast_
-0000e3d0: 6469 6d73 2e70 6f70 2864 7374 290a 2020  dims.pop(dst).  
-0000e3e0: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
-0000e3f0: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
-0000e400: 6469 6d28 782c 2074 6172 6765 745f 7368  dim(x, target_sh
-0000e410: 6170 652c 2062 6361 7374 5f64 696d 7329  ape, bcast_dims)
-0000e420: 0a20 2020 2065 6c69 6620 7372 6320 3d3d  .    elif src ==
-0000e430: 2064 7374 3a0a 2020 2020 2020 2020 7265   dst:.        re
-0000e440: 7475 726e 2078 0a20 2020 2065 6c73 653a  turn x.    else:
-0000e450: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e460: 6d6f 7665 6469 6d28 782c 2073 7263 2c20  movedim(x, src, 
-0000e470: 6473 7429 0a0a 0a64 6566 2062 696e 6172  dst)...def binar
-0000e480: 795f 6f70 5f62 6174 6368 696e 675f 7275  y_op_batching_ru
-0000e490: 6c65 286f 703a 2070 7269 6d73 2e50 7269  le(op: prims.Pri
-0000e4a0: 6d49 4473 2c20 6178 6973 5f73 697a 653a  mIDs, axis_size:
-0000e4b0: 2069 6e74 2c20 7661 6c73 5f69 6e3a 2042   int, vals_in: B
-0000e4c0: 6174 6368 6564 5661 6c75 6529 3a0a 2020  atchedValue):.  
-0000e4d0: 2020 2828 782c 2078 5f62 6469 6d29 2c20    ((x, x_bdim), 
-0000e4e0: 2879 2c20 795f 6264 696d 2929 203d 2076  (y, y_bdim)) = v
-0000e4f0: 616c 735f 696e 0a20 2020 2069 6620 785f  als_in.    if x_
-0000e500: 6264 696d 2021 3d20 795f 6264 696d 3a0a  bdim != y_bdim:.
-0000e510: 2020 2020 2020 2020 6966 2078 5f62 6469          if x_bdi
-0000e520: 6d20 6973 206e 6f74 5f6d 6170 7065 643a  m is not_mapped:
-0000e530: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
-0000e540: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
-0000e550: 6178 6973 5f73 697a 652c 2078 5f62 6469  axis_size, x_bdi
-0000e560: 6d2c 2079 5f62 6469 6d2c 2078 290a 2020  m, y_bdim, x).  
-0000e570: 2020 2020 2020 2020 2020 785f 6264 696d            x_bdim
-0000e580: 203d 2079 5f62 6469 6d0a 2020 2020 2020   = y_bdim.      
-0000e590: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000e5a0: 2020 2020 7920 3d20 6d6f 7665 5f62 6174      y = move_bat
-0000e5b0: 6368 5f64 696d 2861 7869 735f 7369 7a65  ch_dim(axis_size
-0000e5c0: 2c20 795f 6264 696d 2c20 785f 6264 696d  , y_bdim, x_bdim
-0000e5d0: 2c20 7929 0a20 2020 2072 6574 7572 6e20  , y).    return 
-0000e5e0: 4261 7463 6865 6456 616c 7565 286f 7028  BatchedValue(op(
-0000e5f0: 782c 2079 292c 2078 5f62 6469 6d29 0a0a  x, y), x_bdim)..
-0000e600: 0a64 6566 2073 696e 5f76 6d61 7028 6178  .def sin_vmap(ax
-0000e610: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
-0000e620: 2042 6174 6368 6564 5661 6c75 6529 202d   BatchedValue) -
-0000e630: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
-0000e640: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
-0000e650: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
-0000e660: 696d 732e 7369 6e2c 2061 7869 735f 7369  ims.sin, axis_si
-0000e670: 7a65 2c20 2861 2c29 290a 0a0a 6465 6620  ze, (a,))...def 
-0000e680: 636f 735f 766d 6170 2861 7869 735f 7369  cos_vmap(axis_si
-0000e690: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
-0000e6a0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
-0000e6b0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
-0000e6c0: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
-0000e6d0: 5f62 6174 6368 6572 2870 7269 6d73 2e63  _batcher(prims.c
-0000e6e0: 6f73 2c20 6178 6973 5f73 697a 652c 2028  os, axis_size, (
-0000e6f0: 612c 2929 0a0a 0a64 6566 206d 756c 5f76  a,))...def mul_v
-0000e700: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
-0000e710: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
-0000e720: 6c75 652c 2062 3a20 4261 7463 6865 6456  lue, b: BatchedV
-0000e730: 616c 7565 2920 2d3e 2042 6174 6368 6564  alue) -> Batched
-0000e740: 5661 6c75 653a 0a20 2020 2072 6574 7572  Value:.    retur
-0000e750: 6e20 6269 6e61 7279 5f6f 705f 6261 7463  n binary_op_batc
-0000e760: 6869 6e67 5f72 756c 6528 7072 696d 732e  hing_rule(prims.
-0000e770: 6d75 6c2c 2061 7869 735f 7369 7a65 2c20  mul, axis_size, 
-0000e780: 2861 2c20 6229 290a 0a0a 6465 6620 6164  (a, b))...def ad
-0000e790: 645f 766d 6170 2861 7869 735f 7369 7a65  d_vmap(axis_size
-0000e7a0: 3a20 696e 742c 2061 3a20 4261 7463 6865  : int, a: Batche
-0000e7b0: 6456 616c 7565 2c20 623a 2042 6174 6368  dValue, b: Batch
-0000e7c0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
-0000e7d0: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
-0000e7e0: 7475 726e 2062 696e 6172 795f 6f70 5f62  turn binary_op_b
-0000e7f0: 6174 6368 696e 675f 7275 6c65 2870 7269  atching_rule(pri
-0000e800: 6d73 2e61 6464 2c20 6178 6973 5f73 697a  ms.add, axis_siz
-0000e810: 652c 2028 612c 2062 2929 0a0a 0a64 6566  e, (a, b))...def
-0000e820: 2073 756d 5f76 6d61 7028 6178 6973 5f73   sum_vmap(axis_s
-0000e830: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
-0000e840: 6368 6564 5661 6c75 652c 2064 696d 733a  chedValue, dims:
-0000e850: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
-0000e860: 2a2a 6b77 6172 6773 2920 2d3e 2042 6174  **kwargs) -> Bat
-0000e870: 6368 6564 5661 6c75 653a 0a20 2020 2062  chedValue:.    b
-0000e880: 6469 6d20 3d20 612e 6261 7463 685f 6469  dim = a.batch_di
-0000e890: 6d0a 2020 2020 2320 544f 444f 3a20 7265  m.    # TODO: re
-0000e8a0: 6d6f 7665 2074 6869 7320 7768 656e 2064  move this when d
-0000e8b0: 696d 7320 6265 636f 6d65 7320 6120 6d61  ims becomes a ma
-0000e8c0: 6e64 6174 6f72 7920 6b77 6172 670a 2020  ndatory kwarg.  
-0000e8d0: 2020 6966 206c 656e 2864 696d 7329 203e    if len(dims) >
-0000e8e0: 2030 3a0a 2020 2020 2020 2020 6469 6d73   0:.        dims
-0000e8f0: 2c20 5f20 3d20 7361 6665 5f7a 6970 282a  , _ = safe_zip(*
-0000e900: 6469 6d73 290a 2020 2020 6469 6d73 5f62  dims).    dims_b
-0000e910: 6566 6f72 6520 3d20 7475 706c 6528 656c  efore = tuple(el
-0000e920: 2066 6f72 2065 6c20 696e 2064 696d 7320   for el in dims 
-0000e930: 6966 2065 6c20 3c20 6264 696d 290a 2020  if el < bdim).  
-0000e940: 2020 6469 6d73 5f61 6674 6572 203d 2074    dims_after = t
-0000e950: 7570 6c65 2865 6c20 2b20 3120 666f 7220  uple(el + 1 for 
-0000e960: 656c 2069 6e20 6469 6d73 2069 6620 656c  el in dims if el
-0000e970: 203e 3d20 6264 696d 290a 2020 2020 6261   >= bdim).    ba
-0000e980: 7463 6865 645f 6469 6d73 203d 2064 696d  tched_dims = dim
-0000e990: 735f 6265 666f 7265 202b 2064 696d 735f  s_before + dims_
-0000e9a0: 6166 7465 720a 2020 2020 7265 7475 726e  after.    return
-0000e9b0: 2076 6563 746f 7269 7a65 645f 6261 7463   vectorized_batc
-0000e9c0: 6865 7228 7072 696d 732e 7375 6d2c 2061  her(prims.sum, a
-0000e9d0: 7869 735f 7369 7a65 2c20 2861 2c29 2c20  xis_size, (a,), 
-0000e9e0: 6469 6d73 3d62 6174 6368 6564 5f64 696d  dims=batched_dim
-0000e9f0: 732c 202a 2a6b 7761 7267 7329 0a0a 0a23  s, **kwargs)...#
-0000ea00: 2054 4f44 4f3a 2050 6c65 6173 6520 7465   TODO: Please te
-0000ea10: 7374 2074 6869 7320 6578 7465 6e73 6976  st this extensiv
-0000ea20: 656c 790a 6465 6620 6272 6f61 6463 6173  ely.def broadcas
-0000ea30: 745f 696e 5f64 696d 5f76 6d61 7028 0a20  t_in_dim_vmap(. 
-0000ea40: 2020 2061 7869 735f 7369 7a65 3a20 696e     axis_size: in
-0000ea50: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
-0000ea60: 7565 2c20 7368 6170 653a 2053 6571 7565  ue, shape: Seque
-0000ea70: 6e63 655b 4261 7463 6865 6456 616c 7565  nce[BatchedValue
-0000ea80: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
-0000ea90: 656e 7369 6f6e 733a 2053 6571 7565 6e63  ensions: Sequenc
-0000eaa0: 655b 4261 7463 6865 6456 616c 7565 5d0a  e[BatchedValue].
-0000eab0: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
-0000eac0: 653a 0a20 2020 2062 6469 6d20 3d20 612e  e:.    bdim = a.
-0000ead0: 6261 7463 685f 6469 6d0a 2020 2020 2320  batch_dim.    # 
-0000eae0: 544f 444f 3a20 7265 6d6f 7665 2074 6869  TODO: remove thi
-0000eaf0: 7320 7768 656e 2073 6861 7065 2061 6e64  s when shape and
-0000eb00: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
-0000eb10: 7369 6f6e 7320 6265 636f 6d65 206d 616e  sions become man
-0000eb20: 6461 746f 7279 206b 7761 7267 730a 2020  datory kwargs.  
-0000eb30: 2020 7368 6170 652c 205f 203d 2073 6166    shape, _ = saf
-0000eb40: 655f 7a69 7028 2a73 6861 7065 290a 2020  e_zip(*shape).  
-0000eb50: 2020 6966 206c 656e 2862 726f 6164 6361    if len(broadca
-0000eb60: 7374 5f64 696d 656e 7369 6f6e 7329 203e  st_dimensions) >
-0000eb70: 2030 3a0a 2020 2020 2020 2020 6272 6f61   0:.        broa
-0000eb80: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000eb90: 2c20 5f20 3d20 7361 6665 5f7a 6970 282a  , _ = safe_zip(*
-0000eba0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000ebb0: 696f 6e73 290a 2020 2020 6966 2062 6469  ions).    if bdi
-0000ebc0: 6d20 6973 206e 6f74 5f6d 6170 7065 643a  m is not_mapped:
-0000ebd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000ebe0: 4261 7463 6865 6456 616c 7565 2870 7269  BatchedValue(pri
-0000ebf0: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
-0000ec00: 6469 6d28 612e 7661 6c75 652c 2073 6861  dim(a.value, sha
-0000ec10: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
-0000ec20: 6d65 6e73 696f 6e73 292c 2062 6469 6d29  mensions), bdim)
-0000ec30: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000ec40: 2020 206e 6577 5f62 6469 6d20 3d20 6264     new_bdim = bd
-0000ec50: 696d 202b 2073 756d 2831 2066 6f72 2064  im + sum(1 for d
-0000ec60: 696d 2069 6e20 6272 6f61 6463 6173 745f  im in broadcast_
-0000ec70: 6469 6d65 6e73 696f 6e73 2069 6620 6469  dimensions if di
-0000ec80: 6d20 3c20 6264 696d 290a 2020 2020 2020  m < bdim).      
-0000ec90: 2020 6e65 775f 7368 6170 6520 3d20 6c69    new_shape = li
-0000eca0: 7374 2873 6861 7065 290a 2020 2020 2020  st(shape).      
-0000ecb0: 2020 6e65 775f 7368 6170 652e 696e 7365    new_shape.inse
-0000ecc0: 7274 286e 6577 5f62 6469 6d2c 2061 7869  rt(new_bdim, axi
-0000ecd0: 735f 7369 7a65 290a 2020 2020 2020 2020  s_size).        
-0000ece0: 6e65 775f 6272 6f61 6463 6173 745f 6469  new_broadcast_di
-0000ecf0: 6d65 6e73 696f 6e73 203d 2028 302c 2920  mensions = (0,) 
-0000ed00: 2b20 7475 706c 6528 6469 6d20 2b20 3120  + tuple(dim + 1 
-0000ed10: 6966 2064 696d 203e 3d20 6264 696d 2065  if dim >= bdim e
-0000ed20: 6c73 6520 6469 6d20 666f 7220 6469 6d20  lse dim for dim 
-0000ed30: 696e 2062 726f 6164 6361 7374 5f64 696d  in broadcast_dim
-0000ed40: 656e 7369 6f6e 7329 0a20 2020 2020 2020  ensions).       
-0000ed50: 2069 6620 6272 6f61 6463 6173 745f 6469   if broadcast_di
-0000ed60: 6d65 6e73 696f 6e73 203d 3d20 2829 3a0a  mensions == ():.
-0000ed70: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0000ed80: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000ed90: 696f 6e73 203d 2028 290a 2020 2020 2020  ions = ().      
-0000eda0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
-0000edb0: 5661 6c75 6528 7072 696d 732e 6272 6f61  Value(prims.broa
-0000edc0: 6463 6173 745f 696e 5f64 696d 2861 2e76  dcast_in_dim(a.v
-0000edd0: 616c 7565 2c20 6e65 775f 7368 6170 652c  alue, new_shape,
+0000b4e0: 2020 2320 544f 444f 2052 6576 6973 6974    # TODO Revisit
+0000b4f0: 2074 6869 7320 2d2d 2063 616e 2077 6520   this -- can we 
+0000b500: 7265 6d6f 7665 2074 6865 7365 2063 6f6d  remove these com
+0000b510: 7075 7461 7469 6f6e 732c 206f 7220 7573  putations, or us
+0000b520: 6520 6120 7370 6563 6961 6c20 5a65 726f  e a special Zero
+0000b530: 5465 6e73 6f72 0a20 2020 2020 2020 2020  Tensor.         
+0000b540: 2020 2020 2020 2020 2020 2023 2020 2074             #   t
+0000b550: 6f20 7369 6d70 6c69 6679 2074 6865 6d3f  o simplify them?
+0000b560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b570: 2020 2020 2069 6620 6163 7475 616c 5f67       if actual_g
+0000b580: 7261 6420 6973 204e 6f6e 653a 0a20 2020  rad is None:.   
+0000b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5a0: 2020 2020 2061 6374 7561 6c5f 6772 6164       actual_grad
+0000b5b0: 203d 206c 746f 7263 682e 7a65 726f 735f   = ltorch.zeros_
+0000b5c0: 6c69 6b65 2870 7269 6d61 6c29 0a20 2020  like(primal).   
+0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5e0: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
+0000b5f0: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
+0000b600: 616c 5d20 3d20 6163 7475 616c 5f67 7261  al] = actual_gra
+0000b610: 640a 0a20 2020 2020 2020 2020 2020 2020  d..             
+0000b620: 2020 2020 2020 2023 2055 7064 6174 6573         # Updates
+0000b630: 2074 6865 2067 7261 6420 616c 6961 7320   the grad alias 
+0000b640: 6d61 700a 2020 2020 2020 2020 2020 2020  map.            
+0000b650: 2020 2020 2020 2020 7661 6374 7561 6c5f          vactual_
+0000b660: 6772 6164 3a20 5661 7269 6162 6c65 203d  grad: Variable =
+0000b670: 2076 6172 6961 626c 6569 6679 2861 6374   variableify(act
+0000b680: 7561 6c5f 6772 6164 290a 2020 2020 2020  ual_grad).      
+0000b690: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b6a0: 2076 6163 7475 616c 5f67 7261 6420 213d   vactual_grad !=
+0000b6b0: 2076 6772 6164 3a0a 2020 2020 2020 2020   vgrad:.        
+0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6d0: 7377 6170 6d61 705b 7667 7261 645d 203d  swapmap[vgrad] =
+0000b6e0: 2061 6374 7561 6c5f 6772 6164 0a0a 2020   actual_grad..  
+0000b6f0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+0000b700: 2020 2020 2020 2020 2020 2023 2052 6573             # Res
+0000b710: 746f 7265 7320 7363 6f70 650a 2020 2020  tores scope.    
+0000b720: 2020 2020 2020 2020 7265 7365 745f 7472          reset_tr
+0000b730: 6163 6563 7478 2874 7261 6365 6374 785f  acectx(tracectx_
+0000b740: 746f 6b29 0a0a 2020 2020 2020 2020 2320  tok)..        # 
+0000b750: 4669 6c74 6572 7320 7075 745f 6772 6164  Filters put_grad
+0000b760: 2061 6e64 2067 6574 5f67 7261 6420 6f70   and get_grad op
+0000b770: 6572 6174 696f 6e73 2061 6e64 2061 7070  erations and app
+0000b780: 6c69 6573 2074 6865 2073 7761 706d 6170  lies the swapmap
+0000b790: 0a20 2020 2020 2020 2064 6566 205f 6669  .        def _fi
+0000b7a0: 6c74 6572 2862 7379 6d3a 2042 6f75 6e64  lter(bsym: Bound
+0000b7b0: 5379 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a  Symbol) -> bool:
+0000b7c0: 0a20 2020 2020 2020 2020 2020 2069 643a  .            id:
+0000b7d0: 2048 6173 6861 626c 6520 3d20 6273 796d   Hashable = bsym
+0000b7e0: 2e73 796d 2e69 640a 2020 2020 2020 2020  .sym.id.        
+0000b7f0: 2020 2020 7265 7475 726e 2069 6420 696e      return id in
+0000b800: 2028 7069 6473 2e50 5554 5f47 5241 442c   (pids.PUT_GRAD,
+0000b810: 2070 6964 732e 4745 545f 4752 4144 290a   pids.GET_GRAD).
+0000b820: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000b830: 2e62 6f75 6e64 5f73 796d 626f 6c73 203d  .bound_symbols =
+0000b840: 205b 0a20 2020 2020 2020 2020 2020 2062   [.            b
+0000b850: 7379 6d2e 6672 6f6d 5f62 7379 6d5f 7377  sym.from_bsym_sw
+0000b860: 6170 5f70 726f 7869 6573 2873 7761 706d  ap_proxies(swapm
+0000b870: 6170 2920 666f 7220 6273 796d 2069 6e20  ap) for bsym in 
+0000b880: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
+0000b890: 6d62 6f6c 7320 6966 206e 6f74 205f 6669  mbols if not _fi
+0000b8a0: 6c74 6572 2862 7379 6d29 0a20 2020 2020  lter(bsym).     
+0000b8b0: 2020 205d 0a0a 2020 2020 2020 2020 2320     ]..        # 
+0000b8c0: 5354 4550 2046 4f55 5220 2d2d 2d20 4f72  STEP FOUR --- Or
+0000b8d0: 6465 7273 2074 6865 206f 7065 7261 7469  ders the operati
+0000b8e0: 6f6e 730a 2020 2020 2020 2020 2320 544f  ons.        # TO
+0000b8f0: 444f 2043 6f6e 7369 6465 7220 616c 7465  DO Consider alte
+0000b900: 726e 6174 6976 6520 7363 6865 6475 6c69  rnative scheduli
+0000b910: 6e67 2061 6c67 6f72 6974 686d 732c 206d  ng algorithms, m
+0000b920: 6179 6265 2062 7920 7573 696e 6720 6772  aybe by using gr
+0000b930: 6170 6820 6665 6174 7572 6573 0a20 2020  aph features.   
+0000b940: 2020 2020 2023 2020 2053 6f6d 6520 6964       #   Some id
+0000b950: 6561 7320 6172 6520 6c6f 6f6b 696e 6720  eas are looking 
+0000b960: 6174 206d 656d 6f72 792d 7361 7669 6e67  at memory-saving
+0000b970: 206e 6f64 6573 2c20 616e 6420 6e6f 6465   nodes, and node
+0000b980: 7320 7769 7468 2061 2068 6967 6820 696e  s with a high in
+0000b990: 2d64 6567 7265 6520 6f72 2068 6967 6820  -degree or high 
+0000b9a0: 6f75 742d 6465 6772 6565 0a0a 2020 2020  out-degree..    
+0000b9b0: 2020 2020 2320 4372 6561 7465 7320 616e      # Creates an
+0000b9c0: 2069 6e69 7469 616c 2076 616c 6964 206f   initial valid o
+0000b9d0: 7264 6572 696e 6720 746f 2044 4345 2c20  rdering to DCE, 
+0000b9e0: 736f 2074 6861 7420 6164 6469 7469 6f6e  so that addition
+0000b9f0: 616c 206f 7264 6572 696e 6720 616e 616c  al ordering anal
+0000ba00: 7973 6973 2064 6f65 736e 2774 206e 6565  ysis doesn't nee
+0000ba10: 6420 746f 2063 6f6e 7369 6465 7220 616c  d to consider al
+0000ba20: 6c20 7379 6d62 6f6c 730a 2020 2020 2020  l symbols.      
+0000ba30: 2020 726f 6f74 732c 206c 6561 7665 7320    roots, leaves 
+0000ba40: 3d20 6273 796d 5f6c 6973 745f 746f 5f64  = bsym_list_to_d
+0000ba50: 6167 2867 7261 6474 7263 2e62 6f75 6e64  ag(gradtrc.bound
+0000ba60: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
+0000ba70: 2020 6f72 6465 7265 645f 6273 796d 7320    ordered_bsyms 
+0000ba80: 3d20 746f 706f 736f 7274 5f62 7379 6d5f  = toposort_bsym_
+0000ba90: 6461 6728 726f 6f74 732c 2054 4f50 4f53  dag(roots, TOPOS
+0000baa0: 4f52 545f 4f52 4445 522e 544f 505f 444f  ORT_ORDER.TOP_DO
+0000bab0: 574e 290a 2020 2020 2020 2020 6772 6164  WN).        grad
+0000bac0: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000bad0: 7320 3d20 6f72 6465 7265 645f 6273 796d  s = ordered_bsym
+0000bae0: 730a 2020 2020 2020 2020 6772 6164 7472  s.        gradtr
+0000baf0: 6320 3d20 6463 6528 6772 6164 7472 6329  c = dce(gradtrc)
+0000bb00: 0a0a 2020 2020 2020 2020 2320 4964 656e  ..        # Iden
+0000bb10: 7469 6669 6573 2074 6865 206f 7264 6572  tifies the order
+0000bb20: 206f 6620 426f 756e 6453 796d 626f 6c73   of BoundSymbols
+0000bb30: 2075 7369 6e67 2061 2022 4446 5320 616e   using a "DFS an
+0000bb40: 6420 6368 6169 6e22 2061 6c67 6f72 6974  d chain" algorit
+0000bb50: 686d 0a20 2020 2020 2020 2023 2054 4f44  hm.        # TOD
+0000bb60: 4f20 456c 6162 6f72 6174 6520 6f6e 2074  O Elaborate on t
+0000bb70: 6869 7320 616c 676f 7269 7468 6d20 616e  his algorithm an
+0000bb80: 6420 7468 6520 696d 706c 656d 656e 7461  d the implementa
+0000bb90: 7469 6f6e 0a20 2020 2020 2020 2072 6f6f  tion.        roo
+0000bba0: 7473 2c20 6c65 6176 6573 203d 2062 7379  ts, leaves = bsy
+0000bbb0: 6d5f 6c69 7374 5f74 6f5f 6461 6728 6772  m_list_to_dag(gr
+0000bbc0: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
+0000bbd0: 6f6c 7329 0a20 2020 2020 2020 2063 6865  ols).        che
+0000bbe0: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0000bbf0: 6c65 6e28 6c65 6176 6573 2920 3d3d 2031  len(leaves) == 1
+0000bc00: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+0000bc10: 6d62 6461 3a20 6622 4578 7065 6374 6564  mbda: f"Expected
+0000bc20: 206f 6e6c 7920 6f6e 6520 6c65 6166 206e   only one leaf n
+0000bc30: 6f64 6520 7768 656e 2073 6f72 7469 6e67  ode when sorting
+0000bc40: 2066 6f72 2067 7261 642c 2066 6f75 6e64   for grad, found
+0000bc50: 2074 6865 7265 2077 6572 6520 7b6c 656e   there were {len
+0000bc60: 286c 6561 7665 7329 7d20 6c65 6176 6573  (leaves)} leaves
+0000bc70: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
+0000bc80: 2020 2020 2028 6c65 6166 2c29 203d 206c       (leaf,) = l
+0000bc90: 6561 7665 730a 0a20 2020 2020 2020 2023  eaves..        #
+0000bca0: 2043 6f6d 7075 7465 7320 7468 6520 7465   Computes the te
+0000bcb0: 6e73 6f72 206d 656d 6f72 7920 7573 6564  nsor memory used
+0000bcc0: 2062 7920 7468 6520 6769 7665 6e20 7079   by the given py
+0000bcd0: 7472 6565 0a20 2020 2020 2020 2064 6566  tree.        def
+0000bce0: 206d 656d 6f72 795f 7573 6564 2870 7974   memory_used(pyt
+0000bcf0: 7265 6529 202d 3e20 696e 743a 0a20 2020  ree) -> int:.   
+0000bd00: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+0000bd10: 7573 653a 2069 6e74 203d 2030 0a0a 2020  use: int = 0..  
+0000bd20: 2020 2020 2020 2020 2020 6465 6620 636f            def co
+0000bd30: 756e 745f 6d65 6d6f 7279 5f75 7365 2878  unt_memory_use(x
+0000bd40: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000bd50: 2020 206e 6f6e 6c6f 6361 6c20 6d65 6d6f     nonlocal memo
+0000bd60: 7279 5f75 7365 0a20 2020 2020 2020 2020  ry_use.         
+0000bd70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000bd80: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
+0000bd90: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
+0000bda0: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
+0000bdb0: 5f75 7365 202b 3d20 782e 6474 7970 652e  _use += x.dtype.
+0000bdc0: 5f62 7974 6573 202a 2078 2e6e 756d 656c  _bytes * x.numel
+0000bdd0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
+0000bde0: 6565 5f6d 6170 2863 6f75 6e74 5f6d 656d  ee_map(count_mem
+0000bdf0: 6f72 795f 7573 652c 2070 7974 7265 6529  ory_use, pytree)
+0000be00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000be10: 7572 6e20 6d65 6d6f 7279 5f75 7365 0a0a  urn memory_use..
+0000be20: 2020 2020 2020 2020 2320 5472 7565 2077          # True w
+0000be30: 6865 6e20 6120 6e6f 6465 2069 7320 6120  hen a node is a 
+0000be40: 226c 696e 6b22 202d 2d20 6120 6e6f 6465  "link" -- a node
+0000be50: 2077 6974 6820 6f6e 6c79 206f 6e65 2063   with only one c
+0000be60: 6869 6c64 2061 6e64 2061 7420 6d6f 7374  hild and at most
+0000be70: 206f 6e65 2070 6172 656e 740a 2020 2020   one parent.    
+0000be80: 2020 2020 2320 2020 436f 6e63 6570 7475      #   Conceptu
+0000be90: 616c 6c79 2074 6865 206e 6f64 6520 6973  ally the node is
+0000bea0: 2061 2022 6c69 6e6b 2220 696e 2061 2063   a "link" in a c
+0000beb0: 6861 696e 206f 6620 6e6f 6465 7320 6c69  hain of nodes li
+0000bec0: 6b65 2041 202d 3e20 4220 2d3e 2043 0a20  ke A -> B -> C. 
+0000bed0: 2020 2020 2020 2064 6566 2069 735f 6c69         def is_li
+0000bee0: 6e6b 286e 3a20 4e6f 6465 2920 2d3e 2062  nk(n: Node) -> b
+0000bef0: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
+0000bf00: 205f 6973 5f6c 696e 6b20 3d20 6c65 6e28   _is_link = len(
+0000bf10: 6e2e 6368 696c 6472 656e 2920 3d3d 2031  n.children) == 1
+0000bf20: 2061 6e64 206c 656e 286e 2e70 6172 656e   and len(n.paren
+0000bf30: 7473 2920 3c3d 2031 0a20 2020 2020 2020  ts) <= 1.       
+0000bf40: 2020 2020 2072 6574 7572 6e20 5f69 735f       return _is_
+0000bf50: 6c69 6e6b 0a0a 2020 2020 2020 2020 636f  link..        co
+0000bf60: 756e 7465 723a 2069 6e74 203d 2030 0a0a  unter: int = 0..
+0000bf70: 2020 2020 2020 2020 6465 6620 5f63 6861          def _cha
+0000bf80: 696e 2863 3a20 6c69 7374 5b4e 6f64 655d  in(c: list[Node]
+0000bf90: 2c20 656e 643a 204e 6f64 6529 202d 3e20  , end: Node) -> 
+0000bfa0: 6c69 7374 5b4e 6f64 655d 3a0a 2020 2020  list[Node]:.    
+0000bfb0: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
+0000bfc0: 2063 6f75 6e74 6572 0a0a 2020 2020 2020   counter..      
+0000bfd0: 2020 2020 2020 2320 544f 444f 2045 7870        # TODO Exp
+0000bfe0: 6572 696d 656e 7420 7769 7468 206e 6f74  eriment with not
+0000bff0: 2061 6c77 6179 7320 6675 7369 6e67 2074   always fusing t
+0000c000: 6869 7320 696e 746f 2074 6865 2063 6f6e  his into the con
+0000c010: 7375 6d65 7220 2d2d 2074 6865 7265 2063  sumer -- there c
+0000c020: 6f75 6c64 2062 6520 616e 0a20 2020 2020  ould be an.     
+0000c030: 2020 2020 2020 2023 2020 2069 6e74 6572         #   inter
+0000c040: 6573 7469 6e67 206d 696e 6375 740a 2020  esting mincut.  
+0000c050: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+0000c060: 2049 6e20 7468 6973 2063 6173 6520 7468   In this case th
+0000c070: 6520 6368 6169 6e20 6361 6e6e 6f74 2062  e chain cannot b
+0000c080: 6520 6578 7465 6e64 6564 2c20 616e 6420  e extended, and 
+0000c090: 6974 7320 6f72 6967 696e 2069 7320 696e  its origin is in
+0000c0a0: 7075 7420 746f 2074 6865 2066 756e 6374  put to the funct
+0000c0b0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000c0c0: 2320 2020 736f 2074 6869 7320 6a75 7374  #   so this just
+0000c0d0: 2066 7573 6573 2069 7420 696e 746f 2074   fuses it into t
+0000c0e0: 6865 2063 6f6e 7375 6d65 720a 2020 2020  he consumer.    
+0000c0f0: 2020 2020 2020 2020 6966 206c 656e 2865          if len(e
+0000c100: 6e64 2e70 6172 656e 7473 2920 3d3d 2030  nd.parents) == 0
+0000c110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c120: 2020 666f 7220 6e20 696e 2063 3a0a 2020    for n in c:.  
+0000c130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c140: 2020 6e2e 6e75 6d62 6572 203d 2063 6f75    n.number = cou
+0000c150: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
+0000c160: 2020 2020 2020 2020 2063 6f75 6e74 6572           counter
+0000c170: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0000c180: 2020 2020 2020 7265 7475 726e 205b 5d0a        return [].
+0000c190: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0000c1a0: 4f54 4520 6c65 6e28 656e 642e 7061 7265  OTE len(end.pare
+0000c1b0: 6e74 7329 203d 3d20 3120 6f6e 2074 6869  nts) == 1 on thi
+0000c1c0: 7320 7061 7468 0a20 2020 2020 2020 2020  s path.         
+0000c1d0: 2020 2028 7061 7265 6e74 2c29 203d 2065     (parent,) = e
+0000c1e0: 6e64 2e70 6172 656e 7473 0a0a 2020 2020  nd.parents..    
+0000c1f0: 2020 2020 2020 2020 2320 4578 7465 6e64          # Extend
+0000c200: 7320 7468 6520 6368 6169 6e20 6966 2074  s the chain if t
+0000c210: 6865 2070 6172 656e 7420 6973 2061 206c  he parent is a l
+0000c220: 696e 6b0a 2020 2020 2020 2020 2020 2020  ink.            
+0000c230: 6966 2069 735f 6c69 6e6b 2870 6172 656e  if is_link(paren
+0000c240: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0000c250: 2020 2020 632e 6170 7065 6e64 2870 6172      c.append(par
+0000c260: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0000c270: 2020 2020 2072 6574 7572 6e20 5f63 6861       return _cha
+0000c280: 696e 2863 2c20 7061 7265 6e74 290a 0a20  in(c, parent).. 
+0000c290: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+0000c2a0: 4520 496e 2074 6869 7320 6361 7365 2074  E In this case t
+0000c2b0: 6865 2063 6861 696e 2068 6173 2061 2070  he chain has a p
+0000c2c0: 6172 656e 7420 7468 6174 2069 7320 6e6f  arent that is no
+0000c2d0: 7420 6120 6c69 6e6b 0a20 2020 2020 2020  t a link.       
+0000c2e0: 2020 2020 2023 2046 696e 6473 2074 6865       # Finds the
+0000c2f0: 206d 696e 6375 740a 2020 2020 2020 2020   mincut.        
+0000c300: 2020 2020 6d69 6e63 7574 5f69 6478 3a20      mincut_idx: 
+0000c310: 696e 7420 3d20 6c65 6e28 6329 0a20 2020  int = len(c).   
+0000c320: 2020 2020 2020 2020 206d 696e 5f6d 656d           min_mem
+0000c330: 6f72 795f 7573 6167 653a 2069 6e74 203d  ory_usage: int =
+0000c340: 206d 656d 6f72 795f 7573 6564 2870 6172   memory_used(par
+0000c350: 656e 742e 6273 796d 2e6f 7574 7075 7429  ent.bsym.output)
+0000c360: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0000c370: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
+0000c380: 6572 6174 6528 6329 3a0a 2020 2020 2020  erate(c):.      
+0000c390: 2020 2020 2020 2020 2020 6d65 6d20 3d20            mem = 
+0000c3a0: 6d65 6d6f 7279 5f75 7365 6428 6e2e 6273  memory_used(n.bs
+0000c3b0: 796d 2e6f 7574 7075 7429 0a20 2020 2020  ym.output).     
+0000c3c0: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
+0000c3d0: 6d20 3c20 6d69 6e5f 6d65 6d6f 7279 5f75  m < min_memory_u
+0000c3e0: 7361 6765 3a0a 2020 2020 2020 2020 2020  sage:.          
+0000c3f0: 2020 2020 2020 2020 2020 6d69 6e63 7574            mincut
+0000c400: 5f69 6478 203d 2069 6478 0a20 2020 2020  _idx = idx.     
+0000c410: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000c420: 696e 5f6d 656d 6f72 795f 7573 6167 6520  in_memory_usage 
+0000c430: 3d20 6d65 6d0a 0a20 2020 2020 2020 2020  = mem..         
+0000c440: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
+0000c450: 2065 6e75 6d65 7261 7465 2863 293a 0a20   enumerate(c):. 
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c470: 6620 6964 7820 3c20 6d69 6e63 7574 5f69  f idx < mincut_i
+0000c480: 6478 3a0a 2020 2020 2020 2020 2020 2020  dx:.            
+0000c490: 2020 2020 2020 2020 6e2e 6e75 6d62 6572          n.number
+0000c4a0: 203d 2063 6f75 6e74 6572 0a20 2020 2020   = counter.     
+0000c4b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000c4c0: 6f75 6e74 6572 202b 3d20 310a 0a20 2020  ounter += 1..   
+0000c4d0: 2020 2020 2020 2020 2023 2052 6574 7572           # Retur
+0000c4e0: 6e73 2074 6865 2070 726f 6475 6365 722d  ns the producer-
+0000c4f0: 7369 6465 2063 6861 696e 2063 7574 2069  side chain cut i
+0000c500: 6620 6974 2065 7869 7374 730a 2020 2020  f it exists.    
+0000c510: 2020 2020 2020 2020 6966 206d 696e 6375          if mincu
+0000c520: 745f 6964 7820 3c20 6c65 6e28 6329 3a0a  t_idx < len(c):.
+0000c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c540: 7265 7475 726e 205b 635b 6d69 6e63 7574  return [c[mincut
+0000c550: 5f69 6478 5d5d 0a20 2020 2020 2020 2020  _idx]].         
+0000c560: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000c570: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0000c580: 6d69 6e63 7574 5f69 6478 203d 3d20 6c65  mincut_idx == le
+0000c590: 6e28 6329 0a20 2020 2020 2020 2020 2020  n(c).           
+0000c5a0: 2020 2020 2072 6574 7572 6e20 656e 642e       return end.
+0000c5b0: 7061 7265 6e74 730a 0a20 2020 2020 2020  parents..       
+0000c5c0: 2064 6566 2063 6861 696e 5f6f 7574 286e   def chain_out(n
+0000c5d0: 3a20 4e6f 6465 2c20 7374 6163 6b3a 206c  : Node, stack: l
+0000c5e0: 6973 745b 4e6f 6465 5d29 202d 3e20 4e6f  ist[Node]) -> No
+0000c5f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000c600: 2320 5368 6f72 742d 6369 7263 7569 7473  # Short-circuits
+0000c610: 2069 6620 7468 6520 6f72 6967 696e 616c   if the original
+0000c620: 206e 6f64 6520 6e20 6361 6e6e 6f74 2062   node n cannot b
+0000c630: 6520 7061 7274 206f 6620 6120 6368 6169  e part of a chai
+0000c640: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+0000c650: 206e 6f74 2069 735f 6c69 6e6b 286e 293a   not is_link(n):
+0000c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c670: 2073 7461 636b 2e61 7070 656e 6428 6e29   stack.append(n)
+0000c680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c690: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0000c6a0: 2020 2020 2023 204e 4f54 4520 6973 5f6c       # NOTE is_l
+0000c6b0: 696e 6b28 6e29 203d 3d20 5472 7565 0a20  ink(n) == True. 
+0000c6c0: 2020 2020 2020 2020 2020 2070 6f73 745f             post_
+0000c6d0: 6368 6169 6e3a 206c 6973 745b 4e6f 6465  chain: list[Node
+0000c6e0: 5d20 3d20 5f63 6861 696e 285b 6e5d 2c20  ] = _chain([n], 
+0000c6f0: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
+0000c700: 666f 7220 7063 2069 6e20 706f 7374 5f63  for pc in post_c
+0000c710: 6861 696e 3a0a 2020 2020 2020 2020 2020  hain:.          
+0000c720: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
+0000c730: 6e64 2870 6329 0a0a 2020 2020 2020 2020  nd(pc)..        
+0000c740: 7374 6163 6b3a 206c 6973 745b 4e6f 6465  stack: list[Node
+0000c750: 5d20 3d20 5b6c 6561 665d 0a20 2020 2020  ] = [leaf].     
+0000c760: 2020 2077 6869 6c65 206c 656e 2873 7461     while len(sta
+0000c770: 636b 2920 3e20 303a 0a20 2020 2020 2020  ck) > 0:.       
+0000c780: 2020 2020 206e 3a20 4e6f 6465 203d 2073       n: Node = s
+0000c790: 7461 636b 2e70 6f70 2829 0a0a 2020 2020  tack.pop()..    
+0000c7a0: 2020 2020 2020 2020 6966 206e 2e6e 756d          if n.num
+0000c7b0: 6265 7220 6973 206e 6f74 204e 6f6e 653a  ber is not None:
+0000c7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c7d0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0000c7e0: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
+0000c7f0: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
+0000c800: 2020 2020 2020 636f 756e 7465 7220 2b3d        counter +=
+0000c810: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
+0000c820: 666f 7220 7020 696e 206e 2e70 6172 656e  for p in n.paren
+0000c830: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0000c840: 2020 2020 6368 6169 6e5f 6f75 7428 702c      chain_out(p,
+0000c850: 2073 7461 636b 290a 0a20 2020 2020 2020   stack)..       
+0000c860: 2064 6566 205f 7365 6c65 6374 6f72 2865   def _selector(e
+0000c870: 6c69 6769 626c 655f 6e6f 6465 733a 206c  ligible_nodes: l
+0000c880: 6973 745b 4e6f 6465 5d29 202d 3e20 696e  ist[Node]) -> in
+0000c890: 743a 0a20 2020 2020 2020 2020 2020 206d  t:.            m
+0000c8a0: 696e 5f69 6478 3a20 696e 7420 3d20 300a  in_idx: int = 0.
+0000c8b0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0000c8c0: 6e75 6d62 6572 3a20 696e 7420 3d20 656c  number: int = el
+0000c8d0: 6967 6962 6c65 5f6e 6f64 6573 5b30 5d2e  igible_nodes[0].
+0000c8e0: 6e75 6d62 6572 0a0a 2020 2020 2020 2020  number..        
+0000c8f0: 2020 2020 2320 4e4f 5445 2041 6c74 686f      # NOTE Altho
+0000c900: 7567 6820 7765 2776 6520 616c 7265 6164  ugh we've alread
+0000c910: 7920 7072 6f63 6573 7365 6420 7468 6520  y processed the 
+0000c920: 6669 7273 7420 656c 656d 656e 7420 6865  first element he
+0000c930: 7265 2c20 7468 6973 2073 7469 6c6c 0a20  re, this still. 
+0000c940: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
+0000c950: 6e75 6d65 7261 7465 7320 7468 6520 656e  numerates the en
+0000c960: 7469 7265 206c 6973 7420 6320 746f 2061  tire list c to a
+0000c970: 6c69 676e 2074 6865 2065 6e75 6d65 7261  lign the enumera
+0000c980: 7469 6f6e 2069 6478 2070 726f 7065 726c  tion idx properl
+0000c990: 790a 2020 2020 2020 2020 2020 2020 666f  y.            fo
+0000c9a0: 7220 6964 782c 206e 2069 6e20 656e 756d  r idx, n in enum
+0000c9b0: 6572 6174 6528 656c 6967 6962 6c65 5f6e  erate(eligible_n
+0000c9c0: 6f64 6573 293a 0a20 2020 2020 2020 2020  odes):.         
+0000c9d0: 2020 2020 2020 2063 6865 636b 286e 2e6e         check(n.n
+0000c9e0: 756d 6265 7220 6973 206e 6f74 204e 6f6e  umber is not Non
+0000c9f0: 652c 206c 616d 6264 613a 2066 2245 7870  e, lambda: f"Exp
+0000ca00: 6563 7465 6420 6561 6368 206e 6f64 6520  ected each node 
+0000ca10: 746f 2062 6520 6e75 6d62 6572 6564 2c20  to be numbered, 
+0000ca20: 6275 7420 7b6e 7d20 7761 7320 6e6f 7422  but {n} was not"
+0000ca30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000ca40: 2020 2069 6620 6e2e 6e75 6d62 6572 203c     if n.number <
+0000ca50: 206d 696e 5f6e 756d 6265 723a 0a20 2020   min_number:.   
+0000ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca70: 206d 696e 5f69 6478 203d 2069 6478 0a20   min_idx = idx. 
+0000ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca90: 2020 206d 696e 5f6e 756d 6265 7220 3d20     min_number = 
+0000caa0: 6e2e 6e75 6d62 6572 0a0a 2020 2020 2020  n.number..      
+0000cab0: 2020 2020 2020 7265 7475 726e 206d 696e        return min
+0000cac0: 5f69 6478 0a0a 2020 2020 2020 2020 736f  _idx..        so
+0000cad0: 7274 6564 5f62 7379 6d73 203d 2074 6f70  rted_bsyms = top
+0000cae0: 6f73 6f72 745f 6273 796d 5f64 6167 286c  osort_bsym_dag(l
+0000caf0: 6561 7665 732c 2074 6f70 6f73 6f72 745f  eaves, toposort_
+0000cb00: 6f72 6465 723d 544f 504f 534f 5254 5f4f  order=TOPOSORT_O
+0000cb10: 5244 4552 2e42 4f54 544f 4d5f 5550 2c20  RDER.BOTTOM_UP, 
+0000cb20: 7365 6c65 6374 6f72 3d5f 7365 6c65 6374  selector=_select
+0000cb30: 6f72 290a 2020 2020 2020 2020 6772 6164  or).        grad
+0000cb40: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000cb50: 7320 3d20 736f 7274 6564 5f62 7379 6d73  s = sorted_bsyms
+0000cb60: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000cb70: 203d 2064 6365 2867 7261 6474 7263 290a   = dce(gradtrc).
+0000cb80: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
+0000cb90: 436f 6e73 6964 6572 2068 6f77 2074 6f20  Consider how to 
+0000cba0: 6861 6e64 6c65 2067 7261 6420 772e 722e  handle grad w.r.
+0000cbb0: 742e 206f 6e6c 7920 736f 6d65 206f 7574  t. only some out
+0000cbc0: 7075 7473 202d 2d20 7368 6f75 6c64 2061  puts -- should a
+0000cbd0: 6c6c 2067 7261 640a 2020 2020 2020 2020  ll grad.        
+0000cbe0: 2320 2020 6f70 6572 6174 696f 6e73 2075  #   operations u
+0000cbf0: 7369 6e67 2074 6865 206f 7468 6572 206f  sing the other o
+0000cc00: 7574 7075 7420 6265 2072 656d 6f76 6564  utput be removed
+0000cc10: 3f20 5768 6174 206b 696e 6420 6f66 2061  ? What kind of a
+0000cc20: 7373 756d 7074 696f 6e20 646f 6573 2074  ssumption does t
+0000cc30: 6861 740a 2020 2020 2020 2020 2320 2020  hat.        #   
+0000cc40: 6d61 6b65 2061 626f 7574 2074 6865 2067  make about the g
+0000cc50: 7261 6420 7374 7275 6374 7572 653f 2050  rad structure? P
+0000cc60: 726f 6261 626c 7920 736f 6d65 206b 696e  robably some kin
+0000cc70: 6420 6f66 2069 6e64 6570 656e 6465 6e63  d of independenc
+0000cc80: 6520 6173 7375 6d70 7469 6f6e 3f20 4172  e assumption? Ar
+0000cc90: 650a 2020 2020 2020 2020 2320 2020 7468  e.        #   th
+0000cca0: 6572 6520 7072 6163 7469 6361 6c20 6578  ere practical ex
+0000ccb0: 616d 706c 6573 2077 6865 7265 2074 6861  amples where tha
+0000ccc0: 7427 7320 616e 2069 7373 7565 3f0a 0a20  t's an issue?.. 
+0000ccd0: 2020 2020 2020 2065 6e64 5f74 696d 655f         end_time_
+0000cce0: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
+0000ccf0: 7328 290a 2020 2020 2020 2020 656c 6170  s().        elap
+0000cd00: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
+0000cd10: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
+0000cd20: 745f 7469 6d65 5f6e 730a 2020 2020 2020  t_time_ns.      
+0000cd30: 2020 656c 6170 7365 645f 7469 6d65 5f6d    elapsed_time_m
+0000cd40: 696c 6c69 7320 3d20 656c 6170 7365 645f  illis = elapsed_
+0000cd50: 7469 6d65 5f6e 7320 2f2f 2031 3030 3030  time_ns // 10000
+0000cd60: 3030 0a20 2020 2020 2020 2067 7261 6474  00.        gradt
+0000cd70: 7263 2e73 6574 5f70 726f 7665 6e61 6e63  rc.set_provenanc
+0000cd80: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
+0000cd90: 6528 6622 4772 6164 2028 746f 6f6b 207b  e(f"Grad (took {
+0000cda0: 656c 6170 7365 645f 7469 6d65 5f6d 696c  elapsed_time_mil
+0000cdb0: 6c69 737d 206d 696c 6c69 7365 636f 6e64  lis} millisecond
+0000cdc0: 7329 2229 290a 0a20 2020 2020 2020 2072  s)"))..        r
+0000cdd0: 6574 7572 6e20 6772 6164 7472 630a 0a20  eturn gradtrc.. 
+0000cde0: 2020 2023 204e 4f54 4520 5468 6973 2069     # NOTE This i
+0000cdf0: 7320 6120 6b6c 7564 6765 2074 6f20 696e  s a kludge to in
+0000ce00: 6469 6361 7465 2074 6861 7420 7765 2073  dicate that we s
+0000ce10: 686f 756c 646e 2774 2075 7365 2050 7954  houldn't use PyT
+0000ce20: 6f72 6368 2773 2061 7574 6f67 7261 6420  orch's autograd 
+0000ce30: 6265 6361 7573 650a 2020 2020 2320 2020  because.    #   
+0000ce40: 7765 2772 6520 7573 696e 6720 6f75 7220  we're using our 
+0000ce50: 6f77 6e20 6175 746f 6772 6164 2074 7261  own autograd tra
+0000ce60: 6e73 666f 726d 0a20 2020 2063 666e 2e5f  nsform.    cfn._
+0000ce70: 7573 696e 675f 6772 6164 5f74 7261 6e73  using_grad_trans
+0000ce80: 666f 726d 203d 2054 7275 650a 0a20 2020  form = True..   
+0000ce90: 2072 6574 7572 6e20 6164 645f 7472 616e   return add_tran
+0000cea0: 7366 6f72 6d28 6366 6e2c 205f 6772 6164  sform(cfn, _grad
+0000ceb0: 5f74 7261 6e73 666f 726d 290a 0a0a 6465  _transform)...de
+0000cec0: 6620 6772 6164 5f76 3128 0a20 2020 2063  f grad_v1(.    c
+0000ced0: 666e 2c0a 2920 2d3e 2043 616c 6c61 626c  fn,.) -> Callabl
+0000cee0: 653a 0a20 2020 2064 6566 2067 7261 6428  e:.    def grad(
+0000cef0: 6675 6e63 293a 0a20 2020 2020 2020 2064  func):.        d
+0000cf00: 6566 2067 7261 645f 6675 6e63 282a 6172  ef grad_func(*ar
+0000cf10: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000cf20: 2020 2020 2020 2020 2020 205f 2c20 6772             _, gr
+0000cf30: 6164 7320 3d20 7661 6c75 655f 616e 645f  ads = value_and_
+0000cf40: 6772 6164 2866 756e 6329 282a 6172 6773  grad(func)(*args
+0000cf50: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0000cf60: 2020 2020 2020 2020 6772 6164 7320 3d20          grads = 
+0000cf70: 5b67 2066 6f72 2067 2069 6e20 6772 6164  [g for g in grad
+0000cf80: 7320 6966 2067 2069 7320 6e6f 7420 4e6f  s if g is not No
+0000cf90: 6e65 5d0a 2020 2020 2020 2020 2020 2020  ne].            
+0000cfa0: 7265 7475 726e 2067 7261 6473 0a0a 2020  return grads..  
+0000cfb0: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
+0000cfc0: 645f 6675 6e63 0a0a 2020 2020 6465 6620  d_func..    def 
+0000cfd0: 5f67 7261 645f 7472 616e 7366 6f72 6d28  _grad_transform(
+0000cfe0: 7472 633a 2054 7261 6365 2c20 2a2c 2065  trc: Trace, *, e
+0000cff0: 7865 6375 746f 7273 5f6c 6973 743a 2053  xecutors_list: S
+0000d000: 6571 7565 6e63 655b 416e 795d 2920 2d3e  equence[Any]) ->
+0000d010: 2054 7261 6365 3a0a 2020 2020 2020 2020   Trace:.        
+0000d020: 6772 6164 7472 6320 3d20 636f 6e73 7472  gradtrc = constr
+0000d030: 7563 745f 7472 6163 6528 2928 6772 6164  uct_trace()(grad
+0000d040: 2874 7263 2e70 7974 686f 6e5f 6361 6c6c  (trc.python_call
+0000d050: 6162 6c65 2829 292c 202a 7472 632e 6172  able()), *trc.ar
+0000d060: 6773 2c20 2a2a 7472 632e 6b77 6172 6773  gs, **trc.kwargs
+0000d070: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000d080: 2067 7261 6474 7263 0a0a 2020 2020 6366   gradtrc..    cf
+0000d090: 6e2e 5f75 7369 6e67 5f67 7261 645f 7472  n._using_grad_tr
+0000d0a0: 616e 7366 6f72 6d20 3d20 5472 7565 0a20  ansform = True. 
+0000d0b0: 2020 2072 6574 7572 6e20 6164 645f 7472     return add_tr
+0000d0c0: 616e 7366 6f72 6d28 6366 6e2c 205f 6772  ansform(cfn, _gr
+0000d0d0: 6164 5f74 7261 6e73 666f 726d 290a 0a0a  ad_transform)...
+0000d0e0: 636c 6173 7320 5472 616e 7366 6f72 6d73  class Transforms
+0000d0f0: 2845 6e75 6d29 3a0a 2020 2020 4964 656e  (Enum):.    Iden
+0000d100: 7469 7479 4f70 203d 2061 7574 6f28 290a  tityOp = auto().
+0000d110: 2020 2020 566d 6170 4f70 203d 2061 7574      VmapOp = aut
+0000d120: 6f28 290a 2020 2020 4a76 704f 7020 3d20  o().    JvpOp = 
+0000d130: 6175 746f 2829 0a20 2020 2056 6a70 4f70  auto().    VjpOp
+0000d140: 203d 2061 7574 6f28 290a 0a0a 406c 7275   = auto()...@lru
+0000d150: 5f63 6163 6865 286d 6178 7369 7a65 3d4e  _cache(maxsize=N
+0000d160: 6f6e 6529 0a64 6566 2073 796d 626f 6c5f  one).def symbol_
+0000d170: 746f 5f65 7661 6c28 626f 756e 645f 7379  to_eval(bound_sy
+0000d180: 6d62 6f6c 293a 0a20 2020 2022 2222 4d61  mbol):.    """Ma
+0000d190: 7020 6120 426f 756e 6453 796d 626f 6c20  p a BoundSymbol 
+0000d1a0: 746f 2061 2066 756e 6374 696f 6e20 7468  to a function th
+0000d1b0: 6174 2065 7661 6c75 6174 6573 2069 742e  at evaluates it.
+0000d1c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0000d1d0: 2020 2020 626f 756e 645f 7379 6d62 6f6c      bound_symbol
+0000d1e0: 3a20 426f 756e 6453 796d 626f 6c20 746f  : BoundSymbol to
+0000d1f0: 206d 6170 0a20 2020 2022 2222 0a20 2020   map.    """.   
+0000d200: 2023 2053 796d 626f 6c20 6973 2063 616c   # Symbol is cal
+0000d210: 6c61 626c 650a 2020 2020 7265 7475 726e  lable.    return
+0000d220: 2062 6f75 6e64 5f73 796d 626f 6c2e 7379   bound_symbol.sy
+0000d230: 6d0a 0a0a 2320 544f 444f 3a20 4375 7272  m...# TODO: Curr
+0000d240: 656e 746c 7920 7765 2075 7365 2074 7261  ently we use tra
+0000d250: 6365 2e61 7267 7320 616e 6420 7472 6163  ce.args and trac
+0000d260: 652e 6b77 6172 6773 2074 6f20 6765 7420  e.kwargs to get 
+0000d270: 7468 6520 6172 6775 6d65 6e74 730a 2320  the arguments.# 
+0000d280: 4d61 7962 6520 7765 2073 686f 756c 6420  Maybe we should 
+0000d290: 7573 6520 7468 6573 6520 696e 7374 6561  use these instea
+0000d2a0: 640a 7472 616e 7366 6f72 6d5f 736b 6970  d.transform_skip
+0000d2b0: 5f6c 6973 7420 3d20 280a 2020 2020 7072  _list = (.    pr
+0000d2c0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+0000d2d0: 434b 5f45 4d50 5459 5f44 4943 542c 0a20  CK_EMPTY_DICT,. 
+0000d2e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+0000d2f0: 2e55 4e50 4143 4b5f 4b45 592c 0a20 2020  .UNPACK_KEY,.   
+0000d300: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
+0000d310: 4e50 4143 4b5f 5345 5155 454e 4345 2c0a  NPACK_SEQUENCE,.
+0000d320: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0000d330: 732e 554e 5041 434b 5f54 5249 5649 414c  s.UNPACK_TRIVIAL
+0000d340: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+0000d350: 4944 732e 5245 5455 524e 2c0a 290a 0a0a  IDs.RETURN,.)...
+0000d360: 6465 6620 6576 616c 5f74 7261 6365 2874  def eval_trace(t
+0000d370: 7261 6365 2c20 2a61 7267 732c 2073 796d  race, *args, sym
+0000d380: 626f 6c5f 6d61 7070 6572 3d73 796d 626f  bol_mapper=symbo
+0000d390: 6c5f 746f 5f65 7661 6c2c 2077 6974 685f  l_to_eval, with_
+0000d3a0: 656e 763d 4661 6c73 652c 202a 2a6b 7761  env=False, **kwa
+0000d3b0: 7267 7329 3a0a 2020 2020 2222 2245 7661  rgs):.    """Eva
+0000d3c0: 6c75 6174 6520 6120 7472 6163 652e 0a0a  luate a trace...
+0000d3d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000d3e0: 2020 7472 6163 653a 2074 7261 6365 2074    trace: trace t
+0000d3f0: 6f20 6576 616c 7561 7465 0a20 2020 2020  o evaluate.     
+0000d400: 2020 202a 6172 6773 3a20 6172 6775 6d65     *args: argume
+0000d410: 6e74 7320 746f 2065 7661 6c75 6174 6520  nts to evaluate 
+0000d420: 7468 6520 7472 6163 6520 7769 7468 0a20  the trace with. 
+0000d430: 2020 2020 2020 2073 796d 626f 6c5f 6d61         symbol_ma
+0000d440: 7070 6572 3a20 6675 6e63 7469 6f6e 2074  pper: function t
+0000d450: 6861 7420 6d61 7073 2061 2073 796d 626f  hat maps a symbo
+0000d460: 6c20 746f 2061 2066 756e 6374 696f 6e20  l to a function 
+0000d470: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
+0000d480: 740a 2020 2020 2020 2020 2a2a 6b77 6172  t.        **kwar
+0000d490: 6773 3a20 6b65 7977 6f72 6420 6172 6775  gs: keyword argu
+0000d4a0: 6d65 6e74 7320 746f 2065 7661 6c75 6174  ments to evaluat
+0000d4b0: 6520 7468 6520 7472 6163 6520 7769 7468  e the trace with
+0000d4c0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0000d4d0: 2020 2020 2020 2072 6573 756c 7420 6f66         result of
+0000d4e0: 2065 7661 6c75 6174 696e 6720 7468 6520   evaluating the 
+0000d4f0: 7472 6163 650a 2020 2020 2222 220a 2020  trace.    """.  
+0000d500: 2020 656e 7620 3d20 7b7d 0a0a 2020 2020    env = {}..    
+0000d510: 6465 6620 7265 6164 2878 3a20 5661 7269  def read(x: Vari
+0000d520: 6162 6c65 293a 0a20 2020 2020 2020 2069  able):.        i
+0000d530: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0000d540: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
+0000d550: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
+0000d560: 765b 782e 6e61 6d65 5d0a 2020 2020 2020  v[x.name].      
+0000d570: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000d580: 2020 2020 7265 7475 726e 2078 0a0a 2020      return x..  
+0000d590: 2020 6465 6620 7772 6974 6528 763a 2056    def write(v: V
+0000d5a0: 6172 6961 626c 652c 2076 616c 3a20 416e  ariable, val: An
+0000d5b0: 792c 2061 6c6c 6f77 5f64 7570 6c69 6361  y, allow_duplica
+0000d5c0: 7465 733d 4661 6c73 6529 202d 3e20 4e6f  tes=False) -> No
+0000d5d0: 6e65 3a0a 2020 2020 2020 2020 6966 206e  ne:.        if n
+0000d5e0: 6f74 2069 7369 6e73 7461 6e63 6528 762c  ot isinstance(v,
+0000d5f0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
+0000d600: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000d610: 2020 2020 2020 2023 2044 7570 6c69 6361         # Duplica
+0000d620: 7465 7320 6172 6520 616c 6c6f 7765 6420  tes are allowed 
+0000d630: 616e 6420 6f76 6572 7772 6974 7465 6e0a  and overwritten.
+0000d640: 2020 2020 2020 2020 6966 2076 2e6e 616d          if v.nam
+0000d650: 6520 696e 2065 6e76 3a0a 2020 2020 2020  e in env:.      
+0000d660: 2020 2020 2020 6966 2061 6c6c 6f77 5f64        if allow_d
+0000d670: 7570 6c69 6361 7465 733a 0a20 2020 2020  uplicates:.     
+0000d680: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d690: 6e0a 2020 2020 2020 2020 2020 2020 7261  n.            ra
+0000d6a0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+0000d6b0: 2256 6172 6961 626c 6520 7b76 2e6e 616d  "Variable {v.nam
+0000d6c0: 657d 2069 7320 6265 696e 6720 6f76 6572  e} is being over
+0000d6d0: 7772 6974 7465 6e20 7468 6973 2069 7320  written this is 
+0000d6e0: 6e6f 7420 616c 6c6f 7765 6422 290a 2020  not allowed").  
+0000d6f0: 2020 2020 2020 656e 765b 762e 6e61 6d65        env[v.name
+0000d700: 5d20 3d20 7661 6c0a 0a20 2020 2073 6166  ] = val..    saf
+0000d710: 655f 6d61 705f 666c 6174 2877 7269 7465  e_map_flat(write
+0000d720: 2c20 6c69 7374 2874 7261 6365 2e61 7267  , list(trace.arg
+0000d730: 7329 2c20 6c69 7374 2861 7267 7329 290a  s), list(args)).
+0000d740: 2020 2020 7361 6665 5f6d 6170 5f66 6c61      safe_map_fla
+0000d750: 7428 7772 6974 652c 206c 6973 7428 7472  t(write, list(tr
+0000d760: 6163 652e 6b77 6172 6773 2e76 616c 7565  ace.kwargs.value
+0000d770: 7328 2929 2c20 6c69 7374 286b 7761 7267  s()), list(kwarg
+0000d780: 732e 7661 6c75 6573 2829 2929 0a0a 2020  s.values()))..  
+0000d790: 2020 666f 7220 7379 6d62 6f6c 2069 6e20    for symbol in 
+0000d7a0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0000d7b0: 6f6c 733a 0a20 2020 2020 2020 2069 6620  ols:.        if 
+0000d7c0: 7379 6d62 6f6c 2e73 796d 2e69 6420 696e  symbol.sym.id in
+0000d7d0: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
+0000d7e0: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+0000d7f0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0000d800: 2020 2061 7267 7320 3d20 7472 6565 5f6d     args = tree_m
+0000d810: 6170 2872 6561 642c 2073 796d 626f 6c2e  ap(read, symbol.
+0000d820: 6172 6773 290a 2020 2020 2020 2020 6b77  args).        kw
+0000d830: 6172 6773 203d 2074 7265 655f 6d61 7028  args = tree_map(
+0000d840: 7265 6164 2c20 7379 6d62 6f6c 2e6b 7761  read, symbol.kwa
+0000d850: 7267 7329 0a20 2020 2020 2020 2070 7269  rgs).        pri
+0000d860: 6d5f 6675 6e63 203d 2073 796d 626f 6c5f  m_func = symbol_
+0000d870: 6d61 7070 6572 2873 796d 626f 6c29 0a20  mapper(symbol). 
+0000d880: 2020 2020 2020 2069 6620 7072 696d 5f66         if prim_f
+0000d890: 756e 6320 6973 204e 6f6e 653a 0a20 2020  unc is None:.   
+0000d8a0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0000d8b0: 650a 2020 2020 2020 2020 7265 7375 6c74  e.        result
+0000d8c0: 203d 2070 7269 6d5f 6675 6e63 282a 6172   = prim_func(*ar
+0000d8d0: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
+0000d8e0: 2020 2020 2020 7361 6665 5f6d 6170 5f66        safe_map_f
+0000d8f0: 6c61 7428 7772 6974 652c 206c 6973 7428  lat(write, list(
+0000d900: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
+0000d910: 6c2e 6f75 7470 7574 2929 2c20 6c69 7374  l.output)), list
+0000d920: 2873 6571 7565 6e63 6966 7928 7265 7375  (sequencify(resu
+0000d930: 6c74 2929 290a 0a20 2020 2069 6620 7769  lt)))..    if wi
+0000d940: 7468 5f65 6e76 3a0a 2020 2020 2020 2020  th_env:.        
+0000d950: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
+0000d960: 7265 6164 2c20 7472 6163 652e 6f75 7470  read, trace.outp
+0000d970: 7574 292c 2065 6e76 0a0a 2020 2020 7265  ut), env..    re
+0000d980: 7475 726e 2074 7265 655f 6d61 7028 7265  turn tree_map(re
+0000d990: 6164 2c20 7472 6163 652e 6f75 7470 7574  ad, trace.output
+0000d9a0: 290a 0a0a 6465 6620 5f69 6465 6e74 6974  )...def _identit
+0000d9b0: 795f 6361 6c6c 5f6d 6574 6166 756e 6328  y_call_metafunc(
+0000d9c0: 2a61 7267 732c 2074 7261 6365 3a20 5472  *args, trace: Tr
+0000d9d0: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
+0000d9e0: 2020 2020 7769 7468 2064 6574 6163 6865      with detache
+0000d9f0: 645f 7472 6163 6528 293a 0a20 2020 2020  d_trace():.     
+0000da00: 2020 2072 6574 7572 6e20 6576 616c 5f74     return eval_t
+0000da10: 7261 6365 2874 7261 6365 2c20 2a61 7267  race(trace, *arg
+0000da20: 732c 202a 2a6b 7761 7267 7329 0a0a 0a69  s, **kwargs)...i
+0000da30: 6465 6e74 6974 795f 6361 6c6c 203d 2053  dentity_call = S
+0000da40: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
+0000da50: 726d 732e 4964 656e 7469 7479 4f70 2c20  rms.IdentityOp, 
+0000da60: 6e61 6d65 3d22 6964 656e 7469 7479 5f63  name="identity_c
+0000da70: 616c 6c22 2c20 6d65 7461 3d5f 6964 656e  all", meta=_iden
+0000da80: 7469 7479 5f63 616c 6c5f 6d65 7461 6675  tity_call_metafu
+0000da90: 6e63 290a 0a0a 6465 6620 6964 656e 7469  nc)...def identi
+0000daa0: 7479 2866 756e 6329 3a0a 2020 2020 2222  ty(func):.    ""
+0000dab0: 2249 6465 6e74 6974 7920 7472 616e 7366  "Identity transf
+0000dac0: 6f72 6d20 666f 7220 6120 5468 756e 6465  orm for a Thunde
+0000dad0: 7220 6675 6e63 7469 6f6e 2e0a 0a20 2020  r function...   
+0000dae0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+0000daf0: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+0000db00: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
+0000db10: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+0000db20: 726d 6564 2e0a 2020 2020 2222 220a 0a20  rmed..    """.. 
+0000db30: 2020 2064 6566 2077 7261 7070 6572 282a     def wrapper(*
+0000db40: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+0000db50: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
+0000db60: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0000db70: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
+0000db80: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+0000db90: 2020 7265 7475 726e 2069 6465 6e74 6974    return identit
+0000dba0: 795f 6361 6c6c 282a 6172 6773 2c20 2a2a  y_call(*args, **
+0000dbb0: 6b77 6172 6773 2c20 7472 6163 653d 7472  kwargs, trace=tr
+0000dbc0: 6163 6529 0a0a 2020 2020 7265 7475 726e  ace)..    return
+0000dbd0: 2077 7261 7070 6572 0a0a 0a64 6566 205f   wrapper...def _
+0000dbe0: 6964 656e 7469 7479 5f63 616c 6c5f 7079  identity_call_py
+0000dbf0: 746f 7263 6828 2a61 7267 732c 2074 7261  torch(*args, tra
+0000dc00: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
+0000dc10: 7267 7329 3a0a 2020 2020 696d 706f 7274  rgs):.    import
+0000dc20: 2074 6f72 6368 0a0a 2020 2020 6465 6620   torch..    def 
+0000dc30: 7379 6d62 6f6c 5f6d 6170 7065 7228 6f70  symbol_mapper(op
+0000dc40: 293a 0a20 2020 2020 2020 2069 6620 6f70  ):.        if op
+0000dc50: 2e6f 7020 3d3d 2054 7261 6e73 666f 726d  .op == Transform
+0000dc60: 732e 4964 656e 7469 7479 4f70 3a0a 2020  s.IdentityOp:.  
+0000dc70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000dc80: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+0000dc90: 7079 746f 7263 680a 0a20 2020 2020 2020  pytorch..       
+0000dca0: 2074 6f72 6368 5f6f 7020 3d20 6f70 735f   torch_op = ops_
+0000dcb0: 746f 5f74 6f72 6368 5f6f 7073 5f6d 6170  to_torch_ops_map
+0000dcc0: 5b6f 702e 6f70 5d0a 2020 2020 2020 2020  [op.op].        
+0000dcd0: 6966 2069 7369 6e73 7461 6e63 6528 746f  if isinstance(to
+0000dce0: 7263 685f 6f70 2c20 7374 7229 3a0a 2020  rch_op, str):.  
+0000dcf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000dd00: 2067 6574 6174 7472 2874 6f72 6368 2c20   getattr(torch, 
+0000dd10: 746f 7263 685f 6f70 2e73 7472 6970 2822  torch_op.strip("
+0000dd20: 7079 746f 7263 682e 2229 290a 2020 2020  pytorch.")).    
+0000dd30: 2020 2020 7265 7475 726e 2074 6f72 6368      return torch
+0000dd40: 5f6f 700a 0a20 2020 2077 6974 6820 6465  _op..    with de
+0000dd50: 7461 6368 6564 5f74 7261 6365 2829 3a0a  tached_trace():.
+0000dd60: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+0000dd70: 7661 6c5f 7472 6163 6528 7472 6163 652c  val_trace(trace,
+0000dd80: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+0000dd90: 2c20 7379 6d62 6f6c 5f6d 6170 7065 723d  , symbol_mapper=
+0000dda0: 7379 6d62 6f6c 5f6d 6170 7065 7229 0a0a  symbol_mapper)..
+0000ddb0: 0a23 2052 6567 6973 7465 7220 7468 6520  .# Register the 
+0000ddc0: 6964 656e 7469 7479 2063 616c 6c20 666f  identity call fo
+0000ddd0: 7220 5079 546f 7263 6820 6578 6563 7574  r PyTorch execut
+0000dde0: 6f72 2e0a 2320 6f70 735f 746f 5f74 6f72  or..# ops_to_tor
+0000ddf0: 6368 5f6f 7073 5f6d 6170 5b54 7261 6e73  ch_ops_map[Trans
+0000de00: 666f 726d 732e 4964 656e 7469 7479 4f70  forms.IdentityOp
+0000de10: 5d20 3d20 5f69 6465 6e74 6974 795f 6361  ] = _identity_ca
+0000de20: 6c6c 5f70 7974 6f72 6368 0a0a 0a23 2056  ll_pytorch...# V
+0000de30: 4d41 5020 7472 616e 7366 6f72 6d0a 2320  MAP transform.# 
+0000de40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  -------------...
+0000de50: 636c 6173 7320 4e6f 744d 6170 7065 643a  class NotMapped:
+0000de60: 0a20 2020 2022 2222 5265 7072 6573 656e  .    """Represen
+0000de70: 7473 2061 206e 6f6e 2d62 6174 6368 6564  ts a non-batched
+0000de80: 2064 696d 656e 7369 6f6e 2e22 2222 0a0a   dimension."""..
+0000de90: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
+0000dea0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000deb0: 7265 7475 726e 2022 6e6f 745f 6d61 7070  return "not_mapp
+0000dec0: 6564 220a 0a0a 4064 6174 6163 6c61 7373  ed"...@dataclass
+0000ded0: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
+0000dee0: 6173 7320 4261 7463 6865 6456 616c 7565  ass BatchedValue
+0000def0: 3a0a 2020 2020 2222 2242 6174 6368 6564  :.    """Batched
+0000df00: 2076 616c 7565 2066 6f72 2074 6865 2076   value for the v
+0000df10: 6d61 7020 7472 616e 7366 6f72 6d2e 0a0a  map transform...
+0000df20: 2020 2020 4174 7472 6962 7574 6573 3a0a      Attributes:.
+0000df30: 2020 2020 2020 2020 7661 6c75 653a 2042          value: B
+0000df40: 6174 6368 6564 2076 616c 7565 2e0a 2020  atched value..  
+0000df50: 2020 2020 2020 6261 7463 685f 6469 6d3a        batch_dim:
+0000df60: 2042 6174 6368 696e 6720 6469 6d65 6e73   Batching dimens
+0000df70: 696f 6e20 6f72 206e 6f74 5f6d 6170 7065  ion or not_mappe
+0000df80: 640a 2020 2020 2222 220a 0a20 2020 2076  d.    """..    v
+0000df90: 616c 7565 3a20 416e 790a 2020 2020 6261  alue: Any.    ba
+0000dfa0: 7463 685f 6469 6d3a 2069 6e74 207c 204e  tch_dim: int | N
+0000dfb0: 6f74 4d61 7070 6564 0a0a 2020 2020 6465  otMapped..    de
+0000dfc0: 6620 5f5f 6974 6572 5f5f 2873 656c 6629  f __iter__(self)
+0000dfd0: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+0000dfe0: 7365 6c66 2e76 616c 7565 0a20 2020 2020  self.value.     
+0000dff0: 2020 2079 6965 6c64 2073 656c 662e 6261     yield self.ba
+0000e000: 7463 685f 6469 6d0a 0a0a 6465 6620 7061  tch_dim...def pa
+0000e010: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
+0000e020: 6c75 6528 7061 6972 293a 0a20 2020 2022  lue(pair):.    "
+0000e030: 2222 436f 6e76 6572 7473 2061 2070 6169  ""Converts a pai
+0000e040: 7220 746f 2061 2042 6174 6368 6564 5661  r to a BatchedVa
+0000e050: 6c75 652e 0a0a 2020 2020 4172 6773 3a0a  lue...    Args:.
+0000e060: 2020 2020 2020 2020 7061 6972 2028 5365          pair (Se
+0000e070: 7175 656e 6365 293a 2050 6169 7220 746f  quence): Pair to
+0000e080: 2063 6f6e 7665 7274 2e0a 0a20 2020 2052   convert...    R
+0000e090: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000e0a0: 4261 7463 6865 6456 616c 7565 3a20 4261  BatchedValue: Ba
+0000e0b0: 7463 6865 6456 616c 7565 2072 6570 7265  tchedValue repre
+0000e0c0: 7365 6e74 6174 696f 6e20 6f66 2074 6865  sentation of the
+0000e0d0: 2070 6169 722e 0a20 2020 2022 2222 0a20   pair..    """. 
+0000e0e0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000e0f0: 2870 6169 722c 2042 6174 6368 6564 5661  (pair, BatchedVa
+0000e100: 6c75 6529 3a0a 2020 2020 2020 2020 7265  lue):.        re
+0000e110: 7475 726e 2070 6169 720a 2020 2020 656c  turn pair.    el
+0000e120: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
+0000e130: 7274 2069 7369 6e73 7461 6e63 6528 7061  rt isinstance(pa
+0000e140: 6972 2c20 5365 7175 656e 6365 2920 616e  ir, Sequence) an
+0000e150: 6420 6c65 6e28 7061 6972 2920 3d3d 2032  d len(pair) == 2
+0000e160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000e170: 4261 7463 6865 6456 616c 7565 282a 7061  BatchedValue(*pa
+0000e180: 6972 290a 0a0a 6465 6620 7665 6374 6f72  ir)...def vector
+0000e190: 697a 6564 5f62 6174 6368 6572 2870 7269  ized_batcher(pri
+0000e1a0: 6d2c 2061 7869 735f 7369 7a65 2c20 6261  m, axis_size, ba
+0000e1b0: 7463 6865 645f 7661 6c75 6573 2c20 2a2a  tched_values, **
+0000e1c0: 6b77 6172 6773 293a 0a20 2020 2062 6174  kwargs):.    bat
+0000e1d0: 6368 5f64 696d 203d 2062 6174 6368 6564  ch_dim = batched
+0000e1e0: 5f76 616c 7565 735b 305d 2e62 6174 6368  _values[0].batch
+0000e1f0: 5f64 696d 0a20 2020 2061 7373 6572 7420  _dim.    assert 
+0000e200: 616c 6c28 0a20 2020 2020 2020 2062 6174  all(.        bat
+0000e210: 6368 5f64 696d 203d 3d20 6276 2e62 6174  ch_dim == bv.bat
+0000e220: 6368 5f64 696d 2066 6f72 2062 7620 696e  ch_dim for bv in
+0000e230: 2062 6174 6368 6564 5f76 616c 7565 735b   batched_values[
+0000e240: 313a 5d0a 2020 2020 292c 2066 2260 7665  1:].    ), f"`ve
+0000e250: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
+0000e260: 6020 676f 7420 6469 6666 6572 656e 7420  ` got different 
+0000e270: 6261 7463 6865 6420 6469 6d65 6e73 696f  batched dimensio
+0000e280: 6e73 207b 5b62 762e 6261 7463 685f 6469  ns {[bv.batch_di
+0000e290: 6d20 666f 7220 6276 2069 6e20 6261 7463  m for bv in batc
+0000e2a0: 6865 645f 7661 6c75 6573 5d7d 220a 2020  hed_values]}".  
+0000e2b0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
+0000e2c0: 5661 6c75 6528 7072 696d 282a 5b62 762e  Value(prim(*[bv.
+0000e2d0: 7661 6c75 6520 666f 7220 6276 2069 6e20  value for bv in 
+0000e2e0: 6261 7463 6865 645f 7661 6c75 6573 5d2c  batched_values],
+0000e2f0: 202a 2a6b 7761 7267 7329 2c20 6261 7463   **kwargs), batc
+0000e300: 685f 6469 6d29 0a0a 0a6e 6f74 5f6d 6170  h_dim)...not_map
+0000e310: 7065 6420 3d20 4e6f 744d 6170 7065 6428  ped = NotMapped(
+0000e320: 290a 0a0a 6465 6620 6d6f 7665 6469 6d28  )...def movedim(
+0000e330: 782c 2073 7263 3a20 696e 742c 2064 7374  x, src: int, dst
+0000e340: 3a20 696e 7429 3a0a 2020 2020 7065 726d  : int):.    perm
+0000e350: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
+0000e360: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
+0000e370: 6920 213d 2073 7263 5d0a 2020 2020 7065  i != src].    pe
+0000e380: 726d 2e69 6e73 6572 7428 6473 742c 2073  rm.insert(dst, s
+0000e390: 7263 290a 2020 2020 7265 7475 726e 2070  rc).    return p
+0000e3a0: 7269 6d73 2e74 7261 6e73 706f 7365 2878  rims.transpose(x
+0000e3b0: 2c20 7475 706c 6528 7065 726d 2929 0a0a  , tuple(perm))..
+0000e3c0: 0a64 6566 206d 6f76 655f 6261 7463 685f  .def move_batch_
+0000e3d0: 6469 6d28 6178 6973 5f73 697a 652c 2073  dim(axis_size, s
+0000e3e0: 7263 2c20 6473 742c 2078 293a 0a20 2020  rc, dst, x):.   
+0000e3f0: 2069 6620 7372 6320 6973 206e 6f74 5f6d   if src is not_m
+0000e400: 6170 7065 643a 0a20 2020 2020 2020 2069  apped:.        i
+0000e410: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0000e420: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
+0000e430: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
+0000e440: 2020 2020 2020 7461 7267 6574 5f73 6861        target_sha
+0000e450: 7065 203d 206c 6973 7428 782e 7368 6170  pe = list(x.shap
+0000e460: 6529 0a20 2020 2020 2020 2074 6172 6765  e).        targe
+0000e470: 745f 7368 6170 652e 696e 7365 7274 2864  t_shape.insert(d
+0000e480: 7374 2c20 6178 6973 5f73 697a 6529 0a20  st, axis_size). 
+0000e490: 2020 2020 2020 2062 6361 7374 5f64 696d         bcast_dim
+0000e4a0: 7320 3d20 6c69 7374 2872 616e 6765 286c  s = list(range(l
+0000e4b0: 656e 2874 6172 6765 745f 7368 6170 6529  en(target_shape)
+0000e4c0: 2929 0a20 2020 2020 2020 2062 6361 7374  )).        bcast
+0000e4d0: 5f64 696d 732e 706f 7028 6473 7429 0a20  _dims.pop(dst). 
+0000e4e0: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
+0000e4f0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
+0000e500: 5f64 696d 2878 2c20 7461 7267 6574 5f73  _dim(x, target_s
+0000e510: 6861 7065 2c20 6263 6173 745f 6469 6d73  hape, bcast_dims
+0000e520: 290a 2020 2020 656c 6966 2073 7263 203d  ).    elif src =
+0000e530: 3d20 6473 743a 0a20 2020 2020 2020 2072  = dst:.        r
+0000e540: 6574 7572 6e20 780a 2020 2020 656c 7365  eturn x.    else
+0000e550: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000e560: 206d 6f76 6564 696d 2878 2c20 7372 632c   movedim(x, src,
+0000e570: 2064 7374 290a 0a0a 6465 6620 6269 6e61   dst)...def bina
+0000e580: 7279 5f6f 705f 6261 7463 6869 6e67 5f72  ry_op_batching_r
+0000e590: 756c 6528 6f70 3a20 7072 696d 732e 5072  ule(op: prims.Pr
+0000e5a0: 696d 4944 732c 2061 7869 735f 7369 7a65  imIDs, axis_size
+0000e5b0: 3a20 696e 742c 2076 616c 735f 696e 3a20  : int, vals_in: 
+0000e5c0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
+0000e5d0: 2020 2028 2878 2c20 785f 6264 696d 292c     ((x, x_bdim),
+0000e5e0: 2028 792c 2079 5f62 6469 6d29 2920 3d20   (y, y_bdim)) = 
+0000e5f0: 7661 6c73 5f69 6e0a 2020 2020 6966 2078  vals_in.    if x
+0000e600: 5f62 6469 6d20 213d 2079 5f62 6469 6d3a  _bdim != y_bdim:
+0000e610: 0a20 2020 2020 2020 2069 6620 785f 6264  .        if x_bd
+0000e620: 696d 2069 7320 6e6f 745f 6d61 7070 6564  im is not_mapped
+0000e630: 3a0a 2020 2020 2020 2020 2020 2020 7820  :.            x 
+0000e640: 3d20 6d6f 7665 5f62 6174 6368 5f64 696d  = move_batch_dim
+0000e650: 2861 7869 735f 7369 7a65 2c20 785f 6264  (axis_size, x_bd
+0000e660: 696d 2c20 795f 6264 696d 2c20 7829 0a20  im, y_bdim, x). 
+0000e670: 2020 2020 2020 2020 2020 2078 5f62 6469             x_bdi
+0000e680: 6d20 3d20 795f 6264 696d 0a20 2020 2020  m = y_bdim.     
+0000e690: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000e6a0: 2020 2020 2079 203d 206d 6f76 655f 6261       y = move_ba
+0000e6b0: 7463 685f 6469 6d28 6178 6973 5f73 697a  tch_dim(axis_siz
+0000e6c0: 652c 2079 5f62 6469 6d2c 2078 5f62 6469  e, y_bdim, x_bdi
+0000e6d0: 6d2c 2079 290a 2020 2020 7265 7475 726e  m, y).    return
+0000e6e0: 2042 6174 6368 6564 5661 6c75 6528 6f70   BatchedValue(op
+0000e6f0: 2878 2c20 7929 2c20 785f 6264 696d 290a  (x, y), x_bdim).
+0000e700: 0a0a 6465 6620 7369 6e5f 766d 6170 2861  ..def sin_vmap(a
+0000e710: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
+0000e720: 3a20 4261 7463 6865 6456 616c 7565 2920  : BatchedValue) 
+0000e730: 2d3e 2042 6174 6368 6564 5661 6c75 653a  -> BatchedValue:
+0000e740: 0a20 2020 2072 6574 7572 6e20 7665 6374  .    return vect
+0000e750: 6f72 697a 6564 5f62 6174 6368 6572 2870  orized_batcher(p
+0000e760: 7269 6d73 2e73 696e 2c20 6178 6973 5f73  rims.sin, axis_s
+0000e770: 697a 652c 2028 612c 2929 0a0a 0a64 6566  ize, (a,))...def
+0000e780: 2063 6f73 5f76 6d61 7028 6178 6973 5f73   cos_vmap(axis_s
+0000e790: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
+0000e7a0: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
+0000e7b0: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
+0000e7c0: 7265 7475 726e 2076 6563 746f 7269 7a65  return vectorize
+0000e7d0: 645f 6261 7463 6865 7228 7072 696d 732e  d_batcher(prims.
+0000e7e0: 636f 732c 2061 7869 735f 7369 7a65 2c20  cos, axis_size, 
+0000e7f0: 2861 2c29 290a 0a0a 6465 6620 6d75 6c5f  (a,))...def mul_
+0000e800: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
+0000e810: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
+0000e820: 616c 7565 2c20 623a 2042 6174 6368 6564  alue, b: Batched
+0000e830: 5661 6c75 6529 202d 3e20 4261 7463 6865  Value) -> Batche
+0000e840: 6456 616c 7565 3a0a 2020 2020 7265 7475  dValue:.    retu
+0000e850: 726e 2062 696e 6172 795f 6f70 5f62 6174  rn binary_op_bat
+0000e860: 6368 696e 675f 7275 6c65 2870 7269 6d73  ching_rule(prims
+0000e870: 2e6d 756c 2c20 6178 6973 5f73 697a 652c  .mul, axis_size,
+0000e880: 2028 612c 2062 2929 0a0a 0a64 6566 2061   (a, b))...def a
+0000e890: 6464 5f76 6d61 7028 6178 6973 5f73 697a  dd_vmap(axis_siz
+0000e8a0: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
+0000e8b0: 6564 5661 6c75 652c 2062 3a20 4261 7463  edValue, b: Batc
+0000e8c0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
+0000e8d0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
+0000e8e0: 6574 7572 6e20 6269 6e61 7279 5f6f 705f  eturn binary_op_
+0000e8f0: 6261 7463 6869 6e67 5f72 756c 6528 7072  batching_rule(pr
+0000e900: 696d 732e 6164 642c 2061 7869 735f 7369  ims.add, axis_si
+0000e910: 7a65 2c20 2861 2c20 6229 290a 0a0a 6465  ze, (a, b))...de
+0000e920: 6620 7375 6d5f 766d 6170 2861 7869 735f  f sum_vmap(axis_
+0000e930: 7369 7a65 3a20 696e 742c 2061 3a20 4261  size: int, a: Ba
+0000e940: 7463 6865 6456 616c 7565 2c20 6469 6d73  tchedValue, dims
+0000e950: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
+0000e960: 202a 2a6b 7761 7267 7329 202d 3e20 4261   **kwargs) -> Ba
+0000e970: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
+0000e980: 6264 696d 203d 2061 2e62 6174 6368 5f64  bdim = a.batch_d
+0000e990: 696d 0a20 2020 2023 2054 4f44 4f3a 2072  im.    # TODO: r
+0000e9a0: 656d 6f76 6520 7468 6973 2077 6865 6e20  emove this when 
+0000e9b0: 6469 6d73 2062 6563 6f6d 6573 2061 206d  dims becomes a m
+0000e9c0: 616e 6461 746f 7279 206b 7761 7267 0a20  andatory kwarg. 
+0000e9d0: 2020 2069 6620 6c65 6e28 6469 6d73 2920     if len(dims) 
+0000e9e0: 3e20 303a 0a20 2020 2020 2020 2064 696d  > 0:.        dim
+0000e9f0: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+0000ea00: 2a64 696d 7329 0a20 2020 2064 696d 735f  *dims).    dims_
+0000ea10: 6265 666f 7265 203d 2074 7570 6c65 2865  before = tuple(e
+0000ea20: 6c20 666f 7220 656c 2069 6e20 6469 6d73  l for el in dims
+0000ea30: 2069 6620 656c 203c 2062 6469 6d29 0a20   if el < bdim). 
+0000ea40: 2020 2064 696d 735f 6166 7465 7220 3d20     dims_after = 
+0000ea50: 7475 706c 6528 656c 202b 2031 2066 6f72  tuple(el + 1 for
+0000ea60: 2065 6c20 696e 2064 696d 7320 6966 2065   el in dims if e
+0000ea70: 6c20 3e3d 2062 6469 6d29 0a20 2020 2062  l >= bdim).    b
+0000ea80: 6174 6368 6564 5f64 696d 7320 3d20 6469  atched_dims = di
+0000ea90: 6d73 5f62 6566 6f72 6520 2b20 6469 6d73  ms_before + dims
+0000eaa0: 5f61 6674 6572 0a20 2020 2072 6574 7572  _after.    retur
+0000eab0: 6e20 7665 6374 6f72 697a 6564 5f62 6174  n vectorized_bat
+0000eac0: 6368 6572 2870 7269 6d73 2e73 756d 2c20  cher(prims.sum, 
+0000ead0: 6178 6973 5f73 697a 652c 2028 612c 292c  axis_size, (a,),
+0000eae0: 2064 696d 733d 6261 7463 6865 645f 6469   dims=batched_di
+0000eaf0: 6d73 2c20 2a2a 6b77 6172 6773 290a 0a0a  ms, **kwargs)...
+0000eb00: 2320 544f 444f 3a20 506c 6561 7365 2074  # TODO: Please t
+0000eb10: 6573 7420 7468 6973 2065 7874 656e 7369  est this extensi
+0000eb20: 7665 6c79 0a64 6566 2062 726f 6164 6361  vely.def broadca
+0000eb30: 7374 5f69 6e5f 6469 6d5f 766d 6170 280a  st_in_dim_vmap(.
+0000eb40: 2020 2020 6178 6973 5f73 697a 653a 2069      axis_size: i
+0000eb50: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
+0000eb60: 6c75 652c 2073 6861 7065 3a20 5365 7175  lue, shape: Sequ
+0000eb70: 656e 6365 5b42 6174 6368 6564 5661 6c75  ence[BatchedValu
+0000eb80: 655d 2c20 6272 6f61 6463 6173 745f 6469  e], broadcast_di
+0000eb90: 6d65 6e73 696f 6e73 3a20 5365 7175 656e  mensions: Sequen
+0000eba0: 6365 5b42 6174 6368 6564 5661 6c75 655d  ce[BatchedValue]
+0000ebb0: 0a29 202d 3e20 4261 7463 6865 6456 616c  .) -> BatchedVal
+0000ebc0: 7565 3a0a 2020 2020 6264 696d 203d 2061  ue:.    bdim = a
+0000ebd0: 2e62 6174 6368 5f64 696d 0a20 2020 2023  .batch_dim.    #
+0000ebe0: 2054 4f44 4f3a 2072 656d 6f76 6520 7468   TODO: remove th
+0000ebf0: 6973 2077 6865 6e20 7368 6170 6520 616e  is when shape an
+0000ec00: 6420 6272 6f61 6463 6173 745f 6469 6d65  d broadcast_dime
+0000ec10: 6e73 696f 6e73 2062 6563 6f6d 6520 6d61  nsions become ma
+0000ec20: 6e64 6174 6f72 7920 6b77 6172 6773 0a20  ndatory kwargs. 
+0000ec30: 2020 2073 6861 7065 2c20 5f20 3d20 7361     shape, _ = sa
+0000ec40: 6665 5f7a 6970 282a 7368 6170 6529 0a20  fe_zip(*shape). 
+0000ec50: 2020 2069 6620 6c65 6e28 6272 6f61 6463     if len(broadc
+0000ec60: 6173 745f 6469 6d65 6e73 696f 6e73 2920  ast_dimensions) 
+0000ec70: 3e20 303a 0a20 2020 2020 2020 2062 726f  > 0:.        bro
+0000ec80: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+0000ec90: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+0000eca0: 2a62 726f 6164 6361 7374 5f64 696d 656e  *broadcast_dimen
+0000ecb0: 7369 6f6e 7329 0a20 2020 2069 6620 6264  sions).    if bd
+0000ecc0: 696d 2069 7320 6e6f 745f 6d61 7070 6564  im is not_mapped
+0000ecd0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000ece0: 2042 6174 6368 6564 5661 6c75 6528 7072   BatchedValue(pr
+0000ecf0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
+0000ed00: 5f64 696d 2861 2e76 616c 7565 2c20 7368  _dim(a.value, sh
+0000ed10: 6170 652c 2062 726f 6164 6361 7374 5f64  ape, broadcast_d
+0000ed20: 696d 656e 7369 6f6e 7329 2c20 6264 696d  imensions), bdim
+0000ed30: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0000ed40: 2020 2020 6e65 775f 6264 696d 203d 2062      new_bdim = b
+0000ed50: 6469 6d20 2b20 7375 6d28 3120 666f 7220  dim + sum(1 for 
+0000ed60: 6469 6d20 696e 2062 726f 6164 6361 7374  dim in broadcast
+0000ed70: 5f64 696d 656e 7369 6f6e 7320 6966 2064  _dimensions if d
+0000ed80: 696d 203c 2062 6469 6d29 0a20 2020 2020  im < bdim).     
+0000ed90: 2020 206e 6577 5f73 6861 7065 203d 206c     new_shape = l
+0000eda0: 6973 7428 7368 6170 6529 0a20 2020 2020  ist(shape).     
+0000edb0: 2020 206e 6577 5f73 6861 7065 2e69 6e73     new_shape.ins
+0000edc0: 6572 7428 6e65 775f 6264 696d 2c20 6178  ert(new_bdim, ax
+0000edd0: 6973 5f73 697a 6529 0a20 2020 2020 2020  is_size).       
 0000ede0: 206e 6577 5f62 726f 6164 6361 7374 5f64   new_broadcast_d
-0000edf0: 696d 656e 7369 6f6e 7329 2c20 6e65 775f  imensions), new_
-0000ee00: 6264 696d 290a 0a0a 766d 6170 5f69 6d70  bdim)...vmap_imp
-0000ee10: 6c73 3a20 6469 6374 5b70 7269 6d73 2e53  ls: dict[prims.S
-0000ee20: 796d 626f 6c2c 2043 616c 6c61 626c 655d  ymbol, Callable]
-0000ee30: 203d 2064 6963 7428 290a 0a0a 6465 6620   = dict()...def 
-0000ee40: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
-0000ee50: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
-0000ee60: 7261 6365 293a 0a20 2020 206e 6577 5f73  race):.    new_s
-0000ee70: 796d 626f 6c73 5f69 7465 7220 3d20 280a  ymbols_iter = (.
-0000ee80: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
-0000ee90: 6d62 6f6c 2e73 7562 7379 6d62 6f6c 7320  mbol.subsymbols 
-0000eea0: 6966 206c 656e 2862 6f75 6e64 5f73 796d  if len(bound_sym
-0000eeb0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
-0000eec0: 3e20 3020 656c 7365 205b 626f 756e 645f  > 0 else [bound_
-0000eed0: 7379 6d62 6f6c 5d0a 2020 2020 2020 2020  symbol].        
-0000eee0: 666f 7220 626f 756e 645f 7379 6d62 6f6c  for bound_symbol
-0000eef0: 2069 6e20 7472 6163 652e 626f 756e 645f   in trace.bound_
-0000ef00: 7379 6d62 6f6c 730a 2020 2020 290a 2020  symbols.    ).  
-0000ef10: 2020 6e65 775f 7379 6d62 6f6c 7320 3d20    new_symbols = 
-0000ef20: 6c69 7374 2863 6861 696e 2e66 726f 6d5f  list(chain.from_
-0000ef30: 6974 6572 6162 6c65 286e 6577 5f73 796d  iterable(new_sym
-0000ef40: 626f 6c73 5f69 7465 7229 290a 2020 2020  bols_iter)).    
-0000ef50: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0000ef60: 6f6c 7320 3d20 6e65 775f 7379 6d62 6f6c  ols = new_symbol
-0000ef70: 730a 2020 2020 7265 7475 726e 2074 7261  s.    return tra
-0000ef80: 6365 0a0a 0a64 6566 2064 6563 6f6d 706f  ce...def decompo
-0000ef90: 7365 645f 666e 5f76 6d61 705f 7275 6c65  sed_fn_vmap_rule
-0000efa0: 2861 7869 735f 7369 7a65 2c20 2a61 7267  (axis_size, *arg
-0000efb0: 732c 2066 6e2c 202a 2a6b 7761 7267 7329  s, fn, **kwargs)
-0000efc0: 3a0a 2020 2020 6172 6773 2c20 696e 5f64  :.    args, in_d
-0000efd0: 696d 7320 3d20 756e 7a69 7032 2861 7267  ims = unzip2(arg
-0000efe0: 7329 0a20 2020 2075 6e62 6174 6368 6564  s).    unbatched
-0000eff0: 5f61 7267 7320 3d20 7472 6565 5f6d 6170  _args = tree_map
-0000f000: 286c 616d 6264 6120 783a 2072 656d 6f76  (lambda x: remov
-0000f010: 655f 6261 7463 685f 6469 6d28 7829 2069  e_batch_dim(x) i
-0000f020: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0000f030: 5465 6e73 6f72 5072 6f78 7929 2065 6c73  TensorProxy) els
-0000f040: 6520 782c 2061 7267 7329 0a20 2020 2074  e x, args).    t
-0000f050: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-0000f060: 5f74 7261 6365 2829 2866 6e2c 202a 756e  _trace()(fn, *un
-0000f070: 6261 7463 6865 645f 6172 6773 2c20 2a2a  batched_args, **
-0000f080: 6b77 6172 6773 290a 2020 2020 7472 6163  kwargs).    trac
-0000f090: 6520 3d20 756e 7772 6170 5f6f 6e65 5f6c  e = unwrap_one_l
-0000f0a0: 6576 656c 5f6f 665f 7375 6273 796d 626f  evel_of_subsymbo
-0000f0b0: 6c73 2874 7261 6365 290a 2020 2020 6f75  ls(trace).    ou
-0000f0c0: 7473 203d 205f 766d 6170 5f63 616c 6c5f  ts = _vmap_call_
-0000f0d0: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
-0000f0e0: 6172 6773 2c20 696e 5f64 696d 732c 2030  args, in_dims, 0
-0000f0f0: 2c20 6178 6973 5f73 697a 652c 2066 756e  , axis_size, fun
-0000f100: 6374 696f 6e5f 7472 6163 653d 7472 6163  ction_trace=trac
-0000f110: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-0000f120: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-0000f130: 7574 732c 2053 6571 7565 6e63 6529 3a0a  uts, Sequence):.
-0000f140: 2020 2020 2020 2020 6f75 745f 6469 6d73          out_dims
-0000f150: 203d 2028 302c 2920 2a20 6c65 6e28 6f75   = (0,) * len(ou
-0000f160: 7473 290a 2020 2020 2020 2020 7265 7475  ts).        retu
-0000f170: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-0000f180: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
-0000f190: 652c 2073 6166 655f 7a69 7028 6f75 7473  e, safe_zip(outs
-0000f1a0: 2c20 6f75 745f 6469 6d73 2929 0a20 2020  , out_dims)).   
-0000f1b0: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
-0000f1c0: 616c 7565 286f 7574 732c 2030 290a 0a0a  alue(outs, 0)...
-0000f1d0: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
-0000f1e0: 2e50 7269 6d49 4473 2e53 494e 5d20 3d20  .PrimIDs.SIN] = 
-0000f1f0: 7369 6e5f 766d 6170 0a76 6d61 705f 696d  sin_vmap.vmap_im
-0000f200: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-0000f210: 732e 434f 535d 203d 2063 6f73 5f76 6d61  s.COS] = cos_vma
-0000f220: 700a 766d 6170 5f69 6d70 6c73 5b70 7269  p.vmap_impls[pri
-0000f230: 6d73 2e50 7269 6d49 4473 2e4d 554c 5d20  ms.PrimIDs.MUL] 
-0000f240: 3d20 6d75 6c5f 766d 6170 0a76 6d61 705f  = mul_vmap.vmap_
-0000f250: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-0000f260: 4944 732e 4144 445d 203d 2061 6464 5f76  IDs.ADD] = add_v
-0000f270: 6d61 700a 766d 6170 5f69 6d70 6c73 5b70  map.vmap_impls[p
-0000f280: 7269 6d73 2e50 7269 6d49 4473 2e53 554d  rims.PrimIDs.SUM
-0000f290: 5d20 3d20 7375 6d5f 766d 6170 0a76 6d61  ] = sum_vmap.vma
-0000f2a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-0000f2b0: 696d 4944 732e 4252 4f41 4443 4153 545f  imIDs.BROADCAST_
-0000f2c0: 494e 5f44 494d 5d20 3d20 6272 6f61 6463  IN_DIM] = broadc
-0000f2d0: 6173 745f 696e 5f64 696d 5f76 6d61 700a  ast_in_dim_vmap.
-0000f2e0: 0a0a 6465 6620 766d 6170 5f73 796d 626f  ..def vmap_symbo
-0000f2f0: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
-0000f300: 2070 7269 6d73 2e53 796d 626f 6c2c 202a   prims.Symbol, *
-0000f310: 2c20 6178 6973 5f73 697a 653a 2069 6e74  , axis_size: int
-0000f320: 293a 0a20 2020 2022 2222 4d61 7073 2061  ):.    """Maps a
-0000f330: 2073 796d 626f 6c20 746f 2061 2076 6d61   symbol to a vma
-0000f340: 7020 6675 6e63 7469 6f6e 2074 6861 7420  p function that 
-0000f350: 6576 616c 7561 7465 7320 6974 2e0a 0a20  evaluates it... 
-0000f360: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000f370: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
-0000f380: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
-0000f390: 6f20 6576 616c 7561 7465 2e0a 0a20 2020  o evaluate...   
-0000f3a0: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-0000f3b0: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-0000f3c0: 7272 6f72 3a20 4966 2074 6865 2076 6d61  rror: If the vma
-0000f3d0: 7020 666f 7220 7468 6520 7379 6d62 6f6c  p for the symbol
-0000f3e0: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
-0000f3f0: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
-0000f400: 733a 0a20 2020 2020 2020 2043 616c 6c61  s:.        Calla
-0000f410: 626c 653a 2076 6d61 7020 6675 6e63 7469  ble: vmap functi
-0000f420: 6f6e 2074 6861 7420 6576 616c 7561 7465  on that evaluate
-0000f430: 7320 7468 6520 7379 6d62 6f6c 2e0a 2020  s the symbol..  
-0000f440: 2020 2222 220a 0a20 2020 2064 6566 2077    """..    def w
-0000f450: 7261 705f 6172 6728 7829 3a0a 2020 2020  rap_arg(x):.    
-0000f460: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000f470: 6528 782c 2042 6174 6368 6564 5661 6c75  e(x, BatchedValu
-0000f480: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000f490: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
-0000f4a0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-0000f4b0: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
-0000f4c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000f4d0: 4261 7463 6865 6456 616c 7565 2878 2c20  BatchedValue(x, 
-0000f4e0: 6e6f 745f 6d61 7070 6564 290a 2020 2020  not_mapped).    
-0000f4f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f500: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0000f510: 6545 7272 6f72 2866 2276 6d61 7020 7772  eError(f"vmap wr
-0000f520: 6170 5f61 7267 2067 6f74 2061 6e20 756e  ap_arg got an un
-0000f530: 7375 7070 6f72 7465 6420 7479 7065 207b  supported type {
-0000f540: 7479 7065 2878 297d 2229 0a0a 2020 2020  type(x)}")..    
-0000f550: 6966 2073 796d 626f 6c2e 6172 655f 616c  if symbol.are_al
-0000f560: 6c5f 6172 6773 5f63 6f6e 7374 616e 743a  l_args_constant:
-0000f570: 0a0a 2020 2020 2020 2020 6465 6620 5f76  ..        def _v
-0000f580: 6d61 705f 696d 706c 5f63 6f6e 7374 2873  map_impl_const(s
-0000f590: 796d 626f 6c2c 202a 6172 6773 2c20 2a2a  ymbol, *args, **
-0000f5a0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000f5b0: 2020 2020 206f 7574 203d 2073 796d 626f       out = symbo
-0000f5c0: 6c5f 746f 5f65 7661 6c28 7379 6d62 6f6c  l_to_eval(symbol
-0000f5d0: 2928 2a61 7267 732c 202a 2a6b 7761 7267  )(*args, **kwarg
-0000f5e0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0000f5f0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0000f600: 742c 2053 6571 7565 6e63 6529 3a0a 2020  t, Sequence):.  
-0000f610: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000f620: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
-0000f630: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
-0000f640: 6c75 652c 2073 6166 655f 7a69 7028 6172  lue, safe_zip(ar
-0000f650: 6773 2c20 5b6e 6f74 5f6d 6170 7065 645d  gs, [not_mapped]
-0000f660: 202a 206c 656e 286f 7574 2929 290a 0a20   * len(out))).. 
-0000f670: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f680: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
-0000f690: 7574 2c20 6e6f 745f 6d61 7070 6564 290a  ut, not_mapped).
-0000f6a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f6b0: 7061 7274 6961 6c28 5f76 6d61 705f 696d  partial(_vmap_im
-0000f6c0: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
-0000f6d0: 290a 0a20 2020 2076 6d61 705f 696d 706c  )..    vmap_impl
-0000f6e0: 203d 2076 6d61 705f 696d 706c 732e 6765   = vmap_impls.ge
-0000f6f0: 7428 7379 6d62 6f6c 2e73 796d 2e69 6429  t(symbol.sym.id)
-0000f700: 0a20 2020 2069 6620 766d 6170 5f69 6d70  .    if vmap_imp
-0000f710: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
-0000f720: 2020 2069 6620 6c65 6e28 7379 6d62 6f6c     if len(symbol
-0000f730: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
-0000f740: 3a0a 2020 2020 2020 2020 2020 2020 766d  :.            vm
-0000f750: 6170 5f69 6d70 6c20 3d20 7061 7274 6961  ap_impl = partia
-0000f760: 6c28 6465 636f 6d70 6f73 6564 5f66 6e5f  l(decomposed_fn_
-0000f770: 766d 6170 5f72 756c 652c 2066 6e3d 7379  vmap_rule, fn=sy
-0000f780: 6d62 6f6c 2e73 796d 290a 2020 2020 2020  mbol.sym).      
-0000f790: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000f7a0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0000f7b0: 6c65 6d65 6e74 6564 4572 726f 7228 6622  lementedError(f"
-0000f7c0: 766d 6170 2066 6f72 207b 7379 6d62 6f6c  vmap for {symbol
-0000f7d0: 2e73 796d 2e69 647d 2069 7320 6e6f 7420  .sym.id} is not 
-0000f7e0: 696d 706c 656d 656e 7465 6422 290a 0a20  implemented").. 
-0000f7f0: 2020 2064 6566 205f 766d 6170 5f69 6d70     def _vmap_imp
-0000f800: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-0000f810: 7329 3a0a 2020 2020 2020 2020 6172 6773  s):.        args
-0000f820: 203d 2074 7265 655f 6d61 7028 7772 6170   = tree_map(wrap
-0000f830: 5f61 7267 2c20 6172 6773 290a 2020 2020  _arg, args).    
-0000f840: 2020 2020 6173 7365 7274 2061 6c6c 2869      assert all(i
-0000f850: 7369 6e73 7461 6e63 6528 6172 672c 2042  sinstance(arg, B
-0000f860: 6174 6368 6564 5661 6c75 6529 2066 6f72  atchedValue) for
-0000f870: 2061 7267 2069 6e20 7472 6565 5f66 6c61   arg in tree_fla
-0000f880: 7474 656e 2861 7267 7329 5b30 5d29 0a20  tten(args)[0]). 
-0000f890: 2020 2020 2020 2072 6574 7572 6e20 766d         return vm
-0000f8a0: 6170 5f69 6d70 6c28 6178 6973 5f73 697a  ap_impl(axis_siz
-0000f8b0: 652c 202a 6172 6773 2c20 2a2a 6b77 6172  e, *args, **kwar
-0000f8c0: 6773 290a 0a20 2020 2072 6574 7572 6e20  gs)..    return 
-0000f8d0: 5f76 6d61 705f 696d 706c 0a0a 0a64 6566  _vmap_impl...def
-0000f8e0: 2072 656d 6f76 655f 6261 7463 685f 6469   remove_batch_di
-0000f8f0: 6d28 7465 6e73 6f72 3a20 5465 6e73 6f72  m(tensor: Tensor
-0000f900: 5072 6f78 792c 2062 6174 6368 5f64 696d  Proxy, batch_dim
-0000f910: 3a20 696e 7420 3d20 3029 202d 3e20 5465  : int = 0) -> Te
-0000f920: 6e73 6f72 5072 6f78 793a 0a20 2020 2022  nsorProxy:.    "
-0000f930: 2222 5265 6d6f 7665 7320 7468 6520 6261  ""Removes the ba
-0000f940: 7463 6820 6469 6d65 6e73 696f 6e20 6672  tch dimension fr
-0000f950: 6f6d 2061 2074 656e 736f 722e 0a0a 2020  om a tensor...  
-0000f960: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000f970: 7465 6e73 6f72 2028 5465 6e73 6f72 5072  tensor (TensorPr
-0000f980: 6f78 7929 3a20 5465 6e73 6f72 2074 6f20  oxy): Tensor to 
-0000f990: 7265 6d6f 7665 2074 6865 2062 6174 6368  remove the batch
-0000f9a0: 2064 696d 656e 7369 6f6e 2066 726f 6d2e   dimension from.
-0000f9b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0000f9c0: 2020 2020 2020 2054 656e 736f 7250 726f         TensorPro
-0000f9d0: 7879 3a20 5465 6e73 6f72 2077 6974 6820  xy: Tensor with 
-0000f9e0: 7468 6520 6261 7463 6820 6469 6d65 6e73  the batch dimens
-0000f9f0: 696f 6e20 7265 6d6f 7665 642e 0a20 2020  ion removed..   
-0000fa00: 2022 2222 0a20 2020 206e 6577 5f73 6861   """.    new_sha
-0000fa10: 7065 203d 2074 656e 736f 722e 7368 6170  pe = tensor.shap
-0000fa20: 655b 3a62 6174 6368 5f64 696d 5d20 2b20  e[:batch_dim] + 
-0000fa30: 7465 6e73 6f72 2e73 6861 7065 5b62 6174  tensor.shape[bat
-0000fa40: 6368 5f64 696d 202b 2031 203a 5d0a 2020  ch_dim + 1 :].  
-0000fa50: 2020 7265 7475 726e 2054 656e 736f 7250    return TensorP
-0000fa60: 726f 7879 286c 696b 653d 7465 6e73 6f72  roxy(like=tensor
-0000fa70: 2c20 7368 6170 653d 6e65 775f 7368 6170  , shape=new_shap
-0000fa80: 6529 0a0a 0a23 2054 4f44 4f3a 2069 6e20  e)...# TODO: in 
-0000fa90: 4a41 5820 6172 6773 2c20 696e 5f64 696d  JAX args, in_dim
-0000faa0: 7320 6172 6520 666c 6174 7465 6e65 6420  s are flattened 
-0000fab0: 7468 6520 7361 6d65 2077 6179 0a23 2054  the same way.# T
-0000fac0: 4f44 4f3a 2069 6e20 4a41 5820 6f75 745f  ODO: in JAX out_
-0000fad0: 6469 6d73 2061 7265 2066 6c61 7474 656e  dims are flatten
-0000fae0: 6564 2061 7320 7765 6c6c 0a64 6566 205f  ed as well.def _
-0000faf0: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
-0000fb00: 6e63 2864 6574 6163 6865 643a 2062 6f6f  nc(detached: boo
-0000fb10: 6c2c 2061 7267 732c 2069 6e5f 6469 6d73  l, args, in_dims
-0000fb20: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
-0000fb30: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
-0000fb40: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
-0000fb50: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
-0000fb60: 4d65 7461 6675 6e63 7469 6f6e 2066 6f72  Metafunction for
-0000fb70: 2076 6d61 7020 6361 6c6c 2e0a 0a20 2020   vmap call...   
-0000fb80: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
-0000fb90: 6574 6163 6865 6420 2862 6f6f 6c29 3a20  etached (bool): 
-0000fba0: 5768 6574 6865 7220 746f 2064 6574 6163  Whether to detac
-0000fbb0: 6820 7468 6520 7472 6163 652e 0a20 2020  h the trace..   
-0000fbc0: 2020 2020 2061 7267 7320 2854 7570 6c65       args (Tuple
-0000fbd0: 5b50 726f 7879 5d29 3a20 4172 6775 6d65  [Proxy]): Argume
-0000fbe0: 6e74 7320 746f 2074 6865 2066 756e 6374  nts to the funct
-0000fbf0: 696f 6e2e 0a20 2020 2020 2020 2069 6e5f  ion..        in_
-0000fc00: 6469 6d73 2028 5475 706c 655b 696e 745d  dims (Tuple[int]
-0000fc10: 293a 2042 6174 6368 2064 696d 656e 7369  ): Batch dimensi
-0000fc20: 6f6e 2066 6f72 2065 6163 6820 6172 6775  on for each argu
-0000fc30: 6d65 6e74 2e0a 2020 2020 2020 2020 6f75  ment..        ou
-0000fc40: 745f 6469 6d73 2028 5475 706c 655b 696e  t_dims (Tuple[in
-0000fc50: 745d 293a 2042 6174 6368 2064 696d 656e  t]): Batch dimen
-0000fc60: 7369 6f6e 2066 6f72 2072 6574 7572 6e20  sion for return 
-0000fc70: 7661 6c75 6573 2e0a 2020 2020 2020 2020  values..        
-0000fc80: 6675 6e63 7469 6f6e 5f74 7261 6365 2028  function_trace (
-0000fc90: 5472 6163 6529 3a20 5472 6163 6520 746f  Trace): Trace to
-0000fca0: 2075 7365 2066 6f72 2074 6865 2066 756e   use for the fun
-0000fcb0: 6374 696f 6e2e 0a20 2020 2020 2020 206b  ction..        k
-0000fcc0: 7761 7267 733a 204b 6579 776f 7264 2061  wargs: Keyword a
-0000fcd0: 7267 756d 656e 7473 2e0a 0a20 2020 2052  rguments...    R
-0000fce0: 6169 7365 733a 0a20 2020 2020 2020 2041  aises:.        A
-0000fcf0: 7373 6572 7469 6f6e 4572 726f 723a 2049  ssertionError: I
-0000fd00: 6620 7468 6520 766d 6170 2066 6f72 206b  f the vmap for k
-0000fd10: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-0000fd20: 2069 7320 6e6f 7420 696d 706c 656d 656e   is not implemen
-0000fd30: 7465 642e 0a0a 2020 2020 5265 7475 726e  ted...    Return
-0000fd40: 733a 0a20 2020 2020 2020 2052 6573 756c  s:.        Resul
-0000fd50: 7420 6f66 2074 6865 2076 6d61 7020 7472  t of the vmap tr
-0000fd60: 616e 7366 6f72 6d2e 0a20 2020 2022 2222  ansform..    """
-0000fd70: 0a20 2020 2063 6f6d 6d6f 6e5f 6465 7669  .    common_devi
-0000fd80: 6365 203d 207b 782e 6465 7669 6365 2066  ce = {x.device f
-0000fd90: 6f72 2078 2069 6e20 6172 6773 2069 6620  or x in args if 
-0000fda0: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
-0000fdb0: 6e73 6f72 5072 6f78 7929 7d0a 2020 2020  nsorProxy)}.    
-0000fdc0: 6173 7365 7274 206c 656e 2863 6f6d 6d6f  assert len(commo
-0000fdd0: 6e5f 6465 7669 6365 2920 3c3d 2031 2c20  n_device) <= 1, 
-0000fde0: 2276 6d61 7020 666f 7220 6d75 6c74 6970  "vmap for multip
-0000fdf0: 6c65 2064 6576 6963 6573 2069 7320 6e6f  le devices is no
-0000fe00: 7420 696d 706c 656d 656e 7465 6422 0a20  t implemented". 
-0000fe10: 2020 2028 636f 6d6d 6f6e 5f64 6576 6963     (common_devic
-0000fe20: 652c 2920 3d20 636f 6d6d 6f6e 5f64 6576  e,) = common_dev
-0000fe30: 6963 6520 6966 206c 656e 2863 6f6d 6d6f  ice if len(commo
-0000fe40: 6e5f 6465 7669 6365 2920 3d3d 2031 2065  n_device) == 1 e
-0000fe50: 6c73 6520 2863 7075 2c29 0a0a 2020 2020  lse (cpu,)..    
-0000fe60: 6966 2061 7869 735f 7369 7a65 2069 7320  if axis_size is 
-0000fe70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2861  None:.        (a
-0000fe80: 7869 735f 7369 7a65 2c29 203d 207b 782e  xis_size,) = {x.
-0000fe90: 7368 6170 655b 6178 5d20 666f 7220 782c  shape[ax] for x,
-0000fea0: 2061 7820 696e 207a 6970 2861 7267 732c   ax in zip(args,
-0000feb0: 2069 6e5f 6469 6d73 2920 6966 2061 7820   in_dims) if ax 
-0000fec0: 6973 206e 6f74 206e 6f74 5f6d 6170 7065  is not not_mappe
-0000fed0: 647d 0a20 2020 2069 6e5f 6469 6d73 203d  d}.    in_dims =
-0000fee0: 2069 6e5f 6469 6d73 2069 6620 6973 696e   in_dims if isin
-0000fef0: 7374 616e 6365 2869 6e5f 6469 6d73 2c20  stance(in_dims, 
-0000ff00: 5365 7175 656e 6365 2920 656c 7365 2028  Sequence) else (
-0000ff10: 696e 5f64 696d 732c 290a 2020 2020 696e  in_dims,).    in
-0000ff20: 5f64 696d 7320 3d20 7475 706c 6528 6e6f  _dims = tuple(no
-0000ff30: 745f 6d61 7070 6564 2069 6620 6973 696e  t_mapped if isin
-0000ff40: 7374 616e 6365 2861 2c20 4e75 6d62 6572  stance(a, Number
-0000ff50: 2920 656c 7365 2064 2066 6f72 2061 2c20  ) else d for a, 
-0000ff60: 6420 696e 2073 6166 655f 7a69 7028 6172  d in safe_zip(ar
-0000ff70: 6773 2c20 696e 5f64 696d 7329 290a 2020  gs, in_dims)).  
-0000ff80: 2020 6f75 745f 6469 6d73 203d 206f 7574    out_dims = out
-0000ff90: 5f64 696d 7320 6966 2069 7369 6e73 7461  _dims if isinsta
-0000ffa0: 6e63 6528 6f75 745f 6469 6d73 2c20 5365  nce(out_dims, Se
-0000ffb0: 7175 656e 6365 2920 656c 7365 2028 6f75  quence) else (ou
-0000ffc0: 745f 6469 6d73 2c29 0a0a 2020 2020 6374  t_dims,)..    ct
-0000ffd0: 7820 3d20 6465 7461 6368 6564 5f74 7261  x = detached_tra
-0000ffe0: 6365 2829 2069 6620 6465 7461 6368 6564  ce() if detached
-0000fff0: 2065 6c73 6520 6e75 6c6c 636f 6e74 6578   else nullcontex
-00010000: 7428 290a 2020 2020 7769 7468 2063 7478  t().    with ctx
-00010010: 3a0a 2020 2020 2020 2020 2320 5765 2070  :.        # We p
-00010020: 726f 7061 6761 7465 2074 6865 2042 6174  ropagate the Bat
-00010030: 6368 5661 6c75 6520 7468 726f 7567 6820  chValue through 
-00010040: 7468 6520 7472 6163 652c 2061 6e64 2074  the trace, and t
-00010050: 6865 6e20 756e 7772 6170 2069 7420 6174  hen unwrap it at
-00010060: 2074 6865 2065 6e64 0a20 2020 2020 2020   the end.       
-00010070: 2062 6174 6368 6564 5f61 7267 7320 3d20   batched_args = 
-00010080: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-00010090: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
-000100a0: 7361 6665 5f7a 6970 2861 7267 732c 2069  safe_zip(args, i
-000100b0: 6e5f 6469 6d73 2929 0a20 2020 2020 2020  n_dims)).       
-000100c0: 2072 6573 756c 7420 3d20 6576 616c 5f74   result = eval_t
-000100d0: 7261 6365 280a 2020 2020 2020 2020 2020  race(.          
-000100e0: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
-000100f0: 2c20 2a62 6174 6368 6564 5f61 7267 732c  , *batched_args,
-00010100: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
-00010110: 6172 7469 616c 2876 6d61 705f 7379 6d62  artial(vmap_symb
-00010120: 6f6c 5f6d 6170 7065 722c 2061 7869 735f  ol_mapper, axis_
-00010130: 7369 7a65 3d61 7869 735f 7369 7a65 292c  size=axis_size),
-00010140: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-00010150: 2020 290a 2020 2020 2020 2020 2320 556e    ).        # Un
-00010160: 7772 6170 7069 6e67 2074 6865 2042 6174  wrapping the Bat
-00010170: 6368 6564 5661 6c75 6527 730a 2020 2020  chedValue's.    
-00010180: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00010190: 6528 7265 7375 6c74 2c20 5365 7175 656e  e(result, Sequen
-000101a0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
-000101b0: 2066 6c61 745f 7265 7375 6c74 2c20 7370   flat_result, sp
-000101c0: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
-000101d0: 6e28 7265 7375 6c74 290a 2020 2020 2020  n(result).      
-000101e0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-000101f0: 2869 7369 6e73 7461 6e63 6528 782c 2042  (isinstance(x, B
-00010200: 6174 6368 6564 5661 6c75 6529 2066 6f72  atchedValue) for
-00010210: 2078 2069 6e20 666c 6174 5f72 6573 756c   x in flat_resul
-00010220: 7429 0a20 2020 2020 2020 2020 2020 206f  t).            o
-00010230: 7574 732c 2062 6469 6d73 203d 2075 6e7a  uts, bdims = unz
-00010240: 6970 3228 666c 6174 5f72 6573 756c 7429  ip2(flat_result)
-00010250: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00010260: 4f44 4f3a 2068 616e 646c 6520 7468 6520  ODO: handle the 
-00010270: 6361 7365 2077 6865 7265 206f 7574 5f64  case where out_d
-00010280: 696d 7320 6973 2061 2073 696e 676c 6520  ims is a single 
-00010290: 7661 6c75 6520 6265 7474 6572 0a20 2020  value better.   
-000102a0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-000102b0: 6f75 745f 6469 6d73 2920 3d3d 2031 3a0a  out_dims) == 1:.
-000102c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102d0: 6f75 745f 6469 6d73 203d 206f 7574 5f64  out_dims = out_d
-000102e0: 696d 7320 2a20 6c65 6e28 6f75 7473 290a  ims * len(outs).
-000102f0: 2020 2020 2020 2020 2020 2020 6f75 7473              outs
-00010300: 203d 2073 6166 655f 6d61 7028 7061 7274   = safe_map(part
-00010310: 6961 6c28 6d6f 7665 5f62 6174 6368 5f64  ial(move_batch_d
-00010320: 696d 2c20 6178 6973 5f73 697a 6529 2c20  im, axis_size), 
-00010330: 6264 696d 732c 206f 7574 5f64 696d 732c  bdims, out_dims,
-00010340: 206f 7574 7329 0a20 2020 2020 2020 2020   outs).         
-00010350: 2020 2072 6574 7572 6e20 7472 6565 5f75     return tree_u
-00010360: 6e66 6c61 7474 656e 286f 7574 732c 2073  nflatten(outs, s
-00010370: 7065 6329 0a20 2020 2020 2020 2069 6620  pec).        if 
-00010380: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
-00010390: 742c 204e 756d 6265 7229 2061 6e64 2061  t, Number) and a
-000103a0: 7869 735f 7369 7a65 2069 7320 6e6f 7420  xis_size is not 
-000103b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000103c0: 2020 2320 544f 444f 3a20 6665 7463 6820    # TODO: fetch 
-000103d0: 7468 6520 6465 6661 756c 7420 6465 7669  the default devi
-000103e0: 6365 2066 726f 6d20 7468 6520 636f 6e74  ce from the cont
-000103f0: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
-00010400: 7265 7375 6c74 203d 2066 756c 6c28 7368  result = full(sh
-00010410: 6170 653d 2829 2c20 6669 6c6c 5f76 616c  ape=(), fill_val
-00010420: 7565 3d72 6573 756c 742c 2064 6576 6963  ue=result, devic
-00010430: 653d 636f 6d6d 6f6e 5f64 6576 6963 6529  e=common_device)
-00010440: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00010450: 756c 7420 3d20 4261 7463 6865 6456 616c  ult = BatchedVal
-00010460: 7565 2872 6573 756c 742c 206e 6f74 5f6d  ue(result, not_m
-00010470: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
-00010480: 6c69 6620 6973 696e 7374 616e 6365 2872  lif isinstance(r
-00010490: 6573 756c 742c 2042 6174 6368 6564 5661  esult, BatchedVa
-000104a0: 6c75 6529 2061 6e64 2069 7369 6e73 7461  lue) and isinsta
-000104b0: 6e63 6528 7265 7375 6c74 2e76 616c 7565  nce(result.value
-000104c0: 2c20 4e75 6d62 6572 2920 616e 6420 6178  , Number) and ax
-000104d0: 6973 5f73 697a 6520 6973 206e 6f74 204e  is_size is not N
-000104e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000104f0: 2072 6573 756c 7420 3d20 4261 7463 6865   result = Batche
-00010500: 6456 616c 7565 2866 756c 6c28 7368 6170  dValue(full(shap
-00010510: 653d 2829 2c20 6669 6c6c 5f76 616c 7565  e=(), fill_value
-00010520: 3d72 6573 756c 742e 7661 6c75 652c 2064  =result.value, d
-00010530: 6576 6963 653d 636f 6d6d 6f6e 5f64 6576  evice=common_dev
-00010540: 6963 6529 2c20 7265 7375 6c74 2e62 6174  ice), result.bat
-00010550: 6368 5f64 696d 290a 2020 2020 2020 2020  ch_dim).        
-00010560: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-00010570: 6528 7265 7375 6c74 2c20 4261 7463 6865  e(result, Batche
-00010580: 6456 616c 7565 290a 2020 2020 2020 2020  dValue).        
-00010590: 6f75 7420 3d20 6d6f 7665 5f62 6174 6368  out = move_batch
-000105a0: 5f64 696d 2861 7869 735f 7369 7a65 2c20  _dim(axis_size, 
-000105b0: 7265 7375 6c74 2e62 6174 6368 5f64 696d  result.batch_dim
-000105c0: 2c20 6f75 745f 6469 6d73 5b30 5d2c 2072  , out_dims[0], r
-000105d0: 6573 756c 742e 7661 6c75 6529 0a20 2020  esult.value).   
-000105e0: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
-000105f0: 0a0a 766d 6170 5f63 616c 6c20 3d20 5379  ..vmap_call = Sy
-00010600: 6d62 6f6c 2869 643d 5472 616e 7366 6f72  mbol(id=Transfor
-00010610: 6d73 2e56 6d61 704f 702c 206e 616d 653d  ms.VmapOp, name=
-00010620: 2276 6d61 705f 6361 6c6c 222c 206d 6574  "vmap_call", met
-00010630: 613d 7061 7274 6961 6c28 5f76 6d61 705f  a=partial(_vmap_
-00010640: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
-00010650: 616c 7365 2929 0a0a 0a23 2054 4f44 4f3a  alse))...# TODO:
-00010660: 2068 6f77 2073 686f 756c 6420 7765 2068   how should we h
-00010670: 616e 646c 6520 6f75 745f 6469 6d73 2068  andle out_dims h
-00010680: 6572 653f 0a23 2061 6c74 686f 7567 6820  ere?.# although 
-00010690: 6865 7265 2077 6520 6172 6520 6361 6c6c  here we are call
-000106a0: 696e 6720 766d 6170 206f 6620 6964 656e  ing vmap of iden
-000106b0: 7469 7479 2c20 736f 2077 6520 7368 6f75  tity, so we shou
-000106c0: 6c64 206b 6e6f 7720 6672 6f6d 2074 6865  ld know from the
-000106d0: 2063 616c 6c20 746f 2076 6d61 700a 2320   call to vmap.# 
-000106e0: 5468 6973 2073 686f 756c 6420 6265 2066  This should be f
-000106f0: 696e 652e 2049 6620 7765 2068 6176 6520  ine. If we have 
-00010700: 766d 6170 2869 6465 6e74 6974 7928 6675  vmap(identity(fu
-00010710: 6e63 292c 206f 7574 5f64 696d 733d 4e29  nc), out_dims=N)
-00010720: 2074 6865 6e20 7468 6973 2072 756c 6520   then this rule 
-00010730: 6973 2066 6972 7374 2075 7365 640a 2320  is first used.# 
-00010740: 746f 2067 6574 2074 6865 2076 6d61 7070  to get the vmapp
-00010750: 6564 2072 6573 756c 7420 6f66 2069 6465  ed result of ide
-00010760: 6e74 6974 7928 6675 6e63 2920 696e 2076  ntity(func) in v
-00010770: 6d61 705f 7379 6d62 6f6c 5f6d 6170 7065  map_symbol_mappe
-00010780: 722c 2061 6e64 206f 7574 5f64 696d 7320  r, and out_dims 
-00010790: 6973 2068 616e 646c 6564 0a23 2061 6674  is handled.# aft
-000107a0: 6572 2074 6861 7420 696e 2074 6865 206f  er that in the o
-000107b0: 7574 6572 205f 766d 6170 5f63 616c 6c5f  uter _vmap_call_
-000107c0: 6d65 7461 6675 6e63 2e0a 6465 6620 5f69  metafunc..def _i
-000107d0: 6465 6e74 6974 795f 6361 6c6c 5f76 6d61  dentity_call_vma
-000107e0: 7028 6178 6973 5f73 697a 652c 202a 6261  p(axis_size, *ba
-000107f0: 7463 6865 645f 6172 6773 2c20 7472 6163  tched_args, trac
-00010800: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
-00010810: 6773 293a 0a20 2020 2061 7267 732c 2069  gs):.    args, i
-00010820: 6e5f 6469 6d73 203d 2075 6e7a 6970 3228  n_dims = unzip2(
-00010830: 6261 7463 6865 645f 6172 6773 290a 2020  batched_args).  
-00010840: 2020 6f75 745f 6469 6d73 203d 2030 2020    out_dims = 0  
-00010850: 2320 4669 786d 650a 2020 2020 6f75 7473  # Fixme.    outs
-00010860: 2c20 6f75 745f 6469 6d73 203d 205f 766d  , out_dims = _vm
-00010870: 6170 5f63 616c 6c5f 6d65 7461 6675 6e63  ap_call_metafunc
-00010880: 2846 616c 7365 2c20 6172 6773 2c20 696e  (False, args, in
-00010890: 5f64 696d 732c 206f 7574 5f64 696d 732c  _dims, out_dims,
-000108a0: 2061 7869 735f 7369 7a65 2c20 6675 6e63   axis_size, func
-000108b0: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
-000108c0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-000108d0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-000108e0: 7473 2c20 5365 7175 656e 6365 293a 0a20  ts, Sequence):. 
-000108f0: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
-00010900: 6665 5f6d 6170 2870 6169 725f 746f 5f62  fe_map(pair_to_b
-00010910: 6174 6368 6564 5f76 616c 7565 2c20 7361  atched_value, sa
-00010920: 6665 5f7a 6970 286f 7574 732c 206f 7574  fe_zip(outs, out
-00010930: 5f64 696d 7329 290a 2020 2020 7265 7475  _dims)).    retu
-00010940: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
-00010950: 6f75 7473 2c20 6f75 745f 6469 6d73 290a  outs, out_dims).
-00010960: 0a0a 766d 6170 5f69 6d70 6c73 5b54 7261  ..vmap_impls[Tra
-00010970: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
-00010980: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
-00010990: 6361 6c6c 5f76 6d61 700a 0a0a 6465 6620  call_vmap...def 
-000109a0: 5f6a 7670 5f63 616c 6c5f 766d 6170 2861  _jvp_call_vmap(a
-000109b0: 7869 735f 7369 7a65 2c20 6261 7463 6865  xis_size, batche
-000109c0: 645f 7072 696d 616c 732c 2062 6174 6368  d_primals, batch
-000109d0: 6564 5f74 616e 6765 6e74 732c 202a 2c20  ed_tangents, *, 
-000109e0: 6675 6e63 7469 6f6e 5f74 7261 6365 3a20  function_trace: 
-000109f0: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-00010a00: 3a0a 2020 2020 7072 696d 616c 732c 2070  :.    primals, p
-00010a10: 7269 6d61 6c73 5f62 6469 6d73 203d 2073  rimals_bdims = s
-00010a20: 6166 655f 7a69 7028 2a62 6174 6368 6564  afe_zip(*batched
-00010a30: 5f70 7269 6d61 6c73 290a 2020 2020 7461  _primals).    ta
-00010a40: 6e67 656e 7473 2c20 7461 6e67 656e 7473  ngents, tangents
-00010a50: 5f62 6469 6d73 203d 2073 6166 655f 7a69  _bdims = safe_zi
-00010a60: 7028 2a62 6174 6368 6564 5f74 616e 6765  p(*batched_tange
-00010a70: 6e74 7329 0a20 2020 206a 7670 5f66 756e  nts).    jvp_fun
-00010a80: 6320 3d20 7061 7274 6961 6c28 5f6a 7670  c = partial(_jvp
-00010a90: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
-00010aa0: 4661 6c73 652c 2066 756e 6374 696f 6e5f  False, function_
-00010ab0: 7472 6163 653d 6675 6e63 7469 6f6e 5f74  trace=function_t
-00010ac0: 7261 6365 290a 2020 2020 766d 6170 7065  race).    vmappe
-00010ad0: 645f 6a76 705f 6675 6e63 203d 2076 6d61  d_jvp_func = vma
-00010ae0: 7028 6a76 705f 6675 6e63 2c20 696e 5f64  p(jvp_func, in_d
-00010af0: 696d 733d 2870 7269 6d61 6c73 5f62 6469  ims=(primals_bdi
-00010b00: 6d73 2c20 7461 6e67 656e 7473 5f62 6469  ms, tangents_bdi
-00010b10: 6d73 292c 2061 7869 735f 7369 7a65 3d61  ms), axis_size=a
-00010b20: 7869 735f 7369 7a65 290a 2020 2020 7265  xis_size).    re
-00010b30: 7375 6c74 203d 2076 6d61 7070 6564 5f6a  sult = vmapped_j
-00010b40: 7670 5f66 756e 6328 7072 696d 616c 732c  vp_func(primals,
-00010b50: 2074 616e 6765 6e74 732c 202a 2a6b 7761   tangents, **kwa
-00010b60: 7267 7329 0a20 2020 2072 6574 7572 6e20  rgs).    return 
-00010b70: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
-00010b80: 783a 2042 6174 6368 6564 5661 6c75 6528  x: BatchedValue(
-00010b90: 782c 2030 292c 2072 6573 756c 7429 0a0a  x, 0), result)..
-00010ba0: 0a76 6d61 705f 696d 706c 735b 5472 616e  .vmap_impls[Tran
-00010bb0: 7366 6f72 6d73 2e4a 7670 4f70 5d20 3d20  sforms.JvpOp] = 
-00010bc0: 5f6a 7670 5f63 616c 6c5f 766d 6170 0a0a  _jvp_call_vmap..
-00010bd0: 0a64 6566 2076 6d61 7028 6675 6e63 2c20  .def vmap(func, 
-00010be0: 696e 5f64 696d 733d 302c 206f 7574 5f64  in_dims=0, out_d
-00010bf0: 696d 733d 302c 2061 7869 735f 7369 7a65  ims=0, axis_size
-00010c00: 3d4e 6f6e 6529 3a0a 2020 2020 2222 2256  =None):.    """V
-00010c10: 6563 746f 7269 7a69 6e67 2074 7261 6e73  ectorizing trans
-00010c20: 666f 726d 2066 6f72 2061 2054 6875 6e64  form for a Thund
-00010c30: 6572 2066 756e 6374 696f 6e2e 0a0a 2020  er function...  
-00010c40: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00010c50: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
-00010c60: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
-00010c70: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
-00010c80: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
-00010c90: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00010ca0: 6c61 626c 653a 2041 2076 6d61 7070 6564  lable: A vmapped
-00010cb0: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
-00010cc0: 6675 6e63 7469 6f6e 2e0a 2020 2020 2222  function..    ""
-00010cd0: 220a 0a20 2020 2023 2054 4f44 4f3a 2066  "..    # TODO: f
-00010ce0: 6c61 7474 656e 0a20 2020 2023 2049 6e20  latten.    # In 
-00010cf0: 4a41 5820 666c 6174 7465 6e69 6e67 206f  JAX flattening o
-00010d00: 6620 696e 5f64 696d 7320 6973 2072 6174  f in_dims is rat
-00010d10: 6865 7220 636f 6d70 6c69 6361 7465 6420  her complicated 
-00010d20: 6265 6361 7573 6520 6974 2063 616e 206f  because it can o
-00010d30: 7074 696f 6e61 6c6c 7920 6265 0a20 2020  ptionally be.   
-00010d40: 2023 2073 7065 6369 6669 6564 2061 7320   # specified as 
-00010d50: 6120 e280 9c70 7265 6669 78e2 809d 2070  a ...prefix... p
-00010d60: 7974 7265 652c 206d 6561 6e69 6e67 2074  ytree, meaning t
-00010d70: 6861 7420 6120 7369 6e67 6c65 206c 6561  hat a single lea
-00010d80: 6620 7661 6c75 6520 6361 6e20 6265 2061  f value can be a
-00010d90: 7070 6c69 6564 0a20 2020 2023 2074 6f20  pplied.    # to 
-00010da0: 616e 2065 6e74 6972 6520 7375 622d 7079  an entire sub-py
-00010db0: 7472 6565 2e0a 0a20 2020 2064 6566 2066  tree...    def f
-00010dc0: 6c61 7474 656e 5f66 756e 635f 666f 725f  latten_func_for_
-00010dd0: 766d 6170 2866 756e 632c 2061 7267 732c  vmap(func, args,
-00010de0: 206b 7761 7267 7329 3a0a 2020 2020 2020   kwargs):.      
-00010df0: 2020 666c 6174 5f61 7267 732c 2073 7065    flat_args, spe
-00010e00: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
-00010e10: 2828 6172 6773 2c20 6b77 6172 6773 2929  ((args, kwargs))
-00010e20: 0a0a 2020 2020 2020 2020 6465 6620 666c  ..        def fl
-00010e30: 6174 5f66 756e 6328 2a66 6c61 745f 6172  at_func(*flat_ar
-00010e40: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-00010e50: 2066 6e5f 6172 6773 2c20 666e 5f6b 7761   fn_args, fn_kwa
-00010e60: 7267 7320 3d20 7472 6565 5f75 6e66 6c61  rgs = tree_unfla
-00010e70: 7474 656e 2866 6c61 745f 6172 6773 2c20  tten(flat_args, 
-00010e80: 7370 6563 290a 2020 2020 2020 2020 2020  spec).          
-00010e90: 2020 7265 7475 726e 2066 756e 6328 2a66    return func(*f
-00010ea0: 6e5f 6172 6773 2c20 2a2a 666e 5f6b 7761  n_args, **fn_kwa
-00010eb0: 7267 7329 0a0a 2020 2020 2020 2020 7265  rgs)..        re
-00010ec0: 7475 726e 2066 6c61 745f 6675 6e63 2c20  turn flat_func, 
-00010ed0: 666c 6174 5f61 7267 732c 2073 7065 630a  flat_args, spec.
-00010ee0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
-00010ef0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-00010f00: 293a 0a20 2020 2020 2020 2066 756e 635f  ):.        func_
-00010f10: 666c 6174 2c20 6172 6773 5f66 6c61 742c  flat, args_flat,
-00010f20: 2061 7267 735f 7370 6563 203d 2066 6c61   args_spec = fla
-00010f30: 7474 656e 5f66 756e 635f 666f 725f 766d  tten_func_for_vm
-00010f40: 6170 2866 756e 632c 2061 7267 732c 206b  ap(func, args, k
-00010f50: 7761 7267 7329 0a20 2020 2020 2020 2069  wargs).        i
-00010f60: 6620 6973 696e 7374 616e 6365 2869 6e5f  f isinstance(in_
-00010f70: 6469 6d73 2c20 696e 7429 3a0a 2020 2020  dims, int):.    
-00010f80: 2020 2020 2020 2020 696e 5f64 696d 735f          in_dims_
-00010f90: 666c 6174 203d 2028 696e 5f64 696d 732c  flat = (in_dims,
-00010fa0: 2920 2a20 6c65 6e28 6172 6773 5f66 6c61  ) * len(args_fla
-00010fb0: 7429 0a20 2020 2020 2020 2065 6c73 653a  t).        else:
-00010fc0: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
-00010fd0: 6469 6d73 5f66 6c61 742c 2069 6e5f 6469  dims_flat, in_di
-00010fe0: 6d73 5f73 7065 6320 3d20 7472 6565 5f66  ms_spec = tree_f
-00010ff0: 6c61 7474 656e 2869 6e5f 6469 6d73 290a  latten(in_dims).
-00011000: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00011010: 7274 206c 656e 2869 6e5f 6469 6d73 5f66  rt len(in_dims_f
-00011020: 6c61 7429 203d 3d20 6c65 6e28 6172 6773  lat) == len(args
-00011030: 5f66 6c61 7429 2c20 2269 6e5f 6469 6d73  _flat), "in_dims
-00011040: 206d 7573 7420 6861 7665 2074 6865 2073   must have the s
-00011050: 616d 6520 6c65 6e67 7468 2061 7320 6172  ame length as ar
-00011060: 6773 2c20 6b77 6172 6773 220a 2020 2020  gs, kwargs".    
-00011070: 2020 2020 756e 6261 7463 6865 645f 6172      unbatched_ar
-00011080: 6773 5f66 6c61 7420 3d20 5b72 656d 6f76  gs_flat = [remov
-00011090: 655f 6261 7463 685f 6469 6d28 6172 6729  e_batch_dim(arg)
-000110a0: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-000110b0: 7267 2c20 5465 6e73 6f72 5072 6f78 7929  rg, TensorProxy)
-000110c0: 2065 6c73 6520 6172 6720 666f 7220 6172   else arg for ar
-000110d0: 6720 696e 2061 7267 735f 666c 6174 5d0a  g in args_flat].
-000110e0: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
-000110f0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-00011100: 2928 6675 6e63 5f66 6c61 742c 202a 756e  )(func_flat, *un
-00011110: 6261 7463 6865 645f 6172 6773 5f66 6c61  batched_args_fla
-00011120: 7429 0a20 2020 2020 2020 206f 7574 7320  t).        outs 
-00011130: 3d20 766d 6170 5f63 616c 6c28 6172 6773  = vmap_call(args
-00011140: 5f66 6c61 742c 2069 6e5f 6469 6d73 5f66  _flat, in_dims_f
-00011150: 6c61 742c 206f 7574 5f64 696d 732c 2061  lat, out_dims, a
-00011160: 7869 735f 7369 7a65 3d61 7869 735f 7369  xis_size=axis_si
-00011170: 7a65 2c20 6675 6e63 7469 6f6e 5f74 7261  ze, function_tra
-00011180: 6365 3d74 7261 6365 290a 2020 2020 2020  ce=trace).      
-00011190: 2020 7265 7475 726e 206f 7574 730a 0a20    return outs.. 
-000111a0: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
-000111b0: 720a 0a0a 2320 544f 444f 2054 6869 7320  r...# TODO This 
-000111c0: 6675 6e63 7469 6f6e 2063 6f6d 6d65 6e74  function comment
-000111d0: 6564 206f 7574 2062 6563 6175 7365 2069  ed out because i
-000111e0: 7420 6361 6c6c 7320 6d61 6b65 5f74 7261  t calls make_tra
-000111f0: 6365 642c 2077 6869 6368 2064 6f65 7320  ced, which does 
-00011200: 6e6f 7420 6578 6973 740a 2320 6465 6620  not exist.# def 
-00011210: 766d 6170 5f65 6167 6572 2866 756e 632c  vmap_eager(func,
-00011220: 2061 7267 732c 2069 6e5f 6469 6d73 3d30   args, in_dims=0
-00011230: 2c20 6f75 745f 6469 6d73 3d30 2c20 6178  , out_dims=0, ax
-00011240: 6973 5f73 697a 653d 4e6f 6e65 2c20 6578  is_size=None, ex
-00011250: 6563 7574 6f72 3d22 746f 7263 6822 293a  ecutor="torch"):
-00011260: 0a23 2020 2020 2022 2222 436f 6d70 7574  .#     """Comput
-00011270: 6573 2074 6865 2076 6d61 7020 6f66 2061  es the vmap of a
-00011280: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
-00011290: 6e2e 0a0a 2320 2020 2020 4172 6773 3a0a  n...#     Args:.
-000112a0: 2320 2020 2020 2020 2020 6675 6e63 2028  #         func (
-000112b0: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
-000112c0: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
-000112d0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
-000112e0: 0a23 2020 2020 2020 2020 2061 7267 7320  .#         args 
-000112f0: 285f 7479 7065 5f29 3a20 4172 6773 206f  (_type_): Args o
-00011300: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
-00011310: 2320 2020 2020 2020 2020 6578 6563 7574  #         execut
-00011320: 6f72 2028 7374 722c 206f 7074 696f 6e61  or (str, optiona
-00011330: 6c29 3a20 4578 6563 7574 6f72 2074 6f20  l): Executor to 
-00011340: 7573 652e 2044 6566 6175 6c74 7320 746f  use. Defaults to
-00011350: 2022 746f 7263 6822 2e0a 0a23 2020 2020   "torch"...#    
-00011360: 2052 6574 7572 6e73 3a0a 2320 2020 2020   Returns:.#     
-00011370: 2020 2020 5468 6520 7265 7375 6c74 206f      The result o
-00011380: 6620 7468 6520 766d 6170 7065 6420 6675  f the vmapped fu
-00011390: 6e63 7469 6f6e 2e0a 2320 2020 2020 2222  nction..#     ""
-000113a0: 220a 2320 2020 2020 2320 544f 444f 3a20  ".#     # TODO: 
-000113b0: 6669 7820 7468 6973 202d 206e 6f74 2061  fix this - not a
-000113c0: 6c6c 2061 7267 7320 6d61 7920 6265 2062  ll args may be b
-000113d0: 6174 6368 6564 0a23 2020 2020 2023 2054  atched.#     # T
-000113e0: 4f44 4f3a 2068 6572 6520 7765 2061 7373  ODO: here we ass
-000113f0: 756d 6520 6261 7463 6820 6178 6973 2069  ume batch axis i
-00011400: 7320 300a 2320 2020 2020 766d 6170 5f74  s 0.#     vmap_t
-00011410: 7261 6365 203d 206d 616b 655f 7472 6163  race = make_trac
-00011420: 6528 0a23 2020 2020 2020 2020 2076 6d61  e(.#         vma
-00011430: 7028 6675 6e63 2c20 696e 5f64 696d 733d  p(func, in_dims=
-00011440: 696e 5f64 696d 732c 206f 7574 5f64 696d  in_dims, out_dim
-00011450: 733d 6f75 745f 6469 6d73 2c20 6178 6973  s=out_dims, axis
-00011460: 5f73 697a 653d 6178 6973 5f73 697a 6529  _size=axis_size)
-00011470: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
-00011480: 746f 722c 0a23 2020 2020 2020 2020 202a  tor,.#         *
-00011490: 6172 6773 290a 2320 2020 2020 766d 6170  args).#     vmap
-000114a0: 5f74 7261 6365 6420 3d20 6d61 6b65 5f74  _traced = make_t
-000114b0: 7261 6365 6428 7061 7274 6961 6c28 6576  raced(partial(ev
-000114c0: 616c 5f74 7261 6365 2c20 766d 6170 5f74  al_trace, vmap_t
-000114d0: 7261 6365 292c 2065 7865 6375 746f 723d  race), executor=
-000114e0: 6578 6563 7574 6f72 290a 2320 2020 2020  executor).#     
-000114f0: 7265 7475 726e 2076 6d61 705f 7472 6163  return vmap_trac
-00011500: 6564 282a 6172 6773 290a 0a0a 2320 4a56  ed(*args)...# JV
-00011510: 5020 7472 616e 7366 6f72 6d0a 2320 2d2d  P transform.# --
-00011520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 4064  -----------...@d
-00011530: 6174 6163 6c61 7373 2866 726f 7a65 6e3d  ataclass(frozen=
-00011540: 5472 7565 290a 636c 6173 7320 4a56 5044  True).class JVPD
-00011550: 7561 6c3a 0a20 2020 2022 2222 4475 616c  ual:.    """Dual
-00011560: 206e 756d 6265 7220 666f 7220 7468 6520   number for the 
-00011570: 4a56 5020 7472 616e 7366 6f72 6d2e 0a0a  JVP transform...
-00011580: 2020 2020 4174 7472 6962 7574 6573 3a0a      Attributes:.
-00011590: 2020 2020 2020 2020 7072 696d 616c 3a20          primal: 
-000115a0: 5072 696d 616c 2076 616c 7565 2e0a 2020  Primal value..  
-000115b0: 2020 2020 2020 7461 6e67 656e 743a 2054        tangent: T
-000115c0: 616e 6765 6e74 2076 616c 7565 2e0a 2020  angent value..  
-000115d0: 2020 2222 220a 0a20 2020 2070 7269 6d61    """..    prima
-000115e0: 6c3a 2041 6e79 0a20 2020 2074 616e 6765  l: Any.    tange
-000115f0: 6e74 3a20 416e 790a 0a20 2020 2064 6566  nt: Any..    def
-00011600: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
-00011610: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-00011620: 656c 662e 7072 696d 616c 0a20 2020 2020  elf.primal.     
-00011630: 2020 2079 6965 6c64 2073 656c 662e 7461     yield self.ta
-00011640: 6e67 656e 740a 0a0a 6465 6620 7061 6972  ngent...def pair
-00011650: 5f74 6f5f 6a76 705f 6475 616c 2870 6169  _to_jvp_dual(pai
-00011660: 7229 3a0a 2020 2020 2222 2243 6f6e 7665  r):.    """Conve
-00011670: 7274 7320 6120 7061 6972 2074 6f20 6120  rts a pair to a 
-00011680: 4a56 5044 7561 6c2e 0a0a 2020 2020 4172  JVPDual...    Ar
-00011690: 6773 3a0a 2020 2020 2020 2020 7061 6972  gs:.        pair
-000116a0: 2028 5365 7175 656e 6365 293a 2050 6169   (Sequence): Pai
-000116b0: 7220 746f 2063 6f6e 7665 7274 2e0a 0a20  r to convert... 
-000116c0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-000116d0: 2020 2020 4a56 5044 7561 6c3a 204a 5650      JVPDual: JVP
-000116e0: 4475 616c 2072 6570 7265 7365 6e74 6174  Dual representat
-000116f0: 696f 6e20 6f66 2074 6865 2070 6169 722e  ion of the pair.
-00011700: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-00011710: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
-00011720: 204a 5650 4475 616c 293a 0a20 2020 2020   JVPDual):.     
-00011730: 2020 2072 6574 7572 6e20 7061 6972 0a20     return pair. 
-00011740: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00011750: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00011760: 6365 2870 6169 722c 2053 6571 7565 6e63  ce(pair, Sequenc
-00011770: 6529 2061 6e64 206c 656e 2870 6169 7229  e) and len(pair)
-00011780: 203d 3d20 320a 2020 2020 2020 2020 7265   == 2.        re
-00011790: 7475 726e 204a 5650 4475 616c 282a 7061  turn JVPDual(*pa
-000117a0: 6972 290a 0a0a 6465 6620 7369 6e5f 6a76  ir)...def sin_jv
-000117b0: 7028 613a 204a 5650 4475 616c 293a 0a20  p(a: JVPDual):. 
-000117c0: 2020 2078 2c20 7864 203d 2061 0a20 2020     x, xd = a.   
-000117d0: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
-000117e0: 7072 696d 732e 7369 6e28 7829 2c20 7072  prims.sin(x), pr
-000117f0: 696d 732e 636f 7328 7829 202a 2078 6429  ims.cos(x) * xd)
-00011800: 0a0a 0a64 6566 206d 756c 5f6a 7670 2861  ...def mul_jvp(a
-00011810: 3a20 4a56 5044 7561 6c2c 2062 3a20 4a56  : JVPDual, b: JV
-00011820: 5044 7561 6c29 3a0a 2020 2020 782c 2078  PDual):.    x, x
-00011830: 6420 3d20 610a 2020 2020 792c 2079 6420  d = a.    y, yd 
-00011840: 3d20 620a 2020 2020 7265 7475 726e 204a  = b.    return J
-00011850: 5650 4475 616c 2878 202a 2079 2c20 7820  VPDual(x * y, x 
-00011860: 2a20 7964 202b 2079 202a 2078 6429 0a0a  * yd + y * xd)..
-00011870: 0a64 6566 2061 6464 5f6a 7670 2861 3a20  .def add_jvp(a: 
-00011880: 4a56 5044 7561 6c2c 2062 3a20 4a56 5044  JVPDual, b: JVPD
-00011890: 7561 6c29 3a0a 2020 2020 782c 2078 6420  ual):.    x, xd 
-000118a0: 3d20 610a 2020 2020 792c 2079 6420 3d20  = a.    y, yd = 
-000118b0: 620a 2020 2020 7265 7475 726e 204a 5650  b.    return JVP
-000118c0: 4475 616c 2878 202b 2079 2c20 7864 202b  Dual(x + y, xd +
-000118d0: 2079 6429 0a0a 0a64 6566 2062 726f 6164   yd)...def broad
-000118e0: 6361 7374 5f69 6e5f 6469 6d5f 6a76 7028  cast_in_dim_jvp(
-000118f0: 613a 204a 5650 4475 616c 2c20 7368 6170  a: JVPDual, shap
-00011900: 653a 2074 7570 6c65 5b4a 5650 4475 616c  e: tuple[JVPDual
-00011910: 2c20 2e2e 2e5d 2c20 6272 6f61 6463 6173  , ...], broadcas
-00011920: 745f 6469 6d65 6e73 696f 6e73 3a20 7475  t_dimensions: tu
-00011930: 706c 655b 4a56 5044 7561 6c2c 202e 2e2e  ple[JVPDual, ...
-00011940: 5d29 202d 3e20 4a56 5044 7561 6c3a 0a20  ]) -> JVPDual:. 
-00011950: 2020 2078 2c20 7864 203d 2061 0a20 2020     x, xd = a.   
-00011960: 2023 2054 4f44 4f3a 2073 6861 7065 2061   # TODO: shape a
-00011970: 6e64 2062 726f 6164 6361 7374 5f64 696d  nd broadcast_dim
-00011980: 656e 7369 6f6e 7320 7368 6f75 6c64 2062  ensions should b
-00011990: 6520 7475 706c 6573 206f 6620 696e 7473  e tuples of ints
-000119a0: 0a20 2020 2023 2062 7574 2066 6f72 206e  .    # but for n
-000119b0: 6f77 2069 7427 7320 6120 7475 706c 6520  ow it's a tuple 
-000119c0: 6f66 204a 5650 4475 616c 730a 2020 2020  of JVPDuals.    
-000119d0: 6966 206c 656e 2873 6861 7065 2920 3e20  if len(shape) > 
-000119e0: 3020 616e 6420 6973 696e 7374 616e 6365  0 and isinstance
-000119f0: 2873 6861 7065 5b30 5d2c 204a 5650 4475  (shape[0], JVPDu
-00011a00: 616c 293a 0a20 2020 2020 2020 2073 6861  al):.        sha
-00011a10: 7065 2c20 5f20 3d20 7361 6665 5f7a 6970  pe, _ = safe_zip
-00011a20: 282a 7368 6170 6529 0a20 2020 2069 6620  (*shape).    if 
-00011a30: 6c65 6e28 6272 6f61 6463 6173 745f 6469  len(broadcast_di
-00011a40: 6d65 6e73 696f 6e73 2920 3e20 3020 616e  mensions) > 0 an
-00011a50: 6420 6973 696e 7374 616e 6365 2862 726f  d isinstance(bro
-00011a60: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00011a70: 735b 305d 2c20 4a56 5044 7561 6c29 3a0a  s[0], JVPDual):.
-00011a80: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
-00011a90: 745f 6469 6d65 6e73 696f 6e73 2c20 5f20  t_dimensions, _ 
-00011aa0: 3d20 7361 6665 5f7a 6970 282a 6272 6f61  = safe_zip(*broa
-00011ab0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-00011ac0: 290a 2020 2020 7265 7475 726e 204a 5650  ).    return JVP
-00011ad0: 4475 616c 280a 2020 2020 2020 2020 7072  Dual(.        pr
-00011ae0: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
-00011af0: 5f64 696d 2878 2c20 7368 6170 652c 2062  _dim(x, shape, b
-00011b00: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-00011b10: 6f6e 7329 2c20 7072 696d 732e 6272 6f61  ons), prims.broa
-00011b20: 6463 6173 745f 696e 5f64 696d 2878 642c  dcast_in_dim(xd,
-00011b30: 2073 6861 7065 2c20 6272 6f61 6463 6173   shape, broadcas
-00011b40: 745f 6469 6d65 6e73 696f 6e73 290a 2020  t_dimensions).  
-00011b50: 2020 290a 0a0a 6465 6620 756e 7061 636b    )...def unpack
-00011b60: 5f73 6571 7565 6e63 655f 6a76 7028 7365  _sequence_jvp(se
-00011b70: 7175 656e 6365 3a20 4a56 5044 7561 6c2c  quence: JVPDual,
-00011b80: 206c 656e 6774 683a 204a 5650 4475 616c   length: JVPDual
-00011b90: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
-00011ba0: 2020 7820 3d20 7472 6565 5f6d 6170 286c    x = tree_map(l
-00011bb0: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
-00011bc0: 6c2c 2073 6571 7565 6e63 6529 0a20 2020  l, sequence).   
-00011bd0: 2078 6420 3d20 7472 6565 5f6d 6170 286c   xd = tree_map(l
-00011be0: 616d 6264 6120 783a 2078 2e74 616e 6765  ambda x: x.tange
-00011bf0: 6e74 2c20 7365 7175 656e 6365 290a 2020  nt, sequence).  
-00011c00: 2020 6c65 6e67 7468 2c20 5f20 3d20 6c65    length, _ = le
-00011c10: 6e67 7468 0a20 2020 2070 7269 6d61 6c73  ngth.    primals
-00011c20: 203d 2070 7269 6d73 2e75 6e70 6163 6b5f   = prims.unpack_
-00011c30: 7365 7175 656e 6365 2878 2c20 6c65 6e67  sequence(x, leng
-00011c40: 7468 290a 2020 2020 7461 6e67 656e 7473  th).    tangents
-00011c50: 203d 2070 7269 6d73 2e75 6e70 6163 6b5f   = prims.unpack_
-00011c60: 7365 7175 656e 6365 2878 642c 206c 656e  sequence(xd, len
-00011c70: 6774 6829 0a20 2020 2072 6574 7572 6e20  gth).    return 
-00011c80: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-00011c90: 5f6a 7670 5f64 7561 6c2c 2073 6166 655f  _jvp_dual, safe_
-00011ca0: 7a69 7028 7072 696d 616c 732c 2074 616e  zip(primals, tan
-00011cb0: 6765 6e74 7329 290a 0a0a 6465 6620 756e  gents))...def un
-00011cc0: 7061 636b 5f74 7269 7669 616c 5f6a 7670  pack_trivial_jvp
-00011cd0: 2878 3a20 4a56 5044 7561 6c29 202d 3e20  (x: JVPDual) -> 
-00011ce0: 4a56 5044 7561 6c3a 0a20 2020 2072 6574  JVPDual:.    ret
-00011cf0: 7572 6e20 780a 0a0a 6a76 705f 696d 706c  urn x...jvp_impl
-00011d00: 733a 2064 6963 745b 7072 696d 732e 5379  s: dict[prims.Sy
-00011d10: 6d62 6f6c 2c20 4361 6c6c 6162 6c65 5d20  mbol, Callable] 
-00011d20: 3d20 6469 6374 2829 0a0a 6a76 705f 696d  = dict()..jvp_im
-00011d30: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-00011d40: 732e 5349 4e5d 203d 2073 696e 5f6a 7670  s.SIN] = sin_jvp
-00011d50: 0a6a 7670 5f69 6d70 6c73 5b70 7269 6d73  .jvp_impls[prims
-00011d60: 2e50 7269 6d49 4473 2e4d 554c 5d20 3d20  .PrimIDs.MUL] = 
-00011d70: 6d75 6c5f 6a76 700a 6a76 705f 696d 706c  mul_jvp.jvp_impl
-00011d80: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-00011d90: 4144 445d 203d 2061 6464 5f6a 7670 0a6a  ADD] = add_jvp.j
-00011da0: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
-00011db0: 7269 6d49 4473 2e42 524f 4144 4341 5354  rimIDs.BROADCAST
-00011dc0: 5f49 4e5f 4449 4d5d 203d 2062 726f 6164  _IN_DIM] = broad
-00011dd0: 6361 7374 5f69 6e5f 6469 6d5f 6a76 700a  cast_in_dim_jvp.
-00011de0: 2320 6a76 705f 696d 706c 735b 7072 696d  # jvp_impls[prim
-00011df0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
-00011e00: 5f53 4551 5545 4e43 455d 203d 2075 6e70  _SEQUENCE] = unp
-00011e10: 6163 6b5f 7365 7175 656e 6365 5f6a 7670  ack_sequence_jvp
-00011e20: 0a23 206a 7670 5f69 6d70 6c73 5b70 7269  .# jvp_impls[pri
-00011e30: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-00011e40: 4b5f 5452 4956 4941 4c5d 203d 2075 6e70  K_TRIVIAL] = unp
-00011e50: 6163 6b5f 7472 6976 6961 6c5f 6a76 700a  ack_trivial_jvp.
-00011e60: 0a0a 6465 6620 6a76 705f 7379 6d62 6f6c  ..def jvp_symbol
-00011e70: 5f6d 6170 7065 7228 7379 6d62 6f6c 3a20  _mapper(symbol: 
-00011e80: 7072 696d 732e 5379 6d62 6f6c 293a 0a20  prims.Symbol):. 
-00011e90: 2020 2022 2222 4d61 7073 2061 2073 796d     """Maps a sym
-00011ea0: 626f 6c20 746f 2061 204a 5650 2066 756e  bol to a JVP fun
-00011eb0: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
-00011ec0: 6174 6573 2069 742e 0a0a 2020 2020 4172  ates it...    Ar
-00011ed0: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
-00011ee0: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
-00011ef0: 293a 2053 796d 626f 6c20 746f 2065 7661  ): Symbol to eva
-00011f00: 6c75 6174 652e 0a0a 2020 2020 5261 6973  luate...    Rais
-00011f10: 6573 3a0a 2020 2020 2020 2020 4e6f 7449  es:.        NotI
-00011f20: 6d70 6c65 6d65 6e74 6564 4572 726f 723a  mplementedError:
-00011f30: 2049 6620 7468 6520 4a56 5020 666f 7220   If the JVP for 
-00011f40: 7468 6520 7379 6d62 6f6c 2069 7320 6e6f  the symbol is no
-00011f50: 7420 696d 706c 656d 656e 7465 642e 0a0a  t implemented...
-00011f60: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00011f70: 2020 2020 2043 616c 6c61 626c 653a 204a       Callable: J
-00011f80: 5650 2066 756e 6374 696f 6e20 7468 6174  VP function that
-00011f90: 2065 7661 6c75 6174 6573 2074 6865 2073   evaluates the s
-00011fa0: 796d 626f 6c2e 0a20 2020 2022 2222 0a0a  ymbol..    """..
-00011fb0: 2020 2020 6465 6620 7772 6170 5f61 7267      def wrap_arg
-00011fc0: 2878 293a 0a20 2020 2020 2020 2069 6620  (x):.        if 
-00011fd0: 6973 696e 7374 616e 6365 2878 2c20 4a56  isinstance(x, JV
-00011fe0: 5044 7561 6c29 3a0a 2020 2020 2020 2020  PDual):.        
-00011ff0: 2020 2020 7265 7475 726e 2078 0a20 2020      return x.   
-00012000: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00012010: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
-00012020: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00012030: 7572 6e20 4a56 5044 7561 6c28 782c 2074  urn JVPDual(x, t
-00012040: 7970 6528 7829 2830 2929 0a20 2020 2020  ype(x)(0)).     
-00012050: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00012060: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00012070: 4572 726f 7228 6622 4a56 5020 7772 6170  Error(f"JVP wrap
-00012080: 5f61 7267 2067 6f74 2061 6e20 756e 7375  _arg got an unsu
-00012090: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
-000120a0: 7065 2878 297d 2229 0a0a 2020 2020 2320  pe(x)}")..    # 
-000120b0: 4966 2073 796d 626f 6c2e 6172 6773 2064  If symbol.args d
-000120c0: 6f65 736e 2774 2068 6176 6520 7375 6263  oesn't have subc
-000120d0: 6c61 7373 6573 206f 6620 5661 7269 6162  lasses of Variab
-000120e0: 6c65 2c20 7468 656e 2077 6520 6e65 6564  le, then we need
-000120f0: 2074 6f20 7265 7475 726e 2061 207a 6572   to return a zer
-00012100: 6f20 7461 6e67 656e 740a 2020 2020 2320  o tangent.    # 
-00012110: 544f 444f 3a20 7468 6572 6520 6d61 7920  TODO: there may 
-00012120: 6265 2061 2062 6574 7465 7220 7761 7920  be a better way 
-00012130: 746f 2064 6574 6563 7420 636f 6e73 7461  to detect consta
-00012140: 6e74 7320 696e 2074 6865 2074 7261 6365  nts in the trace
-00012150: 0a20 2020 2069 6620 7379 6d62 6f6c 2e61  .    if symbol.a
-00012160: 7265 5f61 6c6c 5f61 7267 735f 636f 6e73  re_all_args_cons
-00012170: 7461 6e74 3a0a 0a20 2020 2020 2020 2064  tant:..        d
-00012180: 6566 207a 6572 6f73 5f6c 696b 6528 7829  ef zeros_like(x)
-00012190: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000121a0: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
-000121b0: 656e 736f 7250 726f 7879 293a 0a20 2020  ensorProxy):.   
-000121c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000121d0: 7572 6e20 6675 6c6c 5f6c 696b 6528 782c  urn full_like(x,
-000121e0: 2066 696c 6c5f 7661 6c75 653d 3029 0a20   fill_value=0). 
-000121f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00012200: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-00012210: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
-00012220: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012230: 726e 2074 7970 6528 782e 7661 6c75 6529  rn type(x.value)
-00012240: 2830 290a 2020 2020 2020 2020 2020 2020  (0).            
-00012250: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00012260: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
-00012270: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012280: 726e 2074 7970 6528 7829 2830 290a 2020  rn type(x)(0).  
-00012290: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000122c0: 2866 227a 6572 6f73 5f6c 696b 6520 696e  (f"zeros_like in
-000122d0: 7369 6465 204a 5650 2067 6f74 2061 6e20  side JVP got an 
-000122e0: 756e 7375 7070 6f72 7465 6420 7479 7065  unsupported type
-000122f0: 207b 7479 7065 2878 297d 2229 0a0a 2020   {type(x)}")..  
-00012300: 2020 2020 2020 6465 6620 6a76 705f 696d        def jvp_im
-00012310: 706c 5f63 6f6e 7374 2873 796d 626f 6c2c  pl_const(symbol,
-00012320: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-00012330: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-00012340: 7269 6d61 6c73 203d 2073 796d 626f 6c5f  rimals = symbol_
-00012350: 746f 5f65 7661 6c28 7379 6d62 6f6c 2928  to_eval(symbol)(
-00012360: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-00012370: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00012380: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
-00012390: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
-000123a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000123b0: 616e 6765 6e74 7320 3d20 7475 706c 6528  angents = tuple(
-000123c0: 7a65 726f 735f 6c69 6b65 2870 2920 666f  zeros_like(p) fo
-000123d0: 7220 7020 696e 2070 7269 6d61 6c73 290a  r p in primals).
-000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123f0: 7265 7475 726e 2073 6166 655f 6d61 7028  return safe_map(
-00012400: 7061 6972 5f74 6f5f 6a76 705f 6475 616c  pair_to_jvp_dual
-00012410: 2c20 7361 6665 5f7a 6970 2870 7269 6d61  , safe_zip(prima
-00012420: 6c73 2c20 7461 6e67 656e 7473 2929 0a20  ls, tangents)). 
-00012430: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012440: 6e20 4a56 5044 7561 6c28 7072 696d 616c  n JVPDual(primal
-00012450: 732c 207a 6572 6f73 5f6c 696b 6528 7072  s, zeros_like(pr
-00012460: 696d 616c 7329 290a 0a20 2020 2020 2020  imals))..       
-00012470: 2072 6574 7572 6e20 7061 7274 6961 6c28   return partial(
-00012480: 6a76 705f 696d 706c 5f63 6f6e 7374 2c20  jvp_impl_const, 
-00012490: 7379 6d62 6f6c 290a 0a20 2020 2023 204e  symbol)..    # N
-000124a0: 6f72 6d61 6c20 6361 7365 2c20 7765 2068  ormal case, we h
-000124b0: 6176 6520 6120 7072 6f78 7920 7461 6e67  ave a proxy tang
-000124c0: 656e 740a 2020 2020 6a76 705f 696d 706c  ent.    jvp_impl
-000124d0: 203d 206a 7670 5f69 6d70 6c73 2e67 6574   = jvp_impls.get
-000124e0: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
-000124f0: 2020 2020 6966 206a 7670 5f69 6d70 6c20      if jvp_impl 
-00012500: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00012510: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-00012520: 656e 7465 6445 7272 6f72 2866 224a 5650  entedError(f"JVP
-00012530: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
-00012540: 2e69 647d 2069 7320 6e6f 7420 696d 706c  .id} is not impl
-00012550: 656d 656e 7465 6422 290a 0a20 2020 2064  emented")..    d
-00012560: 6566 205f 6a76 705f 696d 706c 282a 6172  ef _jvp_impl(*ar
-00012570: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-00012580: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
-00012590: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
-000125a0: 2061 7267 7329 0a20 2020 2020 2020 2023   args).        #
-000125b0: 2045 7870 6563 7469 6e67 204a 5650 4475   Expecting JVPDu
-000125c0: 616c 7320 7772 6170 7069 6e67 2070 6169  als wrapping pai
-000125d0: 7273 206f 6620 7072 696d 616c 7320 616e  rs of primals an
-000125e0: 6420 7461 6e67 656e 7473 0a20 2020 2020  d tangents.     
-000125f0: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
-00012600: 696e 7374 616e 6365 2861 7267 2c20 4a56  instance(arg, JV
-00012610: 5044 7561 6c29 2066 6f72 2061 7267 2069  PDual) for arg i
-00012620: 6e20 7472 6565 5f66 6c61 7474 656e 2861  n tree_flatten(a
-00012630: 7267 7329 5b30 5d29 0a20 2020 2020 2020  rgs)[0]).       
-00012640: 2072 6574 7572 6e20 6a76 705f 696d 706c   return jvp_impl
-00012650: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-00012660: 290a 0a20 2020 2072 6574 7572 6e20 5f6a  )..    return _j
-00012670: 7670 5f69 6d70 6c0a 0a0a 6465 6620 5f6a  vp_impl...def _j
-00012680: 7670 5f63 616c 6c5f 6d65 7461 6675 6e63  vp_call_metafunc
-00012690: 2864 6574 6163 6865 643a 2062 6f6f 6c2c  (detached: bool,
-000126a0: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
-000126b0: 7473 2c20 2a2c 2066 756e 6374 696f 6e5f  ts, *, function_
-000126c0: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
-000126d0: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
-000126e0: 4d65 7461 6675 6e63 7469 6f6e 2066 6f72  Metafunction for
-000126f0: 2074 6865 204a 5650 2074 7261 6e73 666f   the JVP transfo
-00012700: 726d 2e0a 0a20 2020 2041 7267 733a 0a20  rm...    Args:. 
-00012710: 2020 2020 2020 2064 6574 6163 6865 6420         detached 
-00012720: 2862 6f6f 6c29 3a20 5768 6574 6865 7220  (bool): Whether 
-00012730: 746f 2064 6574 6163 6820 7468 6520 7472  to detach the tr
-00012740: 6163 652e 0a20 2020 2020 2020 2070 7269  ace..        pri
-00012750: 6d61 6c73 2028 5475 706c 655b 5072 6f78  mals (Tuple[Prox
-00012760: 795d 293a 2050 7269 6d61 6c20 7661 6c75  y]): Primal valu
-00012770: 6573 2e0a 2020 2020 2020 2020 7461 6e67  es..        tang
-00012780: 656e 7473 2028 5475 706c 655b 5072 6f78  ents (Tuple[Prox
-00012790: 795d 293a 2054 616e 6765 6e74 2076 616c  y]): Tangent val
-000127a0: 7565 732e 0a20 2020 2020 2020 2066 756e  ues..        fun
-000127b0: 6374 696f 6e5f 7472 6163 6520 2854 7261  ction_trace (Tra
-000127c0: 6365 293a 2054 7261 6365 206f 6620 7468  ce): Trace of th
-000127d0: 6520 6675 6e63 7469 6f6e 2074 6f20 6265  e function to be
-000127e0: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
-000127f0: 2020 2020 2020 6b77 6172 6773 3a20 4b65        kwargs: Ke
-00012800: 7977 6f72 6420 6172 6775 6d65 6e74 732e  yword arguments.
-00012810: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-00012820: 2020 2020 2020 4173 7365 7274 696f 6e45        AssertionE
-00012830: 7272 6f72 3a20 4966 2074 6865 204a 5650  rror: If the JVP
-00012840: 2066 6f72 206b 6579 776f 7264 2061 7267   for keyword arg
-00012850: 756d 656e 7473 2069 7320 6e6f 7420 696d  uments is not im
-00012860: 706c 656d 656e 7465 642e 0a0a 2020 2020  plemented...    
-00012870: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00012880: 2052 6573 756c 7420 6f66 2074 6865 204a   Result of the J
-00012890: 5650 2074 7261 6e73 666f 726d 2e0a 2020  VP transform..  
-000128a0: 2020 2222 220a 2020 2020 6173 7365 7274    """.    assert
-000128b0: 206c 656e 286b 7761 7267 7329 203d 3d20   len(kwargs) == 
-000128c0: 302c 2022 4a56 5020 666f 7220 6b77 6172  0, "JVP for kwar
-000128d0: 6773 2069 7320 6e6f 7420 696d 706c 656d  gs is not implem
-000128e0: 656e 7465 6422 0a0a 2020 2020 6374 7820  ented"..    ctx 
-000128f0: 3d20 6465 7461 6368 6564 5f74 7261 6365  = detached_trace
-00012900: 2829 2069 6620 6465 7461 6368 6564 2065  () if detached e
-00012910: 6c73 6520 6e75 6c6c 636f 6e74 6578 7428  lse nullcontext(
-00012920: 290a 2020 2020 7769 7468 2063 7478 3a0a  ).    with ctx:.
-00012930: 2020 2020 2020 2020 2320 5772 6170 7069          # Wrappi
-00012940: 6e67 2074 6865 2070 7269 6d61 6c73 2061  ng the primals a
-00012950: 6e64 2074 616e 6765 6e74 7320 696e 204a  nd tangents in J
-00012960: 5650 4475 616c 7320 6973 206e 6f74 2073  VPDuals is not s
-00012970: 7472 6963 746c 7920 6e65 6365 7373 6172  trictly necessar
-00012980: 792c 2062 7574 2069 7420 6d61 6b65 730a  y, but it makes.
-00012990: 2020 2020 2020 2020 2320 7468 6520 636f          # the co
-000129a0: 6465 206d 6f72 6520 7265 6164 6162 6c65  de more readable
-000129b0: 0a20 2020 2020 2020 2023 2057 6520 7072  .        # We pr
-000129c0: 6f70 6167 6174 6520 7468 6520 4a56 5044  opagate the JVPD
-000129d0: 7561 6c73 2074 6872 6f75 6768 2074 6865  uals through the
-000129e0: 2074 7261 6365 2c20 616e 6420 7468 656e   trace, and then
-000129f0: 2075 6e77 7261 7020 7468 656d 2061 7420   unwrap them at 
-00012a00: 7468 6520 656e 640a 2020 2020 2020 2020  the end.        
-00012a10: 7072 696d 616c 735f 7461 6e67 656e 7473  primals_tangents
-00012a20: 5f64 7561 6c73 203d 2073 6166 655f 6d61  _duals = safe_ma
-00012a30: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
-00012a40: 616c 2c20 7361 6665 5f7a 6970 2870 7269  al, safe_zip(pri
-00012a50: 6d61 6c73 2c20 7461 6e67 656e 7473 2929  mals, tangents))
-00012a60: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-00012a70: 3d20 6576 616c 5f74 7261 6365 2866 756e  = eval_trace(fun
-00012a80: 6374 696f 6e5f 7472 6163 652c 202a 7072  ction_trace, *pr
-00012a90: 696d 616c 735f 7461 6e67 656e 7473 5f64  imals_tangents_d
-00012aa0: 7561 6c73 2c20 7379 6d62 6f6c 5f6d 6170  uals, symbol_map
-00012ab0: 7065 723d 6a76 705f 7379 6d62 6f6c 5f6d  per=jvp_symbol_m
-00012ac0: 6170 7065 7229 0a20 2020 2020 2020 2023  apper).        #
-00012ad0: 2055 6e77 7261 7070 696e 6720 7468 6520   Unwrapping the 
-00012ae0: 4a56 5044 7561 6c73 0a20 2020 2020 2020  JVPDuals.       
-00012af0: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
-00012b00: 6573 756c 742c 2053 6571 7565 6e63 6529  esult, Sequence)
-00012b10: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00012b20: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
-00012b30: 6e63 6528 782c 204a 5650 4475 616c 2920  nce(x, JVPDual) 
-00012b40: 666f 7220 7820 696e 2072 6573 756c 7429  for x in result)
-00012b50: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00012b60: 6d61 6c73 2c20 7461 6e67 656e 7473 203d  mals, tangents =
-00012b70: 2075 6e7a 6970 3228 7265 7375 6c74 290a   unzip2(result).
-00012b80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012b90: 726e 2070 7269 6d61 6c73 2c20 7461 6e67  rn primals, tang
-00012ba0: 656e 7473 0a20 2020 2020 2020 2061 7373  ents.        ass
-00012bb0: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
-00012bc0: 6573 756c 742c 204a 5650 4475 616c 290a  esult, JVPDual).
-00012bd0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00012be0: 6573 756c 742e 7072 696d 616c 2c20 7265  esult.primal, re
-00012bf0: 7375 6c74 2e74 616e 6765 6e74 0a0a 0a6a  sult.tangent...j
-00012c00: 7670 5f63 616c 6c20 3d20 5379 6d62 6f6c  vp_call = Symbol
-00012c10: 2869 643d 5472 616e 7366 6f72 6d73 2e4a  (id=Transforms.J
-00012c20: 7670 4f70 2c20 6e61 6d65 3d22 6a76 705f  vpOp, name="jvp_
-00012c30: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
-00012c40: 6961 6c28 5f6a 7670 5f63 616c 6c5f 6d65  ial(_jvp_call_me
-00012c50: 7461 6675 6e63 2c20 4661 6c73 6529 290a  tafunc, False)).
-00012c60: 0a0a 6465 6620 5f69 6465 6e74 6974 795f  ..def _identity_
-00012c70: 6361 6c6c 5f6a 7670 282a 6172 6773 3a20  call_jvp(*args: 
-00012c80: 4a56 5044 7561 6c2c 2074 7261 6365 3a20  JVPDual, trace: 
-00012c90: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-00012ca0: 3a0a 2020 2020 7072 696d 616c 732c 2074  :.    primals, t
-00012cb0: 616e 6765 6e74 7320 3d20 756e 7a69 7032  angents = unzip2
-00012cc0: 2861 7267 7329 0a20 2020 206f 7574 5f70  (args).    out_p
-00012cd0: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
-00012ce0: 656e 7473 203d 205f 6a76 705f 6361 6c6c  ents = _jvp_call
-00012cf0: 5f6d 6574 6166 756e 6328 4661 6c73 652c  _metafunc(False,
-00012d00: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
-00012d10: 7473 2c20 7472 6163 652c 202a 2a6b 7761  ts, trace, **kwa
-00012d20: 7267 7329 0a20 2020 2069 6620 6973 696e  rgs).    if isin
-00012d30: 7374 616e 6365 286f 7574 5f70 7269 6d61  stance(out_prima
-00012d40: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
-00012d50: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
-00012d60: 6665 5f6d 6170 2870 6169 725f 746f 5f6a  fe_map(pair_to_j
-00012d70: 7670 5f64 7561 6c2c 2073 6166 655f 7a69  vp_dual, safe_zi
-00012d80: 7028 6f75 745f 7072 696d 616c 732c 206f  p(out_primals, o
-00012d90: 7574 5f74 616e 6765 6e74 7329 290a 2020  ut_tangents)).  
-00012da0: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
-00012db0: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
-00012dc0: 745f 7461 6e67 656e 7473 290a 0a0a 6a76  t_tangents)...jv
-00012dd0: 705f 696d 706c 735b 5472 616e 7366 6f72  p_impls[Transfor
-00012de0: 6d73 2e49 6465 6e74 6974 794f 705d 203d  ms.IdentityOp] =
-00012df0: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
-00012e00: 6a76 700a 0a0a 6465 6620 5f76 6d61 705f  jvp...def _vmap_
-00012e10: 6361 6c6c 5f6a 7670 2861 7267 733a 204a  call_jvp(args: J
-00012e20: 5650 4475 616c 2c20 696e 5f64 696d 732c  VPDual, in_dims,
-00012e30: 206f 7574 5f64 696d 732c 2061 7869 735f   out_dims, axis_
-00012e40: 7369 7a65 2c20 7472 6163 653a 2054 7261  size, trace: Tra
-00012e50: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-00012e60: 2020 2070 7269 6d61 6c73 2c20 7461 6e67     primals, tang
-00012e70: 656e 7473 203d 2073 6166 655f 7a69 7028  ents = safe_zip(
-00012e80: 2a61 7267 7329 0a20 2020 2069 6e5f 6469  *args).    in_di
-00012e90: 6d73 2c20 5f20 3d20 7361 6665 5f7a 6970  ms, _ = safe_zip
-00012ea0: 282a 696e 5f64 696d 7329 0a20 2020 206f  (*in_dims).    o
-00012eb0: 7574 5f64 696d 732c 205f 203d 2073 6166  ut_dims, _ = saf
-00012ec0: 655f 7a69 7028 2a6f 7574 5f64 696d 7329  e_zip(*out_dims)
-00012ed0: 0a20 2020 2076 6d61 7070 6564 5f74 7261  .    vmapped_tra
-00012ee0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-00012ef0: 7261 6365 2829 280a 2020 2020 2020 2020  race()(.        
-00012f00: 766d 6170 2870 6172 7469 616c 2865 7661  vmap(partial(eva
-00012f10: 6c5f 7472 6163 652c 2074 7261 6365 292c  l_trace, trace),
-00012f20: 2069 6e5f 6469 6d73 3d69 6e5f 6469 6d73   in_dims=in_dims
-00012f30: 2c20 6f75 745f 6469 6d73 3d6f 7574 5f64  , out_dims=out_d
-00012f40: 696d 732c 2061 7869 735f 7369 7a65 3d61  ims, axis_size=a
-00012f50: 7869 735f 7369 7a65 292c 202a 7072 696d  xis_size), *prim
-00012f60: 616c 730a 2020 2020 290a 2020 2020 766d  als.    ).    vm
-00012f70: 6170 7065 645f 6675 6e63 203d 2070 6172  apped_func = par
-00012f80: 7469 616c 2865 7661 6c5f 7472 6163 652c  tial(eval_trace,
-00012f90: 2076 6d61 7070 6564 5f74 7261 6365 290a   vmapped_trace).
-00012fa0: 2020 2020 6f75 745f 7072 696d 616c 732c      out_primals,
-00012fb0: 206f 7574 5f74 616e 6765 6e74 7320 3d20   out_tangents = 
-00012fc0: 6a76 7028 766d 6170 7065 645f 6675 6e63  jvp(vmapped_func
-00012fd0: 2928 7072 696d 616c 732c 2074 616e 6765  )(primals, tange
-00012fe0: 6e74 732c 202a 2a6b 7761 7267 7329 0a20  nts, **kwargs). 
-00012ff0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00013000: 286f 7574 5f70 7269 6d61 6c73 2c20 5365  (out_primals, Se
-00013010: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-00013020: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-00013030: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
-00013040: 6c2c 2073 6166 655f 7a69 7028 6f75 745f  l, safe_zip(out_
-00013050: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00013060: 6765 6e74 7329 290a 2020 2020 7265 7475  gents)).    retu
-00013070: 726e 204a 5650 4475 616c 286f 7574 5f70  rn JVPDual(out_p
-00013080: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
-00013090: 656e 7473 290a 0a0a 6a76 705f 696d 706c  ents)...jvp_impl
-000130a0: 735b 5472 616e 7366 6f72 6d73 2e56 6d61  s[Transforms.Vma
-000130b0: 704f 705d 203d 205f 766d 6170 5f63 616c  pOp] = _vmap_cal
-000130c0: 6c5f 6a76 700a 0a0a 6465 6620 6a76 7028  l_jvp...def jvp(
-000130d0: 6675 6e63 293a 0a20 2020 2022 2222 4a61  func):.    """Ja
-000130e0: 636f 6269 616e 2d76 6563 746f 7220 7072  cobian-vector pr
-000130f0: 6f64 7563 7420 7472 616e 7366 6f72 6d20  oduct transform 
-00013100: 666f 7220 6120 5468 756e 6465 7220 6675  for a Thunder fu
-00013110: 6e63 7469 6f6e 2e0a 0a20 2020 2041 7267  nction...    Arg
-00013120: 733a 0a20 2020 2020 2020 2066 756e 6320  s:.        func 
-00013130: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
-00013140: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
-00013150: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
-00013160: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00013170: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00013180: 3a20 4120 6675 6e63 7469 6f6e 2074 6861  : A function tha
-00013190: 7420 636f 6d70 7574 6573 2074 6865 204a  t computes the J
-000131a0: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
-000131b0: 726f 6475 6374 0a20 2020 2020 2020 2020  roduct.         
-000131c0: 2020 2074 616b 696e 6720 7072 696d 616c     taking primal
-000131d0: 7320 616e 6420 7461 6e67 656e 7473 2061  s and tangents a
-000131e0: 7320 6172 6775 6d65 6e74 732e 0a20 2020  s arguments..   
-000131f0: 2022 2222 0a0a 2020 2020 6465 6620 7772   """..    def wr
-00013200: 6170 7065 7228 7072 696d 616c 732c 2074  apper(primals, t
-00013210: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
-00013220: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
-00013230: 7563 745f 7472 6163 6528 2928 6675 6e63  uct_trace()(func
-00013240: 2c20 2a70 7269 6d61 6c73 290a 2020 2020  , *primals).    
-00013250: 2020 2020 7265 7475 726e 206a 7670 5f63      return jvp_c
-00013260: 616c 6c28 7072 696d 616c 732c 2074 616e  all(primals, tan
-00013270: 6765 6e74 732c 2066 756e 6374 696f 6e5f  gents, function_
-00013280: 7472 6163 653d 7472 6163 6529 0a0a 2020  trace=trace)..  
-00013290: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
-000132a0: 0a0a 0a23 2054 4f44 4f20 5468 6973 2066  ...# TODO This f
-000132b0: 756e 6374 696f 6e20 636f 6d6d 656e 7465  unction commente
-000132c0: 6420 6f75 7420 6265 6361 7573 6520 6974  d out because it
-000132d0: 2063 616c 6c73 206d 616b 655f 7472 6163   calls make_trac
-000132e0: 6564 2c20 7768 6963 6820 646f 6573 206e  ed, which does n
-000132f0: 6f74 2065 7869 7374 0a23 2064 6566 206a  ot exist.# def j
-00013300: 7670 5f65 6167 6572 2866 756e 632c 2070  vp_eager(func, p
-00013310: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
-00013320: 2c20 6578 6563 7574 6f72 3d22 746f 7263  , executor="torc
-00013330: 6822 293a 0a23 2020 2020 2022 2222 436f  h"):.#     """Co
-00013340: 6d70 7574 6573 2074 6865 204a 6163 6f62  mputes the Jacob
-00013350: 6961 6e2d 7665 6374 6f72 2070 726f 6475  ian-vector produ
-00013360: 6374 206f 6620 6120 5468 756e 6465 7220  ct of a Thunder 
-00013370: 6675 6e63 7469 6f6e 2e0a 0a23 2020 2020  function...#    
-00013380: 2041 7267 733a 0a23 2020 2020 2020 2020   Args:.#        
-00013390: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
-000133a0: 3a20 4120 5468 756e 6465 7220 6675 6e63  : A Thunder func
-000133b0: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
-000133c0: 666f 726d 6564 2e0a 2320 2020 2020 2020  formed..#       
-000133d0: 2020 7072 696d 616c 7320 285f 7479 7065    primals (_type
-000133e0: 5f29 3a20 5072 696d 616c 7320 6f66 2074  _): Primals of t
-000133f0: 6865 2066 756e 6374 696f 6e2e 0a23 2020  he function..#  
-00013400: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
-00013410: 285f 7479 7065 5f29 3a20 5461 6e67 656e  (_type_): Tangen
-00013420: 7473 206f 6620 7468 6520 6675 6e63 7469  ts of the functi
-00013430: 6f6e 2e0a 2320 2020 2020 2020 2020 6578  on..#         ex
-00013440: 6563 7574 6f72 2028 7374 722c 206f 7074  ecutor (str, opt
-00013450: 696f 6e61 6c29 3a20 4578 6563 7574 6f72  ional): Executor
-00013460: 2074 6f20 7573 652e 2044 6566 6175 6c74   to use. Default
-00013470: 7320 746f 2022 746f 7263 6822 2e0a 0a23  s to "torch"...#
-00013480: 2020 2020 2052 6574 7572 6e73 3a0a 2320       Returns:.# 
-00013490: 2020 2020 2020 2020 5468 6520 7265 7375          The resu
-000134a0: 6c74 206f 6620 7468 6520 4a61 636f 6269  lt of the Jacobi
-000134b0: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
-000134c0: 742e 0a23 2020 2020 2022 2222 0a23 2020  t..#     """.#  
-000134d0: 2020 2074 7261 6365 203d 206d 616b 655f     trace = make_
-000134e0: 7472 6163 6528 6675 6e63 2c20 6578 6563  trace(func, exec
-000134f0: 7574 6f72 3d65 7865 6375 746f 722c 202a  utor=executor, *
-00013500: 7072 696d 616c 7329 0a0a 2320 2020 2020  primals)..#     
-00013510: 6465 6620 6a76 705f 6675 6e63 282a 7072  def jvp_func(*pr
-00013520: 696d 616c 735f 616e 645f 7461 6e67 656e  imals_and_tangen
-00013530: 7473 293a 0a23 2020 2020 2020 2020 205f  ts):.#         _
-00013540: 7072 696d 616c 732c 205f 7461 6e67 656e  primals, _tangen
-00013550: 7473 203d 2070 7269 6d61 6c73 5f61 6e64  ts = primals_and
-00013560: 5f74 616e 6765 6e74 735b 3a20 6c65 6e28  _tangents[: len(
-00013570: 7072 696d 616c 7329 5d2c 2070 7269 6d61  primals)], prima
-00013580: 6c73 5f61 6e64 5f74 616e 6765 6e74 735b  ls_and_tangents[
-00013590: 6c65 6e28 7072 696d 616c 7329 203a 5d0a  len(primals) :].
-000135a0: 2320 2020 2020 2020 2020 7265 7475 726e  #         return
-000135b0: 205f 6a76 705f 6361 6c6c 5f6d 6574 6166   _jvp_call_metaf
-000135c0: 756e 6328 5f70 7269 6d61 6c73 2c20 5f74  unc(_primals, _t
-000135d0: 616e 6765 6e74 732c 2074 7261 6365 2c20  angents, trace, 
-000135e0: 6465 7461 6368 6564 3d46 616c 7365 290a  detached=False).
-000135f0: 0a23 2020 2020 206a 7670 5f74 7261 6365  .#     jvp_trace
-00013600: 203d 206d 616b 655f 7472 6163 6528 6a76   = make_trace(jv
-00013610: 705f 6675 6e63 2c20 6578 6563 7574 6f72  p_func, executor
-00013620: 3d65 7865 6375 746f 7229 282a 7072 696d  =executor)(*prim
-00013630: 616c 732c 202a 7461 6e67 656e 7473 290a  als, *tangents).
-00013640: 2320 2020 2020 6a76 705f 7472 6163 6564  #     jvp_traced
-00013650: 203d 206d 616b 655f 7472 6163 6564 2870   = make_traced(p
-00013660: 6172 7469 616c 2865 7661 6c5f 7472 6163  artial(eval_trac
-00013670: 652c 206a 7670 5f74 7261 6365 292c 2065  e, jvp_trace), e
-00013680: 7865 6375 746f 723d 6578 6563 7574 6f72  xecutor=executor
-00013690: 290a 2320 2020 2020 7265 7475 726e 206a  ).#     return j
-000136a0: 7670 5f74 7261 6365 6428 2a70 7269 6d61  vp_traced(*prima
-000136b0: 6c73 2c20 2a74 616e 6765 6e74 7329 0a0a  ls, *tangents)..
-000136c0: 0a23 2056 4a50 2074 7261 6e73 666f 726d  .# VJP transform
-000136d0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-000136e0: 0a40 6461 7461 636c 6173 7328 6672 6f7a  .@dataclass(froz
-000136f0: 656e 3d54 7275 6529 0a63 6c61 7373 2056  en=True).class V
-00013700: 4a50 4475 616c 3a0a 2020 2020 2222 2241  JPDual:.    """A
-00013710: 2070 6169 7220 6f66 2070 7269 6d61 6c20   pair of primal 
-00013720: 616e 6420 7361 7665 6420 696e 666f 726d  and saved inform
-00013730: 6174 696f 6e20 666f 7220 6261 636b 7761  ation for backwa
-00013740: 7264 2028 7265 7369 6475 616c 7329 2e0a  rd (residuals)..
-00013750: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00013760: 2020 2070 7269 6d61 6c20 2855 6e69 6f6e     primal (Union
-00013770: 5b50 726f 7879 2c20 4e75 6d62 6572 5d29  [Proxy, Number])
-00013780: 3a20 5072 696d 616c 2076 616c 7565 2c20  : Primal value, 
-00013790: 692e 652e 2c20 7468 6520 7661 6c75 6520  i.e., the value 
-000137a0: 6265 696e 6720 6469 6666 6572 656e 7469  being differenti
-000137b0: 6174 6564 2e0a 2020 2020 2020 2020 7265  ated..        re
-000137c0: 7369 6475 616c 7320 2854 7570 6c65 5b50  siduals (Tuple[P
-000137d0: 726f 7879 2c20 2e2e 2e5d 293a 2052 6573  roxy, ...]): Res
-000137e0: 6964 7561 6c73 2c20 692e 652e 2c20 7468  iduals, i.e., th
-000137f0: 6520 7661 6c75 6573 2074 6861 7420 6172  e values that ar
-00013800: 650a 2020 2020 2020 2020 2020 2020 7361  e.            sa
-00013810: 7665 6420 666f 7220 7468 6520 6261 636b  ved for the back
-00013820: 7761 7264 2e0a 0a20 2020 2059 6965 6c64  ward...    Yield
-00013830: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
-00013840: 5b56 6172 6961 626c 652c 2054 7570 6c65  [Variable, Tuple
-00013850: 5b56 6172 6961 626c 652c 202e 2e2e 5d2c  [Variable, ...],
-00013860: 2043 616c 6c61 626c 655d 3a20 5072 696d   Callable]: Prim
-00013870: 616c 2061 6e64 2072 6573 6964 7561 6c73  al and residuals
-00013880: 0a20 2020 2022 2222 0a0a 2020 2020 7072  .    """..    pr
-00013890: 696d 616c 3a20 5072 6f78 7920 7c20 4e75  imal: Proxy | Nu
-000138a0: 6d62 6572 0a20 2020 2072 6573 6964 7561  mber.    residua
-000138b0: 6c73 3a20 7475 706c 655b 5072 6f78 792c  ls: tuple[Proxy,
-000138c0: 202e 2e2e 5d0a 0a20 2020 2064 6566 205f   ...]..    def _
-000138d0: 5f69 7465 725f 5f28 7365 6c66 293a 0a20  _iter__(self):. 
-000138e0: 2020 2020 2020 2079 6965 6c64 2073 656c         yield sel
-000138f0: 662e 7072 696d 616c 0a20 2020 2020 2020  f.primal.       
-00013900: 2079 6965 6c64 2073 656c 662e 7265 7369   yield self.resi
-00013910: 6475 616c 730a 0a0a 636c 6173 7320 4e6f  duals...class No
-00013920: 5075 6c6c 6261 636b 3a0a 2020 2020 2222  Pullback:.    ""
-00013930: 2241 2064 756d 6d79 2070 756c 6c62 6163  "A dummy pullbac
-00013940: 6b20 6675 6e63 7469 6f6e 2074 6861 7420  k function that 
-00013950: 7265 7475 726e 7320 4e6f 6e65 206f 7220  returns None or 
-00013960: 7261 6973 6573 2061 6e20 6572 726f 722e  raises an error.
-00013970: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
-00013980: 6e69 745f 5f28 7365 6c66 2c20 6e75 6d5f  nit__(self, num_
-00013990: 6172 6773 3d30 293a 0a20 2020 2020 2020  args=0):.       
-000139a0: 2073 656c 662e 6e75 6d5f 6172 6773 203d   self.num_args =
-000139b0: 206e 756d 5f61 7267 730a 0a20 2020 2064   num_args..    d
-000139c0: 6566 205f 5f63 616c 6c5f 5f28 7365 6c66  ef __call__(self
-000139d0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-000139e0: 7329 3a0a 2020 2020 2020 2020 6966 2073  s):.        if s
-000139f0: 656c 662e 6e75 6d5f 6172 6773 203e 2030  elf.num_args > 0
-00013a00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00013a10: 7475 726e 2028 4e6f 6e65 2c29 202a 2073  turn (None,) * s
-00013a20: 656c 662e 6e75 6d5f 6172 6773 0a20 2020  elf.num_args.   
-00013a30: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00013a40: 6d65 4572 726f 7228 2250 756c 6c62 6163  meError("Pullbac
-00013a50: 6b20 6361 6c6c 6564 206f 6e20 6120 6e6f  k called on a no
-00013a60: 6e2d 6469 6666 6572 656e 7469 6162 6c65  n-differentiable
-00013a70: 2073 796d 626f 6c20 6f72 2061 2063 6f6e   symbol or a con
-00013a80: 7374 616e 742e 2229 0a0a 0a63 6c61 7373  stant.")...class
-00013a90: 205a 6572 6f42 6163 6b77 6172 643a 0a20   ZeroBackward:. 
-00013aa0: 2020 2022 2222 4120 6865 6c70 6572 2062     """A helper b
-00013ab0: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
-00013ac0: 2074 6861 7420 7265 7475 726e 7320 7a65   that returns ze
-00013ad0: 726f 732e 2222 220a 0a20 2020 2064 6566  ros."""..    def
-00013ae0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00013af0: 6e75 6d5f 6172 6773 293a 0a20 2020 2020  num_args):.     
-00013b00: 2020 2073 656c 662e 6e75 6d5f 6172 6773     self.num_args
-00013b10: 203d 206e 756d 5f61 7267 730a 0a20 2020   = num_args..   
-00013b20: 2064 6566 205f 5f63 616c 6c5f 5f28 7365   def __call__(se
-00013b30: 6c66 2c20 2a61 7267 732c 202a 2a6b 7761  lf, *args, **kwa
-00013b40: 7267 7329 3a0a 2020 2020 2020 2020 2320  rgs):.        # 
-00013b50: 4173 7375 6d69 6e67 2074 6861 7420 7468  Assuming that th
-00013b60: 6520 6669 7273 7420 6172 6775 6d65 6e74  e first argument
-00013b70: 7320 6172 6520 7468 6520 666f 7277 6172  s are the forwar
-00013b80: 6420 6172 6775 6d65 6e74 730a 2020 2020  d arguments.    
-00013b90: 2020 2020 666f 7277 6172 645f 6172 6773      forward_args
-00013ba0: 203d 2061 7267 735b 3a20 7365 6c66 2e6e   = args[: self.n
-00013bb0: 756d 5f61 7267 735d 0a0a 2020 2020 2020  um_args]..      
-00013bc0: 2020 6465 6620 7a65 726f 735f 6c69 6b65    def zeros_like
-00013bd0: 2878 293a 0a20 2020 2020 2020 2020 2020  (x):.           
-00013be0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-00013bf0: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
-00013c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c10: 7265 7475 726e 2066 756c 6c5f 6c69 6b65  return full_like
-00013c20: 2878 2c20 6669 6c6c 5f76 616c 7565 3d30  (x, fill_value=0
-00013c30: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00013c40: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-00013c50: 204e 756d 6265 7250 726f 7879 293a 0a20   NumberProxy):. 
-00013c60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013c70: 6574 7572 6e20 7479 7065 2878 2e76 616c  eturn type(x.val
-00013c80: 7565 2928 3029 0a20 2020 2020 2020 2020  ue)(0).         
-00013c90: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00013ca0: 6365 2878 2c20 4e75 6d62 6572 293a 0a20  ce(x, Number):. 
-00013cb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013cc0: 6574 7572 6e20 7479 7065 2878 2928 3029  eturn type(x)(0)
-00013cd0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00013ce0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00013cf0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00013d00: 726f 7228 6622 7a65 726f 735f 6c69 6b65  ror(f"zeros_like
-00013d10: 2069 6e73 6964 6520 5a65 726f 4261 636b   inside ZeroBack
-00013d20: 7761 7264 2067 6f74 2061 6e20 756e 7375  ward got an unsu
-00013d30: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
-00013d40: 7065 2878 297d 2229 0a0a 2020 2020 2020  pe(x)}")..      
-00013d50: 2020 7265 7475 726e 2074 7570 6c65 287a    return tuple(z
-00013d60: 6572 6f73 5f6c 696b 6528 6172 6729 2066  eros_like(arg) f
-00013d70: 6f72 2061 7267 2069 6e20 666f 7277 6172  or arg in forwar
-00013d80: 645f 6172 6773 290a 0a0a 2320 4d61 7070  d_args)...# Mapp
-00013d90: 696e 6720 6672 6f6d 2073 796d 626f 6c73  ing from symbols
-00013da0: 2074 6f20 6175 676d 656e 7465 6420 7072   to augmented pr
-00013db0: 696d 616c 2028 666f 7277 6172 6429 2066  imal (forward) f
-00013dc0: 756e 6374 696f 6e73 2075 7365 6420 696e  unctions used in
-00013dd0: 2056 4a50 0a23 2054 6865 2061 7567 6d65   VJP.# The augme
-00013de0: 6e74 6564 5f70 7269 6d61 6c20 6675 6e63  nted_primal func
-00013df0: 7469 6f6e 2074 616b 6573 2074 6865 2070  tion takes the p
-00013e00: 7269 6d61 6c20 7661 6c75 6573 2061 6e64  rimal values and
-00013e10: 2072 6574 7572 6e73 2074 6865 2070 7269   returns the pri
-00013e20: 6d61 6c0a 2320 7265 7375 6c74 2061 6e64  mal.# result and
-00013e30: 2074 6865 2072 6573 6964 7561 6c73 2028   the residuals (
-00013e40: 7361 7665 6420 7661 6c75 6573 2066 6f72  saved values for
-00013e50: 2074 6865 2062 6163 6b77 6172 6429 2e0a   the backward)..
-00013e60: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00013e70: 645f 696d 706c 7320 3d20 7b0a 2020 2020  d_impls = {.    
-00013e80: 7072 696d 732e 5072 696d 4944 732e 4143  prims.PrimIDs.AC
-00013e90: 4f53 3a20 6c61 6d62 6461 2078 3a20 2870  OS: lambda x: (p
-00013ea0: 7269 6d73 2e61 636f 7328 7829 2c20 2878  rims.acos(x), (x
-00013eb0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00013ec0: 7269 6d49 4473 2e41 434f 5348 3a20 6c61  rimIDs.ACOSH: la
-00013ed0: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
-00013ee0: 636f 7368 2878 292c 2028 782c 2929 2c0a  cosh(x), (x,)),.
-00013ef0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00013f00: 732e 4153 494e 3a20 6c61 6d62 6461 2078  s.ASIN: lambda x
-00013f10: 3a20 2870 7269 6d73 2e61 7369 6e28 7829  : (prims.asin(x)
-00013f20: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
-00013f30: 6d73 2e50 7269 6d49 4473 2e41 5349 4e48  ms.PrimIDs.ASINH
-00013f40: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00013f50: 6d73 2e61 7369 6e68 2878 292c 2028 782c  ms.asinh(x), (x,
-00013f60: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00013f70: 696d 4944 732e 4154 414e 3a20 6c61 6d62  imIDs.ATAN: lamb
-00013f80: 6461 2078 3a20 2870 7269 6d73 2e61 7461  da x: (prims.ata
-00013f90: 6e28 7829 2c20 2878 2c29 292c 0a20 2020  n(x), (x,)),.   
-00013fa0: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00013fb0: 5441 4e48 3a20 6c61 6d62 6461 2078 3a20  TANH: lambda x: 
-00013fc0: 2870 7269 6d73 2e61 7461 6e68 2878 292c  (prims.atanh(x),
-00013fd0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00013fe0: 732e 5072 696d 4944 732e 4154 414e 323a  s.PrimIDs.ATAN2:
-00013ff0: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
-00014000: 7269 6d73 2e61 7461 6e32 2878 2c20 7929  rims.atan2(x, y)
-00014010: 2c20 2878 2c20 7929 292c 0a20 2020 2070  , (x, y)),.    p
-00014020: 7269 6d73 2e50 7269 6d49 4473 2e43 4f53  rims.PrimIDs.COS
-00014030: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
-00014040: 696d 732e 636f 7368 2878 292c 2028 782c  ims.cosh(x), (x,
-00014050: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014060: 696d 4944 732e 4449 4741 4d4d 413a 206c  imIDs.DIGAMMA: l
-00014070: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-00014080: 6469 6761 6d6d 6128 7829 2c20 2878 2c29  digamma(x), (x,)
-00014090: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-000140a0: 6d49 4473 2e45 5246 433a 206c 616d 6264  mIDs.ERFC: lambd
-000140b0: 6120 783a 2028 7072 696d 732e 6572 6663  a x: (prims.erfc
-000140c0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-000140d0: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
-000140e0: 4649 4e56 3a20 6c61 6d62 6461 2078 3a20  FINV: lambda x: 
-000140f0: 2870 7269 6d73 2e65 7266 696e 7628 7829  (prims.erfinv(x)
-00014100: 2c20 2870 7269 6d73 2e65 7266 696e 7628  , (prims.erfinv(
-00014110: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
-00014120: 2e50 7269 6d49 4473 2e45 5246 4349 4e56  .PrimIDs.ERFCINV
-00014130: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
-00014140: 6d73 2e65 7266 6369 6e76 2878 292c 2028  ms.erfcinv(x), (
-00014150: 7072 696d 732e 6572 6663 696e 7628 7829  prims.erfcinv(x)
-00014160: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014170: 7269 6d49 4473 2e45 5850 323a 206c 616d  rimIDs.EXP2: lam
-00014180: 6264 6120 783a 2028 7072 696d 732e 6578  bda x: (prims.ex
-00014190: 7032 2878 292c 2028 7072 696d 732e 6578  p2(x), (prims.ex
-000141a0: 7032 2878 292c 2929 2c0a 2020 2020 7072  p2(x),)),.    pr
-000141b0: 696d 732e 5072 696d 4944 732e 4558 504d  ims.PrimIDs.EXPM
-000141c0: 313a 206c 616d 6264 6120 783a 2028 7072  1: lambda x: (pr
-000141d0: 696d 732e 6578 706d 3128 7829 2c20 2870  ims.expm1(x), (p
-000141e0: 7269 6d73 2e65 7870 6d31 2878 292c 2929  rims.expm1(x),))
-000141f0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014200: 4944 732e 4c47 414d 4d41 3a20 6c61 6d62  IDs.LGAMMA: lamb
-00014210: 6461 2078 3a20 2870 7269 6d73 2e6c 6761  da x: (prims.lga
-00014220: 6d6d 6128 7829 2c20 2878 2c29 292c 0a20  mma(x), (x,)),. 
-00014230: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014240: 2e4e 4454 5249 3a20 6c61 6d62 6461 2078  .NDTRI: lambda x
-00014250: 3a20 2870 7269 6d73 2e6e 6474 7269 2878  : (prims.ndtri(x
-00014260: 292c 2028 7072 696d 732e 6e64 7472 6928  ), (prims.ndtri(
-00014270: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
-00014280: 2e50 7269 6d49 4473 2e53 494e 483a 206c  .PrimIDs.SINH: l
-00014290: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-000142a0: 7369 6e68 2878 292c 2028 782c 2929 2c0a  sinh(x), (x,)),.
-000142b0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-000142c0: 732e 5351 5254 3a20 6c61 6d62 6461 2078  s.SQRT: lambda x
-000142d0: 3a20 2870 7269 6d73 2e73 7172 7428 7829  : (prims.sqrt(x)
-000142e0: 2c20 2870 7269 6d73 2e73 7172 7428 7829  , (prims.sqrt(x)
-000142f0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014300: 7269 6d49 4473 2e4e 453a 206c 616d 6264  rimIDs.NE: lambd
-00014310: 6120 782c 2079 3a20 2870 7269 6d73 2e6e  a x, y: (prims.n
-00014320: 6528 782c 2079 292c 2028 782c 2079 2929  e(x, y), (x, y))
-00014330: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014340: 4944 732e 4754 3a20 6c61 6d62 6461 2078  IDs.GT: lambda x
-00014350: 2c20 793a 2028 7072 696d 732e 6774 2878  , y: (prims.gt(x
-00014360: 2c20 7929 2c20 2878 2c20 7929 292c 0a20  , y), (x, y)),. 
-00014370: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014380: 2e4c 453a 206c 616d 6264 6120 782c 2079  .LE: lambda x, y
-00014390: 3a20 2870 7269 6d73 2e6c 6528 782c 2079  : (prims.le(x, y
-000143a0: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
-000143b0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
-000143c0: 4731 303a 206c 616d 6264 6120 783a 2028  G10: lambda x: (
-000143d0: 7072 696d 732e 6c6f 6731 3028 7829 2c20  prims.log10(x), 
-000143e0: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
-000143f0: 2e50 7269 6d49 4473 2e4c 4f47 3150 3a20  .PrimIDs.LOG1P: 
-00014400: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014410: 2e6c 6f67 3170 2878 292c 2028 782c 2929  .log1p(x), (x,))
-00014420: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014430: 4944 732e 4c4f 4732 3a20 6c61 6d62 6461  IDs.LOG2: lambda
-00014440: 2078 3a20 2870 7269 6d73 2e6c 6f67 3228   x: (prims.log2(
-00014450: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
-00014460: 7269 6d73 2e50 7269 6d49 4473 2e5a 4554  rims.PrimIDs.ZET
-00014470: 413a 206c 616d 6264 6120 782c 2079 3a20  A: lambda x, y: 
-00014480: 2870 7269 6d73 2e7a 6574 6128 782c 2079  (prims.zeta(x, y
-00014490: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
-000144a0: 7072 696d 732e 5072 696d 4944 732e 464d  prims.PrimIDs.FM
-000144b0: 4f44 3a20 6c61 6d62 6461 2078 2c20 793a  OD: lambda x, y:
-000144c0: 2028 7072 696d 732e 666d 6f64 2878 2c20   (prims.fmod(x, 
-000144d0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
-000144e0: 2070 7269 6d73 2e50 7269 6d49 4473 2e43   prims.PrimIDs.C
-000144f0: 4f50 595f 3a20 6c61 6d62 6461 2078 2c20  OPY_: lambda x, 
-00014500: 793a 2028 7072 696d 732e 636f 7079 5f28  y: (prims.copy_(
-00014510: 782c 2079 292c 2074 7570 6c65 2829 292c  x, y), tuple()),
-00014520: 0a7d 0a0a 0a23 204d 6170 7069 6e67 2066  .}...# Mapping f
-00014530: 726f 6d20 7379 6d62 6f6c 7320 746f 2062  rom symbols to b
-00014540: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
-00014550: 7320 7573 6564 2069 6e20 564a 500a 2320  s used in VJP.# 
-00014560: 5468 6520 6261 636b 7761 7264 2066 756e  The backward fun
-00014570: 6374 696f 6e20 7461 6b65 7320 7468 6520  ction takes the 
-00014580: 7265 7369 6475 616c 7320 616e 6420 636f  residuals and co
-00014590: 7461 6e67 656e 7473 2061 6e64 2072 6574  tangents and ret
-000145a0: 7572 6e73 2074 6865 0a23 2076 6563 746f  urns the.# vecto
-000145b0: 722d 4a61 636f 6269 616e 2070 726f 6475  r-Jacobian produ
-000145c0: 6374 7320 666f 7220 6561 6368 2061 7267  cts for each arg
-000145d0: 756d 656e 742e 0a62 6163 6b77 6172 645f  ument..backward_
-000145e0: 696d 706c 7320 3d20 7b0a 2020 2020 7072  impls = {.    pr
-000145f0: 696d 732e 5072 696d 4944 732e 4143 4f53  ims.PrimIDs.ACOS
-00014600: 3a20 6c61 6d62 6461 2078 2c20 673a 202d  : lambda x, g: -
-00014610: 6720 2f20 7072 696d 732e 7371 7274 2831  g / prims.sqrt(1
-00014620: 2e30 202d 2078 202a 2078 292c 0a20 2020  .0 - x * x),.   
-00014630: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014640: 434f 5348 3a20 6c61 6d62 6461 2078 2c20  COSH: lambda x, 
-00014650: 673a 2067 202a 2070 7269 6d73 2e72 7371  g: g * prims.rsq
-00014660: 7274 2878 202a 2078 202d 2031 2e30 292c  rt(x * x - 1.0),
-00014670: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014680: 4473 2e41 5349 4e3a 206c 616d 6264 6120  Ds.ASIN: lambda 
-00014690: 782c 2067 3a20 6720 2f20 7072 696d 732e  x, g: g / prims.
-000146a0: 7371 7274 2831 2e30 202d 2078 202a 2078  sqrt(1.0 - x * x
-000146b0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-000146c0: 6d49 4473 2e41 5349 4e48 3a20 6c61 6d62  mIDs.ASINH: lamb
-000146d0: 6461 2078 2c20 673a 2067 202a 2070 7269  da x, g: g * pri
-000146e0: 6d73 2e72 7371 7274 2831 2e30 202b 2078  ms.rsqrt(1.0 + x
-000146f0: 202a 2078 292c 0a20 2020 2070 7269 6d73   * x),.    prims
-00014700: 2e50 7269 6d49 4473 2e41 5441 4e3a 206c  .PrimIDs.ATAN: l
-00014710: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
-00014720: 2831 2e30 202b 2078 202a 2078 292c 0a20  (1.0 + x * x),. 
-00014730: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014740: 2e41 5441 4e48 3a20 6c61 6d62 6461 2078  .ATANH: lambda x
-00014750: 2c20 673a 2067 202f 2028 312e 3020 2d20  , g: g / (1.0 - 
-00014760: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-00014770: 732e 5072 696d 4944 732e 434f 5348 3a20  s.PrimIDs.COSH: 
-00014780: 6c61 6d62 6461 2078 2c20 673a 2070 7269  lambda x, g: pri
-00014790: 6d73 2e6d 756c 2867 2c20 7072 696d 732e  ms.mul(g, prims.
-000147a0: 7369 6e68 2878 2929 2c0a 2020 2020 7072  sinh(x)),.    pr
-000147b0: 696d 732e 5072 696d 4944 732e 4552 4643  ims.PrimIDs.ERFC
-000147c0: 3a20 6c61 6d62 6461 2078 2c20 673a 202d  : lambda x, g: -
-000147d0: 6720 2a20 322e 3020 2f20 6d61 7468 2e73  g * 2.0 / math.s
-000147e0: 7172 7428 6d61 7468 2e70 6929 202a 2070  qrt(math.pi) * p
-000147f0: 7269 6d73 2e65 7870 282d 7820 2a20 7829  rims.exp(-x * x)
-00014800: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014810: 4944 732e 4552 4649 4e56 3a20 6c61 6d62  IDs.ERFINV: lamb
-00014820: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
-00014830: 2a20 302e 3520 2a20 6d61 7468 2e73 7172  * 0.5 * math.sqr
-00014840: 7428 6d61 7468 2e70 6929 202a 2070 7269  t(math.pi) * pri
-00014850: 6d73 2e65 7870 2872 6573 756c 742a 2a32  ms.exp(result**2
-00014860: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014870: 6d49 4473 2e45 5246 4349 4e56 3a20 6c61  mIDs.ERFCINV: la
-00014880: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
-00014890: 2d67 202a 2030 2e35 202a 206d 6174 682e  -g * 0.5 * math.
-000148a0: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
-000148b0: 7072 696d 732e 6578 7028 7265 7375 6c74  prims.exp(result
-000148c0: 2a2a 3229 2c0a 2020 2020 7072 696d 732e  **2),.    prims.
-000148d0: 5072 696d 4944 732e 4558 5032 3a20 6c61  PrimIDs.EXP2: la
-000148e0: 6d62 6461 2072 6573 756c 742c 2067 3a20  mbda result, g: 
-000148f0: 6720 2a20 7265 7375 6c74 202a 206d 6174  g * result * mat
-00014900: 682e 6c6f 6728 322e 3029 2c0a 2020 2020  h.log(2.0),.    
-00014910: 7072 696d 732e 5072 696d 4944 732e 4558  prims.PrimIDs.EX
-00014920: 504d 313a 206c 616d 6264 6120 7265 7375  PM1: lambda resu
-00014930: 6c74 2c20 673a 2067 202a 2028 7265 7375  lt, g: g * (resu
-00014940: 6c74 202b 2031 2e30 292c 0a20 2020 2070  lt + 1.0),.    p
-00014950: 7269 6d73 2e50 7269 6d49 4473 2e4c 4741  rims.PrimIDs.LGA
-00014960: 4d4d 413a 206c 616d 6264 6120 782c 2067  MMA: lambda x, g
-00014970: 3a20 6720 2a20 7072 696d 732e 6469 6761  : g * prims.diga
-00014980: 6d6d 6128 7829 2c0a 2020 2020 7072 696d  mma(x),.    prim
-00014990: 732e 5072 696d 4944 732e 4e44 5452 493a  s.PrimIDs.NDTRI:
-000149a0: 206c 616d 6264 6120 7265 7375 6c74 2c20   lambda result, 
-000149b0: 673a 2067 202a 2070 7269 6d73 2e65 7870  g: g * prims.exp
-000149c0: 2830 2e35 202a 2072 6573 756c 742a 2a32  (0.5 * result**2
-000149d0: 2920 2a20 6d61 7468 2e73 7172 7428 322e  ) * math.sqrt(2.
-000149e0: 3020 2a20 6d61 7468 2e70 6929 2c0a 2020  0 * math.pi),.  
-000149f0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014a00: 5349 4e48 3a20 6c61 6d62 6461 2078 2c20  SINH: lambda x, 
-00014a10: 673a 2070 7269 6d73 2e6d 756c 2867 2c20  g: prims.mul(g, 
-00014a20: 7072 696d 732e 636f 7368 2878 2929 2c0a  prims.cosh(x)),.
-00014a30: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014a40: 732e 5351 5254 3a20 6c61 6d62 6461 2072  s.SQRT: lambda r
-00014a50: 6573 756c 742c 2067 3a20 6720 2f20 2832  esult, g: g / (2
-00014a60: 2e30 202a 2072 6573 756c 7429 2c0a 2020  .0 * result),.  
-00014a70: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014a80: 4e45 3a20 5a65 726f 4261 636b 7761 7264  NE: ZeroBackward
-00014a90: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
-00014aa0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014ab0: 4754 3a20 5a65 726f 4261 636b 7761 7264  GT: ZeroBackward
-00014ac0: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
-00014ad0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014ae0: 4c45 3a20 5a65 726f 4261 636b 7761 7264  LE: ZeroBackward
-00014af0: 286e 756d 5f61 7267 733d 3229 2c0a 2020  (num_args=2),.  
-00014b00: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014b10: 4c4f 4731 303a 206c 616d 6264 6120 782c  LOG10: lambda x,
-00014b20: 2067 3a20 6720 2f20 2878 202a 2032 2e33   g: g / (x * 2.3
-00014b30: 3032 3538 3530 3932 3939 3430 3436 292c  02585092994046),
-00014b40: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014b50: 4473 2e4c 4f47 3150 3a20 6c61 6d62 6461  Ds.LOG1P: lambda
-00014b60: 2078 2c20 673a 2067 202f 2028 7820 2b20   x, g: g / (x + 
-00014b70: 3129 2c0a 2020 2020 7072 696d 732e 5072  1),.    prims.Pr
-00014b80: 696d 4944 732e 4c4f 4732 3a20 6c61 6d62  imIDs.LOG2: lamb
-00014b90: 6461 2078 2c20 673a 2067 202f 2028 7820  da x, g: g / (x 
-00014ba0: 2a20 302e 3639 3331 3437 3138 3035 3539  * 0.693147180559
-00014bb0: 3934 3533 292c 0a20 2020 2070 7269 6d73  9453),.    prims
-00014bc0: 2e50 7269 6d49 4473 2e46 4d4f 443a 206c  .PrimIDs.FMOD: l
-00014bd0: 616d 6264 6120 782c 2079 2c20 673a 2028  ambda x, y, g: (
-00014be0: 672c 202d 6720 2a20 7072 696d 732e 7472  g, -g * prims.tr
-00014bf0: 756e 6328 7820 2f20 7929 292c 0a20 2020  unc(x / y)),.   
-00014c00: 2023 2054 6865 2063 6f70 7920 7368 6f75   # The copy shou
-00014c10: 6c64 206e 6f74 2062 6520 6469 6666 6572  ld not be differ
-00014c20: 656e 7469 6162 6c65 2e20 5765 2072 6574  entiable. We ret
-00014c30: 7572 6e20 4e6f 6e65 2074 6f20 656e 6162  urn None to enab
-00014c40: 6c65 2074 6865 2067 656e 6572 6174 696f  le the generatio
-00014c50: 6e20 6f66 2074 6865 2062 6163 6b77 6172  n of the backwar
-00014c60: 6420 6772 6170 6820 7468 726f 7567 6820  d graph through 
-00014c70: 7468 656d 2e0a 2020 2020 7072 696d 732e  them..    prims.
-00014c80: 5072 696d 4944 732e 434f 5059 5f3a 206c  PrimIDs.COPY_: l
-00014c90: 616d 6264 6120 673a 2028 4e6f 6e65 2c20  ambda g: (None, 
-00014ca0: 4e6f 6e65 292c 0a7d 0a0a 0a64 6566 2072  None),.}...def r
-00014cb0: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00014cc0: 645f 666f 7277 6172 6428 6f70 293a 0a20  d_forward(op):. 
-00014cd0: 2020 2022 2222 4465 636f 7261 746f 7220     """Decorator 
-00014ce0: 746f 2072 6567 6973 7465 7220 616e 2061  to register an a
-00014cf0: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
-00014d00: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
-00014d10: 666f 7220 6120 7379 6d62 6f6c 2e0a 0a20  for a symbol... 
-00014d20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00014d30: 206f 7020 284f 7073 293a 2053 796d 626f   op (Ops): Symbo
-00014d40: 6c20 666f 7220 7768 6963 6820 746f 2072  l for which to r
-00014d50: 6567 6973 7465 7220 7468 6520 6175 676d  egister the augm
-00014d60: 656e 7465 6420 666f 7277 6172 6420 696d  ented forward im
-00014d70: 706c 656d 656e 7461 7469 6f6e 2e0a 0a20  plementation... 
-00014d80: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00014d90: 2020 2020 4361 6c6c 6162 6c65 3a20 4465      Callable: De
-00014da0: 636f 7261 746f 7220 6675 6e63 7469 6f6e  corator function
-00014db0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-00014dc0: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
-00014dd0: 6329 3a0a 2020 2020 2020 2020 6175 676d  c):.        augm
-00014de0: 656e 7465 645f 666f 7277 6172 645f 696d  ented_forward_im
-00014df0: 706c 735b 6f70 5d20 3d20 6675 6e63 0a20  pls[op] = func. 
-00014e00: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
-00014e10: 6e63 0a0a 2020 2020 7265 7475 726e 2064  nc..    return d
-00014e20: 6563 6f72 6174 6f72 0a0a 0a64 6566 2072  ecorator...def r
-00014e30: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00014e40: 286f 7029 3a0a 2020 2020 2222 2244 6563  (op):.    """Dec
-00014e50: 6f72 6174 6f72 2074 6f20 7265 6769 7374  orator to regist
-00014e60: 6572 2061 2062 6163 6b77 6172 6420 696d  er a backward im
-00014e70: 706c 656d 656e 7461 7469 6f6e 2066 6f72  plementation for
-00014e80: 2061 2073 796d 626f 6c2e 0a0a 2020 2020   a symbol...    
-00014e90: 4172 6773 3a0a 2020 2020 2020 2020 6f70  Args:.        op
-00014ea0: 2028 4f70 7329 3a20 5379 6d62 6f6c 2066   (Ops): Symbol f
-00014eb0: 6f72 2077 6869 6368 2074 6f20 7265 6769  or which to regi
-00014ec0: 7374 6572 2074 6865 2062 6163 6b77 6172  ster the backwar
-00014ed0: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
-00014ee0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00014ef0: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00014f00: 3a20 4465 636f 7261 746f 7220 6675 6e63  : Decorator func
-00014f10: 7469 6f6e 2e0a 2020 2020 2222 220a 0a20  tion..    """.. 
-00014f20: 2020 2064 6566 2064 6563 6f72 6174 6f72     def decorator
-00014f30: 2866 756e 6329 3a0a 2020 2020 2020 2020  (func):.        
-00014f40: 6261 636b 7761 7264 5f69 6d70 6c73 5b6f  backward_impls[o
-00014f50: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
-00014f60: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
-00014f70: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
-00014f80: 746f 720a 0a0a 6465 6620 7265 7374 6f72  tor...def restor
-00014f90: 655f 7265 6475 6365 645f 6469 6d73 2878  e_reduced_dims(x
-00014fa0: 2c20 7265 6475 6365 645f 6469 6d73 2c20  , reduced_dims, 
-00014fb0: 6f72 6967 696e 616c 5f73 6861 7065 293a  original_shape):
-00014fc0: 0a20 2020 2022 2222 5265 7374 6f72 6573  .    """Restores
-00014fd0: 2074 6865 2072 6564 7563 6564 2064 696d   the reduced dim
-00014fe0: 656e 7369 6f6e 7320 6f66 2061 2074 656e  ensions of a ten
-00014ff0: 736f 722e 0a0a 2020 2020 4172 6773 3a0a  sor...    Args:.
-00015000: 2020 2020 2020 2020 7820 2856 6172 6961          x (Varia
-00015010: 626c 6529 3a20 5465 6e73 6f72 2074 6f20  ble): Tensor to 
-00015020: 6265 2072 6573 6861 7065 642e 0a20 2020  be reshaped..   
-00015030: 2020 2020 2072 6564 7563 6564 5f64 696d       reduced_dim
-00015040: 7320 2854 7570 6c65 5b69 6e74 2c20 2e2e  s (Tuple[int, ..
-00015050: 2e5d 293a 2054 7570 6c65 206f 6620 7265  .]): Tuple of re
-00015060: 6475 6365 6420 6469 6d65 6e73 696f 6e73  duced dimensions
-00015070: 2e0a 2020 2020 2020 2020 6f72 6967 696e  ..        origin
-00015080: 616c 5f73 6861 7065 2028 5475 706c 655b  al_shape (Tuple[
-00015090: 696e 742c 202e 2e2e 5d29 3a20 4f72 6967  int, ...]): Orig
-000150a0: 696e 616c 2073 6861 7065 206f 6620 7468  inal shape of th
-000150b0: 6520 7465 6e73 6f72 2e0a 0a20 2020 2052  e tensor...    R
-000150c0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-000150d0: 5661 7269 6162 6c65 3a20 5465 6e73 6f72  Variable: Tensor
-000150e0: 2077 6974 6820 7468 6520 7265 6475 6365   with the reduce
-000150f0: 6420 6469 6d65 6e73 696f 6e73 2072 6573  d dimensions res
-00015100: 746f 7265 642e 0a20 2020 2022 2222 0a20  tored..    """. 
-00015110: 2020 2069 6620 6f72 6967 696e 616c 5f73     if original_s
-00015120: 6861 7065 203d 3d20 2829 3a20 2023 2073  hape == ():  # s
-00015130: 6361 6c61 720a 2020 2020 2020 2020 7265  calar.        re
-00015140: 7475 726e 2078 0a0a 2020 2020 756e 7371  turn x..    unsq
-00015150: 7565 657a 6564 203d 2063 6c61 6e67 2e75  ueezed = clang.u
-00015160: 6e73 7175 6565 7a65 2878 2c20 7265 6475  nsqueeze(x, redu
-00015170: 6365 645f 6469 6d73 290a 2020 2020 7265  ced_dims).    re
-00015180: 7475 726e 2063 6c61 6e67 2e65 7870 616e  turn clang.expan
-00015190: 6428 756e 7371 7565 657a 6564 2c20 6f72  d(unsqueezed, or
-000151a0: 6967 696e 616c 5f73 6861 7065 290a 0a0a  iginal_shape)...
-000151b0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-000151c0: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-000151d0: 2e5a 4554 4129 0a64 6566 207a 6574 615f  .ZETA).def zeta_
-000151e0: 6261 636b 7761 7264 2878 2c20 792c 2067  backward(x, y, g
-000151f0: 293a 0a20 2020 2023 2054 6865 2064 6572  ):.    # The der
-00015200: 6976 6174 6976 6520 7772 7420 7468 6520  ivative wrt the 
-00015210: 6669 7273 7420 6172 6775 6d65 6e74 2069  first argument i
-00015220: 7320 6e6f 7420 6578 7072 6573 7369 626c  s not expressibl
-00015230: 6520 696e 2074 6572 6d73 206f 6620 7a65  e in terms of ze
-00015240: 7461 206f 720a 2020 2020 2320 6f74 6865  ta or.    # othe
-00015250: 7220 7370 6563 6961 6c20 6675 6e63 7469  r special functi
-00015260: 6f6e 730a 2020 2020 2320 5468 6572 6566  ons.    # Theref
-00015270: 6f72 652c 2077 6520 636f 6d70 7574 6520  ore, we compute 
-00015280: 6f6e 6c79 2074 6865 2064 6572 6976 6174  only the derivat
-00015290: 6976 6520 7772 7420 7468 6520 7365 636f  ive wrt the seco
-000152a0: 6e64 2061 7267 756d 656e 740a 2020 2020  nd argument.    
-000152b0: 6779 203d 2067 202a 202d 7820 2a20 7072  gy = g * -x * pr
-000152c0: 696d 732e 7a65 7461 2878 202b 2031 2e30  ims.zeta(x + 1.0
-000152d0: 2c20 7929 0a0a 2020 2020 2320 5265 7475  , y)..    # Retu
-000152e0: 726e 2061 206d 6170 7070 696e 6720 6672  rn a mappping fr
-000152f0: 6f6d 2074 6865 2066 6f72 7761 7264 2061  om the forward a
-00015300: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
-00015310: 6772 6164 6965 6e74 730a 2020 2020 7265  gradients.    re
-00015320: 7475 726e 207b 2279 223a 2067 797d 0a0a  turn {"y": gy}..
-00015330: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00015340: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-00015350: 732e 4449 4741 4d4d 4129 0a64 6566 2064  s.DIGAMMA).def d
-00015360: 6967 616d 6d61 5f62 6163 6b77 6172 6428  igamma_backward(
-00015370: 613a 2050 726f 7879 2c20 6729 3a0a 2020  a: Proxy, g):.  
-00015380: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00015390: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
-000153a0: 6761 6d6d 610a 0a20 2020 2072 6574 7572  gamma..    retur
-000153b0: 6e20 6720 2a20 706f 6c79 6761 6d6d 6128  n g * polygamma(
-000153c0: 312c 2061 290a 0a0a 4072 6567 6973 7465  1, a)...@registe
-000153d0: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-000153e0: 6172 6428 2274 6f72 6368 2e70 6f6c 7967  ard("torch.polyg
-000153f0: 616d 6d61 2229 0a64 6566 2070 6f6c 7967  amma").def polyg
-00015400: 616d 6d61 5f61 7567 5f66 7764 286e 3a20  amma_aug_fwd(n: 
-00015410: 696e 742c 2061 3a20 5072 6f78 7929 3a0a  int, a: Proxy):.
-00015420: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00015430: 2e74 6f72 6368 2069 6d70 6f72 7420 706f  .torch import po
-00015440: 6c79 6761 6d6d 610a 0a20 2020 2070 7269  lygamma..    pri
-00015450: 6d61 6c20 3d20 706f 6c79 6761 6d6d 6128  mal = polygamma(
-00015460: 6e2c 2061 290a 2020 2020 7265 7369 6475  n, a).    residu
-00015470: 616c 7320 3d20 286e 2c20 6129 0a20 2020  als = (n, a).   
-00015480: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00015490: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-000154a0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-000154b0: 6163 6b77 6172 6428 2274 6f72 6368 2e70  ackward("torch.p
-000154c0: 6f6c 7967 616d 6d61 2229 0a64 6566 2070  olygamma").def p
-000154d0: 6f6c 7967 616d 6d61 5f62 6163 6b77 6172  olygamma_backwar
-000154e0: 6428 6e3a 2069 6e74 2c20 613a 2050 726f  d(n: int, a: Pro
-000154f0: 7879 2c20 6729 3a0a 2020 2020 6672 6f6d  xy, g):.    from
-00015500: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-00015510: 6d70 6f72 7420 706f 6c79 6761 6d6d 610a  mport polygamma.
-00015520: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
-00015530: 2c20 6720 2a20 706f 6c79 6761 6d6d 6128  , g * polygamma(
-00015540: 6e20 2b20 312c 2061 290a 0a0a 4072 6567  n + 1, a)...@reg
-00015550: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-00015560: 7269 6d73 2e50 7269 6d49 4473 2e41 5441  rims.PrimIDs.ATA
-00015570: 4e32 290a 6465 6620 6174 616e 325f 6261  N2).def atan2_ba
-00015580: 636b 7761 7264 2878 2c20 792c 2067 293a  ckward(x, y, g):
-00015590: 0a20 2020 2061 6c70 6861 203d 2031 2e30  .    alpha = 1.0
-000155a0: 202f 2028 7820 2a20 7820 2b20 7920 2a20   / (x * x + y * 
-000155b0: 7929 0a20 2020 2067 7261 645f 7820 3d20  y).    grad_x = 
-000155c0: 6720 2a20 7920 2a20 616c 7068 610a 2020  g * y * alpha.  
-000155d0: 2020 6772 6164 5f79 203d 2067 202a 202d    grad_y = g * -
-000155e0: 7820 2a20 616c 7068 610a 2020 2020 7265  x * alpha.    re
-000155f0: 7475 726e 2067 7261 645f 782c 2067 7261  turn grad_x, gra
-00015600: 645f 790a 0a0a 4072 6567 6973 7465 725f  d_y...@register_
-00015610: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00015620: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00015630: 5641 5229 0a64 6566 2076 6172 5f61 7567  VAR).def var_aug
-00015640: 5f66 7764 2861 2c20 6469 6d2c 202a 2c20  _fwd(a, dim, *, 
-00015650: 636f 7272 6563 7469 6f6e 293a 0a20 2020  correction):.   
-00015660: 2076 203d 2070 7269 6d73 2e76 6172 2861   v = prims.var(a
-00015670: 2c20 6469 6d2c 2063 6f72 7265 6374 696f  , dim, correctio
-00015680: 6e3d 636f 7272 6563 7469 6f6e 290a 2020  n=correction).  
-00015690: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-000156a0: 2828 762c 292c 2028 612c 2064 696d 2c20  ((v,), (a, dim, 
-000156b0: 636f 7272 6563 7469 6f6e 2c20 7629 290a  correction, v)).
-000156c0: 0a0a 2320 544f 444f 3a20 6669 7820 6469  ..# TODO: fix di
-000156d0: 7669 7369 6f6e 2062 7920 7a65 726f 2077  vision by zero w
-000156e0: 6865 6e20 6e5f 656c 656d 5f72 6564 7563  hen n_elem_reduc
-000156f0: 6564 203d 3d20 3020 6f72 2077 6865 6e20  ed == 0 or when 
-00015700: 762e 6e75 6d65 6c20 3d3d 2030 0a23 2062  v.numel == 0.# b
-00015710: 7920 7265 7475 726e 696e 6720 7a65 726f  y returning zero
-00015720: 735f 6c69 6b65 2861 2920 6f72 2073 696d  s_like(a) or sim
-00015730: 696c 6172 2e0a 2320 544f 444f 3a20 6669  ilar..# TODO: fi
-00015740: 7820 6772 6164 2077 6865 6e20 636f 7272  x grad when corr
-00015750: 6563 7469 6f6e 203e 206e 5f65 6c65 6d5f  ection > n_elem_
-00015760: 7265 6475 6365 642e 0a40 7265 6769 7374  reduced..@regist
-00015770: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-00015780: 732e 5072 696d 4944 732e 5641 5229 0a64  s.PrimIDs.VAR).d
-00015790: 6566 2076 6172 5f62 6163 6b77 6172 6428  ef var_backward(
-000157a0: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
-000157b0: 6f6e 2c20 762c 2067 293a 0a20 2020 206e  on, v, g):.    n
-000157c0: 5f65 6c65 6d5f 7265 6475 6365 6420 3d20  _elem_reduced = 
-000157d0: 612e 6e75 6d65 6c20 2f2f 2076 2e6e 756d  a.numel // v.num
-000157e0: 656c 2069 6620 612e 6e75 6d65 6c20 213d  el if a.numel !=
-000157f0: 2030 2065 6c73 6520 310a 2020 2020 6e6f   0 else 1.    no
-00015800: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
-00015810: 6172 203d 206e 5f65 6c65 6d5f 7265 6475  ar = n_elem_redu
-00015820: 6365 6420 2d20 636f 7272 6563 7469 6f6e  ced - correction
-00015830: 0a20 2020 2067 203d 2072 6573 746f 7265  .    g = restore
-00015840: 5f72 6564 7563 6564 5f64 696d 7328 672c  _reduced_dims(g,
-00015850: 2064 696d 2c20 612e 7368 6170 6529 0a20   dim, a.shape). 
-00015860: 2020 2069 6620 612e 6474 7970 6520 213d     if a.dtype !=
-00015870: 2076 2e64 7479 7065 3a0a 2020 2020 2020   v.dtype:.      
-00015880: 2020 6120 3d20 7072 696d 732e 636f 6e76    a = prims.conv
-00015890: 6572 745f 656c 656d 656e 745f 7479 7065  ert_element_type
-000158a0: 2861 2c20 762e 6474 7970 6529 0a20 2020  (a, v.dtype).   
-000158b0: 206d 6561 6e20 3d20 7072 696d 732e 7375   mean = prims.su
-000158c0: 6d28 612c 2064 696d 2920 2f20 6e5f 656c  m(a, dim) / n_el
-000158d0: 656d 5f72 6564 7563 6564 0a20 2020 206d  em_reduced.    m
-000158e0: 6561 6e20 3d20 7265 7374 6f72 655f 7265  ean = restore_re
-000158f0: 6475 6365 645f 6469 6d73 286d 6561 6e2c  duced_dims(mean,
-00015900: 2064 696d 2c20 612e 7368 6170 6529 0a20   dim, a.shape). 
-00015910: 2020 2072 6574 7572 6e20 2832 202a 2067     return (2 * g
-00015920: 202a 2028 6120 2d20 6d65 616e 2929 202f   * (a - mean)) /
-00015930: 206e 6f72 6d61 6c69 7a61 7469 6f6e 5f73   normalization_s
-00015940: 6361 6c61 720a 0a0a 6465 6620 6e5f 656c  calar...def n_el
-00015950: 656d 5f72 6564 7563 6564 2861 5f6e 6469  em_reduced(a_ndi
-00015960: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
-00015970: 293a 0a20 2020 2064 696d 7320 3d20 7574  ):.    dims = ut
-00015980: 696c 732e 6361 6e6f 6e69 6361 6c69 7a65  ils.canonicalize
-00015990: 5f64 696d 7328 615f 6e64 696d 2c20 6469  _dims(a_ndim, di
-000159a0: 6d73 290a 2020 2020 7265 6475 6374 696f  ms).    reductio
-000159b0: 6e5f 7369 7a65 203d 2031 0a20 2020 2066  n_size = 1.    f
-000159c0: 6f72 2069 6478 2c20 7369 7a65 2069 6e20  or idx, size in 
-000159d0: 656e 756d 6572 6174 6528 615f 7368 6170  enumerate(a_shap
-000159e0: 6529 3a0a 2020 2020 2020 2020 6966 2069  e):.        if i
-000159f0: 6478 2069 6e20 6469 6d73 3a0a 2020 2020  dx in dims:.    
-00015a00: 2020 2020 2020 2020 7265 6475 6374 696f          reductio
-00015a10: 6e5f 7369 7a65 202a 3d20 7369 7a65 0a20  n_size *= size. 
-00015a20: 2020 2072 6574 7572 6e20 7265 6475 6374     return reduct
-00015a30: 696f 6e5f 7369 7a65 0a0a 0a64 6566 206d  ion_size...def m
-00015a40: 6561 6e5f 6261 636b 7761 7264 2861 5f6e  ean_backward(a_n
-00015a50: 6469 6d2c 2061 5f73 6861 7065 2c20 6469  dim, a_shape, di
-00015a60: 6d73 2c20 6772 6164 293a 0a20 2020 206d  ms, grad):.    m
-00015a70: 6561 6e5f 6c6f 6361 6c5f 6772 6164 203d  ean_local_grad =
-00015a80: 2031 2e30 202f 206e 5f65 6c65 6d5f 7265   1.0 / n_elem_re
-00015a90: 6475 6365 6428 615f 6e64 696d 2c20 615f  duced(a_ndim, a_
-00015aa0: 7368 6170 652c 2064 696d 7329 0a20 2020  shape, dims).   
-00015ab0: 2072 6574 7572 6e20 7265 7374 6f72 655f   return restore_
-00015ac0: 7265 6475 6365 645f 6469 6d73 2867 7261  reduced_dims(gra
-00015ad0: 642c 2064 696d 732c 2061 5f73 6861 7065  d, dims, a_shape
-00015ae0: 2920 2a20 6d65 616e 5f6c 6f63 616c 5f67  ) * mean_local_g
-00015af0: 7261 640a 0a0a 4072 6567 6973 7465 725f  rad...@register_
-00015b00: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00015b10: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00015b20: 5041 4429 0a64 6566 2070 6164 5f61 7567  PAD).def pad_aug
-00015b30: 5f66 7764 2861 2c20 7061 6464 696e 675f  _fwd(a, padding_
-00015b40: 7661 6c75 652c 2070 6164 6469 6e67 5f63  value, padding_c
-00015b50: 6f6e 6669 6729 3a0a 2020 2020 7265 7475  onfig):.    retu
-00015b60: 726e 2056 4a50 4475 616c 2828 7072 696d  rn VJPDual((prim
-00015b70: 732e 7061 6428 612c 2070 6164 6469 6e67  s.pad(a, padding
-00015b80: 5f76 616c 7565 2c20 7061 6464 696e 675f  _value, padding_
-00015b90: 636f 6e66 6967 292c 292c 2028 612c 2070  config),), (a, p
-00015ba0: 6164 6469 6e67 5f63 6f6e 6669 6729 290a  adding_config)).
-00015bb0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00015bc0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00015bd0: 4473 2e50 4144 290a 6465 6620 7061 645f  Ds.PAD).def pad_
-00015be0: 6261 636b 7761 7264 2861 2c20 7061 6464  backward(a, padd
-00015bf0: 696e 675f 636f 6e66 6967 2c20 6729 3a0a  ing_config, g):.
-00015c00: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
-00015c10: 7569 7420 6f6e 2065 6d70 7479 2069 6e70  uit on empty inp
-00015c20: 7574 2e0a 2020 2020 6966 2061 6e79 2864  ut..    if any(d
-00015c30: 696d 203d 3d20 3020 666f 7220 6469 6d20  im == 0 for dim 
-00015c40: 696e 2061 2e73 6861 7065 293a 0a20 2020  in a.shape):.   
-00015c50: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
-00015c60: 5f6c 696b 6528 612c 2066 696c 6c5f 7661  _like(a, fill_va
-00015c70: 6c75 653d 3029 0a0a 2020 2020 2320 556e  lue=0)..    # Un
-00015c80: 2d70 6164 2062 7920 7061 6464 696e 6720  -pad by padding 
-00015c90: 7769 7468 207a 6572 6f20 7661 6c75 6573  with zero values
-00015ca0: 0a20 2020 207a 6572 6f5f 7061 6464 696e  .    zero_paddin
-00015cb0: 675f 636f 6e66 6967 203d 205b 282d 6c6f  g_config = [(-lo
-00015cc0: 2c20 2d68 692c 2030 2920 666f 7220 6c6f  , -hi, 0) for lo
-00015cd0: 2c20 6869 2c20 5f20 696e 2070 6164 6469  , hi, _ in paddi
-00015ce0: 6e67 5f63 6f6e 6669 675d 0a0a 2020 2020  ng_config]..    
-00015cf0: 6720 3d20 7072 696d 732e 7061 6428 672c  g = prims.pad(g,
-00015d00: 2030 2e30 2c20 7a65 726f 5f70 6164 6469   0.0, zero_paddi
-00015d10: 6e67 5f63 6f6e 6669 6729 0a0a 2020 2020  ng_config)..    
-00015d20: 2320 556e 2d73 6c69 6365 2062 7920 736c  # Un-slice by sl
-00015d30: 6963 696e 6720 7769 7468 2061 2073 7472  icing with a str
-00015d40: 6964 6520 6f66 2076 616c 7565 2028 6469  ide of value (di
-00015d50: 6c61 7469 6f6e 202b 2031 290a 2020 2020  lation + 1).    
-00015d60: 666f 7220 6469 6d2c 2028 5f2c 205f 2c20  for dim, (_, _, 
-00015d70: 6429 2069 6e20 656e 756d 6572 6174 6528  d) in enumerate(
-00015d80: 7061 6464 696e 675f 636f 6e66 6967 293a  padding_config):
-00015d90: 0a20 2020 2020 2020 2067 203d 2073 6c69  .        g = sli
-00015da0: 6365 5f69 6e5f 6469 6d28 672c 2030 2c20  ce_in_dim(g, 0, 
-00015db0: 672e 7368 6170 655b 6469 6d5d 2c20 7374  g.shape[dim], st
-00015dc0: 7269 6465 3d64 202b 2031 2c20 6469 6d3d  ride=d + 1, dim=
-00015dd0: 6469 6d29 0a0a 2020 2020 7265 7475 726e  dim)..    return
-00015de0: 2067 0a0a 0a40 7265 6769 7374 6572 5f61   g...@register_a
-00015df0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00015e00: 2870 7269 6d73 2e50 7269 6d49 4473 2e50  (prims.PrimIDs.P
-00015e10: 524f 4429 0a64 6566 2070 726f 645f 6175  ROD).def prod_au
-00015e20: 675f 6677 6428 782c 2064 696d 7329 3a0a  g_fwd(x, dims):.
-00015e30: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
-00015e40: 2070 726f 6420 6f70 6572 6174 696f 6e2e   prod operation.
-00015e50: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00015e60: 2020 2020 7820 2856 6172 6961 626c 6529      x (Variable)
-00015e70: 3a20 5465 6e73 6f72 2074 6f20 6265 206d  : Tensor to be m
-00015e80: 756c 7469 706c 6965 642e 0a20 2020 2020  ultiplied..     
-00015e90: 2020 2064 696d 7320 2854 7570 6c65 5b69     dims (Tuple[i
-00015ea0: 6e74 2c20 2e2e 2e5d 293a 2044 696d 656e  nt, ...]): Dimen
-00015eb0: 7369 6f6e 7320 746f 2062 6520 6d75 6c74  sions to be mult
-00015ec0: 6970 6c69 6564 2e0a 0a20 2020 2052 6574  iplied...    Ret
-00015ed0: 7572 6e73 3a0a 2020 2020 2020 2020 564a  urns:.        VJ
-00015ee0: 5044 7561 6c3a 2050 7269 6d61 6c20 616e  PDual: Primal an
-00015ef0: 6420 7265 7369 6475 616c 732e 0a20 2020  d residuals..   
-00015f00: 2022 2222 0a20 2020 2070 7269 6d61 6c20   """.    primal 
-00015f10: 3d20 7072 696d 732e 7072 6f64 2878 2c20  = prims.prod(x, 
-00015f20: 6469 6d73 290a 0a20 2020 2072 6573 6964  dims)..    resid
-00015f30: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
-00015f40: 2070 7269 6d61 6c2c 0a20 2020 2020 2020   primal,.       
-00015f50: 2078 2c0a 2020 2020 2020 2020 782e 7368   x,.        x.sh
-00015f60: 6170 652c 0a20 2020 2020 2020 2064 696d  ape,.        dim
-00015f70: 732c 0a20 2020 2029 0a20 2020 2072 6574  s,.    ).    ret
-00015f80: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00015f90: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-00015fa0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00015fb0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-00015fc0: 732e 5052 4f44 290a 6465 6620 7072 6f64  s.PROD).def prod
-00015fd0: 5f70 756c 6c62 6163 6b28 7072 696d 616c  _pullback(primal
-00015fe0: 2c20 782c 2078 5f73 6861 7065 2c20 7265  , x, x_shape, re
-00015ff0: 6475 6365 645f 6469 6d73 2c20 6729 3a0a  duced_dims, g):.
-00016000: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-00016010: 2e64 6976 2872 6573 746f 7265 5f72 6564  .div(restore_red
-00016020: 7563 6564 5f64 696d 7328 7072 696d 616c  uced_dims(primal
-00016030: 202a 2067 2c20 7265 6475 6365 645f 6469   * g, reduced_di
-00016040: 6d73 2c20 785f 7368 6170 6529 2c20 7829  ms, x_shape), x)
-00016050: 0a0a 0a64 6566 206b 6565 7064 696d 5f72  ...def keepdim_r
-00016060: 6564 7563 7469 6f6e 2872 6564 7563 7469  eduction(reducti
-00016070: 6f6e 5f66 6e2c 2078 2c20 6469 6d73 293a  on_fn, x, dims):
-00016080: 0a20 2020 2022 2222 4170 706c 6965 7320  .    """Applies 
-00016090: 7265 6475 6374 696f 6e20 616e 6420 6669  reduction and fi
-000160a0: 7865 7320 6f75 7470 7574 2074 6f20 636f  xes output to co
-000160b0: 6e66 6f72 6d20 746f 206b 6565 7064 696d  nform to keepdim
-000160c0: 3d54 7275 6522 2222 0a20 2020 206f 7574  =True""".    out
-000160d0: 203d 2072 6564 7563 7469 6f6e 5f66 6e28   = reduction_fn(
-000160e0: 782c 2064 696d 7329 0a20 2020 2061 7267  x, dims).    arg
-000160f0: 6d61 785f 7375 6d5f 6f75 745f 7368 6170  max_sum_out_shap
-00016100: 6520 3d20 5b78 2e73 6861 7065 5b69 5d20  e = [x.shape[i] 
-00016110: 6966 2069 206e 6f74 2069 6e20 6469 6d73  if i not in dims
-00016120: 2065 6c73 6520 3120 666f 7220 6920 696e   else 1 for i in
-00016130: 2072 616e 6765 2878 2e6e 6469 6d29 5d0a   range(x.ndim)].
-00016140: 2020 2020 6272 6f61 6463 6173 745f 6469      broadcast_di
-00016150: 6d73 203d 205b 6920 666f 7220 6920 696e  ms = [i for i in
-00016160: 2072 616e 6765 2878 2e6e 6469 6d29 2069   range(x.ndim) i
-00016170: 6620 6920 6e6f 7420 696e 2064 696d 735d  f i not in dims]
-00016180: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
-00016190: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
-000161a0: 696d 286f 7574 2c20 6172 676d 6178 5f73  im(out, argmax_s
-000161b0: 756d 5f6f 7574 5f73 6861 7065 2c20 6272  um_out_shape, br
-000161c0: 6f61 6463 6173 745f 6469 6d73 290a 0a0a  oadcast_dims)...
-000161d0: 2320 496e 7370 6972 6564 2066 726f 6d20  # Inspired from 
-000161e0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-000161f0: 6f6d 2f48 4950 532f 6175 746f 6772 6164  om/HIPS/autograd
-00016200: 2f62 6c6f 622f 6d61 7374 6572 2f61 7574  /blob/master/aut
-00016210: 6f67 7261 642f 6e75 6d70 792f 6e75 6d70  ograd/numpy/nump
-00016220: 795f 766a 7073 2e70 7923 4c33 3533 0a64  y_vjps.py#L353.d
-00016230: 6566 2067 7261 645f 6368 6f6f 7365 725f  ef grad_chooser_
-00016240: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
-00016250: 2078 2c20 785f 7368 6170 652c 2072 6564   x, x_shape, red
-00016260: 7563 6564 5f64 696d 732c 2067 293a 0a20  uced_dims, g):. 
-00016270: 2020 2022 2222 4275 696c 6473 2067 7261     """Builds gra
-00016280: 6469 656e 7420 6f66 2066 756e 6374 696f  dient of functio
-00016290: 6e73 2074 6861 7420 6368 6f6f 7365 2061  ns that choose a
-000162a0: 2073 696e 676c 6520 6974 656d 2c20 7375   single item, su
-000162b0: 6368 2061 7320 6d69 6e20 6f72 206d 6178  ch as min or max
-000162c0: 2e22 2222 0a20 2020 2067 5f72 6570 6561  .""".    g_repea
-000162d0: 7465 6420 3d20 7265 7374 6f72 655f 7265  ted = restore_re
-000162e0: 6475 6365 645f 6469 6d73 2867 2c20 7265  duced_dims(g, re
-000162f0: 6475 6365 645f 6469 6d73 2c20 785f 7368  duced_dims, x_sh
-00016300: 6170 6529 0a20 2020 2070 7269 6d61 6c5f  ape).    primal_
-00016310: 7265 7065 6174 6564 203d 2072 6573 746f  repeated = resto
-00016320: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
-00016330: 7072 696d 616c 2c20 7265 6475 6365 645f  primal, reduced_
-00016340: 6469 6d73 2c20 785f 7368 6170 6529 0a20  dims, x_shape). 
-00016350: 2020 2061 7267 6d61 785f 6c6f 6361 7469     argmax_locati
-00016360: 6f6e 7320 3d20 7820 3d3d 2070 7269 6d61  ons = x == prima
-00016370: 6c5f 7265 7065 6174 6564 0a20 2020 2061  l_repeated.    a
-00016380: 7267 6d61 785f 7375 6d20 3d20 6b65 6570  rgmax_sum = keep
-00016390: 6469 6d5f 7265 6475 6374 696f 6e28 7072  dim_reduction(pr
-000163a0: 696d 732e 7375 6d2c 2061 7267 6d61 785f  ims.sum, argmax_
-000163b0: 6c6f 6361 7469 6f6e 732c 2072 6564 7563  locations, reduc
-000163c0: 6564 5f64 696d 7329 0a20 2020 206f 7574  ed_dims).    out
-000163d0: 203d 2067 5f72 6570 6561 7465 6420 2a20   = g_repeated * 
-000163e0: 6172 676d 6178 5f6c 6f63 6174 696f 6e73  argmax_locations
-000163f0: 202f 2061 7267 6d61 785f 7375 6d0a 2020   / argmax_sum.  
-00016400: 2020 7265 7475 726e 206f 7574 0a0a 0a72    return out...r
-00016410: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00016420: 2870 7269 6d73 2e50 7269 6d49 4473 2e41  (prims.PrimIDs.A
-00016430: 4d49 4e29 2867 7261 645f 6368 6f6f 7365  MIN)(grad_choose
-00016440: 725f 6261 636b 7761 7264 290a 0a0a 4072  r_backward)...@r
-00016450: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-00016460: 645f 666f 7277 6172 6428 7072 696d 732e  d_forward(prims.
-00016470: 5072 696d 4944 732e 414d 494e 290a 6465  PrimIDs.AMIN).de
-00016480: 6620 616d 696e 5f61 7567 5f66 7764 2878  f amin_aug_fwd(x
-00016490: 2c20 6469 6d73 293a 0a20 2020 2022 2222  , dims):.    """
-000164a0: 4175 676d 656e 7465 6420 616d 696e 206f  Augmented amin o
-000164b0: 7065 7261 7469 6f6e 2e0a 2020 2020 4172  peration..    Ar
-000164c0: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
-000164d0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
-000164e0: 2074 6f20 636f 6d70 7574 6520 616d 696e   to compute amin
-000164f0: 206f 6e2e 0a20 2020 2020 2020 2064 696d   on..        dim
-00016500: 7320 2854 7570 6c65 5b69 6e74 2c20 2e2e  s (Tuple[int, ..
-00016510: 2e5d 293a 2044 696d 656e 7369 6f6e 7320  .]): Dimensions 
-00016520: 746f 2063 6f6d 7075 7465 2061 6d69 6e20  to compute amin 
-00016530: 6f76 6572 2e0a 2020 2020 5265 7475 726e  over..    Return
-00016540: 733a 0a20 2020 2020 2020 2056 4a50 4475  s:.        VJPDu
-00016550: 616c 3a20 5072 696d 616c 2061 6e64 2072  al: Primal and r
-00016560: 6573 6964 7561 6c73 2e0a 2020 2020 2222  esiduals..    ""
-00016570: 220a 2020 2020 7072 696d 616c 203d 2070  ".    primal = p
-00016580: 7269 6d73 2e61 6d69 6e28 782c 2064 696d  rims.amin(x, dim
-00016590: 7329 0a0a 2020 2020 7265 7369 6475 616c  s)..    residual
-000165a0: 7320 3d20 280a 2020 2020 2020 2020 7072  s = (.        pr
-000165b0: 696d 616c 2c0a 2020 2020 2020 2020 782c  imal,.        x,
-000165c0: 0a20 2020 2020 2020 2078 2e73 6861 7065  .        x.shape
-000165d0: 2c0a 2020 2020 2020 2020 6469 6d73 2c0a  ,.        dims,.
-000165e0: 2020 2020 290a 0a20 2020 2072 6574 7572      )..    retur
-000165f0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-00016600: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
-00016610: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-00016620: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
-00016630: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
-00016640: 6620 706f 775f 6175 675f 6665 6428 782c  f pow_aug_fed(x,
-00016650: 2079 293a 0a20 2020 2022 2222 4175 676d   y):.    """Augm
-00016660: 656e 7465 6420 7468 6520 706f 7720 6f70  ented the pow op
-00016670: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
-00016680: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
-00016690: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
-000166a0: 2077 6974 6820 7468 6520 6261 7365 2074   with the base t
-000166b0: 6f20 6265 2065 7870 6f6e 656e 7469 6174  o be exponentiat
-000166c0: 6564 2e0a 2020 2020 2020 2020 7920 2856  ed..        y (V
-000166d0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
-000166e0: 2077 6974 6820 706f 7765 7220 746f 2072   with power to r
-000166f0: 6169 7365 2074 6f2e 0a0a 2020 2020 5265  aise to...    Re
-00016700: 7475 726e 733a 0a20 2020 2020 2020 2056  turns:.        V
-00016710: 4a50 4475 616c 3a20 5072 696d 616c 2061  JPDual: Primal a
-00016720: 6e64 2072 6573 6964 7561 6c73 2e0a 2020  nd residuals..  
-00016730: 2020 2222 220a 2020 2020 7072 696d 616c    """.    primal
-00016740: 203d 2070 7269 6d73 2e70 6f77 2878 2c20   = prims.pow(x, 
-00016750: 7929 0a20 2020 2072 6573 6964 7561 6c73  y).    residuals
-00016760: 203d 2028 7072 696d 616c 2c20 782c 2079   = (primal, x, y
-00016770: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-00016780: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-00016790: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
-000167a0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-000167b0: 6d73 2e50 7269 6d49 4473 2e50 4f57 290a  ms.PrimIDs.POW).
-000167c0: 6465 6620 706f 775f 6261 636b 7761 7264  def pow_backward
-000167d0: 2872 6573 756c 742c 2078 2c20 792c 2067  (result, x, y, g
-000167e0: 293a 0a20 2020 2069 6d70 6f72 7420 7468  ):.    import th
-000167f0: 756e 6465 722e 636c 616e 6720 6173 2074  under.clang as t
-00016800: 6c61 6e67 0a0a 2020 2020 6772 6573 756c  lang..    gresul
-00016810: 7420 3d20 6720 2a20 7265 7375 6c74 2020  t = g * result  
-00016820: 2320 7265 7573 6520 636f 6d6d 6f6e 2066  # reuse common f
-00016830: 6163 746f 720a 2020 2020 6478 203d 2067  actor.    dx = g
-00016840: 202a 2079 202a 2078 202a 2a20 2879 202d   * y * x ** (y -
-00016850: 2031 290a 2020 2020 6479 203d 2067 7265   1).    dy = gre
-00016860: 7375 6c74 202a 2074 6c61 6e67 2e6c 6f67  sult * tlang.log
-00016870: 2878 290a 2020 2020 7265 7475 726e 2064  (x).    return d
-00016880: 782c 2064 790a 0a0a 4072 6567 6973 7465  x, dy...@registe
-00016890: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-000168a0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000168b0: 732e 5441 4e29 0a64 6566 2074 616e 5f61  s.TAN).def tan_a
-000168c0: 7567 5f66 7764 2878 293a 0a20 2020 2022  ug_fwd(x):.    "
-000168d0: 2222 4175 676d 656e 7465 6420 7461 6e20  ""Augmented tan 
-000168e0: 6f70 6572 6174 696f 6e2e 0a0a 2020 2020  operation...    
-000168f0: 4172 6773 3a0a 2020 2020 2020 2020 7820  Args:.        x 
-00016900: 2856 6172 6961 626c 6529 3a20 5465 6e73  (Variable): Tens
-00016910: 6f72 2074 6f20 6265 2070 6173 7365 6420  or to be passed 
-00016920: 746f 2074 616e 2e0a 2020 2020 2222 220a  to tan..    """.
-00016930: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
-00016940: 696d 732e 7461 6e28 7829 0a20 2020 2072  ims.tan(x).    r
-00016950: 6573 6964 7561 6c73 203d 2028 7072 696d  esiduals = (prim
-00016960: 616c 2c29 0a20 2020 2072 6574 7572 6e20  al,).    return 
-00016970: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-00016980: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-00016990: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-000169a0: 7072 696d 732e 5072 696d 4944 732e 5441  prims.PrimIDs.TA
-000169b0: 4e29 0a64 6566 2074 616e 5f62 6163 6b77  N).def tan_backw
-000169c0: 6172 6428 7265 7375 6c74 2c20 6729 3a0a  ard(result, g):.
-000169d0: 2020 2020 7265 7475 726e 2067 202a 2028      return g * (
-000169e0: 3120 2b20 7265 7375 6c74 202a 2072 6573  1 + result * res
-000169f0: 756c 7429 0a0a 0a23 204e 4f54 453a 204a  ult)...# NOTE: J
-00016a00: 6178 2075 7365 7320 6e70 2e61 7267 736f  ax uses np.argso
-00016a10: 7274 2069 6e20 6974 7320 7472 616e 7370  rt in its transp
-00016a20: 6f73 6520 766a 7020 636f 6d70 7574 6174  ose vjp computat
-00016a30: 696f 6e0a 6465 6620 5f61 7267 736f 7274  ion.def _argsort
-00016a40: 2873 6571 293a 0a20 2020 2072 6574 7572  (seq):.    retur
-00016a50: 6e20 736f 7274 6564 2872 616e 6765 286c  n sorted(range(l
-00016a60: 656e 2873 6571 2929 2c20 6b65 793d 7365  en(seq)), key=se
-00016a70: 712e 5f5f 6765 7469 7465 6d5f 5f29 0a0a  q.__getitem__)..
-00016a80: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00016a90: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
-00016aa0: 6d73 2e50 7269 6d49 4473 2e44 4556 4943  ms.PrimIDs.DEVIC
-00016ab0: 455f 5055 5429 0a64 6566 2064 6576 6963  E_PUT).def devic
-00016ac0: 655f 7075 745f 6175 675f 6677 6428 613a  e_put_aug_fwd(a:
-00016ad0: 2054 656e 736f 7250 726f 7879 2c20 6465   TensorProxy, de
-00016ae0: 7669 6365 3a20 4465 7669 6365 2920 2d3e  vice: Device) ->
-00016af0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00016b00: 2020 7072 696d 616c 203d 2070 7269 6d73    primal = prims
-00016b10: 2e64 6576 6963 655f 7075 7428 612c 2064  .device_put(a, d
-00016b20: 6576 6963 6529 0a20 2020 2072 6573 6964  evice).    resid
-00016b30: 7561 6c73 203d 2028 612e 6465 7669 6365  uals = (a.device
-00016b40: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
-00016b50: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-00016b60: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-00016b70: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
-00016b80: 696d 732e 5072 696d 4944 732e 4445 5649  ims.PrimIDs.DEVI
-00016b90: 4345 5f50 5554 290a 6465 6620 6465 7669  CE_PUT).def devi
-00016ba0: 6365 5f70 7574 5f62 6163 6b77 6172 6428  ce_put_backward(
-00016bb0: 6f72 6967 5f64 6576 6963 652c 2067 293a  orig_device, g):
-00016bc0: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
-00016bd0: 732e 6465 7669 6365 5f70 7574 2867 2c20  s.device_put(g, 
-00016be0: 6f72 6967 5f64 6576 6963 6529 2c20 4e6f  orig_device), No
-00016bf0: 6e65 0a0a 0a40 7265 6769 7374 6572 5f61  ne...@register_a
-00016c00: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00016c10: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
-00016c20: 4f4e 564f 4c55 5449 4f4e 290a 6465 6620  ONVOLUTION).def 
-00016c30: 636f 6e76 6f6c 7574 696f 6e5f 6175 675f  convolution_aug_
-00016c40: 6677 6428 0a20 2020 2061 3a20 5072 6f78  fwd(.    a: Prox
-00016c50: 792c 0a20 2020 2077 6569 6768 742c 0a20  y,.    weight,. 
-00016c60: 2020 2062 6961 732c 0a20 2020 2073 7472     bias,.    str
-00016c70: 6964 652c 0a20 2020 2070 6164 6469 6e67  ide,.    padding
-00016c80: 2c0a 2020 2020 6469 6c61 7469 6f6e 2c0a  ,.    dilation,.
-00016c90: 2020 2020 7472 616e 7370 6f73 6564 2c0a      transposed,.
-00016ca0: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
-00016cb0: 6e67 2c0a 2020 2020 6772 6f75 7073 2c0a  ng,.    groups,.
-00016cc0: 293a 0a20 2020 2070 7269 6d61 6c20 3d20  ):.    primal = 
-00016cd0: 636f 6e76 6f6c 7574 696f 6e28 612c 2077  convolution(a, w
-00016ce0: 6569 6768 742c 2062 6961 732c 2073 7472  eight, bias, str
-00016cf0: 6964 652c 2070 6164 6469 6e67 2c20 6469  ide, padding, di
-00016d00: 6c61 7469 6f6e 2c20 7472 616e 7370 6f73  lation, transpos
-00016d10: 6564 2c20 6f75 7470 7574 5f70 6164 6469  ed, output_paddi
-00016d20: 6e67 2c20 6772 6f75 7073 290a 2020 2020  ng, groups).    
-00016d30: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
-00016d40: 6d61 6c2c 2061 2c20 7765 6967 6874 2c20  mal, a, weight, 
-00016d50: 6269 6173 2c20 7374 7269 6465 2c20 7061  bias, stride, pa
-00016d60: 6464 696e 672c 2064 696c 6174 696f 6e2c  dding, dilation,
-00016d70: 2074 7261 6e73 706f 7365 642c 206f 7574   transposed, out
-00016d80: 7075 745f 7061 6464 696e 672c 2067 726f  put_padding, gro
-00016d90: 7570 7329 0a20 2020 2072 6574 7572 6e20  ups).    return 
-00016da0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-00016db0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-00016dc0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00016dd0: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
-00016de0: 4e56 4f4c 5554 494f 4e29 0a64 6566 2063  NVOLUTION).def c
-00016df0: 6f6e 766f 6c75 7469 6f6e 5f62 6163 6b77  onvolution_backw
-00016e00: 6172 6428 0a20 2020 206f 7574 7075 743a  ard(.    output:
-00016e10: 2050 726f 7879 2c0a 2020 2020 696e 7075   Proxy,.    inpu
-00016e20: 743a 2050 726f 7879 2c0a 2020 2020 7765  t: Proxy,.    we
-00016e30: 6967 6874 2c0a 2020 2020 6269 6173 2c0a  ight,.    bias,.
-00016e40: 2020 2020 7374 7269 6465 2c0a 2020 2020      stride,.    
-00016e50: 7061 6464 696e 672c 0a20 2020 2064 696c  padding,.    dil
-00016e60: 6174 696f 6e2c 0a20 2020 2074 7261 6e73  ation,.    trans
-00016e70: 706f 7365 642c 0a20 2020 206f 7574 7075  posed,.    outpu
-00016e80: 745f 7061 6464 696e 672c 0a20 2020 2067  t_padding,.    g
-00016e90: 726f 7570 732c 0a20 2020 2067 7261 642c  roups,.    grad,
-00016ea0: 0a29 3a0a 2020 2020 2320 5472 616e 7370  .):.    # Transp
-00016eb0: 6f73 6564 2063 6f6e 766f 6c75 7469 6f6e  osed convolution
-00016ec0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-00016ed0: 6421 0a20 2020 2061 7373 6572 7420 7472  d!.    assert tr
-00016ee0: 616e 7370 6f73 6564 203d 3d20 300a 0a20  ansposed == 0.. 
-00016ef0: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
-00016f00: 4e6f 6e65 0a20 2020 2077 6569 6768 745f  None.    weight_
-00016f10: 6772 6164 203d 204e 6f6e 650a 2020 2020  grad = None.    
-00016f20: 6269 6173 5f67 7261 6420 3d20 4e6f 6e65  bias_grad = None
-00016f30: 0a0a 2020 2020 2320 5368 6f72 7420 6369  ..    # Short ci
-00016f40: 7263 7569 7420 6f6e 207a 6572 6f2d 6469  rcuit on zero-di
-00016f50: 6d20 6772 6164 0a20 2020 2069 6620 616e  m grad.    if an
-00016f60: 7928 7320 3d3d 2030 2066 6f72 2073 2069  y(s == 0 for s i
-00016f70: 6e20 6772 6164 2e73 6861 7065 293a 0a20  n grad.shape):. 
-00016f80: 2020 2020 2020 2069 6e70 7574 5f67 7261         input_gra
-00016f90: 6420 3d20 6675 6c6c 5f6c 696b 6528 696e  d = full_like(in
-00016fa0: 7075 742c 2066 696c 6c5f 7661 6c75 653d  put, fill_value=
-00016fb0: 3029 0a20 2020 2020 2020 2077 6569 6768  0).        weigh
-00016fc0: 745f 6772 6164 203d 2066 756c 6c5f 6c69  t_grad = full_li
-00016fd0: 6b65 2877 6569 6768 742c 2066 696c 6c5f  ke(weight, fill_
-00016fe0: 7661 6c75 653d 3029 0a20 2020 2020 2020  value=0).       
-00016ff0: 2069 6620 6269 6173 2069 7320 6e6f 7420   if bias is not 
-00017000: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00017010: 2020 6269 6173 5f67 7261 6420 3d20 6675    bias_grad = fu
-00017020: 6c6c 5f6c 696b 6528 6269 6173 2c20 6669  ll_like(bias, fi
-00017030: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
-00017040: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
-00017050: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
-00017060: 7261 642c 2062 6961 735f 6772 6164 2920  rad, bias_grad) 
-00017070: 2b20 2828 4e6f 6e65 2c29 202a 2036 290a  + ((None,) * 6).
-00017080: 0a20 2020 2062 6174 6368 2c20 696e 5f63  .    batch, in_c
-00017090: 6861 6e6e 656c 732c 202a 7370 6174 6961  hannels, *spatia
-000170a0: 6c5f 6469 6d73 203d 2069 6e70 7574 2e73  l_dims = input.s
-000170b0: 6861 7065 0a20 2020 206f 7574 5f63 6861  hape.    out_cha
-000170c0: 6e6e 656c 732c 2067 696e 5f63 6861 6e6e  nnels, gin_chann
-000170d0: 656c 732c 202a 6b65 726e 656c 5f64 696d  els, *kernel_dim
-000170e0: 7320 3d20 7765 6967 6874 2e73 6861 7065  s = weight.shape
-000170f0: 0a20 2020 2064 696d 203d 206c 656e 2873  .    dim = len(s
-00017100: 7061 7469 616c 5f64 696d 7329 0a0a 2020  patial_dims)..  
-00017110: 2020 6465 6620 6d61 7962 655f 6578 7061    def maybe_expa
-00017120: 6e64 5f73 6571 2873 2c20 6469 6d29 3a0a  nd_seq(s, dim):.
-00017130: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00017140: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00017150: 2020 2020 7265 7475 726e 2028 735b 305d      return (s[0]
-00017160: 2c29 202a 2064 696d 0a20 2020 2020 2020  ,) * dim.       
-00017170: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00017180: 2020 2072 6574 7572 6e20 730a 0a20 2020     return s..   
-00017190: 2073 7472 6964 6520 3d20 6d61 7962 655f   stride = maybe_
-000171a0: 6578 7061 6e64 5f73 6571 2873 7472 6964  expand_seq(strid
-000171b0: 652c 2064 696d 290a 2020 2020 7061 6464  e, dim).    padd
-000171c0: 696e 6720 3d20 6d61 7962 655f 6578 7061  ing = maybe_expa
-000171d0: 6e64 5f73 6571 2870 6164 6469 6e67 2c20  nd_seq(padding, 
-000171e0: 6469 6d29 0a20 2020 2064 696c 6174 696f  dim).    dilatio
-000171f0: 6e20 3d20 6d61 7962 655f 6578 7061 6e64  n = maybe_expand
-00017200: 5f73 6571 2864 696c 6174 696f 6e2c 2064  _seq(dilation, d
-00017210: 696d 290a 0a20 2020 2064 6566 2063 6f6e  im)..    def con
-00017220: 765f 7472 616e 7370 6f73 6528 7429 3a0a  v_transpose(t):.
-00017230: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-00017240: 7269 6d73 2e74 7261 6e73 706f 7365 2874  rims.transpose(t
-00017250: 2c20 2831 2c20 3029 202b 2074 7570 6c65  , (1, 0) + tuple
-00017260: 2872 616e 6765 2832 2c20 742e 6e64 696d  (range(2, t.ndim
-00017270: 2929 290a 0a20 2020 2023 2069 6e70 7574  )))..    # input
-00017280: 5f67 7261 6420 3d20 7b0a 2020 2020 6465  _grad = {.    de
-00017290: 6620 7472 616e 7370 6f73 655f 616e 645f  f transpose_and_
-000172a0: 666c 6970 5f77 6569 6768 7428 7765 6967  flip_weight(weig
-000172b0: 6874 293a 0a20 2020 2020 2020 2023 2054  ht):.        # T
-000172c0: 6865 206c 696e 6573 2062 656c 6f77 2061  he lines below a
-000172d0: 7265 2074 7261 6e73 706f 7369 6e67 2074  re transposing t
-000172e0: 6865 2063 6861 6e6e 656c 7320 6469 6d73  he channels dims
-000172f0: 2e0a 2020 2020 2020 2020 2320 5765 2061  ..        # We a
-00017300: 6c73 6f20 6e65 6564 2074 6f20 6578 7472  lso need to extr
-00017310: 6163 7420 7468 6520 6772 6f75 7020 696e  act the group in
-00017320: 666f 726d 6174 696f 6e20 616e 6420 6d65  formation and me
-00017330: 7267 6520 6974 0a20 2020 2020 2020 2023  rge it.        #
-00017340: 2077 6974 6820 7468 6520 6469 6d65 6e73   with the dimens
-00017350: 696f 6e20 636f 7272 6573 706f 6e64 696e  ion correspondin
-00017360: 6720 746f 2074 6865 2022 6f75 745f 6368  g to the "out_ch
-00017370: 616e 6e65 6c73 2220 6469 6d2e 0a20 2020  annels" dim..   
-00017380: 2020 2020 2023 2028 6f75 745f 6368 616e       # (out_chan
-00017390: 6e65 6c73 2c20 6769 6e5f 6368 616e 6e65  nels, gin_channe
-000173a0: 6c73 2920 2d3e 2028 6769 6e5f 6368 616e  ls) -> (gin_chan
-000173b0: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
-000173c0: 6c73 290a 2020 2020 2020 2020 7765 6967  ls).        weig
-000173d0: 6874 203d 2063 6f6e 765f 7472 616e 7370  ht = conv_transp
-000173e0: 6f73 6528 7765 6967 6874 290a 2020 2020  ose(weight).    
-000173f0: 2020 2020 2320 5370 6c69 7420 286f 7574      # Split (out
-00017400: 5f63 6861 6e6e 656c 732c 2920 2d3e 2028  _channels,) -> (
-00017410: 6772 6f75 7073 2c20 6f75 745f 6368 616e  groups, out_chan
-00017420: 6e65 6c73 202f 2f20 6772 6f75 7073 290a  nels // groups).
-00017430: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
-00017440: 2077 6569 6768 742e 7265 7368 6170 6528   weight.reshape(
-00017450: 5b67 696e 5f63 6861 6e6e 656c 732c 2067  [gin_channels, g
-00017460: 726f 7570 732c 206f 7574 5f63 6861 6e6e  roups, out_chann
-00017470: 656c 7320 2f2f 2067 726f 7570 735d 202b  els // groups] +
-00017480: 206b 6572 6e65 6c5f 6469 6d73 290a 2020   kernel_dims).  
-00017490: 2020 2020 2020 2320 4d6f 7669 6e67 2067        # Moving g
-000174a0: 726f 7570 7320 746f 2074 6865 206c 6566  roups to the lef
-000174b0: 742d 6d6f 7374 2070 6f73 6974 696f 6e2e  t-most position.
-000174c0: 0a20 2020 2020 2020 2023 2028 6769 6e5f  .        # (gin_
-000174d0: 6368 616e 6e65 6c73 2c20 6772 6f75 7073  channels, groups
-000174e0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
-000174f0: 2f20 6772 6f75 7073 2920 2d3e 2028 6772  / groups) -> (gr
-00017500: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
-00017510: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
-00017520: 202f 2f20 6772 6f75 7073 290a 2020 2020   // groups).    
-00017530: 2020 2020 7765 6967 6874 203d 2063 6f6e      weight = con
-00017540: 765f 7472 616e 7370 6f73 6528 7765 6967  v_transpose(weig
-00017550: 6874 290a 2020 2020 2020 2020 2320 5371  ht).        # Sq
-00017560: 7561 7368 2028 6772 6f75 7073 2c20 6769  uash (groups, gi
-00017570: 6e5f 6368 616e 6e65 6c73 2920 2d3e 2028  n_channels) -> (
-00017580: 696e 5f63 6861 6e6e 656c 7329 0a20 2020  in_channels).   
-00017590: 2020 2020 2077 6569 6768 7420 3d20 7765       weight = we
-000175a0: 6967 6874 2e72 6573 6861 7065 285b 696e  ight.reshape([in
-000175b0: 5f63 6861 6e6e 656c 732c 206f 7574 5f63  _channels, out_c
-000175c0: 6861 6e6e 656c 7320 2f2f 2067 726f 7570  hannels // group
-000175d0: 735d 202b 206b 6572 6e65 6c5f 6469 6d73  s] + kernel_dims
-000175e0: 290a 0a20 2020 2020 2020 2023 2046 6c69  )..        # Fli
-000175f0: 7020 7370 6174 6961 6c20 6469 6d65 6e73  p spatial dimens
-00017600: 696f 6e73 0a20 2020 2020 2020 2077 6569  ions.        wei
-00017610: 6768 7420 3d20 7072 696d 732e 666c 6970  ght = prims.flip
-00017620: 2877 6569 6768 742c 2074 7570 6c65 2872  (weight, tuple(r
-00017630: 616e 6765 2832 2c20 7765 6967 6874 2e6e  ange(2, weight.n
-00017640: 6469 6d29 2929 0a20 2020 2020 2020 2072  dim))).        r
-00017650: 6574 7572 6e20 7765 6967 6874 0a0a 2020  eturn weight..  
-00017660: 2020 2320 5765 206e 6565 6420 746f 2070    # We need to p
-00017670: 6164 2074 6865 2067 7261 6469 656e 7420  ad the gradient 
-00017680: 746f 2062 6520 6162 6c65 2074 6f20 6669  to be able to fi
-00017690: 7420 6b65 726e 656c 2077 696e 646f 7773  t kernel windows
-000176a0: 2e0a 2020 2020 696e 6974 6961 6c5f 6772  ..    initial_gr
-000176b0: 6164 5f70 6164 6469 6e67 203d 205b 6420  ad_padding = [d 
-000176c0: 2a20 286b 202d 2031 2920 666f 7220 642c  * (k - 1) for d,
-000176d0: 206b 2069 6e20 7a69 7028 6469 6c61 7469   k in zip(dilati
-000176e0: 6f6e 2c20 6b65 726e 656c 5f64 696d 7329  on, kernel_dims)
-000176f0: 5d0a 0a20 2020 2069 6e70 7574 5f67 7261  ]..    input_gra
-00017700: 6420 3d20 636f 6e76 6f6c 7574 696f 6e28  d = convolution(
-00017710: 0a20 2020 2020 2020 2070 7269 6d73 2e70  .        prims.p
-00017720: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
-00017730: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-00017740: 2020 302e 302c 0a20 2020 2020 2020 2020    0.0,.         
-00017750: 2020 2023 2054 6865 2070 6978 6573 2061     # The pixes a
-00017760: 7265 2073 7472 6964 6520 6177 6179 2066  re stride away f
-00017770: 726f 6d20 6561 6368 206f 7468 6572 2069  rom each other i
-00017780: 6e20 7468 6520 6f72 6967 696e 616c 2069  n the original i
-00017790: 6e70 7574 2e0a 2020 2020 2020 2020 2020  nput..          
-000177a0: 2020 2320 4865 6e63 6520 7765 206e 6565    # Hence we nee
-000177b0: 6420 746f 2064 696c 6174 6520 7468 6520  d to dilate the 
-000177c0: 6772 6164 6965 6e74 2062 7920 6469 6c61  gradient by dila
-000177d0: 7469 6f6e 3d73 7472 6964 6520 2d20 310a  tion=stride - 1.
-000177e0: 2020 2020 2020 2020 2020 2020 2320 736f              # so
-000177f0: 2074 6861 7420 7468 6572 6520 6172 6520   that there are 
-00017800: 7374 7269 6465 202d 2031 207a 6572 6f73  stride - 1 zeros
-00017810: 2062 6574 7765 656e 2074 6865 2070 6978   between the pix
-00017820: 656c 732e 0a20 2020 2020 2020 2020 2020  els..           
-00017830: 205b 2830 2c20 302c 2030 292c 2028 302c   [(0, 0, 0), (0,
-00017840: 2030 2c20 3029 5d20 2b20 5b28 302c 2030   0, 0)] + [(0, 0
-00017850: 2c20 7320 2d20 3129 2066 6f72 2073 2069  , s - 1) for s i
-00017860: 6e20 7374 7269 6465 5d2c 0a20 2020 2020  n stride],.     
-00017870: 2020 2029 2c0a 2020 2020 2020 2020 7472     ),.        tr
-00017880: 616e 7370 6f73 655f 616e 645f 666c 6970  anspose_and_flip
-00017890: 5f77 6569 6768 7428 7765 6967 6874 292c  _weight(weight),
-000178a0: 0a20 2020 2020 2020 204e 6f6e 652c 0a20  .        None,. 
-000178b0: 2020 2020 2020 2023 2053 6574 7469 6e67         # Setting
-000178c0: 2073 7472 6964 6520 746f 2031 2061 7320   stride to 1 as 
-000178d0: 7468 6520 6469 7374 616e 6365 2062 6574  the distance bet
-000178e0: 7765 656e 2070 6978 656c 7320 6973 2074  ween pixels is t
-000178f0: 616b 656e 0a20 2020 2020 2020 2023 2063  aken.        # c
-00017900: 6172 6520 6279 2074 6865 2070 6164 2072  are by the pad r
-00017910: 6967 6874 2061 626f 7665 2e0a 2020 2020  ight above..    
-00017920: 2020 2020 2831 2c29 2c0a 2020 2020 2020      (1,),.      
-00017930: 2020 696e 6974 6961 6c5f 6772 6164 5f70    initial_grad_p
-00017940: 6164 6469 6e67 2c0a 2020 2020 2020 2020  adding,.        
-00017950: 6469 6c61 7469 6f6e 2c0a 2020 2020 2020  dilation,.      
-00017960: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
-00017970: 2020 2020 2020 6f75 7470 7574 5f70 6164        output_pad
-00017980: 6469 6e67 2c0a 2020 2020 2020 2020 6772  ding,.        gr
-00017990: 6f75 7073 2c0a 2020 2020 290a 0a20 2020  oups,.    )..   
-000179a0: 2064 6566 2070 6164 5f74 6f5f 696e 7075   def pad_to_inpu
-000179b0: 7428 6772 6164 293a 0a20 2020 2020 2020  t(grad):.       
-000179c0: 2023 2057 6520 6e65 6564 2074 6f20 756e   # We need to un
-000179d0: 7061 6420 7468 6520 7061 6464 696e 6720  pad the padding 
-000179e0: 646f 6e65 2074 6f20 7468 6520 696e 7075  done to the inpu
-000179f0: 7420 7072 696f 7220 746f 2074 6865 2063  t prior to the c
-00017a00: 6f6e 766f 6c75 7469 6f6e 2e0a 2020 2020  onvolution..    
-00017a10: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
-00017a20: 6c6f 7720 616e 6420 6869 6768 2070 6164  low and high pad
-00017a30: 6469 6e67 2061 7265 206e 6f74 206e 6563  ding are not nec
-00017a40: 6573 7361 7269 6c79 2065 7175 616c 2c20  essarily equal, 
-00017a50: 736f 2077 6520 6361 6e6e 6f74 0a20 2020  so we cannot.   
-00017a60: 2020 2020 2023 2061 6273 6f72 6220 6974       # absorb it
-00017a70: 2069 6e74 6f20 7468 6520 636f 6e76 6f6c   into the convol
-00017a80: 7574 696f 6e20 6a75 7374 2079 6574 2c20  ution just yet, 
-00017a90: 756e 6c65 7373 2074 6865 2041 5049 2069  unless the API i
-00017aa0: 7320 6d6f 6469 6669 6564 2e0a 2020 2020  s modified..    
-00017ab0: 2020 2020 7061 645f 636f 6e66 6967 203d      pad_config =
-00017ac0: 205b 2830 2c20 302c 2030 292c 2028 302c   [(0, 0, 0), (0,
-00017ad0: 2030 2c20 3029 5d0a 2020 2020 2020 2020   0, 0)].        
-00017ae0: 666f 7220 6f2c 2069 2c20 672c 2070 2069  for o, i, g, p i
-00017af0: 6e20 7a69 7028 6772 6164 2e73 6861 7065  n zip(grad.shape
-00017b00: 5b32 3a5d 2c20 7370 6174 6961 6c5f 6469  [2:], spatial_di
-00017b10: 6d73 2c20 696e 7075 745f 6772 6164 2e73  ms, input_grad.s
-00017b20: 6861 7065 5b32 3a5d 2c20 7061 6464 696e  hape[2:], paddin
-00017b30: 6729 3a0a 2020 2020 2020 2020 2020 2020  g):.            
-00017b40: 6c6f 203d 202d 700a 2020 2020 2020 2020  lo = -p.        
-00017b50: 2020 2020 2320 4e6f 7465 2074 6861 7420      # Note that 
-00017b60: 2869 202b 2032 202a 2070 2920 6973 2074  (i + 2 * p) is t
-00017b70: 6865 2073 697a 6520 6f66 2074 6865 2070  he size of the p
-00017b80: 6164 6465 6420 696e 7075 742c 0a20 2020  added input,.   
-00017b90: 2020 2020 2020 2020 2023 2073 6f20 7468           # so th
-00017ba0: 6520 7175 616e 7469 7479 2028 6920 2b20  e quantity (i + 
-00017bb0: 3220 2a20 7029 202d 2067 2074 656c 6c73  2 * p) - g tells
-00017bc0: 2075 7320 6279 2068 6f77 206d 7563 680a   us by how much.
-00017bd0: 2020 2020 2020 2020 2020 2020 2320 7765              # we
-00017be0: 206e 6565 6420 746f 2070 6164 2074 6865   need to pad the
-00017bf0: 2067 7261 6469 656e 7420 736f 2074 6861   gradient so tha
-00017c00: 7420 7468 6520 656c 656d 656e 7473 206f  t the elements o
-00017c10: 7574 7369 6465 0a20 2020 2020 2020 2020  utside.         
-00017c20: 2020 2023 206f 6620 7468 6520 636f 6e76     # of the conv
-00017c30: 6f6c 7574 696f 6e20 7265 6365 6976 6520  olution receive 
-00017c40: 7a65 726f 2067 7261 6469 656e 742e 0a20  zero gradient.. 
-00017c50: 2020 2020 2020 2020 2020 2023 2070 2069             # p i
-00017c60: 7320 6164 6469 7469 6f6e 616c 6c79 2073  s additionally s
-00017c70: 7562 7472 6163 7465 6420 746f 206e 6567  ubtracted to neg
-00017c80: 6174 6520 7468 6520 696e 7075 7427 7320  ate the input's 
-00017c90: 7061 640a 2020 2020 2020 2020 2020 2020  pad.            
-00017ca0: 2320 696e 2066 6f72 7761 7264 2e0a 2020  # in forward..  
-00017cb0: 2020 2020 2020 2020 2020 6869 203d 2028            hi = (
-00017cc0: 6920 2b20 3220 2a20 7029 202d 2067 202d  i + 2 * p) - g -
-00017cd0: 2070 0a20 2020 2020 2020 2020 2020 2070   p.            p
-00017ce0: 6164 5f63 6f6e 6669 672e 6170 7065 6e64  ad_config.append
-00017cf0: 2828 6c6f 2c20 6869 2c20 3029 290a 2020  ((lo, hi, 0)).  
-00017d00: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
-00017d10: 6d73 2e70 6164 2867 7261 642c 2030 2e30  ms.pad(grad, 0.0
-00017d20: 2c20 7061 645f 636f 6e66 6967 290a 0a20  , pad_config).. 
-00017d30: 2020 2069 6e70 7574 5f67 7261 6420 3d20     input_grad = 
-00017d40: 7061 645f 746f 5f69 6e70 7574 2869 6e70  pad_to_input(inp
-00017d50: 7574 5f67 7261 6429 0a20 2020 2023 207d  ut_grad).    # }
-00017d60: 0a0a 2020 2020 2320 6269 6173 5f67 7261  ..    # bias_gra
-00017d70: 6420 3d20 7b0a 2020 2020 6966 2062 6961  d = {.    if bia
-00017d80: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00017d90: 2020 2020 2020 2069 6d70 6f72 7420 7468         import th
-00017da0: 756e 6465 722e 746f 7263 6820 6173 206c  under.torch as l
-00017db0: 746f 7263 680a 0a20 2020 2020 2020 2062  torch..        b
-00017dc0: 6961 735f 6772 6164 203d 206c 746f 7263  ias_grad = ltorc
-00017dd0: 682e 7375 6d28 6772 6164 2c20 5b64 2066  h.sum(grad, [d f
-00017de0: 6f72 2064 2069 6e20 7261 6e67 6528 6772  or d in range(gr
-00017df0: 6164 2e6e 6469 6d29 2069 6620 6420 213d  ad.ndim) if d !=
-00017e00: 2031 5d29 0a20 2020 2023 207d 0a0a 2020   1]).    # }..  
-00017e10: 2020 2320 7765 6967 6874 2067 7261 6420    # weight grad 
-00017e20: 3d20 7b0a 2020 2020 6465 6620 7061 645f  = {.    def pad_
-00017e30: 7472 616e 7370 6f73 655f 616e 645f 7075  transpose_and_pu
-00017e40: 7368 5f67 726f 7570 735f 696e 746f 5f62  sh_groups_into_b
-00017e50: 6174 6368 6573 2874 293a 0a20 2020 2020  atches(t):.     
-00017e60: 2020 2023 2046 6972 7374 2070 6164 2c2e     # First pad,.
-00017e70: 2e2e 0a20 2020 2020 2020 2023 2050 6164  ...        # Pad
-00017e80: 2061 7320 6e65 6365 7373 6172 7920 736f   as necessary so
-00017e90: 2074 6861 7420 696e 2063 6f6e 766f 6c75   that in convolu
-00017ea0: 7469 6f6e 7320 7765 206e 6576 6572 2061  tions we never a
-00017eb0: 6476 616e 6365 0a20 2020 2020 2020 2023  dvance.        #
-00017ec0: 2070 6173 7420 7265 6c65 7661 6e74 2069   past relevant i
-00017ed0: 6e70 7574 732e 0a20 2020 2020 2020 2070  nputs..        p
-00017ee0: 6164 5f63 6f6e 6669 6720 3d20 5b28 302c  ad_config = [(0,
-00017ef0: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
-00017f00: 295d 0a20 2020 2020 2020 2066 6f72 206f  )].        for o
-00017f10: 2c20 692c 206b 2c20 702c 2073 2c20 6420  , i, k, p, s, d 
-00017f20: 696e 207a 6970 2867 7261 642e 7368 6170  in zip(grad.shap
-00017f30: 655b 323a 5d2c 2073 7061 7469 616c 5f64  e[2:], spatial_d
-00017f40: 696d 732c 206b 6572 6e65 6c5f 6469 6d73  ims, kernel_dims
-00017f50: 2c20 7061 6464 696e 672c 2073 7472 6964  , padding, strid
-00017f60: 652c 2064 696c 6174 696f 6e29 3a0a 2020  e, dilation):.  
-00017f70: 2020 2020 2020 2020 2020 2320 5061 6464            # Padd
-00017f80: 696e 6720 6672 6f6d 2062 656c 6f77 2069  ing from below i
-00017f90: 7320 7468 6520 7361 6d65 2e0a 2020 2020  s the same..    
-00017fa0: 2020 2020 2020 2020 6c6f 203d 2070 0a20          lo = p. 
-00017fb0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00017fc0: 7265 2069 7320 616c 7761 7973 2074 6865  re is always the
-00017fd0: 206d 6178 2069 6e64 6578 2069 6478 2069   max index idx i
-00017fe0: 6e20 7468 6520 696e 7075 740a 2020 2020  n the input.    
-00017ff0: 2020 2020 2020 2020 2320 7468 6520 7661          # the va
-00018000: 6c75 6520 6f66 2077 6869 6368 2c20 696e  lue of which, in
-00018010: 7075 745b 6964 785d 2c20 7468 6520 6b65  put[idx], the ke
-00018020: 726e 656c 2074 6f75 6368 6573 2e0a 2020  rnel touches..  
-00018030: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00018040: 6b65 726e 656c 2072 6561 6368 2c20 6f72  kernel reach, or
-00018050: 206b 5f72 6561 6368 2c20 6973 2065 7861   k_reach, is exa
-00018060: 6374 6c79 2069 6478 202b 2031 2e0a 2020  ctly idx + 1..  
-00018070: 2020 2020 2020 2020 2020 2320 5765 2075            # We u
-00018080: 7365 2069 7420 746f 2064 6563 6964 6520  se it to decide 
-00018090: 6279 2068 6f77 206d 7563 6820 7765 206e  by how much we n
-000180a0: 6565 6420 746f 2070 6164 2066 726f 6d20  eed to pad from 
-000180b0: 6162 6f76 650a 2020 2020 2020 2020 2020  above.          
-000180c0: 2020 2320 6173 2074 6f20 6e6f 7420 6d6f    # as to not mo
-000180d0: 7665 2070 6173 7420 7265 6c65 7661 6e74  ve past relevant
-000180e0: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
-000180f0: 2020 2020 206b 5f72 6561 6368 203d 2028       k_reach = (
-00018100: 6f20 2d20 3129 202a 2073 202b 2064 202a  o - 1) * s + d *
-00018110: 2028 6b20 2d20 3129 202b 2031 0a20 2020   (k - 1) + 1.   
-00018120: 2020 2020 2020 2020 2023 2054 6865 2070           # The p
-00018130: 6164 2066 726f 6d20 6162 6f76 6520 6571  ad from above eq
-00018140: 7561 6c73 206b 5f72 6561 6368 206d 696e  uals k_reach min
-00018150: 7573 2074 6865 206c 656e 6774 680a 2020  us the length.  
-00018160: 2020 2020 2020 2020 2020 2320 6f66 2074            # of t
-00018170: 6865 2069 6e70 7574 2070 6164 6465 6420  he input padded 
-00018180: 6672 6f6d 2062 656c 6f77 2e0a 2020 2020  from below..    
-00018190: 2020 2020 2020 2020 6869 203d 206b 5f72          hi = k_r
-000181a0: 6561 6368 202d 2028 6920 2b20 7029 0a20  each - (i + p). 
-000181b0: 2020 2020 2020 2020 2020 2070 6164 5f63             pad_c
-000181c0: 6f6e 6669 672e 6170 7065 6e64 2828 6c6f  onfig.append((lo
-000181d0: 2c20 6869 2c20 3029 290a 2020 2020 2020  , hi, 0)).      
-000181e0: 2020 7420 3d20 7072 696d 732e 7061 6428    t = prims.pad(
-000181f0: 742c 2030 2e30 2c20 7061 645f 636f 6e66  t, 0.0, pad_conf
-00018200: 6967 290a 0a20 2020 2020 2020 205f 2c20  ig)..        _, 
-00018210: 5f2c 202a 745f 7370 6174 6961 6c5f 6469  _, *t_spatial_di
-00018220: 6d73 203d 2074 2e73 6861 7065 0a0a 2020  ms = t.shape..  
-00018230: 2020 2020 2020 2320 2e2e 2e20 7468 656e        # ... then
-00018240: 2064 6f20 7468 6520 7265 7374 2e0a 2020   do the rest..  
-00018250: 2020 2020 2020 2320 742e 7368 6170 6520        # t.shape 
-00018260: 3d3d 2028 6261 7463 682c 2069 6e5f 6368  == (batch, in_ch
-00018270: 616e 6e65 6c73 2c20 2e2e 2e29 0a20 2020  annels, ...).   
-00018280: 2020 2020 2023 2054 6865 2072 6573 756c       # The resul
-00018290: 7420 6f66 2074 6869 7320 6675 6e63 7469  t of this functi
-000182a0: 6f6e 2068 6173 2073 6861 7065 0a20 2020  on has shape.   
-000182b0: 2020 2020 2023 2028 696e 5f63 6861 6e6e       # (in_chann
-000182c0: 656c 732c 2062 6174 6368 202a 2067 726f  els, batch * gro
-000182d0: 7570 7329 0a20 2020 2020 2020 2023 2028  ups).        # (
-000182e0: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
-000182f0: 6c73 2920 2d3e 2028 696e 5f63 6861 6e6e  ls) -> (in_chann
-00018300: 656c 732c 2062 6174 6368 290a 2020 2020  els, batch).    
-00018310: 2020 2020 7420 3d20 636f 6e76 5f74 7261      t = conv_tra
-00018320: 6e73 706f 7365 2874 290a 2020 2020 2020  nspose(t).      
-00018330: 2020 2320 5370 6c69 7420 2869 6e5f 6368    # Split (in_ch
-00018340: 616e 6e65 6c73 2c29 202d 3e20 2867 726f  annels,) -> (gro
-00018350: 7570 732c 2067 696e 5f63 6861 6e6e 656c  ups, gin_channel
-00018360: 7329 0a20 2020 2020 2020 2074 203d 2074  s).        t = t
-00018370: 2e72 6573 6861 7065 285b 6772 6f75 7073  .reshape([groups
-00018380: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
-00018390: 6261 7463 685d 202b 2074 5f73 7061 7469  batch] + t_spati
-000183a0: 616c 5f64 696d 7329 0a20 2020 2020 2020  al_dims).       
-000183b0: 2023 2054 7261 6e73 706f 7365 2028 6772   # Transpose (gr
-000183c0: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
-000183d0: 6c73 2c20 6261 7463 6829 202d 3e20 2867  ls, batch) -> (g
-000183e0: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
-000183f0: 7570 732c 2062 6174 6368 290a 2020 2020  ups, batch).    
-00018400: 2020 2020 7420 3d20 636f 6e76 5f74 7261      t = conv_tra
-00018410: 6e73 706f 7365 2874 290a 2020 2020 2020  nspose(t).      
-00018420: 2020 2320 466c 6174 7465 6e20 2867 726f    # Flatten (gro
-00018430: 7570 732c 2062 6174 6368 2920 2d3e 2028  ups, batch) -> (
-00018440: 6772 6f75 7073 202a 2062 6174 6368 2c29  groups * batch,)
-00018450: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
-00018460: 6573 6861 7065 285b 6769 6e5f 6368 616e  eshape([gin_chan
-00018470: 6e65 6c73 2c20 6772 6f75 7073 202a 2062  nels, groups * b
-00018480: 6174 6368 5d20 2b20 745f 7370 6174 6961  atch] + t_spatia
-00018490: 6c5f 6469 6d73 290a 2020 2020 2020 2020  l_dims).        
-000184a0: 7265 7475 726e 2074 0a0a 2020 2020 2320  return t..    # 
-000184b0: 696e 7075 7420 7769 6c6c 2068 6176 6520  input will have 
-000184c0: 7368 6170 6520 2867 696e 5f63 6861 6e6e  shape (gin_chann
-000184d0: 656c 732c 2067 726f 7570 7320 2a20 6261  els, groups * ba
-000184e0: 7463 6829 0a20 2020 2069 6e70 7574 203d  tch).    input =
-000184f0: 2070 6164 5f74 7261 6e73 706f 7365 5f61   pad_transpose_a
-00018500: 6e64 5f70 7573 685f 6772 6f75 7073 5f69  nd_push_groups_i
-00018510: 6e74 6f5f 6261 7463 6865 7328 696e 7075  nto_batches(inpu
-00018520: 7429 0a20 2020 2023 2067 7261 6420 7769  t).    # grad wi
-00018530: 6c6c 2068 6176 6520 7368 6170 6520 286f  ll have shape (o
-00018540: 7574 5f63 6861 6e6e 656c 732c 2062 6174  ut_channels, bat
-00018550: 6368 290a 2020 2020 2320 4e6f 7465 2074  ch).    # Note t
-00018560: 6861 7420 7468 6573 6520 7368 6170 6573  hat these shapes
-00018570: 2061 7265 2063 6f6d 7061 7469 626c 6520   are compatible 
-00018580: 666f 7220 6120 6772 6f75 7020 636f 6e76  for a group conv
-00018590: 6f6c 7574 696f 6e2e 0a20 2020 2067 7261  olution..    gra
-000185a0: 6420 3d20 636f 6e76 5f74 7261 6e73 706f  d = conv_transpo
-000185b0: 7365 2867 7261 6429 0a0a 2020 2020 2320  se(grad)..    # 
-000185c0: 5768 7920 646f 2077 6520 666c 6970 2073  Why do we flip s
-000185d0: 7472 6964 6520 616e 6420 6469 6c61 7469  tride and dilati
-000185e0: 6f6e 3f0a 2020 2020 2320 6b65 726e 656c  on?.    # kernel
-000185f0: 5b69 5d20 616e 6420 6b65 726e 656c 5b69  [i] and kernel[i
-00018600: 202b 2031 5d20 6172 6520 6469 6c61 7469   + 1] are dilati
-00018610: 6f6e 2061 7061 7274 2066 726f 6d20 6561  on apart from ea
-00018620: 6368 206f 7468 6572 2c0a 2020 2020 2320  ch other,.    # 
-00018630: 736f 2064 696c 6174 696f 6e20 6265 636f  so dilation beco
-00018640: 6d65 7320 7468 6520 6e65 7720 7374 7269  mes the new stri
-00018650: 6465 2e0a 2020 2020 2320 416c 6c20 7468  de..    # All th
-00018660: 6520 656c 656d 656e 7473 2074 6861 7420  e elements that 
-00018670: 6b65 726e 656c 5b69 5d20 746f 7563 6865  kernel[i] touche
-00018680: 7320 6172 6520 7374 7269 6465 2061 7761  s are stride awa
-00018690: 7920 6672 6f6d 2065 6163 6820 6f74 6865  y from each othe
-000186a0: 722c 0a20 2020 2023 2068 656e 6365 2073  r,.    # hence s
-000186b0: 7472 6964 6520 6265 636f 6d65 7320 7468  tride becomes th
-000186c0: 6520 6e65 7720 6469 6c61 7469 6f6e 2e0a  e new dilation..
-000186d0: 2020 2020 7765 6967 6874 5f67 7261 6420      weight_grad 
-000186e0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
-000186f0: 2020 2020 2020 2069 6e70 7574 2c0a 2020         input,.  
-00018700: 2020 2020 2020 6772 6164 2c0a 2020 2020        grad,.    
-00018710: 2020 2020 4e6f 6e65 2c0a 2020 2020 2020      None,.      
-00018720: 2020 6469 6c61 7469 6f6e 2c20 2023 2073    dilation,  # s
-00018730: 6574 2073 7472 6964 653d 6469 6c61 7469  et stride=dilati
-00018740: 6f6e 0a20 2020 2020 2020 2028 302c 292c  on.        (0,),
-00018750: 0a20 2020 2020 2020 2073 7472 6964 652c  .        stride,
-00018760: 2020 2320 7365 7420 6469 6c61 7469 6f6e    # set dilation
-00018770: 3d73 7472 6964 650a 2020 2020 2020 2020  =stride.        
-00018780: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
-00018790: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
-000187a0: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
-000187b0: 7073 2c0a 2020 2020 290a 0a20 2020 2023  ps,.    )..    #
-000187c0: 2054 6865 2072 6573 756c 7420 6f66 2074   The result of t
-000187d0: 6865 2063 6f6e 766f 6c75 7469 6f6e 2068  he convolution h
-000187e0: 6173 2073 6861 7065 2028 6769 6e5f 6368  as shape (gin_ch
-000187f0: 616e 6e65 6c73 2c20 6f75 745f 6368 616e  annels, out_chan
-00018800: 6e65 6c73 292c 0a20 2020 2023 2073 6f20  nels),.    # so 
-00018810: 7472 616e 7370 6f73 6974 696f 6e20 6973  transposition is
-00018820: 2072 6571 7569 7265 642e 0a20 2020 2077   required..    w
-00018830: 6569 6768 745f 6772 6164 203d 2063 6f6e  eight_grad = con
-00018840: 765f 7472 616e 7370 6f73 6528 7765 6967  v_transpose(weig
-00018850: 6874 5f67 7261 6429 0a20 2020 2023 207d  ht_grad).    # }
-00018860: 0a0a 2020 2020 7265 7475 726e 2028 696e  ..    return (in
-00018870: 7075 745f 6772 6164 2c20 7765 6967 6874  put_grad, weight
-00018880: 5f67 7261 642c 2062 6961 735f 6772 6164  _grad, bias_grad
-00018890: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-000188a0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-000188b0: 2274 6f72 6368 2e6c 6f67 5f73 6f66 746d  "torch.log_softm
-000188c0: 6178 2229 0a64 6566 206c 6f67 5f73 6f66  ax").def log_sof
-000188d0: 746d 6178 5f61 7567 5f66 7764 2869 6e70  tmax_aug_fwd(inp
-000188e0: 7574 3a20 5465 6e73 6f72 5072 6f78 792c  ut: TensorProxy,
-000188f0: 2064 696d 3a20 696e 742c 202a 2c20 6474   dim: int, *, dt
-00018900: 7970 653d 4e6f 6e65 2920 2d3e 2056 4a50  ype=None) -> VJP
-00018910: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
-00018920: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00018930: 6f72 7420 6c6f 675f 736f 6674 6d61 780a  ort log_softmax.
-00018940: 0a20 2020 2070 7269 6d61 6c20 3d20 6c6f  .    primal = lo
-00018950: 675f 736f 6674 6d61 7828 696e 7075 742c  g_softmax(input,
-00018960: 2064 696d 3d64 696d 2c20 6474 7970 653d   dim=dim, dtype=
-00018970: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
-00018980: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
-00018990: 6469 6d2c 2069 6e70 7574 2e64 7479 7065  dim, input.dtype
-000189a0: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-000189b0: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-000189c0: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
-000189d0: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
-000189e0: 7263 682e 6c6f 675f 736f 6674 6d61 7822  rch.log_softmax"
-000189f0: 290a 6465 6620 6c6f 675f 736f 6674 6d61  ).def log_softma
-00018a00: 785f 6261 636b 7761 7264 2870 7269 6d61  x_backward(prima
-00018a10: 6c2c 2064 696d 2c20 6474 7970 652c 2067  l, dim, dtype, g
-00018a20: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
-00018a30: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
-00018a40: 206c 6f67 5f73 6f66 746d 6178 5f62 6163   log_softmax_bac
-00018a50: 6b77 6172 640a 0a20 2020 2072 6574 7572  kward..    retur
-00018a60: 6e20 6c6f 675f 736f 6674 6d61 785f 6261  n log_softmax_ba
-00018a70: 636b 7761 7264 2867 2c20 7072 696d 616c  ckward(g, primal
-00018a80: 2c20 6469 6d2c 2064 7479 7065 290a 0a0a  , dim, dtype)...
-00018a90: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00018aa0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-00018ab0: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
-00018ac0: 2e6e 6c6c 5f6c 6f73 7322 290a 6465 6620  .nll_loss").def 
-00018ad0: 6e6c 6c5f 6c6f 7373 5f61 7567 5f66 7764  nll_loss_aug_fwd
-00018ae0: 280a 2020 2020 696e 7075 743a 2050 726f  (.    input: Pro
-00018af0: 7879 2c0a 2020 2020 7461 7267 6574 3a20  xy,.    target: 
-00018b00: 5072 6f78 792c 0a20 2020 2077 6569 6768  Proxy,.    weigh
-00018b10: 743a 204e 6f6e 6520 7c20 5072 6f78 792c  t: None | Proxy,
-00018b20: 0a20 2020 2069 676e 6f72 655f 696e 6465  .    ignore_inde
-00018b30: 783a 2069 6e74 2c0a 2020 2020 7265 6475  x: int,.    redu
-00018b40: 6374 696f 6e3a 2073 7472 2c0a 2920 2d3e  ction: str,.) ->
-00018b50: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
-00018b60: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00018b70: 2069 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73   import _nll_los
-00018b80: 735f 6865 6c70 6572 0a0a 2020 2020 7072  s_helper..    pr
-00018b90: 696d 616c 2c20 746f 7461 6c5f 7765 6967  imal, total_weig
-00018ba0: 6874 203d 205f 6e6c 6c5f 6c6f 7373 5f68  ht = _nll_loss_h
-00018bb0: 656c 7065 7228 0a20 2020 2020 2020 2069  elper(.        i
-00018bc0: 6e70 7574 2c0a 2020 2020 2020 2020 7461  nput,.        ta
-00018bd0: 7267 6574 2c0a 2020 2020 2020 2020 7765  rget,.        we
-00018be0: 6967 6874 2c0a 2020 2020 2020 2020 6967  ight,.        ig
-00018bf0: 6e6f 7265 5f69 6e64 6578 2c0a 2020 2020  nore_index,.    
-00018c00: 2020 2020 7265 6475 6374 696f 6e2c 0a20      reduction,. 
-00018c10: 2020 2029 0a20 2020 2072 6573 6964 7561     ).    residua
-00018c20: 6c73 203d 2028 696e 7075 742c 2074 6172  ls = (input, tar
-00018c30: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
-00018c40: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
-00018c50: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
-00018c60: 6874 290a 2020 2020 7265 7475 726e 2056  ht).    return V
-00018c70: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
-00018c80: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
-00018c90: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
-00018ca0: 746f 7263 682e 6e6e 2e66 756e 6374 696f  torch.nn.functio
-00018cb0: 6e61 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64  nal.nll_loss").d
-00018cc0: 6566 206e 6c6c 5f6c 6f73 735f 6261 636b  ef nll_loss_back
-00018cd0: 7761 7264 2869 6e70 7574 2c20 7461 7267  ward(input, targ
-00018ce0: 6574 2c20 7765 6967 6874 2c20 7265 6475  et, weight, redu
-00018cf0: 6374 696f 6e2c 2069 676e 6f72 655f 696e  ction, ignore_in
-00018d00: 6465 782c 2074 6f74 616c 5f77 6569 6768  dex, total_weigh
-00018d10: 742c 2067 293a 0a20 2020 2066 726f 6d20  t, g):.    from 
-00018d20: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00018d30: 706f 7274 206e 6c6c 5f6c 6f73 735f 6261  port nll_loss_ba
-00018d40: 636b 7761 7264 0a0a 2020 2020 6769 6e70  ckward..    ginp
-00018d50: 7574 203d 206e 6c6c 5f6c 6f73 735f 6261  ut = nll_loss_ba
-00018d60: 636b 7761 7264 2867 2c20 696e 7075 742c  ckward(g, input,
-00018d70: 2074 6172 6765 742c 2077 6569 6768 742c   target, weight,
-00018d80: 2072 6564 7563 7469 6f6e 2c20 6967 6e6f   reduction, igno
-00018d90: 7265 5f69 6e64 6578 2c20 746f 7461 6c5f  re_index, total_
-00018da0: 7765 6967 6874 290a 2020 2020 7265 7475  weight).    retu
-00018db0: 726e 2067 696e 7075 742c 202a 2828 4e6f  rn ginput, *((No
-00018dc0: 6e65 2c29 202a 2034 290a 0a0a 4072 6567  ne,) * 4)...@reg
-00018dd0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00018de0: 666f 7277 6172 6428 2274 6f72 6368 2e73  forward("torch.s
-00018df0: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
-00018e00: 5f61 7567 5f66 7764 2861 3a20 5465 6e73  _aug_fwd(a: Tens
-00018e10: 6f72 5072 6f78 792c 2073 706c 6974 5f73  orProxy, split_s
-00018e20: 697a 655f 6f72 5f73 6563 7469 6f6e 733a  ize_or_sections:
-00018e30: 2069 6e74 207c 2053 6571 7565 6e63 655b   int | Sequence[
-00018e40: 696e 745d 2c20 6469 6d3a 2069 6e74 203d  int], dim: int =
-00018e50: 2030 2920 2d3e 2056 4a50 4475 616c 3a0a   0) -> VJPDual:.
-00018e60: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-00018e70: 2e74 6f72 6368 2069 6d70 6f72 7420 7370  .torch import sp
-00018e80: 6c69 740a 0a20 2020 2070 7269 6d61 6c20  lit..    primal 
-00018e90: 3d20 7370 6c69 7428 612c 2073 706c 6974  = split(a, split
-00018ea0: 5f73 697a 655f 6f72 5f73 6563 7469 6f6e  _size_or_section
-00018eb0: 732c 2064 696d 290a 2020 2020 7265 7369  s, dim).    resi
-00018ec0: 6475 616c 7320 3d20 2864 696d 2c29 0a20  duals = (dim,). 
-00018ed0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-00018ee0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-00018ef0: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
-00018f00: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
-00018f10: 2e73 706c 6974 2229 0a64 6566 2073 706c  .split").def spl
-00018f20: 6974 5f62 6163 6b77 6172 6428 6469 6d2c  it_backward(dim,
-00018f30: 202a 6772 6164 7329 3a0a 2020 2020 6672   *grads):.    fr
-00018f40: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00018f50: 2069 6d70 6f72 7420 6361 740a 0a20 2020   import cat..   
-00018f60: 2072 6574 7572 6e20 6361 7428 6772 6164   return cat(grad
-00018f70: 732c 2064 696d 290a 0a0a 4072 6567 6973  s, dim)...@regis
-00018f80: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-00018f90: 7277 6172 6428 2274 6f72 6368 2e6e 6e2e  rward("torch.nn.
-00018fa0: 6675 6e63 7469 6f6e 616c 2e65 6d62 6564  functional.embed
-00018fb0: 6469 6e67 2229 0a64 6566 2065 6d62 6564  ding").def embed
-00018fc0: 6469 6e67 5f61 7567 5f66 7764 280a 2020  ding_aug_fwd(.  
-00018fd0: 2020 613a 2050 726f 7879 2c0a 2020 2020    a: Proxy,.    
-00018fe0: 7765 6967 6874 3a20 5072 6f78 792c 0a20  weight: Proxy,. 
-00018ff0: 2020 2070 6164 6469 6e67 5f69 6478 3a20     padding_idx: 
-00019000: 696e 7420 7c20 4e6f 6e65 2c0a 2020 2020  int | None,.    
-00019010: 6d61 785f 6e6f 726d 3a20 666c 6f61 7420  max_norm: float 
-00019020: 7c20 4e6f 6e65 2c0a 2020 2020 6e6f 726d  | None,.    norm
-00019030: 5f74 7970 653a 2066 6c6f 6174 2c0a 2020  _type: float,.  
-00019040: 2020 7363 616c 655f 6772 6164 5f62 795f    scale_grad_by_
-00019050: 6672 6571 3a20 626f 6f6c 2c0a 2020 2020  freq: bool,.    
-00019060: 7370 6172 7365 3a20 626f 6f6c 2c0a 2920  sparse: bool,.) 
-00019070: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-00019080: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00019090: 6368 2069 6d70 6f72 7420 656d 6265 6464  ch import embedd
-000190a0: 696e 670a 0a20 2020 2070 7269 6d61 6c20  ing..    primal 
-000190b0: 3d20 656d 6265 6464 696e 6728 0a20 2020  = embedding(.   
-000190c0: 2020 2020 2061 2c0a 2020 2020 2020 2020       a,.        
-000190d0: 7765 6967 6874 2c0a 2020 2020 2020 2020  weight,.        
-000190e0: 7061 6464 696e 675f 6964 783d 7061 6464  padding_idx=padd
-000190f0: 696e 675f 6964 782c 0a20 2020 2020 2020  ing_idx,.       
-00019100: 206d 6178 5f6e 6f72 6d3d 6d61 785f 6e6f   max_norm=max_no
-00019110: 726d 2c0a 2020 2020 2020 2020 6e6f 726d  rm,.        norm
-00019120: 5f74 7970 653d 6e6f 726d 5f74 7970 652c  _type=norm_type,
-00019130: 0a20 2020 2020 2020 2073 6361 6c65 5f67  .        scale_g
-00019140: 7261 645f 6279 5f66 7265 713d 7363 616c  rad_by_freq=scal
-00019150: 655f 6772 6164 5f62 795f 6672 6571 2c0a  e_grad_by_freq,.
-00019160: 2020 2020 2020 2020 7370 6172 7365 3d73          sparse=s
-00019170: 7061 7273 652c 0a20 2020 2029 0a20 2020  parse,.    ).   
-00019180: 2072 6573 6964 7561 6c73 203d 2028 612c   residuals = (a,
-00019190: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
-000191a0: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
-000191b0: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
-000191c0: 712c 2073 7061 7273 6529 0a20 2020 2072  q, sparse).    r
-000191d0: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-000191e0: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-000191f0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-00019200: 6b77 6172 6428 2274 6f72 6368 2e6e 6e2e  kward("torch.nn.
-00019210: 6675 6e63 7469 6f6e 616c 2e65 6d62 6564  functional.embed
-00019220: 6469 6e67 2229 0a64 6566 2065 6d62 6564  ding").def embed
-00019230: 6469 6e67 5f62 6163 6b77 6172 6428 612c  ding_backward(a,
-00019240: 206e 756d 5f77 6569 6768 7473 2c20 7061   num_weights, pa
-00019250: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
-00019260: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
-00019270: 7061 7273 652c 2067 293a 0a20 2020 2066  parse, g):.    f
-00019280: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-00019290: 6820 696d 706f 7274 2065 6d62 6564 6469  h import embeddi
-000192a0: 6e67 5f62 6163 6b77 6172 640a 0a20 2020  ng_backward..   
-000192b0: 2070 6164 6469 6e67 5f69 6478 203d 202d   padding_idx = -
-000192c0: 3120 6966 2070 6164 6469 6e67 5f69 6478  1 if padding_idx
-000192d0: 2069 7320 4e6f 6e65 2065 6c73 6520 7061   is None else pa
-000192e0: 6464 696e 675f 6964 780a 2020 2020 6777  dding_idx.    gw
-000192f0: 6569 6768 7420 3d20 656d 6265 6464 696e  eight = embeddin
-00019300: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
-00019310: 206e 756d 5f77 6569 6768 7473 2c20 7061   num_weights, pa
-00019320: 6464 696e 675f 6964 782c 2073 6361 6c65  dding_idx, scale
-00019330: 5f67 7261 645f 6279 5f66 7265 712c 2073  _grad_by_freq, s
-00019340: 7061 7273 6529 0a20 2020 2072 6574 7572  parse).    retur
-00019350: 6e20 6777 6569 6768 740a 0a0a 4072 6567  n gweight...@reg
-00019360: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00019370: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00019380: 696d 4944 732e 4241 5443 485f 4e4f 524d  imIDs.BATCH_NORM
-00019390: 290a 6465 6620 6261 7463 685f 6e6f 726d  ).def batch_norm
-000193a0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
-000193b0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
-000193c0: 2020 7765 6967 6874 3a20 4e6f 6e65 207c    weight: None |
-000193d0: 2054 656e 736f 7250 726f 7879 2c0a 2020   TensorProxy,.  
-000193e0: 2020 6269 6173 3a20 4e6f 6e65 207c 2054    bias: None | T
-000193f0: 656e 736f 7250 726f 7879 2c0a 2020 2020  ensorProxy,.    
-00019400: 7275 6e6e 696e 675f 6d65 616e 3a20 4e6f  running_mean: No
-00019410: 6e65 207c 2054 656e 736f 7250 726f 7879  ne | TensorProxy
-00019420: 2c0a 2020 2020 7275 6e6e 696e 675f 7661  ,.    running_va
-00019430: 723a 204e 6f6e 6520 7c20 5465 6e73 6f72  r: None | Tensor
-00019440: 5072 6f78 792c 0a20 2020 2074 7261 696e  Proxy,.    train
-00019450: 696e 673a 2062 6f6f 6c2c 0a20 2020 206d  ing: bool,.    m
-00019460: 6f6d 656e 7475 6d3a 204e 756d 6265 722c  omentum: Number,
-00019470: 0a20 2020 2065 7073 3a20 4e75 6d62 6572  .    eps: Number
-00019480: 2c0a 2920 2d3e 2056 4a50 4475 616c 3a0a  ,.) -> VJPDual:.
-00019490: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
-000194a0: 6d73 2e62 6174 6368 5f6e 6f72 6d28 0a20  ms.batch_norm(. 
-000194b0: 2020 2020 2020 2061 2c0a 2020 2020 2020         a,.      
-000194c0: 2020 7765 6967 6874 2c0a 2020 2020 2020    weight,.      
-000194d0: 2020 6269 6173 2c0a 2020 2020 2020 2020    bias,.        
-000194e0: 7275 6e6e 696e 675f 6d65 616e 2c0a 2020  running_mean,.  
-000194f0: 2020 2020 2020 7275 6e6e 696e 675f 7661        running_va
-00019500: 722c 0a20 2020 2020 2020 2074 7261 696e  r,.        train
-00019510: 696e 672c 0a20 2020 2020 2020 206d 6f6d  ing,.        mom
-00019520: 656e 7475 6d2c 0a20 2020 2020 2020 2065  entum,.        e
-00019530: 7073 2c0a 2020 2020 290a 2020 2020 6f75  ps,.    ).    ou
-00019540: 7470 7574 5f6d 6173 6b20 3d20 5b78 2069  tput_mask = [x i
-00019550: 7320 6e6f 7420 4e6f 6e65 2066 6f72 2078  s not None for x
-00019560: 2069 6e20 2861 2c20 7765 6967 6874 2c20   in (a, weight, 
-00019570: 6269 6173 295d 0a20 2020 206f 7574 7075  bias)].    outpu
-00019580: 742c 2073 6176 655f 6d65 616e 2c20 7361  t, save_mean, sa
-00019590: 7665 5f69 6e76 7374 6420 3d20 7072 696d  ve_invstd = prim
-000195a0: 616c 0a20 2020 2072 6573 6964 7561 6c73  al.    residuals
-000195b0: 203d 2028 612c 2077 6569 6768 742c 2072   = (a, weight, r
-000195c0: 756e 6e69 6e67 5f6d 6561 6e2c 2072 756e  unning_mean, run
-000195d0: 6e69 6e67 5f76 6172 2c20 7361 7665 5f6d  ning_var, save_m
-000195e0: 6561 6e2c 2073 6176 655f 696e 7673 7464  ean, save_invstd
-000195f0: 2c20 7472 6169 6e69 6e67 2c20 6570 732c  , training, eps,
-00019600: 206f 7574 7075 745f 6d61 736b 290a 2020   output_mask).  
-00019610: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00019620: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-00019630: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-00019640: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
-00019650: 7269 6d49 4473 2e42 4154 4348 5f4e 4f52  rimIDs.BATCH_NOR
-00019660: 4d29 0a64 6566 2062 6174 6368 5f6e 6f72  M).def batch_nor
-00019670: 6d5f 6261 636b 7761 7264 2861 2c20 7765  m_backward(a, we
-00019680: 6967 6874 2c20 7275 6e6e 696e 675f 6d65  ight, running_me
-00019690: 616e 2c20 7275 6e6e 696e 675f 7661 722c  an, running_var,
-000196a0: 2073 6176 655f 6d65 616e 2c20 7361 7665   save_mean, save
-000196b0: 5f69 6e76 7374 642c 2074 7261 696e 2c20  _invstd, train, 
-000196c0: 6570 732c 206f 7574 7075 745f 6d61 736b  eps, output_mask
-000196d0: 2c20 2a67 7261 6473 293a 0a20 2020 2066  , *grads):.    f
-000196e0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-000196f0: 6820 696d 706f 7274 2062 6174 6368 5f6e  h import batch_n
-00019700: 6f72 6d5f 6261 636b 7761 7264 0a0a 2020  orm_backward..  
-00019710: 2020 7265 7375 6c74 203d 2062 6174 6368    result = batch
-00019720: 5f6e 6f72 6d5f 6261 636b 7761 7264 280a  _norm_backward(.
-00019730: 2020 2020 2020 2020 6772 6164 735b 305d          grads[0]
-00019740: 2c20 612c 2077 6569 6768 742c 2072 756e  , a, weight, run
-00019750: 6e69 6e67 5f6d 6561 6e2c 2072 756e 6e69  ning_mean, runni
-00019760: 6e67 5f76 6172 2c20 7361 7665 5f6d 6561  ng_var, save_mea
-00019770: 6e2c 2073 6176 655f 696e 7673 7464 2c20  n, save_invstd, 
-00019780: 7472 6169 6e2c 2065 7073 2c20 6f75 7470  train, eps, outp
-00019790: 7574 5f6d 6173 6b0a 2020 2020 290a 2020  ut_mask.    ).  
-000197a0: 2020 7265 7475 726e 202a 7265 7375 6c74    return *result
-000197b0: 2c20 4e6f 6e65 2c20 4e6f 6e65 0a0a 0a40  , None, None...@
-000197c0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-000197d0: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
-000197e0: 682e 6375 6d73 756d 2229 0a64 6566 2063  h.cumsum").def c
-000197f0: 756d 7375 6d5f 6175 675f 6677 6428 613a  umsum_aug_fwd(a:
-00019800: 2050 726f 7879 2c20 6469 6d3a 2069 6e74   Proxy, dim: int
-00019810: 2c20 2a2c 2064 7479 7065 3a20 4e6f 6e65  , *, dtype: None
-00019820: 207c 2064 7479 7065 732e 6474 7970 6520   | dtypes.dtype 
-00019830: 3d20 4e6f 6e65 2920 2d3e 2056 4a50 4475  = None) -> VJPDu
-00019840: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
-00019850: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-00019860: 7420 6375 6d73 756d 0a0a 2020 2020 7072  t cumsum..    pr
-00019870: 696d 616c 203d 2063 756d 7375 6d28 612c  imal = cumsum(a,
-00019880: 2064 696d 2c20 6474 7970 653d 6474 7970   dim, dtype=dtyp
-00019890: 6529 0a20 2020 2072 6573 6964 7561 6c73  e).    residuals
-000198a0: 203d 2028 0a20 2020 2020 2020 2061 2e64   = (.        a.d
-000198b0: 7479 7065 2c0a 2020 2020 2020 2020 6469  type,.        di
-000198c0: 6d2c 0a20 2020 2029 0a20 2020 2072 6574  m,.    ).    ret
-000198d0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-000198e0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-000198f0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00019900: 6172 6428 2274 6f72 6368 2e63 756d 7375  ard("torch.cumsu
-00019910: 6d22 290a 6465 6620 6375 6d73 756d 5f62  m").def cumsum_b
-00019920: 6163 6b77 6172 6428 615f 6474 7970 652c  ackward(a_dtype,
-00019930: 2064 696d 2c20 6729 3a0a 2020 2020 6720   dim, g):.    g 
-00019940: 3d20 672e 746f 2861 5f64 7479 7065 290a  = g.to(a_dtype).
-00019950: 2020 2020 6966 2067 2e6e 756d 656c 203c      if g.numel <
-00019960: 3d20 3120 6f72 2067 2e73 6861 7065 5b64  = 1 or g.shape[d
-00019970: 696d 5d20 3d3d 2031 3a0a 2020 2020 2020  im] == 1:.      
-00019980: 2020 7265 7475 726e 2067 0a20 2020 2072    return g.    r
-00019990: 6574 7572 6e20 672e 666c 6970 2864 696d  eturn g.flip(dim
-000199a0: 292e 6375 6d73 756d 2864 696d 292e 666c  ).cumsum(dim).fl
-000199b0: 6970 2864 696d 290a 0a0a 4072 6567 6973  ip(dim)...@regis
-000199c0: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-000199d0: 7277 6172 6428 2274 6f72 6368 2e73 6f66  rward("torch.sof
-000199e0: 746d 6178 2229 0a64 6566 2073 6f66 746d  tmax").def softm
-000199f0: 6178 5f61 7567 5f66 7764 2861 3a20 5072  ax_aug_fwd(a: Pr
-00019a00: 6f78 792c 2064 696d 3a20 696e 742c 2064  oxy, dim: int, d
-00019a10: 7479 7065 3a20 6474 7970 6573 2e64 7479  type: dtypes.dty
-00019a20: 7065 207c 204e 6f6e 6520 3d20 4e6f 6e65  pe | None = None
-00019a30: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
-00019a40: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00019a50: 6f72 6368 2069 6d70 6f72 7420 736f 6674  orch import soft
-00019a60: 6d61 780a 0a20 2020 2070 7269 6d61 6c20  max..    primal 
-00019a70: 3d20 736f 6674 6d61 7828 612c 2064 696d  = softmax(a, dim
-00019a80: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
-00019a90: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00019aa0: 7072 696d 616c 2c20 6469 6d29 0a20 2020  primal, dim).   
-00019ab0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00019ac0: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00019ad0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-00019ae0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
-00019af0: 6f66 746d 6178 2229 0a64 6566 2073 6f66  oftmax").def sof
-00019b00: 746d 6178 5f62 6163 6b77 6172 6428 7072  tmax_backward(pr
-00019b10: 696d 616c 2c20 6469 6d2c 2067 293a 0a20  imal, dim, g):. 
-00019b20: 2020 2072 6574 7572 6e20 7072 696d 616c     return primal
-00019b30: 202a 2028 6720 2d20 2870 7269 6d61 6c20   * (g - (primal 
-00019b40: 2a20 6729 2e73 756d 2864 696d 2c20 6b65  * g).sum(dim, ke
-00019b50: 6570 6469 6d3d 5472 7565 2929 0a0a 0a64  epdim=True))...d
-00019b60: 6566 2069 7465 725f 626f 756e 645f 7379  ef iter_bound_sy
-00019b70: 6d62 6f6c 7328 626f 756e 645f 7379 6d62  mbols(bound_symb
-00019b80: 6f6c 7329 3a0a 2020 2020 2222 2249 7465  ols):.    """Ite
-00019b90: 7261 7465 206f 7665 7220 626f 756e 6420  rate over bound 
-00019ba0: 7379 6d62 6f6c 732c 2073 6b69 7070 696e  symbols, skippin
-00019bb0: 6720 7379 6d62 6f6c 7320 7468 6174 2061  g symbols that a
-00019bc0: 7265 206e 6f74 2073 7570 706f 7274 6564  re not supported
-00019bd0: 2062 790a 2020 2020 7468 6520 7472 616e   by.    the tran
-00019be0: 7366 6f72 6d73 2069 6e66 7261 7374 7275  sforms infrastru
-00019bf0: 6374 7572 652e 0a0a 2020 2020 4172 6773  cture...    Args
-00019c00: 3a0a 2020 2020 2020 2020 626f 756e 645f  :.        bound_
-00019c10: 7379 6d62 6f6c 7320 284c 6973 745b 426f  symbols (List[Bo
-00019c20: 756e 6453 796d 626f 6c5d 293a 204c 6973  undSymbol]): Lis
-00019c30: 7420 6f66 2062 6f75 6e64 2073 796d 626f  t of bound symbo
-00019c40: 6c73 0a0a 2020 2020 5969 656c 6473 3a0a  ls..    Yields:.
-00019c50: 2020 2020 2020 2020 426f 756e 6453 796d          BoundSym
-00019c60: 626f 6c3a 2042 6f75 6e64 2073 796d 626f  bol: Bound symbo
-00019c70: 6c73 2074 6861 7420 6172 6520 7375 7070  ls that are supp
-00019c80: 6f72 7465 6420 6279 2074 6865 2074 7261  orted by the tra
-00019c90: 6e73 666f 726d 730a 2020 2020 2020 2020  nsforms.        
-00019ca0: 696e 6672 6173 7472 7563 7475 7265 0a20  infrastructure. 
-00019cb0: 2020 2022 2222 0a20 2020 2066 6f72 2073     """.    for s
-00019cc0: 796d 626f 6c20 696e 2062 6f75 6e64 5f73  ymbol in bound_s
-00019cd0: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
-00019ce0: 6966 2073 796d 626f 6c2e 7379 6d2e 6964  if symbol.sym.id
-00019cf0: 2069 6e20 7472 616e 7366 6f72 6d5f 736b   in transform_sk
-00019d00: 6970 5f6c 6973 743a 0a20 2020 2020 2020  ip_list:.       
-00019d10: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00019d20: 2020 2020 2020 656c 6966 2073 796d 626f        elif symbo
-00019d30: 6c2e 6f75 7470 7574 2069 7320 4e6f 6e65  l.output is None
-00019d40: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-00019d50: 6e74 696e 7565 0a20 2020 2020 2020 2065  ntinue.        e
-00019d60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019d70: 2079 6965 6c64 2073 796d 626f 6c0a 0a0a   yield symbol...
-00019d80: 6465 6620 6465 636f 6e73 7472 7563 745f  def deconstruct_
-00019d90: 666f 7277 6172 645f 656e 765f 666f 725f  forward_env_for_
-00019da0: 6261 636b 7761 7264 2874 7261 6365 2c20  backward(trace, 
-00019db0: 656e 7629 3a0a 2020 2020 2320 4e6f 7465  env):.    # Note
-00019dc0: 205b 5361 7669 6e67 2074 6865 2066 6f72   [Saving the for
-00019dd0: 7761 7264 2065 6e76 6972 6f6e 6d65 6e74  ward environment
-00019de0: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
-00019df0: 2072 756c 655d 0a20 2020 2023 2057 6520   rule].    # We 
-00019e00: 6361 6e6e 6f74 2073 6176 6520 7468 6520  cannot save the 
-00019e10: 7472 6163 6520 6f62 6a65 6374 2069 6e20  trace object in 
-00019e20: 7468 6520 7265 7369 6475 616c 7320 6265  the residuals be
-00019e30: 6361 7573 6520 6578 6563 7574 6f72 7320  cause executors 
-00019e40: 6d61 7920 6e6f 740a 2020 2020 2320 6265  may not.    # be
-00019e50: 2061 626c 6520 746f 2072 6574 7572 6e20   able to return 
-00019e60: 6974 2066 6f72 2074 6865 2073 706c 6974  it for the split
-00019e70: 7465 6420 666f 7277 6172 642f 6261 636b  ted forward/back
-00019e80: 7761 7264 2070 6173 7365 732e 2049 6e73  ward passes. Ins
-00019e90: 7465 6164 2c20 7765 0a20 2020 2023 2073  tead, we.    # s
-00019ea0: 6176 6520 6172 6773 2061 6e64 206b 7761  ave args and kwa
-00019eb0: 7267 7320 6f66 2074 6865 206f 7269 6769  rgs of the origi
-00019ec0: 6e61 6c20 6675 6e63 7469 6f6e 2063 616c  nal function cal
-00019ed0: 6c20 616e 6420 7265 636f 6e73 7472 7563  l and reconstruc
-00019ee0: 7420 7468 650a 2020 2020 2320 7472 6163  t the.    # trac
-00019ef0: 6520 6f62 6a65 6374 2061 6e64 2069 7473  e object and its
-00019f00: 2065 6e76 6972 6f6e 6d65 6e74 2064 6963   environment dic
-00019f10: 7420 696e 2074 6865 2062 6163 6b77 6172  t in the backwar
-00019f20: 6420 7275 6c65 2e20 4865 7265 2077 6520  d rule. Here we 
-00019f30: 7265 6c79 0a20 2020 2023 206f 6e20 7468  rely.    # on th
-00019f40: 6520 6661 6374 2074 6861 7420 7468 6520  e fact that the 
-00019f50: 6f72 6465 7220 6f66 2074 6865 2073 796d  order of the sym
-00019f60: 626f 6c73 2069 6e20 7468 6520 7472 6163  bols in the trac
-00019f70: 6520 6973 2064 6574 6572 6d69 6e69 7374  e is determinist
-00019f80: 6963 0a20 2020 2023 2061 6e64 2061 6c77  ic.    # and alw
-00019f90: 6179 7320 7468 6520 7361 6d65 2066 6f72  ays the same for
-00019fa0: 2074 6865 2073 616d 6520 6675 6e63 7469   the same functi
-00019fb0: 6f6e 2063 616c 6c20 616e 6420 7468 6520  on call and the 
-00019fc0: 7361 6d65 2073 6574 206f 660a 2020 2020  same set of.    
-00019fd0: 2320 6172 6775 6d65 6e74 732e 2053 6565  # arguments. See
-00019fe0: 2074 6573 745f 6772 6164 2e70 793a 7465   test_grad.py:te
-00019ff0: 7374 5f74 6f72 6368 5f61 7574 6f67 7261  st_torch_autogra
-0001a000: 645f 6675 6e63 7469 6f6e 2066 6f72 2061  d_function for a
-0001a010: 6e20 6578 616d 706c 650a 2020 2020 2320  n example.    # 
-0001a020: 7768 6572 6520 7468 6973 2069 7320 7465  where this is te
-0001a030: 7374 6564 2e0a 2020 2020 626f 756e 645f  sted..    bound_
-0001a040: 7379 6d62 6f6c 7320 3d20 6974 6572 5f62  symbols = iter_b
-0001a050: 6f75 6e64 5f73 796d 626f 6c73 2874 7261  ound_symbols(tra
-0001a060: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-0001a070: 290a 2020 2020 7361 7665 645f 666f 725f  ).    saved_for_
-0001a080: 6261 636b 7761 7264 203d 2074 7570 6c65  backward = tuple
-0001a090: 2865 6e76 5b73 6571 7565 6e63 6966 7928  (env[sequencify(
-0001a0a0: 7379 6d62 6f6c 2e6f 7574 7075 7429 5b30  symbol.output)[0
-0001a0b0: 5d2e 6e61 6d65 5d2e 7265 7369 6475 616c  ].name].residual
-0001a0c0: 7320 666f 7220 7379 6d62 6f6c 2069 6e20  s for symbol in 
-0001a0d0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
-0001a0e0: 2020 2072 6574 7572 6e20 7361 7665 645f     return saved_
-0001a0f0: 666f 725f 6261 636b 7761 7264 0a0a 0a64  for_backward...d
-0001a100: 6566 2072 6563 6f6e 7374 7275 6374 5f66  ef reconstruct_f
-0001a110: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-0001a120: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
-0001a130: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001a140: 6429 3a0a 2020 2020 626f 756e 645f 7379  d):.    bound_sy
-0001a150: 6d62 6f6c 7320 3d20 6974 6572 5f62 6f75  mbols = iter_bou
-0001a160: 6e64 5f73 796d 626f 6c73 2874 7261 6365  nd_symbols(trace
-0001a170: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
-0001a180: 0a20 2020 2072 6563 6f6e 7374 7275 6374  .    reconstruct
-0001a190: 6564 5f65 6e76 203d 207b 7d0a 0a20 2020  ed_env = {}..   
-0001a1a0: 2066 6f72 2069 6478 2c20 7379 6d20 696e   for idx, sym in
-0001a1b0: 2065 6e75 6d65 7261 7465 2862 6f75 6e64   enumerate(bound
-0001a1c0: 5f73 796d 626f 6c73 293a 0a20 2020 2020  _symbols):.     
-0001a1d0: 2020 206b 203d 2073 6571 7565 6e63 6966     k = sequencif
-0001a1e0: 7928 7379 6d2e 6f75 7470 7574 295b 305d  y(sym.output)[0]
-0001a1f0: 2e6e 616d 650a 2020 2020 2020 2020 7620  .name.        v 
-0001a200: 3d20 564a 5044 7561 6c28 4e6f 6e65 2c20  = VJPDual(None, 
-0001a210: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001a220: 7264 5b69 6478 5d29 0a20 2020 2020 2020  rd[idx]).       
-0001a230: 2072 6563 6f6e 7374 7275 6374 6564 5f65   reconstructed_e
-0001a240: 6e76 5b6b 5d20 3d20 760a 0a20 2020 2072  nv[k] = v..    r
-0001a250: 6574 7572 6e20 7265 636f 6e73 7472 7563  eturn reconstruc
-0001a260: 7465 645f 656e 760a 0a0a 6465 6620 6465  ted_env...def de
-0001a270: 636f 6d70 6f73 6564 5f66 6e5f 6175 675f  composed_fn_aug_
-0001a280: 6677 645f 7275 6c65 282a 6172 6773 2c20  fwd_rule(*args, 
-0001a290: 6465 636f 6d70 6f73 6564 5f66 6e2c 202a  decomposed_fn, *
-0001a2a0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
-0001a2b0: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
-0001a2c0: 7264 2072 756c 6520 666f 7220 636f 6d70  rd rule for comp
-0001a2d0: 6f73 6974 6520 6675 6e63 7469 6f6e 7320  osite functions 
-0001a2e0: 696d 706c 656d 656e 7465 6420 696e 2074  implemented in t
-0001a2f0: 6572 6d73 206f 6620 6f74 6865 7220 6675  erms of other fu
-0001a300: 6e63 7469 6f6e 7320 7468 6174 2061 7265  nctions that are
-0001a310: 0a20 2020 2073 7570 706f 7365 6420 746f  .    supposed to
-0001a320: 2062 6520 7375 7070 6f72 7465 6420 6279   be supported by
-0001a330: 2074 6865 2056 4a50 2069 6e66 7261 7374   the VJP infrast
-0001a340: 7275 6374 7572 652e 0a0a 2020 2020 4172  ructure...    Ar
-0001a350: 6773 3a0a 2020 2020 2020 2020 6465 636f  gs:.        deco
-0001a360: 6d70 6f73 6564 5f66 6e20 2843 616c 6c61  mposed_fn (Calla
-0001a370: 626c 6529 3a20 6465 636f 6d70 6f73 6564  ble): decomposed
-0001a380: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
-0001a390: 6675 6e63 7469 6f6e 0a0a 2020 2020 5265  function..    Re
-0001a3a0: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
-0001a3b0: 616c 6c61 626c 653a 2041 7567 6d65 6e74  allable: Augment
-0001a3c0: 6564 2066 6f72 7761 7264 2072 756c 6520  ed forward rule 
-0001a3d0: 666f 7220 7468 6520 636f 6d70 6f73 6974  for the composit
-0001a3e0: 6520 6675 6e63 7469 6f6e 0a20 2020 2022  e function.    "
-0001a3f0: 2222 0a20 2020 2074 7261 6365 203d 2063  "".    trace = c
-0001a400: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
-0001a410: 2864 6563 6f6d 706f 7365 645f 666e 2c20  (decomposed_fn, 
-0001a420: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0001a430: 0a20 2020 2074 7261 6365 203d 2075 6e77  .    trace = unw
-0001a440: 7261 705f 6f6e 655f 6c65 7665 6c5f 6f66  rap_one_level_of
-0001a450: 5f73 7562 7379 6d62 6f6c 7328 7472 6163  _subsymbols(trac
-0001a460: 6529 0a20 2020 2023 2054 6865 7265 206d  e).    # There m
-0001a470: 6179 2062 6520 6120 6465 6164 206e 6f64  ay be a dead nod
-0001a480: 6520 6c69 6b65 2022 5f20 3d20 7072 696d  e like "_ = prim
-0001a490: 732e 636f 6e76 6572 745f 656c 656d 656e  s.convert_elemen
-0001a4a0: 745f 7479 7065 2830 2c20 666c 6f61 7429  t_type(0, float)
-0001a4b0: 220a 2020 2020 2320 696e 2074 6865 2074  ".    # in the t
-0001a4c0: 7261 6365 2e20 5765 206e 6565 6420 746f  race. We need to
-0001a4d0: 2072 656d 6f76 6520 6974 2062 6566 6f72   remove it befor
-0001a4e0: 6520 7765 2063 616e 2075 7365 2074 6865  e we can use the
-0001a4f0: 2074 7261 6365 2066 6f72 0a20 2020 2023   trace for.    #
-0001a500: 2061 7567 6d65 6e74 6564 5f66 6f72 7761   augmented_forwa
-0001a510: 7264 5f70 6173 732e 0a20 2020 2074 7261  rd_pass..    tra
-0001a520: 6365 203d 2064 6365 2874 7261 6365 290a  ce = dce(trace).
-0001a530: 2020 2020 7265 7375 6c74 2c20 656e 7620      result, env 
-0001a540: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
-0001a550: 6172 645f 7061 7373 282a 6172 6773 2c20  ard_pass(*args, 
-0001a560: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
-0001a570: 7761 7267 7329 0a20 2020 2073 6176 6564  wargs).    saved
-0001a580: 5f66 6f72 5f62 6163 6b77 6172 6420 3d20  _for_backward = 
-0001a590: 6465 636f 6e73 7472 7563 745f 666f 7277  deconstruct_forw
-0001a5a0: 6172 645f 656e 765f 666f 725f 6261 636b  ard_env_for_back
-0001a5b0: 7761 7264 2874 7261 6365 2c20 656e 7629  ward(trace, env)
-0001a5c0: 0a20 2020 2023 2053 7461 7469 6320 6361  .    # Static ca
-0001a5d0: 6368 696e 6720 646f 6573 206e 6f74 2077  ching does not w
-0001a5e0: 6974 6820 7769 7468 206b 7761 7267 7320  ith with kwargs 
-0001a5f0: 6469 6374 732c 2073 6f20 7765 2772 6520  dicts, so we're 
-0001a600: 636f 6e76 6572 7469 6e67 2074 6865 6d0a  converting them.
-0001a610: 2020 2020 2320 746f 204e 6f6e 6520 666f      # to None fo
-0001a620: 7220 6e6f 7720 7768 656e 2070 6f73 7369  r now when possi
-0001a630: 626c 652e 0a20 2020 206b 7761 7267 7320  ble..    kwargs 
-0001a640: 3d20 4e6f 6e65 2069 6620 6e6f 7420 6b77  = None if not kw
-0001a650: 6172 6773 2065 6c73 6520 6b77 6172 6773  args else kwargs
-0001a660: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-0001a670: 2028 6172 6773 2c20 6b77 6172 6773 2c20   (args, kwargs, 
-0001a680: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001a690: 7264 290a 2020 2020 7265 7475 726e 2056  rd).    return V
-0001a6a0: 4a50 4475 616c 2872 6573 756c 742c 2072  JPDual(result, r
-0001a6b0: 6573 6964 7561 6c73 290a 0a0a 6465 6620  esiduals)...def 
-0001a6c0: 6465 636f 6d70 6f73 6564 5f66 6e5f 6261  decomposed_fn_ba
-0001a6d0: 636b 7761 7264 5f72 756c 6528 6465 636f  ckward_rule(deco
-0001a6e0: 6d70 6f73 6564 5f66 6e2c 2061 7267 732c  mposed_fn, args,
-0001a6f0: 206b 7761 7267 732c 2073 6176 6564 5f66   kwargs, saved_f
-0001a700: 6f72 5f62 6163 6b77 6172 642c 202a 6772  or_backward, *gr
-0001a710: 6164 7329 3a0a 2020 2020 6b77 6172 6773  ads):.    kwargs
-0001a720: 203d 207b 7d20 6966 206b 7761 7267 7320   = {} if kwargs 
-0001a730: 6973 204e 6f6e 6520 656c 7365 206b 7761  is None else kwa
-0001a740: 7267 730a 2020 2020 7472 6163 6520 3d20  rgs.    trace = 
-0001a750: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-0001a760: 2928 6465 636f 6d70 6f73 6564 5f66 6e2c  )(decomposed_fn,
-0001a770: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
-0001a780: 290a 2020 2020 7472 6163 6520 3d20 756e  ).    trace = un
-0001a790: 7772 6170 5f6f 6e65 5f6c 6576 656c 5f6f  wrap_one_level_o
-0001a7a0: 665f 7375 6273 796d 626f 6c73 2874 7261  f_subsymbols(tra
-0001a7b0: 6365 290a 2020 2020 7472 6163 6520 3d20  ce).    trace = 
-0001a7c0: 6463 6528 7472 6163 6529 0a20 2020 2023  dce(trace).    #
-0001a7d0: 2062 6f75 6e64 5f73 796d 626f 6c73 203d   bound_symbols =
-0001a7e0: 2069 7465 725f 626f 756e 645f 7379 6d62   iter_bound_symb
-0001a7f0: 6f6c 7328 7472 6163 652e 626f 756e 645f  ols(trace.bound_
-0001a800: 7379 6d62 6f6c 7329 0a20 2020 2023 2072  symbols).    # r
-0001a810: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
-0001a820: 203d 207b 0a20 2020 2023 2020 2020 2073   = {.    #     s
-0001a830: 6571 7565 6e63 6966 7928 7379 6d62 6f6c  equencify(symbol
-0001a840: 2e6f 7574 7075 7429 5b30 5d2e 6e61 6d65  .output)[0].name
-0001a850: 3a20 564a 5044 7561 6c28 4e6f 6e65 2c20  : VJPDual(None, 
-0001a860: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001a870: 7264 5b69 5d29 0a20 2020 2023 2020 2020  rd[i]).    #    
-0001a880: 2066 6f72 2069 2c20 7379 6d62 6f6c 2069   for i, symbol i
-0001a890: 6e20 656e 756d 6572 6174 6528 626f 756e  n enumerate(boun
-0001a8a0: 645f 7379 6d62 6f6c 7329 0a20 2020 2023  d_symbols).    #
-0001a8b0: 207d 0a20 2020 2072 6563 6f6e 7374 7275   }.    reconstru
-0001a8c0: 6374 6564 5f65 6e76 203d 2072 6563 6f6e  cted_env = recon
-0001a8d0: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
-0001a8e0: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
-0001a8f0: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
-0001a900: 5f62 6163 6b77 6172 6429 0a20 2020 2072  _backward).    r
-0001a910: 6573 756c 7420 3d20 6261 636b 7761 7264  esult = backward
-0001a920: 5f70 6173 7328 7265 636f 6e73 7472 7563  _pass(reconstruc
-0001a930: 7465 645f 656e 762c 2074 7261 6365 2c20  ted_env, trace, 
-0001a940: 6772 6164 7329 0a20 2020 2069 6620 6c65  grads).    if le
-0001a950: 6e28 6172 6773 2920 3d3d 2031 3a0a 2020  n(args) == 1:.  
-0001a960: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0001a970: 756c 745b 305d 0a20 2020 2023 2042 6163  ult[0].    # Bac
-0001a980: 6b77 6172 6420 7061 7373 206d 6967 6874  kward pass might
-0001a990: 2072 6574 7572 6e20 6120 6469 6374 2077   return a dict w
-0001a9a0: 6974 6820 6772 6164 7320 6275 7420 6375  ith grads but cu
-0001a9b0: 7272 656e 7420 696e 7465 7266 6163 6520  rrent interface 
-0001a9c0: 6f66 0a20 2020 2023 2062 6163 6b77 6172  of.    # backwar
-0001a9d0: 6420 7275 6c65 2064 6f65 7320 6e6f 7420  d rule does not 
-0001a9e0: 7375 7070 6f72 7420 6974 2e20 536f 2077  support it. So w
-0001a9f0: 6520 6a75 7374 2064 726f 7020 6974 2066  e just drop it f
-0001aa00: 6f72 206e 6f77 2e0a 2020 2020 656c 6966  or now..    elif
-0001aa10: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-0001aa20: 6c74 5b2d 315d 2c20 6469 6374 293a 0a20  lt[-1], dict):. 
-0001aa30: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0001aa40: 7375 6c74 5b3a 2d31 5d0a 2020 2020 7265  sult[:-1].    re
-0001aa50: 7475 726e 2072 6573 756c 740a 0a0a 4072  turn result...@r
-0001aa60: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
-0001aa70: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
-0001aa80: 2e54 656e 736f 722e 636f 6e74 6967 756f  .Tensor.contiguo
-0001aa90: 7573 2229 0a40 7265 6769 7374 6572 5f61  us").@register_a
-0001aaa0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-0001aab0: 2822 746f 7263 682e 636f 6e74 6967 756f  ("torch.contiguo
-0001aac0: 7573 2229 0a64 6566 2063 6f6e 7469 6775  us").def contigu
-0001aad0: 6f75 735f 6175 675f 6677 6428 783a 2054  ous_aug_fwd(x: T
-0001aae0: 656e 736f 7250 726f 7879 2c20 2f2c 202a  ensorProxy, /, *
-0001aaf0: 2c20 6d65 6d6f 7279 5f66 6f72 6d61 743a  , memory_format:
-0001ab00: 2074 6f72 6368 2e6d 656d 6f72 795f 666f   torch.memory_fo
-0001ab10: 726d 6174 203d 2074 6f72 6368 2e63 6f6e  rmat = torch.con
-0001ab20: 7469 6775 6f75 735f 666f 726d 6174 2920  tiguous_format) 
-0001ab30: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-0001ab40: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-0001ab50: 6368 2069 6d70 6f72 7420 636f 6e74 6967  ch import contig
-0001ab60: 756f 7573 0a0a 2020 2020 7265 7475 726e  uous..    return
-0001ab70: 2056 4a50 4475 616c 2863 6f6e 7469 6775   VJPDual(contigu
-0001ab80: 6f75 7328 782c 206d 656d 6f72 795f 666f  ous(x, memory_fo
-0001ab90: 726d 6174 3d6d 656d 6f72 795f 666f 726d  rmat=memory_form
-0001aba0: 6174 292c 2074 7570 6c65 2829 290a 0a0a  at), tuple())...
-0001abb0: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-0001abc0: 7264 2822 746f 7263 682e 5465 6e73 6f72  rd("torch.Tensor
-0001abd0: 2e63 6f6e 7469 6775 6f75 7322 290a 4072  .contiguous").@r
-0001abe0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-0001abf0: 2822 746f 7263 682e 636f 6e74 6967 756f  ("torch.contiguo
-0001ac00: 7573 2229 0a64 6566 2063 6f6e 7469 6775  us").def contigu
-0001ac10: 6f75 735f 6261 636b 7761 7264 282a 7265  ous_backward(*re
-0001ac20: 7369 6475 616c 735f 616e 645f 6772 6164  siduals_and_grad
-0001ac30: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-0001ac40: 3a0a 2020 2020 2320 5265 7369 6475 616c  :.    # Residual
-0001ac50: 7320 6973 206e 6f74 2065 6d70 7479 2062  s is not empty b
-0001ac60: 6563 6175 7365 2063 6f6e 7469 6775 6f75  ecause contiguou
-0001ac70: 7320 7379 6d62 6f6c 2068 6173 2074 6865  s symbol has the
-0001ac80: 2073 616d 6520 6f75 7470 7574 2061 7320   same output as 
-0001ac90: 6974 7320 696e 7075 740a 2020 2020 6720  its input.    g 
-0001aca0: 3d20 7265 7369 6475 616c 735f 616e 645f  = residuals_and_
-0001acb0: 6772 6164 5b2d 315d 0a20 2020 2072 6574  grad[-1].    ret
-0001acc0: 7572 6e20 670a 0a0a 6465 6620 7265 6369  urn g...def reci
-0001acd0: 7072 6f63 616c 5f61 7567 5f66 7764 2861  procal_aug_fwd(a
-0001ace0: 3a20 5465 6e73 6f72 5072 6f78 7929 202d  : TensorProxy) -
-0001acf0: 3e20 564a 5044 7561 6c3a 0a20 2020 2070  > VJPDual:.    p
-0001ad00: 7269 6d61 6c20 3d20 7265 6369 7072 6f63  rimal = reciproc
-0001ad10: 616c 2861 290a 2020 2020 7265 7475 726e  al(a).    return
-0001ad20: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-0001ad30: 2028 7072 696d 616c 2c29 290a 0a0a 6465   (primal,))...de
-0001ad40: 6620 7265 6369 7072 6f63 616c 5f62 6163  f reciprocal_bac
-0001ad50: 6b77 6172 6428 7072 696d 616c 2c20 6729  kward(primal, g)
-0001ad60: 3a0a 2020 2020 7265 7475 726e 202d 6720  :.    return -g 
-0001ad70: 2a20 7072 696d 616c 202a 2070 7269 6d61  * primal * prima
-0001ad80: 6c0a 0a0a 4070 6172 7469 616c 2872 6567  l...@partial(reg
-0001ad90: 6973 7465 725f 6772 6164 2c20 7072 696d  ister_grad, prim
-0001ada0: 732e 5072 696d 4944 732e 5245 4349 5052  s.PrimIDs.RECIPR
-0001adb0: 4f43 414c 290a 6465 6620 7265 6369 7072  OCAL).def recipr
-0001adc0: 6f63 616c 5f6a 6f69 6e74 5f66 6f72 7761  ocal_joint_forwa
-0001add0: 7264 5f62 6163 6b77 6172 645f 7275 6c65  rd_backward_rule
-0001ade0: 2861 3a20 5465 6e73 6f72 5072 6f78 7929  (a: TensorProxy)
-0001adf0: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
-0001ae00: 0a20 2020 2072 6573 756c 742c 2073 6176  .    result, sav
-0001ae10: 6564 203d 2072 6563 6970 726f 6361 6c5f  ed = reciprocal_
-0001ae20: 6175 675f 6677 6428 6129 0a20 2020 2067  aug_fwd(a).    g
-0001ae30: 203d 2067 6574 5f67 7261 6428 7265 7375   = get_grad(resu
-0001ae40: 6c74 290a 2020 2020 6761 203d 2072 6563  lt).    ga = rec
-0001ae50: 6970 726f 6361 6c5f 6261 636b 7761 7264  iprocal_backward
-0001ae60: 282a 7361 7665 642c 2067 290a 2020 2020  (*saved, g).    
-0001ae70: 7075 745f 6772 6164 2861 2c20 6761 290a  put_grad(a, ga).
-0001ae80: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0001ae90: 740a 0a0a 4072 6567 6973 7465 725f 6175  t...@register_au
-0001aea0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-0001aeb0: 2274 6f72 6368 2e69 6e64 6578 5f70 7574  "torch.index_put
-0001aec0: 2229 0a64 6566 2069 6e64 6578 5f70 7574  ").def index_put
-0001aed0: 5f61 7567 5f66 7764 280a 2020 2020 613a  _aug_fwd(.    a:
-0001aee0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
-0001aef0: 2069 6e64 6963 6573 3a20 5365 7175 656e   indices: Sequen
-0001af00: 6365 5b54 656e 736f 7250 726f 7879 5d2c  ce[TensorProxy],
-0001af10: 2076 616c 7565 733a 2054 656e 736f 7250   values: TensorP
-0001af20: 726f 7879 2c20 6163 6375 6d75 6c61 7465  roxy, accumulate
-0001af30: 3a20 626f 6f6c 203d 2046 616c 7365 0a29  : bool = False.)
-0001af40: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
-0001af50: 2070 7269 6d61 6c20 3d20 636c 616e 672e   primal = clang.
-0001af60: 696e 6465 785f 7075 7428 612c 2069 6e64  index_put(a, ind
-0001af70: 6963 6573 2c20 7661 6c75 6573 2c20 6163  ices, values, ac
-0001af80: 6375 6d75 6c61 7465 290a 2020 2020 7265  cumulate).    re
-0001af90: 7369 6475 616c 7320 3d20 280a 2020 2020  siduals = (.    
-0001afa0: 2020 2020 696e 6469 6365 732c 0a20 2020      indices,.   
-0001afb0: 2020 2020 2076 616c 7565 732c 0a20 2020       values,.   
-0001afc0: 2020 2020 2061 6363 756d 756c 6174 652c       accumulate,
-0001afd0: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-0001afe0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-0001aff0: 2c20 7265 7369 6475 616c 7329 0a0a 0a64  , residuals)...d
-0001b000: 6566 2073 756d 5f74 6f28 613a 2054 656e  ef sum_to(a: Ten
-0001b010: 736f 7250 726f 7879 2c20 7368 6170 653a  sorProxy, shape:
-0001b020: 2053 6571 7565 6e63 655b 696e 745d 2920   Sequence[int]) 
-0001b030: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-0001b040: 2020 2020 6966 206e 6f74 2073 6861 7065      if not shape
-0001b050: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001b060: 2061 2e73 756d 2829 0a20 2020 206c 6561   a.sum().    lea
-0001b070: 6469 6e67 5f64 696d 7320 3d20 612e 6e64  ding_dims = a.nd
-0001b080: 696d 202d 206c 656e 2873 6861 7065 290a  im - len(shape).
-0001b090: 2020 2020 7265 6475 6365 5f64 696d 7320      reduce_dims 
-0001b0a0: 3d20 7475 706c 6528 7261 6e67 6528 6c65  = tuple(range(le
-0001b0b0: 6164 696e 675f 6469 6d73 2929 202b 2074  ading_dims)) + t
-0001b0c0: 7570 6c65 280a 2020 2020 2020 2020 6920  uple(.        i 
-0001b0d0: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-0001b0e0: 6561 6469 6e67 5f64 696d 732c 2061 2e6e  eading_dims, a.n
-0001b0f0: 6469 6d29 2069 6620 7368 6170 655b 6920  dim) if shape[i 
-0001b100: 2d20 6c65 6164 696e 675f 6469 6d73 5d20  - leading_dims] 
-0001b110: 3d3d 2031 2061 6e64 2061 2e73 6861 7065  == 1 and a.shape
-0001b120: 5b69 5d20 213d 2031 0a20 2020 2029 0a20  [i] != 1.    ). 
-0001b130: 2020 2061 203d 206c 746f 7263 682e 7375     a = ltorch.su
-0001b140: 6d28 612c 2064 696d 3d72 6564 7563 655f  m(a, dim=reduce_
-0001b150: 6469 6d73 2c20 6b65 6570 6469 6d3d 5472  dims, keepdim=Tr
-0001b160: 7565 290a 2020 2020 6966 206c 6561 6469  ue).    if leadi
-0001b170: 6e67 5f64 696d 7320 3e20 303a 0a20 2020  ng_dims > 0:.   
-0001b180: 2020 2020 2072 6574 7572 6e20 6c74 6f72       return ltor
-0001b190: 6368 2e76 6965 7728 612c 2073 6861 7065  ch.view(a, shape
-0001b1a0: 290a 2020 2020 7265 7475 726e 2061 0a0a  ).    return a..
-0001b1b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-0001b1c0: 6172 6428 2274 6f72 6368 2e69 6e64 6578  ard("torch.index
-0001b1d0: 5f70 7574 2229 0a64 6566 2069 6e64 6578  _put").def index
-0001b1e0: 5f70 7574 5f62 6163 6b77 6172 6428 696e  _put_backward(in
-0001b1f0: 6469 6365 733a 2053 6571 7565 6e63 655b  dices: Sequence[
-0001b200: 5465 6e73 6f72 5072 6f78 795d 2c20 7661  TensorProxy], va
-0001b210: 6c75 6573 3a20 5465 6e73 6f72 5072 6f78  lues: TensorProx
-0001b220: 792c 2061 6363 756d 756c 6174 653a 2062  y, accumulate: b
-0001b230: 6f6f 6c2c 2067 3a20 5465 6e73 6f72 5072  ool, g: TensorPr
-0001b240: 6f78 7929 3a0a 2020 2020 675f 7661 6c75  oxy):.    g_valu
-0001b250: 6573 203d 2067 5b69 6e64 6963 6573 5d0a  es = g[indices].
-0001b260: 2020 2020 2320 746f 7263 6820 6861 7320      # torch has 
-0001b270: 6578 7472 6120 6c6f 6769 6320 746f 2068  extra logic to h
-0001b280: 616e 646c 6520 7468 6520 6578 7061 6e64  andle the expand
-0001b290: 6564 2076 616c 7565 730a 2020 2020 6966  ed values.    if
-0001b2a0: 206e 6f74 2075 7469 6c73 2e73 616d 655f   not utils.same_
-0001b2b0: 7368 6170 6528 675f 7661 6c75 6573 2e73  shape(g_values.s
-0001b2c0: 6861 7065 2c20 7661 6c75 6573 2e73 6861  hape, values.sha
-0001b2d0: 7065 293a 0a20 2020 2020 2020 2069 6620  pe):.        if 
-0001b2e0: 636c 616e 672e 636f 6d70 7574 655f 6272  clang.compute_br
-0001b2f0: 6f61 6463 6173 745f 7368 6170 6528 675f  oadcast_shape(g_
-0001b300: 7661 6c75 6573 2e73 6861 7065 2c20 7661  values.shape, va
-0001b310: 6c75 6573 2e73 6861 7065 293a 0a20 2020  lues.shape):.   
-0001b320: 2020 2020 2020 2020 2067 5f76 616c 7565           g_value
-0001b330: 7320 3d20 7375 6d5f 746f 2867 5f76 616c  s = sum_to(g_val
-0001b340: 7565 732c 2076 616c 7565 732e 7368 6170  ues, values.shap
-0001b350: 6529 0a20 2020 2069 6620 6163 6375 6d75  e).    if accumu
-0001b360: 6c61 7465 3a0a 2020 2020 2020 2020 7265  late:.        re
-0001b370: 7475 726e 2067 2c20 675f 7661 6c75 6573  turn g, g_values
-0001b380: 0a20 2020 2072 6574 7572 6e20 636c 616e  .    return clan
-0001b390: 672e 696e 6465 785f 7075 7428 672c 2069  g.index_put(g, i
-0001b3a0: 6e64 6963 6573 2c20 6c74 6f72 6368 2e7a  ndices, ltorch.z
-0001b3b0: 6572 6f73 5f6c 696b 6528 7661 6c75 6573  eros_like(values
-0001b3c0: 292c 2046 616c 7365 292c 2067 5f76 616c  ), False), g_val
-0001b3d0: 7565 730a 0a0a 6465 6620 756e 6966 6f72  ues...def unifor
-0001b3e0: 6d5f 6175 675f 6677 6428 7368 6170 652c  m_aug_fwd(shape,
-0001b3f0: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
-0001b400: 202a 2c20 6465 7669 6365 2c20 6474 7970   *, device, dtyp
-0001b410: 6529 3a0a 2020 2020 7072 696d 616c 203d  e):.    primal =
-0001b420: 2070 7269 6d73 2e75 6e69 666f 726d 2873   prims.uniform(s
-0001b430: 6861 7065 2c20 6d69 6e76 616c 2c20 6d61  hape, minval, ma
-0001b440: 7876 616c 2c20 6465 7669 6365 3d64 6576  xval, device=dev
-0001b450: 6963 652c 2064 7479 7065 3d64 7479 7065  ice, dtype=dtype
-0001b460: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-0001b470: 4475 616c 2870 7269 6d61 6c2c 2028 7072  Dual(primal, (pr
-0001b480: 696d 616c 2c20 6d69 6e76 616c 2c20 6d61  imal, minval, ma
-0001b490: 7876 616c 2929 0a0a 0a64 6566 2075 6e69  xval))...def uni
-0001b4a0: 666f 726d 5f62 6163 6b77 6172 6428 7072  form_backward(pr
-0001b4b0: 696d 616c 2c20 6d69 6e76 616c 2c20 6d61  imal, minval, ma
-0001b4c0: 7876 616c 2c20 6729 3a0a 2020 2020 2320  xval, g):.    # 
-0001b4d0: 756e 6966 6f72 6d20 6973 2069 6d70 6c65  uniform is imple
-0001b4e0: 6d65 6e74 6564 2061 7320 286d 6178 7661  mented as (maxva
-0001b4f0: 6c20 2d20 6d69 6e76 616c 2920 2a20 756e  l - minval) * un
-0001b500: 6966 6f72 6d28 7368 6170 652c 2030 2c20  iform(shape, 0, 
-0001b510: 3129 202b 206d 696e 7661 6c0a 2020 2020  1) + minval.    
-0001b520: 756e 7363 616c 6564 5f70 7269 6d61 6c20  unscaled_primal 
-0001b530: 3d20 2870 7269 6d61 6c20 2d20 6d69 6e76  = (primal - minv
-0001b540: 616c 2920 2f20 286d 6178 7661 6c20 2d20  al) / (maxval - 
-0001b550: 6d69 6e76 616c 290a 2020 2020 7265 6475  minval).    redu
-0001b560: 6365 5f61 6c6c 5f64 696d 7320 3d20 7475  ce_all_dims = tu
-0001b570: 706c 6528 7261 6e67 6528 672e 6e64 696d  ple(range(g.ndim
-0001b580: 2929 0a20 2020 2073 756d 203d 2070 6172  )).    sum = par
-0001b590: 7469 616c 2870 7269 6d73 2e73 756d 2c20  tial(prims.sum, 
-0001b5a0: 6469 6d73 3d72 6564 7563 655f 616c 6c5f  dims=reduce_all_
-0001b5b0: 6469 6d73 290a 2020 2020 7265 7475 726e  dims).    return
-0001b5c0: 204e 6f6e 652c 2073 756d 2867 202a 2028   None, sum(g * (
-0001b5d0: 3120 2d20 756e 7363 616c 6564 5f70 7269  1 - unscaled_pri
-0001b5e0: 6d61 6c29 292c 2073 756d 2867 202a 2075  mal)), sum(g * u
-0001b5f0: 6e73 6361 6c65 645f 7072 696d 616c 290a  nscaled_primal).
-0001b600: 0a0a 6e6f 6e64 6966 6665 7265 6e74 6961  ..nondifferentia
-0001b610: 626c 655f 766a 705f 7379 6d62 6f6c 7320  ble_vjp_symbols 
-0001b620: 3d20 2870 7269 6d73 2e50 7269 6d49 4473  = (prims.PrimIDs
-0001b630: 2e42 4954 5749 5345 5f41 4e44 2c20 7072  .BITWISE_AND, pr
-0001b640: 696d 732e 5072 696d 4944 732e 5349 474e  ims.PrimIDs.SIGN
-0001b650: 4249 542c 2070 7269 6d73 2e50 7269 6d49  BIT, prims.PrimI
-0001b660: 4473 2e46 554c 4c29 0a0a 0a64 6566 2069  Ds.FULL)...def i
-0001b670: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
-0001b680: 6a70 2873 796d 626f 6c3a 2070 7269 6d73  jp(symbol: prims
-0001b690: 2e53 796d 626f 6c29 202d 3e20 626f 6f6c  .Symbol) -> bool
-0001b6a0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
-0001b6b0: 6620 6120 7379 6d62 6f6c 2069 7320 636f  f a symbol is co
-0001b6c0: 6e73 7461 6e74 2066 6f72 2074 6865 2056  nstant for the V
-0001b6d0: 4a50 2074 7261 6e73 666f 726d 2e0a 0a20  JP transform... 
-0001b6e0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001b6f0: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
-0001b700: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
-0001b710: 6f20 6368 6563 6b2e 0a0a 2020 2020 5265  o check...    Re
-0001b720: 7475 726e 733a 0a20 2020 2020 2020 2062  turns:.        b
-0001b730: 6f6f 6c3a 2054 7275 6520 6966 2074 6865  ool: True if the
-0001b740: 2073 796d 626f 6c20 6973 2063 6f6e 7374   symbol is const
-0001b750: 616e 742c 2046 616c 7365 206f 7468 6572  ant, False other
-0001b760: 7769 7365 2e0a 2020 2020 2222 220a 2020  wise..    """.  
-0001b770: 2020 6172 655f 616c 6c5f 6172 6773 5f6e    are_all_args_n
-0001b780: 6f6e 5f64 6966 6665 7265 6e74 6961 626c  on_differentiabl
-0001b790: 6520 3d20 6e6f 7420 616e 7928 6973 696e  e = not any(isin
-0001b7a0: 7374 616e 6365 2861 7267 2c20 2846 6c6f  stance(arg, (Flo
-0001b7b0: 6174 5072 6f78 792c 2054 656e 736f 7250  atProxy, TensorP
-0001b7c0: 726f 7879 2929 2066 6f72 2061 7267 2069  roxy)) for arg i
-0001b7d0: 6e20 7379 6d62 6f6c 2e66 6c61 745f 6172  n symbol.flat_ar
-0001b7e0: 6773 290a 2020 2020 7265 7475 726e 2028  gs).    return (
-0001b7f0: 0a20 2020 2020 2020 2061 7265 5f61 6c6c  .        are_all
-0001b800: 5f61 7267 735f 6e6f 6e5f 6469 6666 6572  _args_non_differ
-0001b810: 656e 7469 6162 6c65 0a20 2020 2020 2020  entiable.       
-0001b820: 206f 7220 7379 6d62 6f6c 2e61 7265 5f61   or symbol.are_a
-0001b830: 6c6c 5f61 7267 735f 636f 6e73 7461 6e74  ll_args_constant
-0001b840: 0a20 2020 2020 2020 206f 7220 7379 6d62  .        or symb
-0001b850: 6f6c 2e73 796d 2e69 6420 696e 206e 6f6e  ol.sym.id in non
-0001b860: 6469 6666 6572 656e 7469 6162 6c65 5f76  differentiable_v
-0001b870: 6a70 5f73 796d 626f 6c73 0a20 2020 2029  jp_symbols.    )
-0001b880: 0a0a 0a64 6566 2076 6a70 5f73 796d 626f  ...def vjp_symbo
-0001b890: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
-0001b8a0: 2070 7269 6d73 2e53 796d 626f 6c2c 202a   prims.Symbol, *
-0001b8b0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0001b8c0: 0a20 2020 2022 2222 5379 6d62 6f6c 206d  .    """Symbol m
-0001b8d0: 6170 7065 7220 666f 7220 7468 6520 564a  apper for the VJ
-0001b8e0: 5020 7472 616e 7366 6f72 6d2e 0a0a 2020  P transform...  
-0001b8f0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001b900: 7379 6d62 6f6c 2028 7072 696d 732e 5379  symbol (prims.Sy
-0001b910: 6d62 6f6c 293a 2053 796d 626f 6c20 746f  mbol): Symbol to
-0001b920: 2062 6520 6d61 7070 6564 2e0a 2020 2020   be mapped..    
-0001b930: 2020 2020 6172 6773 2028 5475 706c 655b      args (Tuple[
-0001b940: 5661 7269 6162 6c65 5d29 3a20 4172 6775  Variable]): Argu
-0001b950: 6d65 6e74 7320 746f 2074 6865 2073 796d  ments to the sym
-0001b960: 626f 6c2e 0a20 2020 2020 2020 206b 7761  bol..        kwa
-0001b970: 7267 7320 2844 6963 745b 7374 722c 2056  rgs (Dict[str, V
-0001b980: 6172 6961 626c 655d 293a 204b 6579 776f  ariable]): Keywo
-0001b990: 7264 2061 7267 756d 656e 7473 2074 6f20  rd arguments to 
-0001b9a0: 7468 6520 7379 6d62 6f6c 2e0a 0a20 2020  the symbol...   
-0001b9b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001b9c0: 2020 4361 6c6c 6162 6c65 3a20 4120 6675    Callable: A fu
-0001b9d0: 6e63 7469 6f6e 2074 6861 7420 636f 6d70  nction that comp
-0001b9e0: 7574 6573 2074 6865 2056 4a50 206f 6620  utes the VJP of 
-0001b9f0: 7468 6520 7379 6d62 6f6c 2e0a 2020 2020  the symbol..    
-0001ba00: 2222 220a 2020 2020 2320 436f 6e73 7461  """.    # Consta
-0001ba10: 6e74 2063 6173 650a 2020 2020 6966 2069  nt case.    if i
-0001ba20: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
-0001ba30: 6a70 2873 796d 626f 6c29 3a0a 0a20 2020  jp(symbol):..   
-0001ba40: 2020 2020 2064 6566 2076 6a70 5f69 6d70       def vjp_imp
-0001ba50: 6c5f 636f 6e73 7428 7379 6d62 6f6c 2c20  l_const(symbol, 
-0001ba60: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0001ba70: 3a0a 2020 2020 2020 2020 2020 2020 6172  :.            ar
-0001ba80: 6773 2c20 6b77 6172 6773 203d 2074 7265  gs, kwargs = tre
-0001ba90: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
-0001baa0: 782e 7072 696d 616c 2069 6620 6973 696e  x.primal if isin
-0001bab0: 7374 616e 6365 2878 2c20 564a 5044 7561  stance(x, VJPDua
-0001bac0: 6c29 2065 6c73 6520 782c 2028 6172 6773  l) else x, (args
-0001bad0: 2c20 6b77 6172 6773 2929 0a20 2020 2020  , kwargs)).     
-0001bae0: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
-0001baf0: 2073 796d 626f 6c5f 746f 5f65 7661 6c28   symbol_to_eval(
-0001bb00: 7379 6d62 6f6c 2928 2a61 7267 732c 202a  symbol)(*args, *
-0001bb10: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-0001bb20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001bb30: 6365 2870 7269 6d61 6c73 2c20 5365 7175  ce(primals, Sequ
-0001bb40: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0001bb50: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
-0001bb60: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-0001bb70: 2056 4a50 4475 616c 2878 2c20 7475 706c   VJPDual(x, tupl
-0001bb80: 6528 2929 2c20 7072 696d 616c 7329 0a20  e()), primals). 
-0001bb90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001bba0: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
-0001bbb0: 732c 2074 7570 6c65 2829 290a 0a20 2020  s, tuple())..   
-0001bbc0: 2020 2020 2072 6574 7572 6e20 7061 7274       return part
-0001bbd0: 6961 6c28 766a 705f 696d 706c 5f63 6f6e  ial(vjp_impl_con
-0001bbe0: 7374 2c20 7379 6d62 6f6c 290a 0a20 2020  st, symbol)..   
-0001bbf0: 2023 204e 6f72 6d61 6c20 6361 7365 2c20   # Normal case, 
-0001bc00: 7765 2068 6176 6520 6120 7072 6f78 7920  we have a proxy 
-0001bc10: 7461 6e67 656e 740a 2020 2020 766a 705f  tangent.    vjp_
-0001bc20: 696d 706c 203d 2061 7567 6d65 6e74 6564  impl = augmented
-0001bc30: 5f66 6f72 7761 7264 5f69 6d70 6c73 2e67  _forward_impls.g
-0001bc40: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
-0001bc50: 290a 0a20 2020 2069 6620 5f67 6574 5f67  )..    if _get_g
-0001bc60: 7261 6466 6e28 7379 6d62 6f6c 2920 6973  radfn(symbol) is
-0001bc70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0001bc80: 2020 2076 6a70 5f69 6d70 6c2c 2062 6163     vjp_impl, bac
-0001bc90: 6b77 6172 645f 666e 203d 206d 616b 655f  kward_fn = make_
-0001bca0: 6175 675f 666f 7277 6172 645f 616e 645f  aug_forward_and_
-0001bcb0: 6261 636b 7761 7264 2873 796d 626f 6c29  backward(symbol)
-0001bcc0: 0a0a 2020 2020 6966 2076 6a70 5f69 6d70  ..    if vjp_imp
-0001bcd0: 6c20 6973 204e 6f6e 653a 0a20 2020 2020  l is None:.     
-0001bce0: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
-0001bcf0: 7420 6669 6e64 2061 2056 4a50 2066 6f72  t find a VJP for
-0001bd00: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
-0001bd10: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
-0001bd20: 706f 7365 2069 740a 2020 2020 2020 2020  pose it.        
-0001bd30: 6966 206c 656e 2873 796d 626f 6c2e 7375  if len(symbol.su
-0001bd40: 6273 796d 626f 6c73 2920 3e20 3020 616e  bsymbols) > 0 an
-0001bd50: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
-0001bd60: 2873 796d 626f 6c2e 7379 6d2e 6964 2c20  (symbol.sym.id, 
-0001bd70: 7072 696d 732e 5072 696d 4944 7329 3a0a  prims.PrimIDs):.
-0001bd80: 2020 2020 2020 2020 2020 2020 766a 705f              vjp_
-0001bd90: 696d 706c 203d 2070 6172 7469 616c 2864  impl = partial(d
-0001bda0: 6563 6f6d 706f 7365 645f 666e 5f61 7567  ecomposed_fn_aug
-0001bdb0: 5f66 7764 5f72 756c 652c 2064 6563 6f6d  _fwd_rule, decom
-0001bdc0: 706f 7365 645f 666e 3d73 796d 626f 6c2e  posed_fn=symbol.
-0001bdd0: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
-0001bde0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0001bdf0: 2057 6520 636f 756c 6420 6e6f 7420 6669   We could not fi
-0001be00: 6e64 2061 2056 4a50 2066 6f72 2074 6869  nd a VJP for thi
-0001be10: 7320 7379 6d62 6f6c 2061 6e64 2077 6520  s symbol and we 
-0001be20: 636f 756c 6420 6e6f 7420 6465 636f 6d70  could not decomp
-0001be30: 6f73 6520 6974 0a20 2020 2020 2020 2020  ose it.         
-0001be40: 2020 2023 2049 7420 636f 756c 6420 6265     # It could be
-0001be50: 2061 2074 6f72 6368 2e64 726f 706f 7574   a torch.dropout
-0001be60: 2077 6974 6820 302e 3020 7072 6f62 6162   with 0.0 probab
-0001be70: 696c 6974 792c 2073 6f20 7765 2073 6b69  ility, so we ski
-0001be80: 7020 6974 0a20 2020 2020 2020 2020 2020  p it.           
-0001be90: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
-0001bea0: 6420 3d3d 2022 746f 7263 682e 6e6e 2e66  d == "torch.nn.f
-0001beb0: 756e 6374 696f 6e61 6c2e 6472 6f70 6f75  unctional.dropou
-0001bec0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-0001bed0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-0001bee0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001bef0: 7428 6622 564a 5020 666f 7220 7b73 796d  t(f"VJP for {sym
-0001bf00: 626f 6c7d 2069 7320 6e6f 7420 696d 706c  bol} is not impl
-0001bf10: 656d 656e 7465 6422 290a 2020 2020 2020  emented").      
-0001bf20: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0001bf30: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0001bf40: 6622 564a 5020 666f 7220 7b73 796d 626f  f"VJP for {symbo
-0001bf50: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
-0001bf60: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
-0001bf70: 2020 2020 6465 6620 5f76 6a70 5f69 6d70      def _vjp_imp
-0001bf80: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-0001bf90: 7329 3a0a 2020 2020 2020 2020 7072 696d  s):.        prim
-0001bfa0: 616c 732c 206b 7761 7267 7320 3d20 7472  als, kwargs = tr
-0001bfb0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-0001bfc0: 2078 2e70 7269 6d61 6c20 6966 2069 7369   x.primal if isi
-0001bfd0: 6e73 7461 6e63 6528 782c 2056 4a50 4475  nstance(x, VJPDu
-0001bfe0: 616c 2920 656c 7365 2078 2c20 2861 7267  al) else x, (arg
-0001bff0: 732c 206b 7761 7267 7329 290a 2020 2020  s, kwargs)).    
-0001c000: 2020 2020 6f75 745f 7072 696d 616c 2c20      out_primal, 
-0001c010: 6f75 745f 7265 7369 6475 616c 7320 3d20  out_residuals = 
-0001c020: 766a 705f 696d 706c 282a 7072 696d 616c  vjp_impl(*primal
-0001c030: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
-0001c040: 2020 2020 2020 2320 5765 2061 7265 2073        # We are s
-0001c050: 6176 696e 6720 7468 6520 7265 7369 6475  aving the residu
-0001c060: 616c 7320 616e 6420 7075 6c6c 6261 636b  als and pullback
-0001c070: 206f 6e6c 7920 696e 2074 6865 2066 6972   only in the fir
-0001c080: 7374 206f 7574 7075 740a 2020 2020 2020  st output.      
-0001c090: 2020 2320 6261 636b 7761 7264 5f70 6173    # backward_pas
-0001c0a0: 7320 7468 656e 2072 6574 7269 6576 6573  s then retrieves
-0001c0b0: 2074 6865 2072 6573 6964 7561 6c73 2061   the residuals a
-0001c0c0: 6e64 2070 756c 6c62 6163 6b20 6672 6f6d  nd pullback from
-0001c0d0: 2074 6865 2066 6972 7374 206f 7574 7075   the first outpu
-0001c0e0: 740a 2020 2020 2020 2020 6966 2069 7369  t.        if isi
-0001c0f0: 6e73 7461 6e63 6528 6f75 745f 7072 696d  nstance(out_prim
-0001c100: 616c 2c20 5365 7175 656e 6365 293a 0a20  al, Sequence):. 
-0001c110: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001c120: 6e20 2856 4a50 4475 616c 286f 7574 5f70  n (VJPDual(out_p
-0001c130: 7269 6d61 6c5b 305d 2c20 6f75 745f 7265  rimal[0], out_re
-0001c140: 7369 6475 616c 7329 2c20 2a28 564a 5044  siduals), *(VJPD
-0001c150: 7561 6c28 6f2c 2074 7570 6c65 2829 2920  ual(o, tuple()) 
-0001c160: 666f 7220 6f20 696e 206f 7574 5f70 7269  for o in out_pri
-0001c170: 6d61 6c5b 313a 5d29 290a 0a20 2020 2020  mal[1:]))..     
-0001c180: 2020 2072 6574 7572 6e20 2856 4a50 4475     return (VJPDu
-0001c190: 616c 286f 7574 5f70 7269 6d61 6c2c 206f  al(out_primal, o
-0001c1a0: 7574 5f72 6573 6964 7561 6c73 292c 290a  ut_residuals),).
-0001c1b0: 0a20 2020 2072 6574 7572 6e20 5f76 6a70  .    return _vjp
-0001c1c0: 5f69 6d70 6c0a 0a0a 6465 6620 6368 6563  _impl...def chec
-0001c1d0: 6b5f 6273 796d 5f66 6f72 5f76 6a70 2862  k_bsym_for_vjp(b
-0001c1e0: 7379 6d29 3a0a 2020 2020 2222 220a 2020  sym):.    """.  
-0001c1f0: 2020 4368 6563 6b20 6966 2061 2062 6f75    Check if a bou
-0001c200: 6e64 2073 796d 626f 6c20 6973 2073 7570  nd symbol is sup
-0001c210: 706f 7274 6564 2062 7920 766a 702e 0a0a  ported by vjp...
-0001c220: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0001c230: 2020 6273 796d 2028 426f 756e 6453 796d    bsym (BoundSym
-0001c240: 626f 6c29 3a20 5468 6520 626f 756e 6420  bol): The bound 
-0001c250: 7379 6d62 6f6c 2074 6f20 6368 6563 6b2e  symbol to check.
-0001c260: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0001c270: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
-0001c280: 6520 6966 2074 6865 2062 6f75 6e64 2073  e if the bound s
-0001c290: 796d 626f 6c20 6973 2073 7570 706f 7274  ymbol is support
-0001c2a0: 6564 2062 7920 766a 702c 2046 616c 7365  ed by vjp, False
-0001c2b0: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
-0001c2c0: 2222 220a 0a20 2020 2069 6620 6273 796d  """..    if bsym
-0001c2d0: 2e73 796d 2e69 6420 696e 2074 7261 6e73  .sym.id in trans
-0001c2e0: 666f 726d 5f73 6b69 705f 6c69 7374 3a0a  form_skip_list:.
-0001c2f0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0001c300: 7275 650a 0a20 2020 2069 6620 6273 796d  rue..    if bsym
-0001c310: 2e73 796d 2e69 6420 696e 2062 6163 6b77  .sym.id in backw
-0001c320: 6172 645f 696d 706c 7320 616e 6420 6273  ard_impls and bs
-0001c330: 796d 2e73 796d 2e69 6420 696e 2061 7567  ym.sym.id in aug
-0001c340: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-0001c350: 6d70 6c73 3a0a 2020 2020 2020 2020 7265  mpls:.        re
-0001c360: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
-0001c370: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
-0001c380: 205f 6772 6164 5f66 6e5f 6d61 703a 0a20   _grad_fn_map:. 
-0001c390: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0001c3a0: 7565 0a0a 2020 2020 2320 5765 2063 6f75  ue..    # We cou
-0001c3b0: 6c64 206e 6f74 2066 696e 6420 6120 564a  ld not find a VJ
-0001c3c0: 5020 666f 7220 7468 6973 2073 796d 626f  P for this symbo
-0001c3d0: 6c2c 2073 6f20 7765 2074 7279 2074 6f20  l, so we try to 
-0001c3e0: 6465 636f 6d70 6f73 6520 6974 0a20 2020  decompose it.   
-0001c3f0: 2023 2069 6e74 6f20 7375 622d 7379 6d62   # into sub-symb
-0001c400: 6f6c 7320 616e 6420 6368 6563 6b20 6966  ols and check if
-0001c410: 2074 6865 7920 6172 6520 7375 7070 6f72   they are suppor
-0001c420: 7465 640a 2020 2020 6966 206c 656e 2862  ted.    if len(b
-0001c430: 7379 6d2e 7375 6273 796d 626f 6c73 2920  sym.subsymbols) 
-0001c440: 3e20 3020 616e 6420 6e6f 7420 6273 796d  > 0 and not bsym
-0001c450: 2e73 796d 2e69 735f 7072 696d 3a0a 2020  .sym.is_prim:.  
-0001c460: 2020 2020 2020 7375 6274 7261 6365 203d        subtrace =
-0001c470: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0001c480: 2829 2862 7379 6d2e 7379 6d2c 202a 6273  ()(bsym.sym, *bs
-0001c490: 796d 2e61 7267 732c 202a 2a62 7379 6d2e  ym.args, **bsym.
-0001c4a0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0001c4b0: 7375 6274 7261 6365 203d 2075 6e77 7261  subtrace = unwra
-0001c4c0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
-0001c4d0: 7562 7379 6d62 6f6c 7328 7375 6274 7261  ubsymbols(subtra
-0001c4e0: 6365 290a 2020 2020 2020 2020 616c 6c5f  ce).        all_
-0001c4f0: 7375 7070 6f72 7465 6420 3d20 616c 6c28  supported = all(
-0001c500: 6368 6563 6b5f 6273 796d 5f66 6f72 5f76  check_bsym_for_v
-0001c510: 6a70 2873 7562 6273 796d 2920 666f 7220  jp(subbsym) for 
-0001c520: 7375 6262 7379 6d20 696e 2073 7562 7472  subbsym in subtr
-0001c530: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001c540: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-0001c550: 6e20 616c 6c5f 7375 7070 6f72 7465 640a  n all_supported.
-0001c560: 0a20 2020 2072 6574 7572 6e20 4661 6c73  .    return Fals
-0001c570: 650a 0a0a 6465 6620 6175 676d 656e 7465  e...def augmente
-0001c580: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
-0001c590: 6172 6773 2c20 7472 6163 653a 2054 7261  args, trace: Tra
-0001c5a0: 6365 2c20 2a2a 6b77 6172 6773 293a 0a20  ce, **kwargs):. 
-0001c5b0: 2020 2022 2222 4175 676d 656e 7465 6420     """Augmented 
-0001c5c0: 666f 7277 6172 6420 7061 7373 2066 6f72  forward pass for
-0001c5d0: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
-0001c5e0: 726d 2e0a 0a20 2020 2054 6865 2061 7567  rm...    The aug
-0001c5f0: 6d65 6e74 6564 2066 6f72 7761 7264 2070  mented forward p
-0001c600: 6173 7320 6973 2061 2066 6f72 7761 7264  ass is a forward
-0001c610: 2070 6173 7320 7468 6174 2072 6574 7572   pass that retur
-0001c620: 6e73 2074 6865 2072 6573 6964 7561 6c73  ns the residuals
-0001c630: 0a20 2020 206f 6620 7468 6520 666f 7277  .    of the forw
-0001c640: 6172 6420 7061 7373 2e0a 2020 2020 5468  ard pass..    Th
-0001c650: 6573 6520 7265 7369 6475 616c 7320 6172  ese residuals ar
-0001c660: 6520 7573 6564 2069 6e20 7468 6520 6261  e used in the ba
-0001c670: 636b 7761 7264 2070 6173 7320 746f 2063  ckward pass to c
-0001c680: 6f6d 7075 7465 2074 6865 2056 4a50 2061  ompute the VJP a
-0001c690: 6e64 2074 6865 790a 2020 2020 6172 6520  nd they.    are 
-0001c6a0: 7265 636f 7264 6564 2069 6e20 7468 6520  recorded in the 
-0001c6b0: 656e 7669 726f 6e6d 656e 7420 6469 6374  environment dict
-0001c6c0: 696f 6e61 7279 2066 6f72 2065 6163 6820  ionary for each 
-0001c6d0: 7661 7269 6162 6c65 2e0a 0a20 2020 2041  variable...    A
-0001c6e0: 7267 733a 0a20 2020 2020 2020 2061 7267  rgs:.        arg
-0001c6f0: 7320 2854 7570 6c65 5b56 6172 6961 626c  s (Tuple[Variabl
-0001c700: 655d 293a 2041 7267 756d 656e 7473 2074  e]): Arguments t
-0001c710: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
-0001c720: 2020 2020 2020 2020 7472 6163 6520 2854          trace (T
-0001c730: 7261 6365 293a 2054 7261 6365 206f 6620  race): Trace of 
-0001c740: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
-0001c750: 2020 2020 2020 6b77 6172 6773 2028 4469        kwargs (Di
-0001c760: 6374 5b73 7472 2c20 5661 7269 6162 6c65  ct[str, Variable
-0001c770: 5d29 3a20 4b65 7977 6f72 6420 6172 6775  ]): Keyword argu
-0001c780: 6d65 6e74 7320 746f 2074 6865 2066 756e  ments to the fun
-0001c790: 6374 696f 6e2e 0a0a 2020 2020 5265 7475  ction...    Retu
-0001c7a0: 726e 733a 0a20 2020 2020 2020 2054 7570  rns:.        Tup
-0001c7b0: 6c65 5b41 6e79 2c20 4469 6374 5b73 7472  le[Any, Dict[str
-0001c7c0: 2c20 416e 795d 5d3a 2054 7570 6c65 206f  , Any]]: Tuple o
-0001c7d0: 6620 7468 6520 7072 696d 616c 206f 7574  f the primal out
-0001c7e0: 7075 7473 2061 6e64 2074 6865 2065 6e76  puts and the env
-0001c7f0: 6972 6f6e 6d65 6e74 2e0a 2020 2020 2222  ironment..    ""
-0001c800: 220a 2020 2020 6172 6773 2c20 6b77 6172  ".    args, kwar
-0001c810: 6773 203d 2074 7265 655f 6d61 7028 6c61  gs = tree_map(la
-0001c820: 6d62 6461 2078 3a20 564a 5044 7561 6c28  mbda x: VJPDual(
-0001c830: 782c 2074 7570 6c65 2829 292c 2028 6172  x, tuple()), (ar
-0001c840: 6773 2c20 6b77 6172 6773 2929 0a20 2020  gs, kwargs)).   
-0001c850: 2072 6573 756c 742c 2065 6e76 203d 2065   result, env = e
-0001c860: 7661 6c5f 7472 6163 6528 0a20 2020 2020  val_trace(.     
-0001c870: 2020 2074 7261 6365 2c0a 2020 2020 2020     trace,.      
-0001c880: 2020 2a61 7267 732c 0a20 2020 2020 2020    *args,.       
-0001c890: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-0001c8a0: 2020 2077 6974 685f 656e 763d 5472 7565     with_env=True
-0001c8b0: 2c0a 2020 2020 2020 2020 7379 6d62 6f6c  ,.        symbol
-0001c8c0: 5f6d 6170 7065 723d 766a 705f 7379 6d62  _mapper=vjp_symb
-0001c8d0: 6f6c 5f6d 6170 7065 722c 0a20 2020 2029  ol_mapper,.    )
-0001c8e0: 0a20 2020 2072 6573 756c 7420 3d20 7472  .    result = tr
-0001c8f0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-0001c900: 2078 2e70 7269 6d61 6c20 6966 2069 7369   x.primal if isi
-0001c910: 6e73 7461 6e63 6528 782c 2056 4a50 4475  nstance(x, VJPDu
-0001c920: 616c 2920 656c 7365 2078 2c20 7265 7375  al) else x, resu
-0001c930: 6c74 290a 2020 2020 7265 7475 726e 2072  lt).    return r
-0001c940: 6573 756c 742c 2065 6e76 0a0a 0a23 2054  esult, env...# T
-0001c950: 4f44 4f3a 2049 6e73 7465 6164 206f 6620  ODO: Instead of 
-0001c960: 7573 696e 6720 7468 6520 656e 7669 726f  using the enviro
-0001c970: 6e6d 656e 7420 6469 6374 696f 6e61 7279  nment dictionary
-0001c980: 2c20 7765 2063 6f75 6c64 2075 7365 2074  , we could use t
-0001c990: 6865 2074 7261 6365 0a23 2073 796d 626f  he trace.# symbo
-0001c9a0: 6c73 206f 7264 6572 2028 7468 6174 2073  ls order (that s
-0001c9b0: 686f 756c 6420 6265 2064 6574 6572 6d69  hould be determi
-0001c9c0: 6e69 7374 6963 2920 746f 2072 6574 7269  nistic) to retri
-0001c9d0: 6576 6520 7468 6520 7265 7369 6475 616c  eve the residual
-0001c9e0: 7320 6e65 6564 6564 0a23 2066 6f72 2074  s needed.# for t
-0001c9f0: 6865 2062 6163 6b77 6172 6420 7061 7373  he backward pass
-0001ca00: 2e0a 6465 6620 6261 636b 7761 7264 5f70  ..def backward_p
-0001ca10: 6173 7328 666f 7277 6172 645f 656e 762c  ass(forward_env,
-0001ca20: 2074 7261 6365 2c20 696e 6974 5f63 6f74   trace, init_cot
-0001ca30: 616e 6765 6e74 7329 3a0a 2020 2020 2222  angents):.    ""
-0001ca40: 2242 6163 6b77 6172 6420 7061 7373 2066  "Backward pass f
-0001ca50: 6f72 2074 6865 2056 4a50 2074 7261 6e73  or the VJP trans
-0001ca60: 666f 726d 2e0a 0a20 2020 2054 6865 2062  form...    The b
-0001ca70: 6163 6b77 6172 6420 7061 7373 2069 7320  ackward pass is 
-0001ca80: 6120 7265 7665 7273 6520 6d6f 6465 2061  a reverse mode a
-0001ca90: 7574 6f6d 6174 6963 2064 6966 6665 7265  utomatic differe
-0001caa0: 6e74 6961 7469 6f6e 2070 6173 7320 7468  ntiation pass th
-0001cab0: 6174 0a20 2020 2063 6f6d 7075 7465 7320  at.    computes 
-0001cac0: 7468 6520 7665 6374 6f72 2d4a 6163 6f62  the vector-Jacob
-0001cad0: 6961 6e20 7072 6f64 7563 7420 2856 4a50  ian product (VJP
-0001cae0: 2920 6f66 2074 6865 2066 756e 6374 696f  ) of the functio
-0001caf0: 6e2e 0a0a 2020 2020 4172 6773 3a0a 2020  n...    Args:.  
-0001cb00: 2020 2020 2020 666f 7277 6172 645f 656e        forward_en
-0001cb10: 7620 2844 6963 745b 7374 722c 2041 6e79  v (Dict[str, Any
-0001cb20: 5d29 3a20 456e 7669 726f 6e6d 656e 7420  ]): Environment 
-0001cb30: 6f66 2074 6865 2066 6f72 7761 7264 2070  of the forward p
-0001cb40: 6173 732e 0a20 2020 2020 2020 2074 7261  ass..        tra
-0001cb50: 6365 2028 5472 6163 6529 3a20 5472 6163  ce (Trace): Trac
-0001cb60: 6520 6f66 2074 6865 2066 756e 6374 696f  e of the functio
-0001cb70: 6e2e 0a20 2020 2020 2020 2069 6e69 745f  n..        init_
-0001cb80: 636f 7461 6e67 656e 7473 2028 5475 706c  cotangents (Tupl
-0001cb90: 655b 5661 7269 6162 6c65 5d29 3a20 496e  e[Variable]): In
-0001cba0: 6974 6961 6c20 636f 7461 6e67 656e 7473  itial cotangents
-0001cbb0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001cbc0: 2020 2020 2020 2020 5475 706c 655b 5072          Tuple[Pr
-0001cbd0: 6f78 792c 202e 2e2e 5d3a 2054 7570 6c65  oxy, ...]: Tuple
-0001cbe0: 206f 6620 7468 6520 7265 7375 6c74 7320   of the results 
-0001cbf0: 6f66 2074 6865 2062 6163 6b77 6172 6420  of the backward 
-0001cc00: 7061 7373 2066 6f72 2065 6163 6820 696e  pass for each in
-0001cc10: 7075 742e 0a20 2020 2022 2222 0a20 2020  put..    """.   
-0001cc20: 2065 6e76 203d 207b 7d0a 0a20 2020 2064   env = {}..    d
-0001cc30: 6566 2067 6574 5f67 7261 6428 783a 2056  ef get_grad(x: V
-0001cc40: 6172 6961 626c 6529 3a0a 2020 2020 2020  ariable):.      
-0001cc50: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001cc60: 782c 2056 6172 6961 626c 6529 3a0a 2020  x, Variable):.  
-0001cc70: 2020 2020 2020 2020 2020 2320 5265 7475            # Retu
-0001cc80: 726e 204e 6f6e 6520 6966 2074 6865 2076  rn None if the v
-0001cc90: 6172 6961 626c 6520 7761 7320 6e6f 7420  ariable was not 
-0001cca0: 7573 6564 2069 6e20 7468 6520 636f 6d70  used in the comp
-0001ccb0: 7574 6174 696f 6e20 616e 640a 2020 2020  utation and.    
-0001ccc0: 2020 2020 2020 2020 2320 6865 6e63 6520          # hence 
-0001ccd0: 6e6f 7420 696e 2074 6865 2065 6e76 0a20  not in the env. 
-0001cce0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001ccf0: 6e20 656e 762e 6765 7428 782e 6e61 6d65  n env.get(x.name
-0001cd00: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0001cd10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001cd20: 2020 7265 7475 726e 2078 0a0a 2020 2020    return x..    
-0001cd30: 6465 6620 7075 745f 6772 6164 2876 3a20  def put_grad(v: 
-0001cd40: 5661 7269 6162 6c65 2c20 7661 6c3a 2041  Variable, val: A
-0001cd50: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-0001cd60: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001cd70: 6365 2876 2c20 5661 7269 6162 6c65 293a  ce(v, Variable):
-0001cd80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001cd90: 762e 6e61 6d65 2069 6e20 656e 763a 0a20  v.name in env:. 
-0001cda0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001cdb0: 6620 7661 6c20 6973 204e 6f6e 653a 0a20  f val is None:. 
-0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cdd0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0001cde0: 2020 2020 2020 2020 2020 2320 4163 6375            # Accu
-0001cdf0: 6d75 6c61 7465 2063 6f74 616e 6765 6e74  mulate cotangent
-0001ce00: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0001ce10: 2020 656e 765b 762e 6e61 6d65 5d20 3d20    env[v.name] = 
-0001ce20: 636c 616e 672e 6164 6428 656e 765b 762e  clang.add(env[v.
-0001ce30: 6e61 6d65 5d2c 2076 616c 2920 6966 2065  name], val) if e
-0001ce40: 6e76 5b76 2e6e 616d 655d 2069 7320 6e6f  nv[v.name] is no
-0001ce50: 7420 4e6f 6e65 2065 6c73 6520 7661 6c0a  t None else val.
-0001ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce70: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0001ce80: 2020 2065 6e76 5b76 2e6e 616d 655d 203d     env[v.name] =
-0001ce90: 2076 616c 0a20 2020 2020 2020 2065 6c69   val.        eli
-0001cea0: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-0001ceb0: 5365 7175 656e 6365 2920 616e 6420 616c  Sequence) and al
-0001cec0: 6c28 6973 696e 7374 616e 6365 2878 2c20  l(isinstance(x, 
-0001ced0: 696e 7429 2066 6f72 2078 2069 6e20 7629  int) for x in v)
-0001cee0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001cef0: 544f 444f 3a20 7265 6d6f 7665 2077 6865  TODO: remove whe
-0001cf00: 6e20 7765 206d 6f76 6520 6469 6d73 2074  n we move dims t
-0001cf10: 6f20 6b77 6172 6773 0a20 2020 2020 2020  o kwargs.       
-0001cf20: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-0001cf30: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0001cf40: 6528 762c 2073 7472 293a 0a20 2020 2020  e(v, str):.     
-0001cf50: 2020 2020 2020 2065 6e76 5b76 5d20 3d20         env[v] = 
-0001cf60: 7661 6c0a 2020 2020 2020 2020 656c 6966  val.        elif
-0001cf70: 2069 7369 6e73 7461 6e63 6528 762c 2053   isinstance(v, S
-0001cf80: 6571 7565 6e63 6529 2061 6e64 2076 616c  equence) and val
-0001cf90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001cfa0: 2020 2020 2020 2320 6272 6f61 6463 6173        # broadcas
-0001cfb0: 7420 4e6f 6e65 2074 6f20 7468 6520 7269  t None to the ri
-0001cfc0: 6768 7420 7368 6170 650a 2020 2020 2020  ght shape.      
-0001cfd0: 2020 2020 2020 7361 6665 5f6d 6170 2870        safe_map(p
-0001cfe0: 7574 5f67 7261 642c 2076 2c20 5b4e 6f6e  ut_grad, v, [Non
-0001cff0: 655d 202a 206c 656e 2876 2929 0a20 2020  e] * len(v)).   
-0001d000: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0001d010: 616e 6365 2876 2c20 5365 7175 656e 6365  ance(v, Sequence
-0001d020: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
-0001d030: 2876 616c 2c20 5365 7175 656e 6365 293a  (val, Sequence):
-0001d040: 0a20 2020 2020 2020 2020 2020 2073 6166  .            saf
-0001d050: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
-0001d060: 7261 642c 2076 2c20 7661 6c29 0a20 2020  rad, v, val).   
-0001d070: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001d080: 2020 2020 2020 2023 2053 6b69 7020 7772         # Skip wr
-0001d090: 6974 696e 6720 746f 2063 6f6e 7374 616e  iting to constan
-0001d0a0: 7473 0a20 2020 2020 2020 2020 2020 2070  ts.            p
-0001d0b0: 6173 730a 0a20 2020 2069 6620 6973 696e  ass..    if isin
-0001d0c0: 7374 616e 6365 2869 6e69 745f 636f 7461  stance(init_cota
-0001d0d0: 6e67 656e 7473 2c20 5365 7175 656e 6365  ngents, Sequence
-0001d0e0: 2920 616e 6420 6c65 6e28 696e 6974 5f63  ) and len(init_c
-0001d0f0: 6f74 616e 6765 6e74 7329 203d 3d20 3120  otangents) == 1 
-0001d100: 616e 6420 6e6f 7420 6973 696e 7374 616e  and not isinstan
-0001d110: 6365 2874 7261 6365 2e6f 7574 7075 742c  ce(trace.output,
-0001d120: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0001d130: 2020 2020 696e 6974 5f63 6f74 616e 6765      init_cotange
-0001d140: 6e74 7320 3d20 696e 6974 5f63 6f74 616e  nts = init_cotan
-0001d150: 6765 6e74 735b 305d 0a20 2020 2073 6166  gents[0].    saf
-0001d160: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
-0001d170: 7261 642c 2074 7261 6365 2e6f 7574 7075  rad, trace.outpu
-0001d180: 742c 2069 6e69 745f 636f 7461 6e67 656e  t, init_cotangen
-0001d190: 7473 290a 0a20 2020 2066 6f72 2073 796d  ts)..    for sym
-0001d1a0: 626f 6c20 696e 2072 6576 6572 7365 6428  bol in reversed(
-0001d1b0: 6c69 7374 2869 7465 725f 626f 756e 645f  list(iter_bound_
-0001d1c0: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
-0001d1d0: 756e 645f 7379 6d62 6f6c 7329 2929 3a0a  und_symbols))):.
-0001d1e0: 2020 2020 2020 2020 7379 6d62 6f6c 5f6f          symbol_o
-0001d1f0: 7574 7075 7420 3d20 7365 7175 656e 6369  utput = sequenci
-0001d200: 6679 2873 796d 626f 6c2e 6f75 7470 7574  fy(symbol.output
-0001d210: 290a 0a20 2020 2020 2020 2063 6f74 616e  )..        cotan
-0001d220: 6765 6e74 7320 3d20 7472 6565 5f6d 6170  gents = tree_map
-0001d230: 2867 6574 5f67 7261 642c 2073 796d 626f  (get_grad, symbo
-0001d240: 6c5f 6f75 7470 7574 290a 2020 2020 2020  l_output).      
-0001d250: 2020 2320 4861 7669 6e67 2061 2073 696e    # Having a sin
-0001d260: 676c 6520 636f 7461 6e67 656e 7420 6973  gle cotangent is
-0001d270: 2061 2063 6f6d 6d6f 6e20 6361 7365 2c20   a common case, 
-0001d280: 736f 2077 6520 666c 6174 7465 6e20 6974  so we flatten it
-0001d290: 0a20 2020 2020 2020 2023 204f 7468 6572  .        # Other
-0001d2a0: 7769 7365 2c20 7765 2077 696c 6c20 6e65  wise, we will ne
-0001d2b0: 6564 2074 6f20 7265 7772 6974 6520 7468  ed to rewrite th
-0001d2c0: 6520 7075 6c6c 6261 636b 2066 756e 6374  e pullback funct
-0001d2d0: 696f 6e73 0a20 2020 2020 2020 2063 6f74  ions.        cot
-0001d2e0: 616e 6765 6e74 7320 3d20 7472 6565 5f66  angents = tree_f
-0001d2f0: 6c61 7474 656e 2863 6f74 616e 6765 6e74  latten(cotangent
-0001d300: 7329 5b30 5d0a 2020 2020 2020 2020 7265  s)[0].        re
-0001d310: 7369 6475 616c 7320 3d20 666f 7277 6172  siduals = forwar
-0001d320: 645f 656e 765b 7379 6d62 6f6c 5f6f 7574  d_env[symbol_out
-0001d330: 7075 745b 305d 2e6e 616d 655d 2e72 6573  put[0].name].res
-0001d340: 6964 7561 6c73 0a20 2020 2020 2020 2069  iduals.        i
-0001d350: 6620 6973 5f63 6f6e 7374 616e 745f 666f  f is_constant_fo
-0001d360: 725f 766a 7028 7379 6d62 6f6c 293a 0a20  r_vjp(symbol):. 
-0001d370: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0001d380: 6361 6e20 736b 6970 2074 6865 2070 756c  can skip the pul
-0001d390: 6c62 6163 6b20 6966 2061 6c6c 2074 6865  lback if all the
-0001d3a0: 2061 7267 756d 656e 7473 2061 7265 2063   arguments are c
-0001d3b0: 6f6e 7374 616e 740a 2020 2020 2020 2020  onstant.        
-0001d3c0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-0001d3d0: 2020 2020 2020 6966 2061 6c6c 2863 6f74        if all(cot
-0001d3e0: 616e 6765 6e74 2069 7320 4e6f 6e65 2066  angent is None f
-0001d3f0: 6f72 2063 6f74 616e 6765 6e74 2069 6e20  or cotangent in 
-0001d400: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
-0001d410: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
-0001d420: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
-0001d430: 6163 6b20 6966 2074 6865 2063 6f74 616e  ack if the cotan
-0001d440: 6765 6e74 2069 7320 4e6f 6e65 0a20 2020  gent is None.   
-0001d450: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
-0001d460: 7028 7075 745f 6772 6164 2c20 7379 6d62  p(put_grad, symb
-0001d470: 6f6c 2e61 7267 732c 2028 4e6f 6e65 2c29  ol.args, (None,)
-0001d480: 202a 206c 656e 2873 796d 626f 6c2e 6172   * len(symbol.ar
-0001d490: 6773 2929 0a20 2020 2020 2020 2020 2020  gs)).           
-0001d4a0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0001d4b0: 2020 2069 6620 7379 6d62 6f6c 2e73 796d     if symbol.sym
-0001d4c0: 2e69 6420 3d3d 2022 746f 7263 682e 6e6e  .id == "torch.nn
-0001d4d0: 2e66 756e 6374 696f 6e61 6c2e 6472 6f70  .functional.drop
-0001d4e0: 6f75 7422 2061 6e64 206e 6f74 2073 796d  out" and not sym
-0001d4f0: 626f 6c2e 7375 6273 796d 626f 6c73 3a0a  bol.subsymbols:.
-0001d500: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-0001d510: 2063 616e 2073 6b69 7020 7468 6520 7075   can skip the pu
-0001d520: 6c6c 6261 636b 2069 6620 7468 6520 6472  llback if the dr
-0001d530: 6f70 6f75 7420 7072 6f62 6162 696c 6974  opout probabilit
-0001d540: 7920 6973 2030 2e30 0a20 2020 2020 2020  y is 0.0.       
-0001d550: 2020 2020 2023 2041 7373 756d 696e 6720       # Assuming 
-0001d560: 7468 6174 2074 6865 2064 726f 706f 7574  that the dropout
-0001d570: 2073 796d 626f 6c20 6861 7320 7468 6520   symbol has the 
-0001d580: 7361 6d65 206f 7574 7075 7420 616e 6420  same output and 
-0001d590: 6172 6775 6d65 6e74 0a20 2020 2020 2020  argument.       
-0001d5a0: 2020 2020 2061 7373 6572 7420 7379 6d62       assert symb
-0001d5b0: 6f6c 2e6f 7574 7075 742e 6e61 6d65 203d  ol.output.name =
-0001d5c0: 3d20 7379 6d62 6f6c 2e61 7267 735b 305d  = symbol.args[0]
-0001d5d0: 2e6e 616d 652c 2022 4472 6f70 6f75 7420  .name, "Dropout 
-0001d5e0: 7379 6d62 6f6c 2068 6173 2061 2064 6966  symbol has a dif
-0001d5f0: 6665 7265 6e74 206f 7574 7075 7420 616e  ferent output an
-0001d600: 6420 6172 6775 6d65 6e74 220a 2020 2020  d argument".    
-0001d610: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
-0001d620: 6c2e 6172 6773 5b31 5d20 3d3d 2030 2e30  l.args[1] == 0.0
-0001d630: 206f 7220 7379 6d62 6f6c 2e61 7267 735b   or symbol.args[
-0001d640: 325d 2069 7320 4661 6c73 653a 0a20 2020  2] is False:.   
-0001d650: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0001d660: 7469 6e75 650a 0a20 2020 2020 2020 2062  tinue..        b
-0001d670: 6163 6b77 6172 6420 3d20 6261 636b 7761  ackward = backwa
-0001d680: 7264 5f69 6d70 6c73 2e67 6574 2873 796d  rd_impls.get(sym
-0001d690: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
-0001d6a0: 2020 2020 6175 675f 666f 7277 6172 6420      aug_forward 
-0001d6b0: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
-0001d6c0: 6172 645f 696d 706c 732e 6765 7428 7379  ard_impls.get(sy
-0001d6d0: 6d62 6f6c 2e73 796d 2e69 6429 0a0a 2020  mbol.sym.id)..  
-0001d6e0: 2020 2020 2020 6966 205f 6765 745f 6772        if _get_gr
-0001d6f0: 6164 666e 2873 796d 626f 6c29 2069 7320  adfn(symbol) is 
-0001d700: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0001d710: 2020 2020 2020 6175 675f 666f 7277 6172        aug_forwar
-0001d720: 642c 2062 6163 6b77 6172 6420 3d20 6d61  d, backward = ma
-0001d730: 6b65 5f61 7567 5f66 6f72 7761 7264 5f61  ke_aug_forward_a
-0001d740: 6e64 5f62 6163 6b77 6172 6428 7379 6d62  nd_backward(symb
-0001d750: 6f6c 290a 0a20 2020 2020 2020 2069 6620  ol)..        if 
-0001d760: 6261 636b 7761 7264 2069 7320 4e6f 6e65  backward is None
-0001d770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0001d780: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
-0001d790: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
-0001d7a0: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
-0001d7b0: 796d 626f 6c2e 7379 6d2e 6964 2c20 7072  ymbol.sym.id, pr
-0001d7c0: 696d 732e 5072 696d 4944 7329 3a0a 2020  ims.PrimIDs):.  
-0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001d7e0: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
-0001d7f0: 6420 6120 6261 636b 7761 7264 2066 6f72  d a backward for
-0001d800: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
-0001d810: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
-0001d820: 706f 7365 2069 740a 2020 2020 2020 2020  pose it.        
-0001d830: 2020 2020 2020 2020 6261 636b 7761 7264          backward
-0001d840: 203d 2070 6172 7469 616c 2864 6563 6f6d   = partial(decom
-0001d850: 706f 7365 645f 666e 5f62 6163 6b77 6172  posed_fn_backwar
-0001d860: 645f 7275 6c65 2c20 7379 6d62 6f6c 2e73  d_rule, symbol.s
-0001d870: 796d 290a 2020 2020 2020 2020 2020 2020  ym).            
-0001d880: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001d890: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
-0001d8a0: 206e 6f74 2066 696e 6420 6120 6261 636b   not find a back
-0001d8b0: 7761 7264 2066 6f72 2074 6869 7320 7379  ward for this sy
-0001d8c0: 6d62 6f6c 2061 6e64 2077 6520 636f 756c  mbol and we coul
-0001d8d0: 6420 6e6f 7420 6465 636f 6d70 6f73 6520  d not decompose 
-0001d8e0: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
-0001d8f0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
-0001d900: 656d 656e 7465 6445 7272 6f72 2866 2242  ementedError(f"B
-0001d910: 6163 6b77 6172 6420 666f 7220 7b73 796d  ackward for {sym
-0001d920: 626f 6c2e 7379 6d2e 6964 7d20 6973 206e  bol.sym.id} is n
-0001d930: 6f74 2069 6d70 6c65 6d65 6e74 6564 2229  ot implemented")
-0001d940: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
-0001d950: 203d 2062 6163 6b77 6172 6428 2a72 6573   = backward(*res
-0001d960: 6964 7561 6c73 2c20 2a63 6f74 616e 6765  iduals, *cotange
-0001d970: 6e74 7329 0a20 2020 2020 2020 2069 6620  nts).        if 
-0001d980: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
-0001d990: 742c 2064 6963 7429 3a0a 2020 2020 2020  t, dict):.      
-0001d9a0: 2020 2020 2020 2320 4966 2074 6865 2062        # If the b
-0001d9b0: 6163 6b77 6172 6420 7265 7475 726e 7320  ackward returns 
-0001d9c0: 6120 6469 6374 2c20 7765 2061 7373 756d  a dict, we assum
-0001d9d0: 6520 7468 6174 2069 7420 6973 2061 2064  e that it is a d
-0001d9e0: 6963 7420 6f66 0a20 2020 2020 2020 2020  ict of.         
-0001d9f0: 2020 2023 2066 6f72 7761 7264 2061 7267     # forward arg
-0001da00: 756d 656e 7473 2074 6f20 7468 6520 636f  uments to the co
-0001da10: 7272 6573 706f 6e64 696e 670a 2020 2020  rresponding.    
-0001da20: 2020 2020 2020 2020 2320 6772 6164 6965          # gradie
-0001da30: 6e74 732f 636f 7461 6e67 656e 7473 2f61  nts/cotangents/a
-0001da40: 646a 6f69 6e74 732f 7365 6e73 6974 6976  djoints/sensitiv
-0001da50: 6974 6965 732e 0a20 2020 2020 2020 2020  ities..         
-0001da60: 2020 2075 7365 645f 6e61 6d65 7320 3d20     used_names = 
-0001da70: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
-0001da80: 2020 666f 7220 692c 2028 6b2c 2076 2920    for i, (k, v) 
-0001da90: 696e 2065 6e75 6d65 7261 7465 2869 6e73  in enumerate(ins
-0001daa0: 7065 6374 2e73 6967 6e61 7475 7265 2861  pect.signature(a
-0001dab0: 7567 5f66 6f72 7761 7264 292e 7061 7261  ug_forward).para
-0001dac0: 6d65 7465 7273 2e69 7465 6d73 2829 293a  meters.items()):
-0001dad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dae0: 2069 6620 762e 6b69 6e64 2069 6e20 2869   if v.kind in (i
-0001daf0: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
-0001db00: 2e50 4f53 4954 494f 4e41 4c5f 4f4e 4c59  .POSITIONAL_ONLY
-0001db10: 2c20 696e 7370 6563 742e 5061 7261 6d65  , inspect.Parame
-0001db20: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
-0001db30: 525f 4b45 5957 4f52 4429 3a0a 2020 2020  R_KEYWORD):.    
-0001db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db50: 7075 745f 6772 6164 2873 796d 626f 6c2e  put_grad(symbol.
-0001db60: 6172 6773 5b69 5d2c 2072 6573 756c 742e  args[i], result.
-0001db70: 6765 7428 6b2c 204e 6f6e 6529 290a 2020  get(k, None)).  
-0001db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db90: 2020 7573 6564 5f6e 616d 6573 2e61 6464    used_names.add
-0001dba0: 286b 290a 0a20 2020 2020 2020 2020 2020  (k)..           
-0001dbb0: 2023 2046 6f72 2064 6576 656c 6f70 6572   # For developer
-0001dbc0: 2063 6f6e 7665 6e69 656e 6365 2c20 7765   convenience, we
-0001dbd0: 2061 6c6c 6f77 2075 7369 6e67 2074 6865   allow using the
-0001dbe0: 206e 616d 6520 6672 6f6d 2074 6865 0a20   name from the. 
-0001dbf0: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
-0001dc00: 7761 7264 206d 6574 6120 696e 2061 6464  ward meta in add
-0001dc10: 6974 696f 6e20 746f 2074 6865 206e 616d  ition to the nam
-0001dc20: 6520 6672 6f6d 2074 6865 2061 7567 6d65  e from the augme
-0001dc30: 6e74 6564 2066 6f72 7761 7264 0a20 2020  nted forward.   
-0001dc40: 2020 2020 2020 2020 2023 2073 6967 6e61           # signa
-0001dc50: 7475 7265 2e0a 2020 2020 2020 2020 2020  ture..          
-0001dc60: 2020 2320 4966 2062 6f74 6820 6e61 6d65    # If both name
-0001dc70: 7320 6172 6520 7573 6564 2c20 7468 6520  s are used, the 
-0001dc80: 6f6e 6520 6672 6f6d 2074 6865 2066 6f72  one from the for
-0001dc90: 7761 7264 206d 6574 6120 7461 6b65 730a  ward meta takes.
-0001dca0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0001dcb0: 6563 6564 656e 6365 2e0a 2020 2020 2020  ecedence..      
-0001dcc0: 2020 2020 2020 666f 7220 692c 2028 6b2c        for i, (k,
-0001dcd0: 2076 2920 696e 2065 6e75 6d65 7261 7465   v) in enumerate
-0001dce0: 2869 6e73 7065 6374 2e73 6967 6e61 7475  (inspect.signatu
-0001dcf0: 7265 2873 796d 626f 6c2e 7379 6d2e 6d65  re(symbol.sym.me
-0001dd00: 7461 292e 7061 7261 6d65 7465 7273 2e69  ta).parameters.i
-0001dd10: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
-0001dd20: 2020 2020 2020 2020 2069 6620 762e 6b69           if v.ki
-0001dd30: 6e64 2069 6e20 2869 6e73 7065 6374 2e50  nd in (inspect.P
-0001dd40: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
-0001dd50: 4e41 4c5f 4f4e 4c59 2c20 696e 7370 6563  NAL_ONLY, inspec
-0001dd60: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
-0001dd70: 5449 4f4e 414c 5f4f 525f 4b45 5957 4f52  TIONAL_OR_KEYWOR
-0001dd80: 4429 3a0a 2020 2020 2020 2020 2020 2020  D):.            
-0001dd90: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
-0001dda0: 2069 6e20 7573 6564 5f6e 616d 6573 3a0a   in used_names:.
-0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddc0: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
-0001ddd0: 2873 796d 626f 6c2e 6172 6773 5b69 5d2c  (symbol.args[i],
-0001dde0: 2072 6573 756c 742e 6765 7428 6b2c 204e   result.get(k, N
-0001ddf0: 6f6e 6529 290a 2020 2020 2020 2020 2020  one)).          
-0001de00: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-0001de10: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-0001de20: 7461 6e63 6528 7265 7375 6c74 2c20 5365  tance(result, Se
-0001de30: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-0001de40: 2020 2020 2072 6573 756c 7420 3d20 2872       result = (r
-0001de50: 6573 756c 742c 290a 0a20 2020 2020 2020  esult,)..       
-0001de60: 2064 6566 2069 735f 6469 6666 6572 656e   def is_differen
-0001de70: 7469 6162 6c65 2861 7267 293a 0a20 2020  tiable(arg):.   
-0001de80: 2020 2020 2020 2020 206d 6174 6368 2061           match a
-0001de90: 7267 3a0a 2020 2020 2020 2020 2020 2020  rg:.            
-0001dea0: 2020 2020 6361 7365 2054 656e 736f 7250      case TensorP
-0001deb0: 726f 7879 2829 3a0a 2020 2020 2020 2020  roxy():.        
-0001dec0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001ded0: 726e 2064 7479 7065 732e 6973 5f69 6e65  rn dtypes.is_ine
-0001dee0: 7861 6374 5f64 7479 7065 2861 7267 2e64  xact_dtype(arg.d
-0001def0: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
-0001df00: 2020 2020 2020 6361 7365 2053 6571 7565        case Seque
-0001df10: 6e63 6528 293a 0a20 2020 2020 2020 2020  nce():.         
-0001df20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001df30: 6e20 6172 6720 616e 6420 616c 6c28 6973  n arg and all(is
-0001df40: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-0001df50: 6f72 5072 6f78 7929 2061 6e64 2064 7479  orProxy) and dty
-0001df60: 7065 732e 6973 5f69 6e65 7861 6374 5f64  pes.is_inexact_d
-0001df70: 7479 7065 2878 2e64 7479 7065 2920 666f  type(x.dtype) fo
-0001df80: 7220 7820 696e 2061 7267 290a 2020 2020  r x in arg).    
-0001df90: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0001dfa0: 205f 3a0a 2020 2020 2020 2020 2020 2020   _:.            
-0001dfb0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-0001dfc0: 616c 7365 0a0a 2020 2020 2020 2020 6966  alse..        if
-0001dfd0: 206c 656e 2873 796d 626f 6c2e 6172 6773   len(symbol.args
-0001dfe0: 2920 213d 2028 6f72 6967 5f72 6573 5f6c  ) != (orig_res_l
-0001dff0: 656e 203a 3d20 6c65 6e28 7265 7375 6c74  en := len(result
-0001e000: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0001e010: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
-0001e020: 2020 2020 2020 206f 7269 675f 7265 735f         orig_res_
-0001e030: 6c65 6e20 3c3d 206c 656e 2873 796d 626f  len <= len(symbo
-0001e040: 6c2e 6172 6773 292c 0a20 2020 2020 2020  l.args),.       
-0001e050: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-0001e060: 2066 2242 6163 6b77 6172 6420 666f 7220   f"Backward for 
-0001e070: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
-0001e080: 7265 7475 726e 6564 207b 6f72 6967 5f72  returned {orig_r
-0001e090: 6573 5f6c 656e 7d20 7661 6c75 6573 2c20  es_len} values, 
-0001e0a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001e0b0: 2020 2b20 6622 6275 7420 6578 7065 6374    + f"but expect
-0001e0c0: 6564 2061 7420 6d6f 7374 207b 6c65 6e28  ed at most {len(
-0001e0d0: 7379 6d62 6f6c 2e61 7267 7329 7d22 2c0a  symbol.args)}",.
-0001e0e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0001e0f0: 2020 2020 2020 2020 2020 2320 4173 7375            # Assu
-0001e100: 6d69 6e67 2074 6861 7420 7468 6520 6e6f  ming that the no
-0001e110: 6e2d 6469 6666 6572 656e 7469 6162 6c65  n-differentiable
-0001e120: 2061 7267 756d 656e 7473 2077 6572 6520   arguments were 
-0001e130: 6472 6f70 7065 6420 6672 6f6d 0a20 2020  dropped from.   
-0001e140: 2020 2020 2020 2020 2023 2074 6865 2062           # the b
-0001e150: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
-0001e160: 2c20 7765 2061 7265 2067 6f69 6e67 2074  , we are going t
-0001e170: 6f20 6170 7065 6e64 204e 6f6e 6520 746f  o append None to
-0001e180: 2074 6865 2072 6573 756c 740a 2020 2020   the result.    
-0001e190: 2020 2020 2020 2020 2320 746f 206d 6174          # to mat
-0001e1a0: 6368 2074 6865 206e 756d 6265 7220 6f66  ch the number of
-0001e1b0: 2061 7267 756d 656e 7473 2e20 416c 7465   arguments. Alte
-0001e1c0: 726e 6174 6976 656c 792c 2077 6520 636f  rnatively, we co
-0001e1d0: 756c 6420 6a75 7374 0a20 2020 2020 2020  uld just.       
-0001e1e0: 2020 2020 2023 2068 6176 6520 6120 666f       # have a fo
-0001e1f0: 722d 6c6f 6f70 2077 6974 6820 6120 636f  r-loop with a co
-0001e200: 6e64 6974 696f 6e61 6c20 7768 656e 2077  nditional when w
-0001e210: 7269 7469 6e67 2074 6f20 7468 650a 2020  riting to the.  
-0001e220: 2020 2020 2020 2020 2020 2320 656e 7669            # envi
-0001e230: 726f 6e6d 656e 742e 0a0a 2020 2020 2020  ronment...      
-0001e240: 2020 2020 2020 6974 6572 5f72 6573 756c        iter_resul
-0001e250: 7420 3d20 6974 6572 2872 6573 756c 7429  t = iter(result)
-0001e260: 0a20 2020 2020 2020 2020 2020 206e 5f64  .            n_d
-0001e270: 6966 6665 7265 6e74 6961 626c 655f 6172  ifferentiable_ar
-0001e280: 6773 203d 2073 756d 2862 6f6f 6c28 6973  gs = sum(bool(is
-0001e290: 5f64 6966 6665 7265 6e74 6961 626c 6528  _differentiable(
-0001e2a0: 6172 6729 2920 666f 7220 6172 6720 696e  arg)) for arg in
-0001e2b0: 2073 796d 626f 6c2e 6172 6773 290a 2020   symbol.args).  
-0001e2c0: 2020 2020 2020 2020 2020 6368 6563 6b28            check(
-0001e2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e2e0: 206e 5f64 6966 6665 7265 6e74 6961 626c   n_differentiabl
-0001e2f0: 655f 6172 6773 203c 3d20 6f72 6967 5f72  e_args <= orig_r
-0001e300: 6573 5f6c 656e 2c0a 2020 2020 2020 2020  es_len,.        
-0001e310: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-0001e320: 6622 4261 636b 7761 7264 2066 6f72 207b  f"Backward for {
-0001e330: 7379 6d62 6f6c 2e73 796d 2e69 647d 2072  symbol.sym.id} r
-0001e340: 6574 7572 6e65 6420 7b6f 7269 675f 7265  eturned {orig_re
-0001e350: 735f 6c65 6e7d 2076 616c 7565 2873 292c  s_len} value(s),
-0001e360: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0001e370: 2020 202b 2066 2262 7574 2065 7870 6563     + f"but expec
-0001e380: 7465 6420 7b6e 5f64 6966 6665 7265 6e74  ted {n_different
-0001e390: 6961 626c 655f 6172 6773 7d22 2c0a 2020  iable_args}",.  
-0001e3a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0001e3b0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-0001e3c0: 3d20 7475 706c 6528 6e65 7874 2869 7465  = tuple(next(ite
-0001e3d0: 725f 7265 7375 6c74 2920 6966 2069 735f  r_result) if is_
-0001e3e0: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
-0001e3f0: 7267 2920 656c 7365 204e 6f6e 6520 666f  rg) else None fo
-0001e400: 7220 6172 6720 696e 2073 796d 626f 6c2e  r arg in symbol.
-0001e410: 6172 6773 290a 0a20 2020 2020 2020 2023  args)..        #
-0001e420: 2053 6565 2022 4261 636b 7761 7264 2069   See "Backward i
-0001e430: 6d70 6c20 666f 7220 6f70 7320 6f66 2074  mpl for ops of t
-0001e440: 6865 2074 7970 6520 5365 7175 656e 6365  he type Sequence
-0001e450: 5b54 656e 736f 7250 726f 7879 5d2c 202e  [TensorProxy], .
-0001e460: 2e2e 202d 3e20 2e2e 2e20 7265 7375 6c74  .. -> ... result
-0001e470: 7320 696e 204e 6f6e 6520 6772 6164 732e  s in None grads.
-0001e480: 220a 2020 2020 2020 2020 2320 5468 6973  ".        # This
-0001e490: 2069 7320 6120 7465 6d70 6f72 6172 7920   is a temporary 
-0001e4a0: 776f 726b 6172 6f75 6e64 2e0a 2020 2020  workaround..    
-0001e4b0: 2020 2020 6966 2073 796d 626f 6c2e 7379      if symbol.sy
-0001e4c0: 6d2e 6964 2069 6e20 2870 7269 6d73 2e50  m.id in (prims.P
-0001e4d0: 7269 6d49 4473 2e43 4154 2c20 2274 6f72  rimIDs.CAT, "tor
-0001e4e0: 6368 2e63 6174 222c 2022 746f 7263 682e  ch.cat", "torch.
-0001e4f0: 7374 6163 6b22 293a 0a20 2020 2020 2020  stack"):.       
-0001e500: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
-0001e510: 6174 2870 7574 5f67 7261 642c 2073 796d  at(put_grad, sym
-0001e520: 626f 6c2e 6172 6773 2c20 7265 7375 6c74  bol.args, result
-0001e530: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001e540: 2020 2020 2020 2020 2020 2020 7361 6665              safe
-0001e550: 5f6d 6170 2870 7574 5f67 7261 642c 2073  _map(put_grad, s
-0001e560: 796d 626f 6c2e 6172 6773 2c20 7265 7375  ymbol.args, resu
-0001e570: 6c74 290a 0a20 2020 2064 6566 2067 6574  lt)..    def get
-0001e580: 5f69 6e65 7861 6374 5f64 7479 7065 5f6f  _inexact_dtype_o
-0001e590: 725f 6e6f 6e65 2878 293a 0a20 2020 2020  r_none(x):.     
-0001e5a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0001e5b0: 2878 2c20 2854 656e 736f 7250 726f 7879  (x, (TensorProxy
-0001e5c0: 2c20 4675 7475 7265 5465 6e73 6f72 5072  , FutureTensorPr
-0001e5d0: 6f78 7929 2920 616e 6420 6474 7970 6573  oxy)) and dtypes
-0001e5e0: 2e69 735f 696e 6578 6163 745f 6474 7970  .is_inexact_dtyp
-0001e5f0: 6528 782e 6474 7970 6529 3a0a 2020 2020  e(x.dtype):.    
-0001e600: 2020 2020 2020 2020 7265 7475 726e 2078          return x
-0001e610: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001e620: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001e630: 6e20 4e6f 6e65 0a0a 2020 2020 6761 7267  n None..    garg
-0001e640: 7320 3d20 7472 6565 5f6d 6170 2867 6574  s = tree_map(get
-0001e650: 5f67 7261 642c 2074 7570 6c65 2874 7261  _grad, tuple(tra
-0001e660: 6365 2e61 7267 7329 290a 2020 2020 676b  ce.args)).    gk
-0001e670: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
-0001e680: 2867 6574 5f67 7261 642c 2074 7261 6365  (get_grad, trace
-0001e690: 2e6b 7761 7267 7329 0a20 2020 2067 6b77  .kwargs).    gkw
-0001e6a0: 6172 6773 203d 207b 6b3a 2076 2066 6f72  args = {k: v for
-0001e6b0: 206b 2c20 7620 696e 2067 6b77 6172 6773   k, v in gkwargs
-0001e6c0: 2e69 7465 6d73 2829 2069 6620 7620 6973  .items() if v is
-0001e6d0: 206e 6f74 204e 6f6e 657d 0a20 2020 2067   not None}.    g
-0001e6e0: 6172 6773 2c20 676b 7761 7267 7320 3d20  args, gkwargs = 
-0001e6f0: 7472 6565 5f6d 6170 2867 6574 5f69 6e65  tree_map(get_ine
-0001e700: 7861 6374 5f64 7479 7065 5f6f 725f 6e6f  xact_dtype_or_no
-0001e710: 6e65 2c20 2867 6172 6773 2c20 676b 7761  ne, (gargs, gkwa
-0001e720: 7267 7329 290a 2020 2020 7265 7475 726e  rgs)).    return
-0001e730: 2067 6172 6773 202b 2028 676b 7761 7267   gargs + (gkwarg
-0001e740: 732c 2920 6966 206c 656e 2867 6b77 6172  s,) if len(gkwar
-0001e750: 6773 2920 213d 2030 2065 6c73 6520 6761  gs) != 0 else ga
-0001e760: 7267 730a 0a0a 6465 6620 766a 705f 6361  rgs...def vjp_ca
-0001e770: 6c6c 5f6d 6574 6166 756e 6328 6465 7461  ll_metafunc(deta
-0001e780: 6368 6564 3a20 626f 6f6c 2c20 7072 696d  ched: bool, prim
-0001e790: 616c 732c 2063 6f74 616e 6765 6e74 732c  als, cotangents,
-0001e7a0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-0001e7b0: 2a6b 7761 7267 7329 3a0a 2020 2020 2320  *kwargs):.    # 
-0001e7c0: 4173 7375 6d69 6e67 2070 7269 6d61 6c73  Assuming primals
-0001e7d0: 2069 7320 666c 6174 0a0a 2020 2020 6966   is flat..    if
-0001e7e0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-0001e7f0: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-0001e800: 6529 3a0a 2020 2020 2020 2020 7072 696d  e):.        prim
-0001e810: 616c 7320 3d20 2870 7269 6d61 6c73 2c29  als = (primals,)
-0001e820: 0a0a 2020 2020 6374 7820 3d20 6465 7461  ..    ctx = deta
-0001e830: 6368 6564 5f74 7261 6365 2829 2069 6620  ched_trace() if 
-0001e840: 6465 7461 6368 6564 2065 6c73 6520 6e75  detached else nu
-0001e850: 6c6c 636f 6e74 6578 7428 290a 2020 2020  llcontext().    
-0001e860: 7769 7468 2063 7478 3a0a 2020 2020 2020  with ctx:.      
-0001e870: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
-0001e880: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001e890: 645f 7061 7373 282a 7072 696d 616c 732c  d_pass(*primals,
-0001e8a0: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
-0001e8b0: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0001e8c0: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
-0001e8d0: 2020 206c 656e 2872 6573 756c 7429 203d     len(result) =
-0001e8e0: 3d20 6c65 6e28 636f 7461 6e67 656e 7473  = len(cotangents
-0001e8f0: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
-0001e900: 7265 7375 6c74 2c20 5365 7175 656e 6365  result, Sequence
-0001e910: 2920 656c 7365 2054 7275 652c 0a20 2020  ) else True,.   
-0001e920: 2020 2020 2020 2020 206c 616d 6264 613a           lambda:
-0001e930: 2066 2245 7870 6563 7465 6420 636f 7461   f"Expected cota
-0001e940: 6e67 656e 7473 2074 6f20 6265 2061 2073  ngents to be a s
-0001e950: 6571 7565 6e63 6520 6f66 206c 656e 6774  equence of lengt
-0001e960: 6820 7b6c 656e 2872 6573 756c 7429 7d2c  h {len(result)},
-0001e970: 2067 6f74 2061 2073 6571 7565 6e63 6520   got a sequence 
-0001e980: 6f66 206c 656e 6774 6820 7b6c 656e 2863  of length {len(c
-0001e990: 6f74 616e 6765 6e74 7329 7d22 2c0a 2020  otangents)}",.  
-0001e9a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001e9b0: 7265 7475 726e 2072 6573 756c 742c 2062  return result, b
-0001e9c0: 6163 6b77 6172 645f 7061 7373 2865 6e76  ackward_pass(env
-0001e9d0: 2c20 7472 6163 652c 2063 6f74 616e 6765  , trace, cotange
-0001e9e0: 6e74 7329 0a0a 0a23 2054 4f44 4f3a 2043  nts)...# TODO: C
-0001e9f0: 616e 2774 2075 7365 2061 2053 796d 626f  an't use a Symbo
-0001ea00: 6c20 6865 7265 2062 6563 6175 7365 206d  l here because m
-0001ea10: 6978 6564 2065 7865 6375 746f 7220 7379  ixed executor sy
-0001ea20: 6273 796d 626f 6c73 2073 6565 6d20 746f  bsymbols seem to
-0001ea30: 2062 650a 2320 756e 7375 7070 6f72 7465   be.# unsupporte
-0001ea40: 642e 2053 6565 2069 7373 7565 2022 436f  d. See issue "Co
-0001ea50: 756c 6420 6e6f 7420 6669 6e64 2061 6e20  uld not find an 
-0001ea60: 6578 6563 7574 6f72 2066 6f72 2062 6f75  executor for bou
-0001ea70: 6e64 2073 796d 626f 6c20 7768 656e 2069  nd symbol when i
-0001ea80: 7473 2073 7562 7379 6d62 6f6c 730a 2320  ts subsymbols.# 
-0001ea90: 6172 6520 6e6f 7420 6675 6c6c 7920 7375  are not fully su
-0001eaa0: 7070 6f72 7465 6420 6279 2061 2073 696e  pported by a sin
-0001eab0: 676c 6520 6578 6563 7574 6f72 220a 766a  gle executor".vj
-0001eac0: 705f 6361 6c6c 203d 2070 6172 7469 616c  p_call = partial
-0001ead0: 280a 2020 2020 766a 705f 6361 6c6c 5f6d  (.    vjp_call_m
-0001eae0: 6574 6166 756e 632c 2046 616c 7365 0a29  etafunc, False.)
-0001eaf0: 2020 2320 5379 6d62 6f6c 2869 643d 5472    # Symbol(id=Tr
-0001eb00: 616e 7366 6f72 6d73 2e56 6a70 4f70 2c20  ansforms.VjpOp, 
-0001eb10: 6e61 6d65 3d22 766a 705f 6361 6c6c 222c  name="vjp_call",
-0001eb20: 206d 6574 613d 7061 7274 6961 6c28 766a   meta=partial(vj
-0001eb30: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
-0001eb40: 2046 616c 7365 2929 0a0a 0a64 6566 2076   False))...def v
-0001eb50: 6a70 2866 756e 6329 3a0a 2020 2020 2222  jp(func):.    ""
-0001eb60: 2243 6f6d 7075 7465 7320 7468 6520 564a  "Computes the VJ
-0001eb70: 5020 6f66 2061 2066 756e 6374 696f 6e2e  P of a function.
-0001eb80: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001eb90: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
-0001eba0: 6c65 293a 2046 756e 6374 696f 6e20 746f  le): Function to
-0001ebb0: 2062 6520 6469 6666 6572 656e 7469 6174   be differentiat
-0001ebc0: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
-0001ebd0: 2064 6566 205f 766a 7028 7072 696d 616c   def _vjp(primal
-0001ebe0: 732c 2063 6f74 616e 6765 6e74 732c 202a  s, cotangents, *
-0001ebf0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0001ec00: 2020 666c 6174 5f66 756e 632c 2066 6c61    flat_func, fla
-0001ec10: 745f 6172 6773 2c20 7370 6563 203d 2066  t_args, spec = f
-0001ec20: 6c61 7474 656e 5f66 756e 6328 6675 6e63  latten_func(func
-0001ec30: 2c20 7072 696d 616c 732c 206b 7761 7267  , primals, kwarg
-0001ec40: 7329 0a20 2020 2020 2020 2074 7261 6365  s).        trace
-0001ec50: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-0001ec60: 6365 2829 2866 6c61 745f 6675 6e63 2c20  ce()(flat_func, 
-0001ec70: 2a66 6c61 745f 6172 6773 290a 2020 2020  *flat_args).    
-0001ec80: 2020 2020 7265 7375 6c74 2c20 766a 705f      result, vjp_
-0001ec90: 7265 7375 6c74 203d 2076 6a70 5f63 616c  result = vjp_cal
-0001eca0: 6c28 666c 6174 5f61 7267 732c 2063 6f74  l(flat_args, cot
-0001ecb0: 616e 6765 6e74 732c 2074 7261 6365 3d74  angents, trace=t
-0001ecc0: 7261 6365 290a 2020 2020 2020 2020 6770  race).        gp
-0001ecd0: 7269 6d61 6c73 2c20 676b 7761 7267 7320  rimals, gkwargs 
-0001ece0: 3d20 7472 6565 5f75 6e66 6c61 7474 656e  = tree_unflatten
-0001ecf0: 2876 6a70 5f72 6573 756c 742c 2073 7065  (vjp_result, spe
-0001ed00: 6329 0a20 2020 2020 2020 2067 7261 6473  c).        grads
-0001ed10: 203d 2067 7072 696d 616c 7320 2b20 2867   = gprimals + (g
-0001ed20: 6b77 6172 6773 2c29 2069 6620 6c65 6e28  kwargs,) if len(
-0001ed30: 676b 7761 7267 7329 2021 3d20 3020 656c  gkwargs) != 0 el
-0001ed40: 7365 2067 7072 696d 616c 730a 2020 2020  se gprimals.    
-0001ed50: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0001ed60: 742c 2067 7261 6473 0a0a 2020 2020 7265  t, grads..    re
-0001ed70: 7475 726e 205f 766a 700a 0a0a 6465 6620  turn _vjp...def 
-0001ed80: 7661 6c75 655f 616e 645f 6772 6164 2866  value_and_grad(f
-0001ed90: 756e 6329 3a0a 2020 2020 2222 2243 6f6d  unc):.    """Com
-0001eda0: 7075 7465 7320 7468 6520 7661 6c75 6520  putes the value 
-0001edb0: 616e 6420 6772 6164 6965 6e74 206f 6620  and gradient of 
-0001edc0: 6120 6675 6e63 7469 6f6e 2e0a 0a20 2020  a function...   
-0001edd0: 2054 6869 7320 6973 2061 2063 6f6e 7665   This is a conve
-0001ede0: 6e69 656e 6365 2066 756e 6374 696f 6e20  nience function 
-0001edf0: 7468 6174 2063 6f6d 6269 6e65 7320 7468  that combines th
-0001ee00: 6520 6675 6e63 7469 6f6e 616c 6974 7920  e functionality 
-0001ee10: 6f66 0a20 2020 2060 766a 705f 6361 6c6c  of.    `vjp_call
-0001ee20: 6020 7769 7468 2069 6d70 6c69 6369 7420  ` with implicit 
-0001ee30: 696e 6974 6961 6c69 7a61 7469 6f6e 206f  initialization o
-0001ee40: 6620 7468 6520 636f 7461 6e67 656e 7420  f the cotangent 
-0001ee50: 746f 2031 2e0a 0a20 2020 2041 7267 733a  to 1...    Args:
-0001ee60: 0a20 2020 2020 2020 2066 756e 6320 2843  .        func (C
-0001ee70: 616c 6c61 626c 6529 3a20 4675 6e63 7469  allable): Functi
-0001ee80: 6f6e 2074 6f20 6265 2064 6966 6665 7265  on to be differe
-0001ee90: 6e74 6961 7465 642e 0a20 2020 2022 2222  ntiated..    """
-0001eea0: 0a0a 2020 2020 6465 6620 6f6e 6573 5f6c  ..    def ones_l
-0001eeb0: 696b 6528 7829 3a0a 2020 2020 2020 2020  ike(x):.        
-0001eec0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0001eed0: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
-0001eee0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001eef0: 6e20 6675 6c6c 5f6c 696b 6528 782c 2066  n full_like(x, f
-0001ef00: 696c 6c5f 7661 6c75 653d 3129 0a20 2020  ill_value=1).   
-0001ef10: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0001ef20: 616e 6365 2878 2c20 4e75 6d62 6572 5072  ance(x, NumberPr
-0001ef30: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
-0001ef40: 2020 7265 7475 726e 2074 7970 6528 782e    return type(x.
-0001ef50: 7661 6c75 6529 2831 290a 2020 2020 2020  value)(1).      
-0001ef60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ef70: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0001ef80: 7272 6f72 2866 226f 6e65 735f 6c69 6b65  rror(f"ones_like
-0001ef90: 2069 6e73 6964 6520 7661 6c75 655f 616e   inside value_an
-0001efa0: 645f 6772 6164 2067 6f74 2061 6e20 756e  d_grad got an un
-0001efb0: 7375 7070 6f72 7465 6420 7479 7065 207b  supported type {
-0001efc0: 7479 7065 2878 297d 2229 0a0a 2020 2020  type(x)}")..    
-0001efd0: 6465 6620 5f76 616c 7565 5f61 6e64 5f67  def _value_and_g
-0001efe0: 7261 6428 2a61 7267 732c 202a 2a6b 7761  rad(*args, **kwa
-0001eff0: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
-0001f000: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-0001f010: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
-0001f020: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-0001f030: 2020 2020 2020 2063 6f74 616e 6765 6e74         cotangent
-0001f040: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
-0001f050: 6264 6120 763a 206f 6e65 735f 6c69 6b65  bda v: ones_like
-0001f060: 2876 292c 2074 7261 6365 2e6f 7574 7075  (v), trace.outpu
-0001f070: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-0001f080: 6e20 766a 7028 6675 6e63 2928 6172 6773  n vjp(func)(args
-0001f090: 2c20 636f 7461 6e67 656e 7473 2c20 2a2a  , cotangents, **
-0001f0a0: 6b77 6172 6773 290a 0a20 2020 2072 6574  kwargs)..    ret
-0001f0b0: 7572 6e20 5f76 616c 7565 5f61 6e64 5f67  urn _value_and_g
-0001f0c0: 7261 640a 0a0a 466f 7277 6172 6442 6163  rad...ForwardBac
-0001f0d0: 6b77 6172 6454 7261 6365 7320 3d20 6e61  kwardTraces = na
-0001f0e0: 6d65 6474 7570 6c65 2822 466f 7277 6172  medtuple("Forwar
-0001f0f0: 6442 6163 6b77 6172 6454 7261 6365 7322  dBackwardTraces"
-0001f100: 2c20 5b22 666f 7277 6172 645f 7472 6163  , ["forward_trac
-0001f110: 6522 2c20 2262 6163 6b77 6172 645f 7472  e", "backward_tr
-0001f120: 6163 6522 5d29 0a0a 0a64 6566 205f 7370  ace"])...def _sp
-0001f130: 6c69 745f 7361 7665 645f 666f 725f 6261  lit_saved_for_ba
-0001f140: 636b 7761 7264 5f69 6e74 6f5f 7465 6e73  ckward_into_tens
-0001f150: 6f72 735f 616e 645f 6f74 6865 7228 0a20  ors_and_other(. 
-0001f160: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-0001f170: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
-0001f180: 5661 7269 6162 6c65 5d2c 0a29 202d 3e20  Variable],.) -> 
-0001f190: 7475 706c 655b 5365 7175 656e 6365 5b56  tuple[Sequence[V
-0001f1a0: 6172 6961 626c 655d 2c20 5365 7175 656e  ariable], Sequen
-0001f1b0: 6365 5b56 6172 6961 626c 655d 5d3a 0a20  ce[Variable]]:. 
-0001f1c0: 2020 2022 2222 5370 6c69 7473 2073 6176     """Splits sav
-0001f1d0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-0001f1e0: 696e 746f 2074 656e 736f 7273 2061 6e64  into tensors and
-0001f1f0: 206f 7468 6572 2e0a 0a20 2020 2041 7267   other...    Arg
-0001f200: 733a 0a20 2020 2020 2020 2073 6176 6564  s:.        saved
-0001f210: 5f66 6f72 5f62 6163 6b77 6172 6420 2853  _for_backward (S
-0001f220: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f230: 5d29 3a20 5361 7665 645f 666f 725f 6261  ]): Saved_for_ba
-0001f240: 636b 7761 7264 2074 6f20 7370 6c69 742e  ckward to split.
-0001f250: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0001f260: 2020 2020 2020 2074 7570 6c65 5b53 6571         tuple[Seq
-0001f270: 7565 6e63 655b 5661 7269 6162 6c65 5d2c  uence[Variable],
-0001f280: 2053 6571 7565 6e63 655b 5661 7269 6162   Sequence[Variab
-0001f290: 6c65 5d5d 3a20 5475 706c 6520 6f66 2074  le]]: Tuple of t
-0001f2a0: 656e 736f 7273 2061 6e64 206f 7468 6572  ensors and other
-0001f2b0: 2e0a 2020 2020 2222 220a 2020 2020 6973  ..    """.    is
-0001f2c0: 5f74 656e 736f 7220 3d20 6c61 6d62 6461  _tensor = lambda
-0001f2d0: 2078 3a20 6973 696e 7374 616e 6365 2878   x: isinstance(x
-0001f2e0: 2c20 5465 6e73 6f72 5072 6f78 7929 0a20  , TensorProxy). 
-0001f2f0: 2020 206f 7468 6572 2c20 7465 6e73 6f72     other, tensor
-0001f300: 7320 3d20 7574 696c 732e 7061 7274 6974  s = utils.partit
-0001f310: 696f 6e28 6973 5f74 656e 736f 722c 2073  ion(is_tensor, s
-0001f320: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f330: 6429 0a20 2020 2072 6574 7572 6e20 7475  d).    return tu
-0001f340: 706c 6528 7465 6e73 6f72 7329 2c20 7475  ple(tensors), tu
-0001f350: 706c 6528 6f74 6865 7229 0a0a 0a64 6566  ple(other)...def
-0001f360: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
-0001f370: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
-0001f380: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
-0001f390: 7761 7264 5f74 7261 6365 3a20 5472 6163  ward_trace: Trac
-0001f3a0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001f3b0: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
-0001f3c0: 5661 7269 6162 6c65 5d29 202d 3e20 4e6f  Variable]) -> No
-0001f3d0: 6e65 3a0a 2020 2020 2222 2255 7064 6174  ne:.    """Updat
-0001f3e0: 6573 2074 6865 2066 6f72 7761 7264 2074  es the forward t
-0001f3f0: 7261 6365 2077 6974 6820 6e65 7720 7361  race with new sa
-0001f400: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f410: 2e0a 0a20 2020 2054 6869 7320 6973 206e  ...    This is n
-0001f420: 6563 6573 7361 7279 2062 6563 6175 7365  ecessary because
-0001f430: 2074 6865 2075 7064 6174 6564 2073 6176   the updated sav
-0001f440: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-0001f450: 6973 206e 6f74 2061 7661 696c 6162 6c65  is not available
-0001f460: 0a20 2020 2077 6865 6e20 7468 6520 666f  .    when the fo
-0001f470: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
-0001f480: 7264 2074 7261 6365 7320 6172 6520 636f  rd traces are co
-0001f490: 6e73 7472 7563 7465 642e 0a0a 2020 2020  nstructed...    
-0001f4a0: 4172 6773 3a0a 2020 2020 2020 2020 666f  Args:.        fo
-0001f4b0: 7277 6172 645f 7472 6163 6520 2854 7261  rward_trace (Tra
-0001f4c0: 6365 293a 2046 6f72 7761 7264 2074 7261  ce): Forward tra
-0001f4d0: 6365 2074 6f20 7570 6461 7465 2e0a 2020  ce to update..  
-0001f4e0: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
-0001f4f0: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
-0001f500: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
-0001f510: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f520: 6420 746f 2075 7365 2074 6f0a 2020 2020  d to use to.    
-0001f530: 2020 2020 2020 2020 7570 6461 7465 2074          update t
-0001f540: 6865 2066 6f72 7761 7264 2074 7261 6365  he forward trace
-0001f550: 2e0a 2020 2020 2222 220a 2020 2020 7361  ..    """.    sa
-0001f560: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f570: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0001f580: 6461 2078 3a20 782e 7661 6c75 6520 6966  da x: x.value if
-0001f590: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
-0001f5a0: 756d 6265 7250 726f 7879 2920 656c 7365  umberProxy) else
-0001f5b0: 2078 2c20 7361 7665 645f 666f 725f 6261   x, saved_for_ba
-0001f5c0: 636b 7761 7264 290a 2020 2020 7361 7665  ckward).    save
-0001f5d0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
-0001f5e0: 5f6f 7468 6572 203d 205f 7370 6c69 745f  _other = _split_
-0001f5f0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001f600: 7264 5f69 6e74 6f5f 7465 6e73 6f72 735f  rd_into_tensors_
-0001f610: 616e 645f 6f74 6865 7228 7361 7665 645f  and_other(saved_
-0001f620: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001f630: 2020 6173 7365 7274 2066 6f72 7761 7264    assert forward
-0001f640: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001f650: 626f 6c73 5b2d 315d 2e73 796d 2e69 6420  bols[-1].sym.id 
-0001f660: 3d3d 2070 7269 6d73 2e50 7269 6d49 4473  == prims.PrimIDs
-0001f670: 2e52 4554 5552 4e0a 2020 2020 6e65 775f  .RETURN.    new_
-0001f680: 7265 7475 726e 203d 2028 666f 7277 6172  return = (forwar
-0001f690: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
-0001f6a0: 5d2c 2028 7361 7665 645f 7465 6e73 6f72  ], (saved_tensor
-0001f6b0: 732c 2073 6176 6564 5f6f 7468 6572 2929  s, saved_other))
-0001f6c0: 0a20 2020 2066 6f72 7761 7264 5f74 7261  .    forward_tra
-0001f6d0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-0001f6e0: 5b2d 315d 203d 2072 6570 6c61 6365 2866  [-1] = replace(f
-0001f6f0: 6f72 7761 7264 5f74 7261 6365 2e62 6f75  orward_trace.bou
-0001f700: 6e64 5f73 796d 626f 6c73 5b2d 315d 2c20  nd_symbols[-1], 
-0001f710: 6172 6773 3d6e 6577 5f72 6574 7572 6e29  args=new_return)
-0001f720: 0a0a 0a64 6566 205f 7570 6461 7465 5f62  ...def _update_b
-0001f730: 6163 6b77 6172 645f 7769 7468 5f6e 6577  ackward_with_new
-0001f740: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-0001f750: 6172 6428 6261 636b 7761 7264 5f74 7261  ard(backward_tra
-0001f760: 6365 3a20 5472 6163 652c 2073 6176 6564  ce: Trace, saved
-0001f770: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
-0001f780: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f790: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
-0001f7a0: 2222 2255 7064 6174 6573 2074 6865 2062  """Updates the b
-0001f7b0: 6163 6b77 6172 6420 7472 6163 6520 7769  ackward trace wi
-0001f7c0: 7468 206e 6577 2073 6176 6564 5f66 6f72  th new saved_for
-0001f7d0: 5f62 6163 6b77 6172 642e 0a0a 2020 2020  _backward...    
-0001f7e0: 5468 6973 2069 7320 6e65 6365 7373 6172  This is necessar
-0001f7f0: 7920 6265 6361 7573 6520 7468 6520 7570  y because the up
-0001f800: 6461 7465 6420 7361 7665 645f 666f 725f  dated saved_for_
-0001f810: 6261 636b 7761 7264 2069 730a 2020 2020  backward is.    
-0001f820: 6e6f 7420 6176 6169 6c61 626c 6520 7768  not available wh
-0001f830: 656e 2074 6865 2062 6163 6b77 6172 6420  en the backward 
-0001f840: 7472 6163 6520 6973 2063 6f6e 7374 7275  trace is constru
-0001f850: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
-0001f860: 0a20 2020 2020 2020 2062 6163 6b77 6172  .        backwar
-0001f870: 645f 7472 6163 6520 2854 7261 6365 293a  d_trace (Trace):
-0001f880: 2042 6163 6b77 6172 6420 7472 6163 6520   Backward trace 
-0001f890: 746f 2075 7064 6174 652e 0a20 2020 2020  to update..     
-0001f8a0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-0001f8b0: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
-0001f8c0: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
-0001f8d0: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
-0001f8e0: 6f20 7573 6520 746f 0a20 2020 2020 2020  o use to.       
-0001f8f0: 2020 2020 2075 7064 6174 6520 7468 6520       update the 
-0001f900: 6261 636b 7761 7264 2074 7261 6365 2e0a  backward trace..
-0001f910: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-0001f920: 2075 6e70 6163 6b69 6e67 5f66 6e28 7361   unpacking_fn(sa
-0001f930: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f940: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
-0001f950: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-0001f960: 2063 6f74 616e 6765 6e74 7320 3d20 6261   cotangents = ba
-0001f970: 636b 7761 7264 5f74 7261 6365 2e61 7267  ckward_trace.arg
-0001f980: 735b 315d 0a20 2020 2073 6176 6564 5f74  s[1].    saved_t
-0001f990: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
-0001f9a0: 6865 7220 3d20 5f73 706c 6974 5f73 6176  her = _split_sav
-0001f9b0: 6564 5f66 6f72 5f62 6163 6b77 6172 645f  ed_for_backward_
-0001f9c0: 696e 746f 5f74 656e 736f 7273 5f61 6e64  into_tensors_and
-0001f9d0: 5f6f 7468 6572 2873 6176 6564 5f66 6f72  _other(saved_for
-0001f9e0: 5f62 6163 6b77 6172 6429 0a20 2020 2075  _backward).    u
-0001f9f0: 6e70 6163 6b69 6e67 5f74 7261 6365 203d  npacking_trace =
-0001fa00: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0001fa10: 2872 656e 616d 655f 7072 6f78 6965 733d  (rename_proxies=
-0001fa20: 4661 6c73 652c 2075 7365 5f64 6365 3d46  False, use_dce=F
-0001fa30: 616c 7365 2928 0a20 2020 2020 2020 2075  alse)(.        u
-0001fa40: 6e70 6163 6b69 6e67 5f66 6e2c 2028 7361  npacking_fn, (sa
-0001fa50: 7665 645f 7465 6e73 6f72 732c 2073 6176  ved_tensors, sav
-0001fa60: 6564 5f6f 7468 6572 292c 2063 6f74 616e  ed_other), cotan
-0001fa70: 6765 6e74 730a 2020 2020 290a 2020 2020  gents.    ).    
-0001fa80: 6173 7365 7274 2075 6e70 6163 6b69 6e67  assert unpacking
-0001fa90: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001faa0: 626f 6c73 5b2d 315d 2e73 796d 2e69 6420  bols[-1].sym.id 
-0001fab0: 3d3d 2070 7269 6d73 2e50 7269 6d49 4473  == prims.PrimIDs
-0001fac0: 2e52 4554 5552 4e0a 0a20 2020 2062 6163  .RETURN..    bac
-0001fad0: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
-0001fae0: 203d 2075 6e70 6163 6b69 6e67 5f74 7261   = unpacking_tra
-0001faf0: 6365 2e61 7267 730a 2020 2020 6261 636b  ce.args.    back
-0001fb00: 7761 7264 5f74 7261 6365 5f62 7379 6d73  ward_trace_bsyms
-0001fb10: 5f77 6974 686f 7574 5f75 6e70 6163 6b69  _without_unpacki
-0001fb20: 6e67 203d 2028 0a20 2020 2020 2020 2062  ng = (.        b
-0001fb30: 7379 6d0a 2020 2020 2020 2020 666f 7220  sym.        for 
-0001fb40: 6273 796d 2069 6e20 6261 636b 7761 7264  bsym in backward
-0001fb50: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001fb60: 626f 6c73 0a20 2020 2020 2020 2069 6620  bols.        if 
-0001fb70: 6273 796d 2e73 796d 2e69 640a 2020 2020  bsym.sym.id.    
-0001fb80: 2020 2020 6e6f 7420 696e 2028 0a20 2020      not in (.   
-0001fb90: 2020 2020 2020 2020 2070 7269 6d73 2e50           prims.P
-0001fba0: 7269 6d49 4473 2e55 4e50 4143 4b5f 454d  rimIDs.UNPACK_EM
-0001fbb0: 5054 595f 4449 4354 2c0a 2020 2020 2020  PTY_DICT,.      
-0001fbc0: 2020 2020 2020 7072 696d 732e 5072 696d        prims.Prim
-0001fbd0: 4944 732e 554e 5041 434b 5f4b 4559 2c0a  IDs.UNPACK_KEY,.
-0001fbe0: 2020 2020 2020 2020 2020 2020 7072 696d              prim
-0001fbf0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
-0001fc00: 5f53 4551 5545 4e43 452c 0a20 2020 2020  _SEQUENCE,.     
-0001fc10: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
-0001fc20: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
-0001fc30: 4941 4c2c 0a20 2020 2020 2020 2029 0a20  IAL,.        ). 
-0001fc40: 2020 2029 0a20 2020 2062 6163 6b77 6172     ).    backwar
-0001fc50: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
-0001fc60: 6d62 6f6c 7320 3d20 6c69 7374 2828 2a75  mbols = list((*u
-0001fc70: 6e70 6163 6b69 6e67 5f74 7261 6365 2e62  npacking_trace.b
-0001fc80: 6f75 6e64 5f73 796d 626f 6c73 5b3a 2d31  ound_symbols[:-1
-0001fc90: 5d2c 202a 6261 636b 7761 7264 5f74 7261  ], *backward_tra
-0001fca0: 6365 5f62 7379 6d73 5f77 6974 686f 7574  ce_bsyms_without
-0001fcb0: 5f75 6e70 6163 6b69 6e67 2929 0a0a 0a23  _unpacking))...#
-0001fcc0: 204e 4f54 453a 2052 6574 7572 6e69 6e67   NOTE: Returning
-0001fcd0: 206e 616d 6564 7475 706c 6573 2066 726f   namedtuples fro
-0001fce0: 6d20 636f 6d70 696c 6564 2066 756e 6374  m compiled funct
-0001fcf0: 696f 6e73 2064 6f65 736e 2774 2077 6f72  ions doesn't wor
-0001fd00: 6b2e 2053 6565 3a0a 2320 2241 6c6c 6f77  k. See:.# "Allow
-0001fd10: 2072 6574 7572 6e69 6e67 206e 616d 6564   returning named
-0001fd20: 7475 706c 6573 2066 726f 6d20 636f 6d70  tuples from comp
-0001fd30: 696c 6564 2066 756e 6374 696f 6e73 220a  iled functions".
-0001fd40: 2320 4e6f 7465 205b 4772 6164 2066 6f72  # Note [Grad for
-0001fd50: 7761 7264 206f 7574 7075 7420 7370 6563  ward output spec
-0001fd60: 5d0a 2320 4966 2069 7420 6469 6420 776f  ].# If it did wo
-0001fd70: 726b 2069 7420 776f 756c 6420 6265 206e  rk it would be n
-0001fd80: 6963 6520 746f 2075 7365 2074 6869 7320  ice to use this 
-0001fd90: 6e61 6d65 6474 7570 6c65 0a23 2069 6e73  namedtuple.# ins
-0001fda0: 7465 6164 206f 6620 7468 6520 706c 6169  tead of the plai
-0001fdb0: 6e20 7475 706c 6520 6f72 2064 6963 7420  n tuple or dict 
-0001fdc0: 7468 6174 2077 6527 7265 2075 7369 6e67  that we're using
-0001fdd0: 206e 6f77 2e0a 546f 7263 6841 7574 6f67   now..TorchAutog
-0001fde0: 7261 6446 6f72 7761 7264 4461 7461 203d  radForwardData =
-0001fdf0: 206e 616d 6564 7475 706c 6528 0a20 2020   namedtuple(.   
-0001fe00: 2022 546f 7263 6841 7574 6f67 7261 6446   "TorchAutogradF
-0001fe10: 6f72 7761 7264 4461 7461 222c 0a20 2020  orwardData",.   
-0001fe20: 205b 226f 7574 7075 7422 2c20 2266 6c61   ["output", "fla
-0001fe30: 745f 6172 6773 222c 2022 666c 6174 5f6f  t_args", "flat_o
-0001fe40: 7574 7075 7422 5d2c 0a29 0a0a 0a64 6566  utput"],.)...def
-0001fe50: 2066 6f72 7761 7264 5f61 6e64 5f62 6163   forward_and_bac
-0001fe60: 6b77 6172 645f 6672 6f6d 5f74 7261 6365  kward_from_trace
-0001fe70: 2874 7261 6365 3a20 5472 6163 652c 2074  (trace: Trace, t
-0001fe80: 6f72 6368 5f61 7574 6f67 7261 643d 4661  orch_autograd=Fa
-0001fe90: 6c73 6529 202d 3e20 466f 7277 6172 6442  lse) -> ForwardB
-0001fea0: 6163 6b77 6172 6454 7261 6365 733a 0a20  ackwardTraces:. 
-0001feb0: 2020 2022 2222 4765 6e65 7261 7465 7320     """Generates 
-0001fec0: 7468 6520 666f 7277 6172 6420 616e 6420  the forward and 
-0001fed0: 6261 636b 7761 7264 2070 6173 7365 7320  backward passes 
-0001fee0: 6672 6f6d 2061 2074 7261 6365 2e0a 0a20  from a trace... 
-0001fef0: 2020 2054 6869 7320 6973 2061 2063 6f6e     This is a con
-0001ff00: 7665 6e69 656e 6365 2066 756e 6374 696f  venience functio
-0001ff10: 6e20 7468 6174 2063 6f6d 6269 6e65 7320  n that combines 
-0001ff20: 7468 6520 6675 6e63 7469 6f6e 616c 6974  the functionalit
-0001ff30: 7920 6f66 0a20 2020 2060 6175 676d 656e  y of.    `augmen
-0001ff40: 7465 645f 666f 7277 6172 645f 7061 7373  ted_forward_pass
-0001ff50: 6020 616e 6420 6062 6163 6b77 6172 645f  ` and `backward_
-0001ff60: 7061 7373 602e 2054 6865 206d 6169 6e20  pass`. The main 
-0001ff70: 6469 6666 6572 656e 6365 2069 7320 7468  difference is th
-0001ff80: 6174 0a20 2020 2074 6869 7320 6675 6e63  at.    this func
-0001ff90: 7469 6f6e 2064 6f65 7320 6e6f 7420 7265  tion does not re
-0001ffa0: 7175 6972 6520 7468 6520 7573 6572 2074  quire the user t
-0001ffb0: 6f20 7072 6f76 6964 6520 6e65 7720 696e  o provide new in
-0001ffc0: 7075 7473 2066 6f72 2074 6865 0a20 2020  puts for the.   
-0001ffd0: 2074 7261 6365 2065 7661 6c75 6174 696f   trace evaluatio
-0001ffe0: 6e2e 2049 6e73 7465 6164 2069 7420 7573  n. Instead it us
-0001fff0: 6573 2074 6865 2069 6e70 7574 7320 7468  es the inputs th
-00020000: 6174 2077 6572 6520 7573 6564 2074 6f20  at were used to 
-00020010: 636f 6e73 7472 7563 740a 2020 2020 7468  construct.    th
-00020020: 6520 7472 6163 652e 0a0a 2020 2020 4172  e trace...    Ar
-00020030: 6773 3a0a 2020 2020 2020 2020 7472 6163  gs:.        trac
-00020040: 6520 2854 7261 6365 293a 2054 7261 6365  e (Trace): Trace
-00020050: 2074 6f20 6765 6e65 7261 7465 2074 6865   to generate the
-00020060: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
-00020070: 6b77 6172 6420 7061 7373 6573 2066 726f  kward passes fro
-00020080: 6d2e 0a0a 2020 2020 5265 7475 726e 733a  m...    Returns:
-00020090: 0a20 2020 2020 2020 2046 6f72 7761 7264  .        Forward
-000200a0: 4261 636b 7761 7264 5472 6163 6573 3a20  BackwardTraces: 
-000200b0: 4120 6e61 6d65 6420 7475 706c 6520 636f  A named tuple co
-000200c0: 6e74 6169 6e69 6e67 2074 6865 2066 6f72  ntaining the for
-000200d0: 7761 7264 2061 6e64 2062 6163 6b77 6172  ward and backwar
-000200e0: 640a 2020 2020 2020 2020 2020 2020 7472  d.            tr
-000200f0: 6163 6573 2e0a 0a20 2020 2045 7861 6d70  aces...    Examp
-00020100: 6c65 3a0a 2020 2020 2020 2020 3e3e 3e20  le:.        >>> 
-00020110: 696d 706f 7274 2074 6f72 6368 0a20 2020  import torch.   
-00020120: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
-00020130: 756e 6465 7220 696d 706f 7274 2063 6f6d  under import com
-00020140: 7069 6c65 2c20 6c61 7374 5f74 7261 6365  pile, last_trace
-00020150: 730a 2020 2020 2020 2020 3e3e 3e20 6672  s.        >>> fr
-00020160: 6f6d 2074 6875 6e64 6572 2e63 6f72 652e  om thunder.core.
-00020170: 7472 616e 7366 6f72 6d73 2069 6d70 6f72  transforms impor
-00020180: 7420 666f 7277 6172 645f 616e 645f 6261  t forward_and_ba
-00020190: 636b 7761 7264 5f66 726f 6d5f 7472 6163  ckward_from_trac
-000201a0: 650a 2020 2020 2020 2020 3e3e 3e20 6465  e.        >>> de
-000201b0: 6620 6628 7829 3a0a 2020 2020 2020 2020  f f(x):.        
-000201c0: 2e2e 2e20 2020 2020 7265 7475 726e 2074  ...     return t
-000201d0: 6f72 6368 2e73 696e 2878 290a 2020 2020  orch.sin(x).    
-000201e0: 2020 2020 3e3e 3e20 7820 3d20 746f 7263      >>> x = torc
-000201f0: 682e 7465 6e73 6f72 2833 2e30 290a 2020  h.tensor(3.0).  
-00020200: 2020 2020 2020 3e3e 3e20 6366 203d 2063        >>> cf = c
-00020210: 6f6d 7069 6c65 2866 290a 2020 2020 2020  ompile(f).      
-00020220: 2020 3e3e 3e20 6f75 7420 3d20 6366 2878    >>> out = cf(x
-00020230: 290a 2020 2020 2020 2020 3e3e 3e20 7472  ).        >>> tr
-00020240: 6163 6520 3d20 6c61 7374 5f74 7261 6365  ace = last_trace
-00020250: 7328 6366 295b 305d 0a20 2020 2020 2020  s(cf)[0].       
-00020260: 203e 3e3e 2066 6f72 7761 7264 5f61 6e64   >>> forward_and
-00020270: 5f62 6163 6b77 6172 645f 6672 6f6d 5f74  _backward_from_t
-00020280: 7261 6365 2874 7261 6365 290a 2020 2020  race(trace).    
-00020290: 2020 2020 2e2e 2e20 466f 7277 6172 6442      ... ForwardB
-000202a0: 6163 6b77 6172 6454 7261 6365 7328 0a20  ackwardTraces(. 
-000202b0: 2020 2020 2020 202e 2e2e 2066 6f72 7761         ... forwa
-000202c0: 7264 5f74 7261 6365 3d23 2069 6d70 6f72  rd_trace=# impor
-000202d0: 7420 7468 756e 6465 7220 6173 2074 6875  t thunder as thu
-000202e0: 6e64 6572 0a20 2020 2020 2020 202e 2e2e  nder.        ...
-000202f0: 2023 2069 6d70 6f72 7420 7468 756e 6465   # import thunde
-00020300: 722e 636f 7265 2e70 7269 6d73 2061 7320  r.core.prims as 
-00020310: 7072 696d 730a 2020 2020 2020 2020 2e2e  prims.        ..
-00020320: 2e20 696d 706f 7274 2074 6f72 6368 0a20  . import torch. 
-00020330: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
-00020340: 2020 202e 2e2e 2040 746f 7263 682e 6e6f     ... @torch.no
-00020350: 5f67 7261 6428 290a 2020 2020 2020 2020  _grad().        
-00020360: 2e2e 2e20 6465 6620 6175 676d 656e 7465  ... def augmente
-00020370: 645f 666f 7277 6172 645f 666e 282a 6172  d_forward_fn(*ar
-00020380: 6773 293a 0a20 2020 2020 2020 202e 2e2e  gs):.        ...
-00020390: 2020 2023 2061 7267 733a 2022 436f 6c6c     # args: "Coll
-000203a0: 6563 7469 6f6e 2220 3d20 2028 7430 2c29  ection" =  (t0,)
-000203b0: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
-000203c0: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
-000203d0: 2074 302c 205c 0a20 2020 2020 2020 202e   t0, \.        .
-000203e0: 2e2e 2020 203d 2061 7267 730a 2020 2020  ..   = args.    
-000203f0: 2020 2020 2e2e 2e20 2020 7431 203d 2070      ...   t1 = p
-00020400: 7269 6d73 2e73 696e 2874 3029 2020 2320  rims.sin(t0)  # 
-00020410: 7431 3a20 2263 7075 2066 3332 5b5d 220a  t1: "cpu f32[]".
-00020420: 2020 2020 2020 2020 2e2e 2e20 2020 7265          ...   re
-00020430: 7475 726e 2074 312c 2028 7430 2c29 2c0a  turn t1, (t0,),.
-00020440: 2020 2020 2020 2020 2e2e 2e20 6261 636b          ... back
-00020450: 7761 7264 5f74 7261 6365 3d23 2069 6d70  ward_trace=# imp
-00020460: 6f72 7420 7468 756e 6465 7220 6173 2074  ort thunder as t
-00020470: 6875 6e64 6572 0a20 2020 2020 2020 202e  hunder.        .
-00020480: 2e2e 2023 2069 6d70 6f72 7420 7468 756e  .. # import thun
-00020490: 6465 722e 636f 7265 2e70 7269 6d73 2061  der.core.prims a
-000204a0: 7320 7072 696d 730a 2020 2020 2020 2020  s prims.        
-000204b0: 2e2e 2e20 696d 706f 7274 2074 6f72 6368  ... import torch
-000204c0: 0a20 2020 2020 2020 202e 2e2e 0a20 2020  .        ....   
-000204d0: 2020 2020 202e 2e2e 2040 746f 7263 682e       ... @torch.
-000204e0: 6e6f 5f67 7261 6428 290a 2020 2020 2020  no_grad().      
-000204f0: 2020 2e2e 2e20 6465 6620 6261 636b 7761    ... def backwa
-00020500: 7264 5f66 6e28 7361 7665 645f 666f 725f  rd_fn(saved_for_
-00020510: 6261 636b 7761 7264 2c20 636f 7461 6e67  backward, cotang
-00020520: 656e 7473 293a 0a20 2020 2020 2020 202e  ents):.        .
-00020530: 2e2e 2020 2023 2073 6176 6564 5f66 6f72  ..   # saved_for
-00020540: 5f62 6163 6b77 6172 643a 2022 436f 6c6c  _backward: "Coll
-00020550: 6563 7469 6f6e 2220 3d20 2028 7430 2c29  ection" =  (t0,)
-00020560: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
-00020570: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
-00020580: 2023 2063 6f74 616e 6765 6e74 733a 2022   # cotangents: "
-00020590: 6370 7520 6633 325b 5d22 203d 2020 636f  cpu f32[]" =  co
-000205a0: 7461 6e67 656e 7473 2020 2874 7269 7669  tangents  (trivi
-000205b0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
-000205c0: 2020 202e 2e2e 2020 2074 302c 205c 0a20     ...   t0, \. 
-000205d0: 2020 2020 2020 202e 2e2e 2020 203d 2073         ...   = s
-000205e0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000205f0: 640a 2020 2020 2020 2020 2e2e 2e20 2020  d.        ...   
-00020600: 7431 203d 2070 7269 6d73 2e63 6f73 2874  t1 = prims.cos(t
-00020610: 3029 2020 2320 7431 3a20 2263 7075 2066  0)  # t1: "cpu f
-00020620: 3332 5b5d 220a 2020 2020 2020 2020 2e2e  32[]".        ..
-00020630: 2e20 2020 7432 203d 2070 7269 6d73 2e6d  .   t2 = prims.m
-00020640: 756c 2863 6f74 616e 6765 6e74 732c 2074  ul(cotangents, t
-00020650: 3129 2020 2320 7432 3a20 2263 7075 2066  1)  # t2: "cpu f
-00020660: 3332 5b5d 220a 2020 2020 2020 2020 2e2e  32[]".        ..
-00020670: 2e20 2020 7265 7475 726e 2028 7432 2c29  .   return (t2,)
-00020680: 290a 2020 2020 2222 220a 0a20 2020 206f  ).    """..    o
-00020690: 7574 7075 745f 7370 6563 203d 204e 6f6e  utput_spec = Non
-000206a0: 650a 0a20 2020 2064 6566 2061 7567 6d65  e..    def augme
-000206b0: 6e74 6564 5f66 6f72 7761 7264 5f66 6e28  nted_forward_fn(
-000206c0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-000206d0: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
-000206e0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
-000206f0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
-00020700: 6172 6773 2c20 7472 6163 653d 7472 6163  args, trace=trac
-00020710: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-00020720: 2020 2020 2073 6176 6564 5f66 6f72 5f62       saved_for_b
-00020730: 6163 6b77 6172 6420 3d20 6465 636f 6e73  ackward = decons
-00020740: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
-00020750: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
-00020760: 7261 6365 2c20 656e 7629 0a20 2020 2020  race, env).     
-00020770: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
-00020780: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
-00020790: 2020 6e6f 6e6c 6f63 616c 206f 7574 7075    nonlocal outpu
-000207a0: 745f 7370 6563 0a20 2020 2020 2020 2020  t_spec.         
-000207b0: 2020 2066 6c61 745f 6172 6773 2c20 5f20     flat_args, _ 
-000207c0: 3d20 7472 6565 5f66 6c61 7474 656e 2828  = tree_flatten((
-000207d0: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
-000207e0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
-000207f0: 6f75 7470 7574 2c20 6f75 7470 7574 5f73  output, output_s
-00020800: 7065 6320 3d20 7472 6565 5f66 6c61 7474  pec = tree_flatt
-00020810: 656e 2872 6573 756c 7429 0a20 2020 2020  en(result).     
-00020820: 2020 2020 2020 2066 6c61 745f 6f75 7470         flat_outp
-00020830: 7574 203d 2074 7570 6c65 2866 6c61 745f  ut = tuple(flat_
-00020840: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
-00020850: 2020 2020 2320 5365 6520 4e6f 7465 205b      # See Note [
-00020860: 4772 6164 2066 6f72 7761 7264 206f 7574  Grad forward out
-00020870: 7075 7420 7370 6563 5d0a 2020 2020 2020  put spec].      
-00020880: 2020 2020 2020 666f 725f 6175 746f 6772        for_autogr
-00020890: 6164 203d 2054 6f72 6368 4175 746f 6772  ad = TorchAutogr
-000208a0: 6164 466f 7277 6172 6444 6174 6128 0a20  adForwardData(. 
-000208b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000208c0: 6573 756c 742c 0a20 2020 2020 2020 2020  esult,.         
-000208d0: 2020 2020 2020 2066 6c61 745f 6172 6773         flat_args
-000208e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000208f0: 2020 666c 6174 5f6f 7574 7075 742c 0a20    flat_output,. 
-00020900: 2020 2020 2020 2020 2020 2029 2e5f 6173             )._as
-00020910: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
-00020920: 2020 2072 6574 7572 6e20 2866 6f72 5f61     return (for_a
-00020930: 7574 6f67 7261 642c 2073 6176 6564 5f66  utograd, saved_f
-00020940: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
-00020950: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-00020960: 6c74 2c20 7361 7665 645f 666f 725f 6261  lt, saved_for_ba
-00020970: 636b 7761 7264 0a0a 2020 2020 2320 436f  ckward..    # Co
-00020980: 7079 2074 6865 2073 6967 6e61 7475 7265  py the signature
-00020990: 206f 6620 7468 6520 6f72 6967 696e 616c   of the original
-000209a0: 2066 756e 6374 696f 6e20 736f 2074 6861   function so tha
-000209b0: 7420 7468 6520 6172 6775 6d65 6e74 7320  t the arguments 
-000209c0: 6172 650a 2020 2020 2320 6e61 6d65 6420  are.    # named 
-000209d0: 636f 7272 6563 746c 7920 696e 2074 6865  correctly in the
-000209e0: 2061 7567 6d65 6e74 6564 2066 6f72 7761   augmented forwa
-000209f0: 7264 2070 6173 7320 696e 7374 6561 6420  rd pass instead 
-00020a00: 6f66 2062 6569 6e67 206e 616d 6564 0a20  of being named. 
-00020a10: 2020 2023 2022 6172 6773 2220 616e 6420     # "args" and 
-00020a20: 226b 7761 7267 7322 2e0a 2020 2020 6175  "kwargs"..    au
-00020a30: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
-00020a40: 666e 2e5f 5f73 6967 6e61 7475 7265 5f5f  fn.__signature__
-00020a50: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
-00020a60: 7475 7265 2874 7261 6365 2e66 6e20 6f72  ture(trace.fn or
-00020a70: 2074 7261 6365 2e70 7974 686f 6e5f 6361   trace.python_ca
-00020a80: 6c6c 6162 6c65 2829 290a 0a20 2020 2064  llable())..    d
-00020a90: 6566 206f 6e65 735f 6c69 6b65 2878 293a  ef ones_like(x):
-00020aa0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00020ab0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-00020ac0: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
-00020ad0: 2020 2020 7265 7475 726e 2066 756c 6c5f      return full_
-00020ae0: 6c69 6b65 2878 2c20 6669 6c6c 5f76 616c  like(x, fill_val
-00020af0: 7565 3d31 290a 2020 2020 2020 2020 656c  ue=1).        el
-00020b00: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-00020b10: 204e 756d 6265 7250 726f 7879 293a 0a20   NumberProxy):. 
-00020b20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020b30: 6e20 7479 7065 2878 2e76 616c 7565 2928  n type(x.value)(
-00020b40: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
-00020b50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00020b60: 7572 6e20 4e6f 6e65 0a0a 2020 2020 666f  urn None..    fo
-00020b70: 7277 6172 645f 7472 6163 6520 3d20 636f  rward_trace = co
-00020b80: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-00020b90: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00020ba0: 645f 666e 2c20 2a74 7261 6365 2e61 7267  d_fn, *trace.arg
-00020bb0: 732c 202a 2a74 7261 6365 2e6b 7761 7267  s, **trace.kwarg
-00020bc0: 7329 0a20 2020 2023 2057 6520 7365 7420  s).    # We set 
-00020bd0: 666f 7277 6172 6420 7472 6163 6520 746f  forward trace to
-00020be0: 2063 6f6e 7374 7275 6374 2070 726f 7869   construct proxi
-00020bf0: 6573 2062 6563 6175 7365 2077 6520 6e65  es because we ne
-00020c00: 6564 2074 6865 7365 2070 726f 7869 6573  ed these proxies
-00020c10: 2074 6f0a 2020 2020 2320 6861 7665 2064   to.    # have d
-00020c20: 6966 6665 7265 6e74 206e 616d 6573 2074  ifferent names t
-00020c30: 6861 6e20 7468 6520 6f6e 6573 2069 6e20  han the ones in 
-00020c40: 7468 6520 666f 7277 6172 6420 7472 6163  the forward trac
-00020c50: 652e 0a20 2020 2074 7279 3a0a 2020 2020  e..    try:.    
-00020c60: 2020 2020 7472 6163 6563 7478 5f74 6f6b      tracectx_tok
-00020c70: 656e 203d 2073 6574 5f74 7261 6365 6374  en = set_tracect
-00020c80: 7828 666f 7277 6172 645f 7472 6163 6529  x(forward_trace)
-00020c90: 0a20 2020 2020 2020 2023 2057 6520 646f  .        # We do
-00020ca0: 6e27 7420 7761 6e74 2074 6f20 7265 636f  n't want to reco
-00020cb0: 7264 2074 686f 7365 206f 6e65 735f 6c69  rd those ones_li
-00020cc0: 6b65 2063 616c 6c73 2069 6e20 7468 6520  ke calls in the 
-00020cd0: 666f 7277 6172 6420 7472 6163 652e 0a20  forward trace.. 
-00020ce0: 2020 2020 2020 2077 6974 6820 6465 7461         with deta
-00020cf0: 6368 6564 5f74 7261 6365 2829 3a0a 2020  ched_trace():.  
-00020d00: 2020 2020 2020 2020 2020 6966 2074 6f72            if tor
-00020d10: 6368 5f61 7574 6f67 7261 643a 0a20 2020  ch_autograd:.   
-00020d20: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-00020d30: 7427 7320 6173 7375 6d65 6420 7468 6174  t's assumed that
-00020d40: 2066 6f72 7761 7264 5f74 7261 6365 2e6f   forward_trace.o
-00020d50: 7574 7075 745b 305d 2069 7320 6120 6469  utput[0] is a di
-00020d60: 6374 2066 726f 6d20 546f 7263 6841 7574  ct from TorchAut
-00020d70: 6f67 7261 6446 6f72 7761 7264 4461 7461  ogradForwardData
-00020d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020d90: 2066 6c61 745f 6f75 7470 7574 203d 2066   flat_output = f
-00020da0: 6f72 7761 7264 5f74 7261 6365 2e6f 7574  orward_trace.out
-00020db0: 7075 745b 305d 5b22 666c 6174 5f6f 7574  put[0]["flat_out
-00020dc0: 7075 7422 5d0a 2020 2020 2020 2020 2020  put"].          
-00020dd0: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
-00020de0: 203d 2075 7469 6c73 2e73 6571 7565 6e63   = utils.sequenc
-00020df0: 6966 7928 7472 6565 5f6d 6170 286c 616d  ify(tree_map(lam
-00020e00: 6264 6120 763a 206f 6e65 735f 6c69 6b65  bda v: ones_like
-00020e10: 2876 292c 2066 6c61 745f 6f75 7470 7574  (v), flat_output
-00020e20: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-00020e30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00020e40: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
-00020e50: 3d20 7574 696c 732e 7365 7175 656e 6369  = utils.sequenci
-00020e60: 6679 2874 7265 655f 6d61 7028 6c61 6d62  fy(tree_map(lamb
-00020e70: 6461 2076 3a20 6f6e 6573 5f6c 696b 6528  da v: ones_like(
-00020e80: 7629 2c20 7472 6163 652e 6f75 7470 7574  v), trace.output
-00020e90: 2929 0a20 2020 2066 696e 616c 6c79 3a0a  )).    finally:.
-00020ea0: 2020 2020 2020 2020 7265 7365 745f 7472          reset_tr
-00020eb0: 6163 6563 7478 2874 7261 6365 6374 785f  acectx(tracectx_
-00020ec0: 746f 6b65 6e29 0a0a 2020 2020 6465 6620  token)..    def 
-00020ed0: 6261 636b 7761 7264 5f66 6e28 7361 7665  backward_fn(save
-00020ee0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-00020ef0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
-00020f00: 2020 2020 2065 6e76 203d 2072 6563 6f6e       env = recon
-00020f10: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
-00020f20: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
-00020f30: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
-00020f40: 5f62 6163 6b77 6172 6429 0a20 2020 2020  _backward).     
-00020f50: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
-00020f60: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
-00020f70: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
-00020f80: 7265 655f 756e 666c 6174 7465 6e28 636f  ree_unflatten(co
-00020f90: 7461 6e67 656e 7473 2c20 6f75 7470 7574  tangents, output
-00020fa0: 5f73 7065 6329 0a20 2020 2020 2020 206f  _spec).        o
-00020fb0: 7574 203d 2062 6163 6b77 6172 645f 7061  ut = backward_pa
-00020fc0: 7373 2865 6e76 2c20 7472 6163 652c 2063  ss(env, trace, c
-00020fd0: 6f74 616e 6765 6e74 7329 0a20 2020 2020  otangents).     
-00020fe0: 2020 2069 6620 746f 7263 685f 6175 746f     if torch_auto
-00020ff0: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
-00021000: 2020 676b 7761 7267 7320 3d20 6f75 745b    gkwargs = out[
-00021010: 2d31 5d20 6966 2069 7369 6e73 7461 6e63  -1] if isinstanc
-00021020: 6528 6f75 745b 2d31 5d2c 2064 6963 7429  e(out[-1], dict)
-00021030: 2065 6c73 6520 7b7d 0a20 2020 2020 2020   else {}.       
-00021040: 2020 2020 2067 6172 6773 203d 206f 7574       gargs = out
-00021050: 5b3a 2d31 5d20 6966 2069 7369 6e73 7461  [:-1] if isinsta
-00021060: 6e63 6528 6f75 745b 2d31 5d2c 2064 6963  nce(out[-1], dic
-00021070: 7429 2065 6c73 6520 6f75 740a 2020 2020  t) else out.    
-00021080: 2020 2020 2020 2020 676b 7761 7267 7320          gkwargs 
-00021090: 3d20 7b6b 3a20 676b 7761 7267 732e 6765  = {k: gkwargs.ge
-000210a0: 7428 6b2c 204e 6f6e 6529 2066 6f72 206b  t(k, None) for k
-000210b0: 2069 6e20 7472 6163 652e 6b77 6172 6773   in trace.kwargs
-000210c0: 7d0a 2020 2020 2020 2020 2020 2020 6f75  }.            ou
-000210d0: 7420 3d20 282a 6761 7267 732c 2067 6b77  t = (*gargs, gkw
-000210e0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-000210f0: 2020 6f75 7420 3d20 7472 6565 5f66 6c61    out = tree_fla
-00021100: 7474 656e 286f 7574 295b 305d 0a20 2020  tten(out)[0].   
-00021110: 2020 2020 2072 6574 7572 6e20 6f75 740a       return out.
-00021120: 0a20 2020 2073 6176 6564 5f66 6f72 5f62  .    saved_for_b
-00021130: 6163 6b77 6172 6420 3d20 666f 7277 6172  ackward = forwar
-00021140: 645f 7472 6163 652e 6f75 7470 7574 5b31  d_trace.output[1
-00021150: 5d0a 2020 2020 6261 636b 7761 7264 5f74  ].    backward_t
-00021160: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-00021170: 5f74 7261 6365 2872 656e 616d 655f 7072  _trace(rename_pr
-00021180: 6f78 6965 733d 4661 6c73 6529 2862 6163  oxies=False)(bac
-00021190: 6b77 6172 645f 666e 2c20 7361 7665 645f  kward_fn, saved_
-000211a0: 666f 725f 6261 636b 7761 7264 2c20 636f  for_backward, co
-000211b0: 7461 6e67 656e 7473 290a 0a20 2020 2023  tangents)..    #
-000211c0: 2057 6520 6172 6520 646f 6e65 2077 6974   We are done wit
-000211d0: 6820 636f 6e73 7472 7563 7469 6e67 2074  h constructing t
-000211e0: 6865 2066 6f72 7761 7264 2061 6e64 2062  he forward and b
-000211f0: 6163 6b77 6172 6420 7061 7373 6573 2061  ackward passes a
-00021200: 7420 7468 6973 0a20 2020 2023 2073 7461  t this.    # sta
-00021210: 6765 2e20 5468 6520 666f 6c6c 6f77 696e  ge. The followin
-00021220: 6720 6973 206e 6f74 2073 7472 6963 746c  g is not strictl
-00021230: 7920 6e65 6365 7373 6172 792c 2062 7574  y necessary, but
-00021240: 2069 7427 7320 676f 6f64 2074 6f20 6669   it's good to fi
-00021250: 6c74 6572 0a20 2020 2023 206f 7574 2074  lter.    # out t
-00021260: 6865 2075 6e75 7365 6420 656c 656d 656e  he unused elemen
-00021270: 7473 206f 6620 7468 6520 7361 7665 645f  ts of the saved_
-00021280: 666f 725f 6261 636b 7761 7264 2061 6e64  for_backward and
-00021290: 2066 6c61 7474 656e 2069 7420 666f 7220   flatten it for 
-000212a0: 6d6f 7265 0a20 2020 2023 2063 6f6d 7061  more.    # compa
-000212b0: 6374 2062 6163 6b77 6172 6420 7472 6163  ct backward trac
-000212c0: 652e 0a0a 2020 2020 2320 4e6f 7720 7765  e...    # Now we
-000212d0: 2063 616e 2064 6574 6572 6d69 6e65 2065   can determine e
-000212e0: 7861 6374 6c79 2077 6861 7427 7320 7573  xactly what's us
-000212f0: 6564 2069 6e20 7468 6520 6261 636b 7761  ed in the backwa
-00021300: 7264 2070 6173 7320 6672 6f6d 2074 6865  rd pass from the
-00021310: 0a20 2020 2023 2073 6176 6564 5f66 6f72  .    # saved_for
-00021320: 5f62 6163 6b77 6172 642e 2057 6520 6361  _backward. We ca
-00021330: 6e20 666c 6174 7465 6e20 616e 6420 6669  n flatten and fi
-00021340: 6c74 6572 2074 6865 2073 6176 6564 5f66  lter the saved_f
-00021350: 6f72 5f62 6163 6b77 6172 640a 2020 2020  or_backward.    
-00021360: 636f 6e73 756d 6572 7320 3d20 7574 696c  consumers = util
-00021370: 732e 636f 6e73 756d 6572 7328 6261 636b  s.consumers(back
-00021380: 7761 7264 5f74 7261 6365 290a 0a20 2020  ward_trace)..   
-00021390: 2023 2046 6f72 7761 7264 2773 2061 6e64   # Forward's and
-000213a0: 2062 6163 6b77 6172 6427 7320 2273 6176   backward's "sav
-000213b0: 6564 5f66 6f72 5f62 6163 6b77 6172 6422  ed_for_backward"
-000213c0: 2061 7265 206e 6f74 206e 6563 6573 7361   are not necessa
-000213d0: 7269 6c79 2074 6865 2073 616d 650a 2020  rily the same.  
-000213e0: 2020 2320 6173 2074 6865 2073 6176 6564    # as the saved
-000213f0: 5f66 6f72 5f62 6163 6b77 6172 642c 2062  _for_backward, b
-00021400: 6563 6175 7365 2073 6f6d 6520 6f72 2061  ecause some or a
-00021410: 6c6c 2065 6c65 6d65 6e74 7320 6f66 2074  ll elements of t
-00021420: 6865 0a20 2020 2023 2073 6176 6564 5f66  he.    # saved_f
-00021430: 6f72 5f62 6163 6b77 6172 6420 7265 7375  or_backward resu
-00021440: 6c74 7320 6d69 6768 7420 6265 2072 652d  lts might be re-
-00021450: 7072 6f78 6966 6965 642e 0a20 2020 2062  proxified..    b
-00021460: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
-00021470: 5f62 6163 6b77 6172 642c 2073 7065 6320  _backward, spec 
-00021480: 3d20 7472 6565 5f66 6c61 7474 656e 2862  = tree_flatten(b
-00021490: 6163 6b77 6172 645f 7472 6163 652e 6172  ackward_trace.ar
-000214a0: 6773 5b30 5d29 0a20 2020 2066 775f 666c  gs[0]).    fw_fl
-000214b0: 6174 5f73 6176 6564 5f66 6f72 5f62 6163  at_saved_for_bac
-000214c0: 6b77 6172 642c 205f 203d 2074 7265 655f  kward, _ = tree_
-000214d0: 666c 6174 7465 6e28 666f 7277 6172 645f  flatten(forward_
-000214e0: 7472 6163 652e 6f75 7470 7574 5b31 5d29  trace.output[1])
-000214f0: 0a20 2020 2075 7365 645f 6d61 736b 203d  .    used_mask =
-00021500: 206c 6973 7428 6c65 6e28 636f 6e73 756d   list(len(consum
-00021510: 6572 732e 6765 7428 782c 2028 2929 2920  ers.get(x, ())) 
-00021520: 3e20 3020 666f 7220 7820 696e 2062 775f  > 0 for x in bw_
-00021530: 666c 6174 5f73 6176 6564 5f66 6f72 5f62  flat_saved_for_b
-00021540: 6163 6b77 6172 6429 0a0a 2020 2020 2320  ackward)..    # 
-00021550: 446f 6e27 7420 7573 6520 7468 6520 7361  Don't use the sa
-00021560: 6d65 2076 6172 6961 626c 6520 7477 6963  me variable twic
-00021570: 6520 696e 2074 6865 2062 6163 6b77 6172  e in the backwar
-00021580: 6420 7061 7373 0a20 2020 2073 6565 6e20  d pass.    seen 
-00021590: 3d20 7365 7428 290a 2020 2020 6672 6f6d  = set().    from
-000215a0: 2074 6875 6e64 6572 2e63 6f72 652e 7072   thunder.core.pr
-000215b0: 6f78 6965 7320 696d 706f 7274 2056 6172  oxies import Var
-000215c0: 6961 626c 650a 0a20 2020 2066 6f72 2069  iable..    for i
-000215d0: 2c20 7820 696e 2065 6e75 6d65 7261 7465  , x in enumerate
-000215e0: 2866 775f 666c 6174 5f73 6176 6564 5f66  (fw_flat_saved_f
-000215f0: 6f72 5f62 6163 6b77 6172 6429 3a0a 2020  or_backward):.  
-00021600: 2020 2020 2020 7820 3d20 7661 7269 6162        x = variab
-00021610: 6c65 6966 7928 7829 0a20 2020 2020 2020  leify(x).       
-00021620: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00021630: 6365 2878 2c20 5661 7269 6162 6c65 293a  ce(x, Variable):
-00021640: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00021650: 7469 6e75 650a 2020 2020 2020 2020 6966  tinue.        if
-00021660: 2078 2069 6e20 7365 656e 3a0a 2020 2020   x in seen:.    
-00021670: 2020 2020 2020 2020 7573 6564 5f6d 6173          used_mas
-00021680: 6b5b 695d 203d 2046 616c 7365 0a20 2020  k[i] = False.   
-00021690: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000216a0: 2020 2020 2020 2073 6565 6e2e 6164 6428         seen.add(
-000216b0: 7829 0a0a 2020 2020 6f6e 6c79 5f75 7365  x)..    only_use
-000216c0: 645f 6677 5f73 6176 6564 5f66 6f72 5f62  d_fw_saved_for_b
-000216d0: 6163 6b77 6172 6420 3d20 7475 706c 6528  ackward = tuple(
-000216e0: 636f 6d70 7265 7373 2866 775f 666c 6174  compress(fw_flat
-000216f0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-00021700: 6172 642c 2075 7365 645f 6d61 736b 2929  ard, used_mask))
-00021710: 0a20 2020 206f 6e6c 795f 7573 6564 5f62  .    only_used_b
-00021720: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
-00021730: 7761 7264 203d 2074 7570 6c65 2863 6f6d  ward = tuple(com
-00021740: 7072 6573 7328 6277 5f66 6c61 745f 7361  press(bw_flat_sa
-00021750: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021760: 2c20 7573 6564 5f6d 6173 6b29 290a 0a20  , used_mask)).. 
-00021770: 2020 2023 2057 6520 6e65 6564 2074 6f20     # We need to 
-00021780: 7570 6461 7465 2074 6865 2074 7261 6365  update the trace
-00021790: 7320 7769 7468 2074 6865 206e 6577 2073  s with the new s
-000217a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000217b0: 640a 2020 2020 5f75 7064 6174 655f 666f  d.    _update_fo
-000217c0: 7277 6172 645f 7769 7468 5f6e 6577 5f73  rward_with_new_s
-000217d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000217e0: 6428 666f 7277 6172 645f 7472 6163 652c  d(forward_trace,
-000217f0: 206f 6e6c 795f 7573 6564 5f66 775f 7361   only_used_fw_sa
-00021800: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021810: 290a 2020 2020 5f75 7064 6174 655f 6261  ).    _update_ba
-00021820: 636b 7761 7264 5f77 6974 685f 6e65 775f  ckward_with_new_
-00021830: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021840: 7264 2862 6163 6b77 6172 645f 7472 6163  rd(backward_trac
-00021850: 652c 206f 6e6c 795f 7573 6564 5f62 775f  e, only_used_bw_
-00021860: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021870: 7264 290a 2020 2020 666f 7277 6172 645f  rd).    forward_
-00021880: 7472 6163 652e 7365 745f 7072 6f76 656e  trace.set_proven
-00021890: 616e 6365 2854 7261 6365 5072 6f76 656e  ance(TraceProven
-000218a0: 616e 6365 2822 4175 676d 656e 7465 6420  ance("Augmented 
-000218b0: 666f 7277 6172 6420 7061 7373 2229 290a  forward pass")).
-000218c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-000218d0: 6365 2e73 6574 5f70 726f 7665 6e61 6e63  ce.set_provenanc
-000218e0: 6528 5472 6163 6550 726f 7665 6e61 6e63  e(TraceProvenanc
-000218f0: 6528 2242 6163 6b77 6172 6420 7061 7373  e("Backward pass
-00021900: 2229 290a 2020 2020 7265 7475 726e 2046  ")).    return F
-00021910: 6f72 7761 7264 4261 636b 7761 7264 5472  orwardBackwardTr
-00021920: 6163 6573 2866 6f72 7761 7264 5f74 7261  aces(forward_tra
-00021930: 6365 2c20 6261 636b 7761 7264 5f74 7261  ce, backward_tra
-00021940: 6365 290a 0a0a 2320 646f 2077 6520 6861  ce)...# do we ha
-00021950: 7070 656e 2074 6f20 7761 6e74 2074 6f20  ppen to want to 
-00021960: 7265 6769 7374 6572 2060 6c74 6f72 6368  register `ltorch
-00021970: 6020 6f70 7320 7375 6368 2061 7320 606c  ` ops such as `l
-00021980: 746f 7263 682e 6c61 7965 725f 6e6f 726d  torch.layer_norm
-00021990: 6020 6173 2077 656c 6c3f 0a61 7574 6f63  ` as well?.autoc
-000219a0: 6173 745f 696d 706c 733a 2064 6963 745b  ast_impls: dict[
-000219b0: 7072 696d 732e 5072 696d 4944 732c 2043  prims.PrimIDs, C
-000219c0: 616c 6c61 626c 655d 203d 207b 7d0a 0a0a  allable] = {}...
-000219d0: 6465 6620 7265 6769 7374 6572 5f61 7574  def register_aut
-000219e0: 6f63 6173 745f 7275 6c65 286f 7029 3a0a  ocast_rule(op):.
-000219f0: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
-00021a00: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
-00021a10: 2061 7574 6f63 6173 745f 696d 706c 735b   autocast_impls[
-00021a20: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
-00021a30: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
-00021a40: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
-00021a50: 6174 6f72 0a0a 0a64 6566 206d 6179 6265  ator...def maybe
-00021a60: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
-00021a70: 7065 2c20 6172 6773 293a 0a20 2020 2061  pe, args):.    a
-00021a80: 6c6c 6f77 6564 5f64 6f77 6e63 6173 745f  llowed_downcast_
-00021a90: 7479 7065 7320 3d20 2864 7479 7065 732e  types = (dtypes.
-00021aa0: 666c 6f61 7431 362c 2064 7479 7065 732e  float16, dtypes.
-00021ab0: 6266 6c6f 6174 3136 2c20 6474 7970 6573  bfloat16, dtypes
-00021ac0: 2e66 6c6f 6174 3332 290a 0a20 2020 2064  .float32)..    d
-00021ad0: 6566 206d 6170 5f66 6e28 6129 3a0a 2020  ef map_fn(a):.  
-00021ae0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00021af0: 6e63 6528 612c 2054 656e 736f 7250 726f  nce(a, TensorPro
-00021b00: 7879 2920 616e 6420 612e 6474 7970 6520  xy) and a.dtype 
-00021b10: 696e 2061 6c6c 6f77 6564 5f64 6f77 6e63  in allowed_downc
-00021b20: 6173 745f 7479 7065 733a 0a20 2020 2020  ast_types:.     
-00021b30: 2020 2020 2020 2072 6574 7572 6e20 6d61         return ma
-00021b40: 7962 655f 636f 6e76 6572 745f 746f 5f64  ybe_convert_to_d
-00021b50: 7479 7065 2861 2c20 6474 7970 6529 0a20  type(a, dtype). 
-00021b60: 2020 2020 2020 2072 6574 7572 6e20 610a         return a.
-00021b70: 0a20 2020 2072 6574 7572 6e20 7472 6565  .    return tree
-00021b80: 5f6d 6170 286d 6170 5f66 6e2c 2061 7267  _map(map_fn, arg
-00021b90: 7329 0a0a 0a40 7265 6769 7374 6572 5f61  s)...@register_a
-00021ba0: 7574 6f63 6173 745f 7275 6c65 2822 746f  utocast_rule("to
-00021bb0: 7263 682e 6d61 746d 756c 2229 0a40 7265  rch.matmul").@re
-00021bc0: 6769 7374 6572 5f61 7574 6f63 6173 745f  gister_autocast_
-00021bd0: 7275 6c65 2870 7269 6d73 2e50 7269 6d49  rule(prims.PrimI
-00021be0: 4473 2e4d 4154 4d55 4c29 0a64 6566 2061  Ds.MATMUL).def a
-00021bf0: 7574 6f63 6173 745f 6d61 746d 756c 5f72  utocast_matmul_r
-00021c00: 756c 6528 612c 2062 2c20 6474 7970 6529  ule(a, b, dtype)
-00021c10: 3a0a 2020 2020 2222 2241 7574 6f63 6173  :.    """Autocas
-00021c20: 7420 7275 6c65 2066 6f72 206d 6174 6d75  t rule for matmu
-00021c30: 6c22 2222 0a20 2020 2072 6574 7572 6e20  l""".    return 
-00021c40: 7072 696d 732e 6d61 746d 756c 282a 286d  prims.matmul(*(m
-00021c50: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-00021c60: 2864 7479 7065 2c20 2861 2c20 6229 2929  (dtype, (a, b)))
-00021c70: 290a 0a0a 4072 6567 6973 7465 725f 6175  )...@register_au
-00021c80: 746f 6361 7374 5f72 756c 6528 2274 6f72  tocast_rule("tor
-00021c90: 6368 2e6e 6e2e 6675 6e63 7469 6f6e 616c  ch.nn.functional
-00021ca0: 2e6c 696e 6561 7222 290a 4072 6567 6973  .linear").@regis
-00021cb0: 7465 725f 6175 746f 6361 7374 5f72 756c  ter_autocast_rul
-00021cc0: 6528 7072 696d 732e 5072 696d 4944 732e  e(prims.PrimIDs.
-00021cd0: 4c49 4e45 4152 290a 6465 6620 6175 746f  LINEAR).def auto
-00021ce0: 6361 7374 5f6c 696e 6561 725f 7275 6c65  cast_linear_rule
-00021cf0: 2861 2c20 772c 2062 6961 732c 2064 7479  (a, w, bias, dty
-00021d00: 7065 293a 0a20 2020 2069 6620 6269 6173  pe):.    if bias
-00021d10: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00021d20: 2020 2320 446f 6e27 7420 7061 7373 2060    # Don't pass `
-00021d30: 6269 6173 6020 746f 206d 6179 6265 5f64  bias` to maybe_d
-00021d40: 6f77 6e63 6173 745f 746f 2e0a 2020 2020  owncast_to..    
-00021d50: 2020 2020 646f 776e 6361 7374 5f61 7267      downcast_arg
-00021d60: 7320 3d20 6d61 7962 655f 646f 776e 6361  s = maybe_downca
-00021d70: 7374 5f74 6f28 6474 7970 652c 2028 612c  st_to(dtype, (a,
-00021d80: 2077 2929 202b 2028 6269 6173 2c29 0a20   w)) + (bias,). 
-00021d90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021da0: 2064 6f77 6e63 6173 745f 6172 6773 203d   downcast_args =
-00021db0: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
-00021dc0: 746f 2864 7479 7065 2c20 2861 2c20 772c  to(dtype, (a, w,
-00021dd0: 2062 6961 7329 290a 0a20 2020 2072 6574   bias))..    ret
-00021de0: 7572 6e20 7072 696d 732e 6c69 6e65 6172  urn prims.linear
-00021df0: 282a 646f 776e 6361 7374 5f61 7267 7329  (*downcast_args)
-00021e00: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
-00021e10: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
-00021e20: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
-00021e30: 7363 616c 6564 5f64 6f74 5f70 726f 6475  scaled_dot_produ
-00021e40: 6374 5f61 7474 656e 7469 6f6e 2229 0a64  ct_attention").d
-00021e50: 6566 2061 7574 6f63 6173 745f 7363 616c  ef autocast_scal
-00021e60: 6564 5f64 6f74 5f70 726f 6475 6374 5f61  ed_dot_product_a
-00021e70: 7474 656e 7469 6f6e 280a 2020 2020 7175  ttention(.    qu
-00021e80: 6572 792c 0a20 2020 206b 6579 2c0a 2020  ery,.    key,.  
-00021e90: 2020 7661 6c75 652c 0a20 2020 2061 7474    value,.    att
-00021ea0: 6e5f 6d61 736b 2c0a 2020 2020 6472 6f70  n_mask,.    drop
-00021eb0: 6f75 745f 702c 0a20 2020 2069 735f 6361  out_p,.    is_ca
-00021ec0: 7573 616c 2c0a 2020 2020 2a2c 0a20 2020  usal,.    *,.   
-00021ed0: 2064 7479 7065 2c0a 2020 2020 7363 616c   dtype,.    scal
-00021ee0: 652c 0a29 3a0a 2020 2020 6672 6f6d 2074  e,.):.    from t
-00021ef0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00021f00: 6f72 7420 7363 616c 6564 5f64 6f74 5f70  ort scaled_dot_p
-00021f10: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
-00021f20: 0a0a 2020 2020 712c 206b 2c20 7620 3d20  ..    q, k, v = 
-00021f30: 6d61 7962 655f 646f 776e 6361 7374 5f74  maybe_downcast_t
-00021f40: 6f28 6474 7970 652c 2028 7175 6572 792c  o(dtype, (query,
-00021f50: 206b 6579 2c20 7661 6c75 6529 290a 2020   key, value)).  
-00021f60: 2020 7265 7475 726e 2073 6361 6c65 645f    return scaled_
-00021f70: 646f 745f 7072 6f64 7563 745f 6174 7465  dot_product_atte
-00021f80: 6e74 696f 6e28 712c 206b 2c20 762c 2061  ntion(q, k, v, a
-00021f90: 7474 6e5f 6d61 736b 2c20 6472 6f70 6f75  ttn_mask, dropou
-00021fa0: 745f 702c 2069 735f 6361 7573 616c 2c20  t_p, is_causal, 
-00021fb0: 7363 616c 653d 7363 616c 6529 0a0a 0a64  scale=scale)...d
-00021fc0: 6566 2061 7574 6f63 6173 745f 7379 6d62  ef autocast_symb
-00021fd0: 6f6c 5f6d 6170 7065 7228 626f 756e 645f  ol_mapper(bound_
-00021fe0: 7379 6d62 6f6c 3a20 426f 756e 6453 796d  symbol: BoundSym
-00021ff0: 626f 6c49 6e74 6572 6661 6365 2c20 6474  bolInterface, dt
-00022000: 7970 653a 2064 7479 7065 732e 6474 7970  ype: dtypes.dtyp
-00022010: 6529 3a0a 2020 2020 2222 2252 6574 7572  e):.    """Retur
-00022020: 6e20 7468 6520 6361 6c6c 6162 6c65 2069  n the callable i
-00022030: 6d70 6c65 6d65 6e74 696e 6720 7468 6520  mplementing the 
-00022040: 6175 746f 6361 7374 2072 756c 6520 666f  autocast rule fo
-00022050: 7220 7468 6520 7379 6d62 6f6c 2e0a 0a20  r the symbol... 
-00022060: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00022070: 2062 6f75 6e64 5f73 796d 626f 6c3a 204d   bound_symbol: M
-00022080: 6170 7065 6420 746f 2069 7473 2061 7574  apped to its aut
-00022090: 6f63 6173 7420 7275 6c65 2e0a 0a20 2020  ocast rule...   
-000220a0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-000220b0: 2020 4361 6c6c 6162 6c65 3a20 5468 6520    Callable: The 
-000220c0: 6361 6c6c 6162 6c65 2069 6d70 6c65 6d65  callable impleme
-000220d0: 6e74 696e 6720 7468 6520 6175 746f 6361  nting the autoca
-000220e0: 7374 2072 756c 6520 666f 7220 7468 6520  st rule for the 
-000220f0: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
-00022100: 2020 2020 6175 746f 6361 7374 5f69 6d70      autocast_imp
-00022110: 6c3a 2043 616c 6c61 626c 6520 7c20 4e6f  l: Callable | No
-00022120: 6e65 203d 2061 7574 6f63 6173 745f 696d  ne = autocast_im
-00022130: 706c 732e 6765 7428 626f 756e 645f 7379  pls.get(bound_sy
-00022140: 6d62 6f6c 2e73 796d 2e69 6429 0a20 2020  mbol.sym.id).   
-00022150: 2072 6574 7572 6e20 626f 756e 645f 7379   return bound_sy
-00022160: 6d62 6f6c 2e73 796d 2069 6620 6175 746f  mbol.sym if auto
-00022170: 6361 7374 5f69 6d70 6c20 6973 204e 6f6e  cast_impl is Non
-00022180: 6520 656c 7365 2070 6172 7469 616c 2861  e else partial(a
-00022190: 7574 6f63 6173 745f 696d 706c 2c20 6474  utocast_impl, dt
-000221a0: 7970 653d 6474 7970 6529 0a0a 0a64 6566  ype=dtype)...def
-000221b0: 2061 7574 6f63 6173 7428 6675 6e63 3a20   autocast(func: 
-000221c0: 4361 6c6c 6162 6c65 2c20 6474 7970 653a  Callable, dtype:
-000221d0: 2064 7479 7065 732e 6474 7970 6529 3a0a   dtypes.dtype):.
-000221e0: 2020 2020 2222 2254 7261 6e73 666f 726d      """Transform
-000221f0: 7320 6120 6675 6e63 7469 6f6e 2074 6f20  s a function to 
-00022200: 6175 746f 6361 7374 2063 6572 7461 696e  autocast certain
-00022210: 206f 7065 7261 7469 6f6e 732e 0a0a 2020   operations...  
-00022220: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00022230: 6675 6e63 3a20 5468 6520 6675 6e63 7469  func: The functi
-00022240: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
-00022250: 726d 6564 2e0a 2020 2020 2020 2020 6474  rmed..        dt
-00022260: 7970 653a 2054 6865 2064 6174 6120 7479  ype: The data ty
-00022270: 7065 2074 6f20 7768 6963 6820 6172 6775  pe to which argu
-00022280: 6d65 6e74 7320 6f66 2074 6865 2066 756e  ments of the fun
-00022290: 6374 696f 6e20 6f72 2073 7562 2066 756e  ction or sub fun
-000222a0: 6374 696f 6e73 2063 6f75 6c64 2067 6574  ctions could get
-000222b0: 2063 6173 7420 6966 0a20 2020 2020 2020   cast if.       
-000222c0: 2020 2020 2074 6865 7920 6172 6520 6064       they are `d
-000222d0: 7479 7065 732e 666c 6f61 7433 3260 2e0a  types.float32`..
-000222e0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-000222f0: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
-00022300: 5468 6520 7472 616e 7366 6f72 6d65 6420  The transformed 
-00022310: 6675 6e63 7469 6f6e 0a20 2020 2022 2222  function.    """
-00022320: 0a0a 2020 2020 6966 206e 6f74 2069 7369  ..    if not isi
-00022330: 6e73 7461 6e63 6528 6474 7970 652c 2064  nstance(dtype, d
-00022340: 7479 7065 732e 6474 7970 6529 3a0a 2020  types.dtype):.  
-00022350: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00022360: 6545 7272 6f72 2866 2260 6474 7970 6560  eError(f"`dtype`
-00022370: 2069 7320 6578 7065 6374 6564 2074 6f20   is expected to 
-00022380: 6265 2060 7468 756e 6465 722e 6474 7970  be `thunder.dtyp
-00022390: 652e 6474 7970 6560 2062 7574 207b 7479  e.dtype` but {ty
-000223a0: 7065 2864 7479 7065 297d 2229 0a20 2020  pe(dtype)}").   
-000223b0: 2069 6620 6474 7970 6520 6e6f 7420 696e   if dtype not in
-000223c0: 207b 6474 7970 6573 2e66 6c6f 6174 3136   {dtypes.float16
-000223d0: 2c20 6474 7970 6573 2e62 666c 6f61 7431  , dtypes.bfloat1
-000223e0: 367d 3a0a 2020 2020 2020 2020 7261 6973  6}:.        rais
-000223f0: 6520 5661 6c75 6545 7272 6f72 2866 2260  e ValueError(f"`
-00022400: 6474 7970 6560 2069 7320 6578 7065 6374  dtype` is expect
-00022410: 6564 2074 6f20 6265 2065 6974 6865 7220  ed to be either 
-00022420: 6074 6875 6e64 6572 2e66 6c6f 6174 3136  `thunder.float16
-00022430: 6020 6f72 2060 7468 756e 6465 722e 6266  ` or `thunder.bf
-00022440: 6c6f 6174 3136 602c 2062 7574 207b 6474  loat16`, but {dt
-00022450: 7970 657d 2229 0a0a 2020 2020 4077 7261  ype}")..    @wra
-00022460: 7073 2866 756e 6329 0a20 2020 2064 6566  ps(func).    def
-00022470: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
-00022480: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00022490: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-000224a0: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
-000224b0: 632c 202a 6172 6773 2c20 2a2a 6b77 6172  c, *args, **kwar
-000224c0: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
-000224d0: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
-000224e0: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
-000224f0: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
-00022500: 7065 723d 7061 7274 6961 6c28 6175 746f  per=partial(auto
-00022510: 6361 7374 5f73 796d 626f 6c5f 6d61 7070  cast_symbol_mapp
-00022520: 6572 2c20 6474 7970 653d 6474 7970 6529  er, dtype=dtype)
-00022530: 290a 0a20 2020 2072 6574 7572 6e20 7772  )..    return wr
-00022540: 6170 7065 720a                           apper.
+0000edf0: 696d 656e 7369 6f6e 7320 3d20 2830 2c29  imensions = (0,)
+0000ee00: 202b 2074 7570 6c65 2864 696d 202b 2031   + tuple(dim + 1
+0000ee10: 2069 6620 6469 6d20 3e3d 2062 6469 6d20   if dim >= bdim 
+0000ee20: 656c 7365 2064 696d 2066 6f72 2064 696d  else dim for dim
+0000ee30: 2069 6e20 6272 6f61 6463 6173 745f 6469   in broadcast_di
+0000ee40: 6d65 6e73 696f 6e73 290a 2020 2020 2020  mensions).      
+0000ee50: 2020 6966 2062 726f 6164 6361 7374 5f64    if broadcast_d
+0000ee60: 696d 656e 7369 6f6e 7320 3d3d 2028 293a  imensions == ():
+0000ee70: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+0000ee80: 5f62 726f 6164 6361 7374 5f64 696d 656e  _broadcast_dimen
+0000ee90: 7369 6f6e 7320 3d20 2829 0a20 2020 2020  sions = ().     
+0000eea0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
+0000eeb0: 6456 616c 7565 2870 7269 6d73 2e62 726f  dValue(prims.bro
+0000eec0: 6164 6361 7374 5f69 6e5f 6469 6d28 612e  adcast_in_dim(a.
+0000eed0: 7661 6c75 652c 206e 6577 5f73 6861 7065  value, new_shape
+0000eee0: 2c20 6e65 775f 6272 6f61 6463 6173 745f  , new_broadcast_
+0000eef0: 6469 6d65 6e73 696f 6e73 292c 206e 6577  dimensions), new
+0000ef00: 5f62 6469 6d29 0a0a 0a76 6d61 705f 696d  _bdim)...vmap_im
+0000ef10: 706c 733a 2064 6963 745b 7072 696d 732e  pls: dict[prims.
+0000ef20: 5379 6d62 6f6c 2c20 4361 6c6c 6162 6c65  Symbol, Callable
+0000ef30: 5d20 3d20 6469 6374 2829 0a0a 0a64 6566  ] = dict()...def
+0000ef40: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
+0000ef50: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
+0000ef60: 7472 6163 6529 3a0a 2020 2020 6e65 775f  trace):.    new_
+0000ef70: 7379 6d62 6f6c 735f 6974 6572 203d 2028  symbols_iter = (
+0000ef80: 0a20 2020 2020 2020 2062 6f75 6e64 5f73  .        bound_s
+0000ef90: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
+0000efa0: 2069 6620 6c65 6e28 626f 756e 645f 7379   if len(bound_sy
+0000efb0: 6d62 6f6c 2e73 7562 7379 6d62 6f6c 7329  mbol.subsymbols)
+0000efc0: 203e 2030 2065 6c73 6520 5b62 6f75 6e64   > 0 else [bound
+0000efd0: 5f73 796d 626f 6c5d 0a20 2020 2020 2020  _symbol].       
+0000efe0: 2066 6f72 2062 6f75 6e64 5f73 796d 626f   for bound_symbo
+0000eff0: 6c20 696e 2074 7261 6365 2e62 6f75 6e64  l in trace.bound
+0000f000: 5f73 796d 626f 6c73 0a20 2020 2029 0a20  _symbols.    ). 
+0000f010: 2020 206e 6577 5f73 796d 626f 6c73 203d     new_symbols =
+0000f020: 206c 6973 7428 6368 6169 6e2e 6672 6f6d   list(chain.from
+0000f030: 5f69 7465 7261 626c 6528 6e65 775f 7379  _iterable(new_sy
+0000f040: 6d62 6f6c 735f 6974 6572 2929 0a20 2020  mbols_iter)).   
+0000f050: 2074 7261 6365 2e62 6f75 6e64 5f73 796d   trace.bound_sym
+0000f060: 626f 6c73 203d 206e 6577 5f73 796d 626f  bols = new_symbo
+0000f070: 6c73 0a20 2020 2072 6574 7572 6e20 7472  ls.    return tr
+0000f080: 6163 650a 0a0a 6465 6620 6465 636f 6d70  ace...def decomp
+0000f090: 6f73 6564 5f66 6e5f 766d 6170 5f72 756c  osed_fn_vmap_rul
+0000f0a0: 6528 6178 6973 5f73 697a 652c 202a 6172  e(axis_size, *ar
+0000f0b0: 6773 2c20 666e 2c20 2a2a 6b77 6172 6773  gs, fn, **kwargs
+0000f0c0: 293a 0a20 2020 2061 7267 732c 2069 6e5f  ):.    args, in_
+0000f0d0: 6469 6d73 203d 2075 6e7a 6970 3228 6172  dims = unzip2(ar
+0000f0e0: 6773 290a 2020 2020 756e 6261 7463 6865  gs).    unbatche
+0000f0f0: 645f 6172 6773 203d 2074 7265 655f 6d61  d_args = tree_ma
+0000f100: 7028 6c61 6d62 6461 2078 3a20 7265 6d6f  p(lambda x: remo
+0000f110: 7665 5f62 6174 6368 5f64 696d 2878 2920  ve_batch_dim(x) 
+0000f120: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0000f130: 2054 656e 736f 7250 726f 7879 2920 656c   TensorProxy) el
+0000f140: 7365 2078 2c20 6172 6773 290a 2020 2020  se x, args).    
+0000f150: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
+0000f160: 745f 7472 6163 6528 2928 666e 2c20 2a75  t_trace()(fn, *u
+0000f170: 6e62 6174 6368 6564 5f61 7267 732c 202a  nbatched_args, *
+0000f180: 2a6b 7761 7267 7329 0a20 2020 2074 7261  *kwargs).    tra
+0000f190: 6365 203d 2075 6e77 7261 705f 6f6e 655f  ce = unwrap_one_
+0000f1a0: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
+0000f1b0: 6f6c 7328 7472 6163 6529 0a20 2020 206f  ols(trace).    o
+0000f1c0: 7574 7320 3d20 5f76 6d61 705f 6361 6c6c  uts = _vmap_call
+0000f1d0: 5f6d 6574 6166 756e 6328 4661 6c73 652c  _metafunc(False,
+0000f1e0: 2061 7267 732c 2069 6e5f 6469 6d73 2c20   args, in_dims, 
+0000f1f0: 302c 2061 7869 735f 7369 7a65 2c20 6675  0, axis_size, fu
+0000f200: 6e63 7469 6f6e 5f74 7261 6365 3d74 7261  nction_trace=tra
+0000f210: 6365 2c20 2a2a 6b77 6172 6773 290a 2020  ce, **kwargs).  
+0000f220: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000f230: 6f75 7473 2c20 5365 7175 656e 6365 293a  outs, Sequence):
+0000f240: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
+0000f250: 7320 3d20 2830 2c29 202a 206c 656e 286f  s = (0,) * len(o
+0000f260: 7574 7329 0a20 2020 2020 2020 2072 6574  uts).        ret
+0000f270: 7572 6e20 7361 6665 5f6d 6170 2870 6169  urn safe_map(pai
+0000f280: 725f 746f 5f62 6174 6368 6564 5f76 616c  r_to_batched_val
+0000f290: 7565 2c20 7361 6665 5f7a 6970 286f 7574  ue, safe_zip(out
+0000f2a0: 732c 206f 7574 5f64 696d 7329 290a 2020  s, out_dims)).  
+0000f2b0: 2020 7265 7475 726e 2042 6174 6368 6564    return Batched
+0000f2c0: 5661 6c75 6528 6f75 7473 2c20 3029 0a0a  Value(outs, 0)..
+0000f2d0: 0a76 6d61 705f 696d 706c 735b 7072 696d  .vmap_impls[prim
+0000f2e0: 732e 5072 696d 4944 732e 5349 4e5d 203d  s.PrimIDs.SIN] =
+0000f2f0: 2073 696e 5f76 6d61 700a 766d 6170 5f69   sin_vmap.vmap_i
+0000f300: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+0000f310: 4473 2e43 4f53 5d20 3d20 636f 735f 766d  Ds.COS] = cos_vm
+0000f320: 6170 0a76 6d61 705f 696d 706c 735b 7072  ap.vmap_impls[pr
+0000f330: 696d 732e 5072 696d 4944 732e 4d55 4c5d  ims.PrimIDs.MUL]
+0000f340: 203d 206d 756c 5f76 6d61 700a 766d 6170   = mul_vmap.vmap
+0000f350: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+0000f360: 6d49 4473 2e41 4444 5d20 3d20 6164 645f  mIDs.ADD] = add_
+0000f370: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
+0000f380: 7072 696d 732e 5072 696d 4944 732e 5355  prims.PrimIDs.SU
+0000f390: 4d5d 203d 2073 756d 5f76 6d61 700a 766d  M] = sum_vmap.vm
+0000f3a0: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
+0000f3b0: 7269 6d49 4473 2e42 524f 4144 4341 5354  rimIDs.BROADCAST
+0000f3c0: 5f49 4e5f 4449 4d5d 203d 2062 726f 6164  _IN_DIM] = broad
+0000f3d0: 6361 7374 5f69 6e5f 6469 6d5f 766d 6170  cast_in_dim_vmap
+0000f3e0: 0a0a 0a64 6566 2076 6d61 705f 7379 6d62  ...def vmap_symb
+0000f3f0: 6f6c 5f6d 6170 7065 7228 7379 6d62 6f6c  ol_mapper(symbol
+0000f400: 3a20 7072 696d 732e 5379 6d62 6f6c 2c20  : prims.Symbol, 
+0000f410: 2a2c 2061 7869 735f 7369 7a65 3a20 696e  *, axis_size: in
+0000f420: 7429 3a0a 2020 2020 2222 224d 6170 7320  t):.    """Maps 
+0000f430: 6120 7379 6d62 6f6c 2074 6f20 6120 766d  a symbol to a vm
+0000f440: 6170 2066 756e 6374 696f 6e20 7468 6174  ap function that
+0000f450: 2065 7661 6c75 6174 6573 2069 742e 0a0a   evaluates it...
+0000f460: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000f470: 2020 7379 6d62 6f6c 2028 7072 696d 732e    symbol (prims.
+0000f480: 5379 6d62 6f6c 293a 2053 796d 626f 6c20  Symbol): Symbol 
+0000f490: 746f 2065 7661 6c75 6174 652e 0a0a 2020  to evaluate...  
+0000f4a0: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+0000f4b0: 2020 4e6f 7449 6d70 6c65 6d65 6e74 6564    NotImplemented
+0000f4c0: 4572 726f 723a 2049 6620 7468 6520 766d  Error: If the vm
+0000f4d0: 6170 2066 6f72 2074 6865 2073 796d 626f  ap for the symbo
+0000f4e0: 6c20 6973 206e 6f74 2069 6d70 6c65 6d65  l is not impleme
+0000f4f0: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
+0000f500: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+0000f510: 6162 6c65 3a20 766d 6170 2066 756e 6374  able: vmap funct
+0000f520: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
+0000f530: 6573 2074 6865 2073 796d 626f 6c2e 0a20  es the symbol.. 
+0000f540: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+0000f550: 7772 6170 5f61 7267 2878 293a 0a20 2020  wrap_arg(x):.   
+0000f560: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000f570: 6365 2878 2c20 4261 7463 6865 6456 616c  ce(x, BatchedVal
+0000f580: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
+0000f590: 2072 6574 7572 6e20 780a 2020 2020 2020   return x.      
+0000f5a0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0000f5b0: 6528 782c 204e 756d 6265 7229 3a0a 2020  e(x, Number):.  
+0000f5c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000f5d0: 2042 6174 6368 6564 5661 6c75 6528 782c   BatchedValue(x,
+0000f5e0: 206e 6f74 5f6d 6170 7065 6429 0a20 2020   not_mapped).   
+0000f5f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000f600: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000f610: 7565 4572 726f 7228 6622 766d 6170 2077  ueError(f"vmap w
+0000f620: 7261 705f 6172 6720 676f 7420 616e 2075  rap_arg got an u
+0000f630: 6e73 7570 706f 7274 6564 2074 7970 6520  nsupported type 
+0000f640: 7b74 7970 6528 7829 7d22 290a 0a20 2020  {type(x)}")..   
+0000f650: 2069 6620 7379 6d62 6f6c 2e61 7265 5f61   if symbol.are_a
+0000f660: 6c6c 5f61 7267 735f 636f 6e73 7461 6e74  ll_args_constant
+0000f670: 3a0a 0a20 2020 2020 2020 2064 6566 205f  :..        def _
+0000f680: 766d 6170 5f69 6d70 6c5f 636f 6e73 7428  vmap_impl_const(
+0000f690: 7379 6d62 6f6c 2c20 2a61 7267 732c 202a  symbol, *args, *
+0000f6a0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+0000f6b0: 2020 2020 2020 6f75 7420 3d20 7379 6d62        out = symb
+0000f6c0: 6f6c 5f74 6f5f 6576 616c 2873 796d 626f  ol_to_eval(symbo
+0000f6d0: 6c29 282a 6172 6773 2c20 2a2a 6b77 6172  l)(*args, **kwar
+0000f6e0: 6773 290a 0a20 2020 2020 2020 2020 2020  gs)..           
+0000f6f0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+0000f700: 7574 2c20 5365 7175 656e 6365 293a 0a20  ut, Sequence):. 
+0000f710: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f720: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+0000f730: 6169 725f 746f 5f62 6174 6368 6564 5f76  air_to_batched_v
+0000f740: 616c 7565 2c20 7361 6665 5f7a 6970 2861  alue, safe_zip(a
+0000f750: 7267 732c 205b 6e6f 745f 6d61 7070 6564  rgs, [not_mapped
+0000f760: 5d20 2a20 6c65 6e28 6f75 7429 2929 0a0a  ] * len(out)))..
+0000f770: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000f780: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000f790: 6f75 742c 206e 6f74 5f6d 6170 7065 6429  out, not_mapped)
+0000f7a0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000f7b0: 2070 6172 7469 616c 285f 766d 6170 5f69   partial(_vmap_i
+0000f7c0: 6d70 6c5f 636f 6e73 742c 2073 796d 626f  mpl_const, symbo
+0000f7d0: 6c29 0a0a 2020 2020 766d 6170 5f69 6d70  l)..    vmap_imp
+0000f7e0: 6c20 3d20 766d 6170 5f69 6d70 6c73 2e67  l = vmap_impls.g
+0000f7f0: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
+0000f800: 290a 2020 2020 6966 2076 6d61 705f 696d  ).    if vmap_im
+0000f810: 706c 2069 7320 4e6f 6e65 3a0a 2020 2020  pl is None:.    
+0000f820: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
+0000f830: 6c2e 7375 6273 796d 626f 6c73 2920 3e20  l.subsymbols) > 
+0000f840: 303a 0a20 2020 2020 2020 2020 2020 2076  0:.            v
+0000f850: 6d61 705f 696d 706c 203d 2070 6172 7469  map_impl = parti
+0000f860: 616c 2864 6563 6f6d 706f 7365 645f 666e  al(decomposed_fn
+0000f870: 5f76 6d61 705f 7275 6c65 2c20 666e 3d73  _vmap_rule, fn=s
+0000f880: 796d 626f 6c2e 7379 6d29 0a20 2020 2020  ymbol.sym).     
+0000f890: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f8a0: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+0000f8b0: 706c 656d 656e 7465 6445 7272 6f72 2866  plementedError(f
+0000f8c0: 2276 6d61 7020 666f 7220 7b73 796d 626f  "vmap for {symbo
+0000f8d0: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
+0000f8e0: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
+0000f8f0: 2020 2020 6465 6620 5f76 6d61 705f 696d      def _vmap_im
+0000f900: 706c 282a 6172 6773 2c20 2a2a 6b77 6172  pl(*args, **kwar
+0000f910: 6773 293a 0a20 2020 2020 2020 2061 7267  gs):.        arg
+0000f920: 7320 3d20 7472 6565 5f6d 6170 2877 7261  s = tree_map(wra
+0000f930: 705f 6172 672c 2061 7267 7329 0a20 2020  p_arg, args).   
+0000f940: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+0000f950: 6973 696e 7374 616e 6365 2861 7267 2c20  isinstance(arg, 
+0000f960: 4261 7463 6865 6456 616c 7565 2920 666f  BatchedValue) fo
+0000f970: 7220 6172 6720 696e 2074 7265 655f 666c  r arg in tree_fl
+0000f980: 6174 7465 6e28 6172 6773 295b 305d 290a  atten(args)[0]).
+0000f990: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+0000f9a0: 6d61 705f 696d 706c 2861 7869 735f 7369  map_impl(axis_si
+0000f9b0: 7a65 2c20 2a61 7267 732c 202a 2a6b 7761  ze, *args, **kwa
+0000f9c0: 7267 7329 0a0a 2020 2020 7265 7475 726e  rgs)..    return
+0000f9d0: 205f 766d 6170 5f69 6d70 6c0a 0a0a 6465   _vmap_impl...de
+0000f9e0: 6620 7265 6d6f 7665 5f62 6174 6368 5f64  f remove_batch_d
+0000f9f0: 696d 2874 656e 736f 723a 2054 656e 736f  im(tensor: Tenso
+0000fa00: 7250 726f 7879 2c20 6261 7463 685f 6469  rProxy, batch_di
+0000fa10: 6d3a 2069 6e74 203d 2030 2920 2d3e 2054  m: int = 0) -> T
+0000fa20: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+0000fa30: 2222 2252 656d 6f76 6573 2074 6865 2062  """Removes the b
+0000fa40: 6174 6368 2064 696d 656e 7369 6f6e 2066  atch dimension f
+0000fa50: 726f 6d20 6120 7465 6e73 6f72 2e0a 0a20  rom a tensor... 
+0000fa60: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000fa70: 2074 656e 736f 7220 2854 656e 736f 7250   tensor (TensorP
+0000fa80: 726f 7879 293a 2054 656e 736f 7220 746f  roxy): Tensor to
+0000fa90: 2072 656d 6f76 6520 7468 6520 6261 7463   remove the batc
+0000faa0: 6820 6469 6d65 6e73 696f 6e20 6672 6f6d  h dimension from
+0000fab0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0000fac0: 2020 2020 2020 2020 5465 6e73 6f72 5072          TensorPr
+0000fad0: 6f78 793a 2054 656e 736f 7220 7769 7468  oxy: Tensor with
+0000fae0: 2074 6865 2062 6174 6368 2064 696d 656e   the batch dimen
+0000faf0: 7369 6f6e 2072 656d 6f76 6564 2e0a 2020  sion removed..  
+0000fb00: 2020 2222 220a 2020 2020 6e65 775f 7368    """.    new_sh
+0000fb10: 6170 6520 3d20 7465 6e73 6f72 2e73 6861  ape = tensor.sha
+0000fb20: 7065 5b3a 6261 7463 685f 6469 6d5d 202b  pe[:batch_dim] +
+0000fb30: 2074 656e 736f 722e 7368 6170 655b 6261   tensor.shape[ba
+0000fb40: 7463 685f 6469 6d20 2b20 3120 3a5d 0a20  tch_dim + 1 :]. 
+0000fb50: 2020 2072 6574 7572 6e20 5465 6e73 6f72     return Tensor
+0000fb60: 5072 6f78 7928 6c69 6b65 3d74 656e 736f  Proxy(like=tenso
+0000fb70: 722c 2073 6861 7065 3d6e 6577 5f73 6861  r, shape=new_sha
+0000fb80: 7065 290a 0a0a 2320 544f 444f 3a20 696e  pe)...# TODO: in
+0000fb90: 204a 4158 2061 7267 732c 2069 6e5f 6469   JAX args, in_di
+0000fba0: 6d73 2061 7265 2066 6c61 7474 656e 6564  ms are flattened
+0000fbb0: 2074 6865 2073 616d 6520 7761 790a 2320   the same way.# 
+0000fbc0: 544f 444f 3a20 696e 204a 4158 206f 7574  TODO: in JAX out
+0000fbd0: 5f64 696d 7320 6172 6520 666c 6174 7465  _dims are flatte
+0000fbe0: 6e65 6420 6173 2077 656c 6c0a 6465 6620  ned as well.def 
+0000fbf0: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
+0000fc00: 756e 6328 6465 7461 6368 6564 3a20 626f  unc(detached: bo
+0000fc10: 6f6c 2c20 6172 6773 2c20 696e 5f64 696d  ol, args, in_dim
+0000fc20: 732c 206f 7574 5f64 696d 732c 2061 7869  s, out_dims, axi
+0000fc30: 735f 7369 7a65 2c20 6675 6e63 7469 6f6e  s_size, function
+0000fc40: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
+0000fc50: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+0000fc60: 224d 6574 6166 756e 6374 696f 6e20 666f  "Metafunction fo
+0000fc70: 7220 766d 6170 2063 616c 6c2e 0a0a 2020  r vmap call...  
+0000fc80: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000fc90: 6465 7461 6368 6564 2028 626f 6f6c 293a  detached (bool):
+0000fca0: 2057 6865 7468 6572 2074 6f20 6465 7461   Whether to deta
+0000fcb0: 6368 2074 6865 2074 7261 6365 2e0a 2020  ch the trace..  
+0000fcc0: 2020 2020 2020 6172 6773 2028 5475 706c        args (Tupl
+0000fcd0: 655b 5072 6f78 795d 293a 2041 7267 756d  e[Proxy]): Argum
+0000fce0: 656e 7473 2074 6f20 7468 6520 6675 6e63  ents to the func
+0000fcf0: 7469 6f6e 2e0a 2020 2020 2020 2020 696e  tion..        in
+0000fd00: 5f64 696d 7320 2854 7570 6c65 5b69 6e74  _dims (Tuple[int
+0000fd10: 5d29 3a20 4261 7463 6820 6469 6d65 6e73  ]): Batch dimens
+0000fd20: 696f 6e20 666f 7220 6561 6368 2061 7267  ion for each arg
+0000fd30: 756d 656e 742e 0a20 2020 2020 2020 206f  ument..        o
+0000fd40: 7574 5f64 696d 7320 2854 7570 6c65 5b69  ut_dims (Tuple[i
+0000fd50: 6e74 5d29 3a20 4261 7463 6820 6469 6d65  nt]): Batch dime
+0000fd60: 6e73 696f 6e20 666f 7220 7265 7475 726e  nsion for return
+0000fd70: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
+0000fd80: 2066 756e 6374 696f 6e5f 7472 6163 6520   function_trace 
+0000fd90: 2854 7261 6365 293a 2054 7261 6365 2074  (Trace): Trace t
+0000fda0: 6f20 7573 6520 666f 7220 7468 6520 6675  o use for the fu
+0000fdb0: 6e63 7469 6f6e 2e0a 2020 2020 2020 2020  nction..        
+0000fdc0: 6b77 6172 6773 3a20 4b65 7977 6f72 6420  kwargs: Keyword 
+0000fdd0: 6172 6775 6d65 6e74 732e 0a0a 2020 2020  arguments...    
+0000fde0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+0000fdf0: 4173 7365 7274 696f 6e45 7272 6f72 3a20  AssertionError: 
+0000fe00: 4966 2074 6865 2076 6d61 7020 666f 7220  If the vmap for 
+0000fe10: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
+0000fe20: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
+0000fe30: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
+0000fe40: 6e73 3a0a 2020 2020 2020 2020 5265 7375  ns:.        Resu
+0000fe50: 6c74 206f 6620 7468 6520 766d 6170 2074  lt of the vmap t
+0000fe60: 7261 6e73 666f 726d 2e0a 2020 2020 2222  ransform..    ""
+0000fe70: 220a 2020 2020 636f 6d6d 6f6e 5f64 6576  ".    common_dev
+0000fe80: 6963 6520 3d20 7b78 2e64 6576 6963 6520  ice = {x.device 
+0000fe90: 666f 7220 7820 696e 2061 7267 7320 6966  for x in args if
+0000fea0: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
+0000feb0: 656e 736f 7250 726f 7879 297d 0a20 2020  ensorProxy)}.   
+0000fec0: 2061 7373 6572 7420 6c65 6e28 636f 6d6d   assert len(comm
+0000fed0: 6f6e 5f64 6576 6963 6529 203c 3d20 312c  on_device) <= 1,
+0000fee0: 2022 766d 6170 2066 6f72 206d 756c 7469   "vmap for multi
+0000fef0: 706c 6520 6465 7669 6365 7320 6973 206e  ple devices is n
+0000ff00: 6f74 2069 6d70 6c65 6d65 6e74 6564 220a  ot implemented".
+0000ff10: 2020 2020 2863 6f6d 6d6f 6e5f 6465 7669      (common_devi
+0000ff20: 6365 2c29 203d 2063 6f6d 6d6f 6e5f 6465  ce,) = common_de
+0000ff30: 7669 6365 2069 6620 6c65 6e28 636f 6d6d  vice if len(comm
+0000ff40: 6f6e 5f64 6576 6963 6529 203d 3d20 3120  on_device) == 1 
+0000ff50: 656c 7365 2028 6370 752c 290a 0a20 2020  else (cpu,)..   
+0000ff60: 2069 6620 6178 6973 5f73 697a 6520 6973   if axis_size is
+0000ff70: 204e 6f6e 653a 0a20 2020 2020 2020 2028   None:.        (
+0000ff80: 6178 6973 5f73 697a 652c 2920 3d20 7b78  axis_size,) = {x
+0000ff90: 2e73 6861 7065 5b61 785d 2066 6f72 2078  .shape[ax] for x
+0000ffa0: 2c20 6178 2069 6e20 7a69 7028 6172 6773  , ax in zip(args
+0000ffb0: 2c20 696e 5f64 696d 7329 2069 6620 6178  , in_dims) if ax
+0000ffc0: 2069 7320 6e6f 7420 6e6f 745f 6d61 7070   is not not_mapp
+0000ffd0: 6564 7d0a 2020 2020 696e 5f64 696d 7320  ed}.    in_dims 
+0000ffe0: 3d20 696e 5f64 696d 7320 6966 2069 7369  = in_dims if isi
+0000fff0: 6e73 7461 6e63 6528 696e 5f64 696d 732c  nstance(in_dims,
+00010000: 2053 6571 7565 6e63 6529 2065 6c73 6520   Sequence) else 
+00010010: 2869 6e5f 6469 6d73 2c29 0a20 2020 2069  (in_dims,).    i
+00010020: 6e5f 6469 6d73 203d 2074 7570 6c65 286e  n_dims = tuple(n
+00010030: 6f74 5f6d 6170 7065 6420 6966 2069 7369  ot_mapped if isi
+00010040: 6e73 7461 6e63 6528 612c 204e 756d 6265  nstance(a, Numbe
+00010050: 7229 2065 6c73 6520 6420 666f 7220 612c  r) else d for a,
+00010060: 2064 2069 6e20 7361 6665 5f7a 6970 2861   d in safe_zip(a
+00010070: 7267 732c 2069 6e5f 6469 6d73 2929 0a20  rgs, in_dims)). 
+00010080: 2020 206f 7574 5f64 696d 7320 3d20 6f75     out_dims = ou
+00010090: 745f 6469 6d73 2069 6620 6973 696e 7374  t_dims if isinst
+000100a0: 616e 6365 286f 7574 5f64 696d 732c 2053  ance(out_dims, S
+000100b0: 6571 7565 6e63 6529 2065 6c73 6520 286f  equence) else (o
+000100c0: 7574 5f64 696d 732c 290a 0a20 2020 2063  ut_dims,)..    c
+000100d0: 7478 203d 2064 6574 6163 6865 645f 7472  tx = detached_tr
+000100e0: 6163 6528 2920 6966 2064 6574 6163 6865  ace() if detache
+000100f0: 6420 656c 7365 206e 756c 6c63 6f6e 7465  d else nullconte
+00010100: 7874 2829 0a20 2020 2077 6974 6820 6374  xt().    with ct
+00010110: 783a 0a20 2020 2020 2020 2023 2057 6520  x:.        # We 
+00010120: 7072 6f70 6167 6174 6520 7468 6520 4261  propagate the Ba
+00010130: 7463 6856 616c 7565 2074 6872 6f75 6768  tchValue through
+00010140: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
+00010150: 7468 656e 2075 6e77 7261 7020 6974 2061  then unwrap it a
+00010160: 7420 7468 6520 656e 640a 2020 2020 2020  t the end.      
+00010170: 2020 6261 7463 6865 645f 6172 6773 203d    batched_args =
+00010180: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
+00010190: 6f5f 6261 7463 6865 645f 7661 6c75 652c  o_batched_value,
+000101a0: 2073 6166 655f 7a69 7028 6172 6773 2c20   safe_zip(args, 
+000101b0: 696e 5f64 696d 7329 290a 2020 2020 2020  in_dims)).      
+000101c0: 2020 7265 7375 6c74 203d 2065 7661 6c5f    result = eval_
+000101d0: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
+000101e0: 2020 2066 756e 6374 696f 6e5f 7472 6163     function_trac
+000101f0: 652c 202a 6261 7463 6865 645f 6172 6773  e, *batched_args
+00010200: 2c20 7379 6d62 6f6c 5f6d 6170 7065 723d  , symbol_mapper=
+00010210: 7061 7274 6961 6c28 766d 6170 5f73 796d  partial(vmap_sym
+00010220: 626f 6c5f 6d61 7070 6572 2c20 6178 6973  bol_mapper, axis
+00010230: 5f73 697a 653d 6178 6973 5f73 697a 6529  _size=axis_size)
+00010240: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+00010250: 2020 2029 0a20 2020 2020 2020 2023 2055     ).        # U
+00010260: 6e77 7261 7070 696e 6720 7468 6520 4261  nwrapping the Ba
+00010270: 7463 6865 6456 616c 7565 2773 0a20 2020  tchedValue's.   
+00010280: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00010290: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
+000102a0: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
+000102b0: 2020 666c 6174 5f72 6573 756c 742c 2073    flat_result, s
+000102c0: 7065 6320 3d20 7472 6565 5f66 6c61 7474  pec = tree_flatt
+000102d0: 656e 2872 6573 756c 7429 0a20 2020 2020  en(result).     
+000102e0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+000102f0: 6c28 6973 696e 7374 616e 6365 2878 2c20  l(isinstance(x, 
+00010300: 4261 7463 6865 6456 616c 7565 2920 666f  BatchedValue) fo
+00010310: 7220 7820 696e 2066 6c61 745f 7265 7375  r x in flat_resu
+00010320: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+00010330: 6f75 7473 2c20 6264 696d 7320 3d20 756e  outs, bdims = un
+00010340: 7a69 7032 2866 6c61 745f 7265 7375 6c74  zip2(flat_result
+00010350: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00010360: 544f 444f 3a20 6861 6e64 6c65 2074 6865  TODO: handle the
+00010370: 2063 6173 6520 7768 6572 6520 6f75 745f   case where out_
+00010380: 6469 6d73 2069 7320 6120 7369 6e67 6c65  dims is a single
+00010390: 2076 616c 7565 2062 6574 7465 720a 2020   value better.  
+000103a0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+000103b0: 286f 7574 5f64 696d 7329 203d 3d20 313a  (out_dims) == 1:
+000103c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000103d0: 206f 7574 5f64 696d 7320 3d20 6f75 745f   out_dims = out_
+000103e0: 6469 6d73 202a 206c 656e 286f 7574 7329  dims * len(outs)
+000103f0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00010400: 7320 3d20 7361 6665 5f6d 6170 2870 6172  s = safe_map(par
+00010410: 7469 616c 286d 6f76 655f 6261 7463 685f  tial(move_batch_
+00010420: 6469 6d2c 2061 7869 735f 7369 7a65 292c  dim, axis_size),
+00010430: 2062 6469 6d73 2c20 6f75 745f 6469 6d73   bdims, out_dims
+00010440: 2c20 6f75 7473 290a 2020 2020 2020 2020  , outs).        
+00010450: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+00010460: 756e 666c 6174 7465 6e28 6f75 7473 2c20  unflatten(outs, 
+00010470: 7370 6563 290a 2020 2020 2020 2020 6966  spec).        if
+00010480: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00010490: 6c74 2c20 4e75 6d62 6572 2920 616e 6420  lt, Number) and 
+000104a0: 6178 6973 5f73 697a 6520 6973 206e 6f74  axis_size is not
+000104b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000104c0: 2020 2023 2054 4f44 4f3a 2066 6574 6368     # TODO: fetch
+000104d0: 2074 6865 2064 6566 6175 6c74 2064 6576   the default dev
+000104e0: 6963 6520 6672 6f6d 2074 6865 2063 6f6e  ice from the con
+000104f0: 7465 7874 0a20 2020 2020 2020 2020 2020  text.           
+00010500: 2072 6573 756c 7420 3d20 6675 6c6c 2873   result = full(s
+00010510: 6861 7065 3d28 292c 2066 696c 6c5f 7661  hape=(), fill_va
+00010520: 6c75 653d 7265 7375 6c74 2c20 6465 7669  lue=result, devi
+00010530: 6365 3d63 6f6d 6d6f 6e5f 6465 7669 6365  ce=common_device
+00010540: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00010550: 7375 6c74 203d 2042 6174 6368 6564 5661  sult = BatchedVa
+00010560: 6c75 6528 7265 7375 6c74 2c20 6e6f 745f  lue(result, not_
+00010570: 6d61 7070 6564 290a 2020 2020 2020 2020  mapped).        
+00010580: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00010590: 7265 7375 6c74 2c20 4261 7463 6865 6456  result, BatchedV
+000105a0: 616c 7565 2920 616e 6420 6973 696e 7374  alue) and isinst
+000105b0: 616e 6365 2872 6573 756c 742e 7661 6c75  ance(result.valu
+000105c0: 652c 204e 756d 6265 7229 2061 6e64 2061  e, Number) and a
+000105d0: 7869 735f 7369 7a65 2069 7320 6e6f 7420  xis_size is not 
+000105e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000105f0: 2020 7265 7375 6c74 203d 2042 6174 6368    result = Batch
+00010600: 6564 5661 6c75 6528 6675 6c6c 2873 6861  edValue(full(sha
+00010610: 7065 3d28 292c 2066 696c 6c5f 7661 6c75  pe=(), fill_valu
+00010620: 653d 7265 7375 6c74 2e76 616c 7565 2c20  e=result.value, 
+00010630: 6465 7669 6365 3d63 6f6d 6d6f 6e5f 6465  device=common_de
+00010640: 7669 6365 292c 2072 6573 756c 742e 6261  vice), result.ba
+00010650: 7463 685f 6469 6d29 0a20 2020 2020 2020  tch_dim).       
+00010660: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00010670: 6365 2872 6573 756c 742c 2042 6174 6368  ce(result, Batch
+00010680: 6564 5661 6c75 6529 0a20 2020 2020 2020  edValue).       
+00010690: 206f 7574 203d 206d 6f76 655f 6261 7463   out = move_batc
+000106a0: 685f 6469 6d28 6178 6973 5f73 697a 652c  h_dim(axis_size,
+000106b0: 2072 6573 756c 742e 6261 7463 685f 6469   result.batch_di
+000106c0: 6d2c 206f 7574 5f64 696d 735b 305d 2c20  m, out_dims[0], 
+000106d0: 7265 7375 6c74 2e76 616c 7565 290a 2020  result.value).  
+000106e0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
+000106f0: 0a0a 0a76 6d61 705f 6361 6c6c 203d 2053  ...vmap_call = S
+00010700: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
+00010710: 726d 732e 566d 6170 4f70 2c20 6e61 6d65  rms.VmapOp, name
+00010720: 3d22 766d 6170 5f63 616c 6c22 2c20 6d65  ="vmap_call", me
+00010730: 7461 3d70 6172 7469 616c 285f 766d 6170  ta=partial(_vmap
+00010740: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
+00010750: 4661 6c73 6529 290a 0a0a 2320 544f 444f  False))...# TODO
+00010760: 3a20 686f 7720 7368 6f75 6c64 2077 6520  : how should we 
+00010770: 6861 6e64 6c65 206f 7574 5f64 696d 7320  handle out_dims 
+00010780: 6865 7265 3f0a 2320 616c 7468 6f75 6768  here?.# although
+00010790: 2068 6572 6520 7765 2061 7265 2063 616c   here we are cal
+000107a0: 6c69 6e67 2076 6d61 7020 6f66 2069 6465  ling vmap of ide
+000107b0: 6e74 6974 792c 2073 6f20 7765 2073 686f  ntity, so we sho
+000107c0: 756c 6420 6b6e 6f77 2066 726f 6d20 7468  uld know from th
+000107d0: 6520 6361 6c6c 2074 6f20 766d 6170 0a23  e call to vmap.#
+000107e0: 2054 6869 7320 7368 6f75 6c64 2062 6520   This should be 
+000107f0: 6669 6e65 2e20 4966 2077 6520 6861 7665  fine. If we have
+00010800: 2076 6d61 7028 6964 656e 7469 7479 2866   vmap(identity(f
+00010810: 756e 6329 2c20 6f75 745f 6469 6d73 3d4e  unc), out_dims=N
+00010820: 2920 7468 656e 2074 6869 7320 7275 6c65  ) then this rule
+00010830: 2069 7320 6669 7273 7420 7573 6564 0a23   is first used.#
+00010840: 2074 6f20 6765 7420 7468 6520 766d 6170   to get the vmap
+00010850: 7065 6420 7265 7375 6c74 206f 6620 6964  ped result of id
+00010860: 656e 7469 7479 2866 756e 6329 2069 6e20  entity(func) in 
+00010870: 766d 6170 5f73 796d 626f 6c5f 6d61 7070  vmap_symbol_mapp
+00010880: 6572 2c20 616e 6420 6f75 745f 6469 6d73  er, and out_dims
+00010890: 2069 7320 6861 6e64 6c65 640a 2320 6166   is handled.# af
+000108a0: 7465 7220 7468 6174 2069 6e20 7468 6520  ter that in the 
+000108b0: 6f75 7465 7220 5f76 6d61 705f 6361 6c6c  outer _vmap_call
+000108c0: 5f6d 6574 6166 756e 632e 0a64 6566 205f  _metafunc..def _
+000108d0: 6964 656e 7469 7479 5f63 616c 6c5f 766d  identity_call_vm
+000108e0: 6170 2861 7869 735f 7369 7a65 2c20 2a62  ap(axis_size, *b
+000108f0: 6174 6368 6564 5f61 7267 732c 2074 7261  atched_args, tra
+00010900: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
+00010910: 7267 7329 3a0a 2020 2020 6172 6773 2c20  rgs):.    args, 
+00010920: 696e 5f64 696d 7320 3d20 756e 7a69 7032  in_dims = unzip2
+00010930: 2862 6174 6368 6564 5f61 7267 7329 0a20  (batched_args). 
+00010940: 2020 206f 7574 5f64 696d 7320 3d20 3020     out_dims = 0 
+00010950: 2023 2046 6978 6d65 0a20 2020 206f 7574   # Fixme.    out
+00010960: 732c 206f 7574 5f64 696d 7320 3d20 5f76  s, out_dims = _v
+00010970: 6d61 705f 6361 6c6c 5f6d 6574 6166 756e  map_call_metafun
+00010980: 6328 4661 6c73 652c 2061 7267 732c 2069  c(False, args, i
+00010990: 6e5f 6469 6d73 2c20 6f75 745f 6469 6d73  n_dims, out_dims
+000109a0: 2c20 6178 6973 5f73 697a 652c 2066 756e  , axis_size, fun
+000109b0: 6374 696f 6e5f 7472 6163 653d 7472 6163  ction_trace=trac
+000109c0: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+000109d0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+000109e0: 7574 732c 2053 6571 7565 6e63 6529 3a0a  uts, Sequence):.
+000109f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00010a00: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+00010a10: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
+00010a20: 6166 655f 7a69 7028 6f75 7473 2c20 6f75  afe_zip(outs, ou
+00010a30: 745f 6469 6d73 2929 0a20 2020 2072 6574  t_dims)).    ret
+00010a40: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+00010a50: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
+00010a60: 0a0a 0a76 6d61 705f 696d 706c 735b 5472  ...vmap_impls[Tr
+00010a70: 616e 7366 6f72 6d73 2e49 6465 6e74 6974  ansforms.Identit
+00010a80: 794f 705d 203d 205f 6964 656e 7469 7479  yOp] = _identity
+00010a90: 5f63 616c 6c5f 766d 6170 0a0a 0a64 6566  _call_vmap...def
+00010aa0: 205f 6a76 705f 6361 6c6c 5f76 6d61 7028   _jvp_call_vmap(
+00010ab0: 6178 6973 5f73 697a 652c 2062 6174 6368  axis_size, batch
+00010ac0: 6564 5f70 7269 6d61 6c73 2c20 6261 7463  ed_primals, batc
+00010ad0: 6865 645f 7461 6e67 656e 7473 2c20 2a2c  hed_tangents, *,
+00010ae0: 2066 756e 6374 696f 6e5f 7472 6163 653a   function_trace:
+00010af0: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
+00010b00: 293a 0a20 2020 2070 7269 6d61 6c73 2c20  ):.    primals, 
+00010b10: 7072 696d 616c 735f 6264 696d 7320 3d20  primals_bdims = 
+00010b20: 7361 6665 5f7a 6970 282a 6261 7463 6865  safe_zip(*batche
+00010b30: 645f 7072 696d 616c 7329 0a20 2020 2074  d_primals).    t
+00010b40: 616e 6765 6e74 732c 2074 616e 6765 6e74  angents, tangent
+00010b50: 735f 6264 696d 7320 3d20 7361 6665 5f7a  s_bdims = safe_z
+00010b60: 6970 282a 6261 7463 6865 645f 7461 6e67  ip(*batched_tang
+00010b70: 656e 7473 290a 2020 2020 6a76 705f 6675  ents).    jvp_fu
+00010b80: 6e63 203d 2070 6172 7469 616c 285f 6a76  nc = partial(_jv
+00010b90: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
+00010ba0: 2046 616c 7365 2c20 6675 6e63 7469 6f6e   False, function
+00010bb0: 5f74 7261 6365 3d66 756e 6374 696f 6e5f  _trace=function_
+00010bc0: 7472 6163 6529 0a20 2020 2076 6d61 7070  trace).    vmapp
+00010bd0: 6564 5f6a 7670 5f66 756e 6320 3d20 766d  ed_jvp_func = vm
+00010be0: 6170 286a 7670 5f66 756e 632c 2069 6e5f  ap(jvp_func, in_
+00010bf0: 6469 6d73 3d28 7072 696d 616c 735f 6264  dims=(primals_bd
+00010c00: 696d 732c 2074 616e 6765 6e74 735f 6264  ims, tangents_bd
+00010c10: 696d 7329 2c20 6178 6973 5f73 697a 653d  ims), axis_size=
+00010c20: 6178 6973 5f73 697a 6529 0a20 2020 2072  axis_size).    r
+00010c30: 6573 756c 7420 3d20 766d 6170 7065 645f  esult = vmapped_
+00010c40: 6a76 705f 6675 6e63 2870 7269 6d61 6c73  jvp_func(primals
+00010c50: 2c20 7461 6e67 656e 7473 2c20 2a2a 6b77  , tangents, **kw
+00010c60: 6172 6773 290a 2020 2020 7265 7475 726e  args).    return
+00010c70: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+00010c80: 2078 3a20 4261 7463 6865 6456 616c 7565   x: BatchedValue
+00010c90: 2878 2c20 3029 2c20 7265 7375 6c74 290a  (x, 0), result).
+00010ca0: 0a0a 766d 6170 5f69 6d70 6c73 5b54 7261  ..vmap_impls[Tra
+00010cb0: 6e73 666f 726d 732e 4a76 704f 705d 203d  nsforms.JvpOp] =
+00010cc0: 205f 6a76 705f 6361 6c6c 5f76 6d61 700a   _jvp_call_vmap.
+00010cd0: 0a0a 6465 6620 766d 6170 2866 756e 632c  ..def vmap(func,
+00010ce0: 2069 6e5f 6469 6d73 3d30 2c20 6f75 745f   in_dims=0, out_
+00010cf0: 6469 6d73 3d30 2c20 6178 6973 5f73 697a  dims=0, axis_siz
+00010d00: 653d 4e6f 6e65 293a 0a20 2020 2022 2222  e=None):.    """
+00010d10: 5665 6374 6f72 697a 696e 6720 7472 616e  Vectorizing tran
+00010d20: 7366 6f72 6d20 666f 7220 6120 5468 756e  sform for a Thun
+00010d30: 6465 7220 6675 6e63 7469 6f6e 2e0a 0a20  der function... 
+00010d40: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00010d50: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+00010d60: 3a20 4120 5468 756e 6465 7220 6675 6e63  : A Thunder func
+00010d70: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
+00010d80: 666f 726d 6564 2e0a 0a20 2020 2052 6574  formed...    Ret
+00010d90: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
+00010da0: 6c6c 6162 6c65 3a20 4120 766d 6170 7065  llable: A vmappe
+00010db0: 6420 7665 7273 696f 6e20 6f66 2074 6865  d version of the
+00010dc0: 2066 756e 6374 696f 6e2e 0a20 2020 2022   function..    "
+00010dd0: 2222 0a0a 2020 2020 2320 544f 444f 3a20  ""..    # TODO: 
+00010de0: 666c 6174 7465 6e0a 2020 2020 2320 496e  flatten.    # In
+00010df0: 204a 4158 2066 6c61 7474 656e 696e 6720   JAX flattening 
+00010e00: 6f66 2069 6e5f 6469 6d73 2069 7320 7261  of in_dims is ra
+00010e10: 7468 6572 2063 6f6d 706c 6963 6174 6564  ther complicated
+00010e20: 2062 6563 6175 7365 2069 7420 6361 6e20   because it can 
+00010e30: 6f70 7469 6f6e 616c 6c79 2062 650a 2020  optionally be.  
+00010e40: 2020 2320 7370 6563 6966 6965 6420 6173    # specified as
+00010e50: 2061 20e2 809c 7072 6566 6978 e280 9d20   a ...prefix... 
+00010e60: 7079 7472 6565 2c20 6d65 616e 696e 6720  pytree, meaning 
+00010e70: 7468 6174 2061 2073 696e 676c 6520 6c65  that a single le
+00010e80: 6166 2076 616c 7565 2063 616e 2062 6520  af value can be 
+00010e90: 6170 706c 6965 640a 2020 2020 2320 746f  applied.    # to
+00010ea0: 2061 6e20 656e 7469 7265 2073 7562 2d70   an entire sub-p
+00010eb0: 7974 7265 652e 0a0a 2020 2020 6465 6620  ytree...    def 
+00010ec0: 666c 6174 7465 6e5f 6675 6e63 5f66 6f72  flatten_func_for
+00010ed0: 5f76 6d61 7028 6675 6e63 2c20 6172 6773  _vmap(func, args
+00010ee0: 2c20 6b77 6172 6773 293a 0a20 2020 2020  , kwargs):.     
+00010ef0: 2020 2066 6c61 745f 6172 6773 2c20 7370     flat_args, sp
+00010f00: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
+00010f10: 6e28 2861 7267 732c 206b 7761 7267 7329  n((args, kwargs)
+00010f20: 290a 0a20 2020 2020 2020 2064 6566 2066  )..        def f
+00010f30: 6c61 745f 6675 6e63 282a 666c 6174 5f61  lat_func(*flat_a
+00010f40: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
+00010f50: 2020 666e 5f61 7267 732c 2066 6e5f 6b77    fn_args, fn_kw
+00010f60: 6172 6773 203d 2074 7265 655f 756e 666c  args = tree_unfl
+00010f70: 6174 7465 6e28 666c 6174 5f61 7267 732c  atten(flat_args,
+00010f80: 2073 7065 6329 0a20 2020 2020 2020 2020   spec).         
+00010f90: 2020 2072 6574 7572 6e20 6675 6e63 282a     return func(*
+00010fa0: 666e 5f61 7267 732c 202a 2a66 6e5f 6b77  fn_args, **fn_kw
+00010fb0: 6172 6773 290a 0a20 2020 2020 2020 2072  args)..        r
+00010fc0: 6574 7572 6e20 666c 6174 5f66 756e 632c  eturn flat_func,
+00010fd0: 2066 6c61 745f 6172 6773 2c20 7370 6563   flat_args, spec
+00010fe0: 0a0a 2020 2020 6465 6620 7772 6170 7065  ..    def wrappe
+00010ff0: 7228 2a61 7267 732c 202a 2a6b 7761 7267  r(*args, **kwarg
+00011000: 7329 3a0a 2020 2020 2020 2020 6675 6e63  s):.        func
+00011010: 5f66 6c61 742c 2061 7267 735f 666c 6174  _flat, args_flat
+00011020: 2c20 6172 6773 5f73 7065 6320 3d20 666c  , args_spec = fl
+00011030: 6174 7465 6e5f 6675 6e63 5f66 6f72 5f76  atten_func_for_v
+00011040: 6d61 7028 6675 6e63 2c20 6172 6773 2c20  map(func, args, 
+00011050: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00011060: 6966 2069 7369 6e73 7461 6e63 6528 696e  if isinstance(in
+00011070: 5f64 696d 732c 2069 6e74 293a 0a20 2020  _dims, int):.   
+00011080: 2020 2020 2020 2020 2069 6e5f 6469 6d73           in_dims
+00011090: 5f66 6c61 7420 3d20 2869 6e5f 6469 6d73  _flat = (in_dims
+000110a0: 2c29 202a 206c 656e 2861 7267 735f 666c  ,) * len(args_fl
+000110b0: 6174 290a 2020 2020 2020 2020 656c 7365  at).        else
+000110c0: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+000110d0: 5f64 696d 735f 666c 6174 2c20 696e 5f64  _dims_flat, in_d
+000110e0: 696d 735f 7370 6563 203d 2074 7265 655f  ims_spec = tree_
+000110f0: 666c 6174 7465 6e28 696e 5f64 696d 7329  flatten(in_dims)
+00011100: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00011110: 6572 7420 6c65 6e28 696e 5f64 696d 735f  ert len(in_dims_
+00011120: 666c 6174 2920 3d3d 206c 656e 2861 7267  flat) == len(arg
+00011130: 735f 666c 6174 292c 2022 696e 5f64 696d  s_flat), "in_dim
+00011140: 7320 6d75 7374 2068 6176 6520 7468 6520  s must have the 
+00011150: 7361 6d65 206c 656e 6774 6820 6173 2061  same length as a
+00011160: 7267 732c 206b 7761 7267 7322 0a20 2020  rgs, kwargs".   
+00011170: 2020 2020 2075 6e62 6174 6368 6564 5f61       unbatched_a
+00011180: 7267 735f 666c 6174 203d 205b 7265 6d6f  rgs_flat = [remo
+00011190: 7665 5f62 6174 6368 5f64 696d 2861 7267  ve_batch_dim(arg
+000111a0: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
+000111b0: 6172 672c 2054 656e 736f 7250 726f 7879  arg, TensorProxy
+000111c0: 2920 656c 7365 2061 7267 2066 6f72 2061  ) else arg for a
+000111d0: 7267 2069 6e20 6172 6773 5f66 6c61 745d  rg in args_flat]
+000111e0: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
+000111f0: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+00011200: 2829 2866 756e 635f 666c 6174 2c20 2a75  ()(func_flat, *u
+00011210: 6e62 6174 6368 6564 5f61 7267 735f 666c  nbatched_args_fl
+00011220: 6174 290a 2020 2020 2020 2020 6f75 7473  at).        outs
+00011230: 203d 2076 6d61 705f 6361 6c6c 2861 7267   = vmap_call(arg
+00011240: 735f 666c 6174 2c20 696e 5f64 696d 735f  s_flat, in_dims_
+00011250: 666c 6174 2c20 6f75 745f 6469 6d73 2c20  flat, out_dims, 
+00011260: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
+00011270: 697a 652c 2066 756e 6374 696f 6e5f 7472  ize, function_tr
+00011280: 6163 653d 7472 6163 6529 0a20 2020 2020  ace=trace).     
+00011290: 2020 2072 6574 7572 6e20 6f75 7473 0a0a     return outs..
+000112a0: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
+000112b0: 6572 0a0a 0a23 2054 4f44 4f20 5468 6973  er...# TODO This
+000112c0: 2066 756e 6374 696f 6e20 636f 6d6d 656e   function commen
+000112d0: 7465 6420 6f75 7420 6265 6361 7573 6520  ted out because 
+000112e0: 6974 2063 616c 6c73 206d 616b 655f 7472  it calls make_tr
+000112f0: 6163 6564 2c20 7768 6963 6820 646f 6573  aced, which does
+00011300: 206e 6f74 2065 7869 7374 0a23 2064 6566   not exist.# def
+00011310: 2076 6d61 705f 6561 6765 7228 6675 6e63   vmap_eager(func
+00011320: 2c20 6172 6773 2c20 696e 5f64 696d 733d  , args, in_dims=
+00011330: 302c 206f 7574 5f64 696d 733d 302c 2061  0, out_dims=0, a
+00011340: 7869 735f 7369 7a65 3d4e 6f6e 652c 2065  xis_size=None, e
+00011350: 7865 6375 746f 723d 2274 6f72 6368 2229  xecutor="torch")
+00011360: 3a0a 2320 2020 2020 2222 2243 6f6d 7075  :.#     """Compu
+00011370: 7465 7320 7468 6520 766d 6170 206f 6620  tes the vmap of 
+00011380: 6120 5468 756e 6465 7220 6675 6e63 7469  a Thunder functi
+00011390: 6f6e 2e0a 0a23 2020 2020 2041 7267 733a  on...#     Args:
+000113a0: 0a23 2020 2020 2020 2020 2066 756e 6320  .#         func 
+000113b0: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
+000113c0: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
+000113d0: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
+000113e0: 2e0a 2320 2020 2020 2020 2020 6172 6773  ..#         args
+000113f0: 2028 5f74 7970 655f 293a 2041 7267 7320   (_type_): Args 
+00011400: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+00011410: 0a23 2020 2020 2020 2020 2065 7865 6375  .#         execu
+00011420: 746f 7220 2873 7472 2c20 6f70 7469 6f6e  tor (str, option
+00011430: 616c 293a 2045 7865 6375 746f 7220 746f  al): Executor to
+00011440: 2075 7365 2e20 4465 6661 756c 7473 2074   use. Defaults t
+00011450: 6f20 2274 6f72 6368 222e 0a0a 2320 2020  o "torch"...#   
+00011460: 2020 5265 7475 726e 733a 0a23 2020 2020    Returns:.#    
+00011470: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
+00011480: 6f66 2074 6865 2076 6d61 7070 6564 2066  of the vmapped f
+00011490: 756e 6374 696f 6e2e 0a23 2020 2020 2022  unction..#     "
+000114a0: 2222 0a23 2020 2020 2023 2054 4f44 4f3a  "".#     # TODO:
+000114b0: 2066 6978 2074 6869 7320 2d20 6e6f 7420   fix this - not 
+000114c0: 616c 6c20 6172 6773 206d 6179 2062 6520  all args may be 
+000114d0: 6261 7463 6865 640a 2320 2020 2020 2320  batched.#     # 
+000114e0: 544f 444f 3a20 6865 7265 2077 6520 6173  TODO: here we as
+000114f0: 7375 6d65 2062 6174 6368 2061 7869 7320  sume batch axis 
+00011500: 6973 2030 0a23 2020 2020 2076 6d61 705f  is 0.#     vmap_
+00011510: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
+00011520: 6365 280a 2320 2020 2020 2020 2020 766d  ce(.#         vm
+00011530: 6170 2866 756e 632c 2069 6e5f 6469 6d73  ap(func, in_dims
+00011540: 3d69 6e5f 6469 6d73 2c20 6f75 745f 6469  =in_dims, out_di
+00011550: 6d73 3d6f 7574 5f64 696d 732c 2061 7869  ms=out_dims, axi
+00011560: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
+00011570: 292c 2065 7865 6375 746f 723d 6578 6563  ), executor=exec
+00011580: 7574 6f72 2c0a 2320 2020 2020 2020 2020  utor,.#         
+00011590: 2a61 7267 7329 0a23 2020 2020 2076 6d61  *args).#     vma
+000115a0: 705f 7472 6163 6564 203d 206d 616b 655f  p_traced = make_
+000115b0: 7472 6163 6564 2870 6172 7469 616c 2865  traced(partial(e
+000115c0: 7661 6c5f 7472 6163 652c 2076 6d61 705f  val_trace, vmap_
+000115d0: 7472 6163 6529 2c20 6578 6563 7574 6f72  trace), executor
+000115e0: 3d65 7865 6375 746f 7229 0a23 2020 2020  =executor).#    
+000115f0: 2072 6574 7572 6e20 766d 6170 5f74 7261   return vmap_tra
+00011600: 6365 6428 2a61 7267 7329 0a0a 0a23 204a  ced(*args)...# J
+00011610: 5650 2074 7261 6e73 666f 726d 0a23 202d  VP transform.# -
+00011620: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a40  ------------...@
+00011630: 6461 7461 636c 6173 7328 6672 6f7a 656e  dataclass(frozen
+00011640: 3d54 7275 6529 0a63 6c61 7373 204a 5650  =True).class JVP
+00011650: 4475 616c 3a0a 2020 2020 2222 2244 7561  Dual:.    """Dua
+00011660: 6c20 6e75 6d62 6572 2066 6f72 2074 6865  l number for the
+00011670: 204a 5650 2074 7261 6e73 666f 726d 2e0a   JVP transform..
+00011680: 0a20 2020 2041 7474 7269 6275 7465 733a  .    Attributes:
+00011690: 0a20 2020 2020 2020 2070 7269 6d61 6c3a  .        primal:
+000116a0: 2050 7269 6d61 6c20 7661 6c75 652e 0a20   Primal value.. 
+000116b0: 2020 2020 2020 2074 616e 6765 6e74 3a20         tangent: 
+000116c0: 5461 6e67 656e 7420 7661 6c75 652e 0a20  Tangent value.. 
+000116d0: 2020 2022 2222 0a0a 2020 2020 7072 696d     """..    prim
+000116e0: 616c 3a20 416e 790a 2020 2020 7461 6e67  al: Any.    tang
+000116f0: 656e 743a 2041 6e79 0a0a 2020 2020 6465  ent: Any..    de
+00011700: 6620 5f5f 6974 6572 5f5f 2873 656c 6629  f __iter__(self)
+00011710: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+00011720: 7365 6c66 2e70 7269 6d61 6c0a 2020 2020  self.primal.    
+00011730: 2020 2020 7969 656c 6420 7365 6c66 2e74      yield self.t
+00011740: 616e 6765 6e74 0a0a 0a64 6566 2070 6169  angent...def pai
+00011750: 725f 746f 5f6a 7670 5f64 7561 6c28 7061  r_to_jvp_dual(pa
+00011760: 6972 293a 0a20 2020 2022 2222 436f 6e76  ir):.    """Conv
+00011770: 6572 7473 2061 2070 6169 7220 746f 2061  erts a pair to a
+00011780: 204a 5650 4475 616c 2e0a 0a20 2020 2041   JVPDual...    A
+00011790: 7267 733a 0a20 2020 2020 2020 2070 6169  rgs:.        pai
+000117a0: 7220 2853 6571 7565 6e63 6529 3a20 5061  r (Sequence): Pa
+000117b0: 6972 2074 6f20 636f 6e76 6572 742e 0a0a  ir to convert...
+000117c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+000117d0: 2020 2020 204a 5650 4475 616c 3a20 4a56       JVPDual: JV
+000117e0: 5044 7561 6c20 7265 7072 6573 656e 7461  PDual representa
+000117f0: 7469 6f6e 206f 6620 7468 6520 7061 6972  tion of the pair
+00011800: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+00011810: 2069 7369 6e73 7461 6e63 6528 7061 6972   isinstance(pair
+00011820: 2c20 4a56 5044 7561 6c29 3a0a 2020 2020  , JVPDual):.    
+00011830: 2020 2020 7265 7475 726e 2070 6169 720a      return pair.
+00011840: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00011850: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00011860: 6e63 6528 7061 6972 2c20 5365 7175 656e  nce(pair, Sequen
+00011870: 6365 2920 616e 6420 6c65 6e28 7061 6972  ce) and len(pair
+00011880: 2920 3d3d 2032 0a20 2020 2020 2020 2072  ) == 2.        r
+00011890: 6574 7572 6e20 4a56 5044 7561 6c28 2a70  eturn JVPDual(*p
+000118a0: 6169 7229 0a0a 0a64 6566 2073 696e 5f6a  air)...def sin_j
+000118b0: 7670 2861 3a20 4a56 5044 7561 6c29 3a0a  vp(a: JVPDual):.
+000118c0: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
+000118d0: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
+000118e0: 2870 7269 6d73 2e73 696e 2878 292c 2070  (prims.sin(x), p
+000118f0: 7269 6d73 2e63 6f73 2878 2920 2a20 7864  rims.cos(x) * xd
+00011900: 290a 0a0a 6465 6620 6d75 6c5f 6a76 7028  )...def mul_jvp(
+00011910: 613a 204a 5650 4475 616c 2c20 623a 204a  a: JVPDual, b: J
+00011920: 5650 4475 616c 293a 0a20 2020 2078 2c20  VPDual):.    x, 
+00011930: 7864 203d 2061 0a20 2020 2079 2c20 7964  xd = a.    y, yd
+00011940: 203d 2062 0a20 2020 2072 6574 7572 6e20   = b.    return 
+00011950: 4a56 5044 7561 6c28 7820 2a20 792c 2078  JVPDual(x * y, x
+00011960: 202a 2079 6420 2b20 7920 2a20 7864 290a   * yd + y * xd).
+00011970: 0a0a 6465 6620 6164 645f 6a76 7028 613a  ..def add_jvp(a:
+00011980: 204a 5650 4475 616c 2c20 623a 204a 5650   JVPDual, b: JVP
+00011990: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
+000119a0: 203d 2061 0a20 2020 2079 2c20 7964 203d   = a.    y, yd =
+000119b0: 2062 0a20 2020 2072 6574 7572 6e20 4a56   b.    return JV
+000119c0: 5044 7561 6c28 7820 2b20 792c 2078 6420  PDual(x + y, xd 
+000119d0: 2b20 7964 290a 0a0a 6465 6620 6272 6f61  + yd)...def broa
+000119e0: 6463 6173 745f 696e 5f64 696d 5f6a 7670  dcast_in_dim_jvp
+000119f0: 2861 3a20 4a56 5044 7561 6c2c 2073 6861  (a: JVPDual, sha
+00011a00: 7065 3a20 7475 706c 655b 4a56 5044 7561  pe: tuple[JVPDua
+00011a10: 6c2c 202e 2e2e 5d2c 2062 726f 6164 6361  l, ...], broadca
+00011a20: 7374 5f64 696d 656e 7369 6f6e 733a 2074  st_dimensions: t
+00011a30: 7570 6c65 5b4a 5650 4475 616c 2c20 2e2e  uple[JVPDual, ..
+00011a40: 2e5d 2920 2d3e 204a 5650 4475 616c 3a0a  .]) -> JVPDual:.
+00011a50: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
+00011a60: 2020 2320 544f 444f 3a20 7368 6170 6520    # TODO: shape 
+00011a70: 616e 6420 6272 6f61 6463 6173 745f 6469  and broadcast_di
+00011a80: 6d65 6e73 696f 6e73 2073 686f 756c 6420  mensions should 
+00011a90: 6265 2074 7570 6c65 7320 6f66 2069 6e74  be tuples of int
+00011aa0: 730a 2020 2020 2320 6275 7420 666f 7220  s.    # but for 
+00011ab0: 6e6f 7720 6974 2773 2061 2074 7570 6c65  now it's a tuple
+00011ac0: 206f 6620 4a56 5044 7561 6c73 0a20 2020   of JVPDuals.   
+00011ad0: 2069 6620 6c65 6e28 7368 6170 6529 203e   if len(shape) >
+00011ae0: 2030 2061 6e64 2069 7369 6e73 7461 6e63   0 and isinstanc
+00011af0: 6528 7368 6170 655b 305d 2c20 4a56 5044  e(shape[0], JVPD
+00011b00: 7561 6c29 3a0a 2020 2020 2020 2020 7368  ual):.        sh
+00011b10: 6170 652c 205f 203d 2073 6166 655f 7a69  ape, _ = safe_zi
+00011b20: 7028 2a73 6861 7065 290a 2020 2020 6966  p(*shape).    if
+00011b30: 206c 656e 2862 726f 6164 6361 7374 5f64   len(broadcast_d
+00011b40: 696d 656e 7369 6f6e 7329 203e 2030 2061  imensions) > 0 a
+00011b50: 6e64 2069 7369 6e73 7461 6e63 6528 6272  nd isinstance(br
+00011b60: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+00011b70: 6e73 5b30 5d2c 204a 5650 4475 616c 293a  ns[0], JVPDual):
+00011b80: 0a20 2020 2020 2020 2062 726f 6164 6361  .        broadca
+00011b90: 7374 5f64 696d 656e 7369 6f6e 732c 205f  st_dimensions, _
+00011ba0: 203d 2073 6166 655f 7a69 7028 2a62 726f   = safe_zip(*bro
+00011bb0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011bc0: 7329 0a20 2020 2072 6574 7572 6e20 4a56  s).    return JV
+00011bd0: 5044 7561 6c28 0a20 2020 2020 2020 2070  PDual(.        p
+00011be0: 7269 6d73 2e62 726f 6164 6361 7374 5f69  rims.broadcast_i
+00011bf0: 6e5f 6469 6d28 782c 2073 6861 7065 2c20  n_dim(x, shape, 
+00011c00: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
+00011c10: 696f 6e73 292c 2070 7269 6d73 2e62 726f  ions), prims.bro
+00011c20: 6164 6361 7374 5f69 6e5f 6469 6d28 7864  adcast_in_dim(xd
+00011c30: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
+00011c40: 7374 5f64 696d 656e 7369 6f6e 7329 0a20  st_dimensions). 
+00011c50: 2020 2029 0a0a 0a64 6566 2075 6e70 6163     )...def unpac
+00011c60: 6b5f 7365 7175 656e 6365 5f6a 7670 2873  k_sequence_jvp(s
+00011c70: 6571 7565 6e63 653a 204a 5650 4475 616c  equence: JVPDual
+00011c80: 2c20 6c65 6e67 7468 3a20 4a56 5044 7561  , length: JVPDua
+00011c90: 6c29 202d 3e20 4a56 5044 7561 6c3a 0a20  l) -> JVPDual:. 
+00011ca0: 2020 2078 203d 2074 7265 655f 6d61 7028     x = tree_map(
+00011cb0: 6c61 6d62 6461 2078 3a20 782e 7072 696d  lambda x: x.prim
+00011cc0: 616c 2c20 7365 7175 656e 6365 290a 2020  al, sequence).  
+00011cd0: 2020 7864 203d 2074 7265 655f 6d61 7028    xd = tree_map(
+00011ce0: 6c61 6d62 6461 2078 3a20 782e 7461 6e67  lambda x: x.tang
+00011cf0: 656e 742c 2073 6571 7565 6e63 6529 0a20  ent, sequence). 
+00011d00: 2020 206c 656e 6774 682c 205f 203d 206c     length, _ = l
+00011d10: 656e 6774 680a 2020 2020 7072 696d 616c  ength.    primal
+00011d20: 7320 3d20 7072 696d 732e 756e 7061 636b  s = prims.unpack
+00011d30: 5f73 6571 7565 6e63 6528 782c 206c 656e  _sequence(x, len
+00011d40: 6774 6829 0a20 2020 2074 616e 6765 6e74  gth).    tangent
+00011d50: 7320 3d20 7072 696d 732e 756e 7061 636b  s = prims.unpack
+00011d60: 5f73 6571 7565 6e63 6528 7864 2c20 6c65  _sequence(xd, le
+00011d70: 6e67 7468 290a 2020 2020 7265 7475 726e  ngth).    return
+00011d80: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
+00011d90: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
+00011da0: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
+00011db0: 6e67 656e 7473 2929 0a0a 0a64 6566 2075  ngents))...def u
+00011dc0: 6e70 6163 6b5f 7472 6976 6961 6c5f 6a76  npack_trivial_jv
+00011dd0: 7028 783a 204a 5650 4475 616c 2920 2d3e  p(x: JVPDual) ->
+00011de0: 204a 5650 4475 616c 3a0a 2020 2020 7265   JVPDual:.    re
+00011df0: 7475 726e 2078 0a0a 0a6a 7670 5f69 6d70  turn x...jvp_imp
+00011e00: 6c73 3a20 6469 6374 5b70 7269 6d73 2e53  ls: dict[prims.S
+00011e10: 796d 626f 6c2c 2043 616c 6c61 626c 655d  ymbol, Callable]
+00011e20: 203d 2064 6963 7428 290a 0a6a 7670 5f69   = dict()..jvp_i
+00011e30: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
+00011e40: 4473 2e53 494e 5d20 3d20 7369 6e5f 6a76  Ds.SIN] = sin_jv
+00011e50: 700a 6a76 705f 696d 706c 735b 7072 696d  p.jvp_impls[prim
+00011e60: 732e 5072 696d 4944 732e 4d55 4c5d 203d  s.PrimIDs.MUL] =
+00011e70: 206d 756c 5f6a 7670 0a6a 7670 5f69 6d70   mul_jvp.jvp_imp
+00011e80: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+00011e90: 2e41 4444 5d20 3d20 6164 645f 6a76 700a  .ADD] = add_jvp.
+00011ea0: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
+00011eb0: 5072 696d 4944 732e 4252 4f41 4443 4153  PrimIDs.BROADCAS
+00011ec0: 545f 494e 5f44 494d 5d20 3d20 6272 6f61  T_IN_DIM] = broa
+00011ed0: 6463 6173 745f 696e 5f64 696d 5f6a 7670  dcast_in_dim_jvp
+00011ee0: 0a23 206a 7670 5f69 6d70 6c73 5b70 7269  .# jvp_impls[pri
+00011ef0: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
+00011f00: 4b5f 5345 5155 454e 4345 5d20 3d20 756e  K_SEQUENCE] = un
+00011f10: 7061 636b 5f73 6571 7565 6e63 655f 6a76  pack_sequence_jv
+00011f20: 700a 2320 6a76 705f 696d 706c 735b 7072  p.# jvp_impls[pr
+00011f30: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+00011f40: 434b 5f54 5249 5649 414c 5d20 3d20 756e  CK_TRIVIAL] = un
+00011f50: 7061 636b 5f74 7269 7669 616c 5f6a 7670  pack_trivial_jvp
+00011f60: 0a0a 0a64 6566 206a 7670 5f73 796d 626f  ...def jvp_symbo
+00011f70: 6c5f 6d61 7070 6572 2873 796d 626f 6c3a  l_mapper(symbol:
+00011f80: 2070 7269 6d73 2e53 796d 626f 6c29 3a0a   prims.Symbol):.
+00011f90: 2020 2020 2222 224d 6170 7320 6120 7379      """Maps a sy
+00011fa0: 6d62 6f6c 2074 6f20 6120 4a56 5020 6675  mbol to a JVP fu
+00011fb0: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
+00011fc0: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
+00011fd0: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
+00011fe0: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
+00011ff0: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6576  l): Symbol to ev
+00012000: 616c 7561 7465 2e0a 0a20 2020 2052 6169  aluate...    Rai
+00012010: 7365 733a 0a20 2020 2020 2020 204e 6f74  ses:.        Not
+00012020: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
+00012030: 3a20 4966 2074 6865 204a 5650 2066 6f72  : If the JVP for
+00012040: 2074 6865 2073 796d 626f 6c20 6973 206e   the symbol is n
+00012050: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
+00012060: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00012070: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
+00012080: 4a56 5020 6675 6e63 7469 6f6e 2074 6861  JVP function tha
+00012090: 7420 6576 616c 7561 7465 7320 7468 6520  t evaluates the 
+000120a0: 7379 6d62 6f6c 2e0a 2020 2020 2222 220a  symbol..    """.
+000120b0: 0a20 2020 2064 6566 2077 7261 705f 6172  .    def wrap_ar
+000120c0: 6728 7829 3a0a 2020 2020 2020 2020 6966  g(x):.        if
+000120d0: 2069 7369 6e73 7461 6e63 6528 782c 204a   isinstance(x, J
+000120e0: 5650 4475 616c 293a 0a20 2020 2020 2020  VPDual):.       
+000120f0: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
+00012100: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00012110: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
+00012120: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00012130: 7475 726e 204a 5650 4475 616c 2878 2c20  turn JVPDual(x, 
+00012140: 7479 7065 2878 2928 3029 290a 2020 2020  type(x)(0)).    
+00012150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012160: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00012170: 6545 7272 6f72 2866 224a 5650 2077 7261  eError(f"JVP wra
+00012180: 705f 6172 6720 676f 7420 616e 2075 6e73  p_arg got an uns
+00012190: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
+000121a0: 7970 6528 7829 7d22 290a 0a20 2020 2023  ype(x)}")..    #
+000121b0: 2049 6620 7379 6d62 6f6c 2e61 7267 7320   If symbol.args 
+000121c0: 646f 6573 6e27 7420 6861 7665 2073 7562  doesn't have sub
+000121d0: 636c 6173 7365 7320 6f66 2056 6172 6961  classes of Varia
+000121e0: 626c 652c 2074 6865 6e20 7765 206e 6565  ble, then we nee
+000121f0: 6420 746f 2072 6574 7572 6e20 6120 7a65  d to return a ze
+00012200: 726f 2074 616e 6765 6e74 0a20 2020 2023  ro tangent.    #
+00012210: 2054 4f44 4f3a 2074 6865 7265 206d 6179   TODO: there may
+00012220: 2062 6520 6120 6265 7474 6572 2077 6179   be a better way
+00012230: 2074 6f20 6465 7465 6374 2063 6f6e 7374   to detect const
+00012240: 616e 7473 2069 6e20 7468 6520 7472 6163  ants in the trac
+00012250: 650a 2020 2020 6966 2073 796d 626f 6c2e  e.    if symbol.
+00012260: 6172 655f 616c 6c5f 6172 6773 5f63 6f6e  are_all_args_con
+00012270: 7374 616e 743a 0a0a 2020 2020 2020 2020  stant:..        
+00012280: 6465 6620 7a65 726f 735f 6c69 6b65 2878  def zeros_like(x
+00012290: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000122a0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+000122b0: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
+000122c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000122d0: 7475 726e 2066 756c 6c5f 6c69 6b65 2878  turn full_like(x
+000122e0: 2c20 6669 6c6c 5f76 616c 7565 3d30 290a  , fill_value=0).
+000122f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00012300: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
+00012310: 756d 6265 7250 726f 7879 293a 0a20 2020  umberProxy):.   
+00012320: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00012330: 7572 6e20 7479 7065 2878 2e76 616c 7565  urn type(x.value
+00012340: 2928 3029 0a20 2020 2020 2020 2020 2020  )(0).           
+00012350: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00012360: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
+00012370: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00012380: 7572 6e20 7479 7065 2878 2928 3029 0a20  urn type(x)(0). 
+00012390: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000123a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000123b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000123c0: 7228 6622 7a65 726f 735f 6c69 6b65 2069  r(f"zeros_like i
+000123d0: 6e73 6964 6520 4a56 5020 676f 7420 616e  nside JVP got an
+000123e0: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
+000123f0: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
+00012400: 2020 2020 2020 2064 6566 206a 7670 5f69         def jvp_i
+00012410: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
+00012420: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+00012430: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00012440: 7072 696d 616c 7320 3d20 7379 6d62 6f6c  primals = symbol
+00012450: 5f74 6f5f 6576 616c 2873 796d 626f 6c29  _to_eval(symbol)
+00012460: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+00012470: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00012480: 2069 7369 6e73 7461 6e63 6528 7072 696d   isinstance(prim
+00012490: 616c 732c 2053 6571 7565 6e63 6529 3a0a  als, Sequence):.
+000124a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124b0: 7461 6e67 656e 7473 203d 2074 7570 6c65  tangents = tuple
+000124c0: 287a 6572 6f73 5f6c 696b 6528 7029 2066  (zeros_like(p) f
+000124d0: 6f72 2070 2069 6e20 7072 696d 616c 7329  or p in primals)
+000124e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124f0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+00012500: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+00012510: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
+00012520: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
+00012530: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012540: 726e 204a 5650 4475 616c 2870 7269 6d61  rn JVPDual(prima
+00012550: 6c73 2c20 7a65 726f 735f 6c69 6b65 2870  ls, zeros_like(p
+00012560: 7269 6d61 6c73 2929 0a0a 2020 2020 2020  rimals))..      
+00012570: 2020 7265 7475 726e 2070 6172 7469 616c    return partial
+00012580: 286a 7670 5f69 6d70 6c5f 636f 6e73 742c  (jvp_impl_const,
+00012590: 2073 796d 626f 6c29 0a0a 2020 2020 2320   symbol)..    # 
+000125a0: 4e6f 726d 616c 2063 6173 652c 2077 6520  Normal case, we 
+000125b0: 6861 7665 2061 2070 726f 7879 2074 616e  have a proxy tan
+000125c0: 6765 6e74 0a20 2020 206a 7670 5f69 6d70  gent.    jvp_imp
+000125d0: 6c20 3d20 6a76 705f 696d 706c 732e 6765  l = jvp_impls.ge
+000125e0: 7428 7379 6d62 6f6c 2e73 796d 2e69 6429  t(symbol.sym.id)
+000125f0: 0a20 2020 2069 6620 6a76 705f 696d 706c  .    if jvp_impl
+00012600: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00012610: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+00012620: 6d65 6e74 6564 4572 726f 7228 6622 4a56  mentedError(f"JV
+00012630: 5020 666f 7220 7b73 796d 626f 6c2e 7379  P for {symbol.sy
+00012640: 6d2e 6964 7d20 6973 206e 6f74 2069 6d70  m.id} is not imp
+00012650: 6c65 6d65 6e74 6564 2229 0a0a 2020 2020  lemented")..    
+00012660: 6465 6620 5f6a 7670 5f69 6d70 6c28 2a61  def _jvp_impl(*a
+00012670: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+00012680: 2020 2020 2020 2020 6172 6773 203d 2074          args = t
+00012690: 7265 655f 6d61 7028 7772 6170 5f61 7267  ree_map(wrap_arg
+000126a0: 2c20 6172 6773 290a 2020 2020 2020 2020  , args).        
+000126b0: 2320 4578 7065 6374 696e 6720 4a56 5044  # Expecting JVPD
+000126c0: 7561 6c73 2077 7261 7070 696e 6720 7061  uals wrapping pa
+000126d0: 6972 7320 6f66 2070 7269 6d61 6c73 2061  irs of primals a
+000126e0: 6e64 2074 616e 6765 6e74 730a 2020 2020  nd tangents.    
+000126f0: 2020 2020 6173 7365 7274 2061 6c6c 2869      assert all(i
+00012700: 7369 6e73 7461 6e63 6528 6172 672c 204a  sinstance(arg, J
+00012710: 5650 4475 616c 2920 666f 7220 6172 6720  VPDual) for arg 
+00012720: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
+00012730: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
+00012740: 2020 7265 7475 726e 206a 7670 5f69 6d70    return jvp_imp
+00012750: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
+00012760: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
+00012770: 6a76 705f 696d 706c 0a0a 0a64 6566 205f  jvp_impl...def _
+00012780: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
+00012790: 6328 6465 7461 6368 6564 3a20 626f 6f6c  c(detached: bool
+000127a0: 2c20 7072 696d 616c 732c 2074 616e 6765  , primals, tange
+000127b0: 6e74 732c 202a 2c20 6675 6e63 7469 6f6e  nts, *, function
+000127c0: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
+000127d0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+000127e0: 224d 6574 6166 756e 6374 696f 6e20 666f  "Metafunction fo
+000127f0: 7220 7468 6520 4a56 5020 7472 616e 7366  r the JVP transf
+00012800: 6f72 6d2e 0a0a 2020 2020 4172 6773 3a0a  orm...    Args:.
+00012810: 2020 2020 2020 2020 6465 7461 6368 6564          detached
+00012820: 2028 626f 6f6c 293a 2057 6865 7468 6572   (bool): Whether
+00012830: 2074 6f20 6465 7461 6368 2074 6865 2074   to detach the t
+00012840: 7261 6365 2e0a 2020 2020 2020 2020 7072  race..        pr
+00012850: 696d 616c 7320 2854 7570 6c65 5b50 726f  imals (Tuple[Pro
+00012860: 7879 5d29 3a20 5072 696d 616c 2076 616c  xy]): Primal val
+00012870: 7565 732e 0a20 2020 2020 2020 2074 616e  ues..        tan
+00012880: 6765 6e74 7320 2854 7570 6c65 5b50 726f  gents (Tuple[Pro
+00012890: 7879 5d29 3a20 5461 6e67 656e 7420 7661  xy]): Tangent va
+000128a0: 6c75 6573 2e0a 2020 2020 2020 2020 6675  lues..        fu
+000128b0: 6e63 7469 6f6e 5f74 7261 6365 2028 5472  nction_trace (Tr
+000128c0: 6163 6529 3a20 5472 6163 6520 6f66 2074  ace): Trace of t
+000128d0: 6865 2066 756e 6374 696f 6e20 746f 2062  he function to b
+000128e0: 6520 7472 616e 7366 6f72 6d65 642e 0a20  e transformed.. 
+000128f0: 2020 2020 2020 206b 7761 7267 733a 204b         kwargs: K
+00012900: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
+00012910: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
+00012920: 2020 2020 2020 2041 7373 6572 7469 6f6e         Assertion
+00012930: 4572 726f 723a 2049 6620 7468 6520 4a56  Error: If the JV
+00012940: 5020 666f 7220 6b65 7977 6f72 6420 6172  P for keyword ar
+00012950: 6775 6d65 6e74 7320 6973 206e 6f74 2069  guments is not i
+00012960: 6d70 6c65 6d65 6e74 6564 2e0a 0a20 2020  mplemented...   
+00012970: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00012980: 2020 5265 7375 6c74 206f 6620 7468 6520    Result of the 
+00012990: 4a56 5020 7472 616e 7366 6f72 6d2e 0a20  JVP transform.. 
+000129a0: 2020 2022 2222 0a20 2020 2061 7373 6572     """.    asser
+000129b0: 7420 6c65 6e28 6b77 6172 6773 2920 3d3d  t len(kwargs) ==
+000129c0: 2030 2c20 224a 5650 2066 6f72 206b 7761   0, "JVP for kwa
+000129d0: 7267 7320 6973 206e 6f74 2069 6d70 6c65  rgs is not imple
+000129e0: 6d65 6e74 6564 220a 0a20 2020 2063 7478  mented"..    ctx
+000129f0: 203d 2064 6574 6163 6865 645f 7472 6163   = detached_trac
+00012a00: 6528 2920 6966 2064 6574 6163 6865 6420  e() if detached 
+00012a10: 656c 7365 206e 756c 6c63 6f6e 7465 7874  else nullcontext
+00012a20: 2829 0a20 2020 2077 6974 6820 6374 783a  ().    with ctx:
+00012a30: 0a20 2020 2020 2020 2023 2057 7261 7070  .        # Wrapp
+00012a40: 696e 6720 7468 6520 7072 696d 616c 7320  ing the primals 
+00012a50: 616e 6420 7461 6e67 656e 7473 2069 6e20  and tangents in 
+00012a60: 4a56 5044 7561 6c73 2069 7320 6e6f 7420  JVPDuals is not 
+00012a70: 7374 7269 6374 6c79 206e 6563 6573 7361  strictly necessa
+00012a80: 7279 2c20 6275 7420 6974 206d 616b 6573  ry, but it makes
+00012a90: 0a20 2020 2020 2020 2023 2074 6865 2063  .        # the c
+00012aa0: 6f64 6520 6d6f 7265 2072 6561 6461 626c  ode more readabl
+00012ab0: 650a 2020 2020 2020 2020 2320 5765 2070  e.        # We p
+00012ac0: 726f 7061 6761 7465 2074 6865 204a 5650  ropagate the JVP
+00012ad0: 4475 616c 7320 7468 726f 7567 6820 7468  Duals through th
+00012ae0: 6520 7472 6163 652c 2061 6e64 2074 6865  e trace, and the
+00012af0: 6e20 756e 7772 6170 2074 6865 6d20 6174  n unwrap them at
+00012b00: 2074 6865 2065 6e64 0a20 2020 2020 2020   the end.       
+00012b10: 2070 7269 6d61 6c73 5f74 616e 6765 6e74   primals_tangent
+00012b20: 735f 6475 616c 7320 3d20 7361 6665 5f6d  s_duals = safe_m
+00012b30: 6170 2870 6169 725f 746f 5f6a 7670 5f64  ap(pair_to_jvp_d
+00012b40: 7561 6c2c 2073 6166 655f 7a69 7028 7072  ual, safe_zip(pr
+00012b50: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
+00012b60: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
+00012b70: 203d 2065 7661 6c5f 7472 6163 6528 6675   = eval_trace(fu
+00012b80: 6e63 7469 6f6e 5f74 7261 6365 2c20 2a70  nction_trace, *p
+00012b90: 7269 6d61 6c73 5f74 616e 6765 6e74 735f  rimals_tangents_
+00012ba0: 6475 616c 732c 2073 796d 626f 6c5f 6d61  duals, symbol_ma
+00012bb0: 7070 6572 3d6a 7670 5f73 796d 626f 6c5f  pper=jvp_symbol_
+00012bc0: 6d61 7070 6572 290a 2020 2020 2020 2020  mapper).        
+00012bd0: 2320 556e 7772 6170 7069 6e67 2074 6865  # Unwrapping the
+00012be0: 204a 5650 4475 616c 730a 2020 2020 2020   JVPDuals.      
+00012bf0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00012c00: 7265 7375 6c74 2c20 5365 7175 656e 6365  result, Sequence
+00012c10: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+00012c20: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
+00012c30: 616e 6365 2878 2c20 4a56 5044 7561 6c29  ance(x, JVPDual)
+00012c40: 2066 6f72 2078 2069 6e20 7265 7375 6c74   for x in result
+00012c50: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+00012c60: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
+00012c70: 3d20 756e 7a69 7032 2872 6573 756c 7429  = unzip2(result)
+00012c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00012c90: 7572 6e20 7072 696d 616c 732c 2074 616e  urn primals, tan
+00012ca0: 6765 6e74 730a 2020 2020 2020 2020 6173  gents.        as
+00012cb0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00012cc0: 7265 7375 6c74 2c20 4a56 5044 7561 6c29  result, JVPDual)
+00012cd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00012ce0: 7265 7375 6c74 2e70 7269 6d61 6c2c 2072  result.primal, r
+00012cf0: 6573 756c 742e 7461 6e67 656e 740a 0a0a  esult.tangent...
+00012d00: 6a76 705f 6361 6c6c 203d 2053 796d 626f  jvp_call = Symbo
+00012d10: 6c28 6964 3d54 7261 6e73 666f 726d 732e  l(id=Transforms.
+00012d20: 4a76 704f 702c 206e 616d 653d 226a 7670  JvpOp, name="jvp
+00012d30: 5f63 616c 6c22 2c20 6d65 7461 3d70 6172  _call", meta=par
+00012d40: 7469 616c 285f 6a76 705f 6361 6c6c 5f6d  tial(_jvp_call_m
+00012d50: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
+00012d60: 0a0a 0a64 6566 205f 6964 656e 7469 7479  ...def _identity
+00012d70: 5f63 616c 6c5f 6a76 7028 2a61 7267 733a  _call_jvp(*args:
+00012d80: 204a 5650 4475 616c 2c20 7472 6163 653a   JVPDual, trace:
+00012d90: 2054 7261 6365 2c20 2a2a 6b77 6172 6773   Trace, **kwargs
+00012da0: 293a 0a20 2020 2070 7269 6d61 6c73 2c20  ):.    primals, 
+00012db0: 7461 6e67 656e 7473 203d 2075 6e7a 6970  tangents = unzip
+00012dc0: 3228 6172 6773 290a 2020 2020 6f75 745f  2(args).    out_
+00012dd0: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00012de0: 6765 6e74 7320 3d20 5f6a 7670 5f63 616c  gents = _jvp_cal
+00012df0: 6c5f 6d65 7461 6675 6e63 2846 616c 7365  l_metafunc(False
+00012e00: 2c20 7072 696d 616c 732c 2074 616e 6765  , primals, tange
+00012e10: 6e74 732c 2074 7261 6365 2c20 2a2a 6b77  nts, trace, **kw
+00012e20: 6172 6773 290a 2020 2020 6966 2069 7369  args).    if isi
+00012e30: 6e73 7461 6e63 6528 6f75 745f 7072 696d  nstance(out_prim
+00012e40: 616c 732c 2053 6571 7565 6e63 6529 3a0a  als, Sequence):.
+00012e50: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00012e60: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+00012e70: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
+00012e80: 6970 286f 7574 5f70 7269 6d61 6c73 2c20  ip(out_primals, 
+00012e90: 6f75 745f 7461 6e67 656e 7473 2929 0a20  out_tangents)). 
+00012ea0: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
+00012eb0: 6c28 6f75 745f 7072 696d 616c 732c 206f  l(out_primals, o
+00012ec0: 7574 5f74 616e 6765 6e74 7329 0a0a 0a6a  ut_tangents)...j
+00012ed0: 7670 5f69 6d70 6c73 5b54 7261 6e73 666f  vp_impls[Transfo
+00012ee0: 726d 732e 4964 656e 7469 7479 4f70 5d20  rms.IdentityOp] 
+00012ef0: 3d20 5f69 6465 6e74 6974 795f 6361 6c6c  = _identity_call
+00012f00: 5f6a 7670 0a0a 0a64 6566 205f 766d 6170  _jvp...def _vmap
+00012f10: 5f63 616c 6c5f 6a76 7028 6172 6773 3a20  _call_jvp(args: 
+00012f20: 4a56 5044 7561 6c2c 2069 6e5f 6469 6d73  JVPDual, in_dims
+00012f30: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
+00012f40: 5f73 697a 652c 2074 7261 6365 3a20 5472  _size, trace: Tr
+00012f50: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
+00012f60: 2020 2020 7072 696d 616c 732c 2074 616e      primals, tan
+00012f70: 6765 6e74 7320 3d20 7361 6665 5f7a 6970  gents = safe_zip
+00012f80: 282a 6172 6773 290a 2020 2020 696e 5f64  (*args).    in_d
+00012f90: 696d 732c 205f 203d 2073 6166 655f 7a69  ims, _ = safe_zi
+00012fa0: 7028 2a69 6e5f 6469 6d73 290a 2020 2020  p(*in_dims).    
+00012fb0: 6f75 745f 6469 6d73 2c20 5f20 3d20 7361  out_dims, _ = sa
+00012fc0: 6665 5f7a 6970 282a 6f75 745f 6469 6d73  fe_zip(*out_dims
+00012fd0: 290a 2020 2020 766d 6170 7065 645f 7472  ).    vmapped_tr
+00012fe0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+00012ff0: 7472 6163 6528 2928 0a20 2020 2020 2020  trace()(.       
+00013000: 2076 6d61 7028 7061 7274 6961 6c28 6576   vmap(partial(ev
+00013010: 616c 5f74 7261 6365 2c20 7472 6163 6529  al_trace, trace)
+00013020: 2c20 696e 5f64 696d 733d 696e 5f64 696d  , in_dims=in_dim
+00013030: 732c 206f 7574 5f64 696d 733d 6f75 745f  s, out_dims=out_
+00013040: 6469 6d73 2c20 6178 6973 5f73 697a 653d  dims, axis_size=
+00013050: 6178 6973 5f73 697a 6529 2c20 2a70 7269  axis_size), *pri
+00013060: 6d61 6c73 0a20 2020 2029 0a20 2020 2076  mals.    ).    v
+00013070: 6d61 7070 6564 5f66 756e 6320 3d20 7061  mapped_func = pa
+00013080: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
+00013090: 2c20 766d 6170 7065 645f 7472 6163 6529  , vmapped_trace)
+000130a0: 0a20 2020 206f 7574 5f70 7269 6d61 6c73  .    out_primals
+000130b0: 2c20 6f75 745f 7461 6e67 656e 7473 203d  , out_tangents =
+000130c0: 206a 7670 2876 6d61 7070 6564 5f66 756e   jvp(vmapped_fun
+000130d0: 6329 2870 7269 6d61 6c73 2c20 7461 6e67  c)(primals, tang
+000130e0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
+000130f0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00013100: 6528 6f75 745f 7072 696d 616c 732c 2053  e(out_primals, S
+00013110: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00013120: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
+00013130: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
+00013140: 616c 2c20 7361 6665 5f7a 6970 286f 7574  al, safe_zip(out
+00013150: 5f70 7269 6d61 6c73 2c20 6f75 745f 7461  _primals, out_ta
+00013160: 6e67 656e 7473 2929 0a20 2020 2072 6574  ngents)).    ret
+00013170: 7572 6e20 4a56 5044 7561 6c28 6f75 745f  urn JVPDual(out_
+00013180: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
+00013190: 6765 6e74 7329 0a0a 0a6a 7670 5f69 6d70  gents)...jvp_imp
+000131a0: 6c73 5b54 7261 6e73 666f 726d 732e 566d  ls[Transforms.Vm
+000131b0: 6170 4f70 5d20 3d20 5f76 6d61 705f 6361  apOp] = _vmap_ca
+000131c0: 6c6c 5f6a 7670 0a0a 0a64 6566 206a 7670  ll_jvp...def jvp
+000131d0: 2866 756e 6329 3a0a 2020 2020 2222 224a  (func):.    """J
+000131e0: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
+000131f0: 726f 6475 6374 2074 7261 6e73 666f 726d  roduct transform
+00013200: 2066 6f72 2061 2054 6875 6e64 6572 2066   for a Thunder f
+00013210: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
+00013220: 6773 3a0a 2020 2020 2020 2020 6675 6e63  gs:.        func
+00013230: 2028 4361 6c6c 6162 6c65 293a 2041 2054   (Callable): A T
+00013240: 6875 6e64 6572 2066 756e 6374 696f 6e20  hunder function 
+00013250: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
+00013260: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
+00013270: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
+00013280: 653a 2041 2066 756e 6374 696f 6e20 7468  e: A function th
+00013290: 6174 2063 6f6d 7075 7465 7320 7468 6520  at computes the 
+000132a0: 4a61 636f 6269 616e 2d76 6563 746f 7220  Jacobian-vector 
+000132b0: 7072 6f64 7563 740a 2020 2020 2020 2020  product.        
+000132c0: 2020 2020 7461 6b69 6e67 2070 7269 6d61      taking prima
+000132d0: 6c73 2061 6e64 2074 616e 6765 6e74 7320  ls and tangents 
+000132e0: 6173 2061 7267 756d 656e 7473 2e0a 2020  as arguments..  
+000132f0: 2020 2222 220a 0a20 2020 2064 6566 2077    """..    def w
+00013300: 7261 7070 6572 2870 7269 6d61 6c73 2c20  rapper(primals, 
+00013310: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
+00013320: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+00013330: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
+00013340: 632c 202a 7072 696d 616c 7329 0a20 2020  c, *primals).   
+00013350: 2020 2020 2072 6574 7572 6e20 6a76 705f       return jvp_
+00013360: 6361 6c6c 2870 7269 6d61 6c73 2c20 7461  call(primals, ta
+00013370: 6e67 656e 7473 2c20 6675 6e63 7469 6f6e  ngents, function
+00013380: 5f74 7261 6365 3d74 7261 6365 290a 0a20  _trace=trace).. 
+00013390: 2020 2072 6574 7572 6e20 7772 6170 7065     return wrappe
+000133a0: 720a 0a0a 2320 544f 444f 2054 6869 7320  r...# TODO This 
+000133b0: 6675 6e63 7469 6f6e 2063 6f6d 6d65 6e74  function comment
+000133c0: 6564 206f 7574 2062 6563 6175 7365 2069  ed out because i
+000133d0: 7420 6361 6c6c 7320 6d61 6b65 5f74 7261  t calls make_tra
+000133e0: 6365 642c 2077 6869 6368 2064 6f65 7320  ced, which does 
+000133f0: 6e6f 7420 6578 6973 740a 2320 6465 6620  not exist.# def 
+00013400: 6a76 705f 6561 6765 7228 6675 6e63 2c20  jvp_eager(func, 
+00013410: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00013420: 732c 2065 7865 6375 746f 723d 2274 6f72  s, executor="tor
+00013430: 6368 2229 3a0a 2320 2020 2020 2222 2243  ch"):.#     """C
+00013440: 6f6d 7075 7465 7320 7468 6520 4a61 636f  omputes the Jaco
+00013450: 6269 616e 2d76 6563 746f 7220 7072 6f64  bian-vector prod
+00013460: 7563 7420 6f66 2061 2054 6875 6e64 6572  uct of a Thunder
+00013470: 2066 756e 6374 696f 6e2e 0a0a 2320 2020   function...#   
+00013480: 2020 4172 6773 3a0a 2320 2020 2020 2020    Args:.#       
+00013490: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
+000134a0: 293a 2041 2054 6875 6e64 6572 2066 756e  ): A Thunder fun
+000134b0: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
+000134c0: 7366 6f72 6d65 642e 0a23 2020 2020 2020  sformed..#      
+000134d0: 2020 2070 7269 6d61 6c73 2028 5f74 7970     primals (_typ
+000134e0: 655f 293a 2050 7269 6d61 6c73 206f 6620  e_): Primals of 
+000134f0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2320  the function..# 
+00013500: 2020 2020 2020 2020 7461 6e67 656e 7473          tangents
+00013510: 2028 5f74 7970 655f 293a 2054 616e 6765   (_type_): Tange
+00013520: 6e74 7320 6f66 2074 6865 2066 756e 6374  nts of the funct
+00013530: 696f 6e2e 0a23 2020 2020 2020 2020 2065  ion..#         e
+00013540: 7865 6375 746f 7220 2873 7472 2c20 6f70  xecutor (str, op
+00013550: 7469 6f6e 616c 293a 2045 7865 6375 746f  tional): Executo
+00013560: 7220 746f 2075 7365 2e20 4465 6661 756c  r to use. Defaul
+00013570: 7473 2074 6f20 2274 6f72 6368 222e 0a0a  ts to "torch"...
+00013580: 2320 2020 2020 5265 7475 726e 733a 0a23  #     Returns:.#
+00013590: 2020 2020 2020 2020 2054 6865 2072 6573           The res
+000135a0: 756c 7420 6f66 2074 6865 204a 6163 6f62  ult of the Jacob
+000135b0: 6961 6e2d 7665 6374 6f72 2070 726f 6475  ian-vector produ
+000135c0: 6374 2e0a 2320 2020 2020 2222 220a 2320  ct..#     """.# 
+000135d0: 2020 2020 7472 6163 6520 3d20 6d61 6b65      trace = make
+000135e0: 5f74 7261 6365 2866 756e 632c 2065 7865  _trace(func, exe
+000135f0: 6375 746f 723d 6578 6563 7574 6f72 2c20  cutor=executor, 
+00013600: 2a70 7269 6d61 6c73 290a 0a23 2020 2020  *primals)..#    
+00013610: 2064 6566 206a 7670 5f66 756e 6328 2a70   def jvp_func(*p
+00013620: 7269 6d61 6c73 5f61 6e64 5f74 616e 6765  rimals_and_tange
+00013630: 6e74 7329 3a0a 2320 2020 2020 2020 2020  nts):.#         
+00013640: 5f70 7269 6d61 6c73 2c20 5f74 616e 6765  _primals, _tange
+00013650: 6e74 7320 3d20 7072 696d 616c 735f 616e  nts = primals_an
+00013660: 645f 7461 6e67 656e 7473 5b3a 206c 656e  d_tangents[: len
+00013670: 2870 7269 6d61 6c73 295d 2c20 7072 696d  (primals)], prim
+00013680: 616c 735f 616e 645f 7461 6e67 656e 7473  als_and_tangents
+00013690: 5b6c 656e 2870 7269 6d61 6c73 2920 3a5d  [len(primals) :]
+000136a0: 0a23 2020 2020 2020 2020 2072 6574 7572  .#         retur
+000136b0: 6e20 5f6a 7670 5f63 616c 6c5f 6d65 7461  n _jvp_call_meta
+000136c0: 6675 6e63 285f 7072 696d 616c 732c 205f  func(_primals, _
+000136d0: 7461 6e67 656e 7473 2c20 7472 6163 652c  tangents, trace,
+000136e0: 2064 6574 6163 6865 643d 4661 6c73 6529   detached=False)
+000136f0: 0a0a 2320 2020 2020 6a76 705f 7472 6163  ..#     jvp_trac
+00013700: 6520 3d20 6d61 6b65 5f74 7261 6365 286a  e = make_trace(j
+00013710: 7670 5f66 756e 632c 2065 7865 6375 746f  vp_func, executo
+00013720: 723d 6578 6563 7574 6f72 2928 2a70 7269  r=executor)(*pri
+00013730: 6d61 6c73 2c20 2a74 616e 6765 6e74 7329  mals, *tangents)
+00013740: 0a23 2020 2020 206a 7670 5f74 7261 6365  .#     jvp_trace
+00013750: 6420 3d20 6d61 6b65 5f74 7261 6365 6428  d = make_traced(
+00013760: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
+00013770: 6365 2c20 6a76 705f 7472 6163 6529 2c20  ce, jvp_trace), 
+00013780: 6578 6563 7574 6f72 3d65 7865 6375 746f  executor=executo
+00013790: 7229 0a23 2020 2020 2072 6574 7572 6e20  r).#     return 
+000137a0: 6a76 705f 7472 6163 6564 282a 7072 696d  jvp_traced(*prim
+000137b0: 616c 732c 202a 7461 6e67 656e 7473 290a  als, *tangents).
+000137c0: 0a0a 2320 564a 5020 7472 616e 7366 6f72  ..# VJP transfor
+000137d0: 6d0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  m.# ============
+000137e0: 3d0a 4064 6174 6163 6c61 7373 2866 726f  =.@dataclass(fro
+000137f0: 7a65 6e3d 5472 7565 290a 636c 6173 7320  zen=True).class 
+00013800: 564a 5044 7561 6c3a 0a20 2020 2022 2222  VJPDual:.    """
+00013810: 4120 7061 6972 206f 6620 7072 696d 616c  A pair of primal
+00013820: 2061 6e64 2073 6176 6564 2069 6e66 6f72   and saved infor
+00013830: 6d61 7469 6f6e 2066 6f72 2062 6163 6b77  mation for backw
+00013840: 6172 6420 2872 6573 6964 7561 6c73 292e  ard (residuals).
+00013850: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00013860: 2020 2020 7072 696d 616c 2028 556e 696f      primal (Unio
+00013870: 6e5b 5072 6f78 792c 204e 756d 6265 725d  n[Proxy, Number]
+00013880: 293a 2050 7269 6d61 6c20 7661 6c75 652c  ): Primal value,
+00013890: 2069 2e65 2e2c 2074 6865 2076 616c 7565   i.e., the value
+000138a0: 2062 6569 6e67 2064 6966 6665 7265 6e74   being different
+000138b0: 6961 7465 642e 0a20 2020 2020 2020 2072  iated..        r
+000138c0: 6573 6964 7561 6c73 2028 5475 706c 655b  esiduals (Tuple[
+000138d0: 5072 6f78 792c 202e 2e2e 5d29 3a20 5265  Proxy, ...]): Re
+000138e0: 7369 6475 616c 732c 2069 2e65 2e2c 2074  siduals, i.e., t
+000138f0: 6865 2076 616c 7565 7320 7468 6174 2061  he values that a
+00013900: 7265 0a20 2020 2020 2020 2020 2020 2073  re.            s
+00013910: 6176 6564 2066 6f72 2074 6865 2062 6163  aved for the bac
+00013920: 6b77 6172 642e 0a0a 2020 2020 5969 656c  kward...    Yiel
+00013930: 6473 3a0a 2020 2020 2020 2020 5475 706c  ds:.        Tupl
+00013940: 655b 5661 7269 6162 6c65 2c20 5475 706c  e[Variable, Tupl
+00013950: 655b 5661 7269 6162 6c65 2c20 2e2e 2e5d  e[Variable, ...]
+00013960: 2c20 4361 6c6c 6162 6c65 5d3a 2050 7269  , Callable]: Pri
+00013970: 6d61 6c20 616e 6420 7265 7369 6475 616c  mal and residual
+00013980: 730a 2020 2020 2222 220a 0a20 2020 2070  s.    """..    p
+00013990: 7269 6d61 6c3a 2050 726f 7879 207c 204e  rimal: Proxy | N
+000139a0: 756d 6265 720a 2020 2020 7265 7369 6475  umber.    residu
+000139b0: 616c 733a 2074 7570 6c65 5b50 726f 7879  als: tuple[Proxy
+000139c0: 2c20 2e2e 2e5d 0a0a 2020 2020 6465 6620  , ...]..    def 
+000139d0: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
+000139e0: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+000139f0: 6c66 2e70 7269 6d61 6c0a 2020 2020 2020  lf.primal.      
+00013a00: 2020 7969 656c 6420 7365 6c66 2e72 6573    yield self.res
+00013a10: 6964 7561 6c73 0a0a 0a63 6c61 7373 204e  iduals...class N
+00013a20: 6f50 756c 6c62 6163 6b3a 0a20 2020 2022  oPullback:.    "
+00013a30: 2222 4120 6475 6d6d 7920 7075 6c6c 6261  ""A dummy pullba
+00013a40: 636b 2066 756e 6374 696f 6e20 7468 6174  ck function that
+00013a50: 2072 6574 7572 6e73 204e 6f6e 6520 6f72   returns None or
+00013a60: 2072 6169 7365 7320 616e 2065 7272 6f72   raises an error
+00013a70: 2e22 2222 0a0a 2020 2020 6465 6620 5f5f  ."""..    def __
+00013a80: 696e 6974 5f5f 2873 656c 662c 206e 756d  init__(self, num
+00013a90: 5f61 7267 733d 3029 3a0a 2020 2020 2020  _args=0):.      
+00013aa0: 2020 7365 6c66 2e6e 756d 5f61 7267 7320    self.num_args 
+00013ab0: 3d20 6e75 6d5f 6172 6773 0a0a 2020 2020  = num_args..    
+00013ac0: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
+00013ad0: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
+00013ae0: 6773 293a 0a20 2020 2020 2020 2069 6620  gs):.        if 
+00013af0: 7365 6c66 2e6e 756d 5f61 7267 7320 3e20  self.num_args > 
+00013b00: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00013b10: 6574 7572 6e20 284e 6f6e 652c 2920 2a20  eturn (None,) * 
+00013b20: 7365 6c66 2e6e 756d 5f61 7267 730a 2020  self.num_args.  
+00013b30: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00013b40: 696d 6545 7272 6f72 2822 5075 6c6c 6261  imeError("Pullba
+00013b50: 636b 2063 616c 6c65 6420 6f6e 2061 206e  ck called on a n
+00013b60: 6f6e 2d64 6966 6665 7265 6e74 6961 626c  on-differentiabl
+00013b70: 6520 7379 6d62 6f6c 206f 7220 6120 636f  e symbol or a co
+00013b80: 6e73 7461 6e74 2e22 290a 0a0a 636c 6173  nstant.")...clas
+00013b90: 7320 5a65 726f 4261 636b 7761 7264 3a0a  s ZeroBackward:.
+00013ba0: 2020 2020 2222 2241 2068 656c 7065 7220      """A helper 
+00013bb0: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
+00013bc0: 6e20 7468 6174 2072 6574 7572 6e73 207a  n that returns z
+00013bd0: 6572 6f73 2e22 2222 0a0a 2020 2020 6465  eros."""..    de
+00013be0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00013bf0: 206e 756d 5f61 7267 7329 3a0a 2020 2020   num_args):.    
+00013c00: 2020 2020 7365 6c66 2e6e 756d 5f61 7267      self.num_arg
+00013c10: 7320 3d20 6e75 6d5f 6172 6773 0a0a 2020  s = num_args..  
+00013c20: 2020 6465 6620 5f5f 6361 6c6c 5f5f 2873    def __call__(s
+00013c30: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
+00013c40: 6172 6773 293a 0a20 2020 2020 2020 2023  args):.        #
+00013c50: 2041 7373 756d 696e 6720 7468 6174 2074   Assuming that t
+00013c60: 6865 2066 6972 7374 2061 7267 756d 656e  he first argumen
+00013c70: 7473 2061 7265 2074 6865 2066 6f72 7761  ts are the forwa
+00013c80: 7264 2061 7267 756d 656e 7473 0a20 2020  rd arguments.   
+00013c90: 2020 2020 2066 6f72 7761 7264 5f61 7267       forward_arg
+00013ca0: 7320 3d20 6172 6773 5b3a 2073 656c 662e  s = args[: self.
+00013cb0: 6e75 6d5f 6172 6773 5d0a 0a20 2020 2020  num_args]..     
+00013cc0: 2020 2064 6566 207a 6572 6f73 5f6c 696b     def zeros_lik
+00013cd0: 6528 7829 3a0a 2020 2020 2020 2020 2020  e(x):.          
+00013ce0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00013cf0: 782c 2054 656e 736f 7250 726f 7879 293a  x, TensorProxy):
+00013d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013d10: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
+00013d20: 6528 782c 2066 696c 6c5f 7661 6c75 653d  e(x, fill_value=
+00013d30: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
+00013d40: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
+00013d50: 2c20 4e75 6d62 6572 5072 6f78 7929 3a0a  , NumberProxy):.
+00013d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d70: 7265 7475 726e 2074 7970 6528 782e 7661  return type(x.va
+00013d80: 6c75 6529 2830 290a 2020 2020 2020 2020  lue)(0).        
+00013d90: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00013da0: 6e63 6528 782c 204e 756d 6265 7229 3a0a  nce(x, Number):.
+00013db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013dc0: 7265 7475 726e 2074 7970 6528 7829 2830  return type(x)(0
+00013dd0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00013de0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00013df0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00013e00: 7272 6f72 2866 227a 6572 6f73 5f6c 696b  rror(f"zeros_lik
+00013e10: 6520 696e 7369 6465 205a 6572 6f42 6163  e inside ZeroBac
+00013e20: 6b77 6172 6420 676f 7420 616e 2075 6e73  kward got an uns
+00013e30: 7570 706f 7274 6564 2074 7970 6520 7b74  upported type {t
+00013e40: 7970 6528 7829 7d22 290a 0a20 2020 2020  ype(x)}")..     
+00013e50: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+00013e60: 7a65 726f 735f 6c69 6b65 2861 7267 2920  zeros_like(arg) 
+00013e70: 666f 7220 6172 6720 696e 2066 6f72 7761  for arg in forwa
+00013e80: 7264 5f61 7267 7329 0a0a 0a23 204d 6170  rd_args)...# Map
+00013e90: 7069 6e67 2066 726f 6d20 7379 6d62 6f6c  ping from symbol
+00013ea0: 7320 746f 2061 7567 6d65 6e74 6564 2070  s to augmented p
+00013eb0: 7269 6d61 6c20 2866 6f72 7761 7264 2920  rimal (forward) 
+00013ec0: 6675 6e63 7469 6f6e 7320 7573 6564 2069  functions used i
+00013ed0: 6e20 564a 500a 2320 5468 6520 6175 676d  n VJP.# The augm
+00013ee0: 656e 7465 645f 7072 696d 616c 2066 756e  ented_primal fun
+00013ef0: 6374 696f 6e20 7461 6b65 7320 7468 6520  ction takes the 
+00013f00: 7072 696d 616c 2076 616c 7565 7320 616e  primal values an
+00013f10: 6420 7265 7475 726e 7320 7468 6520 7072  d returns the pr
+00013f20: 696d 616c 0a23 2072 6573 756c 7420 616e  imal.# result an
+00013f30: 6420 7468 6520 7265 7369 6475 616c 7320  d the residuals 
+00013f40: 2873 6176 6564 2076 616c 7565 7320 666f  (saved values fo
+00013f50: 7220 7468 6520 6261 636b 7761 7264 292e  r the backward).
+00013f60: 0a61 7567 6d65 6e74 6564 5f66 6f72 7761  .augmented_forwa
+00013f70: 7264 5f69 6d70 6c73 203d 207b 0a20 2020  rd_impls = {.   
+00013f80: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00013f90: 434f 533a 206c 616d 6264 6120 783a 2028  COS: lambda x: (
+00013fa0: 7072 696d 732e 6163 6f73 2878 292c 2028  prims.acos(x), (
+00013fb0: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
+00013fc0: 5072 696d 4944 732e 4143 4f53 483a 206c  PrimIDs.ACOSH: l
+00013fd0: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
+00013fe0: 6163 6f73 6828 7829 2c20 2878 2c29 292c  acosh(x), (x,)),
+00013ff0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014000: 4473 2e41 5349 4e3a 206c 616d 6264 6120  Ds.ASIN: lambda 
+00014010: 783a 2028 7072 696d 732e 6173 696e 2878  x: (prims.asin(x
+00014020: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+00014030: 696d 732e 5072 696d 4944 732e 4153 494e  ims.PrimIDs.ASIN
+00014040: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
+00014050: 696d 732e 6173 696e 6828 7829 2c20 2878  ims.asinh(x), (x
+00014060: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014070: 7269 6d49 4473 2e41 5441 4e3a 206c 616d  rimIDs.ATAN: lam
+00014080: 6264 6120 783a 2028 7072 696d 732e 6174  bda x: (prims.at
+00014090: 616e 2878 292c 2028 782c 2929 2c0a 2020  an(x), (x,)),.  
+000140a0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+000140b0: 4154 414e 483a 206c 616d 6264 6120 783a  ATANH: lambda x:
+000140c0: 2028 7072 696d 732e 6174 616e 6828 7829   (prims.atanh(x)
+000140d0: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+000140e0: 6d73 2e50 7269 6d49 4473 2e41 5441 4e32  ms.PrimIDs.ATAN2
+000140f0: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
+00014100: 7072 696d 732e 6174 616e 3228 782c 2079  prims.atan2(x, y
+00014110: 292c 2028 782c 2079 2929 2c0a 2020 2020  ), (x, y)),.    
+00014120: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
+00014130: 5348 3a20 6c61 6d62 6461 2078 3a20 2870  SH: lambda x: (p
+00014140: 7269 6d73 2e63 6f73 6828 7829 2c20 2878  rims.cosh(x), (x
+00014150: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014160: 7269 6d49 4473 2e44 4947 414d 4d41 3a20  rimIDs.DIGAMMA: 
+00014170: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+00014180: 2e64 6967 616d 6d61 2878 292c 2028 782c  .digamma(x), (x,
+00014190: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000141a0: 696d 4944 732e 4552 4643 3a20 6c61 6d62  imIDs.ERFC: lamb
+000141b0: 6461 2078 3a20 2870 7269 6d73 2e65 7266  da x: (prims.erf
+000141c0: 6328 7829 2c20 2878 2c29 292c 0a20 2020  c(x), (x,)),.   
+000141d0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+000141e0: 5246 494e 563a 206c 616d 6264 6120 783a  RFINV: lambda x:
+000141f0: 2028 7072 696d 732e 6572 6669 6e76 2878   (prims.erfinv(x
+00014200: 292c 2028 7072 696d 732e 6572 6669 6e76  ), (prims.erfinv
+00014210: 2878 292c 2929 2c0a 2020 2020 7072 696d  (x),)),.    prim
+00014220: 732e 5072 696d 4944 732e 4552 4643 494e  s.PrimIDs.ERFCIN
+00014230: 563a 206c 616d 6264 6120 783a 2028 7072  V: lambda x: (pr
+00014240: 696d 732e 6572 6663 696e 7628 7829 2c20  ims.erfcinv(x), 
+00014250: 2870 7269 6d73 2e65 7266 6369 6e76 2878  (prims.erfcinv(x
+00014260: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+00014270: 5072 696d 4944 732e 4558 5032 3a20 6c61  PrimIDs.EXP2: la
+00014280: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
+00014290: 7870 3228 7829 2c20 2870 7269 6d73 2e65  xp2(x), (prims.e
+000142a0: 7870 3228 7829 2c29 292c 0a20 2020 2070  xp2(x),)),.    p
+000142b0: 7269 6d73 2e50 7269 6d49 4473 2e45 5850  rims.PrimIDs.EXP
+000142c0: 4d31 3a20 6c61 6d62 6461 2078 3a20 2870  M1: lambda x: (p
+000142d0: 7269 6d73 2e65 7870 6d31 2878 292c 2028  rims.expm1(x), (
+000142e0: 7072 696d 732e 6578 706d 3128 7829 2c29  prims.expm1(x),)
+000142f0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014300: 6d49 4473 2e4c 4741 4d4d 413a 206c 616d  mIDs.LGAMMA: lam
+00014310: 6264 6120 783a 2028 7072 696d 732e 6c67  bda x: (prims.lg
+00014320: 616d 6d61 2878 292c 2028 782c 2929 2c0a  amma(x), (x,)),.
+00014330: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014340: 732e 4e44 5452 493a 206c 616d 6264 6120  s.NDTRI: lambda 
+00014350: 783a 2028 7072 696d 732e 6e64 7472 6928  x: (prims.ndtri(
+00014360: 7829 2c20 2870 7269 6d73 2e6e 6474 7269  x), (prims.ndtri
+00014370: 2878 292c 2929 2c0a 2020 2020 7072 696d  (x),)),.    prim
+00014380: 732e 5072 696d 4944 732e 5349 4e48 3a20  s.PrimIDs.SINH: 
+00014390: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+000143a0: 2e73 696e 6828 7829 2c20 2878 2c29 292c  .sinh(x), (x,)),
+000143b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000143c0: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
+000143d0: 783a 2028 7072 696d 732e 7371 7274 2878  x: (prims.sqrt(x
+000143e0: 292c 2028 7072 696d 732e 7371 7274 2878  ), (prims.sqrt(x
+000143f0: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+00014400: 5072 696d 4944 732e 4e45 3a20 6c61 6d62  PrimIDs.NE: lamb
+00014410: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
+00014420: 6e65 2878 2c20 7929 2c20 2878 2c20 7929  ne(x, y), (x, y)
+00014430: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014440: 6d49 4473 2e47 543a 206c 616d 6264 6120  mIDs.GT: lambda 
+00014450: 782c 2079 3a20 2870 7269 6d73 2e67 7428  x, y: (prims.gt(
+00014460: 782c 2079 292c 2028 782c 2079 2929 2c0a  x, y), (x, y)),.
+00014470: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014480: 732e 4c45 3a20 6c61 6d62 6461 2078 2c20  s.LE: lambda x, 
+00014490: 793a 2028 7072 696d 732e 6c65 2878 2c20  y: (prims.le(x, 
+000144a0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
+000144b0: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
+000144c0: 4f47 3130 3a20 6c61 6d62 6461 2078 3a20  OG10: lambda x: 
+000144d0: 2870 7269 6d73 2e6c 6f67 3130 2878 292c  (prims.log10(x),
+000144e0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+000144f0: 732e 5072 696d 4944 732e 4c4f 4731 503a  s.PrimIDs.LOG1P:
+00014500: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014510: 732e 6c6f 6731 7028 7829 2c20 2878 2c29  s.log1p(x), (x,)
+00014520: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014530: 6d49 4473 2e4c 4f47 323a 206c 616d 6264  mIDs.LOG2: lambd
+00014540: 6120 783a 2028 7072 696d 732e 6c6f 6732  a x: (prims.log2
+00014550: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+00014560: 7072 696d 732e 5072 696d 4944 732e 5a45  prims.PrimIDs.ZE
+00014570: 5441 3a20 6c61 6d62 6461 2078 2c20 793a  TA: lambda x, y:
+00014580: 2028 7072 696d 732e 7a65 7461 2878 2c20   (prims.zeta(x, 
+00014590: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
+000145a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
+000145b0: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
+000145c0: 3a20 2870 7269 6d73 2e66 6d6f 6428 782c  : (prims.fmod(x,
+000145d0: 2079 292c 2028 782c 2079 2929 2c0a 2020   y), (x, y)),.  
+000145e0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+000145f0: 434f 5059 5f3a 206c 616d 6264 6120 782c  COPY_: lambda x,
+00014600: 2079 3a20 2870 7269 6d73 2e63 6f70 795f   y: (prims.copy_
+00014610: 2878 2c20 7929 2c20 7475 706c 6528 2929  (x, y), tuple())
+00014620: 2c0a 7d0a 0a0a 2320 4d61 7070 696e 6720  ,.}...# Mapping 
+00014630: 6672 6f6d 2073 796d 626f 6c73 2074 6f20  from symbols to 
+00014640: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
+00014650: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
+00014660: 2054 6865 2062 6163 6b77 6172 6420 6675   The backward fu
+00014670: 6e63 7469 6f6e 2074 616b 6573 2074 6865  nction takes the
+00014680: 2072 6573 6964 7561 6c73 2061 6e64 2063   residuals and c
+00014690: 6f74 616e 6765 6e74 7320 616e 6420 7265  otangents and re
+000146a0: 7475 726e 7320 7468 650a 2320 7665 6374  turns the.# vect
+000146b0: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
+000146c0: 7563 7473 2066 6f72 2065 6163 6820 6172  ucts for each ar
+000146d0: 6775 6d65 6e74 2e0a 6261 636b 7761 7264  gument..backward
+000146e0: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
+000146f0: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
+00014700: 533a 206c 616d 6264 6120 782c 2067 3a20  S: lambda x, g: 
+00014710: 2d67 202f 2070 7269 6d73 2e73 7172 7428  -g / prims.sqrt(
+00014720: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
+00014730: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014740: 4143 4f53 483a 206c 616d 6264 6120 782c  ACOSH: lambda x,
+00014750: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
+00014760: 7172 7428 7820 2a20 7820 2d20 312e 3029  qrt(x * x - 1.0)
+00014770: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014780: 4944 732e 4153 494e 3a20 6c61 6d62 6461  IDs.ASIN: lambda
+00014790: 2078 2c20 673a 2067 202f 2070 7269 6d73   x, g: g / prims
+000147a0: 2e73 7172 7428 312e 3020 2d20 7820 2a20  .sqrt(1.0 - x * 
+000147b0: 7829 2c0a 2020 2020 7072 696d 732e 5072  x),.    prims.Pr
+000147c0: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
+000147d0: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
+000147e0: 696d 732e 7273 7172 7428 312e 3020 2b20  ims.rsqrt(1.0 + 
+000147f0: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
+00014800: 732e 5072 696d 4944 732e 4154 414e 3a20  s.PrimIDs.ATAN: 
+00014810: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
+00014820: 2028 312e 3020 2b20 7820 2a20 7829 2c0a   (1.0 + x * x),.
+00014830: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014840: 732e 4154 414e 483a 206c 616d 6264 6120  s.ATANH: lambda 
+00014850: 782c 2067 3a20 6720 2f20 2831 2e30 202d  x, g: g / (1.0 -
+00014860: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
+00014870: 6d73 2e50 7269 6d49 4473 2e43 4f53 483a  ms.PrimIDs.COSH:
+00014880: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
+00014890: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
+000148a0: 2e73 696e 6828 7829 292c 0a20 2020 2070  .sinh(x)),.    p
+000148b0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+000148c0: 433a 206c 616d 6264 6120 782c 2067 3a20  C: lambda x, g: 
+000148d0: 2d67 202a 2032 2e30 202f 206d 6174 682e  -g * 2.0 / math.
+000148e0: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
+000148f0: 7072 696d 732e 6578 7028 2d78 202a 2078  prims.exp(-x * x
+00014900: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00014910: 6d49 4473 2e45 5246 494e 563a 206c 616d  mIDs.ERFINV: lam
+00014920: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
+00014930: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
+00014940: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
+00014950: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
+00014960: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00014970: 696d 4944 732e 4552 4643 494e 563a 206c  imIDs.ERFCINV: l
+00014980: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
+00014990: 202d 6720 2a20 302e 3520 2a20 6d61 7468   -g * 0.5 * math
+000149a0: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
+000149b0: 2070 7269 6d73 2e65 7870 2872 6573 756c   prims.exp(resul
+000149c0: 742a 2a32 292c 0a20 2020 2070 7269 6d73  t**2),.    prims
+000149d0: 2e50 7269 6d49 4473 2e45 5850 323a 206c  .PrimIDs.EXP2: l
+000149e0: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
+000149f0: 2067 202a 2072 6573 756c 7420 2a20 6d61   g * result * ma
+00014a00: 7468 2e6c 6f67 2832 2e30 292c 0a20 2020  th.log(2.0),.   
+00014a10: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
+00014a20: 5850 4d31 3a20 6c61 6d62 6461 2072 6573  XPM1: lambda res
+00014a30: 756c 742c 2067 3a20 6720 2a20 2872 6573  ult, g: g * (res
+00014a40: 756c 7420 2b20 312e 3029 2c0a 2020 2020  ult + 1.0),.    
+00014a50: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
+00014a60: 414d 4d41 3a20 6c61 6d62 6461 2078 2c20  AMMA: lambda x, 
+00014a70: 673a 2067 202a 2070 7269 6d73 2e64 6967  g: g * prims.dig
+00014a80: 616d 6d61 2878 292c 0a20 2020 2070 7269  amma(x),.    pri
+00014a90: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
+00014aa0: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
+00014ab0: 2067 3a20 6720 2a20 7072 696d 732e 6578   g: g * prims.ex
+00014ac0: 7028 302e 3520 2a20 7265 7375 6c74 2a2a  p(0.5 * result**
+00014ad0: 3229 202a 206d 6174 682e 7371 7274 2832  2) * math.sqrt(2
+00014ae0: 2e30 202a 206d 6174 682e 7069 292c 0a20  .0 * math.pi),. 
+00014af0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014b00: 2e53 494e 483a 206c 616d 6264 6120 782c  .SINH: lambda x,
+00014b10: 2067 3a20 7072 696d 732e 6d75 6c28 672c   g: prims.mul(g,
+00014b20: 2070 7269 6d73 2e63 6f73 6828 7829 292c   prims.cosh(x)),
+00014b30: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014b40: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
+00014b50: 7265 7375 6c74 2c20 673a 2067 202f 2028  result, g: g / (
+00014b60: 322e 3020 2a20 7265 7375 6c74 292c 0a20  2.0 * result),. 
+00014b70: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014b80: 2e4e 453a 205a 6572 6f42 6163 6b77 6172  .NE: ZeroBackwar
+00014b90: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
+00014ba0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014bb0: 2e47 543a 205a 6572 6f42 6163 6b77 6172  .GT: ZeroBackwar
+00014bc0: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
+00014bd0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014be0: 2e4c 453a 205a 6572 6f42 6163 6b77 6172  .LE: ZeroBackwar
+00014bf0: 6428 6e75 6d5f 6172 6773 3d32 292c 0a20  d(num_args=2),. 
+00014c00: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014c10: 2e4c 4f47 3130 3a20 6c61 6d62 6461 2078  .LOG10: lambda x
+00014c20: 2c20 673a 2067 202f 2028 7820 2a20 322e  , g: g / (x * 2.
+00014c30: 3330 3235 3835 3039 3239 3934 3034 3629  302585092994046)
+00014c40: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014c50: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
+00014c60: 6120 782c 2067 3a20 6720 2f20 2878 202b  a x, g: g / (x +
+00014c70: 2031 292c 0a20 2020 2070 7269 6d73 2e50   1),.    prims.P
+00014c80: 7269 6d49 4473 2e4c 4f47 323a 206c 616d  rimIDs.LOG2: lam
+00014c90: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
+00014ca0: 202a 2030 2e36 3933 3134 3731 3830 3535   * 0.69314718055
+00014cb0: 3939 3435 3329 2c0a 2020 2020 7072 696d  99453),.    prim
+00014cc0: 732e 5072 696d 4944 732e 464d 4f44 3a20  s.PrimIDs.FMOD: 
+00014cd0: 6c61 6d62 6461 2078 2c20 792c 2067 3a20  lambda x, y, g: 
+00014ce0: 2867 2c20 2d67 202a 2070 7269 6d73 2e74  (g, -g * prims.t
+00014cf0: 7275 6e63 2878 202f 2079 2929 2c0a 2020  runc(x / y)),.  
+00014d00: 2020 2320 5468 6520 636f 7079 2073 686f    # The copy sho
+00014d10: 756c 6420 6e6f 7420 6265 2064 6966 6665  uld not be diffe
+00014d20: 7265 6e74 6961 626c 652e 2057 6520 7265  rentiable. We re
+00014d30: 7475 726e 204e 6f6e 6520 746f 2065 6e61  turn None to ena
+00014d40: 626c 6520 7468 6520 6765 6e65 7261 7469  ble the generati
+00014d50: 6f6e 206f 6620 7468 6520 6261 636b 7761  on of the backwa
+00014d60: 7264 2067 7261 7068 2074 6872 6f75 6768  rd graph through
+00014d70: 2074 6865 6d2e 0a20 2020 2070 7269 6d73   them..    prims
+00014d80: 2e50 7269 6d49 4473 2e43 4f50 595f 3a20  .PrimIDs.COPY_: 
+00014d90: 6c61 6d62 6461 2067 3a20 284e 6f6e 652c  lambda g: (None,
+00014da0: 204e 6f6e 6529 2c0a 7d0a 0a0a 6465 6620   None),.}...def 
+00014db0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00014dc0: 6564 5f66 6f72 7761 7264 286f 7029 3a0a  ed_forward(op):.
+00014dd0: 2020 2020 2222 2244 6563 6f72 6174 6f72      """Decorator
+00014de0: 2074 6f20 7265 6769 7374 6572 2061 6e20   to register an 
+00014df0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
+00014e00: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
+00014e10: 2066 6f72 2061 2073 796d 626f 6c2e 0a0a   for a symbol...
+00014e20: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00014e30: 2020 6f70 2028 4f70 7329 3a20 5379 6d62    op (Ops): Symb
+00014e40: 6f6c 2066 6f72 2077 6869 6368 2074 6f20  ol for which to 
+00014e50: 7265 6769 7374 6572 2074 6865 2061 7567  register the aug
+00014e60: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
+00014e70: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0a0a  mplementation...
+00014e80: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00014e90: 2020 2020 2043 616c 6c61 626c 653a 2044       Callable: D
+00014ea0: 6563 6f72 6174 6f72 2066 756e 6374 696f  ecorator functio
+00014eb0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
+00014ec0: 6465 6620 6465 636f 7261 746f 7228 6675  def decorator(fu
+00014ed0: 6e63 293a 0a20 2020 2020 2020 2061 7567  nc):.        aug
+00014ee0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
+00014ef0: 6d70 6c73 5b6f 705d 203d 2066 756e 630a  mpls[op] = func.
+00014f00: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00014f10: 756e 630a 0a20 2020 2072 6574 7572 6e20  unc..    return 
+00014f20: 6465 636f 7261 746f 720a 0a0a 6465 6620  decorator...def 
+00014f30: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+00014f40: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
+00014f50: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
+00014f60: 7465 7220 6120 6261 636b 7761 7264 2069  ter a backward i
+00014f70: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
+00014f80: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
+00014f90: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
+00014fa0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
+00014fb0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
+00014fc0: 6973 7465 7220 7468 6520 6261 636b 7761  ister the backwa
+00014fd0: 7264 2069 6d70 6c65 6d65 6e74 6174 696f  rd implementatio
+00014fe0: 6e2e 0a0a 2020 2020 5265 7475 726e 733a  n...    Returns:
+00014ff0: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
+00015000: 653a 2044 6563 6f72 6174 6f72 2066 756e  e: Decorator fun
+00015010: 6374 696f 6e2e 0a20 2020 2022 2222 0a0a  ction..    """..
+00015020: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
+00015030: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
+00015040: 2062 6163 6b77 6172 645f 696d 706c 735b   backward_impls[
+00015050: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
+00015060: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
+00015070: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
+00015080: 6174 6f72 0a0a 0a64 6566 2072 6573 746f  ator...def resto
+00015090: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
+000150a0: 782c 2072 6564 7563 6564 5f64 696d 732c  x, reduced_dims,
+000150b0: 206f 7269 6769 6e61 6c5f 7368 6170 6529   original_shape)
+000150c0: 3a0a 2020 2020 2222 2252 6573 746f 7265  :.    """Restore
+000150d0: 7320 7468 6520 7265 6475 6365 6420 6469  s the reduced di
+000150e0: 6d65 6e73 696f 6e73 206f 6620 6120 7465  mensions of a te
+000150f0: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
+00015100: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
+00015110: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
+00015120: 2062 6520 7265 7368 6170 6564 2e0a 2020   be reshaped..  
+00015130: 2020 2020 2020 7265 6475 6365 645f 6469        reduced_di
+00015140: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
+00015150: 2e2e 5d29 3a20 5475 706c 6520 6f66 2072  ..]): Tuple of r
+00015160: 6564 7563 6564 2064 696d 656e 7369 6f6e  educed dimension
+00015170: 732e 0a20 2020 2020 2020 206f 7269 6769  s..        origi
+00015180: 6e61 6c5f 7368 6170 6520 2854 7570 6c65  nal_shape (Tuple
+00015190: 5b69 6e74 2c20 2e2e 2e5d 293a 204f 7269  [int, ...]): Ori
+000151a0: 6769 6e61 6c20 7368 6170 6520 6f66 2074  ginal shape of t
+000151b0: 6865 2074 656e 736f 722e 0a0a 2020 2020  he tensor...    
+000151c0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000151d0: 2056 6172 6961 626c 653a 2054 656e 736f   Variable: Tenso
+000151e0: 7220 7769 7468 2074 6865 2072 6564 7563  r with the reduc
+000151f0: 6564 2064 696d 656e 7369 6f6e 7320 7265  ed dimensions re
+00015200: 7374 6f72 6564 2e0a 2020 2020 2222 220a  stored..    """.
+00015210: 2020 2020 6966 206f 7269 6769 6e61 6c5f      if original_
+00015220: 7368 6170 6520 3d3d 2028 293a 2020 2320  shape == ():  # 
+00015230: 7363 616c 6172 0a20 2020 2020 2020 2072  scalar.        r
+00015240: 6574 7572 6e20 780a 0a20 2020 2075 6e73  eturn x..    uns
+00015250: 7175 6565 7a65 6420 3d20 636c 616e 672e  queezed = clang.
+00015260: 756e 7371 7565 657a 6528 782c 2072 6564  unsqueeze(x, red
+00015270: 7563 6564 5f64 696d 7329 0a20 2020 2072  uced_dims).    r
+00015280: 6574 7572 6e20 636c 616e 672e 6578 7061  eturn clang.expa
+00015290: 6e64 2875 6e73 7175 6565 7a65 642c 206f  nd(unsqueezed, o
+000152a0: 7269 6769 6e61 6c5f 7368 6170 6529 0a0a  riginal_shape)..
+000152b0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000152c0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+000152d0: 732e 5a45 5441 290a 6465 6620 7a65 7461  s.ZETA).def zeta
+000152e0: 5f62 6163 6b77 6172 6428 782c 2079 2c20  _backward(x, y, 
+000152f0: 6729 3a0a 2020 2020 2320 5468 6520 6465  g):.    # The de
+00015300: 7269 7661 7469 7665 2077 7274 2074 6865  rivative wrt the
+00015310: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
+00015320: 6973 206e 6f74 2065 7870 7265 7373 6962  is not expressib
+00015330: 6c65 2069 6e20 7465 726d 7320 6f66 207a  le in terms of z
+00015340: 6574 6120 6f72 0a20 2020 2023 206f 7468  eta or.    # oth
+00015350: 6572 2073 7065 6369 616c 2066 756e 6374  er special funct
+00015360: 696f 6e73 0a20 2020 2023 2054 6865 7265  ions.    # There
+00015370: 666f 7265 2c20 7765 2063 6f6d 7075 7465  fore, we compute
+00015380: 206f 6e6c 7920 7468 6520 6465 7269 7661   only the deriva
+00015390: 7469 7665 2077 7274 2074 6865 2073 6563  tive wrt the sec
+000153a0: 6f6e 6420 6172 6775 6d65 6e74 0a20 2020  ond argument.   
+000153b0: 2067 7920 3d20 6720 2a20 2d78 202a 2070   gy = g * -x * p
+000153c0: 7269 6d73 2e7a 6574 6128 7820 2b20 312e  rims.zeta(x + 1.
+000153d0: 302c 2079 290a 0a20 2020 2023 2052 6574  0, y)..    # Ret
+000153e0: 7572 6e20 6120 6d61 7070 7069 6e67 2066  urn a mappping f
+000153f0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
+00015400: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
+00015410: 2067 7261 6469 656e 7473 0a20 2020 2072   gradients.    r
+00015420: 6574 7572 6e20 7b22 7922 3a20 6779 7d0a  eturn {"y": gy}.
+00015430: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00015440: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+00015450: 4473 2e44 4947 414d 4d41 290a 6465 6620  Ds.DIGAMMA).def 
+00015460: 6469 6761 6d6d 615f 6261 636b 7761 7264  digamma_backward
+00015470: 2861 3a20 5072 6f78 792c 2067 293a 0a20  (a: Proxy, g):. 
+00015480: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+00015490: 746f 7263 6820 696d 706f 7274 2070 6f6c  torch import pol
+000154a0: 7967 616d 6d61 0a0a 2020 2020 7265 7475  ygamma..    retu
+000154b0: 726e 2067 202a 2070 6f6c 7967 616d 6d61  rn g * polygamma
+000154c0: 2831 2c20 6129 0a0a 0a40 7265 6769 7374  (1, a)...@regist
+000154d0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+000154e0: 7761 7264 2822 746f 7263 682e 706f 6c79  ward("torch.poly
+000154f0: 6761 6d6d 6122 290a 6465 6620 706f 6c79  gamma").def poly
+00015500: 6761 6d6d 615f 6175 675f 6677 6428 6e3a  gamma_aug_fwd(n:
+00015510: 2069 6e74 2c20 613a 2050 726f 7879 293a   int, a: Proxy):
+00015520: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00015530: 722e 746f 7263 6820 696d 706f 7274 2070  r.torch import p
+00015540: 6f6c 7967 616d 6d61 0a0a 2020 2020 7072  olygamma..    pr
+00015550: 696d 616c 203d 2070 6f6c 7967 616d 6d61  imal = polygamma
+00015560: 286e 2c20 6129 0a20 2020 2072 6573 6964  (n, a).    resid
+00015570: 7561 6c73 203d 2028 6e2c 2061 290a 2020  uals = (n, a).  
+00015580: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
+00015590: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
+000155a0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
+000155b0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
+000155c0: 706f 6c79 6761 6d6d 6122 290a 6465 6620  polygamma").def 
+000155d0: 706f 6c79 6761 6d6d 615f 6261 636b 7761  polygamma_backwa
+000155e0: 7264 286e 3a20 696e 742c 2061 3a20 5072  rd(n: int, a: Pr
+000155f0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
+00015600: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00015610: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
+00015620: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
+00015630: 652c 2067 202a 2070 6f6c 7967 616d 6d61  e, g * polygamma
+00015640: 286e 202b 2031 2c20 6129 0a0a 0a40 7265  (n + 1, a)...@re
+00015650: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00015660: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
+00015670: 414e 3229 0a64 6566 2061 7461 6e32 5f62  AN2).def atan2_b
+00015680: 6163 6b77 6172 6428 782c 2079 2c20 6729  ackward(x, y, g)
+00015690: 3a0a 2020 2020 616c 7068 6120 3d20 312e  :.    alpha = 1.
+000156a0: 3020 2f20 2878 202a 2078 202b 2079 202a  0 / (x * x + y *
+000156b0: 2079 290a 2020 2020 6772 6164 5f78 203d   y).    grad_x =
+000156c0: 2067 202a 2079 202a 2061 6c70 6861 0a20   g * y * alpha. 
+000156d0: 2020 2067 7261 645f 7920 3d20 6720 2a20     grad_y = g * 
+000156e0: 2d78 202a 2061 6c70 6861 0a20 2020 2072  -x * alpha.    r
+000156f0: 6574 7572 6e20 6772 6164 5f78 2c20 6772  eturn grad_x, gr
+00015700: 6164 5f79 0a0a 0a40 7265 6769 7374 6572  ad_y...@register
+00015710: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00015720: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+00015730: 2e56 4152 290a 6465 6620 7661 725f 6175  .VAR).def var_au
+00015740: 675f 6677 6428 612c 2064 696d 2c20 2a2c  g_fwd(a, dim, *,
+00015750: 2063 6f72 7265 6374 696f 6e29 3a0a 2020   correction):.  
+00015760: 2020 7620 3d20 7072 696d 732e 7661 7228    v = prims.var(
+00015770: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
+00015780: 6f6e 3d63 6f72 7265 6374 696f 6e29 0a20  on=correction). 
+00015790: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+000157a0: 6c28 2876 2c29 2c20 2861 2c20 6469 6d2c  l((v,), (a, dim,
+000157b0: 2063 6f72 7265 6374 696f 6e2c 2076 2929   correction, v))
+000157c0: 0a0a 0a23 2054 4f44 4f3a 2066 6978 2064  ...# TODO: fix d
+000157d0: 6976 6973 696f 6e20 6279 207a 6572 6f20  ivision by zero 
+000157e0: 7768 656e 206e 5f65 6c65 6d5f 7265 6475  when n_elem_redu
+000157f0: 6365 6420 3d3d 2030 206f 7220 7768 656e  ced == 0 or when
+00015800: 2076 2e6e 756d 656c 203d 3d20 300a 2320   v.numel == 0.# 
+00015810: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
+00015820: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
+00015830: 6d69 6c61 722e 0a23 2054 4f44 4f3a 2066  milar..# TODO: f
+00015840: 6978 2067 7261 6420 7768 656e 2063 6f72  ix grad when cor
+00015850: 7265 6374 696f 6e20 3e20 6e5f 656c 656d  rection > n_elem
+00015860: 5f72 6564 7563 6564 2e0a 4072 6567 6973  _reduced..@regis
+00015870: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
+00015880: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
+00015890: 6465 6620 7661 725f 6261 636b 7761 7264  def var_backward
+000158a0: 2861 2c20 6469 6d2c 2063 6f72 7265 6374  (a, dim, correct
+000158b0: 696f 6e2c 2076 2c20 6729 3a0a 2020 2020  ion, v, g):.    
+000158c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
+000158d0: 2061 2e6e 756d 656c 202f 2f20 762e 6e75   a.numel // v.nu
+000158e0: 6d65 6c20 6966 2061 2e6e 756d 656c 2021  mel if a.numel !
+000158f0: 3d20 3020 656c 7365 2031 0a20 2020 206e  = 0 else 1.    n
+00015900: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
+00015910: 6c61 7220 3d20 6e5f 656c 656d 5f72 6564  lar = n_elem_red
+00015920: 7563 6564 202d 2063 6f72 7265 6374 696f  uced - correctio
+00015930: 6e0a 2020 2020 6720 3d20 7265 7374 6f72  n.    g = restor
+00015940: 655f 7265 6475 6365 645f 6469 6d73 2867  e_reduced_dims(g
+00015950: 2c20 6469 6d2c 2061 2e73 6861 7065 290a  , dim, a.shape).
+00015960: 2020 2020 6966 2061 2e64 7479 7065 2021      if a.dtype !
+00015970: 3d20 762e 6474 7970 653a 0a20 2020 2020  = v.dtype:.     
+00015980: 2020 2061 203d 2070 7269 6d73 2e63 6f6e     a = prims.con
+00015990: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
+000159a0: 6528 612c 2076 2e64 7479 7065 290a 2020  e(a, v.dtype).  
+000159b0: 2020 6d65 616e 203d 2070 7269 6d73 2e73    mean = prims.s
+000159c0: 756d 2861 2c20 6469 6d29 202f 206e 5f65  um(a, dim) / n_e
+000159d0: 6c65 6d5f 7265 6475 6365 640a 2020 2020  lem_reduced.    
+000159e0: 6d65 616e 203d 2072 6573 746f 7265 5f72  mean = restore_r
+000159f0: 6564 7563 6564 5f64 696d 7328 6d65 616e  educed_dims(mean
+00015a00: 2c20 6469 6d2c 2061 2e73 6861 7065 290a  , dim, a.shape).
+00015a10: 2020 2020 7265 7475 726e 2028 3220 2a20      return (2 * 
+00015a20: 6720 2a20 2861 202d 206d 6561 6e29 2920  g * (a - mean)) 
+00015a30: 2f20 6e6f 726d 616c 697a 6174 696f 6e5f  / normalization_
+00015a40: 7363 616c 6172 0a0a 0a64 6566 206e 5f65  scalar...def n_e
+00015a50: 6c65 6d5f 7265 6475 6365 6428 615f 6e64  lem_reduced(a_nd
+00015a60: 696d 2c20 615f 7368 6170 652c 2064 696d  im, a_shape, dim
+00015a70: 7329 3a0a 2020 2020 6469 6d73 203d 2075  s):.    dims = u
+00015a80: 7469 6c73 2e63 616e 6f6e 6963 616c 697a  tils.canonicaliz
+00015a90: 655f 6469 6d73 2861 5f6e 6469 6d2c 2064  e_dims(a_ndim, d
+00015aa0: 696d 7329 0a20 2020 2072 6564 7563 7469  ims).    reducti
+00015ab0: 6f6e 5f73 697a 6520 3d20 310a 2020 2020  on_size = 1.    
+00015ac0: 666f 7220 6964 782c 2073 697a 6520 696e  for idx, size in
+00015ad0: 2065 6e75 6d65 7261 7465 2861 5f73 6861   enumerate(a_sha
+00015ae0: 7065 293a 0a20 2020 2020 2020 2069 6620  pe):.        if 
+00015af0: 6964 7820 696e 2064 696d 733a 0a20 2020  idx in dims:.   
+00015b00: 2020 2020 2020 2020 2072 6564 7563 7469           reducti
+00015b10: 6f6e 5f73 697a 6520 2a3d 2073 697a 650a  on_size *= size.
+00015b20: 2020 2020 7265 7475 726e 2072 6564 7563      return reduc
+00015b30: 7469 6f6e 5f73 697a 650a 0a0a 6465 6620  tion_size...def 
+00015b40: 6d65 616e 5f62 6163 6b77 6172 6428 615f  mean_backward(a_
+00015b50: 6e64 696d 2c20 615f 7368 6170 652c 2064  ndim, a_shape, d
+00015b60: 696d 732c 2067 7261 6429 3a0a 2020 2020  ims, grad):.    
+00015b70: 6d65 616e 5f6c 6f63 616c 5f67 7261 6420  mean_local_grad 
+00015b80: 3d20 312e 3020 2f20 6e5f 656c 656d 5f72  = 1.0 / n_elem_r
+00015b90: 6564 7563 6564 2861 5f6e 6469 6d2c 2061  educed(a_ndim, a
+00015ba0: 5f73 6861 7065 2c20 6469 6d73 290a 2020  _shape, dims).  
+00015bb0: 2020 7265 7475 726e 2072 6573 746f 7265    return restore
+00015bc0: 5f72 6564 7563 6564 5f64 696d 7328 6772  _reduced_dims(gr
+00015bd0: 6164 2c20 6469 6d73 2c20 615f 7368 6170  ad, dims, a_shap
+00015be0: 6529 202a 206d 6561 6e5f 6c6f 6361 6c5f  e) * mean_local_
+00015bf0: 6772 6164 0a0a 0a40 7265 6769 7374 6572  grad...@register
+00015c00: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00015c10: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+00015c20: 2e50 4144 290a 6465 6620 7061 645f 6175  .PAD).def pad_au
+00015c30: 675f 6677 6428 612c 2070 6164 6469 6e67  g_fwd(a, padding
+00015c40: 5f76 616c 7565 2c20 7061 6464 696e 675f  _value, padding_
+00015c50: 636f 6e66 6967 293a 0a20 2020 2072 6574  config):.    ret
+00015c60: 7572 6e20 564a 5044 7561 6c28 2870 7269  urn VJPDual((pri
+00015c70: 6d73 2e70 6164 2861 2c20 7061 6464 696e  ms.pad(a, paddin
+00015c80: 675f 7661 6c75 652c 2070 6164 6469 6e67  g_value, padding
+00015c90: 5f63 6f6e 6669 6729 2c29 2c20 2861 2c20  _config),), (a, 
+00015ca0: 7061 6464 696e 675f 636f 6e66 6967 2929  padding_config))
+00015cb0: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+00015cc0: 6b77 6172 6428 7072 696d 732e 5072 696d  kward(prims.Prim
+00015cd0: 4944 732e 5041 4429 0a64 6566 2070 6164  IDs.PAD).def pad
+00015ce0: 5f62 6163 6b77 6172 6428 612c 2070 6164  _backward(a, pad
+00015cf0: 6469 6e67 5f63 6f6e 6669 672c 2067 293a  ding_config, g):
+00015d00: 0a20 2020 2023 2053 686f 7274 2063 6972  .    # Short cir
+00015d10: 6375 6974 206f 6e20 656d 7074 7920 696e  cuit on empty in
+00015d20: 7075 742e 0a20 2020 2069 6620 616e 7928  put..    if any(
+00015d30: 6469 6d20 3d3d 2030 2066 6f72 2064 696d  dim == 0 for dim
+00015d40: 2069 6e20 612e 7368 6170 6529 3a0a 2020   in a.shape):.  
+00015d50: 2020 2020 2020 7265 7475 726e 2066 756c        return ful
+00015d60: 6c5f 6c69 6b65 2861 2c20 6669 6c6c 5f76  l_like(a, fill_v
+00015d70: 616c 7565 3d30 290a 0a20 2020 2023 2055  alue=0)..    # U
+00015d80: 6e2d 7061 6420 6279 2070 6164 6469 6e67  n-pad by padding
+00015d90: 2077 6974 6820 7a65 726f 2076 616c 7565   with zero value
+00015da0: 730a 2020 2020 7a65 726f 5f70 6164 6469  s.    zero_paddi
+00015db0: 6e67 5f63 6f6e 6669 6720 3d20 5b28 2d6c  ng_config = [(-l
+00015dc0: 6f2c 202d 6869 2c20 3029 2066 6f72 206c  o, -hi, 0) for l
+00015dd0: 6f2c 2068 692c 205f 2069 6e20 7061 6464  o, hi, _ in padd
+00015de0: 696e 675f 636f 6e66 6967 5d0a 0a20 2020  ing_config]..   
+00015df0: 2067 203d 2070 7269 6d73 2e70 6164 2867   g = prims.pad(g
+00015e00: 2c20 302e 302c 207a 6572 6f5f 7061 6464  , 0.0, zero_padd
+00015e10: 696e 675f 636f 6e66 6967 290a 0a20 2020  ing_config)..   
+00015e20: 2023 2055 6e2d 736c 6963 6520 6279 2073   # Un-slice by s
+00015e30: 6c69 6369 6e67 2077 6974 6820 6120 7374  licing with a st
+00015e40: 7269 6465 206f 6620 7661 6c75 6520 2864  ride of value (d
+00015e50: 696c 6174 696f 6e20 2b20 3129 0a20 2020  ilation + 1).   
+00015e60: 2066 6f72 2064 696d 2c20 285f 2c20 5f2c   for dim, (_, _,
+00015e70: 2064 2920 696e 2065 6e75 6d65 7261 7465   d) in enumerate
+00015e80: 2870 6164 6469 6e67 5f63 6f6e 6669 6729  (padding_config)
+00015e90: 3a0a 2020 2020 2020 2020 6720 3d20 736c  :.        g = sl
+00015ea0: 6963 655f 696e 5f64 696d 2867 2c20 302c  ice_in_dim(g, 0,
+00015eb0: 2067 2e73 6861 7065 5b64 696d 5d2c 2073   g.shape[dim], s
+00015ec0: 7472 6964 653d 6420 2b20 312c 2064 696d  tride=d + 1, dim
+00015ed0: 3d64 696d 290a 0a20 2020 2072 6574 7572  =dim)..    retur
+00015ee0: 6e20 670a 0a0a 4072 6567 6973 7465 725f  n g...@register_
+00015ef0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00015f00: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00015f10: 5052 4f44 290a 6465 6620 7072 6f64 5f61  PROD).def prod_a
+00015f20: 7567 5f66 7764 2878 2c20 6469 6d73 293a  ug_fwd(x, dims):
+00015f30: 0a20 2020 2022 2222 4175 676d 656e 7465  .    """Augmente
+00015f40: 6420 7072 6f64 206f 7065 7261 7469 6f6e  d prod operation
+00015f50: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00015f60: 2020 2020 2078 2028 5661 7269 6162 6c65       x (Variable
+00015f70: 293a 2054 656e 736f 7220 746f 2062 6520  ): Tensor to be 
+00015f80: 6d75 6c74 6970 6c69 6564 2e0a 2020 2020  multiplied..    
+00015f90: 2020 2020 6469 6d73 2028 5475 706c 655b      dims (Tuple[
+00015fa0: 696e 742c 202e 2e2e 5d29 3a20 4469 6d65  int, ...]): Dime
+00015fb0: 6e73 696f 6e73 2074 6f20 6265 206d 756c  nsions to be mul
+00015fc0: 7469 706c 6965 642e 0a0a 2020 2020 5265  tiplied...    Re
+00015fd0: 7475 726e 733a 0a20 2020 2020 2020 2056  turns:.        V
+00015fe0: 4a50 4475 616c 3a20 5072 696d 616c 2061  JPDual: Primal a
+00015ff0: 6e64 2072 6573 6964 7561 6c73 2e0a 2020  nd residuals..  
+00016000: 2020 2222 220a 2020 2020 7072 696d 616c    """.    primal
+00016010: 203d 2070 7269 6d73 2e70 726f 6428 782c   = prims.prod(x,
+00016020: 2064 696d 7329 0a0a 2020 2020 7265 7369   dims)..    resi
+00016030: 6475 616c 7320 3d20 280a 2020 2020 2020  duals = (.      
+00016040: 2020 7072 696d 616c 2c0a 2020 2020 2020    primal,.      
+00016050: 2020 782c 0a20 2020 2020 2020 2078 2e73    x,.        x.s
+00016060: 6861 7065 2c0a 2020 2020 2020 2020 6469  hape,.        di
+00016070: 6d73 2c0a 2020 2020 290a 2020 2020 7265  ms,.    ).    re
+00016080: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00016090: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+000160a0: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+000160b0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+000160c0: 4473 2e50 524f 4429 0a64 6566 2070 726f  Ds.PROD).def pro
+000160d0: 645f 7075 6c6c 6261 636b 2870 7269 6d61  d_pullback(prima
+000160e0: 6c2c 2078 2c20 785f 7368 6170 652c 2072  l, x, x_shape, r
+000160f0: 6564 7563 6564 5f64 696d 732c 2067 293a  educed_dims, g):
+00016100: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
+00016110: 732e 6469 7628 7265 7374 6f72 655f 7265  s.div(restore_re
+00016120: 6475 6365 645f 6469 6d73 2870 7269 6d61  duced_dims(prima
+00016130: 6c20 2a20 672c 2072 6564 7563 6564 5f64  l * g, reduced_d
+00016140: 696d 732c 2078 5f73 6861 7065 292c 2078  ims, x_shape), x
+00016150: 290a 0a0a 6465 6620 6b65 6570 6469 6d5f  )...def keepdim_
+00016160: 7265 6475 6374 696f 6e28 7265 6475 6374  reduction(reduct
+00016170: 696f 6e5f 666e 2c20 782c 2064 696d 7329  ion_fn, x, dims)
+00016180: 3a0a 2020 2020 2222 2241 7070 6c69 6573  :.    """Applies
+00016190: 2072 6564 7563 7469 6f6e 2061 6e64 2066   reduction and f
+000161a0: 6978 6573 206f 7574 7075 7420 746f 2063  ixes output to c
+000161b0: 6f6e 666f 726d 2074 6f20 6b65 6570 6469  onform to keepdi
+000161c0: 6d3d 5472 7565 2222 220a 2020 2020 6f75  m=True""".    ou
+000161d0: 7420 3d20 7265 6475 6374 696f 6e5f 666e  t = reduction_fn
+000161e0: 2878 2c20 6469 6d73 290a 2020 2020 6172  (x, dims).    ar
+000161f0: 676d 6178 5f73 756d 5f6f 7574 5f73 6861  gmax_sum_out_sha
+00016200: 7065 203d 205b 782e 7368 6170 655b 695d  pe = [x.shape[i]
+00016210: 2069 6620 6920 6e6f 7420 696e 2064 696d   if i not in dim
+00016220: 7320 656c 7365 2031 2066 6f72 2069 2069  s else 1 for i i
+00016230: 6e20 7261 6e67 6528 782e 6e64 696d 295d  n range(x.ndim)]
+00016240: 0a20 2020 2062 726f 6164 6361 7374 5f64  .    broadcast_d
+00016250: 696d 7320 3d20 5b69 2066 6f72 2069 2069  ims = [i for i i
+00016260: 6e20 7261 6e67 6528 782e 6e64 696d 2920  n range(x.ndim) 
+00016270: 6966 2069 206e 6f74 2069 6e20 6469 6d73  if i not in dims
+00016280: 5d0a 2020 2020 7265 7475 726e 2070 7269  ].    return pri
+00016290: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
+000162a0: 6469 6d28 6f75 742c 2061 7267 6d61 785f  dim(out, argmax_
+000162b0: 7375 6d5f 6f75 745f 7368 6170 652c 2062  sum_out_shape, b
+000162c0: 726f 6164 6361 7374 5f64 696d 7329 0a0a  roadcast_dims)..
+000162d0: 0a23 2049 6e73 7069 7265 6420 6672 6f6d  .# Inspired from
+000162e0: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+000162f0: 636f 6d2f 4849 5053 2f61 7574 6f67 7261  com/HIPS/autogra
+00016300: 642f 626c 6f62 2f6d 6173 7465 722f 6175  d/blob/master/au
+00016310: 746f 6772 6164 2f6e 756d 7079 2f6e 756d  tograd/numpy/num
+00016320: 7079 5f76 6a70 732e 7079 234c 3335 330a  py_vjps.py#L353.
+00016330: 6465 6620 6772 6164 5f63 686f 6f73 6572  def grad_chooser
+00016340: 5f62 6163 6b77 6172 6428 7072 696d 616c  _backward(primal
+00016350: 2c20 782c 2078 5f73 6861 7065 2c20 7265  , x, x_shape, re
+00016360: 6475 6365 645f 6469 6d73 2c20 6729 3a0a  duced_dims, g):.
+00016370: 2020 2020 2222 2242 7569 6c64 7320 6772      """Builds gr
+00016380: 6164 6965 6e74 206f 6620 6675 6e63 7469  adient of functi
+00016390: 6f6e 7320 7468 6174 2063 686f 6f73 6520  ons that choose 
+000163a0: 6120 7369 6e67 6c65 2069 7465 6d2c 2073  a single item, s
+000163b0: 7563 6820 6173 206d 696e 206f 7220 6d61  uch as min or ma
+000163c0: 782e 2222 220a 2020 2020 675f 7265 7065  x.""".    g_repe
+000163d0: 6174 6564 203d 2072 6573 746f 7265 5f72  ated = restore_r
+000163e0: 6564 7563 6564 5f64 696d 7328 672c 2072  educed_dims(g, r
+000163f0: 6564 7563 6564 5f64 696d 732c 2078 5f73  educed_dims, x_s
+00016400: 6861 7065 290a 2020 2020 7072 696d 616c  hape).    primal
+00016410: 5f72 6570 6561 7465 6420 3d20 7265 7374  _repeated = rest
+00016420: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
+00016430: 2870 7269 6d61 6c2c 2072 6564 7563 6564  (primal, reduced
+00016440: 5f64 696d 732c 2078 5f73 6861 7065 290a  _dims, x_shape).
+00016450: 2020 2020 6172 676d 6178 5f6c 6f63 6174      argmax_locat
+00016460: 696f 6e73 203d 2078 203d 3d20 7072 696d  ions = x == prim
+00016470: 616c 5f72 6570 6561 7465 640a 2020 2020  al_repeated.    
+00016480: 6172 676d 6178 5f73 756d 203d 206b 6565  argmax_sum = kee
+00016490: 7064 696d 5f72 6564 7563 7469 6f6e 2870  pdim_reduction(p
+000164a0: 7269 6d73 2e73 756d 2c20 6172 676d 6178  rims.sum, argmax
+000164b0: 5f6c 6f63 6174 696f 6e73 2c20 7265 6475  _locations, redu
+000164c0: 6365 645f 6469 6d73 290a 2020 2020 6f75  ced_dims).    ou
+000164d0: 7420 3d20 675f 7265 7065 6174 6564 202a  t = g_repeated *
+000164e0: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
+000164f0: 7320 2f20 6172 676d 6178 5f73 756d 0a20  s / argmax_sum. 
+00016500: 2020 2072 6574 7572 6e20 6f75 740a 0a0a     return out...
+00016510: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+00016520: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00016530: 414d 494e 2928 6772 6164 5f63 686f 6f73  AMIN)(grad_choos
+00016540: 6572 5f62 6163 6b77 6172 6429 0a0a 0a40  er_backward)...@
+00016550: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00016560: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+00016570: 2e50 7269 6d49 4473 2e41 4d49 4e29 0a64  .PrimIDs.AMIN).d
+00016580: 6566 2061 6d69 6e5f 6175 675f 6677 6428  ef amin_aug_fwd(
+00016590: 782c 2064 696d 7329 3a0a 2020 2020 2222  x, dims):.    ""
+000165a0: 2241 7567 6d65 6e74 6564 2061 6d69 6e20  "Augmented amin 
+000165b0: 6f70 6572 6174 696f 6e2e 0a20 2020 2041  operation..    A
+000165c0: 7267 733a 0a20 2020 2020 2020 2078 2028  rgs:.        x (
+000165d0: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
+000165e0: 7220 746f 2063 6f6d 7075 7465 2061 6d69  r to compute ami
+000165f0: 6e20 6f6e 2e0a 2020 2020 2020 2020 6469  n on..        di
+00016600: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
+00016610: 2e2e 5d29 3a20 4469 6d65 6e73 696f 6e73  ..]): Dimensions
+00016620: 2074 6f20 636f 6d70 7574 6520 616d 696e   to compute amin
+00016630: 206f 7665 722e 0a20 2020 2052 6574 7572   over..    Retur
+00016640: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
+00016650: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
+00016660: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
+00016670: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
+00016680: 7072 696d 732e 616d 696e 2878 2c20 6469  prims.amin(x, di
+00016690: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
+000166a0: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
+000166b0: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
+000166c0: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
+000166d0: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
+000166e0: 0a20 2020 2029 0a0a 2020 2020 7265 7475  .    )..    retu
+000166f0: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
+00016700: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
+00016710: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00016720: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
+00016730: 732e 5072 696d 4944 732e 504f 5729 0a64  s.PrimIDs.POW).d
+00016740: 6566 2070 6f77 5f61 7567 5f66 6564 2878  ef pow_aug_fed(x
+00016750: 2c20 7929 3a0a 2020 2020 2222 2241 7567  , y):.    """Aug
+00016760: 6d65 6e74 6564 2074 6865 2070 6f77 206f  mented the pow o
+00016770: 7065 7261 7469 6f6e 2e0a 0a20 2020 2041  peration...    A
+00016780: 7267 733a 0a20 2020 2020 2020 2078 2028  rgs:.        x (
+00016790: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
+000167a0: 7220 7769 7468 2074 6865 2062 6173 6520  r with the base 
+000167b0: 746f 2062 6520 6578 706f 6e65 6e74 6961  to be exponentia
+000167c0: 7465 642e 0a20 2020 2020 2020 2079 2028  ted..        y (
+000167d0: 5661 7269 6162 6c65 293a 2054 656e 736f  Variable): Tenso
+000167e0: 7220 7769 7468 2070 6f77 6572 2074 6f20  r with power to 
+000167f0: 7261 6973 6520 746f 2e0a 0a20 2020 2052  raise to...    R
+00016800: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00016810: 564a 5044 7561 6c3a 2050 7269 6d61 6c20  VJPDual: Primal 
+00016820: 616e 6420 7265 7369 6475 616c 732e 0a20  and residuals.. 
+00016830: 2020 2022 2222 0a20 2020 2070 7269 6d61     """.    prima
+00016840: 6c20 3d20 7072 696d 732e 706f 7728 782c  l = prims.pow(x,
+00016850: 2079 290a 2020 2020 7265 7369 6475 616c   y).    residual
+00016860: 7320 3d20 2870 7269 6d61 6c2c 2078 2c20  s = (primal, x, 
+00016870: 7929 0a20 2020 2072 6574 7572 6e20 564a  y).    return VJ
+00016880: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00016890: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+000168a0: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+000168b0: 696d 732e 5072 696d 4944 732e 504f 5729  ims.PrimIDs.POW)
+000168c0: 0a64 6566 2070 6f77 5f62 6163 6b77 6172  .def pow_backwar
+000168d0: 6428 7265 7375 6c74 2c20 782c 2079 2c20  d(result, x, y, 
+000168e0: 6729 3a0a 2020 2020 696d 706f 7274 2074  g):.    import t
+000168f0: 6875 6e64 6572 2e63 6c61 6e67 2061 7320  hunder.clang as 
+00016900: 746c 616e 670a 0a20 2020 2067 7265 7375  tlang..    gresu
+00016910: 6c74 203d 2067 202a 2072 6573 756c 7420  lt = g * result 
+00016920: 2023 2072 6575 7365 2063 6f6d 6d6f 6e20   # reuse common 
+00016930: 6661 6374 6f72 0a20 2020 2064 7820 3d20  factor.    dx = 
+00016940: 6720 2a20 7920 2a20 7820 2a2a 2028 7920  g * y * x ** (y 
+00016950: 2d20 3129 0a20 2020 2064 7920 3d20 6772  - 1).    dy = gr
+00016960: 6573 756c 7420 2a20 746c 616e 672e 6c6f  esult * tlang.lo
+00016970: 6728 7829 0a20 2020 2072 6574 7572 6e20  g(x).    return 
+00016980: 6478 2c20 6479 0a0a 0a40 7265 6769 7374  dx, dy...@regist
+00016990: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+000169a0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
+000169b0: 4473 2e54 414e 290a 6465 6620 7461 6e5f  Ds.TAN).def tan_
+000169c0: 6175 675f 6677 6428 7829 3a0a 2020 2020  aug_fwd(x):.    
+000169d0: 2222 2241 7567 6d65 6e74 6564 2074 616e  """Augmented tan
+000169e0: 206f 7065 7261 7469 6f6e 2e0a 0a20 2020   operation...   
+000169f0: 2041 7267 733a 0a20 2020 2020 2020 2078   Args:.        x
+00016a00: 2028 5661 7269 6162 6c65 293a 2054 656e   (Variable): Ten
+00016a10: 736f 7220 746f 2062 6520 7061 7373 6564  sor to be passed
+00016a20: 2074 6f20 7461 6e2e 0a20 2020 2022 2222   to tan..    """
+00016a30: 0a0a 2020 2020 7072 696d 616c 203d 2070  ..    primal = p
+00016a40: 7269 6d73 2e74 616e 2878 290a 2020 2020  rims.tan(x).    
+00016a50: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
+00016a60: 6d61 6c2c 290a 2020 2020 7265 7475 726e  mal,).    return
+00016a70: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
+00016a80: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
+00016a90: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00016aa0: 2870 7269 6d73 2e50 7269 6d49 4473 2e54  (prims.PrimIDs.T
+00016ab0: 414e 290a 6465 6620 7461 6e5f 6261 636b  AN).def tan_back
+00016ac0: 7761 7264 2872 6573 756c 742c 2067 293a  ward(result, g):
+00016ad0: 0a20 2020 2072 6574 7572 6e20 6720 2a20  .    return g * 
+00016ae0: 2831 202b 2072 6573 756c 7420 2a20 7265  (1 + result * re
+00016af0: 7375 6c74 290a 0a0a 2320 4e4f 5445 3a20  sult)...# NOTE: 
+00016b00: 4a61 7820 7573 6573 206e 702e 6172 6773  Jax uses np.args
+00016b10: 6f72 7420 696e 2069 7473 2074 7261 6e73  ort in its trans
+00016b20: 706f 7365 2076 6a70 2063 6f6d 7075 7461  pose vjp computa
+00016b30: 7469 6f6e 0a64 6566 205f 6172 6773 6f72  tion.def _argsor
+00016b40: 7428 7365 7129 3a0a 2020 2020 7265 7475  t(seq):.    retu
+00016b50: 726e 2073 6f72 7465 6428 7261 6e67 6528  rn sorted(range(
+00016b60: 6c65 6e28 7365 7129 292c 206b 6579 3d73  len(seq)), key=s
+00016b70: 6571 2e5f 5f67 6574 6974 656d 5f5f 290a  eq.__getitem__).
+00016b80: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+00016b90: 656e 7465 645f 666f 7277 6172 6428 7072  ented_forward(pr
+00016ba0: 696d 732e 5072 696d 4944 732e 4445 5649  ims.PrimIDs.DEVI
+00016bb0: 4345 5f50 5554 290a 6465 6620 6465 7669  CE_PUT).def devi
+00016bc0: 6365 5f70 7574 5f61 7567 5f66 7764 2861  ce_put_aug_fwd(a
+00016bd0: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
+00016be0: 6576 6963 653a 2044 6576 6963 6529 202d  evice: Device) -
+00016bf0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00016c00: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
+00016c10: 732e 6465 7669 6365 5f70 7574 2861 2c20  s.device_put(a, 
+00016c20: 6465 7669 6365 290a 2020 2020 7265 7369  device).    resi
+00016c30: 6475 616c 7320 3d20 2861 2e64 6576 6963  duals = (a.devic
+00016c40: 652c 290a 2020 2020 7265 7475 726e 2056  e,).    return V
+00016c50: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00016c60: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00016c70: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+00016c80: 7269 6d73 2e50 7269 6d49 4473 2e44 4556  rims.PrimIDs.DEV
+00016c90: 4943 455f 5055 5429 0a64 6566 2064 6576  ICE_PUT).def dev
+00016ca0: 6963 655f 7075 745f 6261 636b 7761 7264  ice_put_backward
+00016cb0: 286f 7269 675f 6465 7669 6365 2c20 6729  (orig_device, g)
+00016cc0: 3a0a 2020 2020 7265 7475 726e 2070 7269  :.    return pri
+00016cd0: 6d73 2e64 6576 6963 655f 7075 7428 672c  ms.device_put(g,
+00016ce0: 206f 7269 675f 6465 7669 6365 292c 204e   orig_device), N
+00016cf0: 6f6e 650a 0a0a 4072 6567 6973 7465 725f  one...@register_
+00016d00: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00016d10: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00016d20: 434f 4e56 4f4c 5554 494f 4e29 0a64 6566  CONVOLUTION).def
+00016d30: 2063 6f6e 766f 6c75 7469 6f6e 5f61 7567   convolution_aug
+00016d40: 5f66 7764 280a 2020 2020 613a 2050 726f  _fwd(.    a: Pro
+00016d50: 7879 2c0a 2020 2020 7765 6967 6874 2c0a  xy,.    weight,.
+00016d60: 2020 2020 6269 6173 2c0a 2020 2020 7374      bias,.    st
+00016d70: 7269 6465 2c0a 2020 2020 7061 6464 696e  ride,.    paddin
+00016d80: 672c 0a20 2020 2064 696c 6174 696f 6e2c  g,.    dilation,
+00016d90: 0a20 2020 2074 7261 6e73 706f 7365 642c  .    transposed,
+00016da0: 0a20 2020 206f 7574 7075 745f 7061 6464  .    output_padd
+00016db0: 696e 672c 0a20 2020 2067 726f 7570 732c  ing,.    groups,
+00016dc0: 0a29 3a0a 2020 2020 7072 696d 616c 203d  .):.    primal =
+00016dd0: 2063 6f6e 766f 6c75 7469 6f6e 2861 2c20   convolution(a, 
+00016de0: 7765 6967 6874 2c20 6269 6173 2c20 7374  weight, bias, st
+00016df0: 7269 6465 2c20 7061 6464 696e 672c 2064  ride, padding, d
+00016e00: 696c 6174 696f 6e2c 2074 7261 6e73 706f  ilation, transpo
+00016e10: 7365 642c 206f 7574 7075 745f 7061 6464  sed, output_padd
+00016e20: 696e 672c 2067 726f 7570 7329 0a20 2020  ing, groups).   
+00016e30: 2072 6573 6964 7561 6c73 203d 2028 7072   residuals = (pr
+00016e40: 696d 616c 2c20 612c 2077 6569 6768 742c  imal, a, weight,
+00016e50: 2062 6961 732c 2073 7472 6964 652c 2070   bias, stride, p
+00016e60: 6164 6469 6e67 2c20 6469 6c61 7469 6f6e  adding, dilation
+00016e70: 2c20 7472 616e 7370 6f73 6564 2c20 6f75  , transposed, ou
+00016e80: 7470 7574 5f70 6164 6469 6e67 2c20 6772  tput_padding, gr
+00016e90: 6f75 7073 290a 2020 2020 7265 7475 726e  oups).    return
+00016ea0: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
+00016eb0: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
+00016ec0: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00016ed0: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
+00016ee0: 4f4e 564f 4c55 5449 4f4e 290a 6465 6620  ONVOLUTION).def 
+00016ef0: 636f 6e76 6f6c 7574 696f 6e5f 6261 636b  convolution_back
+00016f00: 7761 7264 280a 2020 2020 6f75 7470 7574  ward(.    output
+00016f10: 3a20 5072 6f78 792c 0a20 2020 2069 6e70  : Proxy,.    inp
+00016f20: 7574 3a20 5072 6f78 792c 0a20 2020 2077  ut: Proxy,.    w
+00016f30: 6569 6768 742c 0a20 2020 2062 6961 732c  eight,.    bias,
+00016f40: 0a20 2020 2073 7472 6964 652c 0a20 2020  .    stride,.   
+00016f50: 2070 6164 6469 6e67 2c0a 2020 2020 6469   padding,.    di
+00016f60: 6c61 7469 6f6e 2c0a 2020 2020 7472 616e  lation,.    tran
+00016f70: 7370 6f73 6564 2c0a 2020 2020 6f75 7470  sposed,.    outp
+00016f80: 7574 5f70 6164 6469 6e67 2c0a 2020 2020  ut_padding,.    
+00016f90: 6772 6f75 7073 2c0a 2020 2020 6772 6164  groups,.    grad
+00016fa0: 2c0a 293a 0a20 2020 2023 2054 7261 6e73  ,.):.    # Trans
+00016fb0: 706f 7365 6420 636f 6e76 6f6c 7574 696f  posed convolutio
+00016fc0: 6e20 6973 206e 6f74 2073 7570 706f 7274  n is not support
+00016fd0: 6564 210a 2020 2020 6173 7365 7274 2074  ed!.    assert t
+00016fe0: 7261 6e73 706f 7365 6420 3d3d 2030 0a0a  ransposed == 0..
+00016ff0: 2020 2020 696e 7075 745f 6772 6164 203d      input_grad =
+00017000: 204e 6f6e 650a 2020 2020 7765 6967 6874   None.    weight
+00017010: 5f67 7261 6420 3d20 4e6f 6e65 0a20 2020  _grad = None.   
+00017020: 2062 6961 735f 6772 6164 203d 204e 6f6e   bias_grad = Non
+00017030: 650a 0a20 2020 2023 2053 686f 7274 2063  e..    # Short c
+00017040: 6972 6375 6974 206f 6e20 7a65 726f 2d64  ircuit on zero-d
+00017050: 696d 2067 7261 640a 2020 2020 6966 2061  im grad.    if a
+00017060: 6e79 2873 203d 3d20 3020 666f 7220 7320  ny(s == 0 for s 
+00017070: 696e 2067 7261 642e 7368 6170 6529 3a0a  in grad.shape):.
+00017080: 2020 2020 2020 2020 696e 7075 745f 6772          input_gr
+00017090: 6164 203d 2066 756c 6c5f 6c69 6b65 2869  ad = full_like(i
+000170a0: 6e70 7574 2c20 6669 6c6c 5f76 616c 7565  nput, fill_value
+000170b0: 3d30 290a 2020 2020 2020 2020 7765 6967  =0).        weig
+000170c0: 6874 5f67 7261 6420 3d20 6675 6c6c 5f6c  ht_grad = full_l
+000170d0: 696b 6528 7765 6967 6874 2c20 6669 6c6c  ike(weight, fill
+000170e0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+000170f0: 2020 6966 2062 6961 7320 6973 206e 6f74    if bias is not
+00017100: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00017110: 2020 2062 6961 735f 6772 6164 203d 2066     bias_grad = f
+00017120: 756c 6c5f 6c69 6b65 2862 6961 732c 2066  ull_like(bias, f
+00017130: 696c 6c5f 7661 6c75 653d 3029 0a20 2020  ill_value=0).   
+00017140: 2020 2020 2072 6574 7572 6e20 2869 6e70       return (inp
+00017150: 7574 5f67 7261 642c 2077 6569 6768 745f  ut_grad, weight_
+00017160: 6772 6164 2c20 6269 6173 5f67 7261 6429  grad, bias_grad)
+00017170: 202b 2028 284e 6f6e 652c 2920 2a20 3629   + ((None,) * 6)
+00017180: 0a0a 2020 2020 6261 7463 682c 2069 6e5f  ..    batch, in_
+00017190: 6368 616e 6e65 6c73 2c20 2a73 7061 7469  channels, *spati
+000171a0: 616c 5f64 696d 7320 3d20 696e 7075 742e  al_dims = input.
+000171b0: 7368 6170 650a 2020 2020 6f75 745f 6368  shape.    out_ch
+000171c0: 616e 6e65 6c73 2c20 6769 6e5f 6368 616e  annels, gin_chan
+000171d0: 6e65 6c73 2c20 2a6b 6572 6e65 6c5f 6469  nels, *kernel_di
+000171e0: 6d73 203d 2077 6569 6768 742e 7368 6170  ms = weight.shap
+000171f0: 650a 2020 2020 6469 6d20 3d20 6c65 6e28  e.    dim = len(
+00017200: 7370 6174 6961 6c5f 6469 6d73 290a 0a20  spatial_dims).. 
+00017210: 2020 2064 6566 206d 6179 6265 5f65 7870     def maybe_exp
+00017220: 616e 645f 7365 7128 732c 2064 696d 293a  and_seq(s, dim):
+00017230: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00017240: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
+00017250: 2020 2020 2072 6574 7572 6e20 2873 5b30       return (s[0
+00017260: 5d2c 2920 2a20 6469 6d0a 2020 2020 2020  ],) * dim.      
+00017270: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00017280: 2020 2020 7265 7475 726e 2073 0a0a 2020      return s..  
+00017290: 2020 7374 7269 6465 203d 206d 6179 6265    stride = maybe
+000172a0: 5f65 7870 616e 645f 7365 7128 7374 7269  _expand_seq(stri
+000172b0: 6465 2c20 6469 6d29 0a20 2020 2070 6164  de, dim).    pad
+000172c0: 6469 6e67 203d 206d 6179 6265 5f65 7870  ding = maybe_exp
+000172d0: 616e 645f 7365 7128 7061 6464 696e 672c  and_seq(padding,
+000172e0: 2064 696d 290a 2020 2020 6469 6c61 7469   dim).    dilati
+000172f0: 6f6e 203d 206d 6179 6265 5f65 7870 616e  on = maybe_expan
+00017300: 645f 7365 7128 6469 6c61 7469 6f6e 2c20  d_seq(dilation, 
+00017310: 6469 6d29 0a0a 2020 2020 6465 6620 636f  dim)..    def co
+00017320: 6e76 5f74 7261 6e73 706f 7365 2874 293a  nv_transpose(t):
+00017330: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00017340: 7072 696d 732e 7472 616e 7370 6f73 6528  prims.transpose(
+00017350: 742c 2028 312c 2030 2920 2b20 7475 706c  t, (1, 0) + tupl
+00017360: 6528 7261 6e67 6528 322c 2074 2e6e 6469  e(range(2, t.ndi
+00017370: 6d29 2929 0a0a 2020 2020 2320 696e 7075  m)))..    # inpu
+00017380: 745f 6772 6164 203d 207b 0a20 2020 2064  t_grad = {.    d
+00017390: 6566 2074 7261 6e73 706f 7365 5f61 6e64  ef transpose_and
+000173a0: 5f66 6c69 705f 7765 6967 6874 2877 6569  _flip_weight(wei
+000173b0: 6768 7429 3a0a 2020 2020 2020 2020 2320  ght):.        # 
+000173c0: 5468 6520 6c69 6e65 7320 6265 6c6f 7720  The lines below 
+000173d0: 6172 6520 7472 616e 7370 6f73 696e 6720  are transposing 
+000173e0: 7468 6520 6368 616e 6e65 6c73 2064 696d  the channels dim
+000173f0: 732e 0a20 2020 2020 2020 2023 2057 6520  s..        # We 
+00017400: 616c 736f 206e 6565 6420 746f 2065 7874  also need to ext
+00017410: 7261 6374 2074 6865 2067 726f 7570 2069  ract the group i
+00017420: 6e66 6f72 6d61 7469 6f6e 2061 6e64 206d  nformation and m
+00017430: 6572 6765 2069 740a 2020 2020 2020 2020  erge it.        
+00017440: 2320 7769 7468 2074 6865 2064 696d 656e  # with the dimen
+00017450: 7369 6f6e 2063 6f72 7265 7370 6f6e 6469  sion correspondi
+00017460: 6e67 2074 6f20 7468 6520 226f 7574 5f63  ng to the "out_c
+00017470: 6861 6e6e 656c 7322 2064 696d 2e0a 2020  hannels" dim..  
+00017480: 2020 2020 2020 2320 286f 7574 5f63 6861        # (out_cha
+00017490: 6e6e 656c 732c 2067 696e 5f63 6861 6e6e  nnels, gin_chann
+000174a0: 656c 7329 202d 3e20 2867 696e 5f63 6861  els) -> (gin_cha
+000174b0: 6e6e 656c 732c 206f 7574 5f63 6861 6e6e  nnels, out_chann
+000174c0: 656c 7329 0a20 2020 2020 2020 2077 6569  els).        wei
+000174d0: 6768 7420 3d20 636f 6e76 5f74 7261 6e73  ght = conv_trans
+000174e0: 706f 7365 2877 6569 6768 7429 0a20 2020  pose(weight).   
+000174f0: 2020 2020 2023 2053 706c 6974 2028 6f75       # Split (ou
+00017500: 745f 6368 616e 6e65 6c73 2c29 202d 3e20  t_channels,) -> 
+00017510: 2867 726f 7570 732c 206f 7574 5f63 6861  (groups, out_cha
+00017520: 6e6e 656c 7320 2f2f 2067 726f 7570 7329  nnels // groups)
+00017530: 0a20 2020 2020 2020 2077 6569 6768 7420  .        weight 
+00017540: 3d20 7765 6967 6874 2e72 6573 6861 7065  = weight.reshape
+00017550: 285b 6769 6e5f 6368 616e 6e65 6c73 2c20  ([gin_channels, 
+00017560: 6772 6f75 7073 2c20 6f75 745f 6368 616e  groups, out_chan
+00017570: 6e65 6c73 202f 2f20 6772 6f75 7073 5d20  nels // groups] 
+00017580: 2b20 6b65 726e 656c 5f64 696d 7329 0a20  + kernel_dims). 
+00017590: 2020 2020 2020 2023 204d 6f76 696e 6720         # Moving 
+000175a0: 6772 6f75 7073 2074 6f20 7468 6520 6c65  groups to the le
+000175b0: 6674 2d6d 6f73 7420 706f 7369 7469 6f6e  ft-most position
+000175c0: 2e0a 2020 2020 2020 2020 2320 2867 696e  ..        # (gin
+000175d0: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
+000175e0: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
+000175f0: 2f2f 2067 726f 7570 7329 202d 3e20 2867  // groups) -> (g
+00017600: 726f 7570 732c 2067 696e 5f63 6861 6e6e  roups, gin_chann
+00017610: 656c 732c 206f 7574 5f63 6861 6e6e 656c  els, out_channel
+00017620: 7320 2f2f 2067 726f 7570 7329 0a20 2020  s // groups).   
+00017630: 2020 2020 2077 6569 6768 7420 3d20 636f       weight = co
+00017640: 6e76 5f74 7261 6e73 706f 7365 2877 6569  nv_transpose(wei
+00017650: 6768 7429 0a20 2020 2020 2020 2023 2053  ght).        # S
+00017660: 7175 6173 6820 2867 726f 7570 732c 2067  quash (groups, g
+00017670: 696e 5f63 6861 6e6e 656c 7329 202d 3e20  in_channels) -> 
+00017680: 2869 6e5f 6368 616e 6e65 6c73 290a 2020  (in_channels).  
+00017690: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
+000176a0: 6569 6768 742e 7265 7368 6170 6528 5b69  eight.reshape([i
+000176b0: 6e5f 6368 616e 6e65 6c73 2c20 6f75 745f  n_channels, out_
+000176c0: 6368 616e 6e65 6c73 202f 2f20 6772 6f75  channels // grou
+000176d0: 7073 5d20 2b20 6b65 726e 656c 5f64 696d  ps] + kernel_dim
+000176e0: 7329 0a0a 2020 2020 2020 2020 2320 466c  s)..        # Fl
+000176f0: 6970 2073 7061 7469 616c 2064 696d 656e  ip spatial dimen
+00017700: 7369 6f6e 730a 2020 2020 2020 2020 7765  sions.        we
+00017710: 6967 6874 203d 2070 7269 6d73 2e66 6c69  ight = prims.fli
+00017720: 7028 7765 6967 6874 2c20 7475 706c 6528  p(weight, tuple(
+00017730: 7261 6e67 6528 322c 2077 6569 6768 742e  range(2, weight.
+00017740: 6e64 696d 2929 290a 2020 2020 2020 2020  ndim))).        
+00017750: 7265 7475 726e 2077 6569 6768 740a 0a20  return weight.. 
+00017760: 2020 2023 2057 6520 6e65 6564 2074 6f20     # We need to 
+00017770: 7061 6420 7468 6520 6772 6164 6965 6e74  pad the gradient
+00017780: 2074 6f20 6265 2061 626c 6520 746f 2066   to be able to f
+00017790: 6974 206b 6572 6e65 6c20 7769 6e64 6f77  it kernel window
+000177a0: 732e 0a20 2020 2069 6e69 7469 616c 5f67  s..    initial_g
+000177b0: 7261 645f 7061 6464 696e 6720 3d20 5b64  rad_padding = [d
+000177c0: 202a 2028 6b20 2d20 3129 2066 6f72 2064   * (k - 1) for d
+000177d0: 2c20 6b20 696e 207a 6970 2864 696c 6174  , k in zip(dilat
+000177e0: 696f 6e2c 206b 6572 6e65 6c5f 6469 6d73  ion, kernel_dims
+000177f0: 295d 0a0a 2020 2020 696e 7075 745f 6772  )]..    input_gr
+00017800: 6164 203d 2063 6f6e 766f 6c75 7469 6f6e  ad = convolution
+00017810: 280a 2020 2020 2020 2020 7072 696d 732e  (.        prims.
+00017820: 7061 6428 0a20 2020 2020 2020 2020 2020  pad(.           
+00017830: 2067 7261 642c 0a20 2020 2020 2020 2020   grad,.         
+00017840: 2020 2030 2e30 2c0a 2020 2020 2020 2020     0.0,.        
+00017850: 2020 2020 2320 5468 6520 7069 7865 7320      # The pixes 
+00017860: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
+00017870: 6672 6f6d 2065 6163 6820 6f74 6865 7220  from each other 
+00017880: 696e 2074 6865 206f 7269 6769 6e61 6c20  in the original 
+00017890: 696e 7075 742e 0a20 2020 2020 2020 2020  input..         
+000178a0: 2020 2023 2048 656e 6365 2077 6520 6e65     # Hence we ne
+000178b0: 6564 2074 6f20 6469 6c61 7465 2074 6865  ed to dilate the
+000178c0: 2067 7261 6469 656e 7420 6279 2064 696c   gradient by dil
+000178d0: 6174 696f 6e3d 7374 7269 6465 202d 2031  ation=stride - 1
+000178e0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+000178f0: 6f20 7468 6174 2074 6865 7265 2061 7265  o that there are
+00017900: 2073 7472 6964 6520 2d20 3120 7a65 726f   stride - 1 zero
+00017910: 7320 6265 7477 6565 6e20 7468 6520 7069  s between the pi
+00017920: 7865 6c73 2e0a 2020 2020 2020 2020 2020  xels..          
+00017930: 2020 5b28 302c 2030 2c20 3029 2c20 2830    [(0, 0, 0), (0
+00017940: 2c20 302c 2030 295d 202b 205b 2830 2c20  , 0, 0)] + [(0, 
+00017950: 302c 2073 202d 2031 2920 666f 7220 7320  0, s - 1) for s 
+00017960: 696e 2073 7472 6964 655d 2c0a 2020 2020  in stride],.    
+00017970: 2020 2020 292c 0a20 2020 2020 2020 2074      ),.        t
+00017980: 7261 6e73 706f 7365 5f61 6e64 5f66 6c69  ranspose_and_fli
+00017990: 705f 7765 6967 6874 2877 6569 6768 7429  p_weight(weight)
+000179a0: 2c0a 2020 2020 2020 2020 4e6f 6e65 2c0a  ,.        None,.
+000179b0: 2020 2020 2020 2020 2320 5365 7474 696e          # Settin
+000179c0: 6720 7374 7269 6465 2074 6f20 3120 6173  g stride to 1 as
+000179d0: 2074 6865 2064 6973 7461 6e63 6520 6265   the distance be
+000179e0: 7477 6565 6e20 7069 7865 6c73 2069 7320  tween pixels is 
+000179f0: 7461 6b65 6e0a 2020 2020 2020 2020 2320  taken.        # 
+00017a00: 6361 7265 2062 7920 7468 6520 7061 6420  care by the pad 
+00017a10: 7269 6768 7420 6162 6f76 652e 0a20 2020  right above..   
+00017a20: 2020 2020 2028 312c 292c 0a20 2020 2020       (1,),.     
+00017a30: 2020 2069 6e69 7469 616c 5f67 7261 645f     initial_grad_
+00017a40: 7061 6464 696e 672c 0a20 2020 2020 2020  padding,.       
+00017a50: 2064 696c 6174 696f 6e2c 0a20 2020 2020   dilation,.     
+00017a60: 2020 2074 7261 6e73 706f 7365 642c 0a20     transposed,. 
+00017a70: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
+00017a80: 6464 696e 672c 0a20 2020 2020 2020 2067  dding,.        g
+00017a90: 726f 7570 732c 0a20 2020 2029 0a0a 2020  roups,.    )..  
+00017aa0: 2020 6465 6620 7061 645f 746f 5f69 6e70    def pad_to_inp
+00017ab0: 7574 2867 7261 6429 3a0a 2020 2020 2020  ut(grad):.      
+00017ac0: 2020 2320 5765 206e 6565 6420 746f 2075    # We need to u
+00017ad0: 6e70 6164 2074 6865 2070 6164 6469 6e67  npad the padding
+00017ae0: 2064 6f6e 6520 746f 2074 6865 2069 6e70   done to the inp
+00017af0: 7574 2070 7269 6f72 2074 6f20 7468 6520  ut prior to the 
+00017b00: 636f 6e76 6f6c 7574 696f 6e2e 0a20 2020  convolution..   
+00017b10: 2020 2020 2023 204e 6f74 6520 7468 6174       # Note that
+00017b20: 206c 6f77 2061 6e64 2068 6967 6820 7061   low and high pa
+00017b30: 6464 696e 6720 6172 6520 6e6f 7420 6e65  dding are not ne
+00017b40: 6365 7373 6172 696c 7920 6571 7561 6c2c  cessarily equal,
+00017b50: 2073 6f20 7765 2063 616e 6e6f 740a 2020   so we cannot.  
+00017b60: 2020 2020 2020 2320 6162 736f 7262 2069        # absorb i
+00017b70: 7420 696e 746f 2074 6865 2063 6f6e 766f  t into the convo
+00017b80: 6c75 7469 6f6e 206a 7573 7420 7965 742c  lution just yet,
+00017b90: 2075 6e6c 6573 7320 7468 6520 4150 4920   unless the API 
+00017ba0: 6973 206d 6f64 6966 6965 642e 0a20 2020  is modified..   
+00017bb0: 2020 2020 2070 6164 5f63 6f6e 6669 6720       pad_config 
+00017bc0: 3d20 5b28 302c 2030 2c20 3029 2c20 2830  = [(0, 0, 0), (0
+00017bd0: 2c20 302c 2030 295d 0a20 2020 2020 2020  , 0, 0)].       
+00017be0: 2066 6f72 206f 2c20 692c 2067 2c20 7020   for o, i, g, p 
+00017bf0: 696e 207a 6970 2867 7261 642e 7368 6170  in zip(grad.shap
+00017c00: 655b 323a 5d2c 2073 7061 7469 616c 5f64  e[2:], spatial_d
+00017c10: 696d 732c 2069 6e70 7574 5f67 7261 642e  ims, input_grad.
+00017c20: 7368 6170 655b 323a 5d2c 2070 6164 6469  shape[2:], paddi
+00017c30: 6e67 293a 0a20 2020 2020 2020 2020 2020  ng):.           
+00017c40: 206c 6f20 3d20 2d70 0a20 2020 2020 2020   lo = -p.       
+00017c50: 2020 2020 2023 204e 6f74 6520 7468 6174       # Note that
+00017c60: 2028 6920 2b20 3220 2a20 7029 2069 7320   (i + 2 * p) is 
+00017c70: 7468 6520 7369 7a65 206f 6620 7468 6520  the size of the 
+00017c80: 7061 6464 6564 2069 6e70 7574 2c0a 2020  padded input,.  
+00017c90: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
+00017ca0: 6865 2071 7561 6e74 6974 7920 2869 202b  he quantity (i +
+00017cb0: 2032 202a 2070 2920 2d20 6720 7465 6c6c   2 * p) - g tell
+00017cc0: 7320 7573 2062 7920 686f 7720 6d75 6368  s us by how much
+00017cd0: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
+00017ce0: 6520 6e65 6564 2074 6f20 7061 6420 7468  e need to pad th
+00017cf0: 6520 6772 6164 6965 6e74 2073 6f20 7468  e gradient so th
+00017d00: 6174 2074 6865 2065 6c65 6d65 6e74 7320  at the elements 
+00017d10: 6f75 7473 6964 650a 2020 2020 2020 2020  outside.        
+00017d20: 2020 2020 2320 6f66 2074 6865 2063 6f6e      # of the con
+00017d30: 766f 6c75 7469 6f6e 2072 6563 6569 7665  volution receive
+00017d40: 207a 6572 6f20 6772 6164 6965 6e74 2e0a   zero gradient..
+00017d50: 2020 2020 2020 2020 2020 2020 2320 7020              # p 
+00017d60: 6973 2061 6464 6974 696f 6e61 6c6c 7920  is additionally 
+00017d70: 7375 6274 7261 6374 6564 2074 6f20 6e65  subtracted to ne
+00017d80: 6761 7465 2074 6865 2069 6e70 7574 2773  gate the input's
+00017d90: 2070 6164 0a20 2020 2020 2020 2020 2020   pad.           
+00017da0: 2023 2069 6e20 666f 7277 6172 642e 0a20   # in forward.. 
+00017db0: 2020 2020 2020 2020 2020 2068 6920 3d20             hi = 
+00017dc0: 2869 202b 2032 202a 2070 2920 2d20 6720  (i + 2 * p) - g 
+00017dd0: 2d20 700a 2020 2020 2020 2020 2020 2020  - p.            
+00017de0: 7061 645f 636f 6e66 6967 2e61 7070 656e  pad_config.appen
+00017df0: 6428 286c 6f2c 2068 692c 2030 2929 0a20  d((lo, hi, 0)). 
+00017e00: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
+00017e10: 696d 732e 7061 6428 6772 6164 2c20 302e  ims.pad(grad, 0.
+00017e20: 302c 2070 6164 5f63 6f6e 6669 6729 0a0a  0, pad_config)..
+00017e30: 2020 2020 696e 7075 745f 6772 6164 203d      input_grad =
+00017e40: 2070 6164 5f74 6f5f 696e 7075 7428 696e   pad_to_input(in
+00017e50: 7075 745f 6772 6164 290a 2020 2020 2320  put_grad).    # 
+00017e60: 7d0a 0a20 2020 2023 2062 6961 735f 6772  }..    # bias_gr
+00017e70: 6164 203d 207b 0a20 2020 2069 6620 6269  ad = {.    if bi
+00017e80: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
+00017e90: 2020 2020 2020 2020 696d 706f 7274 2074          import t
+00017ea0: 6875 6e64 6572 2e74 6f72 6368 2061 7320  hunder.torch as 
+00017eb0: 6c74 6f72 6368 0a0a 2020 2020 2020 2020  ltorch..        
+00017ec0: 6269 6173 5f67 7261 6420 3d20 6c74 6f72  bias_grad = ltor
+00017ed0: 6368 2e73 756d 2867 7261 642c 205b 6420  ch.sum(grad, [d 
+00017ee0: 666f 7220 6420 696e 2072 616e 6765 2867  for d in range(g
+00017ef0: 7261 642e 6e64 696d 2920 6966 2064 2021  rad.ndim) if d !
+00017f00: 3d20 315d 290a 2020 2020 2320 7d0a 0a20  = 1]).    # }.. 
+00017f10: 2020 2023 2077 6569 6768 7420 6772 6164     # weight grad
+00017f20: 203d 207b 0a20 2020 2064 6566 2070 6164   = {.    def pad
+00017f30: 5f74 7261 6e73 706f 7365 5f61 6e64 5f70  _transpose_and_p
+00017f40: 7573 685f 6772 6f75 7073 5f69 6e74 6f5f  ush_groups_into_
+00017f50: 6261 7463 6865 7328 7429 3a0a 2020 2020  batches(t):.    
+00017f60: 2020 2020 2320 4669 7273 7420 7061 642c      # First pad,
+00017f70: 2e2e 2e0a 2020 2020 2020 2020 2320 5061  ....        # Pa
+00017f80: 6420 6173 206e 6563 6573 7361 7279 2073  d as necessary s
+00017f90: 6f20 7468 6174 2069 6e20 636f 6e76 6f6c  o that in convol
+00017fa0: 7574 696f 6e73 2077 6520 6e65 7665 7220  utions we never 
+00017fb0: 6164 7661 6e63 650a 2020 2020 2020 2020  advance.        
+00017fc0: 2320 7061 7374 2072 656c 6576 616e 7420  # past relevant 
+00017fd0: 696e 7075 7473 2e0a 2020 2020 2020 2020  inputs..        
+00017fe0: 7061 645f 636f 6e66 6967 203d 205b 2830  pad_config = [(0
+00017ff0: 2c20 302c 2030 292c 2028 302c 2030 2c20  , 0, 0), (0, 0, 
+00018000: 3029 5d0a 2020 2020 2020 2020 666f 7220  0)].        for 
+00018010: 6f2c 2069 2c20 6b2c 2070 2c20 732c 2064  o, i, k, p, s, d
+00018020: 2069 6e20 7a69 7028 6772 6164 2e73 6861   in zip(grad.sha
+00018030: 7065 5b32 3a5d 2c20 7370 6174 6961 6c5f  pe[2:], spatial_
+00018040: 6469 6d73 2c20 6b65 726e 656c 5f64 696d  dims, kernel_dim
+00018050: 732c 2070 6164 6469 6e67 2c20 7374 7269  s, padding, stri
+00018060: 6465 2c20 6469 6c61 7469 6f6e 293a 0a20  de, dilation):. 
+00018070: 2020 2020 2020 2020 2020 2023 2050 6164             # Pad
+00018080: 6469 6e67 2066 726f 6d20 6265 6c6f 7720  ding from below 
+00018090: 6973 2074 6865 2073 616d 652e 0a20 2020  is the same..   
+000180a0: 2020 2020 2020 2020 206c 6f20 3d20 700a           lo = p.
+000180b0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+000180c0: 6572 6520 6973 2061 6c77 6179 7320 7468  ere is always th
+000180d0: 6520 6d61 7820 696e 6465 7820 6964 7820  e max index idx 
+000180e0: 696e 2074 6865 2069 6e70 7574 0a20 2020  in the input.   
+000180f0: 2020 2020 2020 2020 2023 2074 6865 2076           # the v
+00018100: 616c 7565 206f 6620 7768 6963 682c 2069  alue of which, i
+00018110: 6e70 7574 5b69 6478 5d2c 2074 6865 206b  nput[idx], the k
+00018120: 6572 6e65 6c20 746f 7563 6865 732e 0a20  ernel touches.. 
+00018130: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00018140: 206b 6572 6e65 6c20 7265 6163 682c 206f   kernel reach, o
+00018150: 7220 6b5f 7265 6163 682c 2069 7320 6578  r k_reach, is ex
+00018160: 6163 746c 7920 6964 7820 2b20 312e 0a20  actly idx + 1.. 
+00018170: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+00018180: 7573 6520 6974 2074 6f20 6465 6369 6465  use it to decide
+00018190: 2062 7920 686f 7720 6d75 6368 2077 6520   by how much we 
+000181a0: 6e65 6564 2074 6f20 7061 6420 6672 6f6d  need to pad from
+000181b0: 2061 626f 7665 0a20 2020 2020 2020 2020   above.         
+000181c0: 2020 2023 2061 7320 746f 206e 6f74 206d     # as to not m
+000181d0: 6f76 6520 7061 7374 2072 656c 6576 616e  ove past relevan
+000181e0: 7420 7661 6c75 6573 2e0a 2020 2020 2020  t values..      
+000181f0: 2020 2020 2020 6b5f 7265 6163 6820 3d20        k_reach = 
+00018200: 286f 202d 2031 2920 2a20 7320 2b20 6420  (o - 1) * s + d 
+00018210: 2a20 286b 202d 2031 2920 2b20 310a 2020  * (k - 1) + 1.  
+00018220: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00018230: 7061 6420 6672 6f6d 2061 626f 7665 2065  pad from above e
+00018240: 7175 616c 7320 6b5f 7265 6163 6820 6d69  quals k_reach mi
+00018250: 6e75 7320 7468 6520 6c65 6e67 7468 0a20  nus the length. 
+00018260: 2020 2020 2020 2020 2020 2023 206f 6620             # of 
+00018270: 7468 6520 696e 7075 7420 7061 6464 6564  the input padded
+00018280: 2066 726f 6d20 6265 6c6f 772e 0a20 2020   from below..   
+00018290: 2020 2020 2020 2020 2068 6920 3d20 6b5f           hi = k_
+000182a0: 7265 6163 6820 2d20 2869 202b 2070 290a  reach - (i + p).
+000182b0: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
+000182c0: 636f 6e66 6967 2e61 7070 656e 6428 286c  config.append((l
+000182d0: 6f2c 2068 692c 2030 2929 0a20 2020 2020  o, hi, 0)).     
+000182e0: 2020 2074 203d 2070 7269 6d73 2e70 6164     t = prims.pad
+000182f0: 2874 2c20 302e 302c 2070 6164 5f63 6f6e  (t, 0.0, pad_con
+00018300: 6669 6729 0a0a 2020 2020 2020 2020 5f2c  fig)..        _,
+00018310: 205f 2c20 2a74 5f73 7061 7469 616c 5f64   _, *t_spatial_d
+00018320: 696d 7320 3d20 742e 7368 6170 650a 0a20  ims = t.shape.. 
+00018330: 2020 2020 2020 2023 202e 2e2e 2074 6865         # ... the
+00018340: 6e20 646f 2074 6865 2072 6573 742e 0a20  n do the rest.. 
+00018350: 2020 2020 2020 2023 2074 2e73 6861 7065         # t.shape
+00018360: 203d 3d20 2862 6174 6368 2c20 696e 5f63   == (batch, in_c
+00018370: 6861 6e6e 656c 732c 202e 2e2e 290a 2020  hannels, ...).  
+00018380: 2020 2020 2020 2320 5468 6520 7265 7375        # The resu
+00018390: 6c74 206f 6620 7468 6973 2066 756e 6374  lt of this funct
+000183a0: 696f 6e20 6861 7320 7368 6170 650a 2020  ion has shape.  
+000183b0: 2020 2020 2020 2320 2869 6e5f 6368 616e        # (in_chan
+000183c0: 6e65 6c73 2c20 6261 7463 6820 2a20 6772  nels, batch * gr
+000183d0: 6f75 7073 290a 2020 2020 2020 2020 2320  oups).        # 
+000183e0: 2862 6174 6368 2c20 696e 5f63 6861 6e6e  (batch, in_chann
+000183f0: 656c 7329 202d 3e20 2869 6e5f 6368 616e  els) -> (in_chan
+00018400: 6e65 6c73 2c20 6261 7463 6829 0a20 2020  nels, batch).   
+00018410: 2020 2020 2074 203d 2063 6f6e 765f 7472       t = conv_tr
+00018420: 616e 7370 6f73 6528 7429 0a20 2020 2020  anspose(t).     
+00018430: 2020 2023 2053 706c 6974 2028 696e 5f63     # Split (in_c
+00018440: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
+00018450: 6f75 7073 2c20 6769 6e5f 6368 616e 6e65  oups, gin_channe
+00018460: 6c73 290a 2020 2020 2020 2020 7420 3d20  ls).        t = 
+00018470: 742e 7265 7368 6170 6528 5b67 726f 7570  t.reshape([group
+00018480: 732c 2067 696e 5f63 6861 6e6e 656c 732c  s, gin_channels,
+00018490: 2062 6174 6368 5d20 2b20 745f 7370 6174   batch] + t_spat
+000184a0: 6961 6c5f 6469 6d73 290a 2020 2020 2020  ial_dims).      
+000184b0: 2020 2320 5472 616e 7370 6f73 6520 2867    # Transpose (g
+000184c0: 726f 7570 732c 2067 696e 5f63 6861 6e6e  roups, gin_chann
+000184d0: 656c 732c 2062 6174 6368 2920 2d3e 2028  els, batch) -> (
+000184e0: 6769 6e5f 6368 616e 6e65 6c73 2c20 6772  gin_channels, gr
+000184f0: 6f75 7073 2c20 6261 7463 6829 0a20 2020  oups, batch).   
+00018500: 2020 2020 2074 203d 2063 6f6e 765f 7472       t = conv_tr
+00018510: 616e 7370 6f73 6528 7429 0a20 2020 2020  anspose(t).     
+00018520: 2020 2023 2046 6c61 7474 656e 2028 6772     # Flatten (gr
+00018530: 6f75 7073 2c20 6261 7463 6829 202d 3e20  oups, batch) -> 
+00018540: 2867 726f 7570 7320 2a20 6261 7463 682c  (groups * batch,
+00018550: 290a 2020 2020 2020 2020 7420 3d20 742e  ).        t = t.
+00018560: 7265 7368 6170 6528 5b67 696e 5f63 6861  reshape([gin_cha
+00018570: 6e6e 656c 732c 2067 726f 7570 7320 2a20  nnels, groups * 
+00018580: 6261 7463 685d 202b 2074 5f73 7061 7469  batch] + t_spati
+00018590: 616c 5f64 696d 7329 0a20 2020 2020 2020  al_dims).       
+000185a0: 2072 6574 7572 6e20 740a 0a20 2020 2023   return t..    #
+000185b0: 2069 6e70 7574 2077 696c 6c20 6861 7665   input will have
+000185c0: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
+000185d0: 6e65 6c73 2c20 6772 6f75 7073 202a 2062  nels, groups * b
+000185e0: 6174 6368 290a 2020 2020 696e 7075 7420  atch).    input 
+000185f0: 3d20 7061 645f 7472 616e 7370 6f73 655f  = pad_transpose_
+00018600: 616e 645f 7075 7368 5f67 726f 7570 735f  and_push_groups_
+00018610: 696e 746f 5f62 6174 6368 6573 2869 6e70  into_batches(inp
+00018620: 7574 290a 2020 2020 2320 6772 6164 2077  ut).    # grad w
+00018630: 696c 6c20 6861 7665 2073 6861 7065 2028  ill have shape (
+00018640: 6f75 745f 6368 616e 6e65 6c73 2c20 6261  out_channels, ba
+00018650: 7463 6829 0a20 2020 2023 204e 6f74 6520  tch).    # Note 
+00018660: 7468 6174 2074 6865 7365 2073 6861 7065  that these shape
+00018670: 7320 6172 6520 636f 6d70 6174 6962 6c65  s are compatible
+00018680: 2066 6f72 2061 2067 726f 7570 2063 6f6e   for a group con
+00018690: 766f 6c75 7469 6f6e 2e0a 2020 2020 6772  volution..    gr
+000186a0: 6164 203d 2063 6f6e 765f 7472 616e 7370  ad = conv_transp
+000186b0: 6f73 6528 6772 6164 290a 0a20 2020 2023  ose(grad)..    #
+000186c0: 2057 6879 2064 6f20 7765 2066 6c69 7020   Why do we flip 
+000186d0: 7374 7269 6465 2061 6e64 2064 696c 6174  stride and dilat
+000186e0: 696f 6e3f 0a20 2020 2023 206b 6572 6e65  ion?.    # kerne
+000186f0: 6c5b 695d 2061 6e64 206b 6572 6e65 6c5b  l[i] and kernel[
+00018700: 6920 2b20 315d 2061 7265 2064 696c 6174  i + 1] are dilat
+00018710: 696f 6e20 6170 6172 7420 6672 6f6d 2065  ion apart from e
+00018720: 6163 6820 6f74 6865 722c 0a20 2020 2023  ach other,.    #
+00018730: 2073 6f20 6469 6c61 7469 6f6e 2062 6563   so dilation bec
+00018740: 6f6d 6573 2074 6865 206e 6577 2073 7472  omes the new str
+00018750: 6964 652e 0a20 2020 2023 2041 6c6c 2074  ide..    # All t
+00018760: 6865 2065 6c65 6d65 6e74 7320 7468 6174  he elements that
+00018770: 206b 6572 6e65 6c5b 695d 2074 6f75 6368   kernel[i] touch
+00018780: 6573 2061 7265 2073 7472 6964 6520 6177  es are stride aw
+00018790: 6179 2066 726f 6d20 6561 6368 206f 7468  ay from each oth
+000187a0: 6572 2c0a 2020 2020 2320 6865 6e63 6520  er,.    # hence 
+000187b0: 7374 7269 6465 2062 6563 6f6d 6573 2074  stride becomes t
+000187c0: 6865 206e 6577 2064 696c 6174 696f 6e2e  he new dilation.
+000187d0: 0a20 2020 2077 6569 6768 745f 6772 6164  .    weight_grad
+000187e0: 203d 2063 6f6e 766f 6c75 7469 6f6e 280a   = convolution(.
+000187f0: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00018800: 2020 2020 2020 2067 7261 642c 0a20 2020         grad,.   
+00018810: 2020 2020 204e 6f6e 652c 0a20 2020 2020       None,.     
+00018820: 2020 2064 696c 6174 696f 6e2c 2020 2320     dilation,  # 
+00018830: 7365 7420 7374 7269 6465 3d64 696c 6174  set stride=dilat
+00018840: 696f 6e0a 2020 2020 2020 2020 2830 2c29  ion.        (0,)
+00018850: 2c0a 2020 2020 2020 2020 7374 7269 6465  ,.        stride
+00018860: 2c20 2023 2073 6574 2064 696c 6174 696f  ,  # set dilatio
+00018870: 6e3d 7374 7269 6465 0a20 2020 2020 2020  n=stride.       
+00018880: 2074 7261 6e73 706f 7365 642c 0a20 2020   transposed,.   
+00018890: 2020 2020 206f 7574 7075 745f 7061 6464       output_padd
+000188a0: 696e 672c 0a20 2020 2020 2020 2067 726f  ing,.        gro
+000188b0: 7570 732c 0a20 2020 2029 0a0a 2020 2020  ups,.    )..    
+000188c0: 2320 5468 6520 7265 7375 6c74 206f 6620  # The result of 
+000188d0: 7468 6520 636f 6e76 6f6c 7574 696f 6e20  the convolution 
+000188e0: 6861 7320 7368 6170 6520 2867 696e 5f63  has shape (gin_c
+000188f0: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
+00018900: 6e6e 656c 7329 2c0a 2020 2020 2320 736f  nnels),.    # so
+00018910: 2074 7261 6e73 706f 7369 7469 6f6e 2069   transposition i
+00018920: 7320 7265 7175 6972 6564 2e0a 2020 2020  s required..    
+00018930: 7765 6967 6874 5f67 7261 6420 3d20 636f  weight_grad = co
+00018940: 6e76 5f74 7261 6e73 706f 7365 2877 6569  nv_transpose(wei
+00018950: 6768 745f 6772 6164 290a 2020 2020 2320  ght_grad).    # 
+00018960: 7d0a 0a20 2020 2072 6574 7572 6e20 2869  }..    return (i
+00018970: 6e70 7574 5f67 7261 642c 2077 6569 6768  nput_grad, weigh
+00018980: 745f 6772 6164 2c20 6269 6173 5f67 7261  t_grad, bias_gra
+00018990: 6429 0a0a 0a40 7265 6769 7374 6572 5f61  d)...@register_a
+000189a0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+000189b0: 2822 746f 7263 682e 6c6f 675f 736f 6674  ("torch.log_soft
+000189c0: 6d61 7822 290a 6465 6620 6c6f 675f 736f  max").def log_so
+000189d0: 6674 6d61 785f 6175 675f 6677 6428 696e  ftmax_aug_fwd(in
+000189e0: 7075 743a 2054 656e 736f 7250 726f 7879  put: TensorProxy
+000189f0: 2c20 6469 6d3a 2069 6e74 2c20 2a2c 2064  , dim: int, *, d
+00018a00: 7479 7065 3d4e 6f6e 6529 202d 3e20 564a  type=None) -> VJ
+00018a10: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
+00018a20: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+00018a30: 706f 7274 206c 6f67 5f73 6f66 746d 6178  port log_softmax
+00018a40: 0a0a 2020 2020 7072 696d 616c 203d 206c  ..    primal = l
+00018a50: 6f67 5f73 6f66 746d 6178 2869 6e70 7574  og_softmax(input
+00018a60: 2c20 6469 6d3d 6469 6d2c 2064 7479 7065  , dim=dim, dtype
+00018a70: 3d64 7479 7065 290a 2020 2020 7265 7369  =dtype).    resi
+00018a80: 6475 616c 7320 3d20 2870 7269 6d61 6c2c  duals = (primal,
+00018a90: 2064 696d 2c20 696e 7075 742e 6474 7970   dim, input.dtyp
+00018aa0: 6529 0a20 2020 2072 6574 7572 6e20 564a  e).    return VJ
+00018ab0: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00018ac0: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00018ad0: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
+00018ae0: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
+00018af0: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
+00018b00: 6178 5f62 6163 6b77 6172 6428 7072 696d  ax_backward(prim
+00018b10: 616c 2c20 6469 6d2c 2064 7479 7065 2c20  al, dim, dtype, 
+00018b20: 6729 3a0a 2020 2020 6672 6f6d 2074 6875  g):.    from thu
+00018b30: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00018b40: 7420 6c6f 675f 736f 6674 6d61 785f 6261  t log_softmax_ba
+00018b50: 636b 7761 7264 0a0a 2020 2020 7265 7475  ckward..    retu
+00018b60: 726e 206c 6f67 5f73 6f66 746d 6178 5f62  rn log_softmax_b
+00018b70: 6163 6b77 6172 6428 672c 2070 7269 6d61  ackward(g, prima
+00018b80: 6c2c 2064 696d 2c20 6474 7970 6529 0a0a  l, dim, dtype)..
+00018b90: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00018ba0: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
+00018bb0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+00018bc0: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
+00018bd0: 206e 6c6c 5f6c 6f73 735f 6175 675f 6677   nll_loss_aug_fw
+00018be0: 6428 0a20 2020 2069 6e70 7574 3a20 5072  d(.    input: Pr
+00018bf0: 6f78 792c 0a20 2020 2074 6172 6765 743a  oxy,.    target:
+00018c00: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
+00018c10: 6874 3a20 4e6f 6e65 207c 2050 726f 7879  ht: None | Proxy
+00018c20: 2c0a 2020 2020 6967 6e6f 7265 5f69 6e64  ,.    ignore_ind
+00018c30: 6578 3a20 696e 742c 0a20 2020 2072 6564  ex: int,.    red
+00018c40: 7563 7469 6f6e 3a20 7374 722c 0a29 202d  uction: str,.) -
+00018c50: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
+00018c60: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+00018c70: 6820 696d 706f 7274 205f 6e6c 6c5f 6c6f  h import _nll_lo
+00018c80: 7373 5f68 656c 7065 720a 0a20 2020 2070  ss_helper..    p
+00018c90: 7269 6d61 6c2c 2074 6f74 616c 5f77 6569  rimal, total_wei
+00018ca0: 6768 7420 3d20 5f6e 6c6c 5f6c 6f73 735f  ght = _nll_loss_
+00018cb0: 6865 6c70 6572 280a 2020 2020 2020 2020  helper(.        
+00018cc0: 696e 7075 742c 0a20 2020 2020 2020 2074  input,.        t
+00018cd0: 6172 6765 742c 0a20 2020 2020 2020 2077  arget,.        w
+00018ce0: 6569 6768 742c 0a20 2020 2020 2020 2069  eight,.        i
+00018cf0: 676e 6f72 655f 696e 6465 782c 0a20 2020  gnore_index,.   
+00018d00: 2020 2020 2072 6564 7563 7469 6f6e 2c0a       reduction,.
+00018d10: 2020 2020 290a 2020 2020 7265 7369 6475      ).    residu
+00018d20: 616c 7320 3d20 2869 6e70 7574 2c20 7461  als = (input, ta
+00018d30: 7267 6574 2c20 7765 6967 6874 2c20 7265  rget, weight, re
+00018d40: 6475 6374 696f 6e2c 2069 676e 6f72 655f  duction, ignore_
+00018d50: 696e 6465 782c 2074 6f74 616c 5f77 6569  index, total_wei
+00018d60: 6768 7429 0a20 2020 2072 6574 7572 6e20  ght).    return 
+00018d70: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00018d80: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00018d90: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00018da0: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
+00018db0: 6f6e 616c 2e6e 6c6c 5f6c 6f73 7322 290a  onal.nll_loss").
+00018dc0: 6465 6620 6e6c 6c5f 6c6f 7373 5f62 6163  def nll_loss_bac
+00018dd0: 6b77 6172 6428 696e 7075 742c 2074 6172  kward(input, tar
+00018de0: 6765 742c 2077 6569 6768 742c 2072 6564  get, weight, red
+00018df0: 7563 7469 6f6e 2c20 6967 6e6f 7265 5f69  uction, ignore_i
+00018e00: 6e64 6578 2c20 746f 7461 6c5f 7765 6967  ndex, total_weig
+00018e10: 6874 2c20 6729 3a0a 2020 2020 6672 6f6d  ht, g):.    from
+00018e20: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00018e30: 6d70 6f72 7420 6e6c 6c5f 6c6f 7373 5f62  mport nll_loss_b
+00018e40: 6163 6b77 6172 640a 0a20 2020 2067 696e  ackward..    gin
+00018e50: 7075 7420 3d20 6e6c 6c5f 6c6f 7373 5f62  put = nll_loss_b
+00018e60: 6163 6b77 6172 6428 672c 2069 6e70 7574  ackward(g, input
+00018e70: 2c20 7461 7267 6574 2c20 7765 6967 6874  , target, weight
+00018e80: 2c20 7265 6475 6374 696f 6e2c 2069 676e  , reduction, ign
+00018e90: 6f72 655f 696e 6465 782c 2074 6f74 616c  ore_index, total
+00018ea0: 5f77 6569 6768 7429 0a20 2020 2072 6574  _weight).    ret
+00018eb0: 7572 6e20 6769 6e70 7574 2c20 2a28 284e  urn ginput, *((N
+00018ec0: 6f6e 652c 2920 2a20 3429 0a0a 0a40 7265  one,) * 4)...@re
+00018ed0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+00018ee0: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
+00018ef0: 7370 6c69 7422 290a 6465 6620 7370 6c69  split").def spli
+00018f00: 745f 6175 675f 6677 6428 613a 2054 656e  t_aug_fwd(a: Ten
+00018f10: 736f 7250 726f 7879 2c20 7370 6c69 745f  sorProxy, split_
+00018f20: 7369 7a65 5f6f 725f 7365 6374 696f 6e73  size_or_sections
+00018f30: 3a20 696e 7420 7c20 5365 7175 656e 6365  : int | Sequence
+00018f40: 5b69 6e74 5d2c 2064 696d 3a20 696e 7420  [int], dim: int 
+00018f50: 3d20 3029 202d 3e20 564a 5044 7561 6c3a  = 0) -> VJPDual:
+00018f60: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00018f70: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
+00018f80: 706c 6974 0a0a 2020 2020 7072 696d 616c  plit..    primal
+00018f90: 203d 2073 706c 6974 2861 2c20 7370 6c69   = split(a, spli
+00018fa0: 745f 7369 7a65 5f6f 725f 7365 6374 696f  t_size_or_sectio
+00018fb0: 6e73 2c20 6469 6d29 0a20 2020 2072 6573  ns, dim).    res
+00018fc0: 6964 7561 6c73 203d 2028 6469 6d2c 290a  iduals = (dim,).
+00018fd0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00018fe0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00018ff0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00019000: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+00019010: 682e 7370 6c69 7422 290a 6465 6620 7370  h.split").def sp
+00019020: 6c69 745f 6261 636b 7761 7264 2864 696d  lit_backward(dim
+00019030: 2c20 2a67 7261 6473 293a 0a20 2020 2066  , *grads):.    f
+00019040: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+00019050: 6820 696d 706f 7274 2063 6174 0a0a 2020  h import cat..  
+00019060: 2020 7265 7475 726e 2063 6174 2867 7261    return cat(gra
+00019070: 6473 2c20 6469 6d29 0a0a 0a40 7265 6769  ds, dim)...@regi
+00019080: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+00019090: 6f72 7761 7264 2822 746f 7263 682e 6e6e  orward("torch.nn
+000190a0: 2e66 756e 6374 696f 6e61 6c2e 656d 6265  .functional.embe
+000190b0: 6464 696e 6722 290a 6465 6620 656d 6265  dding").def embe
+000190c0: 6464 696e 675f 6175 675f 6677 6428 0a20  dding_aug_fwd(. 
+000190d0: 2020 2061 3a20 5072 6f78 792c 0a20 2020     a: Proxy,.   
+000190e0: 2077 6569 6768 743a 2050 726f 7879 2c0a   weight: Proxy,.
+000190f0: 2020 2020 7061 6464 696e 675f 6964 783a      padding_idx:
+00019100: 2069 6e74 207c 204e 6f6e 652c 0a20 2020   int | None,.   
+00019110: 206d 6178 5f6e 6f72 6d3a 2066 6c6f 6174   max_norm: float
+00019120: 207c 204e 6f6e 652c 0a20 2020 206e 6f72   | None,.    nor
+00019130: 6d5f 7479 7065 3a20 666c 6f61 742c 0a20  m_type: float,. 
+00019140: 2020 2073 6361 6c65 5f67 7261 645f 6279     scale_grad_by
+00019150: 5f66 7265 713a 2062 6f6f 6c2c 0a20 2020  _freq: bool,.   
+00019160: 2073 7061 7273 653a 2062 6f6f 6c2c 0a29   sparse: bool,.)
+00019170: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
+00019180: 2066 726f 6d20 7468 756e 6465 722e 746f   from thunder.to
+00019190: 7263 6820 696d 706f 7274 2065 6d62 6564  rch import embed
+000191a0: 6469 6e67 0a0a 2020 2020 7072 696d 616c  ding..    primal
+000191b0: 203d 2065 6d62 6564 6469 6e67 280a 2020   = embedding(.  
+000191c0: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
+000191d0: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
+000191e0: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
+000191f0: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
+00019200: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
+00019210: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
+00019220: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
+00019230: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
+00019240: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
+00019250: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+00019260: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
+00019270: 7370 6172 7365 2c0a 2020 2020 290a 2020  sparse,.    ).  
+00019280: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
+00019290: 2c20 7765 6967 6874 2e73 6861 7065 5b30  , weight.shape[0
+000192a0: 5d2c 2070 6164 6469 6e67 5f69 6478 2c20  ], padding_idx, 
+000192b0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+000192c0: 6571 2c20 7370 6172 7365 290a 2020 2020  eq, sparse).    
+000192d0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
+000192e0: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
+000192f0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
+00019300: 636b 7761 7264 2822 746f 7263 682e 6e6e  ckward("torch.nn
+00019310: 2e66 756e 6374 696f 6e61 6c2e 656d 6265  .functional.embe
+00019320: 6464 696e 6722 290a 6465 6620 656d 6265  dding").def embe
+00019330: 6464 696e 675f 6261 636b 7761 7264 2861  dding_backward(a
+00019340: 2c20 6e75 6d5f 7765 6967 6874 732c 2070  , num_weights, p
+00019350: 6164 6469 6e67 5f69 6478 2c20 7363 616c  adding_idx, scal
+00019360: 655f 6772 6164 5f62 795f 6672 6571 2c20  e_grad_by_freq, 
+00019370: 7370 6172 7365 2c20 6729 3a0a 2020 2020  sparse, g):.    
+00019380: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00019390: 6368 2069 6d70 6f72 7420 656d 6265 6464  ch import embedd
+000193a0: 696e 675f 6261 636b 7761 7264 0a0a 2020  ing_backward..  
+000193b0: 2020 7061 6464 696e 675f 6964 7820 3d20    padding_idx = 
+000193c0: 2d31 2069 6620 7061 6464 696e 675f 6964  -1 if padding_id
+000193d0: 7820 6973 204e 6f6e 6520 656c 7365 2070  x is None else p
+000193e0: 6164 6469 6e67 5f69 6478 0a20 2020 2067  adding_idx.    g
+000193f0: 7765 6967 6874 203d 2065 6d62 6564 6469  weight = embeddi
+00019400: 6e67 5f62 6163 6b77 6172 6428 672c 2061  ng_backward(g, a
+00019410: 2c20 6e75 6d5f 7765 6967 6874 732c 2070  , num_weights, p
+00019420: 6164 6469 6e67 5f69 6478 2c20 7363 616c  adding_idx, scal
+00019430: 655f 6772 6164 5f62 795f 6672 6571 2c20  e_grad_by_freq, 
+00019440: 7370 6172 7365 290a 2020 2020 7265 7475  sparse).    retu
+00019450: 726e 2067 7765 6967 6874 0a0a 0a40 7265  rn gweight...@re
+00019460: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+00019470: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
+00019480: 6375 6d73 756d 2229 0a64 6566 2063 756d  cumsum").def cum
+00019490: 7375 6d5f 6175 675f 6677 6428 613a 2050  sum_aug_fwd(a: P
+000194a0: 726f 7879 2c20 6469 6d3a 2069 6e74 2c20  roxy, dim: int, 
+000194b0: 2a2c 2064 7479 7065 3a20 4e6f 6e65 207c  *, dtype: None |
+000194c0: 2064 7479 7065 732e 6474 7970 6520 3d20   dtypes.dtype = 
+000194d0: 4e6f 6e65 2920 2d3e 2056 4a50 4475 616c  None) -> VJPDual
+000194e0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
+000194f0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
+00019500: 6375 6d73 756d 0a0a 2020 2020 7072 696d  cumsum..    prim
+00019510: 616c 203d 2063 756d 7375 6d28 612c 2064  al = cumsum(a, d
+00019520: 696d 2c20 6474 7970 653d 6474 7970 6529  im, dtype=dtype)
+00019530: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+00019540: 2028 0a20 2020 2020 2020 2061 2e64 7479   (.        a.dty
+00019550: 7065 2c0a 2020 2020 2020 2020 6469 6d2c  pe,.        dim,
+00019560: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+00019570: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+00019580: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+00019590: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+000195a0: 6428 2274 6f72 6368 2e63 756d 7375 6d22  d("torch.cumsum"
+000195b0: 290a 6465 6620 6375 6d73 756d 5f62 6163  ).def cumsum_bac
+000195c0: 6b77 6172 6428 615f 6474 7970 652c 2064  kward(a_dtype, d
+000195d0: 696d 2c20 6729 3a0a 2020 2020 6720 3d20  im, g):.    g = 
+000195e0: 672e 746f 2861 5f64 7479 7065 290a 2020  g.to(a_dtype).  
+000195f0: 2020 6966 2067 2e6e 756d 656c 203c 3d20    if g.numel <= 
+00019600: 3120 6f72 2067 2e73 6861 7065 5b64 696d  1 or g.shape[dim
+00019610: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
+00019620: 7265 7475 726e 2067 0a20 2020 2072 6574  return g.    ret
+00019630: 7572 6e20 672e 666c 6970 2864 696d 292e  urn g.flip(dim).
+00019640: 6375 6d73 756d 2864 696d 292e 666c 6970  cumsum(dim).flip
+00019650: 2864 696d 290a 0a0a 4072 6567 6973 7465  (dim)...@registe
+00019660: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00019670: 6172 6428 2274 6f72 6368 2e73 6f66 746d  ard("torch.softm
+00019680: 6178 2229 0a64 6566 2073 6f66 746d 6178  ax").def softmax
+00019690: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
+000196a0: 792c 2064 696d 3a20 696e 742c 2064 7479  y, dim: int, dty
+000196b0: 7065 3a20 6474 7970 6573 2e64 7479 7065  pe: dtypes.dtype
+000196c0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+000196d0: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
+000196e0: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+000196f0: 6368 2069 6d70 6f72 7420 736f 6674 6d61  ch import softma
+00019700: 780a 0a20 2020 2070 7269 6d61 6c20 3d20  x..    primal = 
+00019710: 736f 6674 6d61 7828 612c 2064 696d 2c20  softmax(a, dim, 
+00019720: 6474 7970 653d 6474 7970 6529 0a20 2020  dtype=dtype).   
+00019730: 2072 6573 6964 7561 6c73 203d 2028 7072   residuals = (pr
+00019740: 696d 616c 2c20 6469 6d29 0a20 2020 2072  imal, dim).    r
+00019750: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
+00019760: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
+00019770: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+00019780: 6b77 6172 6428 2274 6f72 6368 2e73 6f66  kward("torch.sof
+00019790: 746d 6178 2229 0a64 6566 2073 6f66 746d  tmax").def softm
+000197a0: 6178 5f62 6163 6b77 6172 6428 7072 696d  ax_backward(prim
+000197b0: 616c 2c20 6469 6d2c 2067 293a 0a20 2020  al, dim, g):.   
+000197c0: 2072 6574 7572 6e20 7072 696d 616c 202a   return primal *
+000197d0: 2028 6720 2d20 2870 7269 6d61 6c20 2a20   (g - (primal * 
+000197e0: 6729 2e73 756d 2864 696d 2c20 6b65 6570  g).sum(dim, keep
+000197f0: 6469 6d3d 5472 7565 2929 0a0a 0a64 6566  dim=True))...def
+00019800: 2069 7465 725f 626f 756e 645f 7379 6d62   iter_bound_symb
+00019810: 6f6c 7328 626f 756e 645f 7379 6d62 6f6c  ols(bound_symbol
+00019820: 7329 3a0a 2020 2020 2222 2249 7465 7261  s):.    """Itera
+00019830: 7465 206f 7665 7220 626f 756e 6420 7379  te over bound sy
+00019840: 6d62 6f6c 732c 2073 6b69 7070 696e 6720  mbols, skipping 
+00019850: 7379 6d62 6f6c 7320 7468 6174 2061 7265  symbols that are
+00019860: 206e 6f74 2073 7570 706f 7274 6564 2062   not supported b
+00019870: 790a 2020 2020 7468 6520 7472 616e 7366  y.    the transf
+00019880: 6f72 6d73 2069 6e66 7261 7374 7275 6374  orms infrastruct
+00019890: 7572 652e 0a0a 2020 2020 4172 6773 3a0a  ure...    Args:.
+000198a0: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
+000198b0: 6d62 6f6c 7320 284c 6973 745b 426f 756e  mbols (List[Boun
+000198c0: 6453 796d 626f 6c5d 293a 204c 6973 7420  dSymbol]): List 
+000198d0: 6f66 2062 6f75 6e64 2073 796d 626f 6c73  of bound symbols
+000198e0: 0a0a 2020 2020 5969 656c 6473 3a0a 2020  ..    Yields:.  
+000198f0: 2020 2020 2020 426f 756e 6453 796d 626f        BoundSymbo
+00019900: 6c3a 2042 6f75 6e64 2073 796d 626f 6c73  l: Bound symbols
+00019910: 2074 6861 7420 6172 6520 7375 7070 6f72   that are suppor
+00019920: 7465 6420 6279 2074 6865 2074 7261 6e73  ted by the trans
+00019930: 666f 726d 730a 2020 2020 2020 2020 696e  forms.        in
+00019940: 6672 6173 7472 7563 7475 7265 0a20 2020  frastructure.   
+00019950: 2022 2222 0a20 2020 2066 6f72 2073 796d   """.    for sym
+00019960: 626f 6c20 696e 2062 6f75 6e64 5f73 796d  bol in bound_sym
+00019970: 626f 6c73 3a0a 2020 2020 2020 2020 6966  bols:.        if
+00019980: 2073 796d 626f 6c2e 7379 6d2e 6964 2069   symbol.sym.id i
+00019990: 6e20 7472 616e 7366 6f72 6d5f 736b 6970  n transform_skip
+000199a0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
+000199b0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+000199c0: 2020 2020 656c 6966 2073 796d 626f 6c2e      elif symbol.
+000199d0: 6f75 7470 7574 2069 7320 4e6f 6e65 3a0a  output is None:.
+000199e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000199f0: 696e 7565 0a20 2020 2020 2020 2065 6c73  inue.        els
+00019a00: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
+00019a10: 6965 6c64 2073 796d 626f 6c0a 0a0a 6465  ield symbol...de
+00019a20: 6620 6465 636f 6e73 7472 7563 745f 666f  f deconstruct_fo
+00019a30: 7277 6172 645f 656e 765f 666f 725f 6261  rward_env_for_ba
+00019a40: 636b 7761 7264 2874 7261 6365 2c20 656e  ckward(trace, en
+00019a50: 7629 3a0a 2020 2020 2320 4e6f 7465 205b  v):.    # Note [
+00019a60: 5361 7669 6e67 2074 6865 2066 6f72 7761  Saving the forwa
+00019a70: 7264 2065 6e76 6972 6f6e 6d65 6e74 2069  rd environment i
+00019a80: 6e20 7468 6520 6261 636b 7761 7264 2072  n the backward r
+00019a90: 756c 655d 0a20 2020 2023 2057 6520 6361  ule].    # We ca
+00019aa0: 6e6e 6f74 2073 6176 6520 7468 6520 7472  nnot save the tr
+00019ab0: 6163 6520 6f62 6a65 6374 2069 6e20 7468  ace object in th
+00019ac0: 6520 7265 7369 6475 616c 7320 6265 6361  e residuals beca
+00019ad0: 7573 6520 6578 6563 7574 6f72 7320 6d61  use executors ma
+00019ae0: 7920 6e6f 740a 2020 2020 2320 6265 2061  y not.    # be a
+00019af0: 626c 6520 746f 2072 6574 7572 6e20 6974  ble to return it
+00019b00: 2066 6f72 2074 6865 2073 706c 6974 7465   for the splitte
+00019b10: 6420 666f 7277 6172 642f 6261 636b 7761  d forward/backwa
+00019b20: 7264 2070 6173 7365 732e 2049 6e73 7465  rd passes. Inste
+00019b30: 6164 2c20 7765 0a20 2020 2023 2073 6176  ad, we.    # sav
+00019b40: 6520 6172 6773 2061 6e64 206b 7761 7267  e args and kwarg
+00019b50: 7320 6f66 2074 6865 206f 7269 6769 6e61  s of the origina
+00019b60: 6c20 6675 6e63 7469 6f6e 2063 616c 6c20  l function call 
+00019b70: 616e 6420 7265 636f 6e73 7472 7563 7420  and reconstruct 
+00019b80: 7468 650a 2020 2020 2320 7472 6163 6520  the.    # trace 
+00019b90: 6f62 6a65 6374 2061 6e64 2069 7473 2065  object and its e
+00019ba0: 6e76 6972 6f6e 6d65 6e74 2064 6963 7420  nvironment dict 
+00019bb0: 696e 2074 6865 2062 6163 6b77 6172 6420  in the backward 
+00019bc0: 7275 6c65 2e20 4865 7265 2077 6520 7265  rule. Here we re
+00019bd0: 6c79 0a20 2020 2023 206f 6e20 7468 6520  ly.    # on the 
+00019be0: 6661 6374 2074 6861 7420 7468 6520 6f72  fact that the or
+00019bf0: 6465 7220 6f66 2074 6865 2073 796d 626f  der of the symbo
+00019c00: 6c73 2069 6e20 7468 6520 7472 6163 6520  ls in the trace 
+00019c10: 6973 2064 6574 6572 6d69 6e69 7374 6963  is deterministic
+00019c20: 0a20 2020 2023 2061 6e64 2061 6c77 6179  .    # and alway
+00019c30: 7320 7468 6520 7361 6d65 2066 6f72 2074  s the same for t
+00019c40: 6865 2073 616d 6520 6675 6e63 7469 6f6e  he same function
+00019c50: 2063 616c 6c20 616e 6420 7468 6520 7361   call and the sa
+00019c60: 6d65 2073 6574 206f 660a 2020 2020 2320  me set of.    # 
+00019c70: 6172 6775 6d65 6e74 732e 2053 6565 2074  arguments. See t
+00019c80: 6573 745f 6772 6164 2e70 793a 7465 7374  est_grad.py:test
+00019c90: 5f74 6f72 6368 5f61 7574 6f67 7261 645f  _torch_autograd_
+00019ca0: 6675 6e63 7469 6f6e 2066 6f72 2061 6e20  function for an 
+00019cb0: 6578 616d 706c 650a 2020 2020 2320 7768  example.    # wh
+00019cc0: 6572 6520 7468 6973 2069 7320 7465 7374  ere this is test
+00019cd0: 6564 2e0a 2020 2020 626f 756e 645f 7379  ed..    bound_sy
+00019ce0: 6d62 6f6c 7320 3d20 6974 6572 5f62 6f75  mbols = iter_bou
+00019cf0: 6e64 5f73 796d 626f 6c73 2874 7261 6365  nd_symbols(trace
+00019d00: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
+00019d10: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
+00019d20: 636b 7761 7264 203d 2074 7570 6c65 2865  ckward = tuple(e
+00019d30: 6e76 5b73 6571 7565 6e63 6966 7928 7379  nv[sequencify(sy
+00019d40: 6d62 6f6c 2e6f 7574 7075 7429 5b30 5d2e  mbol.output)[0].
+00019d50: 6e61 6d65 5d2e 7265 7369 6475 616c 7320  name].residuals 
+00019d60: 666f 7220 7379 6d62 6f6c 2069 6e20 626f  for symbol in bo
+00019d70: 756e 645f 7379 6d62 6f6c 7329 0a20 2020  und_symbols).   
+00019d80: 2072 6574 7572 6e20 7361 7665 645f 666f   return saved_fo
+00019d90: 725f 6261 636b 7761 7264 0a0a 0a64 6566  r_backward...def
+00019da0: 2072 6563 6f6e 7374 7275 6374 5f66 6f72   reconstruct_for
+00019db0: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
+00019dc0: 6b77 6172 6428 7472 6163 652c 2073 6176  kward(trace, sav
+00019dd0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+00019de0: 3a0a 2020 2020 626f 756e 645f 7379 6d62  :.    bound_symb
+00019df0: 6f6c 7320 3d20 6974 6572 5f62 6f75 6e64  ols = iter_bound
+00019e00: 5f73 796d 626f 6c73 2874 7261 6365 2e62  _symbols(trace.b
+00019e10: 6f75 6e64 5f73 796d 626f 6c73 290a 0a20  ound_symbols).. 
+00019e20: 2020 2072 6563 6f6e 7374 7275 6374 6564     reconstructed
+00019e30: 5f65 6e76 203d 207b 7d0a 0a20 2020 2066  _env = {}..    f
+00019e40: 6f72 2069 6478 2c20 7379 6d20 696e 2065  or idx, sym in e
+00019e50: 6e75 6d65 7261 7465 2862 6f75 6e64 5f73  numerate(bound_s
+00019e60: 796d 626f 6c73 293a 0a20 2020 2020 2020  ymbols):.       
+00019e70: 206b 203d 2073 6571 7565 6e63 6966 7928   k = sequencify(
+00019e80: 7379 6d2e 6f75 7470 7574 295b 305d 2e6e  sym.output)[0].n
+00019e90: 616d 650a 2020 2020 2020 2020 7620 3d20  ame.        v = 
+00019ea0: 564a 5044 7561 6c28 4e6f 6e65 2c20 7361  VJPDual(None, sa
+00019eb0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00019ec0: 5b69 6478 5d29 0a20 2020 2020 2020 2072  [idx]).        r
+00019ed0: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
+00019ee0: 5b6b 5d20 3d20 760a 0a20 2020 2072 6574  [k] = v..    ret
+00019ef0: 7572 6e20 7265 636f 6e73 7472 7563 7465  urn reconstructe
+00019f00: 645f 656e 760a 0a0a 6465 6620 6465 636f  d_env...def deco
+00019f10: 6d70 6f73 6564 5f66 6e5f 6175 675f 6677  mposed_fn_aug_fw
+00019f20: 645f 7275 6c65 282a 6172 6773 2c20 6465  d_rule(*args, de
+00019f30: 636f 6d70 6f73 6564 5f66 6e2c 202a 2a6b  composed_fn, **k
+00019f40: 7761 7267 7329 3a0a 2020 2020 2222 2241  wargs):.    """A
+00019f50: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
+00019f60: 2072 756c 6520 666f 7220 636f 6d70 6f73   rule for compos
+00019f70: 6974 6520 6675 6e63 7469 6f6e 7320 696d  ite functions im
+00019f80: 706c 656d 656e 7465 6420 696e 2074 6572  plemented in ter
+00019f90: 6d73 206f 6620 6f74 6865 7220 6675 6e63  ms of other func
+00019fa0: 7469 6f6e 7320 7468 6174 2061 7265 0a20  tions that are. 
+00019fb0: 2020 2073 7570 706f 7365 6420 746f 2062     supposed to b
+00019fc0: 6520 7375 7070 6f72 7465 6420 6279 2074  e supported by t
+00019fd0: 6865 2056 4a50 2069 6e66 7261 7374 7275  he VJP infrastru
+00019fe0: 6374 7572 652e 0a0a 2020 2020 4172 6773  cture...    Args
+00019ff0: 3a0a 2020 2020 2020 2020 6465 636f 6d70  :.        decomp
+0001a000: 6f73 6564 5f66 6e20 2843 616c 6c61 626c  osed_fn (Callabl
+0001a010: 6529 3a20 6465 636f 6d70 6f73 6564 2076  e): decomposed v
+0001a020: 6572 7369 6f6e 206f 6620 7468 6520 6675  ersion of the fu
+0001a030: 6e63 7469 6f6e 0a0a 2020 2020 5265 7475  nction..    Retu
+0001a040: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+0001a050: 6c61 626c 653a 2041 7567 6d65 6e74 6564  lable: Augmented
+0001a060: 2066 6f72 7761 7264 2072 756c 6520 666f   forward rule fo
+0001a070: 7220 7468 6520 636f 6d70 6f73 6974 6520  r the composite 
+0001a080: 6675 6e63 7469 6f6e 0a20 2020 2022 2222  function.    """
+0001a090: 0a20 2020 2074 7261 6365 203d 2063 6f6e  .    trace = con
+0001a0a0: 7374 7275 6374 5f74 7261 6365 2829 2864  struct_trace()(d
+0001a0b0: 6563 6f6d 706f 7365 645f 666e 2c20 2a61  ecomposed_fn, *a
+0001a0c0: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+0001a0d0: 2020 2074 7261 6365 203d 2075 6e77 7261     trace = unwra
+0001a0e0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
+0001a0f0: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
+0001a100: 0a20 2020 2023 2054 6865 7265 206d 6179  .    # There may
+0001a110: 2062 6520 6120 6465 6164 206e 6f64 6520   be a dead node 
+0001a120: 6c69 6b65 2022 5f20 3d20 7072 696d 732e  like "_ = prims.
+0001a130: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
+0001a140: 7479 7065 2830 2c20 666c 6f61 7429 220a  type(0, float)".
+0001a150: 2020 2020 2320 696e 2074 6865 2074 7261      # in the tra
+0001a160: 6365 2e20 5765 206e 6565 6420 746f 2072  ce. We need to r
+0001a170: 656d 6f76 6520 6974 2062 6566 6f72 6520  emove it before 
+0001a180: 7765 2063 616e 2075 7365 2074 6865 2074  we can use the t
+0001a190: 7261 6365 2066 6f72 0a20 2020 2023 2061  race for.    # a
+0001a1a0: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001a1b0: 5f70 6173 732e 0a20 2020 2074 7261 6365  _pass..    trace
+0001a1c0: 203d 2064 6365 2874 7261 6365 290a 2020   = dce(trace).  
+0001a1d0: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
+0001a1e0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001a1f0: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
+0001a200: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
+0001a210: 7267 7329 0a20 2020 2073 6176 6564 5f66  rgs).    saved_f
+0001a220: 6f72 5f62 6163 6b77 6172 6420 3d20 6465  or_backward = de
+0001a230: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
+0001a240: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
+0001a250: 7264 2874 7261 6365 2c20 656e 7629 0a20  rd(trace, env). 
+0001a260: 2020 2023 2053 7461 7469 6320 6361 6368     # Static cach
+0001a270: 696e 6720 646f 6573 206e 6f74 2077 6974  ing does not wit
+0001a280: 6820 7769 7468 206b 7761 7267 7320 6469  h with kwargs di
+0001a290: 6374 732c 2073 6f20 7765 2772 6520 636f  cts, so we're co
+0001a2a0: 6e76 6572 7469 6e67 2074 6865 6d0a 2020  nverting them.  
+0001a2b0: 2020 2320 746f 204e 6f6e 6520 666f 7220    # to None for 
+0001a2c0: 6e6f 7720 7768 656e 2070 6f73 7369 626c  now when possibl
+0001a2d0: 652e 0a20 2020 206b 7761 7267 7320 3d20  e..    kwargs = 
+0001a2e0: 4e6f 6e65 2069 6620 6e6f 7420 6b77 6172  None if not kwar
+0001a2f0: 6773 2065 6c73 6520 6b77 6172 6773 0a20  gs else kwargs. 
+0001a300: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
+0001a310: 6172 6773 2c20 6b77 6172 6773 2c20 7361  args, kwargs, sa
+0001a320: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001a330: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+0001a340: 4475 616c 2872 6573 756c 742c 2072 6573  Dual(result, res
+0001a350: 6964 7561 6c73 290a 0a0a 6465 6620 6465  iduals)...def de
+0001a360: 636f 6d70 6f73 6564 5f66 6e5f 6261 636b  composed_fn_back
+0001a370: 7761 7264 5f72 756c 6528 6465 636f 6d70  ward_rule(decomp
+0001a380: 6f73 6564 5f66 6e2c 2061 7267 732c 206b  osed_fn, args, k
+0001a390: 7761 7267 732c 2073 6176 6564 5f66 6f72  wargs, saved_for
+0001a3a0: 5f62 6163 6b77 6172 642c 202a 6772 6164  _backward, *grad
+0001a3b0: 7329 3a0a 2020 2020 6b77 6172 6773 203d  s):.    kwargs =
+0001a3c0: 207b 7d20 6966 206b 7761 7267 7320 6973   {} if kwargs is
+0001a3d0: 204e 6f6e 6520 656c 7365 206b 7761 7267   None else kwarg
+0001a3e0: 730a 2020 2020 7472 6163 6520 3d20 636f  s.    trace = co
+0001a3f0: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+0001a400: 6465 636f 6d70 6f73 6564 5f66 6e2c 202a  decomposed_fn, *
+0001a410: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+0001a420: 2020 2020 7472 6163 6520 3d20 756e 7772      trace = unwr
+0001a430: 6170 5f6f 6e65 5f6c 6576 656c 5f6f 665f  ap_one_level_of_
+0001a440: 7375 6273 796d 626f 6c73 2874 7261 6365  subsymbols(trace
+0001a450: 290a 2020 2020 7472 6163 6520 3d20 6463  ).    trace = dc
+0001a460: 6528 7472 6163 6529 0a20 2020 2023 2062  e(trace).    # b
+0001a470: 6f75 6e64 5f73 796d 626f 6c73 203d 2069  ound_symbols = i
+0001a480: 7465 725f 626f 756e 645f 7379 6d62 6f6c  ter_bound_symbol
+0001a490: 7328 7472 6163 652e 626f 756e 645f 7379  s(trace.bound_sy
+0001a4a0: 6d62 6f6c 7329 0a20 2020 2023 2072 6563  mbols).    # rec
+0001a4b0: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
+0001a4c0: 207b 0a20 2020 2023 2020 2020 2073 6571   {.    #     seq
+0001a4d0: 7565 6e63 6966 7928 7379 6d62 6f6c 2e6f  uencify(symbol.o
+0001a4e0: 7574 7075 7429 5b30 5d2e 6e61 6d65 3a20  utput)[0].name: 
+0001a4f0: 564a 5044 7561 6c28 4e6f 6e65 2c20 7361  VJPDual(None, sa
+0001a500: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001a510: 5b69 5d29 0a20 2020 2023 2020 2020 2066  [i]).    #     f
+0001a520: 6f72 2069 2c20 7379 6d62 6f6c 2069 6e20  or i, symbol in 
+0001a530: 656e 756d 6572 6174 6528 626f 756e 645f  enumerate(bound_
+0001a540: 7379 6d62 6f6c 7329 0a20 2020 2023 207d  symbols).    # }
+0001a550: 0a20 2020 2072 6563 6f6e 7374 7275 6374  .    reconstruct
+0001a560: 6564 5f65 6e76 203d 2072 6563 6f6e 7374  ed_env = reconst
+0001a570: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
+0001a580: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
+0001a590: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
+0001a5a0: 6163 6b77 6172 6429 0a20 2020 2072 6573  ackward).    res
+0001a5b0: 756c 7420 3d20 6261 636b 7761 7264 5f70  ult = backward_p
+0001a5c0: 6173 7328 7265 636f 6e73 7472 7563 7465  ass(reconstructe
+0001a5d0: 645f 656e 762c 2074 7261 6365 2c20 6772  d_env, trace, gr
+0001a5e0: 6164 7329 0a20 2020 2069 6620 6c65 6e28  ads).    if len(
+0001a5f0: 6172 6773 2920 3d3d 2031 3a0a 2020 2020  args) == 1:.    
+0001a600: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001a610: 745b 305d 0a20 2020 2023 2042 6163 6b77  t[0].    # Backw
+0001a620: 6172 6420 7061 7373 206d 6967 6874 2072  ard pass might r
+0001a630: 6574 7572 6e20 6120 6469 6374 2077 6974  eturn a dict wit
+0001a640: 6820 6772 6164 7320 6275 7420 6375 7272  h grads but curr
+0001a650: 656e 7420 696e 7465 7266 6163 6520 6f66  ent interface of
+0001a660: 0a20 2020 2023 2062 6163 6b77 6172 6420  .    # backward 
+0001a670: 7275 6c65 2064 6f65 7320 6e6f 7420 7375  rule does not su
+0001a680: 7070 6f72 7420 6974 2e20 536f 2077 6520  pport it. So we 
+0001a690: 6a75 7374 2064 726f 7020 6974 2066 6f72  just drop it for
+0001a6a0: 206e 6f77 2e0a 2020 2020 656c 6966 2069   now..    elif i
+0001a6b0: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
+0001a6c0: 5b2d 315d 2c20 6469 6374 293a 0a20 2020  [-1], dict):.   
+0001a6d0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+0001a6e0: 6c74 5b3a 2d31 5d0a 2020 2020 7265 7475  lt[:-1].    retu
+0001a6f0: 726e 2072 6573 756c 740a 0a0a 4072 6567  rn result...@reg
+0001a700: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+0001a710: 666f 7277 6172 6428 2274 6f72 6368 2e54  forward("torch.T
+0001a720: 656e 736f 722e 636f 6e74 6967 756f 7573  ensor.contiguous
+0001a730: 2229 0a40 7265 6769 7374 6572 5f61 7567  ").@register_aug
+0001a740: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
+0001a750: 746f 7263 682e 636f 6e74 6967 756f 7573  torch.contiguous
+0001a760: 2229 0a64 6566 2063 6f6e 7469 6775 6f75  ").def contiguou
+0001a770: 735f 6175 675f 6677 6428 783a 2054 656e  s_aug_fwd(x: Ten
+0001a780: 736f 7250 726f 7879 2c20 2f2c 202a 2c20  sorProxy, /, *, 
+0001a790: 6d65 6d6f 7279 5f66 6f72 6d61 743a 2074  memory_format: t
+0001a7a0: 6f72 6368 2e6d 656d 6f72 795f 666f 726d  orch.memory_form
+0001a7b0: 6174 203d 2074 6f72 6368 2e63 6f6e 7469  at = torch.conti
+0001a7c0: 6775 6f75 735f 666f 726d 6174 2920 2d3e  guous_format) ->
+0001a7d0: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+0001a7e0: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+0001a7f0: 2069 6d70 6f72 7420 636f 6e74 6967 756f   import contiguo
+0001a800: 7573 0a0a 2020 2020 7265 7475 726e 2056  us..    return V
+0001a810: 4a50 4475 616c 2863 6f6e 7469 6775 6f75  JPDual(contiguou
+0001a820: 7328 782c 206d 656d 6f72 795f 666f 726d  s(x, memory_form
+0001a830: 6174 3d6d 656d 6f72 795f 666f 726d 6174  at=memory_format
+0001a840: 292c 2074 7570 6c65 2829 290a 0a0a 4072  ), tuple())...@r
+0001a850: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+0001a860: 2822 746f 7263 682e 5465 6e73 6f72 2e63  ("torch.Tensor.c
+0001a870: 6f6e 7469 6775 6f75 7322 290a 4072 6567  ontiguous").@reg
+0001a880: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+0001a890: 746f 7263 682e 636f 6e74 6967 756f 7573  torch.contiguous
+0001a8a0: 2229 0a64 6566 2063 6f6e 7469 6775 6f75  ").def contiguou
+0001a8b0: 735f 6261 636b 7761 7264 282a 7265 7369  s_backward(*resi
+0001a8c0: 6475 616c 735f 616e 645f 6772 6164 2920  duals_and_grad) 
+0001a8d0: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
+0001a8e0: 2020 2020 2320 5265 7369 6475 616c 7320      # Residuals 
+0001a8f0: 6973 206e 6f74 2065 6d70 7479 2062 6563  is not empty bec
+0001a900: 6175 7365 2063 6f6e 7469 6775 6f75 7320  ause contiguous 
+0001a910: 7379 6d62 6f6c 2068 6173 2074 6865 2073  symbol has the s
+0001a920: 616d 6520 6f75 7470 7574 2061 7320 6974  ame output as it
+0001a930: 7320 696e 7075 740a 2020 2020 6720 3d20  s input.    g = 
+0001a940: 7265 7369 6475 616c 735f 616e 645f 6772  residuals_and_gr
+0001a950: 6164 5b2d 315d 0a20 2020 2072 6574 7572  ad[-1].    retur
+0001a960: 6e20 670a 0a0a 6465 6620 7265 6369 7072  n g...def recipr
+0001a970: 6f63 616c 5f61 7567 5f66 7764 2861 3a20  ocal_aug_fwd(a: 
+0001a980: 5465 6e73 6f72 5072 6f78 7929 202d 3e20  TensorProxy) -> 
+0001a990: 564a 5044 7561 6c3a 0a20 2020 2070 7269  VJPDual:.    pri
+0001a9a0: 6d61 6c20 3d20 7265 6369 7072 6f63 616c  mal = reciprocal
+0001a9b0: 2861 290a 2020 2020 7265 7475 726e 2056  (a).    return V
+0001a9c0: 4a50 4475 616c 2870 7269 6d61 6c2c 2028  JPDual(primal, (
+0001a9d0: 7072 696d 616c 2c29 290a 0a0a 6465 6620  primal,))...def 
+0001a9e0: 7265 6369 7072 6f63 616c 5f62 6163 6b77  reciprocal_backw
+0001a9f0: 6172 6428 7072 696d 616c 2c20 6729 3a0a  ard(primal, g):.
+0001aa00: 2020 2020 7265 7475 726e 202d 6720 2a20      return -g * 
+0001aa10: 7072 696d 616c 202a 2070 7269 6d61 6c0a  primal * primal.
+0001aa20: 0a0a 4070 6172 7469 616c 2872 6567 6973  ..@partial(regis
+0001aa30: 7465 725f 6772 6164 2c20 7072 696d 732e  ter_grad, prims.
+0001aa40: 5072 696d 4944 732e 5245 4349 5052 4f43  PrimIDs.RECIPROC
+0001aa50: 414c 290a 6465 6620 7265 6369 7072 6f63  AL).def reciproc
+0001aa60: 616c 5f6a 6f69 6e74 5f66 6f72 7761 7264  al_joint_forward
+0001aa70: 5f62 6163 6b77 6172 645f 7275 6c65 2861  _backward_rule(a
+0001aa80: 3a20 5465 6e73 6f72 5072 6f78 7929 202d  : TensorProxy) -
+0001aa90: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+0001aaa0: 2020 2072 6573 756c 742c 2073 6176 6564     result, saved
+0001aab0: 203d 2072 6563 6970 726f 6361 6c5f 6175   = reciprocal_au
+0001aac0: 675f 6677 6428 6129 0a20 2020 2067 203d  g_fwd(a).    g =
+0001aad0: 2067 6574 5f67 7261 6428 7265 7375 6c74   get_grad(result
+0001aae0: 290a 2020 2020 6761 203d 2072 6563 6970  ).    ga = recip
+0001aaf0: 726f 6361 6c5f 6261 636b 7761 7264 282a  rocal_backward(*
+0001ab00: 7361 7665 642c 2067 290a 2020 2020 7075  saved, g).    pu
+0001ab10: 745f 6772 6164 2861 2c20 6761 290a 2020  t_grad(a, ga).  
+0001ab20: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+0001ab30: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+0001ab40: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+0001ab50: 6f72 6368 2e69 6e64 6578 5f70 7574 2229  orch.index_put")
+0001ab60: 0a64 6566 2069 6e64 6578 5f70 7574 5f61  .def index_put_a
+0001ab70: 7567 5f66 7764 280a 2020 2020 613a 2054  ug_fwd(.    a: T
+0001ab80: 656e 736f 7250 726f 7879 2c20 2f2c 2069  ensorProxy, /, i
+0001ab90: 6e64 6963 6573 3a20 5365 7175 656e 6365  ndices: Sequence
+0001aba0: 5b54 656e 736f 7250 726f 7879 5d2c 2076  [TensorProxy], v
+0001abb0: 616c 7565 733a 2054 656e 736f 7250 726f  alues: TensorPro
+0001abc0: 7879 2c20 6163 6375 6d75 6c61 7465 3a20  xy, accumulate: 
+0001abd0: 626f 6f6c 203d 2046 616c 7365 0a29 202d  bool = False.) -
+0001abe0: 3e20 564a 5044 7561 6c3a 0a20 2020 2070  > VJPDual:.    p
+0001abf0: 7269 6d61 6c20 3d20 636c 616e 672e 696e  rimal = clang.in
+0001ac00: 6465 785f 7075 7428 612c 2069 6e64 6963  dex_put(a, indic
+0001ac10: 6573 2c20 7661 6c75 6573 2c20 6163 6375  es, values, accu
+0001ac20: 6d75 6c61 7465 290a 2020 2020 7265 7369  mulate).    resi
+0001ac30: 6475 616c 7320 3d20 280a 2020 2020 2020  duals = (.      
+0001ac40: 2020 696e 6469 6365 732c 0a20 2020 2020    indices,.     
+0001ac50: 2020 2076 616c 7565 732c 0a20 2020 2020     values,.     
+0001ac60: 2020 2061 6363 756d 756c 6174 652c 0a20     accumulate,. 
+0001ac70: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+0001ac80: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+0001ac90: 7265 7369 6475 616c 7329 0a0a 0a64 6566  residuals)...def
+0001aca0: 2073 756d 5f74 6f28 613a 2054 656e 736f   sum_to(a: Tenso
+0001acb0: 7250 726f 7879 2c20 7368 6170 653a 2053  rProxy, shape: S
+0001acc0: 6571 7565 6e63 655b 696e 745d 2920 2d3e  equence[int]) ->
+0001acd0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+0001ace0: 2020 6966 206e 6f74 2073 6861 7065 3a0a    if not shape:.
+0001acf0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001ad00: 2e73 756d 2829 0a20 2020 206c 6561 6469  .sum().    leadi
+0001ad10: 6e67 5f64 696d 7320 3d20 612e 6e64 696d  ng_dims = a.ndim
+0001ad20: 202d 206c 656e 2873 6861 7065 290a 2020   - len(shape).  
+0001ad30: 2020 7265 6475 6365 5f64 696d 7320 3d20    reduce_dims = 
+0001ad40: 7475 706c 6528 7261 6e67 6528 6c65 6164  tuple(range(lead
+0001ad50: 696e 675f 6469 6d73 2929 202b 2074 7570  ing_dims)) + tup
+0001ad60: 6c65 280a 2020 2020 2020 2020 6920 666f  le(.        i fo
+0001ad70: 7220 6920 696e 2072 616e 6765 286c 6561  r i in range(lea
+0001ad80: 6469 6e67 5f64 696d 732c 2061 2e6e 6469  ding_dims, a.ndi
+0001ad90: 6d29 2069 6620 7368 6170 655b 6920 2d20  m) if shape[i - 
+0001ada0: 6c65 6164 696e 675f 6469 6d73 5d20 3d3d  leading_dims] ==
+0001adb0: 2031 2061 6e64 2061 2e73 6861 7065 5b69   1 and a.shape[i
+0001adc0: 5d20 213d 2031 0a20 2020 2029 0a20 2020  ] != 1.    ).   
+0001add0: 2061 203d 206c 746f 7263 682e 7375 6d28   a = ltorch.sum(
+0001ade0: 612c 2064 696d 3d72 6564 7563 655f 6469  a, dim=reduce_di
+0001adf0: 6d73 2c20 6b65 6570 6469 6d3d 5472 7565  ms, keepdim=True
+0001ae00: 290a 2020 2020 6966 206c 6561 6469 6e67  ).    if leading
+0001ae10: 5f64 696d 7320 3e20 303a 0a20 2020 2020  _dims > 0:.     
+0001ae20: 2020 2072 6574 7572 6e20 6c74 6f72 6368     return ltorch
+0001ae30: 2e76 6965 7728 612c 2073 6861 7065 290a  .view(a, shape).
+0001ae40: 2020 2020 7265 7475 726e 2061 0a0a 0a40      return a...@
+0001ae50: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+0001ae60: 6428 2274 6f72 6368 2e69 6e64 6578 5f70  d("torch.index_p
+0001ae70: 7574 2229 0a64 6566 2069 6e64 6578 5f70  ut").def index_p
+0001ae80: 7574 5f62 6163 6b77 6172 6428 696e 6469  ut_backward(indi
+0001ae90: 6365 733a 2053 6571 7565 6e63 655b 5465  ces: Sequence[Te
+0001aea0: 6e73 6f72 5072 6f78 795d 2c20 7661 6c75  nsorProxy], valu
+0001aeb0: 6573 3a20 5465 6e73 6f72 5072 6f78 792c  es: TensorProxy,
+0001aec0: 2061 6363 756d 756c 6174 653a 2062 6f6f   accumulate: boo
+0001aed0: 6c2c 2067 3a20 5465 6e73 6f72 5072 6f78  l, g: TensorProx
+0001aee0: 7929 3a0a 2020 2020 675f 7661 6c75 6573  y):.    g_values
+0001aef0: 203d 2067 5b69 6e64 6963 6573 5d0a 2020   = g[indices].  
+0001af00: 2020 2320 746f 7263 6820 6861 7320 6578    # torch has ex
+0001af10: 7472 6120 6c6f 6769 6320 746f 2068 616e  tra logic to han
+0001af20: 646c 6520 7468 6520 6578 7061 6e64 6564  dle the expanded
+0001af30: 2076 616c 7565 730a 2020 2020 6966 206e   values.    if n
+0001af40: 6f74 2075 7469 6c73 2e73 616d 655f 7368  ot utils.same_sh
+0001af50: 6170 6528 675f 7661 6c75 6573 2e73 6861  ape(g_values.sha
+0001af60: 7065 2c20 7661 6c75 6573 2e73 6861 7065  pe, values.shape
+0001af70: 293a 0a20 2020 2020 2020 2069 6620 636c  ):.        if cl
+0001af80: 616e 672e 636f 6d70 7574 655f 6272 6f61  ang.compute_broa
+0001af90: 6463 6173 745f 7368 6170 6528 675f 7661  dcast_shape(g_va
+0001afa0: 6c75 6573 2e73 6861 7065 2c20 7661 6c75  lues.shape, valu
+0001afb0: 6573 2e73 6861 7065 293a 0a20 2020 2020  es.shape):.     
+0001afc0: 2020 2020 2020 2067 5f76 616c 7565 7320         g_values 
+0001afd0: 3d20 7375 6d5f 746f 2867 5f76 616c 7565  = sum_to(g_value
+0001afe0: 732c 2076 616c 7565 732e 7368 6170 6529  s, values.shape)
+0001aff0: 0a20 2020 2069 6620 6163 6375 6d75 6c61  .    if accumula
+0001b000: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
+0001b010: 726e 2067 2c20 675f 7661 6c75 6573 0a20  rn g, g_values. 
+0001b020: 2020 2072 6574 7572 6e20 636c 616e 672e     return clang.
+0001b030: 696e 6465 785f 7075 7428 672c 2069 6e64  index_put(g, ind
+0001b040: 6963 6573 2c20 6c74 6f72 6368 2e7a 6572  ices, ltorch.zer
+0001b050: 6f73 5f6c 696b 6528 7661 6c75 6573 292c  os_like(values),
+0001b060: 2046 616c 7365 292c 2067 5f76 616c 7565   False), g_value
+0001b070: 730a 0a0a 6465 6620 756e 6966 6f72 6d5f  s...def uniform_
+0001b080: 6175 675f 6677 6428 7368 6170 652c 206d  aug_fwd(shape, m
+0001b090: 696e 7661 6c2c 206d 6178 7661 6c2c 202a  inval, maxval, *
+0001b0a0: 2c20 6465 7669 6365 2c20 6474 7970 6529  , device, dtype)
+0001b0b0: 3a0a 2020 2020 7072 696d 616c 203d 2070  :.    primal = p
+0001b0c0: 7269 6d73 2e75 6e69 666f 726d 2873 6861  rims.uniform(sha
+0001b0d0: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
+0001b0e0: 616c 2c20 6465 7669 6365 3d64 6576 6963  al, device=devic
+0001b0f0: 652c 2064 7479 7065 3d64 7479 7065 290a  e, dtype=dtype).
+0001b100: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+0001b110: 616c 2870 7269 6d61 6c2c 2028 7072 696d  al(primal, (prim
+0001b120: 616c 2c20 6d69 6e76 616c 2c20 6d61 7876  al, minval, maxv
+0001b130: 616c 2929 0a0a 0a64 6566 2075 6e69 666f  al))...def unifo
+0001b140: 726d 5f62 6163 6b77 6172 6428 7072 696d  rm_backward(prim
+0001b150: 616c 2c20 6d69 6e76 616c 2c20 6d61 7876  al, minval, maxv
+0001b160: 616c 2c20 6729 3a0a 2020 2020 2320 756e  al, g):.    # un
+0001b170: 6966 6f72 6d20 6973 2069 6d70 6c65 6d65  iform is impleme
+0001b180: 6e74 6564 2061 7320 286d 6178 7661 6c20  nted as (maxval 
+0001b190: 2d20 6d69 6e76 616c 2920 2a20 756e 6966  - minval) * unif
+0001b1a0: 6f72 6d28 7368 6170 652c 2030 2c20 3129  orm(shape, 0, 1)
+0001b1b0: 202b 206d 696e 7661 6c0a 2020 2020 756e   + minval.    un
+0001b1c0: 7363 616c 6564 5f70 7269 6d61 6c20 3d20  scaled_primal = 
+0001b1d0: 2870 7269 6d61 6c20 2d20 6d69 6e76 616c  (primal - minval
+0001b1e0: 2920 2f20 286d 6178 7661 6c20 2d20 6d69  ) / (maxval - mi
+0001b1f0: 6e76 616c 290a 2020 2020 7265 6475 6365  nval).    reduce
+0001b200: 5f61 6c6c 5f64 696d 7320 3d20 7475 706c  _all_dims = tupl
+0001b210: 6528 7261 6e67 6528 672e 6e64 696d 2929  e(range(g.ndim))
+0001b220: 0a20 2020 2073 756d 203d 2070 6172 7469  .    sum = parti
+0001b230: 616c 2870 7269 6d73 2e73 756d 2c20 6469  al(prims.sum, di
+0001b240: 6d73 3d72 6564 7563 655f 616c 6c5f 6469  ms=reduce_all_di
+0001b250: 6d73 290a 2020 2020 7265 7475 726e 204e  ms).    return N
+0001b260: 6f6e 652c 2073 756d 2867 202a 2028 3120  one, sum(g * (1 
+0001b270: 2d20 756e 7363 616c 6564 5f70 7269 6d61  - unscaled_prima
+0001b280: 6c29 292c 2073 756d 2867 202a 2075 6e73  l)), sum(g * uns
+0001b290: 6361 6c65 645f 7072 696d 616c 290a 0a0a  caled_primal)...
+0001b2a0: 6e6f 6e64 6966 6665 7265 6e74 6961 626c  nondifferentiabl
+0001b2b0: 655f 766a 705f 7379 6d62 6f6c 7320 3d20  e_vjp_symbols = 
+0001b2c0: 2870 7269 6d73 2e50 7269 6d49 4473 2e42  (prims.PrimIDs.B
+0001b2d0: 4954 5749 5345 5f41 4e44 2c20 7072 696d  ITWISE_AND, prim
+0001b2e0: 732e 5072 696d 4944 732e 5349 474e 4249  s.PrimIDs.SIGNBI
+0001b2f0: 542c 2070 7269 6d73 2e50 7269 6d49 4473  T, prims.PrimIDs
+0001b300: 2e46 554c 4c29 0a0a 0a64 6566 2069 735f  .FULL)...def is_
+0001b310: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
+0001b320: 2873 796d 626f 6c3a 2070 7269 6d73 2e53  (symbol: prims.S
+0001b330: 796d 626f 6c29 202d 3e20 626f 6f6c 3a0a  ymbol) -> bool:.
+0001b340: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
+0001b350: 6120 7379 6d62 6f6c 2069 7320 636f 6e73  a symbol is cons
+0001b360: 7461 6e74 2066 6f72 2074 6865 2056 4a50  tant for the VJP
+0001b370: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
+0001b380: 2041 7267 733a 0a20 2020 2020 2020 2073   Args:.        s
+0001b390: 796d 626f 6c20 2870 7269 6d73 2e53 796d  ymbol (prims.Sym
+0001b3a0: 626f 6c29 3a20 5379 6d62 6f6c 2074 6f20  bol): Symbol to 
+0001b3b0: 6368 6563 6b2e 0a0a 2020 2020 5265 7475  check...    Retu
+0001b3c0: 726e 733a 0a20 2020 2020 2020 2062 6f6f  rns:.        boo
+0001b3d0: 6c3a 2054 7275 6520 6966 2074 6865 2073  l: True if the s
+0001b3e0: 796d 626f 6c20 6973 2063 6f6e 7374 616e  ymbol is constan
+0001b3f0: 742c 2046 616c 7365 206f 7468 6572 7769  t, False otherwi
+0001b400: 7365 2e0a 2020 2020 2222 220a 2020 2020  se..    """.    
+0001b410: 6172 655f 616c 6c5f 6172 6773 5f6e 6f6e  are_all_args_non
+0001b420: 5f64 6966 6665 7265 6e74 6961 626c 6520  _differentiable 
+0001b430: 3d20 6e6f 7420 616e 7928 6973 696e 7374  = not any(isinst
+0001b440: 616e 6365 2861 7267 2c20 2846 6c6f 6174  ance(arg, (Float
+0001b450: 5072 6f78 792c 2054 656e 736f 7250 726f  Proxy, TensorPro
+0001b460: 7879 2929 2066 6f72 2061 7267 2069 6e20  xy)) for arg in 
+0001b470: 7379 6d62 6f6c 2e66 6c61 745f 6172 6773  symbol.flat_args
+0001b480: 290a 2020 2020 7265 7475 726e 2028 0a20  ).    return (. 
+0001b490: 2020 2020 2020 2061 7265 5f61 6c6c 5f61         are_all_a
+0001b4a0: 7267 735f 6e6f 6e5f 6469 6666 6572 656e  rgs_non_differen
+0001b4b0: 7469 6162 6c65 0a20 2020 2020 2020 206f  tiable.        o
+0001b4c0: 7220 7379 6d62 6f6c 2e61 7265 5f61 6c6c  r symbol.are_all
+0001b4d0: 5f61 7267 735f 636f 6e73 7461 6e74 0a20  _args_constant. 
+0001b4e0: 2020 2020 2020 206f 7220 7379 6d62 6f6c         or symbol
+0001b4f0: 2e73 796d 2e69 6420 696e 206e 6f6e 6469  .sym.id in nondi
+0001b500: 6666 6572 656e 7469 6162 6c65 5f76 6a70  fferentiable_vjp
+0001b510: 5f73 796d 626f 6c73 0a20 2020 2029 0a0a  _symbols.    )..
+0001b520: 0a64 6566 2076 6a70 5f73 796d 626f 6c5f  .def vjp_symbol_
+0001b530: 6d61 7070 6572 2873 796d 626f 6c3a 2070  mapper(symbol: p
+0001b540: 7269 6d73 2e53 796d 626f 6c2c 202a 6172  rims.Symbol, *ar
+0001b550: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0001b560: 2020 2022 2222 5379 6d62 6f6c 206d 6170     """Symbol map
+0001b570: 7065 7220 666f 7220 7468 6520 564a 5020  per for the VJP 
+0001b580: 7472 616e 7366 6f72 6d2e 0a0a 2020 2020  transform...    
+0001b590: 4172 6773 3a0a 2020 2020 2020 2020 7379  Args:.        sy
+0001b5a0: 6d62 6f6c 2028 7072 696d 732e 5379 6d62  mbol (prims.Symb
+0001b5b0: 6f6c 293a 2053 796d 626f 6c20 746f 2062  ol): Symbol to b
+0001b5c0: 6520 6d61 7070 6564 2e0a 2020 2020 2020  e mapped..      
+0001b5d0: 2020 6172 6773 2028 5475 706c 655b 5661    args (Tuple[Va
+0001b5e0: 7269 6162 6c65 5d29 3a20 4172 6775 6d65  riable]): Argume
+0001b5f0: 6e74 7320 746f 2074 6865 2073 796d 626f  nts to the symbo
+0001b600: 6c2e 0a20 2020 2020 2020 206b 7761 7267  l..        kwarg
+0001b610: 7320 2844 6963 745b 7374 722c 2056 6172  s (Dict[str, Var
+0001b620: 6961 626c 655d 293a 204b 6579 776f 7264  iable]): Keyword
+0001b630: 2061 7267 756d 656e 7473 2074 6f20 7468   arguments to th
+0001b640: 6520 7379 6d62 6f6c 2e0a 0a20 2020 2052  e symbol...    R
+0001b650: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0001b660: 4361 6c6c 6162 6c65 3a20 4120 6675 6e63  Callable: A func
+0001b670: 7469 6f6e 2074 6861 7420 636f 6d70 7574  tion that comput
+0001b680: 6573 2074 6865 2056 4a50 206f 6620 7468  es the VJP of th
+0001b690: 6520 7379 6d62 6f6c 2e0a 2020 2020 2222  e symbol..    ""
+0001b6a0: 220a 2020 2020 2320 436f 6e73 7461 6e74  ".    # Constant
+0001b6b0: 2063 6173 650a 2020 2020 6966 2069 735f   case.    if is_
+0001b6c0: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
+0001b6d0: 2873 796d 626f 6c29 3a0a 0a20 2020 2020  (symbol):..     
+0001b6e0: 2020 2064 6566 2076 6a70 5f69 6d70 6c5f     def vjp_impl_
+0001b6f0: 636f 6e73 7428 7379 6d62 6f6c 2c20 2a61  const(symbol, *a
+0001b700: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+0001b710: 2020 2020 2020 2020 2020 2020 6172 6773              args
+0001b720: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
+0001b730: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+0001b740: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
+0001b750: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
+0001b760: 2065 6c73 6520 782c 2028 6172 6773 2c20   else x, (args, 
+0001b770: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
+0001b780: 2020 2020 2070 7269 6d61 6c73 203d 2073       primals = s
+0001b790: 796d 626f 6c5f 746f 5f65 7661 6c28 7379  ymbol_to_eval(sy
+0001b7a0: 6d62 6f6c 2928 2a61 7267 732c 202a 2a6b  mbol)(*args, **k
+0001b7b0: 7761 7267 7329 0a20 2020 2020 2020 2020  wargs).         
+0001b7c0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001b7d0: 2870 7269 6d61 6c73 2c20 5365 7175 656e  (primals, Sequen
+0001b7e0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
+0001b7f0: 2020 2020 2072 6574 7572 6e20 7472 6565       return tree
+0001b800: 5f6d 6170 286c 616d 6264 6120 783a 2056  _map(lambda x: V
+0001b810: 4a50 4475 616c 2878 2c20 7475 706c 6528  JPDual(x, tuple(
+0001b820: 2929 2c20 7072 696d 616c 7329 0a20 2020  )), primals).   
+0001b830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b840: 564a 5044 7561 6c28 7072 696d 616c 732c  VJPDual(primals,
+0001b850: 2074 7570 6c65 2829 290a 0a20 2020 2020   tuple())..     
+0001b860: 2020 2072 6574 7572 6e20 7061 7274 6961     return partia
+0001b870: 6c28 766a 705f 696d 706c 5f63 6f6e 7374  l(vjp_impl_const
+0001b880: 2c20 7379 6d62 6f6c 290a 0a20 2020 2023  , symbol)..    #
+0001b890: 204e 6f72 6d61 6c20 6361 7365 2c20 7765   Normal case, we
+0001b8a0: 2068 6176 6520 6120 7072 6f78 7920 7461   have a proxy ta
+0001b8b0: 6e67 656e 740a 2020 2020 766a 705f 696d  ngent.    vjp_im
+0001b8c0: 706c 203d 2061 7567 6d65 6e74 6564 5f66  pl = augmented_f
+0001b8d0: 6f72 7761 7264 5f69 6d70 6c73 2e67 6574  orward_impls.get
+0001b8e0: 2873 796d 626f 6c2e 7379 6d2e 6964 290a  (symbol.sym.id).
+0001b8f0: 0a20 2020 2069 6620 5f67 6574 5f67 7261  .    if _get_gra
+0001b900: 6466 6e28 7379 6d62 6f6c 2920 6973 206e  dfn(symbol) is n
+0001b910: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001b920: 2076 6a70 5f69 6d70 6c2c 2062 6163 6b77   vjp_impl, backw
+0001b930: 6172 645f 666e 203d 206d 616b 655f 6175  ard_fn = make_au
+0001b940: 675f 666f 7277 6172 645f 616e 645f 6261  g_forward_and_ba
+0001b950: 636b 7761 7264 2873 796d 626f 6c29 0a0a  ckward(symbol)..
+0001b960: 2020 2020 6966 2076 6a70 5f69 6d70 6c20      if vjp_impl 
+0001b970: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001b980: 2023 2057 6520 636f 756c 6420 6e6f 7420   # We could not 
+0001b990: 6669 6e64 2061 2056 4a50 2066 6f72 2074  find a VJP for t
+0001b9a0: 6869 7320 7379 6d62 6f6c 2c20 736f 2077  his symbol, so w
+0001b9b0: 6520 7472 7920 746f 2064 6563 6f6d 706f  e try to decompo
+0001b9c0: 7365 2069 740a 2020 2020 2020 2020 6966  se it.        if
+0001b9d0: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
+0001b9e0: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
+0001b9f0: 6e6f 7420 6973 696e 7374 616e 6365 2873  not isinstance(s
+0001ba00: 796d 626f 6c2e 7379 6d2e 6964 2c20 7072  ymbol.sym.id, pr
+0001ba10: 696d 732e 5072 696d 4944 7329 3a0a 2020  ims.PrimIDs):.  
+0001ba20: 2020 2020 2020 2020 2020 766a 705f 696d            vjp_im
+0001ba30: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
+0001ba40: 6f6d 706f 7365 645f 666e 5f61 7567 5f66  omposed_fn_aug_f
+0001ba50: 7764 5f72 756c 652c 2064 6563 6f6d 706f  wd_rule, decompo
+0001ba60: 7365 645f 666e 3d73 796d 626f 6c2e 7379  sed_fn=symbol.sy
+0001ba70: 6d29 0a20 2020 2020 2020 2065 6c73 653a  m).        else:
+0001ba80: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+0001ba90: 6520 636f 756c 6420 6e6f 7420 6669 6e64  e could not find
+0001baa0: 2061 2056 4a50 2066 6f72 2074 6869 7320   a VJP for this 
+0001bab0: 7379 6d62 6f6c 2061 6e64 2077 6520 636f  symbol and we co
+0001bac0: 756c 6420 6e6f 7420 6465 636f 6d70 6f73  uld not decompos
+0001bad0: 6520 6974 0a20 2020 2020 2020 2020 2020  e it.           
+0001bae0: 2023 2049 7420 636f 756c 6420 6265 2061   # It could be a
+0001baf0: 2074 6f72 6368 2e64 726f 706f 7574 2077   torch.dropout w
+0001bb00: 6974 6820 302e 3020 7072 6f62 6162 696c  ith 0.0 probabil
+0001bb10: 6974 792c 2073 6f20 7765 2073 6b69 7020  ity, so we skip 
+0001bb20: 6974 0a20 2020 2020 2020 2020 2020 2069  it.            i
+0001bb30: 6620 7379 6d62 6f6c 2e73 796d 2e69 6420  f symbol.sym.id 
+0001bb40: 3d3d 2022 746f 7263 682e 6e6e 2e66 756e  == "torch.nn.fun
+0001bb50: 6374 696f 6e61 6c2e 6472 6f70 6f75 7422  ctional.dropout"
+0001bb60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bb70: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+0001bb80: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0001bb90: 6622 564a 5020 666f 7220 7b73 796d 626f  f"VJP for {symbo
+0001bba0: 6c7d 2069 7320 6e6f 7420 696d 706c 656d  l} is not implem
+0001bbb0: 656e 7465 6422 290a 2020 2020 2020 2020  ented").        
+0001bbc0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
+0001bbd0: 6c65 6d65 6e74 6564 4572 726f 7228 6622  lementedError(f"
+0001bbe0: 564a 5020 666f 7220 7b73 796d 626f 6c2e  VJP for {symbol.
+0001bbf0: 7379 6d2e 6964 7d20 6973 206e 6f74 2069  sym.id} is not i
+0001bc00: 6d70 6c65 6d65 6e74 6564 2229 0a0a 2020  mplemented")..  
+0001bc10: 2020 6465 6620 5f76 6a70 5f69 6d70 6c28    def _vjp_impl(
+0001bc20: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0001bc30: 3a0a 2020 2020 2020 2020 7072 696d 616c  :.        primal
+0001bc40: 732c 206b 7761 7267 7320 3d20 7472 6565  s, kwargs = tree
+0001bc50: 5f6d 6170 286c 616d 6264 6120 783a 2078  _map(lambda x: x
+0001bc60: 2e70 7269 6d61 6c20 6966 2069 7369 6e73  .primal if isins
+0001bc70: 7461 6e63 6528 782c 2056 4a50 4475 616c  tance(x, VJPDual
+0001bc80: 2920 656c 7365 2078 2c20 2861 7267 732c  ) else x, (args,
+0001bc90: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
+0001bca0: 2020 6f75 745f 7072 696d 616c 2c20 6f75    out_primal, ou
+0001bcb0: 745f 7265 7369 6475 616c 7320 3d20 766a  t_residuals = vj
+0001bcc0: 705f 696d 706c 282a 7072 696d 616c 732c  p_impl(*primals,
+0001bcd0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+0001bce0: 2020 2020 2320 5765 2061 7265 2073 6176      # We are sav
+0001bcf0: 696e 6720 7468 6520 7265 7369 6475 616c  ing the residual
+0001bd00: 7320 616e 6420 7075 6c6c 6261 636b 206f  s and pullback o
+0001bd10: 6e6c 7920 696e 2074 6865 2066 6972 7374  nly in the first
+0001bd20: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0001bd30: 2320 6261 636b 7761 7264 5f70 6173 7320  # backward_pass 
+0001bd40: 7468 656e 2072 6574 7269 6576 6573 2074  then retrieves t
+0001bd50: 6865 2072 6573 6964 7561 6c73 2061 6e64  he residuals and
+0001bd60: 2070 756c 6c62 6163 6b20 6672 6f6d 2074   pullback from t
+0001bd70: 6865 2066 6972 7374 206f 7574 7075 740a  he first output.
+0001bd80: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001bd90: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
+0001bda0: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
+0001bdb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001bdc0: 2856 4a50 4475 616c 286f 7574 5f70 7269  (VJPDual(out_pri
+0001bdd0: 6d61 6c5b 305d 2c20 6f75 745f 7265 7369  mal[0], out_resi
+0001bde0: 6475 616c 7329 2c20 2a28 564a 5044 7561  duals), *(VJPDua
+0001bdf0: 6c28 6f2c 2074 7570 6c65 2829 2920 666f  l(o, tuple()) fo
+0001be00: 7220 6f20 696e 206f 7574 5f70 7269 6d61  r o in out_prima
+0001be10: 6c5b 313a 5d29 290a 0a20 2020 2020 2020  l[1:]))..       
+0001be20: 2072 6574 7572 6e20 2856 4a50 4475 616c   return (VJPDual
+0001be30: 286f 7574 5f70 7269 6d61 6c2c 206f 7574  (out_primal, out
+0001be40: 5f72 6573 6964 7561 6c73 292c 290a 0a20  _residuals),).. 
+0001be50: 2020 2072 6574 7572 6e20 5f76 6a70 5f69     return _vjp_i
+0001be60: 6d70 6c0a 0a0a 6465 6620 6368 6563 6b5f  mpl...def check_
+0001be70: 6273 796d 5f66 6f72 5f76 6a70 2862 7379  bsym_for_vjp(bsy
+0001be80: 6d29 3a0a 2020 2020 2222 220a 2020 2020  m):.    """.    
+0001be90: 4368 6563 6b20 6966 2061 2062 6f75 6e64  Check if a bound
+0001bea0: 2073 796d 626f 6c20 6973 2073 7570 706f   symbol is suppo
+0001beb0: 7274 6564 2062 7920 766a 702e 0a0a 2020  rted by vjp...  
+0001bec0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001bed0: 6273 796d 2028 426f 756e 6453 796d 626f  bsym (BoundSymbo
+0001bee0: 6c29 3a20 5468 6520 626f 756e 6420 7379  l): The bound sy
+0001bef0: 6d62 6f6c 2074 6f20 6368 6563 6b2e 0a0a  mbol to check...
+0001bf00: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001bf10: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
+0001bf20: 6966 2074 6865 2062 6f75 6e64 2073 796d  if the bound sym
+0001bf30: 626f 6c20 6973 2073 7570 706f 7274 6564  bol is supported
+0001bf40: 2062 7920 766a 702c 2046 616c 7365 206f   by vjp, False o
+0001bf50: 7468 6572 7769 7365 2e0a 2020 2020 2222  therwise..    ""
+0001bf60: 220a 0a20 2020 2069 6620 6273 796d 2e73  "..    if bsym.s
+0001bf70: 796d 2e69 6420 696e 2074 7261 6e73 666f  ym.id in transfo
+0001bf80: 726d 5f73 6b69 705f 6c69 7374 3a0a 2020  rm_skip_list:.  
+0001bf90: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
+0001bfa0: 650a 0a20 2020 2069 6620 6273 796d 2e73  e..    if bsym.s
+0001bfb0: 796d 2e69 6420 696e 2062 6163 6b77 6172  ym.id in backwar
+0001bfc0: 645f 696d 706c 7320 616e 6420 6273 796d  d_impls and bsym
+0001bfd0: 2e73 796d 2e69 6420 696e 2061 7567 6d65  .sym.id in augme
+0001bfe0: 6e74 6564 5f66 6f72 7761 7264 5f69 6d70  nted_forward_imp
+0001bff0: 6c73 3a0a 2020 2020 2020 2020 7265 7475  ls:.        retu
+0001c000: 726e 2054 7275 650a 0a20 2020 2069 6620  rn True..    if 
+0001c010: 6273 796d 2e73 796d 2e69 6420 696e 205f  bsym.sym.id in _
+0001c020: 6772 6164 5f66 6e5f 6d61 703a 0a20 2020  grad_fn_map:.   
+0001c030: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+0001c040: 0a0a 2020 2020 2320 5765 2063 6f75 6c64  ..    # We could
+0001c050: 206e 6f74 2066 696e 6420 6120 564a 5020   not find a VJP 
+0001c060: 666f 7220 7468 6973 2073 796d 626f 6c2c  for this symbol,
+0001c070: 2073 6f20 7765 2074 7279 2074 6f20 6465   so we try to de
+0001c080: 636f 6d70 6f73 6520 6974 0a20 2020 2023  compose it.    #
+0001c090: 2069 6e74 6f20 7375 622d 7379 6d62 6f6c   into sub-symbol
+0001c0a0: 7320 616e 6420 6368 6563 6b20 6966 2074  s and check if t
+0001c0b0: 6865 7920 6172 6520 7375 7070 6f72 7465  hey are supporte
+0001c0c0: 640a 2020 2020 6966 206c 656e 2862 7379  d.    if len(bsy
+0001c0d0: 6d2e 7375 6273 796d 626f 6c73 2920 3e20  m.subsymbols) > 
+0001c0e0: 3020 616e 6420 6e6f 7420 6273 796d 2e73  0 and not bsym.s
+0001c0f0: 796d 2e69 735f 7072 696d 3a0a 2020 2020  ym.is_prim:.    
+0001c100: 2020 2020 7375 6274 7261 6365 203d 2063      subtrace = c
+0001c110: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+0001c120: 2862 7379 6d2e 7379 6d2c 202a 6273 796d  (bsym.sym, *bsym
+0001c130: 2e61 7267 732c 202a 2a62 7379 6d2e 6b77  .args, **bsym.kw
+0001c140: 6172 6773 290a 2020 2020 2020 2020 7375  args).        su
+0001c150: 6274 7261 6365 203d 2075 6e77 7261 705f  btrace = unwrap_
+0001c160: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
+0001c170: 7379 6d62 6f6c 7328 7375 6274 7261 6365  symbols(subtrace
+0001c180: 290a 2020 2020 2020 2020 616c 6c5f 7375  ).        all_su
+0001c190: 7070 6f72 7465 6420 3d20 616c 6c28 6368  pported = all(ch
+0001c1a0: 6563 6b5f 6273 796d 5f66 6f72 5f76 6a70  eck_bsym_for_vjp
+0001c1b0: 2873 7562 6273 796d 2920 666f 7220 7375  (subbsym) for su
+0001c1c0: 6262 7379 6d20 696e 2073 7562 7472 6163  bbsym in subtrac
+0001c1d0: 652e 626f 756e 645f 7379 6d62 6f6c 7329  e.bound_symbols)
+0001c1e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001c1f0: 616c 6c5f 7375 7070 6f72 7465 640a 0a20  all_supported.. 
+0001c200: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0001c210: 0a0a 6465 6620 6175 676d 656e 7465 645f  ..def augmented_
+0001c220: 666f 7277 6172 645f 7061 7373 282a 6172  forward_pass(*ar
+0001c230: 6773 2c20 7472 6163 653a 2054 7261 6365  gs, trace: Trace
+0001c240: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0001c250: 2022 2222 4175 676d 656e 7465 6420 666f   """Augmented fo
+0001c260: 7277 6172 6420 7061 7373 2066 6f72 2074  rward pass for t
+0001c270: 6865 2056 4a50 2074 7261 6e73 666f 726d  he VJP transform
+0001c280: 2e0a 0a20 2020 2054 6865 2061 7567 6d65  ...    The augme
+0001c290: 6e74 6564 2066 6f72 7761 7264 2070 6173  nted forward pas
+0001c2a0: 7320 6973 2061 2066 6f72 7761 7264 2070  s is a forward p
+0001c2b0: 6173 7320 7468 6174 2072 6574 7572 6e73  ass that returns
+0001c2c0: 2074 6865 2072 6573 6964 7561 6c73 0a20   the residuals. 
+0001c2d0: 2020 206f 6620 7468 6520 666f 7277 6172     of the forwar
+0001c2e0: 6420 7061 7373 2e0a 2020 2020 5468 6573  d pass..    Thes
+0001c2f0: 6520 7265 7369 6475 616c 7320 6172 6520  e residuals are 
+0001c300: 7573 6564 2069 6e20 7468 6520 6261 636b  used in the back
+0001c310: 7761 7264 2070 6173 7320 746f 2063 6f6d  ward pass to com
+0001c320: 7075 7465 2074 6865 2056 4a50 2061 6e64  pute the VJP and
+0001c330: 2074 6865 790a 2020 2020 6172 6520 7265   they.    are re
+0001c340: 636f 7264 6564 2069 6e20 7468 6520 656e  corded in the en
+0001c350: 7669 726f 6e6d 656e 7420 6469 6374 696f  vironment dictio
+0001c360: 6e61 7279 2066 6f72 2065 6163 6820 7661  nary for each va
+0001c370: 7269 6162 6c65 2e0a 0a20 2020 2041 7267  riable...    Arg
+0001c380: 733a 0a20 2020 2020 2020 2061 7267 7320  s:.        args 
+0001c390: 2854 7570 6c65 5b56 6172 6961 626c 655d  (Tuple[Variable]
+0001c3a0: 293a 2041 7267 756d 656e 7473 2074 6f20  ): Arguments to 
+0001c3b0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
+0001c3c0: 2020 2020 2020 7472 6163 6520 2854 7261        trace (Tra
+0001c3d0: 6365 293a 2054 7261 6365 206f 6620 7468  ce): Trace of th
+0001c3e0: 6520 6675 6e63 7469 6f6e 2e0a 2020 2020  e function..    
+0001c3f0: 2020 2020 6b77 6172 6773 2028 4469 6374      kwargs (Dict
+0001c400: 5b73 7472 2c20 5661 7269 6162 6c65 5d29  [str, Variable])
+0001c410: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
+0001c420: 6e74 7320 746f 2074 6865 2066 756e 6374  nts to the funct
+0001c430: 696f 6e2e 0a0a 2020 2020 5265 7475 726e  ion...    Return
+0001c440: 733a 0a20 2020 2020 2020 2054 7570 6c65  s:.        Tuple
+0001c450: 5b41 6e79 2c20 4469 6374 5b73 7472 2c20  [Any, Dict[str, 
+0001c460: 416e 795d 5d3a 2054 7570 6c65 206f 6620  Any]]: Tuple of 
+0001c470: 7468 6520 7072 696d 616c 206f 7574 7075  the primal outpu
+0001c480: 7473 2061 6e64 2074 6865 2065 6e76 6972  ts and the envir
+0001c490: 6f6e 6d65 6e74 2e0a 2020 2020 2222 220a  onment..    """.
+0001c4a0: 2020 2020 6172 6773 2c20 6b77 6172 6773      args, kwargs
+0001c4b0: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
+0001c4c0: 6461 2078 3a20 564a 5044 7561 6c28 782c  da x: VJPDual(x,
+0001c4d0: 2074 7570 6c65 2829 292c 2028 6172 6773   tuple()), (args
+0001c4e0: 2c20 6b77 6172 6773 2929 0a20 2020 2072  , kwargs)).    r
+0001c4f0: 6573 756c 742c 2065 6e76 203d 2065 7661  esult, env = eva
+0001c500: 6c5f 7472 6163 6528 0a20 2020 2020 2020  l_trace(.       
+0001c510: 2074 7261 6365 2c0a 2020 2020 2020 2020   trace,.        
+0001c520: 2a61 7267 732c 0a20 2020 2020 2020 202a  *args,.        *
+0001c530: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+0001c540: 2077 6974 685f 656e 763d 5472 7565 2c0a   with_env=True,.
+0001c550: 2020 2020 2020 2020 7379 6d62 6f6c 5f6d          symbol_m
+0001c560: 6170 7065 723d 766a 705f 7379 6d62 6f6c  apper=vjp_symbol
+0001c570: 5f6d 6170 7065 722c 0a20 2020 2029 0a20  _mapper,.    ). 
+0001c580: 2020 2072 6573 756c 7420 3d20 7472 6565     result = tree
+0001c590: 5f6d 6170 286c 616d 6264 6120 783a 2078  _map(lambda x: x
+0001c5a0: 2e70 7269 6d61 6c20 6966 2069 7369 6e73  .primal if isins
+0001c5b0: 7461 6e63 6528 782c 2056 4a50 4475 616c  tance(x, VJPDual
+0001c5c0: 2920 656c 7365 2078 2c20 7265 7375 6c74  ) else x, result
+0001c5d0: 290a 2020 2020 7265 7475 726e 2072 6573  ).    return res
+0001c5e0: 756c 742c 2065 6e76 0a0a 0a23 2054 4f44  ult, env...# TOD
+0001c5f0: 4f3a 2049 6e73 7465 6164 206f 6620 7573  O: Instead of us
+0001c600: 696e 6720 7468 6520 656e 7669 726f 6e6d  ing the environm
+0001c610: 656e 7420 6469 6374 696f 6e61 7279 2c20  ent dictionary, 
+0001c620: 7765 2063 6f75 6c64 2075 7365 2074 6865  we could use the
+0001c630: 2074 7261 6365 0a23 2073 796d 626f 6c73   trace.# symbols
+0001c640: 206f 7264 6572 2028 7468 6174 2073 686f   order (that sho
+0001c650: 756c 6420 6265 2064 6574 6572 6d69 6e69  uld be determini
+0001c660: 7374 6963 2920 746f 2072 6574 7269 6576  stic) to retriev
+0001c670: 6520 7468 6520 7265 7369 6475 616c 7320  e the residuals 
+0001c680: 6e65 6564 6564 0a23 2066 6f72 2074 6865  needed.# for the
+0001c690: 2062 6163 6b77 6172 6420 7061 7373 2e0a   backward pass..
+0001c6a0: 6465 6620 6261 636b 7761 7264 5f70 6173  def backward_pas
+0001c6b0: 7328 666f 7277 6172 645f 656e 762c 2074  s(forward_env, t
+0001c6c0: 7261 6365 2c20 696e 6974 5f63 6f74 616e  race, init_cotan
+0001c6d0: 6765 6e74 7329 3a0a 2020 2020 2222 2242  gents):.    """B
+0001c6e0: 6163 6b77 6172 6420 7061 7373 2066 6f72  ackward pass for
+0001c6f0: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
+0001c700: 726d 2e0a 0a20 2020 2054 6865 2062 6163  rm...    The bac
+0001c710: 6b77 6172 6420 7061 7373 2069 7320 6120  kward pass is a 
+0001c720: 7265 7665 7273 6520 6d6f 6465 2061 7574  reverse mode aut
+0001c730: 6f6d 6174 6963 2064 6966 6665 7265 6e74  omatic different
+0001c740: 6961 7469 6f6e 2070 6173 7320 7468 6174  iation pass that
+0001c750: 0a20 2020 2063 6f6d 7075 7465 7320 7468  .    computes th
+0001c760: 6520 7665 6374 6f72 2d4a 6163 6f62 6961  e vector-Jacobia
+0001c770: 6e20 7072 6f64 7563 7420 2856 4a50 2920  n product (VJP) 
+0001c780: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+0001c790: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001c7a0: 2020 2020 666f 7277 6172 645f 656e 7620      forward_env 
+0001c7b0: 2844 6963 745b 7374 722c 2041 6e79 5d29  (Dict[str, Any])
+0001c7c0: 3a20 456e 7669 726f 6e6d 656e 7420 6f66  : Environment of
+0001c7d0: 2074 6865 2066 6f72 7761 7264 2070 6173   the forward pas
+0001c7e0: 732e 0a20 2020 2020 2020 2074 7261 6365  s..        trace
+0001c7f0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
+0001c800: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+0001c810: 0a20 2020 2020 2020 2069 6e69 745f 636f  .        init_co
+0001c820: 7461 6e67 656e 7473 2028 5475 706c 655b  tangents (Tuple[
+0001c830: 5661 7269 6162 6c65 5d29 3a20 496e 6974  Variable]): Init
+0001c840: 6961 6c20 636f 7461 6e67 656e 7473 2e0a  ial cotangents..
+0001c850: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+0001c860: 2020 2020 2020 5475 706c 655b 5072 6f78        Tuple[Prox
+0001c870: 792c 202e 2e2e 5d3a 2054 7570 6c65 206f  y, ...]: Tuple o
+0001c880: 6620 7468 6520 7265 7375 6c74 7320 6f66  f the results of
+0001c890: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
+0001c8a0: 7373 2066 6f72 2065 6163 6820 696e 7075  ss for each inpu
+0001c8b0: 742e 0a20 2020 2022 2222 0a20 2020 2065  t..    """.    e
+0001c8c0: 6e76 203d 207b 7d0a 0a20 2020 2064 6566  nv = {}..    def
+0001c8d0: 2067 6574 5f67 7261 6428 783a 2056 6172   get_grad(x: Var
+0001c8e0: 6961 626c 6529 3a0a 2020 2020 2020 2020  iable):.        
+0001c8f0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001c900: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
+0001c910: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
+0001c920: 204e 6f6e 6520 6966 2074 6865 2076 6172   None if the var
+0001c930: 6961 626c 6520 7761 7320 6e6f 7420 7573  iable was not us
+0001c940: 6564 2069 6e20 7468 6520 636f 6d70 7574  ed in the comput
+0001c950: 6174 696f 6e20 616e 640a 2020 2020 2020  ation and.      
+0001c960: 2020 2020 2020 2320 6865 6e63 6520 6e6f        # hence no
+0001c970: 7420 696e 2074 6865 2065 6e76 0a20 2020  t in the env.   
+0001c980: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001c990: 656e 762e 6765 7428 782e 6e61 6d65 2c20  env.get(x.name, 
+0001c9a0: 4e6f 6e65 290a 2020 2020 2020 2020 656c  None).        el
+0001c9b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001c9c0: 7265 7475 726e 2078 0a0a 2020 2020 6465  return x..    de
+0001c9d0: 6620 7075 745f 6772 6164 2876 3a20 5661  f put_grad(v: Va
+0001c9e0: 7269 6162 6c65 2c20 7661 6c3a 2041 6e79  riable, val: Any
+0001c9f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001ca00: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0001ca10: 2876 2c20 5661 7269 6162 6c65 293a 0a20  (v, Variable):. 
+0001ca20: 2020 2020 2020 2020 2020 2069 6620 762e             if v.
+0001ca30: 6e61 6d65 2069 6e20 656e 763a 0a20 2020  name in env:.   
+0001ca40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001ca50: 7661 6c20 6973 204e 6f6e 653a 0a20 2020  val is None:.   
+0001ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca70: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0001ca80: 2020 2020 2020 2020 2320 4163 6375 6d75          # Accumu
+0001ca90: 6c61 7465 2063 6f74 616e 6765 6e74 730a  late cotangents.
+0001caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cab0: 656e 765b 762e 6e61 6d65 5d20 3d20 636c  env[v.name] = cl
+0001cac0: 616e 672e 6164 6428 656e 765b 762e 6e61  ang.add(env[v.na
+0001cad0: 6d65 5d2c 2076 616c 2920 6966 2065 6e76  me], val) if env
+0001cae0: 5b76 2e6e 616d 655d 2069 7320 6e6f 7420  [v.name] is not 
+0001caf0: 4e6f 6e65 2065 6c73 6520 7661 6c0a 2020  None else val.  
+0001cb00: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001cb10: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0001cb20: 2065 6e76 5b76 2e6e 616d 655d 203d 2076   env[v.name] = v
+0001cb30: 616c 0a20 2020 2020 2020 2065 6c69 6620  al.        elif 
+0001cb40: 6973 696e 7374 616e 6365 2876 2c20 5365  isinstance(v, Se
+0001cb50: 7175 656e 6365 2920 616e 6420 616c 6c28  quence) and all(
+0001cb60: 6973 696e 7374 616e 6365 2878 2c20 696e  isinstance(x, in
+0001cb70: 7429 2066 6f72 2078 2069 6e20 7629 3a0a  t) for x in v):.
+0001cb80: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+0001cb90: 444f 3a20 7265 6d6f 7665 2077 6865 6e20  DO: remove when 
+0001cba0: 7765 206d 6f76 6520 6469 6d73 2074 6f20  we move dims to 
+0001cbb0: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
+0001cbc0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
+0001cbd0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0001cbe0: 762c 2073 7472 293a 0a20 2020 2020 2020  v, str):.       
+0001cbf0: 2020 2020 2065 6e76 5b76 5d20 3d20 7661       env[v] = va
+0001cc00: 6c0a 2020 2020 2020 2020 656c 6966 2069  l.        elif i
+0001cc10: 7369 6e73 7461 6e63 6528 762c 2053 6571  sinstance(v, Seq
+0001cc20: 7565 6e63 6529 2061 6e64 2076 616c 2069  uence) and val i
+0001cc30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001cc40: 2020 2020 2320 6272 6f61 6463 6173 7420      # broadcast 
+0001cc50: 4e6f 6e65 2074 6f20 7468 6520 7269 6768  None to the righ
+0001cc60: 7420 7368 6170 650a 2020 2020 2020 2020  t shape.        
+0001cc70: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
+0001cc80: 5f67 7261 642c 2076 2c20 5b4e 6f6e 655d  _grad, v, [None]
+0001cc90: 202a 206c 656e 2876 2929 0a20 2020 2020   * len(v)).     
+0001cca0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0001ccb0: 6365 2876 2c20 5365 7175 656e 6365 2920  ce(v, Sequence) 
+0001ccc0: 616e 6420 6973 696e 7374 616e 6365 2876  and isinstance(v
+0001ccd0: 616c 2c20 5365 7175 656e 6365 293a 0a20  al, Sequence):. 
+0001cce0: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
+0001ccf0: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
+0001cd00: 642c 2076 2c20 7661 6c29 0a20 2020 2020  d, v, val).     
+0001cd10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001cd20: 2020 2020 2023 2053 6b69 7020 7772 6974       # Skip writ
+0001cd30: 696e 6720 746f 2063 6f6e 7374 616e 7473  ing to constants
+0001cd40: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+0001cd50: 730a 0a20 2020 2069 6620 6973 696e 7374  s..    if isinst
+0001cd60: 616e 6365 2869 6e69 745f 636f 7461 6e67  ance(init_cotang
+0001cd70: 656e 7473 2c20 5365 7175 656e 6365 2920  ents, Sequence) 
+0001cd80: 616e 6420 6c65 6e28 696e 6974 5f63 6f74  and len(init_cot
+0001cd90: 616e 6765 6e74 7329 203d 3d20 3120 616e  angents) == 1 an
+0001cda0: 6420 6e6f 7420 6973 696e 7374 616e 6365  d not isinstance
+0001cdb0: 2874 7261 6365 2e6f 7574 7075 742c 2053  (trace.output, S
+0001cdc0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+0001cdd0: 2020 696e 6974 5f63 6f74 616e 6765 6e74    init_cotangent
+0001cde0: 7320 3d20 696e 6974 5f63 6f74 616e 6765  s = init_cotange
+0001cdf0: 6e74 735b 305d 0a20 2020 2073 6166 655f  nts[0].    safe_
+0001ce00: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
+0001ce10: 642c 2074 7261 6365 2e6f 7574 7075 742c  d, trace.output,
+0001ce20: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
+0001ce30: 290a 0a20 2020 2066 6f72 2073 796d 626f  )..    for symbo
+0001ce40: 6c20 696e 2072 6576 6572 7365 6428 6c69  l in reversed(li
+0001ce50: 7374 2869 7465 725f 626f 756e 645f 7379  st(iter_bound_sy
+0001ce60: 6d62 6f6c 7328 7472 6163 652e 626f 756e  mbols(trace.boun
+0001ce70: 645f 7379 6d62 6f6c 7329 2929 3a0a 2020  d_symbols))):.  
+0001ce80: 2020 2020 2020 7379 6d62 6f6c 5f6f 7574        symbol_out
+0001ce90: 7075 7420 3d20 7365 7175 656e 6369 6679  put = sequencify
+0001cea0: 2873 796d 626f 6c2e 6f75 7470 7574 290a  (symbol.output).
+0001ceb0: 0a20 2020 2020 2020 2063 6f74 616e 6765  .        cotange
+0001cec0: 6e74 7320 3d20 7472 6565 5f6d 6170 2867  nts = tree_map(g
+0001ced0: 6574 5f67 7261 642c 2073 796d 626f 6c5f  et_grad, symbol_
+0001cee0: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
+0001cef0: 2320 4861 7669 6e67 2061 2073 696e 676c  # Having a singl
+0001cf00: 6520 636f 7461 6e67 656e 7420 6973 2061  e cotangent is a
+0001cf10: 2063 6f6d 6d6f 6e20 6361 7365 2c20 736f   common case, so
+0001cf20: 2077 6520 666c 6174 7465 6e20 6974 0a20   we flatten it. 
+0001cf30: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
+0001cf40: 7365 2c20 7765 2077 696c 6c20 6e65 6564  se, we will need
+0001cf50: 2074 6f20 7265 7772 6974 6520 7468 6520   to rewrite the 
+0001cf60: 7075 6c6c 6261 636b 2066 756e 6374 696f  pullback functio
+0001cf70: 6e73 0a20 2020 2020 2020 2063 6f74 616e  ns.        cotan
+0001cf80: 6765 6e74 7320 3d20 7472 6565 5f66 6c61  gents = tree_fla
+0001cf90: 7474 656e 2863 6f74 616e 6765 6e74 7329  tten(cotangents)
+0001cfa0: 5b30 5d0a 2020 2020 2020 2020 7265 7369  [0].        resi
+0001cfb0: 6475 616c 7320 3d20 666f 7277 6172 645f  duals = forward_
+0001cfc0: 656e 765b 7379 6d62 6f6c 5f6f 7574 7075  env[symbol_outpu
+0001cfd0: 745b 305d 2e6e 616d 655d 2e72 6573 6964  t[0].name].resid
+0001cfe0: 7561 6c73 0a20 2020 2020 2020 2069 6620  uals.        if 
+0001cff0: 6973 5f63 6f6e 7374 616e 745f 666f 725f  is_constant_for_
+0001d000: 766a 7028 7379 6d62 6f6c 293a 0a20 2020  vjp(symbol):.   
+0001d010: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
+0001d020: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
+0001d030: 6163 6b20 6966 2061 6c6c 2074 6865 2061  ack if all the a
+0001d040: 7267 756d 656e 7473 2061 7265 2063 6f6e  rguments are con
+0001d050: 7374 616e 740a 2020 2020 2020 2020 2020  stant.          
+0001d060: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+0001d070: 2020 2020 6966 2061 6c6c 2863 6f74 616e      if all(cotan
+0001d080: 6765 6e74 2069 7320 4e6f 6e65 2066 6f72  gent is None for
+0001d090: 2063 6f74 616e 6765 6e74 2069 6e20 636f   cotangent in co
+0001d0a0: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
+0001d0b0: 2020 2020 2020 2023 2057 6520 6361 6e20         # We can 
+0001d0c0: 736b 6970 2074 6865 2070 756c 6c62 6163  skip the pullbac
+0001d0d0: 6b20 6966 2074 6865 2063 6f74 616e 6765  k if the cotange
+0001d0e0: 6e74 2069 7320 4e6f 6e65 0a20 2020 2020  nt is None.     
+0001d0f0: 2020 2020 2020 2073 6166 655f 6d61 7028         safe_map(
+0001d100: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
+0001d110: 2e61 7267 732c 2028 4e6f 6e65 2c29 202a  .args, (None,) *
+0001d120: 206c 656e 2873 796d 626f 6c2e 6172 6773   len(symbol.args
+0001d130: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
+0001d140: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0001d150: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0001d160: 6420 3d3d 2022 746f 7263 682e 6e6e 2e66  d == "torch.nn.f
+0001d170: 756e 6374 696f 6e61 6c2e 6472 6f70 6f75  unctional.dropou
+0001d180: 7422 2061 6e64 206e 6f74 2073 796d 626f  t" and not symbo
+0001d190: 6c2e 7375 6273 796d 626f 6c73 3a0a 2020  l.subsymbols:.  
+0001d1a0: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
+0001d1b0: 616e 2073 6b69 7020 7468 6520 7075 6c6c  an skip the pull
+0001d1c0: 6261 636b 2069 6620 7468 6520 6472 6f70  back if the drop
+0001d1d0: 6f75 7420 7072 6f62 6162 696c 6974 7920  out probability 
+0001d1e0: 6973 2030 2e30 0a20 2020 2020 2020 2020  is 0.0.         
+0001d1f0: 2020 2023 2041 7373 756d 696e 6720 7468     # Assuming th
+0001d200: 6174 2074 6865 2064 726f 706f 7574 2073  at the dropout s
+0001d210: 796d 626f 6c20 6861 7320 7468 6520 7361  ymbol has the sa
+0001d220: 6d65 206f 7574 7075 7420 616e 6420 6172  me output and ar
+0001d230: 6775 6d65 6e74 0a20 2020 2020 2020 2020  gument.         
+0001d240: 2020 2061 7373 6572 7420 7379 6d62 6f6c     assert symbol
+0001d250: 2e6f 7574 7075 742e 6e61 6d65 203d 3d20  .output.name == 
+0001d260: 7379 6d62 6f6c 2e61 7267 735b 305d 2e6e  symbol.args[0].n
+0001d270: 616d 652c 2022 4472 6f70 6f75 7420 7379  ame, "Dropout sy
+0001d280: 6d62 6f6c 2068 6173 2061 2064 6966 6665  mbol has a diffe
+0001d290: 7265 6e74 206f 7574 7075 7420 616e 6420  rent output and 
+0001d2a0: 6172 6775 6d65 6e74 220a 2020 2020 2020  argument".      
+0001d2b0: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
+0001d2c0: 6172 6773 5b31 5d20 3d3d 2030 2e30 206f  args[1] == 0.0 o
+0001d2d0: 7220 7379 6d62 6f6c 2e61 7267 735b 325d  r symbol.args[2]
+0001d2e0: 2069 7320 4661 6c73 653a 0a20 2020 2020   is False:.     
+0001d2f0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0001d300: 6e75 650a 0a20 2020 2020 2020 2062 6163  nue..        bac
+0001d310: 6b77 6172 6420 3d20 6261 636b 7761 7264  kward = backward
+0001d320: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
+0001d330: 6c2e 7379 6d2e 6964 290a 2020 2020 2020  l.sym.id).      
+0001d340: 2020 6175 675f 666f 7277 6172 6420 3d20    aug_forward = 
+0001d350: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001d360: 645f 696d 706c 732e 6765 7428 7379 6d62  d_impls.get(symb
+0001d370: 6f6c 2e73 796d 2e69 6429 0a0a 2020 2020  ol.sym.id)..    
+0001d380: 2020 2020 6966 205f 6765 745f 6772 6164      if _get_grad
+0001d390: 666e 2873 796d 626f 6c29 2069 7320 6e6f  fn(symbol) is no
+0001d3a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001d3b0: 2020 2020 6175 675f 666f 7277 6172 642c      aug_forward,
+0001d3c0: 2062 6163 6b77 6172 6420 3d20 6d61 6b65   backward = make
+0001d3d0: 5f61 7567 5f66 6f72 7761 7264 5f61 6e64  _aug_forward_and
+0001d3e0: 5f62 6163 6b77 6172 6428 7379 6d62 6f6c  _backward(symbol
+0001d3f0: 290a 0a20 2020 2020 2020 2069 6620 6261  )..        if ba
+0001d400: 636b 7761 7264 2069 7320 4e6f 6e65 3a0a  ckward is None:.
+0001d410: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0001d420: 656e 2873 796d 626f 6c2e 7375 6273 796d  en(symbol.subsym
+0001d430: 626f 6c73 2920 3e20 3020 616e 6420 6e6f  bols) > 0 and no
+0001d440: 7420 6973 696e 7374 616e 6365 2873 796d  t isinstance(sym
+0001d450: 626f 6c2e 7379 6d2e 6964 2c20 7072 696d  bol.sym.id, prim
+0001d460: 732e 5072 696d 4944 7329 3a0a 2020 2020  s.PrimIDs):.    
+0001d470: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+0001d480: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
+0001d490: 6120 6261 636b 7761 7264 2066 6f72 2074  a backward for t
+0001d4a0: 6869 7320 7379 6d62 6f6c 2c20 736f 2077  his symbol, so w
+0001d4b0: 6520 7472 7920 746f 2064 6563 6f6d 706f  e try to decompo
+0001d4c0: 7365 2069 740a 2020 2020 2020 2020 2020  se it.          
+0001d4d0: 2020 2020 2020 6261 636b 7761 7264 203d        backward =
+0001d4e0: 2070 6172 7469 616c 2864 6563 6f6d 706f   partial(decompo
+0001d4f0: 7365 645f 666e 5f62 6163 6b77 6172 645f  sed_fn_backward_
+0001d500: 7275 6c65 2c20 7379 6d62 6f6c 2e73 796d  rule, symbol.sym
+0001d510: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0001d520: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001d530: 2020 2020 2320 5765 2063 6f75 6c64 206e      # We could n
+0001d540: 6f74 2066 696e 6420 6120 6261 636b 7761  ot find a backwa
+0001d550: 7264 2066 6f72 2074 6869 7320 7379 6d62  rd for this symb
+0001d560: 6f6c 2061 6e64 2077 6520 636f 756c 6420  ol and we could 
+0001d570: 6e6f 7420 6465 636f 6d70 6f73 6520 6974  not decompose it
+0001d580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d590: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+0001d5a0: 656e 7465 6445 7272 6f72 2866 2242 6163  entedError(f"Bac
+0001d5b0: 6b77 6172 6420 666f 7220 7b73 796d 626f  kward for {symbo
+0001d5c0: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
+0001d5d0: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
+0001d5e0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0001d5f0: 2062 6163 6b77 6172 6428 2a72 6573 6964   backward(*resid
+0001d600: 7561 6c73 2c20 2a63 6f74 616e 6765 6e74  uals, *cotangent
+0001d610: 7329 0a20 2020 2020 2020 2069 6620 6973  s).        if is
+0001d620: 696e 7374 616e 6365 2872 6573 756c 742c  instance(result,
+0001d630: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+0001d640: 2020 2020 2320 4966 2074 6865 2062 6163      # If the bac
+0001d650: 6b77 6172 6420 7265 7475 726e 7320 6120  kward returns a 
+0001d660: 6469 6374 2c20 7765 2061 7373 756d 6520  dict, we assume 
+0001d670: 7468 6174 2069 7420 6973 2061 2064 6963  that it is a dic
+0001d680: 7420 6f66 0a20 2020 2020 2020 2020 2020  t of.           
+0001d690: 2023 2066 6f72 7761 7264 2061 7267 756d   # forward argum
+0001d6a0: 656e 7473 2074 6f20 7468 6520 636f 7272  ents to the corr
+0001d6b0: 6573 706f 6e64 696e 670a 2020 2020 2020  esponding.      
+0001d6c0: 2020 2020 2020 2320 6772 6164 6965 6e74        # gradient
+0001d6d0: 732f 636f 7461 6e67 656e 7473 2f61 646a  s/cotangents/adj
+0001d6e0: 6f69 6e74 732f 7365 6e73 6974 6976 6974  oints/sensitivit
+0001d6f0: 6965 732e 0a20 2020 2020 2020 2020 2020  ies..           
+0001d700: 2075 7365 645f 6e61 6d65 7320 3d20 7365   used_names = se
+0001d710: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0001d720: 666f 7220 692c 2028 6b2c 2076 2920 696e  for i, (k, v) in
+0001d730: 2065 6e75 6d65 7261 7465 2869 6e73 7065   enumerate(inspe
+0001d740: 6374 2e73 6967 6e61 7475 7265 2861 7567  ct.signature(aug
+0001d750: 5f66 6f72 7761 7264 292e 7061 7261 6d65  _forward).parame
+0001d760: 7465 7273 2e69 7465 6d73 2829 293a 0a20  ters.items()):. 
+0001d770: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001d780: 6620 762e 6b69 6e64 2069 6e20 2869 6e73  f v.kind in (ins
+0001d790: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
+0001d7a0: 4f53 4954 494f 4e41 4c5f 4f4e 4c59 2c20  OSITIONAL_ONLY, 
+0001d7b0: 696e 7370 6563 742e 5061 7261 6d65 7465  inspect.Paramete
+0001d7c0: 722e 504f 5349 5449 4f4e 414c 5f4f 525f  r.POSITIONAL_OR_
+0001d7d0: 4b45 5957 4f52 4429 3a0a 2020 2020 2020  KEYWORD):.      
+0001d7e0: 2020 2020 2020 2020 2020 2020 2020 7075                pu
+0001d7f0: 745f 6772 6164 2873 796d 626f 6c2e 6172  t_grad(symbol.ar
+0001d800: 6773 5b69 5d2c 2072 6573 756c 742e 6765  gs[i], result.ge
+0001d810: 7428 6b2c 204e 6f6e 6529 290a 2020 2020  t(k, None)).    
+0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d830: 7573 6564 5f6e 616d 6573 2e61 6464 286b  used_names.add(k
+0001d840: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0001d850: 2046 6f72 2064 6576 656c 6f70 6572 2063   For developer c
+0001d860: 6f6e 7665 6e69 656e 6365 2c20 7765 2061  onvenience, we a
+0001d870: 6c6c 6f77 2075 7369 6e67 2074 6865 206e  llow using the n
+0001d880: 616d 6520 6672 6f6d 2074 6865 0a20 2020  ame from the.   
+0001d890: 2020 2020 2020 2020 2023 2066 6f72 7761           # forwa
+0001d8a0: 7264 206d 6574 6120 696e 2061 6464 6974  rd meta in addit
+0001d8b0: 696f 6e20 746f 2074 6865 206e 616d 6520  ion to the name 
+0001d8c0: 6672 6f6d 2074 6865 2061 7567 6d65 6e74  from the augment
+0001d8d0: 6564 2066 6f72 7761 7264 0a20 2020 2020  ed forward.     
+0001d8e0: 2020 2020 2020 2023 2073 6967 6e61 7475         # signatu
+0001d8f0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+0001d900: 2320 4966 2062 6f74 6820 6e61 6d65 7320  # If both names 
+0001d910: 6172 6520 7573 6564 2c20 7468 6520 6f6e  are used, the on
+0001d920: 6520 6672 6f6d 2074 6865 2066 6f72 7761  e from the forwa
+0001d930: 7264 206d 6574 6120 7461 6b65 730a 2020  rd meta takes.  
+0001d940: 2020 2020 2020 2020 2020 2320 7072 6563            # prec
+0001d950: 6564 656e 6365 2e0a 2020 2020 2020 2020  edence..        
+0001d960: 2020 2020 666f 7220 692c 2028 6b2c 2076      for i, (k, v
+0001d970: 2920 696e 2065 6e75 6d65 7261 7465 2869  ) in enumerate(i
+0001d980: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
+0001d990: 2873 796d 626f 6c2e 7379 6d2e 6d65 7461  (symbol.sym.meta
+0001d9a0: 292e 7061 7261 6d65 7465 7273 2e69 7465  ).parameters.ite
+0001d9b0: 6d73 2829 293a 0a20 2020 2020 2020 2020  ms()):.         
+0001d9c0: 2020 2020 2020 2069 6620 762e 6b69 6e64         if v.kind
+0001d9d0: 2069 6e20 2869 6e73 7065 6374 2e50 6172   in (inspect.Par
+0001d9e0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
+0001d9f0: 4c5f 4f4e 4c59 2c20 696e 7370 6563 742e  L_ONLY, inspect.
+0001da00: 5061 7261 6d65 7465 722e 504f 5349 5449  Parameter.POSITI
+0001da10: 4f4e 414c 5f4f 525f 4b45 5957 4f52 4429  ONAL_OR_KEYWORD)
+0001da20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001da30: 2020 2020 2020 6966 206b 206e 6f74 2069        if k not i
+0001da40: 6e20 7573 6564 5f6e 616d 6573 3a0a 2020  n used_names:.  
+0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da60: 2020 2020 2020 7075 745f 6772 6164 2873        put_grad(s
+0001da70: 796d 626f 6c2e 6172 6773 5b69 5d2c 2072  ymbol.args[i], r
+0001da80: 6573 756c 742e 6765 7428 6b2c 204e 6f6e  esult.get(k, Non
+0001da90: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+0001daa0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0001dab0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+0001dac0: 6e63 6528 7265 7375 6c74 2c20 5365 7175  nce(result, Sequ
+0001dad0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+0001dae0: 2020 2072 6573 756c 7420 3d20 2872 6573     result = (res
+0001daf0: 756c 742c 290a 0a20 2020 2020 2020 2064  ult,)..        d
+0001db00: 6566 2069 735f 6469 6666 6572 656e 7469  ef is_differenti
+0001db10: 6162 6c65 2861 7267 293a 0a20 2020 2020  able(arg):.     
+0001db20: 2020 2020 2020 206d 6174 6368 2061 7267         match arg
+0001db30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001db40: 2020 6361 7365 2054 656e 736f 7250 726f    case TensorPro
+0001db50: 7879 2829 3a0a 2020 2020 2020 2020 2020  xy():.          
+0001db60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001db70: 2064 7479 7065 732e 6973 5f69 6e65 7861   dtypes.is_inexa
+0001db80: 6374 5f64 7479 7065 2861 7267 2e64 7479  ct_dtype(arg.dty
+0001db90: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+0001dba0: 2020 2020 6361 7365 2053 6571 7565 6e63      case Sequenc
+0001dbb0: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+0001dbc0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001dbd0: 6172 6720 616e 6420 616c 6c28 6973 696e  arg and all(isin
+0001dbe0: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+0001dbf0: 5072 6f78 7929 2061 6e64 2064 7479 7065  Proxy) and dtype
+0001dc00: 732e 6973 5f69 6e65 7861 6374 5f64 7479  s.is_inexact_dty
+0001dc10: 7065 2878 2e64 7479 7065 2920 666f 7220  pe(x.dtype) for 
+0001dc20: 7820 696e 2061 7267 290a 2020 2020 2020  x in arg).      
+0001dc30: 2020 2020 2020 2020 2020 6361 7365 205f            case _
+0001dc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001dc50: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0001dc60: 7365 0a0a 2020 2020 2020 2020 6966 206c  se..        if l
+0001dc70: 656e 2873 796d 626f 6c2e 6172 6773 2920  en(symbol.args) 
+0001dc80: 213d 2028 6f72 6967 5f72 6573 5f6c 656e  != (orig_res_len
+0001dc90: 203a 3d20 6c65 6e28 7265 7375 6c74 2929   := len(result))
+0001dca0: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
+0001dcb0: 6563 6b28 0a20 2020 2020 2020 2020 2020  eck(.           
+0001dcc0: 2020 2020 206f 7269 675f 7265 735f 6c65       orig_res_le
+0001dcd0: 6e20 3c3d 206c 656e 2873 796d 626f 6c2e  n <= len(symbol.
+0001dce0: 6172 6773 292c 0a20 2020 2020 2020 2020  args),.         
+0001dcf0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0001dd00: 2242 6163 6b77 6172 6420 666f 7220 7b73  "Backward for {s
+0001dd10: 796d 626f 6c2e 7379 6d2e 6964 7d20 7265  ymbol.sym.id} re
+0001dd20: 7475 726e 6564 207b 6f72 6967 5f72 6573  turned {orig_res
+0001dd30: 5f6c 656e 7d20 7661 6c75 6573 2c20 220a  _len} values, ".
+0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd50: 2b20 6622 6275 7420 6578 7065 6374 6564  + f"but expected
+0001dd60: 2061 7420 6d6f 7374 207b 6c65 6e28 7379   at most {len(sy
+0001dd70: 6d62 6f6c 2e61 7267 7329 7d22 2c0a 2020  mbol.args)}",.  
+0001dd80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001dd90: 2020 2020 2020 2020 2320 4173 7375 6d69          # Assumi
+0001dda0: 6e67 2074 6861 7420 7468 6520 6e6f 6e2d  ng that the non-
+0001ddb0: 6469 6666 6572 656e 7469 6162 6c65 2061  differentiable a
+0001ddc0: 7267 756d 656e 7473 2077 6572 6520 6472  rguments were dr
+0001ddd0: 6f70 7065 6420 6672 6f6d 0a20 2020 2020  opped from.     
+0001dde0: 2020 2020 2020 2023 2074 6865 2062 6163         # the bac
+0001ddf0: 6b77 6172 6420 6675 6e63 7469 6f6e 2c20  kward function, 
+0001de00: 7765 2061 7265 2067 6f69 6e67 2074 6f20  we are going to 
+0001de10: 6170 7065 6e64 204e 6f6e 6520 746f 2074  append None to t
+0001de20: 6865 2072 6573 756c 740a 2020 2020 2020  he result.      
+0001de30: 2020 2020 2020 2320 746f 206d 6174 6368        # to match
+0001de40: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
+0001de50: 7267 756d 656e 7473 2e20 416c 7465 726e  rguments. Altern
+0001de60: 6174 6976 656c 792c 2077 6520 636f 756c  atively, we coul
+0001de70: 6420 6a75 7374 0a20 2020 2020 2020 2020  d just.         
+0001de80: 2020 2023 2068 6176 6520 6120 666f 722d     # have a for-
+0001de90: 6c6f 6f70 2077 6974 6820 6120 636f 6e64  loop with a cond
+0001dea0: 6974 696f 6e61 6c20 7768 656e 2077 7269  itional when wri
+0001deb0: 7469 6e67 2074 6f20 7468 650a 2020 2020  ting to the.    
+0001dec0: 2020 2020 2020 2020 2320 656e 7669 726f          # enviro
+0001ded0: 6e6d 656e 742e 0a0a 2020 2020 2020 2020  nment...        
+0001dee0: 2020 2020 6974 6572 5f72 6573 756c 7420      iter_result 
+0001def0: 3d20 6974 6572 2872 6573 756c 7429 0a20  = iter(result). 
+0001df00: 2020 2020 2020 2020 2020 206e 5f64 6966             n_dif
+0001df10: 6665 7265 6e74 6961 626c 655f 6172 6773  ferentiable_args
+0001df20: 203d 2073 756d 2862 6f6f 6c28 6973 5f64   = sum(bool(is_d
+0001df30: 6966 6665 7265 6e74 6961 626c 6528 6172  ifferentiable(ar
+0001df40: 6729 2920 666f 7220 6172 6720 696e 2073  g)) for arg in s
+0001df50: 796d 626f 6c2e 6172 6773 290a 2020 2020  ymbol.args).    
+0001df60: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
+0001df70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001df80: 5f64 6966 6665 7265 6e74 6961 626c 655f  _differentiable_
+0001df90: 6172 6773 203c 3d20 6f72 6967 5f72 6573  args <= orig_res
+0001dfa0: 5f6c 656e 2c0a 2020 2020 2020 2020 2020  _len,.          
+0001dfb0: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0001dfc0: 4261 636b 7761 7264 2066 6f72 207b 7379  Backward for {sy
+0001dfd0: 6d62 6f6c 2e73 796d 2e69 647d 2072 6574  mbol.sym.id} ret
+0001dfe0: 7572 6e65 6420 7b6f 7269 675f 7265 735f  urned {orig_res_
+0001dff0: 6c65 6e7d 2076 616c 7565 2873 292c 2022  len} value(s), "
+0001e000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e010: 202b 2066 2262 7574 2065 7870 6563 7465   + f"but expecte
+0001e020: 6420 7b6e 5f64 6966 6665 7265 6e74 6961  d {n_differentia
+0001e030: 626c 655f 6172 6773 7d22 2c0a 2020 2020  ble_args}",.    
+0001e040: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001e050: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0001e060: 7475 706c 6528 6e65 7874 2869 7465 725f  tuple(next(iter_
+0001e070: 7265 7375 6c74 2920 6966 2069 735f 6469  result) if is_di
+0001e080: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
+0001e090: 2920 656c 7365 204e 6f6e 6520 666f 7220  ) else None for 
+0001e0a0: 6172 6720 696e 2073 796d 626f 6c2e 6172  arg in symbol.ar
+0001e0b0: 6773 290a 0a20 2020 2020 2020 2023 2053  gs)..        # S
+0001e0c0: 6565 2022 4261 636b 7761 7264 2069 6d70  ee "Backward imp
+0001e0d0: 6c20 666f 7220 6f70 7320 6f66 2074 6865  l for ops of the
+0001e0e0: 2074 7970 6520 5365 7175 656e 6365 5b54   type Sequence[T
+0001e0f0: 656e 736f 7250 726f 7879 5d2c 202e 2e2e  ensorProxy], ...
+0001e100: 202d 3e20 2e2e 2e20 7265 7375 6c74 7320   -> ... results 
+0001e110: 696e 204e 6f6e 6520 6772 6164 732e 220a  in None grads.".
+0001e120: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+0001e130: 7320 6120 7465 6d70 6f72 6172 7920 776f  s a temporary wo
+0001e140: 726b 6172 6f75 6e64 2e0a 2020 2020 2020  rkaround..      
+0001e150: 2020 6966 2073 796d 626f 6c2e 7379 6d2e    if symbol.sym.
+0001e160: 6964 2069 6e20 2870 7269 6d73 2e50 7269  id in (prims.Pri
+0001e170: 6d49 4473 2e43 4154 2c20 2274 6f72 6368  mIDs.CAT, "torch
+0001e180: 2e63 6174 222c 2022 746f 7263 682e 7374  .cat", "torch.st
+0001e190: 6163 6b22 293a 0a20 2020 2020 2020 2020  ack"):.         
+0001e1a0: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
+0001e1b0: 2870 7574 5f67 7261 642c 2073 796d 626f  (put_grad, symbo
+0001e1c0: 6c2e 6172 6773 2c20 7265 7375 6c74 290a  l.args, result).
+0001e1d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001e1e0: 2020 2020 2020 2020 2020 7361 6665 5f6d            safe_m
+0001e1f0: 6170 2870 7574 5f67 7261 642c 2073 796d  ap(put_grad, sym
+0001e200: 626f 6c2e 6172 6773 2c20 7265 7375 6c74  bol.args, result
+0001e210: 290a 0a20 2020 2064 6566 2067 6574 5f69  )..    def get_i
+0001e220: 6e65 7861 6374 5f64 7479 7065 5f6f 725f  nexact_dtype_or_
+0001e230: 6e6f 6e65 2878 293a 0a20 2020 2020 2020  none(x):.       
+0001e240: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0001e250: 2c20 2854 656e 736f 7250 726f 7879 2c20  , (TensorProxy, 
+0001e260: 4675 7475 7265 5465 6e73 6f72 5072 6f78  FutureTensorProx
+0001e270: 7929 2920 616e 6420 6474 7970 6573 2e69  y)) and dtypes.i
+0001e280: 735f 696e 6578 6163 745f 6474 7970 6528  s_inexact_dtype(
+0001e290: 782e 6474 7970 6529 3a0a 2020 2020 2020  x.dtype):.      
+0001e2a0: 2020 2020 2020 7265 7475 726e 2078 0a20        return x. 
+0001e2b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001e2c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001e2d0: 4e6f 6e65 0a0a 2020 2020 6761 7267 7320  None..    gargs 
+0001e2e0: 3d20 7472 6565 5f6d 6170 2867 6574 5f67  = tree_map(get_g
+0001e2f0: 7261 642c 2074 7570 6c65 2874 7261 6365  rad, tuple(trace
+0001e300: 2e61 7267 7329 290a 2020 2020 676b 7761  .args)).    gkwa
+0001e310: 7267 7320 3d20 7472 6565 5f6d 6170 2867  rgs = tree_map(g
+0001e320: 6574 5f67 7261 642c 2074 7261 6365 2e6b  et_grad, trace.k
+0001e330: 7761 7267 7329 0a20 2020 2067 6b77 6172  wargs).    gkwar
+0001e340: 6773 203d 207b 6b3a 2076 2066 6f72 206b  gs = {k: v for k
+0001e350: 2c20 7620 696e 2067 6b77 6172 6773 2e69  , v in gkwargs.i
+0001e360: 7465 6d73 2829 2069 6620 7620 6973 206e  tems() if v is n
+0001e370: 6f74 204e 6f6e 657d 0a20 2020 2067 6172  ot None}.    gar
+0001e380: 6773 2c20 676b 7761 7267 7320 3d20 7472  gs, gkwargs = tr
+0001e390: 6565 5f6d 6170 2867 6574 5f69 6e65 7861  ee_map(get_inexa
+0001e3a0: 6374 5f64 7479 7065 5f6f 725f 6e6f 6e65  ct_dtype_or_none
+0001e3b0: 2c20 2867 6172 6773 2c20 676b 7761 7267  , (gargs, gkwarg
+0001e3c0: 7329 290a 2020 2020 7265 7475 726e 2067  s)).    return g
+0001e3d0: 6172 6773 202b 2028 676b 7761 7267 732c  args + (gkwargs,
+0001e3e0: 2920 6966 206c 656e 2867 6b77 6172 6773  ) if len(gkwargs
+0001e3f0: 2920 213d 2030 2065 6c73 6520 6761 7267  ) != 0 else garg
+0001e400: 730a 0a0a 6465 6620 766a 705f 6361 6c6c  s...def vjp_call
+0001e410: 5f6d 6574 6166 756e 6328 6465 7461 6368  _metafunc(detach
+0001e420: 6564 3a20 626f 6f6c 2c20 7072 696d 616c  ed: bool, primal
+0001e430: 732c 2063 6f74 616e 6765 6e74 732c 2074  s, cotangents, t
+0001e440: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+0001e450: 7761 7267 7329 3a0a 2020 2020 2320 4173  wargs):.    # As
+0001e460: 7375 6d69 6e67 2070 7269 6d61 6c73 2069  suming primals i
+0001e470: 7320 666c 6174 0a0a 2020 2020 6966 206e  s flat..    if n
+0001e480: 6f74 2069 7369 6e73 7461 6e63 6528 7072  ot isinstance(pr
+0001e490: 696d 616c 732c 2053 6571 7565 6e63 6529  imals, Sequence)
+0001e4a0: 3a0a 2020 2020 2020 2020 7072 696d 616c  :.        primal
+0001e4b0: 7320 3d20 2870 7269 6d61 6c73 2c29 0a0a  s = (primals,)..
+0001e4c0: 2020 2020 6374 7820 3d20 6465 7461 6368      ctx = detach
+0001e4d0: 6564 5f74 7261 6365 2829 2069 6620 6465  ed_trace() if de
+0001e4e0: 7461 6368 6564 2065 6c73 6520 6e75 6c6c  tached else null
+0001e4f0: 636f 6e74 6578 7428 290a 2020 2020 7769  context().    wi
+0001e500: 7468 2063 7478 3a0a 2020 2020 2020 2020  th ctx:.        
+0001e510: 7265 7375 6c74 2c20 656e 7620 3d20 6175  result, env = au
+0001e520: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+0001e530: 7061 7373 282a 7072 696d 616c 732c 2074  pass(*primals, t
+0001e540: 7261 6365 3d74 7261 6365 2c20 2a2a 6b77  race=trace, **kw
+0001e550: 6172 6773 290a 2020 2020 2020 2020 6368  args).        ch
+0001e560: 6563 6b28 0a20 2020 2020 2020 2020 2020  eck(.           
+0001e570: 206c 656e 2872 6573 756c 7429 203d 3d20   len(result) == 
+0001e580: 6c65 6e28 636f 7461 6e67 656e 7473 2920  len(cotangents) 
+0001e590: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0001e5a0: 7375 6c74 2c20 5365 7175 656e 6365 2920  sult, Sequence) 
+0001e5b0: 656c 7365 2054 7275 652c 0a20 2020 2020  else True,.     
+0001e5c0: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
+0001e5d0: 2245 7870 6563 7465 6420 636f 7461 6e67  "Expected cotang
+0001e5e0: 656e 7473 2074 6f20 6265 2061 2073 6571  ents to be a seq
+0001e5f0: 7565 6e63 6520 6f66 206c 656e 6774 6820  uence of length 
+0001e600: 7b6c 656e 2872 6573 756c 7429 7d2c 2067  {len(result)}, g
+0001e610: 6f74 2061 2073 6571 7565 6e63 6520 6f66  ot a sequence of
+0001e620: 206c 656e 6774 6820 7b6c 656e 2863 6f74   length {len(cot
+0001e630: 616e 6765 6e74 7329 7d22 2c0a 2020 2020  angents)}",.    
+0001e640: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0001e650: 7475 726e 2072 6573 756c 742c 2062 6163  turn result, bac
+0001e660: 6b77 6172 645f 7061 7373 2865 6e76 2c20  kward_pass(env, 
+0001e670: 7472 6163 652c 2063 6f74 616e 6765 6e74  trace, cotangent
+0001e680: 7329 0a0a 0a23 2054 4f44 4f3a 2043 616e  s)...# TODO: Can
+0001e690: 2774 2075 7365 2061 2053 796d 626f 6c20  't use a Symbol 
+0001e6a0: 6865 7265 2062 6563 6175 7365 206d 6978  here because mix
+0001e6b0: 6564 2065 7865 6375 746f 7220 7379 6273  ed executor sybs
+0001e6c0: 796d 626f 6c73 2073 6565 6d20 746f 2062  ymbols seem to b
+0001e6d0: 650a 2320 756e 7375 7070 6f72 7465 642e  e.# unsupported.
+0001e6e0: 2053 6565 2069 7373 7565 2022 436f 756c   See issue "Coul
+0001e6f0: 6420 6e6f 7420 6669 6e64 2061 6e20 6578  d not find an ex
+0001e700: 6563 7574 6f72 2066 6f72 2062 6f75 6e64  ecutor for bound
+0001e710: 2073 796d 626f 6c20 7768 656e 2069 7473   symbol when its
+0001e720: 2073 7562 7379 6d62 6f6c 730a 2320 6172   subsymbols.# ar
+0001e730: 6520 6e6f 7420 6675 6c6c 7920 7375 7070  e not fully supp
+0001e740: 6f72 7465 6420 6279 2061 2073 696e 676c  orted by a singl
+0001e750: 6520 6578 6563 7574 6f72 220a 766a 705f  e executor".vjp_
+0001e760: 6361 6c6c 203d 2070 6172 7469 616c 280a  call = partial(.
+0001e770: 2020 2020 766a 705f 6361 6c6c 5f6d 6574      vjp_call_met
+0001e780: 6166 756e 632c 2046 616c 7365 0a29 2020  afunc, False.)  
+0001e790: 2320 5379 6d62 6f6c 2869 643d 5472 616e  # Symbol(id=Tran
+0001e7a0: 7366 6f72 6d73 2e56 6a70 4f70 2c20 6e61  sforms.VjpOp, na
+0001e7b0: 6d65 3d22 766a 705f 6361 6c6c 222c 206d  me="vjp_call", m
+0001e7c0: 6574 613d 7061 7274 6961 6c28 766a 705f  eta=partial(vjp_
+0001e7d0: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
+0001e7e0: 616c 7365 2929 0a0a 0a64 6566 2076 6a70  alse))...def vjp
+0001e7f0: 2866 756e 6329 3a0a 2020 2020 2222 2243  (func):.    """C
+0001e800: 6f6d 7075 7465 7320 7468 6520 564a 5020  omputes the VJP 
+0001e810: 6f66 2061 2066 756e 6374 696f 6e2e 0a0a  of a function...
+0001e820: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001e830: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
+0001e840: 293a 2046 756e 6374 696f 6e20 746f 2062  ): Function to b
+0001e850: 6520 6469 6666 6572 656e 7469 6174 6564  e differentiated
+0001e860: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+0001e870: 6566 205f 766a 7028 7072 696d 616c 732c  ef _vjp(primals,
+0001e880: 2063 6f74 616e 6765 6e74 732c 202a 2a6b   cotangents, **k
+0001e890: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0001e8a0: 666c 6174 5f66 756e 632c 2066 6c61 745f  flat_func, flat_
+0001e8b0: 6172 6773 2c20 7370 6563 203d 2066 6c61  args, spec = fla
+0001e8c0: 7474 656e 5f66 756e 6328 6675 6e63 2c20  tten_func(func, 
+0001e8d0: 7072 696d 616c 732c 206b 7761 7267 7329  primals, kwargs)
+0001e8e0: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
+0001e8f0: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0001e900: 2829 2866 6c61 745f 6675 6e63 2c20 2a66  ()(flat_func, *f
+0001e910: 6c61 745f 6172 6773 290a 2020 2020 2020  lat_args).      
+0001e920: 2020 7265 7375 6c74 2c20 766a 705f 7265    result, vjp_re
+0001e930: 7375 6c74 203d 2076 6a70 5f63 616c 6c28  sult = vjp_call(
+0001e940: 666c 6174 5f61 7267 732c 2063 6f74 616e  flat_args, cotan
+0001e950: 6765 6e74 732c 2074 7261 6365 3d74 7261  gents, trace=tra
+0001e960: 6365 290a 2020 2020 2020 2020 6770 7269  ce).        gpri
+0001e970: 6d61 6c73 2c20 676b 7761 7267 7320 3d20  mals, gkwargs = 
+0001e980: 7472 6565 5f75 6e66 6c61 7474 656e 2876  tree_unflatten(v
+0001e990: 6a70 5f72 6573 756c 742c 2073 7065 6329  jp_result, spec)
+0001e9a0: 0a20 2020 2020 2020 2067 7261 6473 203d  .        grads =
+0001e9b0: 2067 7072 696d 616c 7320 2b20 2867 6b77   gprimals + (gkw
+0001e9c0: 6172 6773 2c29 2069 6620 6c65 6e28 676b  args,) if len(gk
+0001e9d0: 7761 7267 7329 2021 3d20 3020 656c 7365  wargs) != 0 else
+0001e9e0: 2067 7072 696d 616c 730a 2020 2020 2020   gprimals.      
+0001e9f0: 2020 7265 7475 726e 2072 6573 756c 742c    return result,
+0001ea00: 2067 7261 6473 0a0a 2020 2020 7265 7475   grads..    retu
+0001ea10: 726e 205f 766a 700a 0a0a 6465 6620 7661  rn _vjp...def va
+0001ea20: 6c75 655f 616e 645f 6772 6164 2866 756e  lue_and_grad(fun
+0001ea30: 6329 3a0a 2020 2020 2222 2243 6f6d 7075  c):.    """Compu
+0001ea40: 7465 7320 7468 6520 7661 6c75 6520 616e  tes the value an
+0001ea50: 6420 6772 6164 6965 6e74 206f 6620 6120  d gradient of a 
+0001ea60: 6675 6e63 7469 6f6e 2e0a 0a20 2020 2054  function...    T
+0001ea70: 6869 7320 6973 2061 2063 6f6e 7665 6e69  his is a conveni
+0001ea80: 656e 6365 2066 756e 6374 696f 6e20 7468  ence function th
+0001ea90: 6174 2063 6f6d 6269 6e65 7320 7468 6520  at combines the 
+0001eaa0: 6675 6e63 7469 6f6e 616c 6974 7920 6f66  functionality of
+0001eab0: 0a20 2020 2060 766a 705f 6361 6c6c 6020  .    `vjp_call` 
+0001eac0: 7769 7468 2069 6d70 6c69 6369 7420 696e  with implicit in
+0001ead0: 6974 6961 6c69 7a61 7469 6f6e 206f 6620  itialization of 
+0001eae0: 7468 6520 636f 7461 6e67 656e 7420 746f  the cotangent to
+0001eaf0: 2031 2e0a 0a20 2020 2041 7267 733a 0a20   1...    Args:. 
+0001eb00: 2020 2020 2020 2066 756e 6320 2843 616c         func (Cal
+0001eb10: 6c61 626c 6529 3a20 4675 6e63 7469 6f6e  lable): Function
+0001eb20: 2074 6f20 6265 2064 6966 6665 7265 6e74   to be different
+0001eb30: 6961 7465 642e 0a20 2020 2022 2222 0a0a  iated..    """..
+0001eb40: 2020 2020 6465 6620 6f6e 6573 5f6c 696b      def ones_lik
+0001eb50: 6528 7829 3a0a 2020 2020 2020 2020 6966  e(x):.        if
+0001eb60: 2069 7369 6e73 7461 6e63 6528 782c 2054   isinstance(x, T
+0001eb70: 656e 736f 7250 726f 7879 293a 0a20 2020  ensorProxy):.   
+0001eb80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001eb90: 6675 6c6c 5f6c 696b 6528 782c 2066 696c  full_like(x, fil
+0001eba0: 6c5f 7661 6c75 653d 3129 0a20 2020 2020  l_value=1).     
+0001ebb0: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0001ebc0: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
+0001ebd0: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+0001ebe0: 7265 7475 726e 2074 7970 6528 782e 7661  return type(x.va
+0001ebf0: 6c75 6529 2831 290a 2020 2020 2020 2020  lue)(1).        
+0001ec00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001ec10: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0001ec20: 6f72 2866 226f 6e65 735f 6c69 6b65 2069  or(f"ones_like i
+0001ec30: 6e73 6964 6520 7661 6c75 655f 616e 645f  nside value_and_
+0001ec40: 6772 6164 2067 6f74 2061 6e20 756e 7375  grad got an unsu
+0001ec50: 7070 6f72 7465 6420 7479 7065 207b 7479  pported type {ty
+0001ec60: 7065 2878 297d 2229 0a0a 2020 2020 6465  pe(x)}")..    de
+0001ec70: 6620 5f76 616c 7565 5f61 6e64 5f67 7261  f _value_and_gra
+0001ec80: 6428 2a61 7267 732c 202a 2a6b 7761 7267  d(*args, **kwarg
+0001ec90: 7329 3a0a 2020 2020 2020 2020 7472 6163  s):.        trac
+0001eca0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+0001ecb0: 6163 6528 2928 6675 6e63 2c20 2a61 7267  ace()(func, *arg
+0001ecc0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
+0001ecd0: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
+0001ece0: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
+0001ecf0: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
+0001ed00: 292c 2074 7261 6365 2e6f 7574 7075 7429  ), trace.output)
+0001ed10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001ed20: 766a 7028 6675 6e63 2928 6172 6773 2c20  vjp(func)(args, 
+0001ed30: 636f 7461 6e67 656e 7473 2c20 2a2a 6b77  cotangents, **kw
+0001ed40: 6172 6773 290a 0a20 2020 2072 6574 7572  args)..    retur
+0001ed50: 6e20 5f76 616c 7565 5f61 6e64 5f67 7261  n _value_and_gra
+0001ed60: 640a 0a0a 466f 7277 6172 6442 6163 6b77  d...ForwardBackw
+0001ed70: 6172 6454 7261 6365 7320 3d20 6e61 6d65  ardTraces = name
+0001ed80: 6474 7570 6c65 2822 466f 7277 6172 6442  dtuple("ForwardB
+0001ed90: 6163 6b77 6172 6454 7261 6365 7322 2c20  ackwardTraces", 
+0001eda0: 5b22 666f 7277 6172 645f 7472 6163 6522  ["forward_trace"
+0001edb0: 2c20 2262 6163 6b77 6172 645f 7472 6163  , "backward_trac
+0001edc0: 6522 5d29 0a0a 0a64 6566 205f 7370 6c69  e"])...def _spli
+0001edd0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+0001ede0: 7761 7264 5f69 6e74 6f5f 7465 6e73 6f72  ward_into_tensor
+0001edf0: 735f 616e 645f 6f74 6865 7228 0a20 2020  s_and_other(.   
+0001ee00: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001ee10: 6172 643a 2053 6571 7565 6e63 655b 5661  ard: Sequence[Va
+0001ee20: 7269 6162 6c65 5d2c 0a29 202d 3e20 7475  riable],.) -> tu
+0001ee30: 706c 655b 5365 7175 656e 6365 5b56 6172  ple[Sequence[Var
+0001ee40: 6961 626c 655d 2c20 5365 7175 656e 6365  iable], Sequence
+0001ee50: 5b56 6172 6961 626c 655d 5d3a 0a20 2020  [Variable]]:.   
+0001ee60: 2022 2222 5370 6c69 7473 2073 6176 6564   """Splits saved
+0001ee70: 5f66 6f72 5f62 6163 6b77 6172 6420 696e  _for_backward in
+0001ee80: 746f 2074 656e 736f 7273 2061 6e64 206f  to tensors and o
+0001ee90: 7468 6572 2e0a 0a20 2020 2041 7267 733a  ther...    Args:
+0001eea0: 0a20 2020 2020 2020 2073 6176 6564 5f66  .        saved_f
+0001eeb0: 6f72 5f62 6163 6b77 6172 6420 2853 6571  or_backward (Seq
+0001eec0: 7565 6e63 655b 5661 7269 6162 6c65 5d29  uence[Variable])
+0001eed0: 3a20 5361 7665 645f 666f 725f 6261 636b  : Saved_for_back
+0001eee0: 7761 7264 2074 6f20 7370 6c69 742e 0a0a  ward to split...
+0001eef0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0001ef00: 2020 2020 2074 7570 6c65 5b53 6571 7565       tuple[Seque
+0001ef10: 6e63 655b 5661 7269 6162 6c65 5d2c 2053  nce[Variable], S
+0001ef20: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001ef30: 5d5d 3a20 5475 706c 6520 6f66 2074 656e  ]]: Tuple of ten
+0001ef40: 736f 7273 2061 6e64 206f 7468 6572 2e0a  sors and other..
+0001ef50: 2020 2020 2222 220a 2020 2020 6973 5f74      """.    is_t
+0001ef60: 656e 736f 7220 3d20 6c61 6d62 6461 2078  ensor = lambda x
+0001ef70: 3a20 6973 696e 7374 616e 6365 2878 2c20  : isinstance(x, 
+0001ef80: 5465 6e73 6f72 5072 6f78 7929 0a20 2020  TensorProxy).   
+0001ef90: 206f 7468 6572 2c20 7465 6e73 6f72 7320   other, tensors 
+0001efa0: 3d20 7574 696c 732e 7061 7274 6974 696f  = utils.partitio
+0001efb0: 6e28 6973 5f74 656e 736f 722c 2073 6176  n(is_tensor, sav
+0001efc0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+0001efd0: 0a20 2020 2072 6574 7572 6e20 7475 706c  .    return tupl
+0001efe0: 6528 7465 6e73 6f72 7329 2c20 7475 706c  e(tensors), tupl
+0001eff0: 6528 6f74 6865 7229 0a0a 0a64 6566 205f  e(other)...def _
+0001f000: 7570 6461 7465 5f66 6f72 7761 7264 5f77  update_forward_w
+0001f010: 6974 685f 6e65 775f 7361 7665 645f 666f  ith_new_saved_fo
+0001f020: 725f 6261 636b 7761 7264 2866 6f72 7761  r_backward(forwa
+0001f030: 7264 5f74 7261 6365 3a20 5472 6163 652c  rd_trace: Trace,
+0001f040: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001f050: 6172 643a 2053 6571 7565 6e63 655b 5661  ard: Sequence[Va
+0001f060: 7269 6162 6c65 5d29 202d 3e20 4e6f 6e65  riable]) -> None
+0001f070: 3a0a 2020 2020 2222 2255 7064 6174 6573  :.    """Updates
+0001f080: 2074 6865 2066 6f72 7761 7264 2074 7261   the forward tra
+0001f090: 6365 2077 6974 6820 6e65 7720 7361 7665  ce with new save
+0001f0a0: 645f 666f 725f 6261 636b 7761 7264 2e0a  d_for_backward..
+0001f0b0: 0a20 2020 2054 6869 7320 6973 206e 6563  .    This is nec
+0001f0c0: 6573 7361 7279 2062 6563 6175 7365 2074  essary because t
+0001f0d0: 6865 2075 7064 6174 6564 2073 6176 6564  he updated saved
+0001f0e0: 5f66 6f72 5f62 6163 6b77 6172 6420 6973  _for_backward is
+0001f0f0: 206e 6f74 2061 7661 696c 6162 6c65 0a20   not available. 
+0001f100: 2020 2077 6865 6e20 7468 6520 666f 7277     when the forw
+0001f110: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+0001f120: 2074 7261 6365 7320 6172 6520 636f 6e73   traces are cons
+0001f130: 7472 7563 7465 642e 0a0a 2020 2020 4172  tructed...    Ar
+0001f140: 6773 3a0a 2020 2020 2020 2020 666f 7277  gs:.        forw
+0001f150: 6172 645f 7472 6163 6520 2854 7261 6365  ard_trace (Trace
+0001f160: 293a 2046 6f72 7761 7264 2074 7261 6365  ): Forward trace
+0001f170: 2074 6f20 7570 6461 7465 2e0a 2020 2020   to update..    
+0001f180: 2020 2020 7361 7665 645f 666f 725f 6261      saved_for_ba
+0001f190: 636b 7761 7264 2028 5365 7175 656e 6365  ckward (Sequence
+0001f1a0: 5b56 6172 6961 626c 655d 293a 2053 6176  [Variable]): Sav
+0001f1b0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+0001f1c0: 746f 2075 7365 2074 6f0a 2020 2020 2020  to use to.      
+0001f1d0: 2020 2020 2020 7570 6461 7465 2074 6865        update the
+0001f1e0: 2066 6f72 7761 7264 2074 7261 6365 2e0a   forward trace..
+0001f1f0: 2020 2020 2222 220a 2020 2020 7361 7665      """.    save
+0001f200: 645f 666f 725f 6261 636b 7761 7264 203d  d_for_backward =
+0001f210: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
+0001f220: 2078 3a20 782e 7661 6c75 6520 6966 2069   x: x.value if i
+0001f230: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
+0001f240: 6265 7250 726f 7879 2920 656c 7365 2078  berProxy) else x
+0001f250: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+0001f260: 7761 7264 290a 2020 2020 7361 7665 645f  ward).    saved_
+0001f270: 7465 6e73 6f72 732c 2073 6176 6564 5f6f  tensors, saved_o
+0001f280: 7468 6572 203d 205f 7370 6c69 745f 7361  ther = _split_sa
+0001f290: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f2a0: 5f69 6e74 6f5f 7465 6e73 6f72 735f 616e  _into_tensors_an
+0001f2b0: 645f 6f74 6865 7228 7361 7665 645f 666f  d_other(saved_fo
+0001f2c0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
+0001f2d0: 6173 7365 7274 2066 6f72 7761 7264 5f74  assert forward_t
+0001f2e0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001f2f0: 6c73 5b2d 315d 2e73 796d 2e69 6420 3d3d  ls[-1].sym.id ==
+0001f300: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
+0001f310: 4554 5552 4e0a 2020 2020 6e65 775f 7265  ETURN.    new_re
+0001f320: 7475 726e 203d 2028 666f 7277 6172 645f  turn = (forward_
+0001f330: 7472 6163 652e 6f75 7470 7574 5b30 5d2c  trace.output[0],
+0001f340: 2028 7361 7665 645f 7465 6e73 6f72 732c   (saved_tensors,
+0001f350: 2073 6176 6564 5f6f 7468 6572 2929 0a20   saved_other)). 
+0001f360: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
+0001f370: 2e62 6f75 6e64 5f73 796d 626f 6c73 5b2d  .bound_symbols[-
+0001f380: 315d 203d 2072 6570 6c61 6365 2866 6f72  1] = replace(for
+0001f390: 7761 7264 5f74 7261 6365 2e62 6f75 6e64  ward_trace.bound
+0001f3a0: 5f73 796d 626f 6c73 5b2d 315d 2c20 6172  _symbols[-1], ar
+0001f3b0: 6773 3d6e 6577 5f72 6574 7572 6e29 0a0a  gs=new_return)..
+0001f3c0: 0a64 6566 205f 7570 6461 7465 5f62 6163  .def _update_bac
+0001f3d0: 6b77 6172 645f 7769 7468 5f6e 6577 5f73  kward_with_new_s
+0001f3e0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f3f0: 6428 6261 636b 7761 7264 5f74 7261 6365  d(backward_trace
+0001f400: 3a20 5472 6163 652c 2073 6176 6564 5f66  : Trace, saved_f
+0001f410: 6f72 5f62 6163 6b77 6172 643a 2053 6571  or_backward: Seq
+0001f420: 7565 6e63 655b 5661 7269 6162 6c65 5d29  uence[Variable])
+0001f430: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+0001f440: 2255 7064 6174 6573 2074 6865 2062 6163  "Updates the bac
+0001f450: 6b77 6172 6420 7472 6163 6520 7769 7468  kward trace with
+0001f460: 206e 6577 2073 6176 6564 5f66 6f72 5f62   new saved_for_b
+0001f470: 6163 6b77 6172 642e 0a0a 2020 2020 5468  ackward...    Th
+0001f480: 6973 2069 7320 6e65 6365 7373 6172 7920  is is necessary 
+0001f490: 6265 6361 7573 6520 7468 6520 7570 6461  because the upda
+0001f4a0: 7465 6420 7361 7665 645f 666f 725f 6261  ted saved_for_ba
+0001f4b0: 636b 7761 7264 2069 730a 2020 2020 6e6f  ckward is.    no
+0001f4c0: 7420 6176 6169 6c61 626c 6520 7768 656e  t available when
+0001f4d0: 2074 6865 2062 6163 6b77 6172 6420 7472   the backward tr
+0001f4e0: 6163 6520 6973 2063 6f6e 7374 7275 6374  ace is construct
+0001f4f0: 6564 2e0a 0a20 2020 2041 7267 733a 0a20  ed...    Args:. 
+0001f500: 2020 2020 2020 2062 6163 6b77 6172 645f         backward_
+0001f510: 7472 6163 6520 2854 7261 6365 293a 2042  trace (Trace): B
+0001f520: 6163 6b77 6172 6420 7472 6163 6520 746f  ackward trace to
+0001f530: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
+0001f540: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001f550: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
+0001f560: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
+0001f570: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
+0001f580: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
+0001f590: 2020 2075 7064 6174 6520 7468 6520 6261     update the ba
+0001f5a0: 636b 7761 7264 2074 7261 6365 2e0a 2020  ckward trace..  
+0001f5b0: 2020 2222 220a 0a20 2020 2064 6566 2075    """..    def u
+0001f5c0: 6e70 6163 6b69 6e67 5f66 6e28 7361 7665  npacking_fn(save
+0001f5d0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+0001f5e0: 636f 7461 6e67 656e 7473 293a 0a20 2020  cotangents):.   
+0001f5f0: 2020 2020 2070 6173 730a 0a20 2020 2063       pass..    c
+0001f600: 6f74 616e 6765 6e74 7320 3d20 6261 636b  otangents = back
+0001f610: 7761 7264 5f74 7261 6365 2e61 7267 735b  ward_trace.args[
+0001f620: 315d 0a20 2020 2073 6176 6564 5f74 656e  1].    saved_ten
+0001f630: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
+0001f640: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
+0001f650: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
+0001f660: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
+0001f670: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
+0001f680: 6163 6b77 6172 6429 0a20 2020 2075 6e70  ackward).    unp
+0001f690: 6163 6b69 6e67 5f74 7261 6365 203d 2063  acking_trace = c
+0001f6a0: 6f6e 7374 7275 6374 5f74 7261 6365 2872  onstruct_trace(r
+0001f6b0: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
+0001f6c0: 6c73 652c 2075 7365 5f64 6365 3d46 616c  lse, use_dce=Fal
+0001f6d0: 7365 2928 0a20 2020 2020 2020 2075 6e70  se)(.        unp
+0001f6e0: 6163 6b69 6e67 5f66 6e2c 2028 7361 7665  acking_fn, (save
+0001f6f0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
+0001f700: 5f6f 7468 6572 292c 2063 6f74 616e 6765  _other), cotange
+0001f710: 6e74 730a 2020 2020 290a 2020 2020 6173  nts.    ).    as
+0001f720: 7365 7274 2075 6e70 6163 6b69 6e67 5f74  sert unpacking_t
+0001f730: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001f740: 6c73 5b2d 315d 2e73 796d 2e69 6420 3d3d  ls[-1].sym.id ==
+0001f750: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
+0001f760: 4554 5552 4e0a 0a20 2020 2062 6163 6b77  ETURN..    backw
+0001f770: 6172 645f 7472 6163 652e 6172 6773 203d  ard_trace.args =
+0001f780: 2075 6e70 6163 6b69 6e67 5f74 7261 6365   unpacking_trace
+0001f790: 2e61 7267 730a 2020 2020 6261 636b 7761  .args.    backwa
+0001f7a0: 7264 5f74 7261 6365 5f62 7379 6d73 5f77  rd_trace_bsyms_w
+0001f7b0: 6974 686f 7574 5f75 6e70 6163 6b69 6e67  ithout_unpacking
+0001f7c0: 203d 2028 0a20 2020 2020 2020 2062 7379   = (.        bsy
+0001f7d0: 6d0a 2020 2020 2020 2020 666f 7220 6273  m.        for bs
+0001f7e0: 796d 2069 6e20 6261 636b 7761 7264 5f74  ym in backward_t
+0001f7f0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001f800: 6c73 0a20 2020 2020 2020 2069 6620 6273  ls.        if bs
+0001f810: 796d 2e73 796d 2e69 640a 2020 2020 2020  ym.sym.id.      
+0001f820: 2020 6e6f 7420 696e 2028 0a20 2020 2020    not in (.     
+0001f830: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
+0001f840: 6d49 4473 2e55 4e50 4143 4b5f 454d 5054  mIDs.UNPACK_EMPT
+0001f850: 595f 4449 4354 2c0a 2020 2020 2020 2020  Y_DICT,.        
+0001f860: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0001f870: 732e 554e 5041 434b 5f4b 4559 2c0a 2020  s.UNPACK_KEY,.  
+0001f880: 2020 2020 2020 2020 2020 7072 696d 732e            prims.
+0001f890: 5072 696d 4944 732e 554e 5041 434b 5f53  PrimIDs.UNPACK_S
+0001f8a0: 4551 5545 4e43 452c 0a20 2020 2020 2020  EQUENCE,.       
+0001f8b0: 2020 2020 2070 7269 6d73 2e50 7269 6d49       prims.PrimI
+0001f8c0: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
+0001f8d0: 4c2c 0a20 2020 2020 2020 2029 0a20 2020  L,.        ).   
+0001f8e0: 2029 0a20 2020 2062 6163 6b77 6172 645f   ).    backward_
+0001f8f0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
+0001f900: 6f6c 7320 3d20 6c69 7374 2828 2a75 6e70  ols = list((*unp
+0001f910: 6163 6b69 6e67 5f74 7261 6365 2e62 6f75  acking_trace.bou
+0001f920: 6e64 5f73 796d 626f 6c73 5b3a 2d31 5d2c  nd_symbols[:-1],
+0001f930: 202a 6261 636b 7761 7264 5f74 7261 6365   *backward_trace
+0001f940: 5f62 7379 6d73 5f77 6974 686f 7574 5f75  _bsyms_without_u
+0001f950: 6e70 6163 6b69 6e67 2929 0a0a 0a23 204e  npacking))...# N
+0001f960: 4f54 453a 2052 6574 7572 6e69 6e67 206e  OTE: Returning n
+0001f970: 616d 6564 7475 706c 6573 2066 726f 6d20  amedtuples from 
+0001f980: 636f 6d70 696c 6564 2066 756e 6374 696f  compiled functio
+0001f990: 6e73 2064 6f65 736e 2774 2077 6f72 6b2e  ns doesn't work.
+0001f9a0: 2053 6565 3a0a 2320 2241 6c6c 6f77 2072   See:.# "Allow r
+0001f9b0: 6574 7572 6e69 6e67 206e 616d 6564 7475  eturning namedtu
+0001f9c0: 706c 6573 2066 726f 6d20 636f 6d70 696c  ples from compil
+0001f9d0: 6564 2066 756e 6374 696f 6e73 220a 2320  ed functions".# 
+0001f9e0: 4e6f 7465 205b 4772 6164 2066 6f72 7761  Note [Grad forwa
+0001f9f0: 7264 206f 7574 7075 7420 7370 6563 5d0a  rd output spec].
+0001fa00: 2320 4966 2069 7420 6469 6420 776f 726b  # If it did work
+0001fa10: 2069 7420 776f 756c 6420 6265 206e 6963   it would be nic
+0001fa20: 6520 746f 2075 7365 2074 6869 7320 6e61  e to use this na
+0001fa30: 6d65 6474 7570 6c65 0a23 2069 6e73 7465  medtuple.# inste
+0001fa40: 6164 206f 6620 7468 6520 706c 6169 6e20  ad of the plain 
+0001fa50: 7475 706c 6520 6f72 2064 6963 7420 7468  tuple or dict th
+0001fa60: 6174 2077 6527 7265 2075 7369 6e67 206e  at we're using n
+0001fa70: 6f77 2e0a 546f 7263 6841 7574 6f67 7261  ow..TorchAutogra
+0001fa80: 6446 6f72 7761 7264 4461 7461 203d 206e  dForwardData = n
+0001fa90: 616d 6564 7475 706c 6528 0a20 2020 2022  amedtuple(.    "
+0001faa0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
+0001fab0: 7761 7264 4461 7461 222c 0a20 2020 205b  wardData",.    [
+0001fac0: 226f 7574 7075 7422 2c20 2266 6c61 745f  "output", "flat_
+0001fad0: 6172 6773 222c 2022 666c 6174 5f6f 7574  args", "flat_out
+0001fae0: 7075 7422 5d2c 0a29 0a0a 0a64 6566 2066  put"],.)...def f
+0001faf0: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
+0001fb00: 6172 645f 6672 6f6d 5f74 7261 6365 2874  ard_from_trace(t
+0001fb10: 7261 6365 3a20 5472 6163 652c 2074 6f72  race: Trace, tor
+0001fb20: 6368 5f61 7574 6f67 7261 643d 4661 6c73  ch_autograd=Fals
+0001fb30: 6529 202d 3e20 466f 7277 6172 6442 6163  e) -> ForwardBac
+0001fb40: 6b77 6172 6454 7261 6365 733a 0a20 2020  kwardTraces:.   
+0001fb50: 2022 2222 4765 6e65 7261 7465 7320 7468   """Generates th
+0001fb60: 6520 666f 7277 6172 6420 616e 6420 6261  e forward and ba
+0001fb70: 636b 7761 7264 2070 6173 7365 7320 6672  ckward passes fr
+0001fb80: 6f6d 2061 2074 7261 6365 2e0a 0a20 2020  om a trace...   
+0001fb90: 2054 6869 7320 6973 2061 2063 6f6e 7665   This is a conve
+0001fba0: 6e69 656e 6365 2066 756e 6374 696f 6e20  nience function 
+0001fbb0: 7468 6174 2063 6f6d 6269 6e65 7320 7468  that combines th
+0001fbc0: 6520 6675 6e63 7469 6f6e 616c 6974 7920  e functionality 
+0001fbd0: 6f66 0a20 2020 2060 6175 676d 656e 7465  of.    `augmente
+0001fbe0: 645f 666f 7277 6172 645f 7061 7373 6020  d_forward_pass` 
+0001fbf0: 616e 6420 6062 6163 6b77 6172 645f 7061  and `backward_pa
+0001fc00: 7373 602e 2054 6865 206d 6169 6e20 6469  ss`. The main di
+0001fc10: 6666 6572 656e 6365 2069 7320 7468 6174  fference is that
+0001fc20: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+0001fc30: 6f6e 2064 6f65 7320 6e6f 7420 7265 7175  on does not requ
+0001fc40: 6972 6520 7468 6520 7573 6572 2074 6f20  ire the user to 
+0001fc50: 7072 6f76 6964 6520 6e65 7720 696e 7075  provide new inpu
+0001fc60: 7473 2066 6f72 2074 6865 0a20 2020 2074  ts for the.    t
+0001fc70: 7261 6365 2065 7661 6c75 6174 696f 6e2e  race evaluation.
+0001fc80: 2049 6e73 7465 6164 2069 7420 7573 6573   Instead it uses
+0001fc90: 2074 6865 2069 6e70 7574 7320 7468 6174   the inputs that
+0001fca0: 2077 6572 6520 7573 6564 2074 6f20 636f   were used to co
+0001fcb0: 6e73 7472 7563 740a 2020 2020 7468 6520  nstruct.    the 
+0001fcc0: 7472 6163 652e 0a0a 2020 2020 4172 6773  trace...    Args
+0001fcd0: 3a0a 2020 2020 2020 2020 7472 6163 6520  :.        trace 
+0001fce0: 2854 7261 6365 293a 2054 7261 6365 2074  (Trace): Trace t
+0001fcf0: 6f20 6765 6e65 7261 7465 2074 6865 2066  o generate the f
+0001fd00: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
+0001fd10: 6172 6420 7061 7373 6573 2066 726f 6d2e  ard passes from.
+0001fd20: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0001fd30: 2020 2020 2020 2046 6f72 7761 7264 4261         ForwardBa
+0001fd40: 636b 7761 7264 5472 6163 6573 3a20 4120  ckwardTraces: A 
+0001fd50: 6e61 6d65 6420 7475 706c 6520 636f 6e74  named tuple cont
+0001fd60: 6169 6e69 6e67 2074 6865 2066 6f72 7761  aining the forwa
+0001fd70: 7264 2061 6e64 2062 6163 6b77 6172 640a  rd and backward.
+0001fd80: 2020 2020 2020 2020 2020 2020 7472 6163              trac
+0001fd90: 6573 2e0a 0a20 2020 2045 7861 6d70 6c65  es...    Example
+0001fda0: 3a0a 2020 2020 2020 2020 3e3e 3e20 696d  :.        >>> im
+0001fdb0: 706f 7274 2074 6f72 6368 0a20 2020 2020  port torch.     
+0001fdc0: 2020 203e 3e3e 2066 726f 6d20 7468 756e     >>> from thun
+0001fdd0: 6465 7220 696d 706f 7274 2063 6f6d 7069  der import compi
+0001fde0: 6c65 2c20 6c61 7374 5f74 7261 6365 730a  le, last_traces.
+0001fdf0: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+0001fe00: 2074 6875 6e64 6572 2e63 6f72 652e 7472   thunder.core.tr
+0001fe10: 616e 7366 6f72 6d73 2069 6d70 6f72 7420  ansforms import 
+0001fe20: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
+0001fe30: 7761 7264 5f66 726f 6d5f 7472 6163 650a  ward_from_trace.
+0001fe40: 2020 2020 2020 2020 3e3e 3e20 6465 6620          >>> def 
+0001fe50: 6628 7829 3a0a 2020 2020 2020 2020 2e2e  f(x):.        ..
+0001fe60: 2e20 2020 2020 7265 7475 726e 2074 6f72  .     return tor
+0001fe70: 6368 2e73 696e 2878 290a 2020 2020 2020  ch.sin(x).      
+0001fe80: 2020 3e3e 3e20 7820 3d20 746f 7263 682e    >>> x = torch.
+0001fe90: 7465 6e73 6f72 2833 2e30 290a 2020 2020  tensor(3.0).    
+0001fea0: 2020 2020 3e3e 3e20 6366 203d 2063 6f6d      >>> cf = com
+0001feb0: 7069 6c65 2866 290a 2020 2020 2020 2020  pile(f).        
+0001fec0: 3e3e 3e20 6f75 7420 3d20 6366 2878 290a  >>> out = cf(x).
+0001fed0: 2020 2020 2020 2020 3e3e 3e20 7472 6163          >>> trac
+0001fee0: 6520 3d20 6c61 7374 5f74 7261 6365 7328  e = last_traces(
+0001fef0: 6366 295b 305d 0a20 2020 2020 2020 203e  cf)[0].        >
+0001ff00: 3e3e 2066 6f72 7761 7264 5f61 6e64 5f62  >> forward_and_b
+0001ff10: 6163 6b77 6172 645f 6672 6f6d 5f74 7261  ackward_from_tra
+0001ff20: 6365 2874 7261 6365 290a 2020 2020 2020  ce(trace).      
+0001ff30: 2020 2e2e 2e20 466f 7277 6172 6442 6163    ... ForwardBac
+0001ff40: 6b77 6172 6454 7261 6365 7328 0a20 2020  kwardTraces(.   
+0001ff50: 2020 2020 202e 2e2e 2066 6f72 7761 7264       ... forward
+0001ff60: 5f74 7261 6365 3d23 2069 6d70 6f72 7420  _trace=# import 
+0001ff70: 7468 756e 6465 7220 6173 2074 6875 6e64  thunder as thund
+0001ff80: 6572 0a20 2020 2020 2020 202e 2e2e 2023  er.        ... #
+0001ff90: 2069 6d70 6f72 7420 7468 756e 6465 722e   import thunder.
+0001ffa0: 636f 7265 2e70 7269 6d73 2061 7320 7072  core.prims as pr
+0001ffb0: 696d 730a 2020 2020 2020 2020 2e2e 2e20  ims.        ... 
+0001ffc0: 696d 706f 7274 2074 6f72 6368 0a20 2020  import torch.   
+0001ffd0: 2020 2020 202e 2e2e 0a20 2020 2020 2020       ....       
+0001ffe0: 202e 2e2e 2040 746f 7263 682e 6e6f 5f67   ... @torch.no_g
+0001fff0: 7261 6428 290a 2020 2020 2020 2020 2e2e  rad().        ..
+00020000: 2e20 6465 6620 6175 676d 656e 7465 645f  . def augmented_
+00020010: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
+00020020: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
+00020030: 2023 2061 7267 733a 2022 436f 6c6c 6563   # args: "Collec
+00020040: 7469 6f6e 2220 3d20 2028 7430 2c29 2020  tion" =  (t0,)  
+00020050: 2874 7269 7669 616c 2075 6e70 6163 6b29  (trivial unpack)
+00020060: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
+00020070: 302c 205c 0a20 2020 2020 2020 202e 2e2e  0, \.        ...
+00020080: 2020 203d 2061 7267 730a 2020 2020 2020     = args.      
+00020090: 2020 2e2e 2e20 2020 7431 203d 2070 7269    ...   t1 = pri
+000200a0: 6d73 2e73 696e 2874 3029 2020 2320 7431  ms.sin(t0)  # t1
+000200b0: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
+000200c0: 2020 2020 2020 2e2e 2e20 2020 7265 7475        ...   retu
+000200d0: 726e 2074 312c 2028 7430 2c29 2c0a 2020  rn t1, (t0,),.  
+000200e0: 2020 2020 2020 2e2e 2e20 6261 636b 7761        ... backwa
+000200f0: 7264 5f74 7261 6365 3d23 2069 6d70 6f72  rd_trace=# impor
+00020100: 7420 7468 756e 6465 7220 6173 2074 6875  t thunder as thu
+00020110: 6e64 6572 0a20 2020 2020 2020 202e 2e2e  nder.        ...
+00020120: 2023 2069 6d70 6f72 7420 7468 756e 6465   # import thunde
+00020130: 722e 636f 7265 2e70 7269 6d73 2061 7320  r.core.prims as 
+00020140: 7072 696d 730a 2020 2020 2020 2020 2e2e  prims.        ..
+00020150: 2e20 696d 706f 7274 2074 6f72 6368 0a20  . import torch. 
+00020160: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
+00020170: 2020 202e 2e2e 2040 746f 7263 682e 6e6f     ... @torch.no
+00020180: 5f67 7261 6428 290a 2020 2020 2020 2020  _grad().        
+00020190: 2e2e 2e20 6465 6620 6261 636b 7761 7264  ... def backward
+000201a0: 5f66 6e28 7361 7665 645f 666f 725f 6261  _fn(saved_for_ba
+000201b0: 636b 7761 7264 2c20 636f 7461 6e67 656e  ckward, cotangen
+000201c0: 7473 293a 0a20 2020 2020 2020 202e 2e2e  ts):.        ...
+000201d0: 2020 2023 2073 6176 6564 5f66 6f72 5f62     # saved_for_b
+000201e0: 6163 6b77 6172 643a 2022 436f 6c6c 6563  ackward: "Collec
+000201f0: 7469 6f6e 2220 3d20 2028 7430 2c29 2020  tion" =  (t0,)  
+00020200: 2874 7269 7669 616c 2075 6e70 6163 6b29  (trivial unpack)
+00020210: 0a20 2020 2020 2020 202e 2e2e 2020 2023  .        ...   #
+00020220: 2063 6f74 616e 6765 6e74 733a 2022 6370   cotangents: "cp
+00020230: 7520 6633 325b 5d22 203d 2020 636f 7461  u f32[]" =  cota
+00020240: 6e67 656e 7473 2020 2874 7269 7669 616c  ngents  (trivial
+00020250: 2075 6e70 6163 6b29 0a20 2020 2020 2020   unpack).       
+00020260: 202e 2e2e 2020 2074 302c 205c 0a20 2020   ...   t0, \.   
+00020270: 2020 2020 202e 2e2e 2020 203d 2073 6176       ...   = sav
+00020280: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
+00020290: 2020 2020 2020 2020 2e2e 2e20 2020 7431          ...   t1
+000202a0: 203d 2070 7269 6d73 2e63 6f73 2874 3029   = prims.cos(t0)
+000202b0: 2020 2320 7431 3a20 2263 7075 2066 3332    # t1: "cpu f32
+000202c0: 5b5d 220a 2020 2020 2020 2020 2e2e 2e20  []".        ... 
+000202d0: 2020 7432 203d 2070 7269 6d73 2e6d 756c    t2 = prims.mul
+000202e0: 2863 6f74 616e 6765 6e74 732c 2074 3129  (cotangents, t1)
+000202f0: 2020 2320 7432 3a20 2263 7075 2066 3332    # t2: "cpu f32
+00020300: 5b5d 220a 2020 2020 2020 2020 2e2e 2e20  []".        ... 
+00020310: 2020 7265 7475 726e 2028 7432 2c29 290a    return (t2,)).
+00020320: 2020 2020 2222 220a 0a20 2020 206f 7574      """..    out
+00020330: 7075 745f 7370 6563 203d 204e 6f6e 650a  put_spec = None.
+00020340: 0a20 2020 2064 6566 2061 7567 6d65 6e74  .    def augment
+00020350: 6564 5f66 6f72 7761 7264 5f66 6e28 2a61  ed_forward_fn(*a
+00020360: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+00020370: 2020 2020 2020 2020 7265 7375 6c74 2c20          result, 
+00020380: 656e 7620 3d20 6175 676d 656e 7465 645f  env = augmented_
+00020390: 666f 7277 6172 645f 7061 7373 282a 6172  forward_pass(*ar
+000203a0: 6773 2c20 7472 6163 653d 7472 6163 652c  gs, trace=trace,
+000203b0: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
+000203c0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+000203d0: 6b77 6172 6420 3d20 6465 636f 6e73 7472  kward = deconstr
+000203e0: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
+000203f0: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
+00020400: 6365 2c20 656e 7629 0a20 2020 2020 2020  ce, env).       
+00020410: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
+00020420: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
+00020430: 6e6f 6e6c 6f63 616c 206f 7574 7075 745f  nonlocal output_
+00020440: 7370 6563 0a20 2020 2020 2020 2020 2020  spec.           
+00020450: 2066 6c61 745f 6172 6773 2c20 5f20 3d20   flat_args, _ = 
+00020460: 7472 6565 5f66 6c61 7474 656e 2828 6172  tree_flatten((ar
+00020470: 6773 2c20 6b77 6172 6773 2929 0a20 2020  gs, kwargs)).   
+00020480: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
+00020490: 7470 7574 2c20 6f75 7470 7574 5f73 7065  tput, output_spe
+000204a0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
+000204b0: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
+000204c0: 2020 2020 2066 6c61 745f 6f75 7470 7574       flat_output
+000204d0: 203d 2074 7570 6c65 2866 6c61 745f 6f75   = tuple(flat_ou
+000204e0: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
+000204f0: 2020 2320 5365 6520 4e6f 7465 205b 4772    # See Note [Gr
+00020500: 6164 2066 6f72 7761 7264 206f 7574 7075  ad forward outpu
+00020510: 7420 7370 6563 5d0a 2020 2020 2020 2020  t spec].        
+00020520: 2020 2020 666f 725f 6175 746f 6772 6164      for_autograd
+00020530: 203d 2054 6f72 6368 4175 746f 6772 6164   = TorchAutograd
+00020540: 466f 7277 6172 6444 6174 6128 0a20 2020  ForwardData(.   
+00020550: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00020560: 756c 742c 0a20 2020 2020 2020 2020 2020  ult,.           
+00020570: 2020 2020 2066 6c61 745f 6172 6773 2c0a       flat_args,.
+00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020590: 666c 6174 5f6f 7574 7075 742c 0a20 2020  flat_output,.   
+000205a0: 2020 2020 2020 2020 2029 2e5f 6173 6469           )._asdi
+000205b0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+000205c0: 2072 6574 7572 6e20 2866 6f72 5f61 7574   return (for_aut
+000205d0: 6f67 7261 642c 2073 6176 6564 5f66 6f72  ograd, saved_for
+000205e0: 5f62 6163 6b77 6172 6429 0a20 2020 2020  _backward).     
+000205f0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00020600: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+00020610: 7761 7264 0a0a 2020 2020 2320 436f 7079  ward..    # Copy
+00020620: 2074 6865 2073 6967 6e61 7475 7265 206f   the signature o
+00020630: 6620 7468 6520 6f72 6967 696e 616c 2066  f the original f
+00020640: 756e 6374 696f 6e20 736f 2074 6861 7420  unction so that 
+00020650: 7468 6520 6172 6775 6d65 6e74 7320 6172  the arguments ar
+00020660: 650a 2020 2020 2320 6e61 6d65 6420 636f  e.    # named co
+00020670: 7272 6563 746c 7920 696e 2074 6865 2061  rrectly in the a
+00020680: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
+00020690: 2070 6173 7320 696e 7374 6561 6420 6f66   pass instead of
+000206a0: 2062 6569 6e67 206e 616d 6564 0a20 2020   being named.   
+000206b0: 2023 2022 6172 6773 2220 616e 6420 226b   # "args" and "k
+000206c0: 7761 7267 7322 2e0a 2020 2020 6175 676d  wargs"..    augm
+000206d0: 656e 7465 645f 666f 7277 6172 645f 666e  ented_forward_fn
+000206e0: 2e5f 5f73 6967 6e61 7475 7265 5f5f 203d  .__signature__ =
+000206f0: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
+00020700: 7265 2874 7261 6365 2e66 6e20 6f72 2074  re(trace.fn or t
+00020710: 7261 6365 2e70 7974 686f 6e5f 6361 6c6c  race.python_call
+00020720: 6162 6c65 2829 290a 0a20 2020 2064 6566  able())..    def
+00020730: 206f 6e65 735f 6c69 6b65 2878 293a 0a20   ones_like(x):. 
+00020740: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00020750: 616e 6365 2878 2c20 5465 6e73 6f72 5072  ance(x, TensorPr
+00020760: 6f78 7929 3a0a 2020 2020 2020 2020 2020  oxy):.          
+00020770: 2020 7265 7475 726e 2066 756c 6c5f 6c69    return full_li
+00020780: 6b65 2878 2c20 6669 6c6c 5f76 616c 7565  ke(x, fill_value
+00020790: 3d31 290a 2020 2020 2020 2020 656c 6966  =1).        elif
+000207a0: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
+000207b0: 756d 6265 7250 726f 7879 293a 0a20 2020  umberProxy):.   
+000207c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000207d0: 7479 7065 2878 2e76 616c 7565 2928 3129  type(x.value)(1)
+000207e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000207f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020800: 6e20 4e6f 6e65 0a0a 2020 2020 666f 7277  n None..    forw
+00020810: 6172 645f 7472 6163 6520 3d20 636f 6e73  ard_trace = cons
+00020820: 7472 7563 745f 7472 6163 6528 2928 6175  truct_trace()(au
+00020830: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+00020840: 666e 2c20 2a74 7261 6365 2e61 7267 732c  fn, *trace.args,
+00020850: 202a 2a74 7261 6365 2e6b 7761 7267 7329   **trace.kwargs)
+00020860: 0a20 2020 2023 2057 6520 7365 7420 666f  .    # We set fo
+00020870: 7277 6172 6420 7472 6163 6520 746f 2063  rward trace to c
+00020880: 6f6e 7374 7275 6374 2070 726f 7869 6573  onstruct proxies
+00020890: 2062 6563 6175 7365 2077 6520 6e65 6564   because we need
+000208a0: 2074 6865 7365 2070 726f 7869 6573 2074   these proxies t
+000208b0: 6f0a 2020 2020 2320 6861 7665 2064 6966  o.    # have dif
+000208c0: 6665 7265 6e74 206e 616d 6573 2074 6861  ferent names tha
+000208d0: 6e20 7468 6520 6f6e 6573 2069 6e20 7468  n the ones in th
+000208e0: 6520 666f 7277 6172 6420 7472 6163 652e  e forward trace.
+000208f0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+00020900: 2020 7472 6163 6563 7478 5f74 6f6b 656e    tracectx_token
+00020910: 203d 2073 6574 5f74 7261 6365 6374 7828   = set_tracectx(
+00020920: 666f 7277 6172 645f 7472 6163 6529 0a20  forward_trace). 
+00020930: 2020 2020 2020 2023 2057 6520 646f 6e27         # We don'
+00020940: 7420 7761 6e74 2074 6f20 7265 636f 7264  t want to record
+00020950: 2074 686f 7365 206f 6e65 735f 6c69 6b65   those ones_like
+00020960: 2063 616c 6c73 2069 6e20 7468 6520 666f   calls in the fo
+00020970: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
+00020980: 2020 2020 2077 6974 6820 6465 7461 6368       with detach
+00020990: 6564 5f74 7261 6365 2829 3a0a 2020 2020  ed_trace():.    
+000209a0: 2020 2020 2020 2020 6966 2074 6f72 6368          if torch
+000209b0: 5f61 7574 6f67 7261 643a 0a20 2020 2020  _autograd:.     
+000209c0: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
+000209d0: 7320 6173 7375 6d65 6420 7468 6174 2066  s assumed that f
+000209e0: 6f72 7761 7264 5f74 7261 6365 2e6f 7574  orward_trace.out
+000209f0: 7075 745b 305d 2069 7320 6120 6469 6374  put[0] is a dict
+00020a00: 2066 726f 6d20 546f 7263 6841 7574 6f67   from TorchAutog
+00020a10: 7261 6446 6f72 7761 7264 4461 7461 0a20  radForwardData. 
+00020a20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020a30: 6c61 745f 6f75 7470 7574 203d 2066 6f72  lat_output = for
+00020a40: 7761 7264 5f74 7261 6365 2e6f 7574 7075  ward_trace.outpu
+00020a50: 745b 305d 5b22 666c 6174 5f6f 7574 7075  t[0]["flat_outpu
+00020a60: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
+00020a70: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
+00020a80: 2075 7469 6c73 2e73 6571 7565 6e63 6966   utils.sequencif
+00020a90: 7928 7472 6565 5f6d 6170 286c 616d 6264  y(tree_map(lambd
+00020aa0: 6120 763a 206f 6e65 735f 6c69 6b65 2876  a v: ones_like(v
+00020ab0: 292c 2066 6c61 745f 6f75 7470 7574 2929  ), flat_output))
+00020ac0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00020ad0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00020ae0: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
+00020af0: 7574 696c 732e 7365 7175 656e 6369 6679  utils.sequencify
+00020b00: 2874 7265 655f 6d61 7028 6c61 6d62 6461  (tree_map(lambda
+00020b10: 2076 3a20 6f6e 6573 5f6c 696b 6528 7629   v: ones_like(v)
+00020b20: 2c20 7472 6163 652e 6f75 7470 7574 2929  , trace.output))
+00020b30: 0a20 2020 2066 696e 616c 6c79 3a0a 2020  .    finally:.  
+00020b40: 2020 2020 2020 7265 7365 745f 7472 6163        reset_trac
+00020b50: 6563 7478 2874 7261 6365 6374 785f 746f  ectx(tracectx_to
+00020b60: 6b65 6e29 0a0a 2020 2020 6465 6620 6261  ken)..    def ba
+00020b70: 636b 7761 7264 5f66 6e28 7361 7665 645f  ckward_fn(saved_
+00020b80: 666f 725f 6261 636b 7761 7264 2c20 636f  for_backward, co
+00020b90: 7461 6e67 656e 7473 293a 0a20 2020 2020  tangents):.     
+00020ba0: 2020 2065 6e76 203d 2072 6563 6f6e 7374     env = reconst
+00020bb0: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
+00020bc0: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
+00020bd0: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
+00020be0: 6163 6b77 6172 6429 0a20 2020 2020 2020  ackward).       
+00020bf0: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
+00020c00: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
+00020c10: 636f 7461 6e67 656e 7473 203d 2074 7265  cotangents = tre
+00020c20: 655f 756e 666c 6174 7465 6e28 636f 7461  e_unflatten(cota
+00020c30: 6e67 656e 7473 2c20 6f75 7470 7574 5f73  ngents, output_s
+00020c40: 7065 6329 0a20 2020 2020 2020 206f 7574  pec).        out
+00020c50: 203d 2062 6163 6b77 6172 645f 7061 7373   = backward_pass
+00020c60: 2865 6e76 2c20 7472 6163 652c 2063 6f74  (env, trace, cot
+00020c70: 616e 6765 6e74 7329 0a20 2020 2020 2020  angents).       
+00020c80: 2069 6620 746f 7263 685f 6175 746f 6772   if torch_autogr
+00020c90: 6164 3a0a 2020 2020 2020 2020 2020 2020  ad:.            
+00020ca0: 676b 7761 7267 7320 3d20 6f75 745b 2d31  gkwargs = out[-1
+00020cb0: 5d20 6966 2069 7369 6e73 7461 6e63 6528  ] if isinstance(
+00020cc0: 6f75 745b 2d31 5d2c 2064 6963 7429 2065  out[-1], dict) e
+00020cd0: 6c73 6520 7b7d 0a20 2020 2020 2020 2020  lse {}.         
+00020ce0: 2020 2067 6172 6773 203d 206f 7574 5b3a     gargs = out[:
+00020cf0: 2d31 5d20 6966 2069 7369 6e73 7461 6e63  -1] if isinstanc
+00020d00: 6528 6f75 745b 2d31 5d2c 2064 6963 7429  e(out[-1], dict)
+00020d10: 2065 6c73 6520 6f75 740a 2020 2020 2020   else out.      
+00020d20: 2020 2020 2020 676b 7761 7267 7320 3d20        gkwargs = 
+00020d30: 7b6b 3a20 676b 7761 7267 732e 6765 7428  {k: gkwargs.get(
+00020d40: 6b2c 204e 6f6e 6529 2066 6f72 206b 2069  k, None) for k i
+00020d50: 6e20 7472 6163 652e 6b77 6172 6773 7d0a  n trace.kwargs}.
+00020d60: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
+00020d70: 3d20 282a 6761 7267 732c 2067 6b77 6172  = (*gargs, gkwar
+00020d80: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00020d90: 6f75 7420 3d20 7472 6565 5f66 6c61 7474  out = tree_flatt
+00020da0: 656e 286f 7574 295b 305d 0a20 2020 2020  en(out)[0].     
+00020db0: 2020 2072 6574 7572 6e20 6f75 740a 0a20     return out.. 
+00020dc0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+00020dd0: 6b77 6172 6420 3d20 666f 7277 6172 645f  kward = forward_
+00020de0: 7472 6163 652e 6f75 7470 7574 5b31 5d0a  trace.output[1].
+00020df0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+00020e00: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+00020e10: 7261 6365 2872 656e 616d 655f 7072 6f78  race(rename_prox
+00020e20: 6965 733d 4661 6c73 6529 2862 6163 6b77  ies=False)(backw
+00020e30: 6172 645f 666e 2c20 7361 7665 645f 666f  ard_fn, saved_fo
+00020e40: 725f 6261 636b 7761 7264 2c20 636f 7461  r_backward, cota
+00020e50: 6e67 656e 7473 290a 0a20 2020 2023 2057  ngents)..    # W
+00020e60: 6520 6172 6520 646f 6e65 2077 6974 6820  e are done with 
+00020e70: 636f 6e73 7472 7563 7469 6e67 2074 6865  constructing the
+00020e80: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
+00020e90: 6b77 6172 6420 7061 7373 6573 2061 7420  kward passes at 
+00020ea0: 7468 6973 0a20 2020 2023 2073 7461 6765  this.    # stage
+00020eb0: 2e20 5468 6520 666f 6c6c 6f77 696e 6720  . The following 
+00020ec0: 6973 206e 6f74 2073 7472 6963 746c 7920  is not strictly 
+00020ed0: 6e65 6365 7373 6172 792c 2062 7574 2069  necessary, but i
+00020ee0: 7427 7320 676f 6f64 2074 6f20 6669 6c74  t's good to filt
+00020ef0: 6572 0a20 2020 2023 206f 7574 2074 6865  er.    # out the
+00020f00: 2075 6e75 7365 6420 656c 656d 656e 7473   unused elements
+00020f10: 206f 6620 7468 6520 7361 7665 645f 666f   of the saved_fo
+00020f20: 725f 6261 636b 7761 7264 2061 6e64 2066  r_backward and f
+00020f30: 6c61 7474 656e 2069 7420 666f 7220 6d6f  latten it for mo
+00020f40: 7265 0a20 2020 2023 2063 6f6d 7061 6374  re.    # compact
+00020f50: 2062 6163 6b77 6172 6420 7472 6163 652e   backward trace.
+00020f60: 0a0a 2020 2020 2320 4e6f 7720 7765 2063  ..    # Now we c
+00020f70: 616e 2064 6574 6572 6d69 6e65 2065 7861  an determine exa
+00020f80: 6374 6c79 2077 6861 7427 7320 7573 6564  ctly what's used
+00020f90: 2069 6e20 7468 6520 6261 636b 7761 7264   in the backward
+00020fa0: 2070 6173 7320 6672 6f6d 2074 6865 0a20   pass from the. 
+00020fb0: 2020 2023 2073 6176 6564 5f66 6f72 5f62     # saved_for_b
+00020fc0: 6163 6b77 6172 642e 2057 6520 6361 6e20  ackward. We can 
+00020fd0: 666c 6174 7465 6e20 616e 6420 6669 6c74  flatten and filt
+00020fe0: 6572 2074 6865 2073 6176 6564 5f66 6f72  er the saved_for
+00020ff0: 5f62 6163 6b77 6172 640a 2020 2020 636f  _backward.    co
+00021000: 6e73 756d 6572 7320 3d20 7574 696c 732e  nsumers = utils.
+00021010: 636f 6e73 756d 6572 7328 6261 636b 7761  consumers(backwa
+00021020: 7264 5f74 7261 6365 290a 0a20 2020 2023  rd_trace)..    #
+00021030: 2046 6f72 7761 7264 2773 2061 6e64 2062   Forward's and b
+00021040: 6163 6b77 6172 6427 7320 2273 6176 6564  ackward's "saved
+00021050: 5f66 6f72 5f62 6163 6b77 6172 6422 2061  _for_backward" a
+00021060: 7265 206e 6f74 206e 6563 6573 7361 7269  re not necessari
+00021070: 6c79 2074 6865 2073 616d 650a 2020 2020  ly the same.    
+00021080: 2320 6173 2074 6865 2073 6176 6564 5f66  # as the saved_f
+00021090: 6f72 5f62 6163 6b77 6172 642c 2062 6563  or_backward, bec
+000210a0: 6175 7365 2073 6f6d 6520 6f72 2061 6c6c  ause some or all
+000210b0: 2065 6c65 6d65 6e74 7320 6f66 2074 6865   elements of the
+000210c0: 0a20 2020 2023 2073 6176 6564 5f66 6f72  .    # saved_for
+000210d0: 5f62 6163 6b77 6172 6420 7265 7375 6c74  _backward result
+000210e0: 7320 6d69 6768 7420 6265 2072 652d 7072  s might be re-pr
+000210f0: 6f78 6966 6965 642e 0a20 2020 2062 775f  oxified..    bw_
+00021100: 666c 6174 5f73 6176 6564 5f66 6f72 5f62  flat_saved_for_b
+00021110: 6163 6b77 6172 642c 2073 7065 6320 3d20  ackward, spec = 
+00021120: 7472 6565 5f66 6c61 7474 656e 2862 6163  tree_flatten(bac
+00021130: 6b77 6172 645f 7472 6163 652e 6172 6773  kward_trace.args
+00021140: 5b30 5d29 0a20 2020 2066 775f 666c 6174  [0]).    fw_flat
+00021150: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+00021160: 6172 642c 205f 203d 2074 7265 655f 666c  ard, _ = tree_fl
+00021170: 6174 7465 6e28 666f 7277 6172 645f 7472  atten(forward_tr
+00021180: 6163 652e 6f75 7470 7574 5b31 5d29 0a20  ace.output[1]). 
+00021190: 2020 2075 7365 645f 6d61 736b 203d 206c     used_mask = l
+000211a0: 6973 7428 6c65 6e28 636f 6e73 756d 6572  ist(len(consumer
+000211b0: 732e 6765 7428 782c 2028 2929 2920 3e20  s.get(x, ())) > 
+000211c0: 3020 666f 7220 7820 696e 2062 775f 666c  0 for x in bw_fl
+000211d0: 6174 5f73 6176 6564 5f66 6f72 5f62 6163  at_saved_for_bac
+000211e0: 6b77 6172 6429 0a0a 2020 2020 2320 446f  kward)..    # Do
+000211f0: 6e27 7420 7573 6520 7468 6520 7361 6d65  n't use the same
+00021200: 2076 6172 6961 626c 6520 7477 6963 6520   variable twice 
+00021210: 696e 2074 6865 2062 6163 6b77 6172 6420  in the backward 
+00021220: 7061 7373 0a20 2020 2073 6565 6e20 3d20  pass.    seen = 
+00021230: 7365 7428 290a 2020 2020 6672 6f6d 2074  set().    from t
+00021240: 6875 6e64 6572 2e63 6f72 652e 7072 6f78  hunder.core.prox
+00021250: 6965 7320 696d 706f 7274 2056 6172 6961  ies import Varia
+00021260: 626c 650a 0a20 2020 2066 6f72 2069 2c20  ble..    for i, 
+00021270: 7820 696e 2065 6e75 6d65 7261 7465 2866  x in enumerate(f
+00021280: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
+00021290: 5f62 6163 6b77 6172 6429 3a0a 2020 2020  _backward):.    
+000212a0: 2020 2020 7820 3d20 7661 7269 6162 6c65      x = variable
+000212b0: 6966 7928 7829 0a20 2020 2020 2020 2069  ify(x).        i
+000212c0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+000212d0: 2878 2c20 5661 7269 6162 6c65 293a 0a20  (x, Variable):. 
+000212e0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+000212f0: 6e75 650a 2020 2020 2020 2020 6966 2078  nue.        if x
+00021300: 2069 6e20 7365 656e 3a0a 2020 2020 2020   in seen:.      
+00021310: 2020 2020 2020 7573 6564 5f6d 6173 6b5b        used_mask[
+00021320: 695d 203d 2046 616c 7365 0a20 2020 2020  i] = False.     
+00021330: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00021340: 2020 2020 2073 6565 6e2e 6164 6428 7829       seen.add(x)
+00021350: 0a0a 2020 2020 6f6e 6c79 5f75 7365 645f  ..    only_used_
+00021360: 6677 5f73 6176 6564 5f66 6f72 5f62 6163  fw_saved_for_bac
+00021370: 6b77 6172 6420 3d20 7475 706c 6528 636f  kward = tuple(co
+00021380: 6d70 7265 7373 2866 775f 666c 6174 5f73  mpress(fw_flat_s
+00021390: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000213a0: 642c 2075 7365 645f 6d61 736b 2929 0a20  d, used_mask)). 
+000213b0: 2020 206f 6e6c 795f 7573 6564 5f62 775f     only_used_bw_
+000213c0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+000213d0: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
+000213e0: 6573 7328 6277 5f66 6c61 745f 7361 7665  ess(bw_flat_save
+000213f0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+00021400: 7573 6564 5f6d 6173 6b29 290a 0a20 2020  used_mask))..   
+00021410: 2023 2057 6520 6e65 6564 2074 6f20 7570   # We need to up
+00021420: 6461 7465 2074 6865 2074 7261 6365 7320  date the traces 
+00021430: 7769 7468 2074 6865 206e 6577 2073 6176  with the new sav
+00021440: 6564 5f66 6f72 5f62 6163 6b77 6172 640a  ed_for_backward.
+00021450: 2020 2020 5f75 7064 6174 655f 666f 7277      _update_forw
+00021460: 6172 645f 7769 7468 5f6e 6577 5f73 6176  ard_with_new_sav
+00021470: 6564 5f66 6f72 5f62 6163 6b77 6172 6428  ed_for_backward(
+00021480: 666f 7277 6172 645f 7472 6163 652c 206f  forward_trace, o
+00021490: 6e6c 795f 7573 6564 5f66 775f 7361 7665  nly_used_fw_save
+000214a0: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
+000214b0: 2020 2020 5f75 7064 6174 655f 6261 636b      _update_back
+000214c0: 7761 7264 5f77 6974 685f 6e65 775f 7361  ward_with_new_sa
+000214d0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+000214e0: 2862 6163 6b77 6172 645f 7472 6163 652c  (backward_trace,
+000214f0: 206f 6e6c 795f 7573 6564 5f62 775f 7361   only_used_bw_sa
+00021500: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021510: 290a 2020 2020 666f 7277 6172 645f 7472  ).    forward_tr
+00021520: 6163 652e 7365 745f 7072 6f76 656e 616e  ace.set_provenan
+00021530: 6365 2854 7261 6365 5072 6f76 656e 616e  ce(TraceProvenan
+00021540: 6365 2822 4175 676d 656e 7465 6420 666f  ce("Augmented fo
+00021550: 7277 6172 6420 7061 7373 2229 290a 2020  rward pass")).  
+00021560: 2020 6261 636b 7761 7264 5f74 7261 6365    backward_trace
+00021570: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
+00021580: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
+00021590: 2242 6163 6b77 6172 6420 7061 7373 2229  "Backward pass")
+000215a0: 290a 2020 2020 7265 7475 726e 2046 6f72  ).    return For
+000215b0: 7761 7264 4261 636b 7761 7264 5472 6163  wardBackwardTrac
+000215c0: 6573 2866 6f72 7761 7264 5f74 7261 6365  es(forward_trace
+000215d0: 2c20 6261 636b 7761 7264 5f74 7261 6365  , backward_trace
+000215e0: 290a 0a0a 2320 646f 2077 6520 6861 7070  )...# do we happ
+000215f0: 656e 2074 6f20 7761 6e74 2074 6f20 7265  en to want to re
+00021600: 6769 7374 6572 2060 6c74 6f72 6368 6020  gister `ltorch` 
+00021610: 6f70 7320 7375 6368 2061 7320 606c 746f  ops such as `lto
+00021620: 7263 682e 6c61 7965 725f 6e6f 726d 6020  rch.layer_norm` 
+00021630: 6173 2077 656c 6c3f 0a61 7574 6f63 6173  as well?.autocas
+00021640: 745f 696d 706c 733a 2064 6963 745b 7072  t_impls: dict[pr
+00021650: 696d 732e 5072 696d 4944 732c 2043 616c  ims.PrimIDs, Cal
+00021660: 6c61 626c 655d 203d 207b 7d0a 0a0a 6465  lable] = {}...de
+00021670: 6620 7265 6769 7374 6572 5f61 7574 6f63  f register_autoc
+00021680: 6173 745f 7275 6c65 286f 7029 3a0a 2020  ast_rule(op):.  
+00021690: 2020 6465 6620 6465 636f 7261 746f 7228    def decorator(
+000216a0: 6675 6e63 293a 0a20 2020 2020 2020 2061  func):.        a
+000216b0: 7574 6f63 6173 745f 696d 706c 735b 6f70  utocast_impls[op
+000216c0: 5d20 3d20 6675 6e63 0a20 2020 2020 2020  ] = func.       
+000216d0: 2072 6574 7572 6e20 6675 6e63 0a0a 2020   return func..  
+000216e0: 2020 7265 7475 726e 2064 6563 6f72 6174    return decorat
+000216f0: 6f72 0a0a 0a64 6566 206d 6179 6265 5f64  or...def maybe_d
+00021700: 6f77 6e63 6173 745f 746f 2864 7479 7065  owncast_to(dtype
+00021710: 2c20 6172 6773 293a 0a20 2020 2061 6c6c  , args):.    all
+00021720: 6f77 6564 5f64 6f77 6e63 6173 745f 7479  owed_downcast_ty
+00021730: 7065 7320 3d20 2864 7479 7065 732e 666c  pes = (dtypes.fl
+00021740: 6f61 7431 362c 2064 7479 7065 732e 6266  oat16, dtypes.bf
+00021750: 6c6f 6174 3136 2c20 6474 7970 6573 2e66  loat16, dtypes.f
+00021760: 6c6f 6174 3332 290a 0a20 2020 2064 6566  loat32)..    def
+00021770: 206d 6170 5f66 6e28 6129 3a0a 2020 2020   map_fn(a):.    
+00021780: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00021790: 6528 612c 2054 656e 736f 7250 726f 7879  e(a, TensorProxy
+000217a0: 2920 616e 6420 612e 6474 7970 6520 696e  ) and a.dtype in
+000217b0: 2061 6c6c 6f77 6564 5f64 6f77 6e63 6173   allowed_downcas
+000217c0: 745f 7479 7065 733a 0a20 2020 2020 2020  t_types:.       
+000217d0: 2020 2020 2072 6574 7572 6e20 6d61 7962       return mayb
+000217e0: 655f 636f 6e76 6572 745f 746f 5f64 7479  e_convert_to_dty
+000217f0: 7065 2861 2c20 6474 7970 6529 0a20 2020  pe(a, dtype).   
+00021800: 2020 2020 2072 6574 7572 6e20 610a 0a20       return a.. 
+00021810: 2020 2072 6574 7572 6e20 7472 6565 5f6d     return tree_m
+00021820: 6170 286d 6170 5f66 6e2c 2061 7267 7329  ap(map_fn, args)
+00021830: 0a0a 0a40 7265 6769 7374 6572 5f61 7574  ...@register_aut
+00021840: 6f63 6173 745f 7275 6c65 2822 746f 7263  ocast_rule("torc
+00021850: 682e 6d61 746d 756c 2229 0a40 7265 6769  h.matmul").@regi
+00021860: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
+00021870: 6c65 2870 7269 6d73 2e50 7269 6d49 4473  le(prims.PrimIDs
+00021880: 2e4d 4154 4d55 4c29 0a64 6566 2061 7574  .MATMUL).def aut
+00021890: 6f63 6173 745f 6d61 746d 756c 5f72 756c  ocast_matmul_rul
+000218a0: 6528 612c 2062 2c20 6474 7970 6529 3a0a  e(a, b, dtype):.
+000218b0: 2020 2020 2222 2241 7574 6f63 6173 7420      """Autocast 
+000218c0: 7275 6c65 2066 6f72 206d 6174 6d75 6c22  rule for matmul"
+000218d0: 2222 0a20 2020 2072 6574 7572 6e20 7072  "".    return pr
+000218e0: 696d 732e 6d61 746d 756c 282a 286d 6179  ims.matmul(*(may
+000218f0: 6265 5f64 6f77 6e63 6173 745f 746f 2864  be_downcast_to(d
+00021900: 7479 7065 2c20 2861 2c20 6229 2929 290a  type, (a, b)))).
+00021910: 0a0a 4072 6567 6973 7465 725f 6175 746f  ..@register_auto
+00021920: 6361 7374 5f72 756c 6528 2274 6f72 6368  cast_rule("torch
+00021930: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6c  .nn.functional.l
+00021940: 696e 6561 7222 290a 4072 6567 6973 7465  inear").@registe
+00021950: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
+00021960: 7072 696d 732e 5072 696d 4944 732e 4c49  prims.PrimIDs.LI
+00021970: 4e45 4152 290a 6465 6620 6175 746f 6361  NEAR).def autoca
+00021980: 7374 5f6c 696e 6561 725f 7275 6c65 2861  st_linear_rule(a
+00021990: 2c20 772c 2062 6961 732c 2064 7479 7065  , w, bias, dtype
+000219a0: 293a 0a20 2020 2069 6620 6269 6173 2069  ):.    if bias i
+000219b0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000219c0: 2320 446f 6e27 7420 7061 7373 2060 6269  # Don't pass `bi
+000219d0: 6173 6020 746f 206d 6179 6265 5f64 6f77  as` to maybe_dow
+000219e0: 6e63 6173 745f 746f 2e0a 2020 2020 2020  ncast_to..      
+000219f0: 2020 646f 776e 6361 7374 5f61 7267 7320    downcast_args 
+00021a00: 3d20 6d61 7962 655f 646f 776e 6361 7374  = maybe_downcast
+00021a10: 5f74 6f28 6474 7970 652c 2028 612c 2077  _to(dtype, (a, w
+00021a20: 2929 202b 2028 6269 6173 2c29 0a20 2020  )) + (bias,).   
+00021a30: 2065 6c73 653a 0a20 2020 2020 2020 2064   else:.        d
+00021a40: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
+00021a50: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
+00021a60: 2864 7479 7065 2c20 2861 2c20 772c 2062  (dtype, (a, w, b
+00021a70: 6961 7329 290a 0a20 2020 2072 6574 7572  ias))..    retur
+00021a80: 6e20 7072 696d 732e 6c69 6e65 6172 282a  n prims.linear(*
+00021a90: 646f 776e 6361 7374 5f61 7267 7329 0a0a  downcast_args)..
+00021aa0: 0a40 7265 6769 7374 6572 5f61 7574 6f63  .@register_autoc
+00021ab0: 6173 745f 7275 6c65 2822 746f 7263 682e  ast_rule("torch.
+00021ac0: 6e6e 2e66 756e 6374 696f 6e61 6c2e 7363  nn.functional.sc
+00021ad0: 616c 6564 5f64 6f74 5f70 726f 6475 6374  aled_dot_product
+00021ae0: 5f61 7474 656e 7469 6f6e 2229 0a64 6566  _attention").def
+00021af0: 2061 7574 6f63 6173 745f 7363 616c 6564   autocast_scaled
+00021b00: 5f64 6f74 5f70 726f 6475 6374 5f61 7474  _dot_product_att
+00021b10: 656e 7469 6f6e 280a 2020 2020 7175 6572  ention(.    quer
+00021b20: 792c 0a20 2020 206b 6579 2c0a 2020 2020  y,.    key,.    
+00021b30: 7661 6c75 652c 0a20 2020 2061 7474 6e5f  value,.    attn_
+00021b40: 6d61 736b 2c0a 2020 2020 6472 6f70 6f75  mask,.    dropou
+00021b50: 745f 702c 0a20 2020 2069 735f 6361 7573  t_p,.    is_caus
+00021b60: 616c 2c0a 2020 2020 2a2c 0a20 2020 2064  al,.    *,.    d
+00021b70: 7479 7065 2c0a 2020 2020 7363 616c 652c  type,.    scale,
+00021b80: 0a29 3a0a 2020 2020 6672 6f6d 2074 6875  .):.    from thu
+00021b90: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00021ba0: 7420 7363 616c 6564 5f64 6f74 5f70 726f  t scaled_dot_pro
+00021bb0: 6475 6374 5f61 7474 656e 7469 6f6e 0a0a  duct_attention..
+00021bc0: 2020 2020 712c 206b 2c20 7620 3d20 6d61      q, k, v = ma
+00021bd0: 7962 655f 646f 776e 6361 7374 5f74 6f28  ybe_downcast_to(
+00021be0: 6474 7970 652c 2028 7175 6572 792c 206b  dtype, (query, k
+00021bf0: 6579 2c20 7661 6c75 6529 290a 2020 2020  ey, value)).    
+00021c00: 7265 7475 726e 2073 6361 6c65 645f 646f  return scaled_do
+00021c10: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
+00021c20: 696f 6e28 712c 206b 2c20 762c 2061 7474  ion(q, k, v, att
+00021c30: 6e5f 6d61 736b 2c20 6472 6f70 6f75 745f  n_mask, dropout_
+00021c40: 702c 2069 735f 6361 7573 616c 2c20 7363  p, is_causal, sc
+00021c50: 616c 653d 7363 616c 6529 0a0a 0a64 6566  ale=scale)...def
+00021c60: 2061 7574 6f63 6173 745f 7379 6d62 6f6c   autocast_symbol
+00021c70: 5f6d 6170 7065 7228 626f 756e 645f 7379  _mapper(bound_sy
+00021c80: 6d62 6f6c 3a20 426f 756e 6453 796d 626f  mbol: BoundSymbo
+00021c90: 6c49 6e74 6572 6661 6365 2c20 6474 7970  lInterface, dtyp
+00021ca0: 653a 2064 7479 7065 732e 6474 7970 6529  e: dtypes.dtype)
+00021cb0: 3a0a 2020 2020 2222 2252 6574 7572 6e20  :.    """Return 
+00021cc0: 7468 6520 6361 6c6c 6162 6c65 2069 6d70  the callable imp
+00021cd0: 6c65 6d65 6e74 696e 6720 7468 6520 6175  lementing the au
+00021ce0: 746f 6361 7374 2072 756c 6520 666f 7220  tocast rule for 
+00021cf0: 7468 6520 7379 6d62 6f6c 2e0a 0a20 2020  the symbol...   
+00021d00: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
+00021d10: 6f75 6e64 5f73 796d 626f 6c3a 204d 6170  ound_symbol: Map
+00021d20: 7065 6420 746f 2069 7473 2061 7574 6f63  ped to its autoc
+00021d30: 6173 7420 7275 6c65 2e0a 0a20 2020 2052  ast rule...    R
+00021d40: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00021d50: 4361 6c6c 6162 6c65 3a20 5468 6520 6361  Callable: The ca
+00021d60: 6c6c 6162 6c65 2069 6d70 6c65 6d65 6e74  llable implement
+00021d70: 696e 6720 7468 6520 6175 746f 6361 7374  ing the autocast
+00021d80: 2072 756c 6520 666f 7220 7468 6520 7379   rule for the sy
+00021d90: 6d62 6f6c 2e0a 2020 2020 2222 220a 2020  mbol..    """.  
+00021da0: 2020 6175 746f 6361 7374 5f69 6d70 6c3a    autocast_impl:
+00021db0: 2043 616c 6c61 626c 6520 7c20 4e6f 6e65   Callable | None
+00021dc0: 203d 2061 7574 6f63 6173 745f 696d 706c   = autocast_impl
+00021dd0: 732e 6765 7428 626f 756e 645f 7379 6d62  s.get(bound_symb
+00021de0: 6f6c 2e73 796d 2e69 6429 0a20 2020 2072  ol.sym.id).    r
+00021df0: 6574 7572 6e20 626f 756e 645f 7379 6d62  eturn bound_symb
+00021e00: 6f6c 2e73 796d 2069 6620 6175 746f 6361  ol.sym if autoca
+00021e10: 7374 5f69 6d70 6c20 6973 204e 6f6e 6520  st_impl is None 
+00021e20: 656c 7365 2070 6172 7469 616c 2861 7574  else partial(aut
+00021e30: 6f63 6173 745f 696d 706c 2c20 6474 7970  ocast_impl, dtyp
+00021e40: 653d 6474 7970 6529 0a0a 0a64 6566 2061  e=dtype)...def a
+00021e50: 7574 6f63 6173 7428 6675 6e63 3a20 4361  utocast(func: Ca
+00021e60: 6c6c 6162 6c65 2c20 6474 7970 653a 2064  llable, dtype: d
+00021e70: 7479 7065 732e 6474 7970 6529 3a0a 2020  types.dtype):.  
+00021e80: 2020 2222 2254 7261 6e73 666f 726d 7320    """Transforms 
+00021e90: 6120 6675 6e63 7469 6f6e 2074 6f20 6175  a function to au
+00021ea0: 746f 6361 7374 2063 6572 7461 696e 206f  tocast certain o
+00021eb0: 7065 7261 7469 6f6e 732e 0a0a 2020 2020  perations...    
+00021ec0: 4172 6773 3a0a 2020 2020 2020 2020 6675  Args:.        fu
+00021ed0: 6e63 3a20 5468 6520 6675 6e63 7469 6f6e  nc: The function
+00021ee0: 2074 6f20 6265 2074 7261 6e73 666f 726d   to be transform
+00021ef0: 6564 2e0a 2020 2020 2020 2020 6474 7970  ed..        dtyp
+00021f00: 653a 2054 6865 2064 6174 6120 7479 7065  e: The data type
+00021f10: 2074 6f20 7768 6963 6820 6172 6775 6d65   to which argume
+00021f20: 6e74 7320 6f66 2074 6865 2066 756e 6374  nts of the funct
+00021f30: 696f 6e20 6f72 2073 7562 2066 756e 6374  ion or sub funct
+00021f40: 696f 6e73 2063 6f75 6c64 2067 6574 2063  ions could get c
+00021f50: 6173 7420 6966 0a20 2020 2020 2020 2020  ast if.         
+00021f60: 2020 2074 6865 7920 6172 6520 6064 7479     they are `dty
+00021f70: 7065 732e 666c 6f61 7433 3260 2e0a 0a20  pes.float32`... 
+00021f80: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00021f90: 2020 2020 4361 6c6c 6162 6c65 3a20 5468      Callable: Th
+00021fa0: 6520 7472 616e 7366 6f72 6d65 6420 6675  e transformed fu
+00021fb0: 6e63 7469 6f6e 0a20 2020 2022 2222 0a0a  nction.    """..
+00021fc0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00021fd0: 7461 6e63 6528 6474 7970 652c 2064 7479  tance(dtype, dty
+00021fe0: 7065 732e 6474 7970 6529 3a0a 2020 2020  pes.dtype):.    
+00021ff0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00022000: 7272 6f72 2866 2260 6474 7970 6560 2069  rror(f"`dtype` i
+00022010: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
+00022020: 2060 7468 756e 6465 722e 6474 7970 652e   `thunder.dtype.
+00022030: 6474 7970 6560 2062 7574 207b 7479 7065  dtype` but {type
+00022040: 2864 7479 7065 297d 2229 0a20 2020 2069  (dtype)}").    i
+00022050: 6620 6474 7970 6520 6e6f 7420 696e 207b  f dtype not in {
+00022060: 6474 7970 6573 2e66 6c6f 6174 3136 2c20  dtypes.float16, 
+00022070: 6474 7970 6573 2e62 666c 6f61 7431 367d  dtypes.bfloat16}
+00022080: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00022090: 5661 6c75 6545 7272 6f72 2866 2260 6474  ValueError(f"`dt
+000220a0: 7970 6560 2069 7320 6578 7065 6374 6564  ype` is expected
+000220b0: 2074 6f20 6265 2065 6974 6865 7220 6074   to be either `t
+000220c0: 6875 6e64 6572 2e66 6c6f 6174 3136 6020  hunder.float16` 
+000220d0: 6f72 2060 7468 756e 6465 722e 6266 6c6f  or `thunder.bflo
+000220e0: 6174 3136 602c 2062 7574 207b 6474 7970  at16`, but {dtyp
+000220f0: 657d 2229 0a0a 2020 2020 4077 7261 7073  e}")..    @wraps
+00022100: 2866 756e 6329 0a20 2020 2064 6566 2077  (func).    def w
+00022110: 7261 7070 6572 282a 6172 6773 2c20 2a2a  rapper(*args, **
+00022120: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00022130: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
+00022140: 6374 5f74 7261 6365 2829 2866 756e 632c  ct_trace()(func,
+00022150: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00022160: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00022170: 2065 7661 6c5f 7472 6163 6528 7472 6163   eval_trace(trac
+00022180: 652c 202a 6172 6773 2c20 2a2a 6b77 6172  e, *args, **kwar
+00022190: 6773 2c20 7379 6d62 6f6c 5f6d 6170 7065  gs, symbol_mappe
+000221a0: 723d 7061 7274 6961 6c28 6175 746f 6361  r=partial(autoca
+000221b0: 7374 5f73 796d 626f 6c5f 6d61 7070 6572  st_symbol_mapper
+000221c0: 2c20 6474 7970 653d 6474 7970 6529 290a  , dtype=dtype)).
+000221d0: 0a20 2020 2072 6574 7572 6e20 7772 6170  .    return wrap
+000221e0: 7065 720a                                per.
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/prims.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/ddp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240421/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/cudnnex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/nvfuserex_impl.py`

 * *Files 2% similar despite different names*

```diff
@@ -2006,54 +2006,14 @@
     nvdims = list(dim)
     return fd.ops.var_mean(nva, nvdims, correction)
 
 
 register_supported(PrimIDs.VAR_MEAN, var_mean, _var_mean_check)
 
 
-def _batch_norm_check(
-    a: TensorProxy,
-    weight: None | TensorProxy,
-    bias: None | TensorProxy,
-    running_mean: None | TensorProxy,
-    running_var: None | TensorProxy,
-    training: bool,
-    momentum: Number,
-    eps: Number,
-) -> bool:
-    return are_supported_tensors(*(x for x in (a, weight, bias, running_mean, running_var) if x is not None))
-
-
-def batch_norm(
-    a: TensorProxy,
-    weight: None | TensorProxy,
-    bias: None | TensorProxy,
-    running_mean: None | TensorProxy,
-    running_var: None | TensorProxy,
-    training: bool,
-    momentum: Number,
-    eps: Number,
-    *,
-    fd: FusionDefinition,
-    lc_to_nv_map: dict,
-) -> Any:
-    nva = getnv(a, fd, lc_to_nv_map)
-    nvweight = None if weight is None else getnv(weight, fd, lc_to_nv_map)
-    nvbias = None if bias is None else getnv(bias, fd, lc_to_nv_map)
-    nvrunning_mean = None if running_mean is None else getnv(running_mean, fd, lc_to_nv_map)
-    nvrunning_var = None if running_var is None else getnv(running_var, fd, lc_to_nv_map)
-    nvmomentum = getnv(momentum, fd, lc_to_nv_map)
-    nveps = getnv(eps, fd, lc_to_nv_map)
-
-    return fd.ops.batch_norm(nva, nvweight, nvbias, nvrunning_mean, nvrunning_var, nvmomentum, nveps, training)
-
-
-register_supported(PrimIDs.BATCH_NORM, batch_norm, _batch_norm_check)
-
-
 def _copy__check(
     copy_from: TensorProxy,
     copy_to: TensorProxy,
 ) -> bool:
     return are_supported_tensors(copy_from, copy_to)
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_autograd.py`

 * *Files 17% similar despite different names*

```diff
@@ -15,38 +15,14 @@
 import thunder.distributed.prims as dist_prims
 import thunder.torch as ltorch
 import thunder
 
 
 class ThunderFunction(torch.autograd.Function):
     @staticmethod
-    def get_forward_backward_splitter(func, compile_data, compile_stats):
-        from thunder import trace
-        from thunder.executors.passes import transform_for_execution
-        from thunder.executors.passes import del_last_used
-        from thunder.core.rematerialization import rematerialize_forward_and_backward, rematerialize_all_gather
-        from thunder.core.transforms import forward_and_backward_from_trace
-        from thunder.cudagraphs import CUDAGraphExecutor
-        from thunder.distributed.utils import sort_waits, sort_data_parallel_syncs, sort_waits_for_zero3
-        from thunder.distributed.transforms import FSDPCommBucketing
-
-        utils.check(compile_data is not None, lambda: "`compile_data` is required")
-
-        def make_trace(func):
-            return partial(
-                trace(compile_data=compile_data, inline_trace=False, insert_ddp_syncs=not compile_data.using_jit), func
-            )
-
-        def split_forward_backward_compat(*args, **kwargs):
-            fw_extrace, bw_extrace = split_forward_backward(func, compile_data, compile_stats, *args, **kwargs)
-            return fw_extrace.python_callable(), bw_extrace.python_callable()
-
-        return split_forward_backward_compat
-
-    @staticmethod
     def forward(ctx, compiled_backward, saved_tensors, saved_other, flat_output, *flat_args):
         # Here we just propagate the tensors through the autograd graph
         ctx.saved_other = saved_other
         ctx.compiled_backward = compiled_backward
 
         # We must save tensors using ctx.save_for_backward
         ctx.save_for_backward(*saved_tensors)
@@ -74,97 +50,14 @@
         grads = ctx.compiled_backward([saved_tensors_list, ctx.saved_other], args)
 
         # Inside the compiled backward we must clear the saved_tensors_list
         assert not saved_tensors_list, "saved_tensors_list must be empty after calling compiled_backward"
         return (None, None, None, None, *grads)
 
 
-# TODO: RC1 Remove this
-def thunder_backward(*, compile_data, compile_stats=None):
-    """Decorator to wrap a Thunder function for use with PyTorch autograd.
-
-    Args:
-        thunder_func: A Thunder function.
-
-    Returns:
-        A wrapped function that can be used with PyTorch autograd.
-
-    Example:
-    >>> import torch
-    >>> import thunder.clang as clang
-    >>> from thunder.executors.torchex import thunder_backward
-    >>> @thunder_backward()
-    ... def func(a, b):
-    ...     c = a + b
-    ...     d = c * b
-    ...     e = clang.sin(d) + clang.cos(c)
-    ...     return e
-    >>> a = torch.randn(3, device="cuda", requires_grad=True)
-    >>> b = torch.randn(3, device="cuda", requires_grad=True)
-    >>> c = func(a, b)
-    >>> print(c)
-    >>> sum(c).sum().backward()
-    >>> print(f"a.grad: {a.grad}")
-    >>> print(f"b.grad: {b.grad}")
-    """
-
-    def decorator(thunder_func):
-        from thunder import compile
-
-        # Compile's caching only works for many calls to the same compiled function
-        # It does not work if the same function is compiled many times, so we must
-        # decorate the augmented forward pass once with compile once and reuse it
-        split_fw_bw = ThunderFunction.get_forward_backward_splitter(thunder_func, compile_data, compile_stats)
-        compile_config = {
-            "langctx": compile_data.langctx,
-            "executors_list": compile_data.executors_list,
-            "only_execute_prims": compile_data.only_execute_prims,
-            "cache_option": compile_data.cache_option,
-            "use_rematerialization": compile_data.use_rematerialization,
-            "use_cudagraphs": compile_data.use_cudagraphs,
-            **compile_data.compile_options,
-            "disable_preprocessing": True,
-            "disable_torch_autograd_support": True,
-        }
-
-        compiled_split_fw_bw = compile(
-            split_fw_bw,
-            **compile_config,
-        )
-        sig = signature(thunder_func)
-
-        @wraps(thunder_func)
-        def wrapper(*args, **kwargs):
-            # Fetch the compiled forward and backward functions using the
-            # compiled function cache
-            compiled_forward, compiled_backward = compiled_split_fw_bw(*args, **kwargs)
-
-            # Compiled forward function currently doesn't support positional
-            # arguments passed as kwargs, so we must bind them here
-            ba = sig.bind(*args, **kwargs)
-            args, kwargs = ba.args, ba.kwargs
-
-            # Run the compiled forward function
-            data_for_autograd, (saved_tensors, saved_other) = compiled_forward(*args, **kwargs)
-
-            # Connect produced tensors with PyTorch's autograd graph
-            ThunderFunction.apply(
-                compiled_backward,
-                saved_tensors,
-                saved_other,
-                data_for_autograd["flat_output"],
-                *data_for_autograd["flat_args"],
-            )
-            return data_for_autograd["output"]
-
-        return wrapper
-
-    return decorator
-
-
 def split_forward_backward(computation_trc, compile_data, compile_stats, /, *args, **kwargs):
     from thunder import trace
     from thunder.executors.passes import transform_for_execution
     from thunder.executors.passes import del_last_used
     from thunder.core.rematerialization import rematerialize_forward_and_backward, rematerialize_all_gather
     from thunder.core.transforms import forward_and_backward_from_trace
     from thunder.cudagraphs import CUDAGraphExecutor
@@ -338,8 +231,13 @@
     bw_extrace = del_last_used(bw_extrace, clear_collections=True)
     bw_traces.append(bw_extrace)
 
     if compile_stats is not None:
         compile_stats.last_traces += fw_traces
         compile_stats.last_backward_traces += bw_traces
 
+    # Enable wrapping with `te.fp8_autocast`.
+    fw_extrace._include_te_fp8_autocast = True
+    # We only want the forward function to be called with `te.fp8_autocast` manager.
+    bw_extrace._include_te_fp8_autocast = False
+
     return fw_extrace, bw_extrace
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/torch_compile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/torchex.py`

 * *Files 0% similar despite different names*

```diff
@@ -1187,23 +1187,17 @@
 
 #
 # Normalization operations
 #
 
 layer_norm = _register_torch_operation("layer_norm", module=torch.nn.functional)
 batch_norm = _register_torch_operation("batch_norm", module=torch.nn.functional)
-native_batch_norm = _register_torch_operation("torch.ops.aten.native_batch_norm", like=prims.batch_norm)
-native_batch_norm_backward = _register_torch_operation(
-    "torch.ops.aten.native_batch_norm_backward", like=ltorch.batch_norm_backward
-)
 
 _register_implementation(ltorch.layer_norm, layer_norm, checker=_always_executable)
 _register_implementation(ltorch.batch_norm, batch_norm, checker=_always_executable)
-_register_implementation(prims.batch_norm, native_batch_norm, checker=_always_executable)
-_register_implementation(ltorch.batch_norm_backward, native_batch_norm_backward, checker=_always_executable)
 
 #
 # NN operations
 #
 
 bmm = _register_torch_operation("bmm")
 convolution = _register_torch_operation("convolution")
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/transformer_engineex.py`

 * *Files 3% similar despite different names*

```diff
@@ -17,16 +17,18 @@
 from thunder.core.symbol import Symbol, BoundSymbol
 import thunder.core.devices as devices
 import thunder.core.prims as prims
 from thunder.core.proxies import TensorProxy, CollectionProxy
 from thunder.core.symbol import Symbol
 from thunder.core.vjp_utils import disable_caching_split_forward_and_backward
 from thunder.extend import OperatorExecutor, register_executor
+from thunder.core.compile_data import get_compile_option
 from thunder.core.langctxs import langctx, Languages
 
+
 __all__ = [
     "transformer_engine_ex",
 ]
 
 TE_AVAILABLE: bool = package_available("transformer_engine")
 
 # We rely on internal details of TransformerEngine like `_Linear` autograd.Function.
@@ -35,14 +37,16 @@
 # between version 1.2 and 1.3.
 # Hence, we have these guards based on version.
 TE_VERSION_1_3_PLUS: bool = False
 
 te: None | Any = None
 if TE_AVAILABLE:
     try:
+        import transformer_engine.pytorch as te
+        from transformer_engine.common import recipe
         from transformer_engine.pytorch.module.linear import _Linear
         from transformer_engine.pytorch.module.base import TransformerEngineBaseModule
         from transformer_engine.pytorch.fp8 import FP8GlobalStateManager
         from transformer_engine.pytorch.utils import check_dim_for_fp8_exec
     except Exception as ex:
         warnings.warn(f"transformer_engine failed to import with exception {ex}")
         TE_AVAILABLE = False
@@ -73,14 +77,15 @@
 #   out = torch.nn.functional.linear(out, d)
 #   return out
 #
 # Traced Program:
 #
 # @torch.no_grad()
 # @no_autocast()
+# @transformer_engine.fp8_autocast(fp8_recipe=te_fp8_recipe)
 # def func(a, b, d):
 #   # a: "cuda:0 bf16[16, 32]"
 #   # b: "cuda:0 bf16[64, 32]"
 #   # d: "cuda:0 bf16[32, 64]"
 #   (t0, _) = te_linear_0(a, b, None, is_grad_enabled=False)  # Backed by it's own instance of TELinear
 #   del a, b
 #   (t1, _) = te_linear_1(t0, d, None, is_grad_enabled=False)  # Backed by it's own instance of TELinear
@@ -328,27 +333,39 @@
 
 te_functional_linear_backward = transformer_engine_ex.register_operator(
     "te_functional_linear_backward", meta=_te_functional_linear_backward_meta, fn=_te_functional_linear_backward_impl
 )
 
 LINEAR_CALLS_COUNTER = 0
 
+if TE_AVAILABLE:
+    _DEFAULT_RECIPE = recipe.DelayedScaling()
+
+IMPORT_CTX_TE_KEY = "transformer_engine"
+FP8_RECIPE_KEY = "te_fp8_recipe"
+
 
 # Creates a new stateful operator for each invocation of `linear`.
 def _create_fp8_linear_bound_symbol(
     a: TensorProxy, w: TensorProxy, b: TensorProxy, is_grad_enabled=False
 ) -> tuple[torch.Tensor, CollectionProxy | None]:
     linear_fn = partial(TELinear(w.shape[1], w.shape[0]), is_grad_enabled=is_grad_enabled)
     global LINEAR_CALLS_COUNTER
     name = f"te_linear_{LINEAR_CALLS_COUNTER}"
 
+    desc = "transformer_engine_ex: Optional fp8_recipe for `fp8_autocast` context manager."
+    if (fp8_recipe := get_compile_option(FP8_RECIPE_KEY, desc)) is None:
+        fp8_recipe = _DEFAULT_RECIPE
+
     def bind_postprocess(bsym: BoundSymbol) -> None:
         # This dict is then used by trace.python_ctx() to resolve the
         # BoundSymbol to the actual function.
         bsym._call_ctx: dict[str, Callable] = {name: linear_fn}
+        bsym._import_ctx: dict[str, Any] = {IMPORT_CTX_TE_KEY: te}
+        bsym._object_ctx: dict[str, Any] = {FP8_RECIPE_KEY: fp8_recipe}
 
     meta_fn = make_te_linear_meta(is_grad_enabled=is_grad_enabled)
     sym = Symbol(
         name=name, meta=meta_fn, is_prim=True, executor=transformer_engine_ex, _bind_postprocess=bind_postprocess
     )
     bsym = sym.bind(a, w, b, output=meta_fn(a, w, b))
 
@@ -430,14 +447,28 @@
     prims.linear,
     checker=_linear_checker,
     execution_transform=_linear_transform,
     grad_transform=_linear_grad,
 )
 
 
+def _is_te_linear_enabled(import_ctx, object_ctx):
+    # These keys are present in `import_ctx` and `object_ctx` only if
+    # we actually replaced a linear call with a new TE operator.
+    is_te_exec_enabled = IMPORT_CTX_TE_KEY in import_ctx and FP8_RECIPE_KEY in object_ctx
+    return is_te_exec_enabled
+
+
+TE_CTX_STR = f"@{IMPORT_CTX_TE_KEY}.fp8_autocast(fp8_recipe={FP8_RECIPE_KEY})"
+
+
+def _get_te_wrapper_string():
+    return TE_CTX_STR
+
+
 def _rearrange_transformer_engine_linear(fw_extrace, bw_extrace):
     """
     Rearrange the TransformerEngine linear symbols `te_linear_*` in forward trace
     so that we match the constraint that first FP8 module being called
     in forward is the last FP8 module whose gradient is computed in backward pass.
 
     Implementation:
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240421/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/extend/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -466,17 +466,14 @@
     if failed_executors:
         raise ValueError(
             f"Expected an Executor or the name of a registered Executor, instead got: {failed_executors[0] if len(failed_executors) == 1 else failed_executors}"
             + os.linesep
             + f"Registered executors: {get_all_executors()}"
         )
 
-    if duplicates := {x for x in resolved_executors if resolved_executors.count(x) > 1}:
-        raise ValueError(f"Duplicate executors in the list of executors. Duplicates: {duplicates}")
-
     return tuple(resolved_executors)
 
 
 def add_executor_lists(
     exc_list: None | Sequence[Executor | str], other_exc_list: None | Sequence[Executor | str]
 ) -> Sequence[Executor]:
     new_exc_list = []
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240421/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240421/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240421/thunder/torch/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,15 +9,15 @@
 from numbers import Number
 from typing import Any, Union, Optional, Tuple
 from collections.abc import Callable
 
 import opt_einsum
 
 # Initializes the language context
-from thunder.torch.langctx import register_method
+from thunder.torch.langctx import register_method, register_property
 
 import thunder.clang as clang
 import thunder.core.devices as devices
 from thunder.core.devices import to_device
 import thunder.core.dtypes as dtypes
 from thunder.core.dtypes import to_torch_dtype, to_dtype, _thunder_to_torch_dtype_map, _torch_to_thunder_dtype_map
 import thunder.core.prims as prims
@@ -72,21 +72,23 @@
 # NOTE Functions that set is_method=True must be able to accept a tensor as their first positional input
 class torchsymbol:
     def __init__(
         self,
         *torchfns,
         is_method: bool = False,
         method_name: None | str = None,
+        is_property: bool = False,
         id: str | None = None,
         is_prim: bool = False,
         tags: None | list[Any] = None,
     ):
         self.torchfns = torchfns
         self.is_method = is_method or (method_name is not None)
         self.method_name: None | str = method_name
+        self.is_property = is_property
         self.id = id
         # When is_prim is True, the function is treated as a primitive, so that
         # executors must execute it directly without decomposition.
         self.is_prim = is_prim
         self.tags = tags
 
     def __call__(self, fn: Callable) -> Symbol:
@@ -123,14 +125,20 @@
 
         if self.is_method:
             method_name: str = self.method_name if self.method_name is not None else fn.__name__
             register_method(method_name, sym)
             torch_method: None | Callable = getattr(torch.Tensor, method_name, None)
             if torch_method is not None:
                 _torch_to_thunder_function_map[torch_method] = sym
+        elif self.is_property:
+            method_name: str = self.method_name if self.method_name is not None else fn.__name__
+            register_property(method_name, sym)
+            torch_property = getattr(torch.Tensor, method_name, None)
+            if torch_property is not None:
+                _torch_to_thunder_function_map[torch_property] = sym
 
         if self.torchfns is not None:
             for torchfn in self.torchfns:
                 _torch_to_thunder_function_map[torchfn] = sym
 
         return sym
 
@@ -167,14 +175,19 @@
         if idx is None:
             return a.shape
         return a.shape[idx]
 
     return fn_
 
 
+@torchsymbol(torch.Tensor.is_cuda, is_property=True, id="torch.is_cuda")
+def is_cuda(a: TensorLike, /) -> bool:
+    return a.device.devicetype is devices.DeviceType.CUDA
+
+
 register_method("size", size)
 
 
 #
 # Data movement and transformation operations
 #
 
@@ -283,14 +296,44 @@
             a = prims.stride_order(a, (3, 0, 2, 1))
         elif memory_format == torch.channels_last_3d:
             a = prims.stride_order(a, (4, 0, 3, 2, 1))
 
     return a
 
 
+@torchsymbol(torch.Tensor.cuda, is_method=True)
+def cuda(
+    a: TensorLike,
+    /,
+    device: None | DeviceLike = None,
+    non_blocking: bool = False,
+    memory_format: None | torch.memory_format = None,
+) -> TensorLike:
+    # Modeled similar to PyTorch:
+    # https://github.com/pytorch/pytorch/blob/e3ac61587aa368c613ef01df1f328a396b64cd5d/tools/autograd/templates/python_variable_methods.cpp#L496-L501
+    # If `device` is None, this function defaults `device` to current CUDA device
+    # and delegates actual data-movement and layout ordering to `Tensor.to`.
+
+    # NOTE: `Tensor.to` doesn't model `non_blocking` currently.
+    utils.check(not non_blocking, lambda: "cuda(): `non_blocking==True` is currently not supported.")
+
+    if device is None:
+        # Move tensor to `current` GPU device.
+        cuda_idx = torch.cuda.current_device()
+        device = devices.Device(devices.DeviceType.CUDA, cuda_idx)
+    else:
+        device = to_device(device)
+        utils.check(
+            device.devicetype == devices.DeviceType.CUDA,
+            lambda: f"cuda(): Invalid device {device}, must be cuda device",
+        )
+
+    return to(a, device=device, memory_format=memory_format)
+
+
 @torchsymbol(torch.Tensor.type_as, is_method=True)
 def type_as(a: TensorProxy, b: TensorProxy, /) -> TensorProxy:
     # NOTE This type check is intentional since we're accessing the true_dtype
     #   attribute of the TensorProxy
     # TODO Create a generic Tensor annotation, and support both PyTorch
     #   tensors and TensorProxies being passed to this operation
     utils.check_type(b, TensorProxy)
@@ -1531,15 +1574,22 @@
     if fill_value is None:
         fill_value = 0
 
     return _mask_tensor(a, mask, fill_value)
 
 
 @torchsymbol(torch.where, is_method=True)
-def where(pred: TensorLike, a: Number | TensorLike, b: Number | TensorLike, /) -> TensorLike:
+def where(
+    pred: TensorLike, a: None | Number | TensorLike = None, b: None | Number | TensorLike = None, /
+) -> TensorLike:
+    utils.check(
+        isinstance(a, (Number, TensorProxy)) and isinstance(b, (Number, TensorProxy)),
+        lambda: f"torch.where() does not support only specifying a condition",
+        exception_type=NotImplementedError,
+    )
     return clang.where(pred, a, b)
 
 
 #
 # Reduction operations
 #
 
@@ -2507,14 +2557,74 @@
         normalized_shape = a.shape[-normalized_ndim:]
     if bias is not None:
         normalized_ndim = len(bias.shape)
         normalized_shape = a.shape[-normalized_ndim:]
     return _native_layer_norm(a, normalized_shape, weight, bias, eps)[0]
 
 
+def _native_batch_norm(
+    a: TensorLike,
+    /,
+    weight: None | TensorLike,
+    bias: None | TensorLike,
+    running_mean: None | TensorLike,
+    running_var: None | TensorLike,
+    training: bool,
+    momentum: Number,
+    eps: Number,
+) -> TensorLike:
+    params_shape = (1, -1) + (1,) * (a.ndim - 2)
+    computation_dtype = utils.get_computation_dtype(a.dtype)
+    a_acc = to(a, computation_dtype)
+    if training:
+        reduction_dims = (0,) + tuple(range(2, a.ndim))
+        # this should be keepdim=False  because of https://github.com/NVIDIA/Fuser/issues/1964
+        biased_var, mean = var_mean(a_acc, dim=reduction_dims, correction=0, keepdim=False)
+        rstd = rsqrt(biased_var + eps)
+        bcast_rstd = reshape(rstd, params_shape)
+        bcast_mean = reshape(mean, params_shape)
+        out = (a - bcast_mean) * bcast_rstd
+
+        if running_mean is not None:
+            new_running_mean = (1 - momentum) * running_mean + momentum * mean
+            if not utils.are_same_dtypes(new_running_mean, running_mean):
+                new_running_mean = to(new_running_mean, running_mean.dtype)
+            prims.copy_(new_running_mean, running_mean)
+        if running_var is not None:
+            n = a.numel / a.shape[1]
+            unbiased_var = biased_var * (n / (n - 1))
+            new_running_var = (1 - momentum) * running_var + momentum * unbiased_var
+            if not utils.are_same_dtypes(new_running_var, running_var):
+                new_running_var = to(new_running_var, running_var.dtype)
+            prims.copy_(new_running_var, running_var)
+    else:
+        running_var_acc = to(running_var, computation_dtype)
+        rstd = rsqrt(running_var_acc + eps)
+        mean = reshape(running_mean, params_shape)
+        rstd = reshape(rstd, params_shape)
+        out = (a_acc - mean) * rstd
+
+    # Handles weight and bias
+    if weight is not None:
+        # Inserting a conversion to the computation_dtype for weight and bias to
+        # disable nvFuser executors's bookend optimization (nv_enable_bookend),
+        # preventing the executor to push out the shape operations out of the
+        # fusion region.
+        weight = to(weight, computation_dtype)
+        weight = reshape(weight, params_shape)
+        out = out * weight
+    if bias is not None:
+        bias = to(bias, computation_dtype)
+        bias = reshape(bias, params_shape)
+        out = out + bias
+
+    out = to(out, a.dtype)
+    return out
+
+
 @torchsymbol(torch.nn.functional.batch_norm)
 def batch_norm(
     a: TensorLike,
     running_mean: None | TensorLike = None,
     running_var: None | TensorLike = None,
     weight: None | TensorLike = None,
     bias: None | TensorLike = None,
@@ -2553,151 +2663,28 @@
         )
     else:
         utils.check(
             running_mean is not None and running_var is not None,
             lambda: f"running_mean and running_var must be defined in evaluation mode",
         )
     computation_dtype = utils.get_computation_dtype(a.dtype)
-    a_dtype = a.dtype
     # Check mixed input types
     params = [x for x in (weight, bias, running_mean, running_var) if x is not None]
     if params:
         if utils.is_low_precision_dtype(a.dtype):
             utils.check(
                 utils.are_same_dtypes(params[0], a) or utils.are_same_dtypes(params[0], computation_dtype),
                 lambda: f"Expected to have type {computation_dtype} or {a.dtype} but got {params[0].dtype}",
             )
         else:
             utils.check_same_dtype(params[0], a)
         utils.check_same_dtype(*params)
 
-    # inplace operation is not supported, so running mean and running var can not be casted,
-    # they are passed to prim operator directly
-    (
-        a,
-        weight,
-        bias,
-    ) = (
-        to(x, computation_dtype) if x is not None else x
-        for x in (
-            a,
-            weight,
-            bias,
-        )
-    )
-    result = prims.batch_norm(a, weight, bias, running_mean, running_var, training, momentum, eps)
-    output = to(result[0], a_dtype)
-    return output
-
-
-@torchsymbol("batch_norm_backward", id="batch_norm_backward")
-def batch_norm_backward(
-    g: TensorLike,
-    a: TensorLike,
-    weight: None | TensorLike,
-    running_mean: None | TensorLike,
-    running_var: None | TensorLike,
-    save_mean: None | TensorLike,
-    save_invstd: None | TensorLike,
-    train: bool,
-    eps: Number,
-    output_mask: list[bool],
-) -> tuple[TensorLike, None | TensorLike, None | TensorLike]:
-    utils.check(a.ndim >= 2, lambda: f"Input tensor must have at least batch and channel dimensions!")
-    if train:
-        utils.check(
-            save_mean is not None and save_invstd is not None,
-            lambda: f"when train=True, save_mean and save_invstd are required",
-        )
-    else:
-        utils.check(
-            running_mean is not None and running_var is not None,
-            lambda: f"when train=False, running_mean and running_var are required",
-        )
-    a_dtype = a.dtype
-    if weight is not None:
-        weight_dtype = weight.dtype
-    else:
-        weight_dtype = a_dtype
-    computation_dtype = utils.get_computation_dtype(a.dtype)
-    (
-        grad_out_cast,
-        a_cast,
-        weight_cast,
-        running_mean_cast,
-        running_var_cast,
-        save_mean_cast,
-        save_invstd_cast,
-    ) = (
-        to(x, computation_dtype) if x is not None else x
-        for x in (
-            g,
-            a,
-            weight,
-            running_mean,
-            running_var,
-            save_mean,
-            save_invstd,
-        )
-    )
-    input_shape = a.shape
-    input_rank = a.dim()
-    axis = 1
-    input_size_prod = 1
-    for x in input_shape:
-        input_size_prod *= x
-
-    num_features = input_size_prod / input_shape[axis]
-    mean = save_mean_cast
-    invstd = save_invstd_cast
-    if not train:
-        mean = running_mean_cast
-        invstd = rsqrt(running_var_cast + eps)
-    broadcast_mask = [1] * input_rank
-    broadcast_mask[axis] = input_shape[axis]
-
-    reduction_axes = []
-    for i in range(input_rank):
-        if i != axis:
-            reduction_axes.append(i)
-
-    mean = reshape(mean, broadcast_mask)
-    norm = 1.0 / num_features
-    grad_output_sum = sum(grad_out_cast, reduction_axes)
-    dot_p = sum(grad_out_cast * (a_cast - mean), reduction_axes)
-
-    grad_mean = reshape(grad_output_sum * norm, broadcast_mask)
-    proj_scale = reshape(mul(dot_p * norm, invstd * invstd), broadcast_mask)
-
-    if weight_cast is None:
-        grad_scale = reshape(invstd, broadcast_mask) * 1.0
-    else:
-        grad_scale = reshape(invstd * weight_cast, broadcast_mask)
-
-    if train:
-        proj = (a_cast - mean) * proj_scale
-        grad_input = ((grad_out_cast - proj) - grad_mean) * grad_scale
-    else:
-        grad_input = grad_out_cast * grad_scale
-
-    if output_mask[1]:
-        grad_weight = dot_p * invstd
-    else:
-        grad_weight = None
-
-    if output_mask[2]:
-        grad_bias = grad_output_sum
-    else:
-        grad_bias = None
-
-    return (
-        grad_input.to(a_dtype),
-        None if grad_weight is None else clang.maybe_convert_to_dtype(grad_weight, weight_dtype),
-        None if grad_bias is None else clang.maybe_convert_to_dtype(grad_bias, weight_dtype),
-    )
+    result = _native_batch_norm(a, weight, bias, running_mean, running_var, training, momentum, eps)
+    return result
 
 
 #
 # NN Operations
 #
```

### Comparing `lightning_thunder-0.2.0.dev20240414/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240421/thunder/torch/langctx.py`

 * *Files 10% similar despite different names*

```diff
@@ -8,22 +8,23 @@
 #
 # Creates and registers the torch language context
 #
 # NOTE That this is done separately from the definition of thunder.torch operations, because the
 #   language context must be available before those operations are defined
 
 _method_name_to_fn_map: dict[str, Callable] = {}
+_property_name_to_fn_map: dict[str, Callable] = {}
 
 
 class TorchCtx(LanguageContext):
     def __init__(self):
         super().__init__("torch")
 
     def has_method(self, id: str) -> bool:
-        return id in _method_name_to_fn_map
+        return id in _method_name_to_fn_map or id in _property_name_to_fn_map
 
     def get_method(self, id: str, *args, **kwargs) -> Callable:
         # Note: concrete implmenetations should only raise AttributeError or
         #       return None for "missing" methods as the proxies will
         #       route __getattr__ to here and hasattr relies on __getattr__
         #       throwing AttributeError (only) when the attribute does
         #       not exist.
@@ -32,17 +33,21 @@
         has_tensor_input: bool = False
         for x in inps:
             if isinstance(x, TensorProxy):
                 has_tensor_input = True
                 break
         if has_tensor_input:
             method: None | Callable = _method_name_to_fn_map.get(id, None)
-            if method is None:
-                raise AttributeError(f"The {self.name} language context has no method {id}")
-            return method
+            prop: None | Callable = _property_name_to_fn_map.get(id, None)
+            if method is None and prop is None:
+                raise AttributeError(f"The {self.name} language context has no method or attribute {id}")
+            if method:
+                return method
+            else:
+                return prop(inps[0])
 
         # has_tensor_input is False
         # Defers to the primitive language context when there are no tensor inputs=
         #   (the primitive language context handles operations on numbers)
         primsctx: LanguageContext = resolve_language(Languages.PRIMS)
         if not primsctx.has_method(id):
             raise AttributeError(
@@ -56,7 +61,11 @@
 register_langctx(Languages.TORCH, torchctx)
 register_langctx("torch", torchctx)
 
 
 # Registers a method with the torch language context
 def register_method(method_name: str, method: Callable, /) -> None:
     _method_name_to_fn_map[method_name] = method
+
+
+def register_property(property_name, property) -> None:
+    _property_name_to_fn_map[property_name] = property
```

